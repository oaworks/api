/*! For license information please see worker.min.js.LICENSE.txt */
(()=>{var e={282:(e,t,i)=>{"use strict";var r=i(155),s=i(108);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}var n,l,o=i(136).codes,u=o.ERR_AMBIGUOUS_ARGUMENT,c=o.ERR_INVALID_ARG_TYPE,p=o.ERR_INVALID_ARG_VALUE,d=o.ERR_INVALID_RETURN_VALUE,h=o.ERR_MISSING_ARGS,f=i(961),m=i(539).inspect,y=i(539).types,g=y.isPromise,_=y.isRegExp,v=Object.assign?Object.assign:i(91).assign,b=Object.is?Object.is:i(609);function w(){var e=i(158);n=e.isDeepEqual,l=e.isDeepStrictEqual}new Map;var x=!1,O=e.exports=I,k={};function j(e){if(e.message instanceof Error)throw e.message;throw new f(e)}function S(e,t,i,r){if(!i){var s=!1;if(0===t)s=!0,r="No value argument passed to `assert.ok()`";else if(r instanceof Error)throw r;var a=new f({actual:i,expected:!0,message:r,operator:"==",stackStartFn:e});throw a.generatedMessage=s,a}}function I(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];S.apply(void 0,[I,t.length].concat(t))}O.fail=function e(t,i,a,n,l){var o,u=arguments.length;if(0===u?o="Failed":1===u?(a=t,t=void 0):(!1===x&&(x=!0,(r.emitWarning?r.emitWarning:s.warn.bind(s))("assert.fail() with more than one argument is deprecated. Please use assert.strictEqual() instead or only pass a message.","DeprecationWarning","DEP0094")),2===u&&(n="!=")),a instanceof Error)throw a;var c={actual:t,expected:i,operator:void 0===n?"fail":n,stackStartFn:l||e};void 0!==a&&(c.message=a);var p=new f(c);throw o&&(p.message=o,p.generatedMessage=!0),p},O.AssertionError=f,O.ok=I,O.equal=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");t!=i&&j({actual:t,expected:i,message:r,operator:"==",stackStartFn:e})},O.notEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");t==i&&j({actual:t,expected:i,message:r,operator:"!=",stackStartFn:e})},O.deepEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===n&&w(),n(t,i)||j({actual:t,expected:i,message:r,operator:"deepEqual",stackStartFn:e})},O.notDeepEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===n&&w(),n(t,i)&&j({actual:t,expected:i,message:r,operator:"notDeepEqual",stackStartFn:e})},O.deepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===n&&w(),l(t,i)||j({actual:t,expected:i,message:r,operator:"deepStrictEqual",stackStartFn:e})},O.notDeepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===n&&w(),l(t,i)&&j({actual:t,expected:i,message:r,operator:"notDeepStrictEqual",stackStartFn:e})},O.strictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");b(t,i)||j({actual:t,expected:i,message:r,operator:"strictEqual",stackStartFn:e})},O.notStrictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");b(t,i)&&j({actual:t,expected:i,message:r,operator:"notStrictEqual",stackStartFn:e})};var A=function e(t,i,r){var s=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i.forEach((function(e){e in t&&(void 0!==r&&"string"==typeof r[e]&&_(t[e])&&t[e].test(r[e])?s[e]=r[e]:s[e]=t[e])}))};function D(e,t,i,r){if("function"!=typeof t){if(_(t))return t.test(e);if(2===arguments.length)throw new c("expected",["Function","RegExp"],t);if("object"!==a(e)||null===e){var s=new f({actual:e,expected:t,message:i,operator:"deepStrictEqual",stackStartFn:r});throw s.operator=r.name,s}var o=Object.keys(t);if(t instanceof Error)o.push("name","message");else if(0===o.length)throw new p("error",t,"may not be an empty object");return void 0===n&&w(),o.forEach((function(s){"string"==typeof e[s]&&_(t[s])&&t[s].test(e[s])||function(e,t,i,r,s,a){if(!(i in e)||!l(e[i],t[i])){if(!r){var n=new A(e,s),o=new A(t,s,e),u=new f({actual:n,expected:o,operator:"deepStrictEqual",stackStartFn:a});throw u.actual=e,u.expected=t,u.operator=a.name,u}j({actual:e,expected:t,message:r,operator:a.name,stackStartFn:a})}}(e,t,s,i,o,r)})),!0}return void 0!==t.prototype&&e instanceof t||!Error.isPrototypeOf(t)&&!0===t.call({},e)}function C(e){if("function"!=typeof e)throw new c("fn","Function",e);try{e()}catch(e){return e}return k}function E(e){return g(e)||null!==e&&"object"===a(e)&&"function"==typeof e.then&&"function"==typeof e.catch}function N(e){return Promise.resolve().then((function(){var t;if("function"==typeof e){if(!E(t=e()))throw new d("instance of Promise","promiseFn",t)}else{if(!E(e))throw new c("promiseFn",["Function","Promise"],e);t=e}return Promise.resolve().then((function(){return t})).then((function(){return k})).catch((function(e){return e}))}))}function L(e,t,i,r){if("string"==typeof i){if(4===arguments.length)throw new c("error",["Object","Error","Function","RegExp"],i);if("object"===a(t)&&null!==t){if(t.message===i)throw new u("error/message",'The error message "'.concat(t.message,'" is identical to the message.'))}else if(t===i)throw new u("error/message",'The error "'.concat(t,'" is identical to the message.'));r=i,i=void 0}else if(null!=i&&"object"!==a(i)&&"function"!=typeof i)throw new c("error",["Object","Error","Function","RegExp"],i);if(t===k){var s="";i&&i.name&&(s+=" (".concat(i.name,")")),s+=r?": ".concat(r):".";var n="rejects"===e.name?"rejection":"exception";j({actual:void 0,expected:i,operator:e.name,message:"Missing expected ".concat(n).concat(s),stackStartFn:e})}if(i&&!D(t,i,r,e))throw t}function P(e,t,i,r){if(t!==k){if("string"==typeof i&&(r=i,i=void 0),!i||D(t,i)){var s=r?": ".concat(r):".",a="doesNotReject"===e.name?"rejection":"exception";j({actual:t,expected:i,operator:e.name,message:"Got unwanted ".concat(a).concat(s,"\n")+'Actual message: "'.concat(t&&t.message,'"'),stackStartFn:e})}throw t}}function R(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];S.apply(void 0,[R,t.length].concat(t))}O.throws=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];L.apply(void 0,[e,C(t)].concat(r))},O.rejects=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(t).then((function(t){return L.apply(void 0,[e,t].concat(r))}))},O.doesNotThrow=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];P.apply(void 0,[e,C(t)].concat(r))},O.doesNotReject=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(t).then((function(t){return P.apply(void 0,[e,t].concat(r))}))},O.ifError=function e(t){if(null!=t){var i="ifError got unwanted exception: ";"object"===a(t)&&"string"==typeof t.message?0===t.message.length&&t.constructor?i+=t.constructor.name:i+=t.message:i+=m(t);var r=new f({actual:t,expected:null,operator:"ifError",message:i,stackStartFn:e}),s=t.stack;if("string"==typeof s){var n=s.split("\n");n.shift();for(var l=r.stack.split("\n"),o=0;o<n.length;o++){var u=l.indexOf(n[o]);if(-1!==u){l=l.slice(0,u);break}}r.stack="".concat(l.join("\n"),"\n").concat(n.join("\n"))}throw r}},O.strict=v(R,O,{equal:O.strictEqual,deepEqual:O.deepStrictEqual,notEqual:O.notStrictEqual,notDeepEqual:O.notDeepStrictEqual}),O.strict.strict=O.strict},961:(e,t,i)=>{"use strict";var r=i(155);function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t){return!t||"object"!==d(t)&&"function"!=typeof t?l(e):t}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,p(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},o(e)}function u(e,t,i){return u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var r=[null];r.push.apply(r,t);var s=new(Function.bind.apply(e,r));return i&&c(s,i.prototype),s},u.apply(null,arguments)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}var h=i(539).inspect,f=i(136).codes.ERR_INVALID_ARG_TYPE;function m(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t}var y="",g="",_="",v="",b={deepStrictEqual:"Expected values to be strictly deep-equal:",strictEqual:"Expected values to be strictly equal:",strictEqualObject:'Expected "actual" to be reference-equal to "expected":',deepEqual:"Expected values to be loosely deep-equal:",equal:"Expected values to be loosely equal:",notDeepStrictEqual:'Expected "actual" not to be strictly deep-equal to:',notStrictEqual:'Expected "actual" to be strictly unequal to:',notStrictEqualObject:'Expected "actual" not to be reference-equal to "expected":',notDeepEqual:'Expected "actual" not to be loosely deep-equal to:',notEqual:'Expected "actual" to be loosely unequal to:',notIdentical:"Values identical but not reference-equal:"};function w(e){var t=Object.keys(e),i=Object.create(Object.getPrototypeOf(e));return t.forEach((function(t){i[t]=e[t]})),Object.defineProperty(i,"message",{value:e.message}),i}function x(e){return h(e,{compact:!1,customInspect:!1,depth:1e3,maxArrayLength:1/0,showHidden:!1,breakLength:1/0,showProxy:!1,sorted:!0,getters:!0})}var O=function(e){function t(e){var i;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),"object"!==d(e)||null===e)throw new f("options","Object",e);var s=e.message,a=e.operator,o=e.stackStartFn,u=e.actual,c=e.expected,h=Error.stackTraceLimit;if(Error.stackTraceLimit=0,null!=s)i=n(this,p(t).call(this,String(s)));else if(r.stderr&&r.stderr.isTTY&&(r.stderr&&r.stderr.getColorDepth&&1!==r.stderr.getColorDepth()?(y="[34m",g="[32m",v="[39m",_="[31m"):(y="",g="",v="",_="")),"object"===d(u)&&null!==u&&"object"===d(c)&&null!==c&&"stack"in u&&u instanceof Error&&"stack"in c&&c instanceof Error&&(u=w(u),c=w(c)),"deepStrictEqual"===a||"strictEqual"===a)i=n(this,p(t).call(this,function(e,t,i){var s="",a="",n=0,l="",o=!1,u=x(e),c=u.split("\n"),p=x(t).split("\n"),h=0,f="";if("strictEqual"===i&&"object"===d(e)&&"object"===d(t)&&null!==e&&null!==t&&(i="strictEqualObject"),1===c.length&&1===p.length&&c[0]!==p[0]){var w=c[0].length+p[0].length;if(w<=10){if(!("object"===d(e)&&null!==e||"object"===d(t)&&null!==t||0===e&&0===t))return"".concat(b[i],"\n\n")+"".concat(c[0]," !== ").concat(p[0],"\n")}else if("strictEqualObject"!==i&&w<(r.stderr&&r.stderr.isTTY?r.stderr.columns:80)){for(;c[0][h]===p[0][h];)h++;h>2&&(f="\n  ".concat(function(e,t){if(t=Math.floor(t),0==e.length||0==t)return"";var i=e.length*t;for(t=Math.floor(Math.log(t)/Math.log(2));t;)e+=e,t--;return e+e.substring(0,i-e.length)}(" ",h),"^"),h=0)}}for(var O=c[c.length-1],k=p[p.length-1];O===k&&(h++<2?l="\n  ".concat(O).concat(l):s=O,c.pop(),p.pop(),0!==c.length&&0!==p.length);)O=c[c.length-1],k=p[p.length-1];var j=Math.max(c.length,p.length);if(0===j){var S=u.split("\n");if(S.length>30)for(S[26]="".concat(y,"...").concat(v);S.length>27;)S.pop();return"".concat(b.notIdentical,"\n\n").concat(S.join("\n"),"\n")}h>3&&(l="\n".concat(y,"...").concat(v).concat(l),o=!0),""!==s&&(l="\n  ".concat(s).concat(l),s="");var I=0,A=b[i]+"\n".concat(g,"+ actual").concat(v," ").concat(_,"- expected").concat(v),D=" ".concat(y,"...").concat(v," Lines skipped");for(h=0;h<j;h++){var C=h-n;if(c.length<h+1)C>1&&h>2&&(C>4?(a+="\n".concat(y,"...").concat(v),o=!0):C>3&&(a+="\n  ".concat(p[h-2]),I++),a+="\n  ".concat(p[h-1]),I++),n=h,s+="\n".concat(_,"-").concat(v," ").concat(p[h]),I++;else if(p.length<h+1)C>1&&h>2&&(C>4?(a+="\n".concat(y,"...").concat(v),o=!0):C>3&&(a+="\n  ".concat(c[h-2]),I++),a+="\n  ".concat(c[h-1]),I++),n=h,a+="\n".concat(g,"+").concat(v," ").concat(c[h]),I++;else{var E=p[h],N=c[h],L=N!==E&&(!m(N,",")||N.slice(0,-1)!==E);L&&m(E,",")&&E.slice(0,-1)===N&&(L=!1,N+=","),L?(C>1&&h>2&&(C>4?(a+="\n".concat(y,"...").concat(v),o=!0):C>3&&(a+="\n  ".concat(c[h-2]),I++),a+="\n  ".concat(c[h-1]),I++),n=h,a+="\n".concat(g,"+").concat(v," ").concat(N),s+="\n".concat(_,"-").concat(v," ").concat(E),I+=2):(a+=s,s="",1!==C&&0!==h||(a+="\n  ".concat(N),I++))}if(I>20&&h<j-2)return"".concat(A).concat(D,"\n").concat(a,"\n").concat(y,"...").concat(v).concat(s,"\n")+"".concat(y,"...").concat(v)}return"".concat(A).concat(o?D:"","\n").concat(a).concat(s).concat(l).concat(f)}(u,c,a)));else if("notDeepStrictEqual"===a||"notStrictEqual"===a){var O=b[a],k=x(u).split("\n");if("notStrictEqual"===a&&"object"===d(u)&&null!==u&&(O=b.notStrictEqualObject),k.length>30)for(k[26]="".concat(y,"...").concat(v);k.length>27;)k.pop();i=1===k.length?n(this,p(t).call(this,"".concat(O," ").concat(k[0]))):n(this,p(t).call(this,"".concat(O,"\n\n").concat(k.join("\n"),"\n")))}else{var j=x(u),S="",I=b[a];"notDeepEqual"===a||"notEqual"===a?(j="".concat(b[a],"\n\n").concat(j)).length>1024&&(j="".concat(j.slice(0,1021),"...")):(S="".concat(x(c)),j.length>512&&(j="".concat(j.slice(0,509),"...")),S.length>512&&(S="".concat(S.slice(0,509),"...")),"deepEqual"===a||"equal"===a?j="".concat(I,"\n\n").concat(j,"\n\nshould equal\n\n"):S=" ".concat(a," ").concat(S)),i=n(this,p(t).call(this,"".concat(j).concat(S)))}return Error.stackTraceLimit=h,i.generatedMessage=!s,Object.defineProperty(l(i),"name",{value:"AssertionError [ERR_ASSERTION]",enumerable:!1,writable:!0,configurable:!0}),i.code="ERR_ASSERTION",i.actual=u,i.expected=c,i.operator=a,Error.captureStackTrace&&Error.captureStackTrace(l(i),o),i.stack,i.name="AssertionError",n(i)}var i,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),i=t,o=[{key:"toString",value:function(){return"".concat(this.name," [").concat(this.code,"]: ").concat(this.message)}},{key:h.custom,value:function(e,t){return h(this,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),r.forEach((function(t){s(e,t,i[t])}))}return e}({},t,{customInspect:!1,depth:0}))}}],o&&a(i.prototype,o),t}(o(Error));e.exports=O},136:(e,t,i)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}var n,l,o={};function u(e,t,i){i||(i=Error);var n=function(i){function n(i,a,l){var o,u,c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),u=this,c=s(n).call(this,function(e,i,r){return"string"==typeof t?t:t(e,i,r)}(i,a,l)),o=!c||"object"!==r(c)&&"function"!=typeof c?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(u):c,o.code=e,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(n,i),n}(i);o[e]=n}function c(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map((function(e){return String(e)})),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:2===i?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}u("ERR_AMBIGUOUS_ARGUMENT",'The "%s" argument is ambiguous. %s',TypeError),u("ERR_INVALID_ARG_TYPE",(function(e,t,s){var a,l,o,u,p;if(void 0===n&&(n=i(282)),n("string"==typeof e,"'name' must be a string"),"string"==typeof t&&(l="not ",t.substr(0,4)===l)?(a="must not be",t=t.replace(/^not /,"")):a="must be",function(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-9,i)===t}(e," argument"))o="The ".concat(e," ").concat(a," ").concat(c(t,"type"));else{var d=("number"!=typeof p&&(p=0),p+1>(u=e).length||-1===u.indexOf(".",p)?"argument":"property");o='The "'.concat(e,'" ').concat(d," ").concat(a," ").concat(c(t,"type"))}return o+". Received type ".concat(r(s))}),TypeError),u("ERR_INVALID_ARG_VALUE",(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"is invalid";void 0===l&&(l=i(539));var s=l.inspect(t);return s.length>128&&(s="".concat(s.slice(0,128),"...")),"The argument '".concat(e,"' ").concat(r,". Received ").concat(s)}),TypeError,RangeError),u("ERR_INVALID_RETURN_VALUE",(function(e,t,i){var s;return s=i&&i.constructor&&i.constructor.name?"instance of ".concat(i.constructor.name):"type ".concat(r(i)),"Expected ".concat(e,' to be returned from the "').concat(t,'"')+" function but got ".concat(s,".")}),TypeError),u("ERR_MISSING_ARGS",(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];void 0===n&&(n=i(282)),n(t.length>0,"At least one arg needs to be specified");var s="The ",a=t.length;switch(t=t.map((function(e){return'"'.concat(e,'"')})),a){case 1:s+="".concat(t[0]," argument");break;case 2:s+="".concat(t[0]," and ").concat(t[1]," arguments");break;default:s+=t.slice(0,a-1).join(", "),s+=", and ".concat(t[a-1]," arguments")}return"".concat(s," must be specified")}),TypeError),e.exports.codes=o},158:(e,t,i)=>{"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=[],r=!0,s=!1,a=void 0;try{for(var n,l=e[Symbol.iterator]();!(r=(n=l.next()).done)&&(i.push(n.value),!t||i.length!==t);r=!0);}catch(e){s=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(s)throw a}}return i}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}var a=void 0!==/a/g.flags,n=function(e){var t=[];return e.forEach((function(e){return t.push(e)})),t},l=function(e){var t=[];return e.forEach((function(e,i){return t.push([i,e])})),t},o=Object.is?Object.is:i(609),u=Object.getOwnPropertySymbols?Object.getOwnPropertySymbols:function(){return[]},c=Number.isNaN?Number.isNaN:i(360);function p(e){return e.call.bind(e)}var d=p(Object.prototype.hasOwnProperty),h=p(Object.prototype.propertyIsEnumerable),f=p(Object.prototype.toString),m=i(539).types,y=m.isAnyArrayBuffer,g=m.isArrayBufferView,_=m.isDate,v=m.isMap,b=m.isRegExp,w=m.isSet,x=m.isNativeError,O=m.isBoxedPrimitive,k=m.isNumberObject,j=m.isStringObject,S=m.isBooleanObject,I=m.isBigIntObject,A=m.isSymbolObject,D=m.isFloat32Array,C=m.isFloat64Array;function E(e){if(0===e.length||e.length>10)return!0;for(var t=0;t<e.length;t++){var i=e.charCodeAt(t);if(i<48||i>57)return!0}return 10===e.length&&e>=Math.pow(2,32)}function N(e){return Object.keys(e).filter(E).concat(u(e).filter(Object.prototype.propertyIsEnumerable.bind(e)))}function L(e,t){if(e===t)return 0;for(var i=e.length,r=t.length,s=0,a=Math.min(i,r);s<a;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0}var P=0,R=1,q=2,T=3;function M(e,t,i,r){if(e===t)return 0!==e||!i||o(e,t);if(i){if("object"!==s(e))return"number"==typeof e&&c(e)&&c(t);if("object"!==s(t)||null===e||null===t)return!1;if(Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1}else{if(null===e||"object"!==s(e))return(null===t||"object"!==s(t))&&e==t;if(null===t||"object"!==s(t))return!1}var n,l,u,p,d=f(e);if(d!==f(t))return!1;if(Array.isArray(e)){if(e.length!==t.length)return!1;var h=N(e),m=N(t);return h.length===m.length&&U(e,t,i,r,R,h)}if("[object Object]"===d&&(!v(e)&&v(t)||!w(e)&&w(t)))return!1;if(_(e)){if(!_(t)||Date.prototype.getTime.call(e)!==Date.prototype.getTime.call(t))return!1}else if(b(e)){if(!b(t)||(u=e,p=t,!(a?u.source===p.source&&u.flags===p.flags:RegExp.prototype.toString.call(u)===RegExp.prototype.toString.call(p))))return!1}else if(x(e)||e instanceof Error){if(e.message!==t.message||e.name!==t.name)return!1}else{if(g(e)){if(i||!D(e)&&!C(e)){if(!function(e,t){return e.byteLength===t.byteLength&&0===L(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new Uint8Array(t.buffer,t.byteOffset,t.byteLength))}(e,t))return!1}else if(!function(e,t){if(e.byteLength!==t.byteLength)return!1;for(var i=0;i<e.byteLength;i++)if(e[i]!==t[i])return!1;return!0}(e,t))return!1;var E=N(e),M=N(t);return E.length===M.length&&U(e,t,i,r,P,E)}if(w(e))return!(!w(t)||e.size!==t.size)&&U(e,t,i,r,q);if(v(e))return!(!v(t)||e.size!==t.size)&&U(e,t,i,r,T);if(y(e)){if(l=t,(n=e).byteLength!==l.byteLength||0!==L(new Uint8Array(n),new Uint8Array(l)))return!1}else if(O(e)&&!function(e,t){return k(e)?k(t)&&o(Number.prototype.valueOf.call(e),Number.prototype.valueOf.call(t)):j(e)?j(t)&&String.prototype.valueOf.call(e)===String.prototype.valueOf.call(t):S(e)?S(t)&&Boolean.prototype.valueOf.call(e)===Boolean.prototype.valueOf.call(t):I(e)?I(t)&&BigInt.prototype.valueOf.call(e)===BigInt.prototype.valueOf.call(t):A(t)&&Symbol.prototype.valueOf.call(e)===Symbol.prototype.valueOf.call(t)}(e,t))return!1}return U(e,t,i,r,P)}function W(e,t){return t.filter((function(t){return h(e,t)}))}function U(e,t,i,a,o,c){if(5===arguments.length){c=Object.keys(e);var p=Object.keys(t);if(c.length!==p.length)return!1}for(var f=0;f<c.length;f++)if(!d(t,c[f]))return!1;if(i&&5===arguments.length){var m=u(e);if(0!==m.length){var y=0;for(f=0;f<m.length;f++){var g=m[f];if(h(e,g)){if(!h(t,g))return!1;c.push(g),y++}else if(h(t,g))return!1}var _=u(t);if(m.length!==_.length&&W(t,_).length!==y)return!1}else{var v=u(t);if(0!==v.length&&0!==W(t,v).length)return!1}}if(0===c.length&&(o===P||o===R&&0===e.length||0===e.size))return!0;if(void 0===a)a={val1:new Map,val2:new Map,position:0};else{var b=a.val1.get(e);if(void 0!==b){var w=a.val2.get(t);if(void 0!==w)return b===w}a.position++}a.val1.set(e,a.position),a.val2.set(t,a.position);var x=function(e,t,i,a,o,u){var c=0;if(u===q){if(!function(e,t,i,r){for(var a=null,l=n(e),o=0;o<l.length;o++){var u=l[o];if("object"===s(u)&&null!==u)null===a&&(a=new Set),a.add(u);else if(!t.has(u)){if(i)return!1;if(!B(e,t,u))return!1;null===a&&(a=new Set),a.add(u)}}if(null!==a){for(var c=n(t),p=0;p<c.length;p++){var d=c[p];if("object"===s(d)&&null!==d){if(!z(a,d,i,r))return!1}else if(!i&&!e.has(d)&&!z(a,d,i,r))return!1}return 0===a.size}return!0}(e,t,i,o))return!1}else if(u===T){if(!function(e,t,i,a){for(var n=null,o=l(e),u=0;u<o.length;u++){var c=r(o[u],2),p=c[0],d=c[1];if("object"===s(p)&&null!==p)null===n&&(n=new Set),n.add(p);else{var h=t.get(p);if(void 0===h&&!t.has(p)||!M(d,h,i,a)){if(i)return!1;if(!J(e,t,p,d,a))return!1;null===n&&(n=new Set),n.add(p)}}}if(null!==n){for(var f=l(t),m=0;m<f.length;m++){var y=r(f[m],2),g=(p=y[0],y[1]);if("object"===s(p)&&null!==p){if(!X(n,e,p,g,i,a))return!1}else if(!(i||e.has(p)&&M(e.get(p),g,!1,a)||X(n,e,p,g,!1,a)))return!1}return 0===n.size}return!0}(e,t,i,o))return!1}else if(u===R)for(;c<e.length;c++){if(!d(e,c)){if(d(t,c))return!1;for(var p=Object.keys(e);c<p.length;c++){var h=p[c];if(!d(t,h)||!M(e[h],t[h],i,o))return!1}return p.length===Object.keys(t).length}if(!d(t,c)||!M(e[c],t[c],i,o))return!1}for(c=0;c<a.length;c++){var f=a[c];if(!M(e[f],t[f],i,o))return!1}return!0}(e,t,i,c,a,o);return a.val1.delete(e),a.val2.delete(t),x}function z(e,t,i,r){for(var s=n(e),a=0;a<s.length;a++){var l=s[a];if(M(t,l,i,r))return e.delete(l),!0}return!1}function F(e){switch(s(e)){case"undefined":return null;case"object":return;case"symbol":return!1;case"string":e=+e;case"number":if(c(e))return!1}return!0}function B(e,t,i){var r=F(i);return null!=r?r:t.has(r)&&!e.has(r)}function J(e,t,i,r,s){var a=F(i);if(null!=a)return a;var n=t.get(a);return!(void 0===n&&!t.has(a)||!M(r,n,!1,s))&&!e.has(a)&&M(r,n,!1,s)}function X(e,t,i,r,s,a){for(var l=n(e),o=0;o<l.length;o++){var u=l[o];if(M(i,u,s,a)&&M(r,t.get(u),s,a))return e.delete(u),!0}return!1}e.exports={isDeepEqual:function(e,t){return M(e,t,!1)},isDeepStrictEqual:function(e,t){return M(e,t,!0)}}},742:(e,t)=>{"use strict";t.byteLength=function(e){var t=l(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,a=l(e),n=a[0],o=a[1],u=new s(function(e,t,i){return 3*(t+i)/4-i}(0,n,o)),c=0,p=o>0?n-4:n;for(i=0;i<p;i+=4)t=r[e.charCodeAt(i)]<<18|r[e.charCodeAt(i+1)]<<12|r[e.charCodeAt(i+2)]<<6|r[e.charCodeAt(i+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;return 2===o&&(t=r[e.charCodeAt(i)]<<2|r[e.charCodeAt(i+1)]>>4,u[c++]=255&t),1===o&&(t=r[e.charCodeAt(i)]<<10|r[e.charCodeAt(i+1)]<<4|r[e.charCodeAt(i+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,s=r%3,a=[],n=16383,l=0,u=r-s;l<u;l+=n)a.push(o(e,l,l+n>u?u:l+n));return 1===s?(t=e[r-1],a.push(i[t>>2]+i[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],a.push(i[t>>10]+i[t>>4&63]+i[t<<2&63]+"=")),a.join("")};for(var i=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0;n<64;++n)i[n]=a[n],r[a.charCodeAt(n)]=n;function l(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function o(e,t,r){for(var s,a,n=[],l=t;l<r;l+=3)s=(e[l]<<16&16711680)+(e[l+1]<<8&65280)+(255&e[l+2]),n.push(i[(a=s)>>18&63]+i[a>>12&63]+i[a>>6&63]+i[63&a]);return n.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},764:(e,t,i)=>{"use strict";var r=i(108);const s=i(742),a=i(645),n="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.lW=u,t.h2=50;const l=2147483647;function o(e){if(e>l)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,u.prototype),t}function u(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return d(e)}return c(e,t,i)}function c(e,t,i){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!u.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const i=0|y(e,t);let r=o(i);const s=r.write(e,t);return s!==i&&(r=r.slice(0,s)),r}(e,t);if(ArrayBuffer.isView(e))return function(e){if(H(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return h(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(H(e,ArrayBuffer)||e&&H(e.buffer,ArrayBuffer))return f(e,t,i);if("undefined"!=typeof SharedArrayBuffer&&(H(e,SharedArrayBuffer)||e&&H(e.buffer,SharedArrayBuffer)))return f(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return u.from(r,t,i);const s=function(e){if(u.isBuffer(e)){const t=0|m(e.length),i=o(t);return 0===i.length||e.copy(i,0,0,t),i}return void 0!==e.length?"number"!=typeof e.length||Z(e.length)?o(0):h(e):"Buffer"===e.type&&Array.isArray(e.data)?h(e.data):void 0}(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return u.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function p(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e){return p(e),o(e<0?0:0|m(e))}function h(e){const t=e.length<0?0:0|m(e.length),i=o(t);for(let r=0;r<t;r+=1)i[r]=255&e[r];return i}function f(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i),Object.setPrototypeOf(r,u.prototype),r}function m(e){if(e>=l)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l.toString(16)+" bytes");return 0|e}function y(e,t){if(u.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||H(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const i=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===i)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return V(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return G(e).length;default:if(s)return r?-1:V(e).length;t=(""+t).toLowerCase(),s=!0}}function g(e,t,i){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,i);case"utf8":case"utf-8":return I(this,t,i);case"ascii":return D(this,t,i);case"latin1":case"binary":return C(this,t,i);case"base64":return S(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function _(e,t,i){const r=e[t];e[t]=e[i],e[i]=r}function v(e,t,i,r,s){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Z(i=+i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=u.from(t,r)),u.isBuffer(t))return 0===t.length?-1:b(e,t,i,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):b(e,[t],i,r,s);throw new TypeError("val must be string, number or Buffer")}function b(e,t,i,r,s){let a,n=1,l=e.length,o=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;n=2,l/=2,o/=2,i/=2}function u(e,t){return 1===n?e[t]:e.readUInt16BE(t*n)}if(s){let r=-1;for(a=i;a<l;a++)if(u(e,a)===u(t,-1===r?0:a-r)){if(-1===r&&(r=a),a-r+1===o)return r*n}else-1!==r&&(a-=a-r),r=-1}else for(i+o>l&&(i=l-o),a=i;a>=0;a--){let i=!0;for(let r=0;r<o;r++)if(u(e,a+r)!==u(t,r)){i=!1;break}if(i)return a}return-1}function w(e,t,i,r){i=Number(i)||0;const s=e.length-i;r?(r=Number(r))>s&&(r=s):r=s;const a=t.length;let n;for(r>a/2&&(r=a/2),n=0;n<r;++n){const r=parseInt(t.substr(2*n,2),16);if(Z(r))return n;e[i+n]=r}return n}function x(e,t,i,r){return Y(V(t,e.length-i),e,i,r)}function O(e,t,i,r){return Y(function(e){const t=[];for(let i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function k(e,t,i,r){return Y(G(t),e,i,r)}function j(e,t,i,r){return Y(function(e,t){let i,r,s;const a=[];for(let n=0;n<e.length&&!((t-=2)<0);++n)i=e.charCodeAt(n),r=i>>8,s=i%256,a.push(s),a.push(r);return a}(t,e.length-i),e,i,r)}function S(e,t,i){return 0===t&&i===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,i))}function I(e,t,i){i=Math.min(e.length,i);const r=[];let s=t;for(;s<i;){const t=e[s];let a=null,n=t>239?4:t>223?3:t>191?2:1;if(s+n<=i){let i,r,l,o;switch(n){case 1:t<128&&(a=t);break;case 2:i=e[s+1],128==(192&i)&&(o=(31&t)<<6|63&i,o>127&&(a=o));break;case 3:i=e[s+1],r=e[s+2],128==(192&i)&&128==(192&r)&&(o=(15&t)<<12|(63&i)<<6|63&r,o>2047&&(o<55296||o>57343)&&(a=o));break;case 4:i=e[s+1],r=e[s+2],l=e[s+3],128==(192&i)&&128==(192&r)&&128==(192&l)&&(o=(15&t)<<18|(63&i)<<12|(63&r)<<6|63&l,o>65535&&o<1114112&&(a=o))}}null===a?(a=65533,n=1):a>65535&&(a-=65536,r.push(a>>>10&1023|55296),a=56320|1023&a),r.push(a),s+=n}return function(e){const t=e.length;if(t<=A)return String.fromCharCode.apply(String,e);let i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=A));return i}(r)}u.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),u.TYPED_ARRAY_SUPPORT||void 0===r||"function"!=typeof r.error||r.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}}),u.poolSize=8192,u.from=function(e,t,i){return c(e,t,i)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array),u.alloc=function(e,t,i){return function(e,t,i){return p(e),e<=0?o(e):void 0!==t?"string"==typeof i?o(e).fill(t,i):o(e).fill(t):o(e)}(e,t,i)},u.allocUnsafe=function(e){return d(e)},u.allocUnsafeSlow=function(e){return d(e)},u.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==u.prototype},u.compare=function(e,t){if(H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),H(t,Uint8Array)&&(t=u.from(t,t.offset,t.byteLength)),!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let i=e.length,r=t.length;for(let s=0,a=Math.min(i,r);s<a;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);let i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;const r=u.allocUnsafe(t);let s=0;for(i=0;i<e.length;++i){let t=e[i];if(H(t,Uint8Array))s+t.length>r.length?(u.isBuffer(t)||(t=u.from(t)),t.copy(r,s)):Uint8Array.prototype.set.call(r,t,s);else{if(!u.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,s)}s+=t.length}return r},u.byteLength=y,u.prototype._isBuffer=!0,u.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)_(this,t,t+1);return this},u.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},u.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},u.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?I(this,0,e):g.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){let e="";const i=t.h2;return e=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(e+=" ... "),"<Buffer "+e+">"},n&&(u.prototype[n]=u.prototype.inspect),u.prototype.compare=function(e,t,i,r,s){if(H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),!u.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||i>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=i)return 0;if(r>=s)return-1;if(t>=i)return 1;if(this===e)return 0;let a=(s>>>=0)-(r>>>=0),n=(i>>>=0)-(t>>>=0);const l=Math.min(a,n),o=this.slice(r,s),c=e.slice(t,i);for(let e=0;e<l;++e)if(o[e]!==c[e]){a=o[e],n=c[e];break}return a<n?-1:n<a?1:0},u.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},u.prototype.indexOf=function(e,t,i){return v(this,e,t,i,!0)},u.prototype.lastIndexOf=function(e,t,i){return v(this,e,t,i,!1)},u.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}const s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let a=!1;for(;;)switch(r){case"hex":return w(this,e,t,i);case"utf8":case"utf-8":return x(this,e,t,i);case"ascii":case"latin1":case"binary":return O(this,e,t,i);case"base64":return k(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,e,t,i);default:if(a)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),a=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const A=4096;function D(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(127&e[s]);return r}function C(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(e[s]);return r}function E(e,t,i){const r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);let s="";for(let r=t;r<i;++r)s+=Q[e[r]];return s}function N(e,t,i){const r=e.slice(t,i);let s="";for(let e=0;e<r.length-1;e+=2)s+=String.fromCharCode(r[e]+256*r[e+1]);return s}function L(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,i,r,s,a){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<a)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function R(e,t,i,r,s){B(t,r,s,e,i,7);let a=Number(t&BigInt(4294967295));e[i++]=a,a>>=8,e[i++]=a,a>>=8,e[i++]=a,a>>=8,e[i++]=a;let n=Number(t>>BigInt(32)&BigInt(4294967295));return e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n,i}function q(e,t,i,r,s){B(t,r,s,e,i,7);let a=Number(t&BigInt(4294967295));e[i+7]=a,a>>=8,e[i+6]=a,a>>=8,e[i+5]=a,a>>=8,e[i+4]=a;let n=Number(t>>BigInt(32)&BigInt(4294967295));return e[i+3]=n,n>>=8,e[i+2]=n,n>>=8,e[i+1]=n,n>>=8,e[i]=n,i+8}function T(e,t,i,r,s,a){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function M(e,t,i,r,s){return t=+t,i>>>=0,s||T(e,0,i,4),a.write(e,t,i,r,23,4),i+4}function W(e,t,i,r,s){return t=+t,i>>>=0,s||T(e,0,i,8),a.write(e,t,i,r,52,8),i+8}u.prototype.slice=function(e,t){const i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,u.prototype),r},u.prototype.readUintLE=u.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=this[e],s=1,a=0;for(;++a<t&&(s*=256);)r+=this[e+a]*s;return r},u.prototype.readUintBE=u.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=this[e+--t],s=1;for(;t>0&&(s*=256);)r+=this[e+--t]*s;return r},u.prototype.readUint8=u.prototype.readUInt8=function(e,t){return e>>>=0,t||L(e,1,this.length),this[e]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(e,t){return e>>>=0,t||L(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(e,t){return e>>>=0,t||L(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(e,t){return e>>>=0,t||L(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(e,t){return e>>>=0,t||L(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readBigUInt64LE=K((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||X(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,s=this[++e]+256*this[++e]+65536*this[++e]+i*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))})),u.prototype.readBigUInt64BE=K((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||X(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],s=this[++e]*2**24+65536*this[++e]+256*this[++e]+i;return(BigInt(r)<<BigInt(32))+BigInt(s)})),u.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=this[e],s=1,a=0;for(;++a<t&&(s*=256);)r+=this[e+a]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},u.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=t,s=1,a=this[e+--r];for(;r>0&&(s*=256);)a+=this[e+--r]*s;return s*=128,a>=s&&(a-=Math.pow(2,8*t)),a},u.prototype.readInt8=function(e,t){return e>>>=0,t||L(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){e>>>=0,t||L(e,2,this.length);const i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt16BE=function(e,t){e>>>=0,t||L(e,2,this.length);const i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt32LE=function(e,t){return e>>>=0,t||L(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return e>>>=0,t||L(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readBigInt64LE=K((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||X(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(i<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),u.prototype.readBigInt64BE=K((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||X(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+i)})),u.prototype.readFloatLE=function(e,t){return e>>>=0,t||L(e,4,this.length),a.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return e>>>=0,t||L(e,4,this.length),a.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return e>>>=0,t||L(e,8,this.length),a.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return e>>>=0,t||L(e,8,this.length),a.read(this,e,!1,52,8)},u.prototype.writeUintLE=u.prototype.writeUIntLE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||P(this,e,t,i,Math.pow(2,8*i)-1,0);let s=1,a=0;for(this[t]=255&e;++a<i&&(s*=256);)this[t+a]=e/s&255;return t+i},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||P(this,e,t,i,Math.pow(2,8*i)-1,0);let s=i-1,a=1;for(this[t+s]=255&e;--s>=0&&(a*=256);)this[t+s]=e/a&255;return t+i},u.prototype.writeUint8=u.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,255,0),this[t]=255&e,t+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigUInt64LE=K((function(e,t=0){return R(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeBigUInt64BE=K((function(e,t=0){return q(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);P(this,e,t,i,r-1,-r)}let s=0,a=1,n=0;for(this[t]=255&e;++s<i&&(a*=256);)e<0&&0===n&&0!==this[t+s-1]&&(n=1),this[t+s]=(e/a>>0)-n&255;return t+i},u.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);P(this,e,t,i,r-1,-r)}let s=i-1,a=1,n=0;for(this[t+s]=255&e;--s>=0&&(a*=256);)e<0&&0===n&&0!==this[t+s+1]&&(n=1),this[t+s]=(e/a>>0)-n&255;return t+i},u.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},u.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigInt64LE=K((function(e,t=0){return R(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeBigInt64BE=K((function(e,t=0){return q(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeFloatLE=function(e,t,i){return M(this,e,t,!0,i)},u.prototype.writeFloatBE=function(e,t,i){return M(this,e,t,!1,i)},u.prototype.writeDoubleLE=function(e,t,i){return W(this,e,t,!0,i)},u.prototype.writeDoubleBE=function(e,t,i){return W(this,e,t,!1,i)},u.prototype.copy=function(e,t,i,r){if(!u.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);const s=r-i;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,i,r):Uint8Array.prototype.set.call(e,this.subarray(i,r),t),s},u.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;let s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{const a=u.isBuffer(e)?e:u.from(e,r),n=a.length;if(0===n)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<i-t;++s)this[s+t]=a[s%n]}return this};const U={};function z(e,t,i){U[e]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function F(e){let t="",i=e.length;const r="-"===e[0]?1:0;for(;i>=r+4;i-=3)t=`_${e.slice(i-3,i)}${t}`;return`${e.slice(0,i)}${t}`}function B(e,t,i,r,s,a){if(e>i||e<t){const r="bigint"==typeof t?"n":"";let s;throw s=a>3?0===t||t===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(a+1)}${r}`:`>= -(2${r} ** ${8*(a+1)-1}${r}) and < 2 ** ${8*(a+1)-1}${r}`:`>= ${t}${r} and <= ${i}${r}`,new U.ERR_OUT_OF_RANGE("value",s,e)}!function(e,t,i){J(t,"offset"),void 0!==e[t]&&void 0!==e[t+i]||X(t,e.length-(i+1))}(r,s,a)}function J(e,t){if("number"!=typeof e)throw new U.ERR_INVALID_ARG_TYPE(t,"number",e)}function X(e,t,i){if(Math.floor(e)!==e)throw J(e,i),new U.ERR_OUT_OF_RANGE(i||"offset","an integer",e);if(t<0)throw new U.ERR_BUFFER_OUT_OF_BOUNDS;throw new U.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${t}`,e)}z("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),z("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),z("ERR_OUT_OF_RANGE",(function(e,t,i){let r=`The value of "${e}" is out of range.`,s=i;return Number.isInteger(i)&&Math.abs(i)>2**32?s=F(String(i)):"bigint"==typeof i&&(s=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(s=F(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r}),RangeError);const $=/[^+/0-9A-Za-z-_]/g;function V(e,t){let i;t=t||1/0;const r=e.length;let s=null;const a=[];for(let n=0;n<r;++n){if(i=e.charCodeAt(n),i>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(n+1===r){(t-=3)>-1&&a.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&a.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&a.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;a.push(i)}else if(i<2048){if((t-=2)<0)break;a.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;a.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return a}function G(e){return s.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace($,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,i,r){let s;for(s=0;s<r&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}function H(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Z(e){return e!=e}const Q=function(){const e="0123456789abcdef",t=new Array(256);for(let i=0;i<16;++i){const r=16*i;for(let s=0;s<16;++s)t[r+s]=e[i]+e[s]}return t}();function K(e){return"undefined"==typeof BigInt?ee:e}function ee(){throw new Error("BigInt not supported")}},924:(e,t,i)=>{"use strict";var r=i(210),s=i(559),a=s(r("String.prototype.indexOf"));e.exports=function(e,t){var i=r(e,!!t);return"function"==typeof i&&a(e,".prototype.")>-1?s(i):i}},559:(e,t,i)=>{"use strict";var r=i(612),s=i(210),a=s("%Function.prototype.apply%"),n=s("%Function.prototype.call%"),l=s("%Reflect.apply%",!0)||r.call(n,a),o=s("%Object.getOwnPropertyDescriptor%",!0),u=s("%Object.defineProperty%",!0),c=s("%Math.max%");if(u)try{u({},"a",{value:1})}catch(e){u=null}e.exports=function(e){var t=l(r,n,arguments);return o&&u&&o(t,"length").configurable&&u(t,"length",{value:1+c(0,e.length-(arguments.length-1))}),t};var p=function(){return l(r,a,arguments)};u?u(e.exports,"apply",{value:p}):e.exports.apply=p},108:(e,t,i)=>{var r=i(539),s=i(282);function a(){return(new Date).getTime()}var n,l=Array.prototype.slice,o={};n=void 0!==i.g&&i.g.console?i.g.console:"undefined"!=typeof window&&window.console?window.console:{};for(var u=[[function(){},"log"],[function(){n.log.apply(n,arguments)},"info"],[function(){n.log.apply(n,arguments)},"warn"],[function(){n.warn.apply(n,arguments)},"error"],[function(e){o[e]=a()},"time"],[function(e){var t=o[e];if(!t)throw new Error("No such label: "+e);delete o[e];var i=a()-t;n.log(e+": "+i+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=r.format.apply(null,arguments),n.error(e.stack)},"trace"],[function(e){n.log(r.inspect(e)+"\n")},"dir"],[function(e){if(!e){var t=l.call(arguments,1);s.ok(!1,r.format.apply(null,t))}},"assert"]],c=0;c<u.length;c++){var p=u[c],d=p[0],h=p[1];n[h]||(n[h]=d)}e.exports=n},289:(e,t,i)=>{"use strict";var r=i(215),s="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),a=Object.prototype.toString,n=Array.prototype.concat,l=Object.defineProperty,o=i(44)(),u=l&&o,c=function(e,t,i,r){if(t in e)if(!0===r){if(e[t]===i)return}else if("function"!=typeof(s=r)||"[object Function]"!==a.call(s)||!r())return;var s;u?l(e,t,{configurable:!0,enumerable:!1,value:i,writable:!0}):e[t]=i},p=function(e,t){var i=arguments.length>2?arguments[2]:{},a=r(t);s&&(a=n.call(a,Object.getOwnPropertySymbols(t)));for(var l=0;l<a.length;l+=1)c(e,a[l],t[a[l]],i[a[l]])};p.supportsDescriptors=!!u,e.exports=p},91:e=>{"use strict";function t(e,t){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var i=Object(e),r=1;r<arguments.length;r++){var s=arguments[r];if(null!=s)for(var a=Object.keys(Object(s)),n=0,l=a.length;n<l;n++){var o=a[n],u=Object.getOwnPropertyDescriptor(s,o);void 0!==u&&u.enumerable&&(i[o]=s[o])}}return i}e.exports={assign:t,polyfill:function(){Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:t})}}},29:(e,t,i)=>{"use strict";var r=i(320),s=Object.prototype.toString,a=Object.prototype.hasOwnProperty;e.exports=function(e,t,i){if(!r(t))throw new TypeError("iterator must be a function");var n;arguments.length>=3&&(n=i),"[object Array]"===s.call(e)?function(e,t,i){for(var r=0,s=e.length;r<s;r++)a.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,n):"string"==typeof e?function(e,t,i){for(var r=0,s=e.length;r<s;r++)null==i?t(e.charAt(r),r,e):t.call(i,e.charAt(r),r,e)}(e,t,n):function(e,t,i){for(var r in e)a.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,n)}},648:e=>{"use strict";var t=Array.prototype.slice,i=Object.prototype.toString;e.exports=function(e){var r=this;if("function"!=typeof r||"[object Function]"!==i.call(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var s,a=t.call(arguments,1),n=Math.max(0,r.length-a.length),l=[],o=0;o<n;o++)l.push("$"+o);if(s=Function("binder","return function ("+l.join(",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var i=r.apply(this,a.concat(t.call(arguments)));return Object(i)===i?i:this}return r.apply(e,a.concat(t.call(arguments)))})),r.prototype){var u=function(){};u.prototype=r.prototype,s.prototype=new u,u.prototype=null}return s}},612:(e,t,i)=>{"use strict";var r=i(648);e.exports=Function.prototype.bind||r},210:(e,t,i)=>{"use strict";var r,s=SyntaxError,a=Function,n=TypeError,l=function(e){try{return a('"use strict"; return ('+e+").constructor;")()}catch(e){}},o=Object.getOwnPropertyDescriptor;if(o)try{o({},"")}catch(e){o=null}var u=function(){throw new n},c=o?function(){try{return u}catch(e){try{return o(arguments,"callee").get}catch(e){return u}}}():u,p=i(405)(),d=i(185)(),h=Object.getPrototypeOf||(d?function(e){return e.__proto__}:null),f={},m="undefined"!=typeof Uint8Array&&h?h(Uint8Array):r,y={"%AggregateError%":"undefined"==typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":p&&h?h([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":f,"%AsyncGenerator%":f,"%AsyncGeneratorFunction%":f,"%AsyncIteratorPrototype%":f,"%Atomics%":"undefined"==typeof Atomics?r:Atomics,"%BigInt%":"undefined"==typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":a,"%GeneratorFunction%":f,"%Int8Array%":"undefined"==typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":p&&h?h(h([][Symbol.iterator]())):r,"%JSON%":"object"==typeof JSON?JSON:r,"%Map%":"undefined"==typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&p&&h?h((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?r:Promise,"%Proxy%":"undefined"==typeof Proxy?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&p&&h?h((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":p&&h?h(""[Symbol.iterator]()):r,"%Symbol%":p?Symbol:r,"%SyntaxError%":s,"%ThrowTypeError%":c,"%TypedArray%":m,"%TypeError%":n,"%Uint8Array%":"undefined"==typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?r:WeakSet};if(h)try{null.error}catch(e){var g=h(h(e));y["%Error.prototype%"]=g}var _=function e(t){var i;if("%AsyncFunction%"===t)i=l("async function () {}");else if("%GeneratorFunction%"===t)i=l("function* () {}");else if("%AsyncGeneratorFunction%"===t)i=l("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(i=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var s=e("%AsyncGenerator%");s&&h&&(i=h(s.prototype))}return y[t]=i,i},v={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},b=i(612),w=i(642),x=b.call(Function.call,Array.prototype.concat),O=b.call(Function.apply,Array.prototype.splice),k=b.call(Function.call,String.prototype.replace),j=b.call(Function.call,String.prototype.slice),S=b.call(Function.call,RegExp.prototype.exec),I=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,A=/\\(\\)?/g,D=function(e,t){var i,r=e;if(w(v,r)&&(r="%"+(i=v[r])[0]+"%"),w(y,r)){var a=y[r];if(a===f&&(a=_(r)),void 0===a&&!t)throw new n("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:i,name:r,value:a}}throw new s("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new n("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new n('"allowMissing" argument must be a boolean');if(null===S(/^%?[^%]*%?$/,e))throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(e){var t=j(e,0,1),i=j(e,-1);if("%"===t&&"%"!==i)throw new s("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==t)throw new s("invalid intrinsic syntax, expected opening `%`");var r=[];return k(e,I,(function(e,t,i,s){r[r.length]=i?k(s,A,"$1"):t||e})),r}(e),r=i.length>0?i[0]:"",a=D("%"+r+"%",t),l=a.name,u=a.value,c=!1,p=a.alias;p&&(r=p[0],O(i,x([0,1],p)));for(var d=1,h=!0;d<i.length;d+=1){var f=i[d],m=j(f,0,1),g=j(f,-1);if(('"'===m||"'"===m||"`"===m||'"'===g||"'"===g||"`"===g)&&m!==g)throw new s("property names with quotes must have matching quotes");if("constructor"!==f&&h||(c=!0),w(y,l="%"+(r+="."+f)+"%"))u=y[l];else if(null!=u){if(!(f in u)){if(!t)throw new n("base intrinsic for "+e+" exists, but the property is not available.");return}if(o&&d+1>=i.length){var _=o(u,f);u=(h=!!_)&&"get"in _&&!("originalValue"in _.get)?_.get:u[f]}else h=w(u,f),u=u[f];h&&!c&&(y[l]=u)}}return u}},296:(e,t,i)=>{"use strict";var r=i(210)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(e){r=null}e.exports=r},44:(e,t,i)=>{"use strict";var r=i(210)("%Object.defineProperty%",!0),s=function(){if(r)try{return r({},"a",{value:1}),!0}catch(e){return!1}return!1};s.hasArrayLengthDefineBug=function(){if(!s())return null;try{return 1!==r([],"length",{value:1}).length}catch(e){return!0}},e.exports=s},185:e=>{"use strict";var t={foo:{}},i=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!({__proto__:null}instanceof i)}},405:(e,t,i)=>{"use strict";var r="undefined"!=typeof Symbol&&Symbol,s=i(419);e.exports=function(){return"function"==typeof r&&"function"==typeof Symbol&&"symbol"==typeof r("foo")&&"symbol"==typeof Symbol("bar")&&s()}},419:e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(e,t);if(42!==s.value||!0!==s.enumerable)return!1}return!0}},410:(e,t,i)=>{"use strict";var r=i(419);e.exports=function(){return r()&&!!Symbol.toStringTag}},642:(e,t,i)=>{"use strict";var r=i(612);e.exports=r.call(Function.call,Object.prototype.hasOwnProperty)},645:(e,t)=>{t.read=function(e,t,i,r,s){var a,n,l=8*s-r-1,o=(1<<l)-1,u=o>>1,c=-7,p=i?s-1:0,d=i?-1:1,h=e[t+p];for(p+=d,a=h&(1<<-c)-1,h>>=-c,c+=l;c>0;a=256*a+e[t+p],p+=d,c-=8);for(n=a&(1<<-c)-1,a>>=-c,c+=r;c>0;n=256*n+e[t+p],p+=d,c-=8);if(0===a)a=1-u;else{if(a===o)return n?NaN:1/0*(h?-1:1);n+=Math.pow(2,r),a-=u}return(h?-1:1)*n*Math.pow(2,a-r)},t.write=function(e,t,i,r,s,a){var n,l,o,u=8*a-s-1,c=(1<<u)-1,p=c>>1,d=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:a-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,n=c):(n=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-n))<1&&(n--,o*=2),(t+=n+p>=1?d/o:d*Math.pow(2,1-p))*o>=2&&(n++,o/=2),n+p>=c?(l=0,n=c):n+p>=1?(l=(t*o-1)*Math.pow(2,s),n+=p):(l=t*Math.pow(2,p-1)*Math.pow(2,s),n=0));s>=8;e[i+h]=255&l,h+=f,l/=256,s-=8);for(n=n<<s|l,u+=s;u>0;e[i+h]=255&n,h+=f,n/=256,u-=8);e[i+h-f]|=128*m}},717:e=>{"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},584:(e,t,i)=>{"use strict";var r=i(410)(),s=i(924)("Object.prototype.toString"),a=function(e){return!(r&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===s(e)},n=function(e){return!!a(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==s(e)&&"[object Function]"===s(e.callee)},l=function(){return a(arguments)}();a.isLegacyArguments=n,e.exports=l?a:n},320:e=>{"use strict";var t,i,r=Function.prototype.toString,s="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof s&&"function"==typeof Object.defineProperty)try{t=Object.defineProperty({},"length",{get:function(){throw i}}),i={},s((function(){throw 42}),null,t)}catch(e){e!==i&&(s=null)}else s=null;var a=/^\s*class\b/,n=function(e){try{var t=r.call(e);return a.test(t)}catch(e){return!1}},l=function(e){try{return!n(e)&&(r.call(e),!0)}catch(e){return!1}},o=Object.prototype.toString,u="function"==typeof Symbol&&!!Symbol.toStringTag,c=!(0 in[,]),p=function(){return!1};if("object"==typeof document){var d=document.all;o.call(d)===o.call(document.all)&&(p=function(e){if((c||!e)&&(void 0===e||"object"==typeof e))try{var t=o.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}e.exports=s?function(e){if(p(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{s(e,null,t)}catch(e){if(e!==i)return!1}return!n(e)&&l(e)}:function(e){if(p(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(u)return l(e);if(n(e))return!1;var t=o.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&l(e)}},662:(e,t,i)=>{"use strict";var r,s=Object.prototype.toString,a=Function.prototype.toString,n=/^\s*(?:function)?\*/,l=i(410)(),o=Object.getPrototypeOf;e.exports=function(e){if("function"!=typeof e)return!1;if(n.test(a.call(e)))return!0;if(!l)return"[object GeneratorFunction]"===s.call(e);if(!o)return!1;if(void 0===r){var t=function(){if(!l)return!1;try{return Function("return function*() {}")()}catch(e){}}();r=!!t&&o(t)}return o(e)===r}},611:e=>{"use strict";e.exports=function(e){return e!=e}},360:(e,t,i)=>{"use strict";var r=i(559),s=i(289),a=i(611),n=i(415),l=i(194),o=r(n(),Number);s(o,{getPolyfill:n,implementation:a,shim:l}),e.exports=o},415:(e,t,i)=>{"use strict";var r=i(611);e.exports=function(){return Number.isNaN&&Number.isNaN(NaN)&&!Number.isNaN("a")?Number.isNaN:r}},194:(e,t,i)=>{"use strict";var r=i(289),s=i(415);e.exports=function(){var e=s();return r(Number,{isNaN:e},{isNaN:function(){return Number.isNaN!==e}}),e}},692:(e,t,i)=>{"use strict";var r=i(430);e.exports=function(e){return!!r(e)}},244:e=>{"use strict";var t=function(e){return e!=e};e.exports=function(e,i){return 0===e&&0===i?1/e==1/i:e===i||!(!t(e)||!t(i))}},609:(e,t,i)=>{"use strict";var r=i(289),s=i(559),a=i(244),n=i(624),l=i(281),o=s(n(),Object);r(o,{getPolyfill:n,implementation:a,shim:l}),e.exports=o},624:(e,t,i)=>{"use strict";var r=i(244);e.exports=function(){return"function"==typeof Object.is?Object.is:r}},281:(e,t,i)=>{"use strict";var r=i(624),s=i(289);e.exports=function(){var e=r();return s(Object,{is:e},{is:function(){return Object.is!==e}}),e}},987:(e,t,i)=>{"use strict";var r;if(!Object.keys){var s=Object.prototype.hasOwnProperty,a=Object.prototype.toString,n=i(414),l=Object.prototype.propertyIsEnumerable,o=!l.call({toString:null},"toString"),u=l.call((function(){}),"prototype"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],p=function(e){var t=e.constructor;return t&&t.prototype===e},d={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},h=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!d["$"+e]&&s.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{p(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();r=function(e){var t=null!==e&&"object"==typeof e,i="[object Function]"===a.call(e),r=n(e),l=t&&"[object String]"===a.call(e),d=[];if(!t&&!i&&!r)throw new TypeError("Object.keys called on a non-object");var f=u&&i;if(l&&e.length>0&&!s.call(e,0))for(var m=0;m<e.length;++m)d.push(String(m));if(r&&e.length>0)for(var y=0;y<e.length;++y)d.push(String(y));else for(var g in e)f&&"prototype"===g||!s.call(e,g)||d.push(String(g));if(o)for(var _=function(e){if("undefined"==typeof window||!h)return p(e);try{return p(e)}catch(e){return!1}}(e),v=0;v<c.length;++v)_&&"constructor"===c[v]||!s.call(e,c[v])||d.push(c[v]);return d}}e.exports=r},215:(e,t,i)=>{"use strict";var r=Array.prototype.slice,s=i(414),a=Object.keys,n=a?function(e){return a(e)}:i(987),l=Object.keys;n.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return s(e)?l(r.call(e)):l(e)})}else Object.keys=n;return Object.keys||n},e.exports=n},414:e=>{"use strict";var t=Object.prototype.toString;e.exports=function(e){var i=t.call(e),r="[object Arguments]"===i;return r||(r="[object Array]"!==i&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===t.call(e.callee)),r}},155:e=>{var t,i,r=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function n(e){if(t===setTimeout)return setTimeout(e,0);if((t===s||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(i){try{return t.call(null,e,0)}catch(i){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:s}catch(e){t=s}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(e){i=a}}();var l,o=[],u=!1,c=-1;function p(){u&&l&&(u=!1,l.length?o=l.concat(o):c=-1,o.length&&d())}function d(){if(!u){var e=n(p);u=!0;for(var t=o.length;t;){for(l=o,o=[];++c<t;)l&&l[c].run();c=-1,t=o.length}l=null,u=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function f(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];o.push(new h(e,t)),1!==o.length||u||n(d)},h.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},384:e=>{e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},955:(e,t,i)=>{"use strict";var r=i(584),s=i(662),a=i(430),n=i(692);function l(e){return e.call.bind(e)}var o="undefined"!=typeof BigInt,u="undefined"!=typeof Symbol,c=l(Object.prototype.toString),p=l(Number.prototype.valueOf),d=l(String.prototype.valueOf),h=l(Boolean.prototype.valueOf);if(o)var f=l(BigInt.prototype.valueOf);if(u)var m=l(Symbol.prototype.valueOf);function y(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function g(e){return"[object Map]"===c(e)}function _(e){return"[object Set]"===c(e)}function v(e){return"[object WeakMap]"===c(e)}function b(e){return"[object WeakSet]"===c(e)}function w(e){return"[object ArrayBuffer]"===c(e)}function x(e){return"undefined"!=typeof ArrayBuffer&&(w.working?w(e):e instanceof ArrayBuffer)}function O(e){return"[object DataView]"===c(e)}function k(e){return"undefined"!=typeof DataView&&(O.working?O(e):e instanceof DataView)}t.isArgumentsObject=r,t.isGeneratorFunction=s,t.isTypedArray=n,t.isPromise=function(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch},t.isArrayBufferView=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):n(e)||k(e)},t.isUint8Array=function(e){return"Uint8Array"===a(e)},t.isUint8ClampedArray=function(e){return"Uint8ClampedArray"===a(e)},t.isUint16Array=function(e){return"Uint16Array"===a(e)},t.isUint32Array=function(e){return"Uint32Array"===a(e)},t.isInt8Array=function(e){return"Int8Array"===a(e)},t.isInt16Array=function(e){return"Int16Array"===a(e)},t.isInt32Array=function(e){return"Int32Array"===a(e)},t.isFloat32Array=function(e){return"Float32Array"===a(e)},t.isFloat64Array=function(e){return"Float64Array"===a(e)},t.isBigInt64Array=function(e){return"BigInt64Array"===a(e)},t.isBigUint64Array=function(e){return"BigUint64Array"===a(e)},g.working="undefined"!=typeof Map&&g(new Map),t.isMap=function(e){return"undefined"!=typeof Map&&(g.working?g(e):e instanceof Map)},_.working="undefined"!=typeof Set&&_(new Set),t.isSet=function(e){return"undefined"!=typeof Set&&(_.working?_(e):e instanceof Set)},v.working="undefined"!=typeof WeakMap&&v(new WeakMap),t.isWeakMap=function(e){return"undefined"!=typeof WeakMap&&(v.working?v(e):e instanceof WeakMap)},b.working="undefined"!=typeof WeakSet&&b(new WeakSet),t.isWeakSet=function(e){return b(e)},w.working="undefined"!=typeof ArrayBuffer&&w(new ArrayBuffer),t.isArrayBuffer=x,O.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&O(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=k;var j="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function S(e){return"[object SharedArrayBuffer]"===c(e)}function I(e){return void 0!==j&&(void 0===S.working&&(S.working=S(new j)),S.working?S(e):e instanceof j)}function A(e){return y(e,p)}function D(e){return y(e,d)}function C(e){return y(e,h)}function E(e){return o&&y(e,f)}function N(e){return u&&y(e,m)}t.isSharedArrayBuffer=I,t.isAsyncFunction=function(e){return"[object AsyncFunction]"===c(e)},t.isMapIterator=function(e){return"[object Map Iterator]"===c(e)},t.isSetIterator=function(e){return"[object Set Iterator]"===c(e)},t.isGeneratorObject=function(e){return"[object Generator]"===c(e)},t.isWebAssemblyCompiledModule=function(e){return"[object WebAssembly.Module]"===c(e)},t.isNumberObject=A,t.isStringObject=D,t.isBooleanObject=C,t.isBigIntObject=E,t.isSymbolObject=N,t.isBoxedPrimitive=function(e){return A(e)||D(e)||C(e)||E(e)||N(e)},t.isAnyArrayBuffer=function(e){return"undefined"!=typeof Uint8Array&&(x(e)||I(e))},["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},539:(e,t,i)=>{var r=i(155),s=i(108),a=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++)i[t[r]]=Object.getOwnPropertyDescriptor(e,t[r]);return i},n=/%[sdj%]/g;t.format=function(e){if(!b(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(c(arguments[i]));return t.join(" ")}i=1;for(var r=arguments,s=r.length,a=String(e).replace(n,(function(e){if("%%"===e)return"%";if(i>=s)return e;switch(e){case"%s":return String(r[i++]);case"%d":return Number(r[i++]);case"%j":try{return JSON.stringify(r[i++])}catch(e){return"[Circular]"}default:return e}})),l=r[i];i<s;l=r[++i])_(l)||!O(l)?a+=" "+l:a+=" "+c(l);return a},t.deprecate=function(e,i){if(void 0!==r&&!0===r.noDeprecation)return e;if(void 0===r)return function(){return t.deprecate(e,i).apply(this,arguments)};var a=!1;return function(){if(!a){if(r.throwDeprecation)throw new Error(i);r.traceDeprecation?s.trace(i):s.error(i),a=!0}return e.apply(this,arguments)}};var l={},o=/^$/;if(r.env.NODE_DEBUG){var u=r.env.NODE_DEBUG;u=u.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+u+"$","i")}function c(e,i){var r={seen:[],stylize:d};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),g(i)?r.showHidden=i:i&&t._extend(r,i),w(r.showHidden)&&(r.showHidden=!1),w(r.depth)&&(r.depth=2),w(r.colors)&&(r.colors=!1),w(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=p),h(r,e,r.depth)}function p(e,t){var i=c.styles[t];return i?"["+c.colors[i][0]+"m"+e+"["+c.colors[i][1]+"m":e}function d(e,t){return e}function h(e,i,r){if(e.customInspect&&i&&S(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(r,e);return b(s)||(s=h(e,s,r)),s}var a=function(e,t){if(w(t))return e.stylize("undefined","undefined");if(b(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return v(t)?e.stylize(""+t,"number"):g(t)?e.stylize(""+t,"boolean"):_(t)?e.stylize("null","null"):void 0}(e,i);if(a)return a;var n=Object.keys(i),l=function(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}(n);if(e.showHidden&&(n=Object.getOwnPropertyNames(i)),j(i)&&(n.indexOf("message")>=0||n.indexOf("description")>=0))return f(i);if(0===n.length){if(S(i)){var o=i.name?": "+i.name:"";return e.stylize("[Function"+o+"]","special")}if(x(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(k(i))return e.stylize(Date.prototype.toString.call(i),"date");if(j(i))return f(i)}var u,c="",p=!1,d=["{","}"];return y(i)&&(p=!0,d=["[","]"]),S(i)&&(c=" [Function"+(i.name?": "+i.name:"")+"]"),x(i)&&(c=" "+RegExp.prototype.toString.call(i)),k(i)&&(c=" "+Date.prototype.toUTCString.call(i)),j(i)&&(c=" "+f(i)),0!==n.length||p&&0!=i.length?r<0?x(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),u=p?function(e,t,i,r,s){for(var a=[],n=0,l=t.length;n<l;++n)C(t,String(n))?a.push(m(e,t,i,r,String(n),!0)):a.push("");return s.forEach((function(s){s.match(/^\d+$/)||a.push(m(e,t,i,r,s,!0))})),a}(e,i,r,l,n):n.map((function(t){return m(e,i,r,l,t,p)})),e.seen.pop(),function(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]}(u,c,d)):d[0]+c+d[1]}function f(e){return"["+Error.prototype.toString.call(e)+"]"}function m(e,t,i,r,s,a){var n,l,o;if((o=Object.getOwnPropertyDescriptor(t,s)||{value:t[s]}).get?l=o.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):o.set&&(l=e.stylize("[Setter]","special")),C(r,s)||(n="["+s+"]"),l||(e.seen.indexOf(o.value)<0?(l=_(i)?h(e,o.value,null):h(e,o.value,i-1)).indexOf("\n")>-1&&(l=a?l.split("\n").map((function(e){return"  "+e})).join("\n").slice(2):"\n"+l.split("\n").map((function(e){return"   "+e})).join("\n")):l=e.stylize("[Circular]","special")),w(n)){if(a&&s.match(/^\d+$/))return l;(n=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(n=n.slice(1,-1),n=e.stylize(n,"name")):(n=n.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),n=e.stylize(n,"string"))}return n+": "+l}function y(e){return Array.isArray(e)}function g(e){return"boolean"==typeof e}function _(e){return null===e}function v(e){return"number"==typeof e}function b(e){return"string"==typeof e}function w(e){return void 0===e}function x(e){return O(e)&&"[object RegExp]"===I(e)}function O(e){return"object"==typeof e&&null!==e}function k(e){return O(e)&&"[object Date]"===I(e)}function j(e){return O(e)&&("[object Error]"===I(e)||e instanceof Error)}function S(e){return"function"==typeof e}function I(e){return Object.prototype.toString.call(e)}function A(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(e=e.toUpperCase(),!l[e])if(o.test(e)){var i=r.pid;l[e]=function(){var r=t.format.apply(t,arguments);s.error("%s %d: %s",e,i,r)}}else l[e]=function(){};return l[e]},t.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=i(955),t.isArray=y,t.isBoolean=g,t.isNull=_,t.isNullOrUndefined=function(e){return null==e},t.isNumber=v,t.isString=b,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=w,t.isRegExp=x,t.types.isRegExp=x,t.isObject=O,t.isDate=k,t.types.isDate=k,t.isError=j,t.types.isNativeError=j,t.isFunction=S,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=i(384);var D=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function C(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){var e,i;s.log("%s - %s",(i=[A((e=new Date).getHours()),A(e.getMinutes()),A(e.getSeconds())].join(":"),[e.getDate(),D[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=i(717),t._extend=function(e,t){if(!t||!O(t))return e;for(var i=Object.keys(t),r=i.length;r--;)e[i[r]]=t[i[r]];return e};var E="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function N(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(E&&e[E]){var t;if("function"!=typeof(t=e[E]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,E,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,r=new Promise((function(e,r){t=e,i=r})),s=[],a=0;a<arguments.length;a++)s.push(arguments[a]);s.push((function(e,r){e?i(e):t(r)}));try{e.apply(this,s)}catch(e){i(e)}return r}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),E&&Object.defineProperty(t,E,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,a(e))},t.promisify.custom=E,t.callbackify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);var s=t.pop();if("function"!=typeof s)throw new TypeError("The last argument must be of type Function");var a=this,n=function(){return s.apply(a,arguments)};e.apply(this,t).then((function(e){r.nextTick(n.bind(null,null,e))}),(function(e){r.nextTick(N.bind(null,e,n))}))}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,a(e)),t}},430:(e,t,i)=>{"use strict";var r=i(29),s=i(83),a=i(559),n=i(924),l=i(296),o=n("Object.prototype.toString"),u=i(410)(),c="undefined"==typeof globalThis?i.g:globalThis,p=s(),d=n("String.prototype.slice"),h=Object.getPrototypeOf,f=n("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},m={__proto__:null};r(p,u&&l&&h?function(e){var t=new c[e];if(Symbol.toStringTag in t){var i=h(t),r=l(i,Symbol.toStringTag);if(!r){var s=h(i);r=l(s,Symbol.toStringTag)}m["$"+e]=a(r.get)}}:function(e){var t=new c[e];m["$"+e]=a(t.slice)}),e.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!u){var t=d(o(e),8,-1);return f(p,t)>-1?t:"Object"===t&&function(e){var t=!1;return r(m,(function(i,r){if(!t)try{i(e),t=d(r,1)}catch(e){}})),t}(e)}return l?function(e){var t=!1;return r(m,(function(i,r){if(!t)try{"$"+i(e)===r&&(t=d(r,1))}catch(e){}})),t}(e):null}},83:(e,t,i)=>{"use strict";var r=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],s="undefined"==typeof globalThis?i.g:globalThis;e.exports=function(){for(var e=[],t=0;t<r.length;t++)"function"==typeof s[r[t]]&&(e[e.length]=r[t]);return e}}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,i),a.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{"use strict";let e=e=>crypto.getRandomValues(new Uint8Array(e));var t,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,v,b,w,x,O,k,j,S,I,A,D=i(155),C=i(108),E=i(764).lW,N=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(l in s=JSON.parse(SECRETS_SERVER))r[l]=s[l]}catch(e){}null==r&&(r={}),null==r.name&&(r.name="OA.Works"),null==r.kv&&(r.kv="oaworks"),null==r.version&&(r.version="6.1.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0);try{D.env.name&&D.env.name.endsWith("_async")&&(r.async=!0)}catch(e){}try{D.env.name&&D.env.name.endsWith("_loop")&&(r.async_loop=!0)}catch(e){}try{D.env.name&&D.env.name.endsWith("_schedule")&&(r.async_schedule=!0)}catch(e){}null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.formats&&(r.formats=["html","csv","json"]),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(e){return!1!==r.pass&&e.passThroughOnException(),e.respondWith(t.call(e))}))}catch(e){}n={},a={},t=async function(){var e,s,n,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke;this.started=Date.now();try{null==(o=r.headers)[E="x-"+r.name.toLowerCase()]&&(o[E]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(u=this.S).cache&&(u.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),i.g[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(T="",b=0,j=(z=this.request.url.split("?")[1].split("&")).length;b<j;b++)if((x=(U=z[b]).split("="))[0].length){if(1===x.length&&T&&(x[0].startsWith(" ")||x[0].includes("%")))this.params[T]+="&"+decodeURIComponent(x[0]);else{if(this.params[x[0]]=1===x.length||"string"==typeof x[1]&&"true"===x[1].toLowerCase()||("string"!=typeof x[1]||"false"!==x[1].toLowerCase())&&(!!U.endsWith("=")||x[1]),"string"!=typeof this.params[x[0]]||0!==this.params[x[0]].replace(/[0-9]/g,"").length||"0"!==this.params[x[0]]&&this.params[x[0]].startsWith("0")||(O=parseInt(this.params[x[0]]),isNaN(O)||(this.params[x[0]]=O)),"string"==typeof this.params[x[0]]&&this.params[x[0]].includes("%"))try{this.params[x[0]]=decodeURIComponent(this.params[x[0]])}catch(e){}if("string"==typeof this.params[x[0]]&&(this.params[x[0]].startsWith("[")||this.params[x[0]].startsWith("{")))try{this.params[x[0]]=JSON.parse(this.params[x[0]])}catch(e){}}T=x[0]}this.headers={};try{for(F=[...this.request.headers],w=0,S=F.length;w<S;w++)_=F[w],this.headers[_[0].toLowerCase()]=_[1]}catch(e){try{for(v in this.request.headers)this.headers[v.toLowerCase()]=this.request.headers[v]}catch(e){}}if(null==(c=this.headers).ip&&(c.ip=null!=(K=this.headers["x-real-ip"])?K:this.headers["x-forwarded-for"]),f=null!=(ce=this.headers["content-type"])?ce:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(f.includes("/json"))this.body=await this.request.json();else if(f.includes("form")){for(y in d={},(await this.request.formData()).entries())y[0]&&(null!=d[y[0]]?(Array.isArray(d[y[0]])||(d[y[0]]=[d[y[0]]]),d[y[0]].push(y[1])):d[y[0]]=y[1]);null!=d&&"{}"!==JSON.stringify(d)&&(this.body=d)}if(null==this.body&&("POST"===(fe=this.request.method)||"PUT"===fe||"DELETE"===fe)){try{d=await this.request.text()}catch(e){}d&&(this.body=d)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(e){}if("object"==typeof this.body&&!Array.isArray(this.body))for(U in this.body)U&&null==(p=this.params)[U]&&(p[U]=this.body[U]);try{this.cookie=null!=(me=this.headers.Cookie)?me:this.headers.cookie}catch(e){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(e){}null==this.rid&&(this.rid=t.uid());try{this.apikey=null!=(ye=null!=(ge=this.headers["x-apikey"])?ge:this.headers.apikey)?ye:this.params.apikey}catch(e){}for(k=0,I=(_e=["x-apikey","apikey"]).length;k<I;k++)xe=_e[k],null!=this.headers[xe]&&delete this.headers[xe],null!=this.params[xe]&&delete this.params[xe];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(e){}this.parts=(null!=m?m:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(e){}this.parts=this.url.length?(null!=m?m:this.url).split("/"):[];try{this.base=this.headers.host}catch(e){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(P=this.parts[this.parts.length-1].split(".").pop().toLowerCase(),N.call(this.S.formats,P)>=0&&(this.format=P,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+P,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(ve=this.parts[0],N.call(this.S.pass,ve)>=0))throw new Error;if(Oe="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[Oe]===this.S.system&&(delete this.headers[Oe],this.system=!0),this._logs=[],this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(B=this.request.method)||"OPTIONS"===B?t._response.call(this,""):t._response.call(this,{name:null!=(J=this.S.name)?J:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=(X=null!=($=this.user)?$.email:void 0)?X:void 0});for(g=void 0,W=[...this.parts],R=void 0,M=[],e=async(i,r,s,n,o)=>{var u,c,p,d,h,f,m,y,_,v,b,w,x,O,k,j,S,I;if(R&&this.fn.startsWith(s))for(;W.length&&null==i[W[0]];)this.params[R]=(this.params[R]?this.params[R]+"/":"")+W.shift(),N.call(M,R)<0&&M.push(R);for(l in j=[],i)if("function"!=(x=typeof i[l])&&"object"!==x)j.push(r[l]=i[l]);else if(null!=i[l]){if(b=s+(s?".":"")+l,"object"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._sheet||i[l]._kv||i[l]._bg){if(null==(p=i[l])._auth&&(p._auth=null!=(d=i[l])._auths?d._auths:d._auths=n),Array.isArray(i[l]._auths)&&0===i[l]._auths.length&&(i[l]._auths=b.split(".")),Array.isArray(i[l]._auth)&&0===i[l]._auth.length&&(i[l]._auth=b.split(".")),null==(h=i[l])._cache&&(h._cache=null!=(f=i[l])._caches?f._caches:f._caches=o),b.startsWith("auth")&&null==(m=i[l])._cache&&(m._cache=!1),i[l]._sheet&&null==(y=i[l])._index&&(y._index=!0),i[l]._index)for(w=0,v=(O=["keys","terms","suggest","count","percent","min","max","range","sum","average","mapping","_for","_each","_bulk","_refresh"]).length;w<v;w++)_=O[w],null==(u=i[l])[_]&&(u[_]={_indexed:_,_auth:_.startsWith("_")?"system":i[l]._auth});for(I in"function"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._kv||i[l]._bg||b.includes(".")&&!s.startsWith("index")&&!b.split(".").pop().startsWith("_")?r[l]=t._wrapper(i[l],b).bind(this):r[l]=i[l].bind(this),i[l])I.startsWith("_")&&(r[l][I]=i[l][I])}else r[l]=JSON.parse(JSON.stringify(i[l]));null==(c=r[l])._name&&(c._name=b),r[l]._schedule&&!a[b]&&!0===this.S.bg&&!1!==this.S.cron&&(C.log("Adding schedule",r[l]._schedule,b),a[b]={schedule:r[l]._schedule,fn:r[l]},S=e=>async()=>{var t,i,r,s,n,l,o,u,c;if(s=a[e].fn,t=null!=(n=this.S.async_runner)?n[null!=(l=s._runner)?l:e]:void 0,!(!0===this.S.dev||this.S.async||this.S.async_loop||this.S.async_schedule||null==D.env.pm_id||1===(o=D.env.pm_id)||"1"===o))return C.log("NOT running scheduled task because not on dev and process pid is not 1",e,this.datetime());if("string"!=typeof t&&!this.S.async_schedule&&"string"==typeof this.S.async)return C.log("NOT running scheduled task because not on the available async process",e,this.datetime());if(!("string"==typeof t||"string"!=typeof this.S.async_schedule||"loop"===s._schedule&&this.S.async_loop))return C.log("NOT running scheduled task because not on the available async scheduled process",e,this.datetime());if("string"!=typeof t&&"string"==typeof this.S.async_loop&&"loop"===s._schedule)return C.log("NOT running scheduled looped task because not on the available loop process",e,this.datetime());if("string"==typeof t&&D.env.name&&!D.env.name.endsWith((null!=(u=s._runner)?u:e).replace(/\./g,"_").replace("__","_")))return C.log("NOT running scheduled task because not on the specified process runner",null!=(c=s._runner)?c:e,this.datetime());C.log("scheduled task",e,this.datetime()),a[e].last=await this.datetime(),delete a[e].error;try{i=s._sheet?await this._loadsheet(a[e].fn,s._name.replace(/\./g,"_")):await a[e].fn(s._args);try{a[e].result=JSON.stringify(i).substr(0,200)}catch(e){}if(a[e].success=!0,C.log("scheduled task result",i),"loop"===s._schedule)return C.log("Schedule looping",e),(await S(e))()}catch(t){r=t,a[e].success=!1;try{return a[e].error=JSON.stringify(r)}catch(e){}}},"loop"===(k=r[l]._schedule)||"startup"===k?(C.log("Starting scheduled",r[l]._schedule,b),(await S(b))()):cron.schedule(r[l]._schedule,S(b))),l.startsWith("_")||(W.length&&W[0]===l&&this.fn.startsWith(s)&&(R=W.shift(),this.fn+=(""===this.fn?"":".")+R,"function"!=typeof r[l]||s.includes("._")||(g=r[l])),"function"==typeof r[l]&&1===b.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(b.replace(/\./g,"/"))),Array.isArray(i[l])||l.startsWith("_")&&"function"!=typeof r[l]||"fn"===l?j.push(void 0):j.push(e(i[l],r[l],b,null!=n?n:i[l]._auths,null!=o?o:i[l]._caches))}else j.push(void 0);return j},e(t,this,""),R&&W.length&&(this.params[R]=this.params[R]?this.params[R]+"/"+W.join("/"):W.join("/")),L=0,A=M.length;L<A;L++)h=M[L],"true"===this.params[h].toLowerCase()&&(this.params[h]=!0),"false"===this.params[h].toLowerCase()&&(this.params[h]=!1),"string"!=typeof this.params[h]||0!==this.params[h].replace(/[0-9]/g,"").length||this.params[h].startsWith("0")||(q=parseInt(this.params[h]),isNaN(q)||(this.params[h]=q));if(this.S.dev&&!0===this.S.bg&&C.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(V=typeof g)||"function"===V)&&g._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("object"!=(G=typeof g)&&"function"!==G||!(g._async||"all"===this.params.size&&g._index&&!(null!=(Y=D.env.name)?Y:"").endsWith("_makecsv"))||"string"!=typeof this.S.async||"string"==typeof(null!=(H=this.S.async_runner)?H[null!=(Z=g._runner)?Z:this.fn]:void 0)&&D.env.name&&D.env.name.endsWith((null!=(Q=g._runner)?Q:this.fn).replace(/\./g,"_"))?"function"==typeof g&&("object"==typeof(n="auth"===this.fn?void 0:await this.auth())&&n._id&&n.email&&(this.user=n),(n="function"==typeof g._auth?await g._auth():!0===g._auth&&null!=this.user||!g._auth||await this.auth.role(g._auth))||this.system?"HEAD"===(se=this.request.method)||"OPTIONS"===se?be="":!1!==g._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(be=await this.cache())?(this.cached="cache",(be=new Response(be.body,be)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),be.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(be=await g(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(be={status:401}).body=await this.auth(!1))):(s="all"===this.params.size&&g._index&&(null!=(ee=this.S.async_runner)?ee._makecsv:void 0)?this.S.async_runner._makecsv:null!=(te=null!=(ie=this.S.async_runner)?ie[null!=(re=g._runner)?re:this.fn]:void 0)?te:this.S.async,C.log("Fetching from async process",s,this.request.url),be=await this.fetch(s+this.request.url,{method:this.request.method,headers:this.headers,body:this.request.body}),delete this.format),(null==be||"object"==typeof be&&404===be.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(be=""),we="object"!=typeof be||Array.isArray(be)||"function"!=typeof(null!=(ae=be.headers)?ae.append:void 0)?await this._response(be,g):be,this.parts.length&&"log"!==(ne=this.parts[0])&&"status"!==ne&&(!this.system||"kv"!==(le=this.parts[0])&&"index"!==le)&&"HEAD"!==(oe=this.request.method)&&"OPTIONS"!==oe&&null!=be&&""!==be&&(!this.completed||!1===g._cache||200!==we.status||"object"==typeof be&&!Array.isArray(be)&&0===(null!=(ue=be.hits)?ue.total:void 0)||"number"==typeof be&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(ke=g._cache)||"object"!=typeof be||Array.isArray(be)||null==(null!=(pe=be.hits)?pe.hits:void 0)||(ke=60),this.cache(void 0,we,ke)),"object"!=(de=typeof g)&&"function"!==de||!1===g._log||this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(he=this.request.method)||"OPTIONS"===he)return we;throw new Error},t._response=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k;if(null==(s=this.S).headers&&(s.headers={}),null==e)e=404,O=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(l in e.headers)this.S.headers[l]=e.headers[l];delete e.headers}O=null!=(g=e.status)?g:200,delete e.status,0===(d=this.keys(e)).length?e=O:1===d.length&&(e=e[d[0]])}else O=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&(_=this.format,N.call(this.S.formats,_)>=0)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}if("string"==typeof e&&"html"===this.format&&!(e=e.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(w='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',w+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',e.includes("<title")?([y,k]=e.split("<title"),[k,r]=k.split("</title>"),w+="<title"+k+"</title>\n",e=y+r):e.includes('id="title"')&&(w+="<title>"+e.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),c=0,h=(v=["<meta ","<link "]).length;c<h;c++)if(o=v[c],e.includes(o))for(p=0,f=(b=e.split(o)).length;p<f;p++)x=o+b[p].split(">")[0],e=e.replace(x,""),w+=x+"\n";e.includes("<head>")&&([m,u]=e.split("<head>"),[u,i]=u.split("</head>"),w+=u,e=m+i),w.includes("icon")||(w+='<link rel="icon" href="data:,">'),w+="\n</head>\n",w+=e.includes("<body")?e:"\n<body>\n"+e+"\n</body>\n",e=w+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(a=this.S.headers)["Content-Type"]&&(a["Content-Type"]="application/json; charset=UTF-8")}try{null==(n=this.S.headers)["Content-Length"]&&(n["Content-Length"]=E.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(e){}try{return!0===this.S.bg?{status:O,headers:this.S.headers,body:e}:new Response(e,{status:O,headers:this.S.headers})}catch(t){return{status:O,headers:this.S.headers,body:e}}},t._loadsheet=async function(e,t){var i,r,s,a,n,l;if(e._sheet.startsWith("http")&&e._sheet.includes("csv")?n=await this.convert.csv2json(e._sheet):e._sheet.startsWith("http")&&e._sheet.includes("json")?(n=await this.fetch(e._sheet))&&!Array.isArray(n)&&(n=[n]):n=await this.src.google.sheets(e._sheet),Array.isArray(n)&&n.length){if("function"==typeof e._format&&(n=await e._format.apply(this,[n])),e._key)for(i=0,r=n.length;i<r;i++)null==(l=n[i])._id&&(l._id=(null!=(s=l[e._key])?s:this.uid()).replace(/\//g,"_").toLowerCase());return await this.index(t,""),await this.index(t,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(a=e._index.mappings)?a:e._index.mapping,aliases:e._index.aliases}),await this.index(t,n),n.length}return 0},t._wrapper=function(e,t){return async function(){var i,s,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe;if(de=Date.now(),pe=t.replace(/\./g,"_"),S={fn:t},e._limit)for(I=await this.kv("limit/"+t);I;)null==S.limited&&(S.limited=0),S.limited+=I,await this.sleep(I-de),I=await this.kv("limit/"+t);if("string"==(z=typeof this.params._async)||"number"===z)if(ce=await this.kv("async/"+this.params._async,"")){if("string"==typeof ce&&ce.includes("/")&&!ce.includes(" ")&&!ce.includes(":")&&!ce.startsWith("10.")&&2===ce.split("/").length){try{e._kv&&(ce=await this.kv(ce))}catch(e){}try{null==ce&&e._index&&(ce=await this.index(ce))}catch(e){}}try{"string"==typeof ce&&(ce.startsWith("{")||ce.startsWith("["))&&(ce=JSON.parse(ce))}catch(e){}}else ce={_async:this.params._async};else if(this.fn===t&&e._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)ce={status:302},e._sheet.startsWith("http")?ce.body=e._sheet:"json"===this.format?ce.body="https://sheets.googleapis.com/v4/spreadsheets/"+e._sheet.split("/")[0]+"/values/"+(null!=(F=null!=(K=e._sheetid)?K:e._sheet.split("/")[1])?F:"Sheet1")+"?alt=json":ce.body="https://docs.google.com/spreadsheets/d/"+e._sheet.split("/")[0],ce.headers={Location:ce.body};else if(e._indexed)(o=[...arguments]).unshift(pe.replace("_"+e._indexed,"")),ce=await this.index[e._indexed](...o);else if((e._index||e._kv)&&(!e._sheet||this.fn!==t||!this.refresh)){if(this.fn===t?(this.fn.replace(/\./g,"/")!==this.route&&(S.key=this.route.split(t.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!S.key&&e._index&&(W=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\*~\?="]/g,"").length&&(S.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(S.key=arguments[0].toString()),e._index&&!S.key&&(W=await this.index.translate(arguments[0],arguments[1])),U=null!=W?void 0:S.key?arguments[1]:e._index?arguments[0]:void 0),"object"==typeof U)if(Array.isArray(U)){if(U.length)for(g=0,w=U.length;g<w;g++)null==(p=U[g])._id&&(p._id=(null!=(ae=p[e._key])?ae:this.uid()).replace(/\//g,"_").toLowerCase())}else null==U._id&&(U._id=(null!=(re=null!=(se=S.key)?se:U[e._key])?re:this.uid()).replace(/\//g,"_").toLowerCase()),null==S.key&&(S.key=U._id.replace(/\//g,"_").toLowerCase());if((null!=U||!this.refresh||"function"!=typeof e)&&(e._kv&&S.key&&null!=(ce=await this.kv(pe+"/"+S.key,U))&&null==U&&(S.cached="kv"),e._index)){if("all"===this.params.size){if(!0!==this.S.bg){if("string"==typeof this.S.bg)throw new Error;ce={status:404}}if(A=null!=(ne=null!=(le=this.params.email)?le:this.params.notify)?ne:null!=(oe=this.user)?oe.email:void 0,this.params.orgkey&&(R=this.params.orgkey,delete this.params.orgkey),L=null!=(ue=this.params.funders)?ue:this.params.flatten,a=null!=(B=this.params.authorships)?B:this.params.flatten,delete W.orgkey,delete W.funders,delete W.authorships,delete W.flatten,delete W.email,delete this.params.size,delete W.size,(fe=await this.index.count(pe,W))>3e6||!(null!=(J=this.S.static)?J.folder:void 0))ce={status:401};else{y=(this.fn?this.fn.replace(/\./g,"_"):"")+"_"+this.uid(),d=this.S.static.url+"/export/"+y+".csv",fe>1e5&&await this.mail({to:null!=(X=r.log)?X.notify:void 0,subject:(this.S.dev?"Dev":"Live")+" oa.report creating large csv of size "+fe,text:"Someone is creating a large csv of size "+fe+"\n\n"+d}),E=this.S.static.folder+"/export";try{(f=(await fs.readdir(E)).length)>970&&f%20==0&&this.mail({to:null!=($=r.log)?$.logs:void 0,subject:(this.S.dev?"Dev":"Live")+" oa.report export file count "+f+"/1000",text:"Info, export file count is "+f+" they will be deleted at 1000"})}catch(e){await fs.mkdir(E),f=0}try{if(f>999){for(V=await fs.readdir(E),_=0,x=V.length;_<x;_++)m=V[_],await fs.unlink(E+"/"+m);this.mail({to:null!=(G=r.log)?G.logs:void 0,subject:(this.S.dev?"Dev":"Live")+" oa.report export file count limit reached, files deleted",text:"Export files had reached 1000 so have been deleted "})}}catch(e){}if(f>1e3)ce={status:401};else{if(E+="/"+y+".csv",await fs.appendFile(E,""),null!=this.params.includes&&(this.params.include=this.params.includes,delete this.params.includes),null!=this.params.excludes&&(this.params.exclude=this.params.excludes,delete this.params.excludes),null!=this.params.include)v="string"==typeof this.params.include?this.params.include.split(","):this.params.include,R&&("string"!=typeof this.params.include||this.params.include.includes("orgs")?Array.isArray(this.params.include)&&N.call(this.params.include,"orgs")<0&&this.params.include.push("orgs"):this.params.include+=",orgs",N.call(W._source.includes,"orgs")<0&&W._source.includes.push("orgs"));else for(v=[],b=0,O=(Y=await this.index.keys(pe)).length;b<O;b++)he=Y[b].split(".")[0],N.call(v,he)<0&&"_id"!==he&&v.push(he);if(null!=this.params.exclude){for(D=0,k=(H="string"==typeof this.params.exclude?this.params.exclude.split(","):this.params.exclude).length;D<k;D++)h=H[D],-1===(P=v.indexOf(h))||R&&"orgs"===h||(v=v.splice(P,1));R&&-1!==(C=W._source.excludes.indexOf("orgs"))&&(W._source.excludes=W._source.excludes.splice(C,1))}A&&await this.mail({to:A,subject:"Your export has started (ref: "+y+".csv)",text:'Your export has started. You can download the file any time, it will keep growing until it is complete, when you will get another notification.<br><br><a href="'+d+'">Download CSV</a><br><br>Thanks'}),s=async(e,t,i,r,s,a,n,o,u)=>{var c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se;if(x=!0,null!=u&&(me=await this.encrypt(u),V=await this.report.orgs.orgkeys('key.keyword:"'+me+'"',1)),n||o){if(r=["DOI"],n)for(G=0,M=(Y=["funder.name","funder.award"]).length;G<M;G++)b=Y[G],r.push(b);if(o)for(ye=0,W=(H=["authorships.institutions.display_name","authorships.institutions.ror","authorships.author.orcid","authorships.author.raw_affiliation_string"]).length;ye<W;ye++)b=H[ye],r.push(b)}for(ve=0,U=r.length;ve<U;ve++)D=r[ve],await fs.appendFile(i,(x?'"':',"')+D.replace("supplements.","")+'"'),x=!1;for(_e=1e5,be=0,z=(Z=["@oa.works","pcastromartin@","wbschmal@","mailparser.io"]).length;be<z;be++)c=Z[be],s&&s.includes(c)&&(_e=3e6);for await(g of this.index._for(e,t,{scroll:"30m",max:_e}))if(await fs.appendFile(i,"\n"),n||o){if(J="",h="",S="",he="",$="",p="",null!=g.funder&&n)for(x=!0,Oe=0,F=(Q=g.funder).length;Oe<F;Oe++)J+=(x?"":";")+(null!=(K=(O=Q[Oe]).name)?K:"").replace(/"/g,""),null!=O.award&&O.award.length&&(O.award=O.award.join(" ")),null==O.award&&(O.award=""),Array.isArray(O.award)&&(O.award.length?O.award=O.award.join(" "):O.award=""),O.award=O.award.replace(/;/g,""),h+=(x?"":";")+O.award,x=!1;if(null!=g.authorships&&o)for(x=!0,ke=0,B=(ee=g.authorships).length;ke<B;ke++){if(x||(S+=";",he+=";"),x=!1,null!=(d=ee[ke]).institutions)for(w=!0,je=0,E=(te=d.institutions).length;je<E;je++)S+=(w?"":",")+(null!=(ie=(j=te[je]).display_name)?ie:"").replace(/"/g,""),he+=(w?"":",")+(null!=(re=j.ror)?re:""),w=!1;(null!=(se=d.author)?se.orcid:void 0)&&($+=($?",":"")+d.author.orcid),d.raw_affiliation_string&&(p+=(p?",":"")+d.raw_affiliation_string.replace(/"/g,""))}await fs.appendFile(i,'"'+g.DOI+(n?'","'+J+'","'+h:"")+(o?'","'+S+'","'+he+'","'+$+'","'+p:"")+'"')}else for(x=!0,Se=0,L=r.length;Se<L;Se++){if((l=r[Se]).includes("."))try{f=await this.flatten(g)}catch(e){f=void 0}else f=g;if(Array.isArray(f)){if(f.length&&"object"==typeof f[0]){for(ge=[],k=0,P=f.length;k<P;k++)null!=(null!=(y=f[k])?y[l]:void 0)&&ge.push(y[l]);f=ge}(X={})[l]=f,f=X}if(null==f||null==f[l])we="";else if("object"==typeof f[l]){if(Array.isArray(f[l])){for(m="",I=0,R=(ae=f[l]).length;I<R;I++)"object"==typeof(_=ae[I])&&("sheets"===l&&_.url&&("string"==typeof(null!=V?V.org:void 0)&&V.org.length&&V.org===g.name.toLowerCase()||"string"==typeof(null!=(ne=this.user)?ne.email:void 0)&&this.user.email.endsWith("@oa.works"))&&(_.url=await this.decrypt(_.url)),_=JSON.stringify(_)),m.includes(_)||(m+=(m?";":"")+_);f[l]=m}we=JSON.stringify(f[l])}else we=f[l];if("string"==typeof we&&(we=we.replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")),"sheets.url"===l&&("string"==typeof(null!=V?V.org:void 0)&&V.org.length&&V.org===g.name.toLowerCase()||"string"==typeof(null!=(le=this.user)?le.email:void 0)&&this.user.email.endsWith("@oa.works"))){for(v=[],A=0,q=(oe=Array.isArray(we)?we:we.split(",")).length;A<q;A++)xe=oe[A],v.push(await this.decrypt(xe));we=JSON.stringify(v)}else if(("email"===l||"supplements.email"===l)&&!we.includes("@")&&"string"==typeof(null!=V?V.org:void 0)&&V.org.length){for(de=[],C=0,T=(ce=null!=(ue=g.orgs)?ue:[]).length;C<T;C++)fe=ce[C],de.push(fe.toLowerCase());pe=V.org.toLowerCase(),N.call(de,pe)>=0&&(we=await this.decrypt(we))}await fs.appendFile(i,(x?'"':',"')+we+'"'),x=!1}if(s)return await this.mail({to:s,subject:"Your export is complete (ref: "+i.split("/").pop()+")",text:'Your export is complete. We recommend you download and store files elsewhere as soon as possible as we may delete this file at any time.<br><br><a href="'+a+'">Download CSV</a><br><br>Thanks'})},this.waitUntil(s(pe,W,E,v,A,d,L,a,R)),delete this.format,ce=d}}}else ce=await this.index(pe+(S.key?"/"+S.key:""),null!=U?U:W);if(null!=ce||S.key&&null!=U||(await this.index(pe,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(Z=e._index.mappings)?Z:e._index.mapping,aliases:e._index.aliases}),""!==U&&(ce=await this.index(pe+(S.key?"/"+S.key:""),null!=U?U:S.key?void 0:W))),null==ce&&null==U&&S.key&&"string"==typeof arguments[0]&&(W=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(M=await this.index(pe,W))&&null!=(Q=M.hits)?Q.total:void 0))for(T=0,j=(ee=await this.keys(M.hits.hits[0]._source)).length;T<j;T++)if(l=ee[T],"string"==typeof M.hits.hits[0]._source[l]&&arguments[0]===M.hits.hits[0]._source[l]||Array.isArray(M.hits.hits[0]._source[l])&&(te=arguments[0],N.call(M.hits.hits[0]._source[l],te)>=0)){null==(ce=M.hits.hits[0]._source)._id&&(ce._id=M.hits.hits[0]._id);break}1===(null!=W?W.size:void 0)&&"object"==typeof ce&&null!=(null!=(ie=ce.hits)?ie.hits:void 0)&&(ce.hits.hits.length?(null==(u=ce.hits.hits[0]._source)._id&&(u._id=ce.hits.hits[0]._id),ce=ce.hits.hits[0]._source):ce=void 0)}null!=W&&(S.qry=JSON.stringify(W)),null==ce||null!=U||S.cached||(S.cached="index"),S.cached&&this.fn===t&&(this.cached=S.cached)}return null==ce&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(c={headers:{},body:U,params:this.copy(this.params)},this.refresh&&(c.params.refresh=!0),c.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,ce=await this.fetch(this.S.bg+"/"+pe.replace(/\_/g,"/"),c),S.bg=!0),null==ce&&e._sheet&&""!==U&&(this.refresh&&this.fn===t||!await this.index(pe))&&(ce=await this._loadsheet(e,pe),(arguments.length||"{}"!==JSON.stringify(this.params))&&(ce=void 0)),null!=ce||e._index&&""===U||"function"!=typeof e||(i=async(e,t,i,r,s)=>{var a,l,o,u,c,d,h,f;if(t._limit&&(a=!0===t._limit?86400:t._limit,await this.kv("limit/"+s,de+a,a)),u=await t.apply(this,i),delete n[s],"object"==typeof u&&(t._kv||t._index)&&null==u.took&&null==u.hits){if(t._key&&Array.isArray(u)&&u.length&&null==u[0]._id&&null!=u[0][t._key])for(h=0,o=u.length;h<o;h++)null==(p=u[h])._id&&(p._id=p[t._key].replace(/\//g,"_").toLowerCase());l=Array.isArray(u)?"":"/"+(null!=(c=null!=(d=u[t._key])?d:u._id)?c:this.uid()).replace(/\//g,"_").toLowerCase(),t._kv&&!Array.isArray(u)&&this.kv(e+l,ce,t._kv),t._index&&this.waitUntil(this.index(e+l,u))}return!0===t._limit&&await this.kv("limit/"+s,""),t._async&&"loop"!==t._schedule&&(this.kv("async/"+this.rid,null==l||Array.isArray(u)?Array.isArray(u)?u.length:u:e+l,172800),this.fn===s&&!1!==t._notify&&(f=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(u)+"\n\n"+this.base+"/"+e+"?_async="+this.rid,r&&this.mail({to:r,text:f}))),u},e._async&&this.fn===t?(S.async=!0,e._unique&&(q=n[t])?ce={_async:q}:(e._unique&&(n[this.fn]=this.rid),ce={_async:this.rid},this.waitUntil(i(pe,e,arguments,this.params.notify,t)))):ce=await i(pe,e,arguments)),ce}},t.svc={},t.src={},t.status=async function(){var e,t,s,n,o,u,c,p,d;p={name:r.name,version:r.version,built:r.built};try{p.pmid=D.env.pm_id}catch(e){}try{p.pmname=D.env.name}catch(e){}for(e=0,s=(o=["rid","params","base","parts","opts","routes"]).length;e<s;e++){l=o[e];try{null==p[l]&&(p[l]=this[l])}catch(e){}}if(!0===this.S.bg)try{for(d in p.schedule={},a)for(l in p.schedule[d]={},a[d])"fn"!==l&&(p.schedule[d][l]=a[d][l])}catch(e){}!0===this.S.bg&&(p.bg=!0),p.kv=("string"==typeof this.S.kv&&i.g[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{p.index=await this.index.status()}catch(e){}if(r.dev){if(p.bg=this.S.bg,!0!==this.S.bg)try{p.request=this.request}catch(e){}for(t=0,n=(u=["headers","cookie","user","body"]).length;t<n;t++){l=u[t];try{null==p[l]&&(p[l]=this[l])}catch(e){}}}else{try{p.index=p.index.status}catch(e){}p.kv&&(p.kv=!0),p.user=null!=(c=this.user)?c.email:void 0}return p},N=[].indexOf,t.auth=async function(e){var t,i,s,a,n,l,o,u,c,p,d,h,f;if("string"==typeof e)return this.users._get(e);if(e||null==this.user||"auth"!==this.fn&&!1!==e){if(!1!==e&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(a=this.params.token)?a:this.params.auth),"")))&&((f=await this.users._get(null!=(n=null!=s?s.email:void 0)?n:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(h=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(h))),!f&&(this.params.resume||this.cookie))){if(!(p=this.params.resume))try{p=(t=JSON.parse(decodeURIComponent(this.cookie).split((null!=(l=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?l:"oaworksLogin")+"=")[1].split(";")[0])).resume,h=t._id}catch(e){}null==h&&(h=this.headers["x-id"]),this.params.email&&!h&&(h=this.hashhex(this.params.email.trim().toLowerCase())),p&&h&&await this.kv("auth/resume/"+h+"/"+p)&&null!=(f=await this.users._get(h))&&(f.resume=p)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),e||"html"!==this.format?f:(d="<body>",d+='<script type="text/javascript" src="/client/oaworksLogin.min.js?v='+this.S.version+'"><\/script>\n',d+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(d+='<input autofocus id="OALoginEmail" class="OALoginEmail" type="text" name="email" placeholder="email">',d+='<input id="OALoginToken" class="OALoginToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',d+='<p class="OALoginWelcome" style="display:none;">Welcome back</p>',d+='<p class="OALoginLogout" style="display:none;"><a id="OALoginLogout" href="#">logout</a></p>'):d+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',d+"</body>")},t.auth.token=function(e,t,i,s,a,n,l){var o,u,c;if(null==e&&(e=this.params.email),e)return e=e.trim().toLowerCase(),null==t&&(t=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&C.log(e,c),null==l&&(l=this.params.url),l?(l+="#"+c,null==i&&(i="Complete your login to "+(l.includes("//")?l.split("//")[1]:l).split("/")[0])):(l=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,e,1200),this.waitUntil(this.mail({from:t,to:e,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+l+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=a?a:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+l+'">'+l+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:l}})),{email:e}},t.auth.role=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m;if(null==e&&(e=this.params.role),t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,"system"===e&&this.system)return"system";if((null!=t?t.email:void 0)&&(u=t.email,N.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],u)>=0))return"root";if(e.startsWith("@")&&null!=(null!=t?t.email:void 0)&&t.email.endsWith(e))return e;if(null!=(null!=t?t.roles:void 0))for(a=0,l=(c="string"==typeof e?e.split(","):e||[]).length;a<l;a++){if(r=c[a],[s,m]=r.replace("/",".").split("."),s===t._id)return"owner";if(m){if(N.call(null!=(p=t.roles[s])?p:[],m)>=0)return m;if(null!=t.roles[s]&&-1<(h=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(m)))for(n=0,o=(d=i.splice(0,h)).length;n<o;n++)if(f=d[n],N.call(t.roles[s],f)>=0)return f}}return!1},t.auth.add=async function(e,t,i,r){var s,a,n,l,o,u,c;return t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,!(!e&&this.user._id!==t._id&&!await this.auth.role("system"))&&(null==e&&(e=null!=(n=null!=(l=this.params.add)?l:this.params.remove)?n:this.params.deny),!!e&&([a,c]=e.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==a&&"root"!==c&&(r?(t.roles[a]=["deny"],this.users._update(t)):c?(null!=(o=t.roles)?o[a]:void 0)&&N.call(t.roles[a],c)>=0?null!=i&&(t.roles[a].splice(t.roles[a].indexOf(c),1),t.roles[a].length||delete t.roles[a],this.users._update(t)):("request"!==c||N.call(null!=(u=t.roles[a])?u:[],"deny")<0)&&(null==(s=t.roles)[a]&&(s[a]=[]),N.call(t.roles[a],"request")>=0&&(t.roles[a]=t.roles[a].splice(t.roles[a].indexOf("request"),1)),t.roles.group.push(c),this.users._update(t)):null!=t.roles[a]?null!=i&&(delete t.roles[a],this.users._update(t)):(t.roles[a]=["user"],this.users._update(t)),t)))},t.auth.remove=function(e,t){return this.auth.add(e,t,!0)},t.auth.deny=function(e,t){return this.auth.add(e,t,void 0,!0)},t.auth.request=function(e,t){return null==e&&(e=this.params.request),e=e.split("/")[0]+"/request",this.auth.add(e,t)},t.auth.logout=async function(e){return null==e&&(e=this.user),!!e&&(await this.kv._each("auth/resume/"+("string"==typeof e?e.includes("@")?this.hashhex(e.trim().toLowerCase()):e:e._id),""),!0)},t.auth._oauth=async function(e,t){var i,s,a,n,l,o,u,c,p,d,h,f,m,y;if(e)try{if(y=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(s=this.S.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(p=r.use)&&null!=(d=p.google)&&null!=(h=d.oauth)&&null!=(f=h.client)?f.id:void 0),null!=t&&(null!=(a=y.data)?a.aud:void 0)===t)return{email:(m=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e)).data.email.toLowerCase(),google:{id:m.data.id},name:null!=(n=m.data.name)?n:m.data.given_name+(m.data.family_name?" "+m.data.family_name:""),avatar:m.data.picture}}catch(e){}},t.users={_index:!0,_auth:"system"},t.users._get=async function(e,t){var i,r,s;if(t)1===(null!=(r=await this.index("users",'apikey:"'+t+'"'))&&null!=(i=r.hits)?i.total:void 0)&&null==(s=r.hits.hits[0]._source)._id&&(s._id=r.hits.hits[0]._id);else if("string"==typeof e){if(e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),!0!==this.S.bg)try{s=await this.kv("users/"+e)}catch(e){}if(null==s){try{s=await this.index("users/"+e)}catch(e){}if(null!=s&&!0!==this.S.bg){try{await this.kv("users/"+e,s)}catch(e){}try{await this.kv("auth/apikey/"+s.apikey,e)}catch(e){}}}}return s},t.users._create=async function(e){var t;if("string"==typeof e&&(e={email:e}),"string"!=typeof e.email||!e.email.includes("@"))return!1;t={_id:this.hashhex(e.email.trim().toLowerCase()),email:e.email,apikey:this.uid()},delete e.email;try{t.profile=e}catch(e){}try{t.creation=this.base+"/"+this.route}catch(e){}t.roles={},t.createdAt=new Date;try{await this.kv("users/"+t._id,t)}catch(e){}try{await this.kv("auth/apikey/"+t.apikey,t._id)}catch(e){}try{this.waitUntil(this.index("users/"+t._id,t))}catch(e){}return t},t.users._update=async function(e,t){if("object"==typeof e&&t._id&&null==t&&(e=(t=e)._id),"string"==typeof e&&"object"==typeof t&&"{}"!==JSON.stringify(t)){e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),t.updatedAt=new Date;try{await this.kv("users/"+e,t)}catch(e){}try{this.waitUntil(this.index("users/"+e,t))}catch(e){}return!0}return!1},t.users._delete=async function(e){var t,i;if(i="object"==typeof e?e:(null!=(t=this.user)?t._id:void 0)===e?this.user:await this.users._get(e)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(e){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(e){}try{await this.kv("users/"+i._id,"")}catch(e){}try{return await this.index("users/"+i._id,"")}catch(e){}}},t.deal={_index:!0,_prefix:!1},t.deal.institution={_index:!0,_prefix:!1},t.deal.load=async function(){var e,t,i,r,s,a,n,l,o,u,c,p,d;for(t={},r=0,a=(c=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;r<a;r++){for(u=c[r],s=0,n=(p=["Institution","Publisher","Collection","Year(s)","Length of Agreement","Package Price","2015 Carnegie Basic Classification","FTE","Source","URL","Share URL Publicly?","Notes"]).length;s<n;s++)u[(d=p[s]).toLowerCase().replace(/ /g,"").replace("?","").replace("(","").replace(")","")]=u[d],delete u[d];try{if(u.value=parseInt(u.packageprice.replace(/[^0-9]/g,"")),"string"==typeof u.fte)try{u.fte=parseInt(u.fte)}catch(e){delete u.fte}"string"==typeof u.notes&&u.notes.toLowerCase().includes("canadian")?(u.gbpvalue=Math.floor(.57*u.value),u.usdvalue=Math.floor(.75*u.value)):u.packageprice.includes("$")?(u.gbpvalue=Math.floor(.77*u.value),u.usdvalue=Math.floor(u.value)):(u.gbpvalue=Math.floor(u.value),u.usdvalue=Math.floor(1.3*u.value))}catch(e){}null==u.usdvalue&&(u.usdvalue="");try{"2103"===u.years&&(u.years="2013")}catch(e){}try{"yes"!==u.shareurlpublicly.toLowerCase()&&delete u.url}catch(e){}try{delete u.shareurlpublicly}catch(e){}try{""===u.collection&&(u.collection="Unclassified")}catch(e){}try{u.carnegiebasicclassification=u["2015carnegiebasicclassification"],delete u["2015carnegiebasicclassification"]}catch(e){}try{null==t[l=u.institution]&&(t[l]={institution:u.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),o=JSON.parse(JSON.stringify(u));try{delete o.institution}catch(e){}try{t[u.institution].value+=u.value,t[u.institution].gbpvalue+=u.gbpvalue,t[u.institution].usdvalue+=u.usdvalue}catch(e){}t[u.institution].deals.push(o)}catch(e){}}for(e in i=[],t)i.push(t[e]);return await this.deal(""),await this.deal.institution(""),await this.deal(c),await this.deal.institution(i),{retrieved:c.length,institutions:i.length}},N=[].indexOf,t.deposits={_index:!0,_auth:"@oa.works"},t.deposit=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae;for(null==e&&(e=this.copy(this.params)),(null!=(A=e.metadata)?A.doi:void 0)&&!e.doi&&(e.doi=e.metadata.doi),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),null==i&&(i=this.S.dev),(p={createdAt:Date.now()}).created_date=await this.datetime(p.createdAt),h=0,g=(D=["embedded","demo","pilot","live","email","plugin"]).length;h<g;h++)p[y=D[h]]=e[y];if(!0===p.pilot&&(p.pilot=Date.now()),!0===p.live&&(p.live=Date.now()),p.name=null!=(z=null!=t?t.filename:void 0)?z:null!=t?t.name:void 0,"anonymous"!==e.from&&(p.from=e.from),e.confirmed&&(p.confirmed=decodeURIComponent(e.confirmed)),p.doi=null!=(Q=e.doi)?Q:null!=(ue=e.metadata)?ue.doi:void 0,null==e.metadata&&e.doi&&(e.metadata=await this.metadata(e.doi)),p.metadata=e.metadata,je=e.config,"string"==typeof e.config&&(je=JSON.parse(e.config)),!e.config&&e.from&&(je=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from),(null!=(ge=this.S.log)?ge.logs:void 0)&&"mark+instantilldemo@cottagelabs.com"===je.owner&&(je.owner=this.S.log.logs),(null!=(_e=this.S.log)?_e.logs:void 0)&&"mark+instantilldemo@cottagelabs.com"===je.email&&(je.email=this.S.log.logs)),p.permissions=null!=(ve=e.permissions)?ve:await this.permissions(null!=(be=e.metadata)?be:e.doi),e.redeposit||(null==t&&e.email&&null!=e.metadata?p.type="dark":(p.archivable=await this.archivable(t,void 0,p.confirmed,e.metadata,p.permissions,i),null!=(null!=(we=p.archivable)?we.metadata:void 0)&&delete p.archivable.metadata)),(null!=(C=p.archivable)?C.archivable:void 0)&&(!p.confirmed||p.confirmed===p.archivable.checksum)){for((Ie={content:t.data,name:p.archivable.name}).publish=!0,c=[],m=0,_=(P=null!=(E=null!=(L=e.metadata)?L.author:void 0)?E:[]).length;m<_;m++)if(null!=(r=P[m]).family){a={name:r.family+(r.given?", "+r.given:"")};try{r.ORCID&&(a.orcid=r.ORCID.split("/").pop())}catch(e){}try{"object"==typeof r.affiliation&&null!=r.affiliation.name&&(a.affiliation=r.affiliation.name)}catch(e){}c.push(a)}0===c.length&&(c=[{name:"Unknown"}]),d=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(d=(d+=null!=(R=null!=(q=p.permissions.best_permission)?q.deposit_statement:void 0)?R:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+e.metadata.doi:"").trim()).lastIndexOf(".")!==d.length-1&&(d+="."),d.length&&(d+=" "),d+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",x={title:null!=(T=e.metadata.title)?T:"Unknown",description:d.trim(),creators:c,version:"submittedVersion"===p.archivable.version?"Submitted Version":"acceptedVersion"===p.archivable.version?"Accepted Version":"publishedVersion"===p.archivable.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},e.doi&&((null!=(Ae=await this.src.zenodo.records.search('"'+e.doi+'"',i))&&null!=(M=Ae.hits)?M.total:void 0)&&(f=Ae.hits.hits[0]),f&&p.confirmed!==p.archivable.checksum&&!i?p.zenodo={already:f.id}:x.related_identifiers=[{relation:"postprint"===x.version||"AAM"===x.version||"preprint"===x.version?"isPreviousVersionOf":"isIdenticalTo",identifier:e.doi}]),x.prereserve_doi=!0,x.access_right="open",x.license=null!=(W=null!=(U=p.permissions.best_permission)?U.licence:void 0)?W:"cc-by",x.license.includes("other")&&x.license.includes("closed")&&(x.license="other-closed"),x.license.includes("other")&&x.license.includes("non")&&x.license.includes("commercial")&&(x.license="other-nc"),x.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(x.license.substring(x.license.length-1)))&&(x.license+="-4.0");try{(null!=(F=p.permissions.best_permission)?F.embargo_end:void 0)&&await this.epoch(p.permissions.best_permission.embargo_end)>Date.now()&&(x.access_right="embargoed",x.embargo_date=p.permissions.best_permission.embargo_end,p.embargo=p.permissions.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(x.publication_date=e.metadata.published)}catch(e){}if(null!=je){if(p.config=je,null!=je.community_ID&&null==je.community&&(je.community=je.community_ID),je.community)for(null==je.communities&&(je.communities=[]),k=0,v=(B="string"==typeof je.community?je.community.split(","):je.community).length;k<v;k++)o=B[k],je.communities.push({identifier:o});if(null!=je.community||null!=je.communities)for(null==je.communities&&(je.communities=je.community),Array.isArray(je.communities)||(je.communities=[je.communities]),x.communities=[],j=0,b=(J=je.communities).length;j<b;j++)u=J[j],x.communities.push("string"==typeof u?{identifier:u}:u);x.communities&&x.communities.length&&(p.community=x.communities[0].identifier)}if(xe=i||p.demo?null!=(X=this.S.src.zenodo)?X.sandbox:void 0:null!=($=this.S.src.zenodo)?$.token:void 0){if(!(null!=(V=p.zenodo)?V.already:void 0))if((Se=await this.src.zenodo.deposition.create(x,Ie,xe,i)).id)p.zenodo={id:Se.id,url:"https://"+(i||p.demo?"sandbox.":"")+"zenodo.org/record/"+Se.id,doi:null!=(null!=(G=Se.metadata)&&null!=(Y=G.prereserve_doi)?Y.doi:void 0)?Se.metadata.prereserve_doi.doi:void 0,file:null!=(H=null!=(Z=Se.uploaded)&&null!=(K=Z.links)?K.download:void 0)?H:null!=(ee=Se.uploaded)&&null!=(te=ee.links)?te.download:void 0},null==p.doi&&(p.doi=p.zenodo.doi),p.type="zenodo";else{p.error="Deposit to Zenodo failed";try{p.error+=": "+JSON.stringify(Se)}catch(e){}p.type="review"}}else p.error="No Zenodo credentials available",p.type="review"}if((null!=(ie=p.archivable)?ie.timeout:void 0)&&(p.error="Archivable timeout",p.type="review"),p.version=null!=(re=p.archivable)?re.version:void 0,p.type||!e.from||p.embedded&&(p.embedded.includes("oa.works")||p.embedded.includes("openaccessbutton.org")||p.embedded.includes("shareyourpaper.org"))||(p.type=e.redeposit?"redeposit":t?"forward":"dark"),p.doi&&(null==p.type&&(p.type="review"),p.url="string"==typeof e.redeposit?e.redeposit:e.url?e.url:void 0,await this.deposits(p),("review"!==p.type||null!=t)&&!1!==(null!=(se=p.archivable)?se.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(ae=exists.zenodo)?ae.already:void 0)||i))){for(l=[null!=(ne=this.S.log)?ne.logs:void 0,"shared@oa.works"],ke=[],"string"==typeof(null!=je?je.owner:void 0)&&je.owner.includes("@")&&!p.error?ke.push(je.owner):(null!=je?je.email:void 0)&&ke.push(je.email),0===ke.length&&(ke=await this.copy(l),l=[]),s=[],S=0,w=(ce=null!=(le=null!=(oe=p.metadata)?oe.author:void 0)?le:[]).length;S<w;S++)(n=ce[S]).family&&s.push((n.given?n.given+" ":"")+n.family);p.metadata.author=s,p.adminlink=p.embedded?p.embedded:"https://shareyourpaper.org"+(p.metadata.doi?"/"+p.metadata.doi:""),p.adminlink+=p.adminlink.includes("?")?"&":"?",null!=(null!=(pe=p.archivable)?pe.checksum:void 0)&&(p.confirmed=encodeURIComponent(p.archivable.checksum),p.adminlink+="confirmed="+p.confirmed+"&"),de=p.email,N.call(p.adminlink,de)<0&&(p.adminlink+="email="+p.email),Oe=await this.templates(p.type+"_deposit"),I=await this.template(Oe.content,p),delete p.adminlink,delete p.confirmed,O={from:"deposits@oa.works",to:ke,subject:null!=(he=I.subject)?he:p.type+" deposit",html:I.content},l&&l.length&&(O.bcc=l),t&&(O.attachment={file:t.data,filename:null!=(fe=null!=(me=null!=(ye=p.archivable)?ye.name:void 0)?me:t.name)?fe:t.filename}),await this.mail(O)}if(p.embargo)try{p.embargo_UI=new Date(p.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(e){}return p},t.deposit._bg=!0,t.archivable=async function(e,t,i,r,s,a){var n,l,o;for(null==a&&(a=this.S.dev),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),l={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},n=async()=>{var n,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,N,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z;if(("string"==typeof r||null==r&&(this.params.doi||this.params.title))&&(r=await this.metadata(null!=(E=null!=r?r:this.params.doi)?E:this.params.title)),null==r&&(r={}),"string"==typeof e&&(e={data:e}),null==e&&null!=t&&(e=await this.fetch(t)),null!=e){null==e.name&&(e.name=e.filename);try{l.name=e.name}catch(e){}try{l.format=null!=e.name&&e.name.includes(".")?e.name.split(".").pop():"html"}catch(e){}if(l.format=l.format.toLowerCase(),e.data){if(null==d&&null!=l.format&&null!=this.convert[l.format+"2txt"])try{d=await this.convert[l.format+"2txt"](e.data)}catch(e){}try{null==d&&(d=e.data)}catch(e){}try{d=d.toString()}catch(e){}}}if(null!=d||i){S=((j=(h=d.length<2e4?d:d.substring(0,6e3)+d.substring(d.length-6e3,d.length)).toLowerCase()).length<6e3?j:j.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==l.name&&(l.name=r.title);try{l.checksum=crypto.createHash("md5").update(d,"utf8").digest("base64")}catch(e){}l.same_paper_evidence={};try{l.same_paper_evidence.words_count=d.split(" ").length}catch(e){}try{l.same_paper_evidence.words_more_than_threshold=l.same_paper_evidence.words_count>500}catch(e){}try{l.same_paper_evidence.doi_match=!(!r.doi||!S.includes(r.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}try{l.same_paper_evidence.title_match=!(!r.title||!S.includes(r.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}if(null!=r.author)try{for(c=0,l.same_paper_evidence.author_match=!1,"string"==typeof r.author&&(r.author={name:r.author}),Array.isArray(r.author)||(r.author=[r.author]),U=r.author,g=0,x=U.length;g<x&&(n=U[g],!0!==l.same_paper_evidence.author_match);g++)try{if(u=(null!=(z=null!=(F=null!=(B=null!=(J=n.last)?J:n.lastname)?B:n.family)?F:n.surname)?z:n.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),o=(null!=(X=null!=($=null!=(V=n.first)?V:n.firstname)?$:n.given)?X:n.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),_=S.indexOf(u),u.length>2&&o.length>0&&-1!==_&&S.substring(_-20,_+u.length+20).includes(o)&&(c+=1,r.author.length<3&&1===c||r.author.length>2&&c>1)){l.same_paper_evidence.author_match=!0;break}}catch(e){}}catch(e){}if(null!=l.format)for(b=0,O=(L=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;b<O;b++)if(m=L[b],l.format.includes(m)){l.same_paper_evidence.document_format=!0;break}l.same_paper=!!(l.same_paper_evidence.words_more_than_threshold&&(l.same_paper_evidence.doi_match||l.same_paper_evidence.title_match||l.same_paper_evidence.author_match)&&l.same_paper_evidence.document_format),l.same_paper_evidence.words_count<150&&"pdf"===l.format&&(l.same_paper_evidence.words_count=0,l.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),l.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(P=await this.src.google.sheets(a?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),D=0,k=P.length;D<k;D++){w=P[D],l.version_evidence.strings_checked+=1,Z=w["what to search"],G=w["where to search"],y=w["how to search"],v=w["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&(H=Z.split("<<")[1].split(">>")[0],null!=r[H.toLowerCase()]&&(Z=Z.replace("<<"+H+">>",r[H.toLowerCase()]))),A=!1,"string"===y?A=!!("file"===G&&h.includes(Z)||"file"!==G&&(null!=r.title&&r.title.includes(Z)||null!=l.name&&l.name.includes(Z))):(C=new RegExp(Z,"gium"),A="file"===G&&null!==j.match(C)||"file"!==G&&(null!=r.title&&null!==r.title.match(C)||null!=l.name&&null!==l.name.match(C))),A){if("string"==typeof(Y=w.value))try{Y=parseInt(Y)}catch(e){}"number"!=typeof Y&&(Y=1),!v||"publisher pdf"!==(R=v.toLowerCase())&&"publishedversion"!==R?l.version_evidence.score-=Y:l.version_evidence.score+=Y,l.version_evidence.strings_matched.push({indicates:v,found:y+" "+Z,in:G,score_value:Y})}}catch(e){f=e,null==(p=l.version_evidence).strings_errored&&(p.strings_errored=[]),l.version_evidence.strings_errored.push({tried:y+" "+Z,in:G,error:f.toString()})}}}catch(e){}l.version_evidence.score>0&&(l.version="publishedVersion"),l.version_evidence.score<0&&(l.version="acceptedVersion"),"unknown"===l.version&&l.version_evidence.strings_checked>0&&(l.version="acceptedVersion");try{null!=(null!=(I=await this.licence(void 0,j))?I.licence:void 0)&&(l.licence=I.licence,l.licence_evidence=I)}catch(e){}l.archivable=!1,i?(l.archivable=!0,i===l.checksum?(l.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",l.admin_confirms=!0):(l.archivable_reason="The depositor says that this file is a version that can be archived",l.depositor_says=!0)):l.same_paper?("pdf"!==l.format&&(l.archivable=!0,l.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!l.archivable&&null!=l.licence&&l.licence.toLowerCase().startsWith("cc")&&(l.archivable=!0,l.archivable_reason="It appears this file contains a "+l.licence+" licence statement. Under this licence the article can be archived"),l.archivable||(l.version?(null!=r&&"{}"!==JSON.stringify(r)&&null==s&&(s=await this.permissions(r)),l.version===(null!=s&&null!=(q=s.best_permission)?q.version:void 0)?(l.archivable=!0,l.archivable_reason="We believe this is a "+l.version.split("V")[0]+" version and our permission system says that version can be shared"):null==l.archivable_reason&&(l.archivable_reason="We believe this file is a "+l.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):l.archivable_reason="We cannot confirm if it is an archivable version or not")):null==l.archivable_reason&&(l.archivable_reason=l.same_paper_evidence.words_more_than_threshold?l.same_paper_evidence.document_format?r.doi||r.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+l.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==e&&null==t||(l.error=null!=(N=e.error)?N:"Could not extract any content");return l.archivable&&null==l.licence&&((null!=s&&null!=(T=s.best_permission)?T.licence:void 0)?l.licence=s.best_permission.licence:(null!=(M=null!=s&&null!=(W=s.best_permission)?W.deposit_statement:void 0)?M:"").toLowerCase().startsWith("cc")&&(l.licence=s.best_permission.deposit_statement)),l.metadata=r},n(),setTimeout((()=>l.timeout=!0),null!=(o=this.params.timeout)?o:6e4);null==l.archivable&&!l.timeout;)await this.sleep(500);return l},t.archivable._bg=!0,t.deposited=async function(){var e,t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_;for await(r of(c="type:* AND NOT error:*",(_=this.params.uid)&&(c+=" AND from.keyword:"+_),this.params.submitted&&(c+=" AND zenodo.url:*"),this.params.fromdate&&(c+=" AND createdAt:>="+this.params.fromdate),g=[],await this.deposits._for(c,{sort:"createdAt:asc"})))if((!_||r.from===_)&&(!this.params.submitted||(null!=(d=r.zenodo)?d.file:void 0))){if(p={type:r.type,createdAt:r.createdAt},r.metadata)for(a=0,l=(h=["doi","title","author","journal","issn","publisher","published"]).length;a<l;a++)p[u=h[a]]=r.metadata[u];for(p.permission=r.best_permission,i=!1,n=0,o=g.length;n<o;n++)if((t=g[n]).doi&&p.doi&&t.doi===p.doi&&t.file&&p.file&&t.file===p.file){i=!0;break}if(!i){if(p.url=null!=(f=r.zenodo)?f.url:void 0,p.file=null!=(m=r.zenodo)?m.file:void 0,"csv"===this.format){for(e in null!=(y=p.author)?y:[])p.author[e]=p.author[e].name?p.author[e].name:p.author[e].given&&p.author[e].family?p.author[e].given+" "+p.author[e].family:"";for(s in p)null!=p[s]&&"object"==typeof p[s]&&(p[s]=await this.flatten(p[s]))}g.push(p)}}return g},N=[].indexOf,t.metadata=async function(e){var t;return null!=(t=await this.find(e))?t.metadata:void 0},t.metadata._log=!1,t.find=async function(e,t={},i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;S={},s=async e=>{var i,r,s;for(r in s=[],i=await this.citation(e))"url"===r||"paywall"===r?s.push(null!=S[r]?S[r]:S[r]=i[r]):s.push(null!=t[r]?t[r]:t[r]=i[r]);return s},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}if(null==e&&(e={}),null==i&&(i=null!=(f=e.dom)?f:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(e.find.startsWith("10.")&&e.find.includes("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(l="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&l.split("/")[0].length>6&&l.length>8&&((o=l.split("/")).length>2&&(l=o.join("/")),null==t.doi&&(t.doi=l)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(_=e.url.replace("...","").match(/\./gi))?_:[]).length>3||(null!=(v=e.url.match(/\(/gi))?v:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(b=e.title.replace("...","").match(/\./gi))?b:[]).length>3||(null!=(w=e.title.match(/\(/gi))?w:[]).length>2)){e.citation=e.title;try{e.title.includes("10.")&&e.title.includes("/")&&(e.doi="10."+e.title.split("10.")[1].split(" ")[0].trim())}catch(e){}(e.doi.length<8||!e.doi.includes("/"))&&delete e.doi,delete e.title}e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(x=e.pmcid)?x:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}"string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(S.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(O=e.from)||"eZwJ83xp3oZDaec86"===O)&&null==S.demo&&(S.demo=!0),S.demo&&null==S.test&&(S.test=!0),u=!1,null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await s(await this.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(k=t.pmcid)?k:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(d=await this.src.openalex.works.title(t.title))?d.type:void 0)&&(null!=d?d.doi:void 0)&&await s(d),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(d=await this.src.openalex.works.doi(t.doi))&&await s(d),t.doi&&!(null!=d?d.type_crossref:void 0)&&(S.doi_not_in_openalex=!0),t.doi&&(n=await this.src.crossref.works.doi(t.doi))&&n.publisher&&(t.publisher=n.publisher),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==S.ill&&(S.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},a=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==S.permissions&&(S.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),a()]);try{if(t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&!(null!=(j=S.permissions)?j.all_permissions:void 0)&&t.publisher_lineage.length>1)for(h=0;h<t.publisher_lineage.length&&(t.publisher_lineage[h]===t.publisher||(t.publisher=t.publisher_lineage[h],S.permissions=await this.permissions(t,null!=(y=e.config)?y.ror:void 0,!1),!S.permissions.all_permissions));)h++}catch(e){}for(c=0,p=(g=["title","journal","year","doi"]).length;c<p;c++)e[I=g[c]]&&e[I]!==t[I]&&(t[I]=e[I]);return S.metadata=t,S},t.citation=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe,Te,Me,We,Ue,ze,Fe,Be,Je,Xe,$e,Ve,Ge,Ye,He,Ze,Qe,Ke,et,tt,it,rt,st,at,nt,lt,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Et,Nt,Lt,Pt,Rt,qt,Tt,Mt,Wt;try{null==e&&(e=null!=(U=this.params.citation)?U:this.params)}catch(e){}if("string"==typeof e){try{(e.startsWith("{")||e.startsWith("["))&&(e=JSON.parse(e))}catch(e){}e.startsWith("10.")&&(e=await this.src.openalex.works.doi(e))}if(Dt={},"object"==typeof e){for(c=0,g=(z=["doi","pmid","pmcid"]).length;c<g;c++)Dt[p=z[c]]=null!=(Q=null!=(ue=e[p])?ue:e[p.toUpperCase()])?Q:null!=(be=e.ids)?be[p]:void 0,"number"==typeof Dt[p]&&(Dt[p]=Dt[p].toString()),("pmid"===p||"pmcid"===p)&&Dt[p]&&Dt[p].includes("/")&&(Dt[p]=Dt[p].split("/").pop()),"doi"===p&&Dt[p]&&Dt[p].includes(".org/")&&(Dt[p]=Dt[p].split(".org/").pop()),Dt[p]&&"pmcid"===p&&!Dt[p].startsWith("PMC")&&(Dt[p]="PMC"+Dt[p]);Dt.doi&&!Dt.DOI&&(Dt.DOI=Dt.doi);try{Dt.type=null!=(Ee=null!=(Fe=e.type_crossref)?Fe:e.type)?Ee:e.genre}catch(e){}Dt.issn=null!=(Ke=null!=(ct=null!=(wt=null!=(F=null!=(B=e.ISSN)?B:e.issn)?F:null!=(J=e.journalInfo)&&null!=(X=J.journal)?X.issn:void 0)?wt:null!=($=e.journal)?$.issn:void 0)?ct:null!=(V=e.primary_location)&&null!=(G=V.source)?G.issn:void 0)?Ke:[],null!=(null!=(Y=e.journalInfo)&&null!=(H=Y.journal)?H.eissn:void 0)&&(Z=e.journalInfo.journal.eissn,N.call(Dt.issn,Z)<0)&&Dt.issn.push(e.journalInfo.journal.eissn),!Dt.issn&&e.journal_issns&&(Dt.issn=e.journal_issns.split(",")),Dt.title=e.title,Array.isArray(Dt.title)&&(Dt.title=Dt.title[0]),Dt.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(Dt.title+=": "+e.subtitle[0]),null==Dt.title&&(Dt.title=null!=(K=e.dctitle)?K:null!=(ee=e.bibjson)?ee.title:void 0),404!==(te=Dt.title)&&"404"!==te||delete Dt.title,"string"==typeof Dt.title&&(Dt.title=Dt.title.replace(/\s\s+/g," ").trim()),Dt.journal=e["container-title"]?e["container-title"][0]:null!=(ie=e.primary_location)&&null!=(re=ie.source)?re.display_name:void 0;try{Dt.shortname=e["short-container-title"][0]}catch(e){}try{Dt.shortname=null!=(se=e.journalInfo.journal.isoabbreviation)?se:e.journalInfo.journal.medlineAbbreviation}catch(e){}null==Dt.journal&&(Dt.journal=null!=(ae=null!=(ne=e.journal_name)?ne:null!=(le=e.journalInfo)&&null!=(oe=le.journal)?oe.title:void 0)?ae:null!=(ce=e.journal)?ce.title:void 0),e.journal&&(Dt.journal=e.journal.split("(")[0].trim()),null==Dt.shortname&&(Dt.shortname=Dt.journal),Dt.shortname&&!Dt.journal_short&&(Dt.journal_short=Dt.shortname);try{for(d=0,_=(pe=["title","journal"]).length;d<_;d++)null==Dt[f=pe[d]]&&(Dt[f]=Dt[f].charAt(0).toUpperCase()+Dt[f].slice(1))}catch(e){}Dt.publisher=null!=(de=null!=(he=e.publisher)?he:null!=(fe=e.primary_location)&&null!=(me=fe.source)?me.publisher:void 0)?de:null!=(ye=e.primary_location)&&null!=(ge=ye.source)?ge.host_organization_name:void 0,Dt.publisher&&(Dt.publisher=Dt.publisher.trim());try{Dt.publisher_lineage=e.primary_location.source.host_organization_lineage_names}catch(e){}for(Dt.published=e.publication_date,Dt.issue=null!=(_e=null!=(ve=e.issue)?ve:null!=(we=e.journalInfo)?we.issue:void 0)?_e:null!=(xe=e.biblio)?xe.issue:void 0,Dt.volume=null!=(Oe=null!=(ke=e.volume)?ke:null!=(je=e.journalInfo)?je.volume:void 0)?Oe:null!=(Se=e.biblio)?Se.volume:void 0,(e.page||e.pages||e.pageInfo)&&(Dt.pages=(null!=(Ie=null!=(Ae=e.page)?Ae:e.pages)?Ie:e.pageInfo).toString()),((null!=(De=e.biblio)?De.first_page:void 0)||(null!=(Ce=e.biblio)?Ce.last_page:void 0))&&(Dt.pages=e.biblio.first_page===e.biblio.last_page?e.biblio.first_page:(null!=(Ne=e.biblio.first_page)?Ne:"")+(e.biblio.first_page&&e.biblio.last_page?"-":"")+(null!=(Le=e.biblio.last_page)?Le:"")),Dt.abstract=null!=(Pe=e.abstract)?Pe:e.abstractText,L=0,x=(Re=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;L<x;L++)if(R=Re[L],"string"!=typeof Dt.published){if(Et=null!=(qe=null!=(Te=e[R])?Te:null!=(Me=e["journal-issue"])?Me[R.replace("journal-issue.","")]:void 0)?qe:null!=(We=e.journalInfo)?We[R.replace("journalInfo.","")]:void 0){"number"==typeof Et&&(Et=Et.toString());try{"string"!=typeof Et&&(Et=Et["date-time"].toString())}catch(e){}if("string"!=typeof Et)try{for(h in Et["date-parts"][0])"number"!=(Ue=typeof Et["date-parts"][0][h])&&"string"!==Ue&&(Et["date-parts"][0][h]="01");Et=Et["date-parts"][0].join("-")}catch(e){}"string"==typeof Et&&(Dt.published=Et.includes("T")?Et.split("T")[0]:Et,Dt.published=Dt.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Dt.published.includes("-")||(Dt.published+="-01"),3!==Dt.published.split("-").length&&(Dt.published+="-01"),null==Dt.year&&(Dt.year=Dt.published.split("-")[0]),3!==Dt.published.split("-").length&&delete Dt.published,4!==Dt.year.toString().length&&delete Dt.year)}if(Dt.published)break}e.year&&null==Dt.year&&(Dt.year=e.year);try{null==Dt.year&&(Dt.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!Dt.year&&Dt.published&&Dt.published.includes("-")&&(Dt.year=Dt.published.split("-")[0]),null==Dt.author&&(a=null!=(ze=null!=(Be=null!=(Je=e.author)?Je:e.z_authors)?Be:null!=(Xe=e.authorList)?Xe.author:void 0)?ze:e.authorships)){null==Dt.author&&(Dt.author=[]);try{for(P=0,O=a.length;P<O;P++)if("string"==typeof(t=a[P]))Dt.author.push({name:t});else{if(s={},"object"==typeof t.author){t.author.display_name.split(" ").length>1&&(s.given=t.author.display_name.split(" ")[0]),s.family=t.author.display_name.split(" ").pop();try{t.author.display_name.split(" ").length>2&&(s.given=t.author.display_name.replace(" "+s.family,""))}catch(e){}for(s.name=t.author.display_name,Ve=null!=($e=t.raw_affiliation_strings)?$e:[],M=0,k=Ve.length;M<k;M++)i=Ve[M],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i})}else for(s.given=null!=(Ge=t.given)?Ge:t.firstName,s.family=null!=(Ye=t.family)?Ye:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(He=s.family)?He:""),Qe=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=(Ze=t.authorAffiliationDetailsList.authorAffiliation)?Ze:[],W=0,j=Qe.length;W<j;W++)"string"==typeof(i=Qe[W])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(et=i.name)?et:i.affiliation).replace(/\s\s+/g," ").trim()}));try{s.affiliation=s.affiliation.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}Dt.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(Dt.subject=e.subject)}catch(e){}try{null!=(null!=(tt=e.keywordList)?tt.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(Dt.keyword=e.keywordList.keyword)}catch(e){}if(!Dt.keyword&&e.keywords)for(Dt.keyword=[],Nt=0,S=(it=e.keywords).length;Nt<S;Nt++)((m=it[Nt]).keyword||m.display_name)&&Dt.keyword.push(null!=(rt=m.keyword)?rt:m.display_name);try{for(ot=[...null!=(st=null!=(at=e.meshHeadingList)?at.meshHeading:void 0)?st:[],...null!=(nt=null!=(lt=e.chemicalList)?lt.chemical:void 0)?nt:[]],Pt=0,I=ot.length;Pt<I;Pt++)C=ot[Pt],null==Dt.keyword&&(Dt.keyword=[]),"string"==typeof(E="string"==typeof C?C:null!=(ut=C.name)?ut:C.descriptorName)&&E&&N.call(Dt.keyword,E)<0&&Dt.keyword.push(E)}catch(e){}"string"==typeof e.license&&(Dt.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(Dt.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(pt=e.best_oa_location)?pt.license:void 0)&&null==Dt.licence&&(Dt.licence=e.best_oa_location.license)}catch(e){}try{(null!=(dt=e.primary_location)?dt.license:void 0)&&null==Dt.licence&&(Dt.licence=e.primary_location.license)}catch(e){}if(!Dt.licence){for(Rt=0,A=(ft=null!=(ht=e.assertion)?ht:[]).length;Rt<A;Rt++)"OPEN ACCESS"===(t=ft[Rt]).label&&t.URL&&t.URL.includes("creativecommons")&&null==Dt.licence&&(Dt.licence=t.URL);for(qt=0,D=(yt=null!=(mt=e.license)?mt:[]).length;qt<D;qt++)!(y=yt[qt]).URL||!y.URL.includes("creativecommons")||Dt.licence&&Dt.licence.includes("creativecommons")||null==Dt.licence&&(Dt.licence=y.URL)}if("string"==typeof Dt.licence&&Dt.licence.includes("/licenses/")&&(Dt.licence="cc-"+Dt.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Dt.url&&(Dt.url=null!=(gt=null!=(_t=null!=(vt=null!=(bt=e.best_oa_location)?bt.pdf_url:void 0)?vt:null!=(xt=e.best_oa_location)?xt.url_for_pdf:void 0)?_t:null!=(Ot=e.best_oa_location)?Ot.url:void 0)?gt:null!=(kt=e.best_oa_location)?kt.landing_page_url:void 0),!Dt.url&&null!=(null!=(jt=e.fullTextUrlList)?jt.fullTextUrl:void 0))for(Tt=0,v=(St=e.fullTextUrlList.fullTextUrl).length;Tt<v;Tt++)"oa"!==(It=(l=St[Tt]).availabilityCode.toLowerCase())&&"f"!==It||Dt.url&&("pdf"!==l.documentStyle||Dt.url.includes("pdf"))||(Dt.url=l.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Dt.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(Dt.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Dt.doi&&e.includes("http")&&(Dt.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(Dt.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?Dt.title=e.split('"')[1].trim():e.split("'").length>2&&null==Dt.title&&(Dt.title=e.split("'")[1].trim())}catch(e){}try{for(T=e.replace(/,\./g," ").split(" "),Mt=0,b=T.length;Mt<b;Mt++)q=T[Mt],Dt.year||4===(q=q.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Lt=parseInt(q))||isNaN(Lt)||(Dt.year=Lt))}catch(e){}try{!Dt.title&&Dt.year&&e.indexOf(Dt.year)<e.length/4&&(Dt.title=e.split(Dt.year)[1].trim(),(!Dt.title.includes("(")||Dt.title.indexOf(")")<Dt.title.indexOf("("))&&(Dt.title=Dt.title.replace(")","")),Dt.title.indexOf(".")<3&&(Dt.title=Dt.title.replace(".","")),Dt.title.indexOf(",")<3&&(Dt.title=Dt.title.replace(",","")),Dt.title=Dt.title.trim(),Dt.title.includes(".")?Dt.title=Dt.title.split(".")[0]:Dt.title.includes(",")&&(Dt.title=Dt.title.split(",")[0]))}catch(e){}if(Dt.title){try{if(n=e.split(Dt.title)[0],Dt.year&&n.includes(Dt.year)&&(n=n.split(Dt.year)[0]),Dt.url&&n.indexOf(Dt.url)>0&&(n=n.split(Dt.url)[0]),Dt.url&&n.startsWith(Dt.url)&&(n=n.replace(Dt.url)),Dt.doi&&n.startsWith(Dt.doi)&&(n=n.replace(Dt.doi)),n.indexOf(".")<3&&(n=n.replace(".","")),n.indexOf(",")<3&&(n=n.replace(",","")),n.lastIndexOf("(")>n.length-3&&(n=n.substring(0,n.lastIndexOf("("))),n.lastIndexOf(")")>n.length-3&&(n=n.substring(0,n.lastIndexOf(")"))),n.lastIndexOf(",")>n.length-3&&(n=n.substring(0,n.lastIndexOf(","))),n.lastIndexOf(".")>n.length-3&&(n=n.substring(0,n.lastIndexOf("."))),(n=n.trim()).length>6)if(n.includes(","))for(Dt.author=[],At=n.split(","),Wt=0,w=At.length;Wt<w;Wt++)r=At[Wt],Dt.author.push({name:r});else Dt.author=[{name:n}]}catch(e){}try{Ct=e.split(Dt.title)[1],Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.replace(Dt.url)),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.replace(Dt.doi)),Ct.indexOf(".")<3&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<3&&(Ct=Ct.replace(",","")),(Ct=Ct.trim()).length>6&&(Dt.journal=Ct,Ct.includes(",")&&(Dt.journal=Dt.journal.split(",")[0].replace(/in /gi,"").trim()),Dt.journal.indexOf(".")<3&&(Dt.journal=Dt.journal.replace(".","")),Dt.journal.indexOf(",")<3&&(Dt.journal=Dt.journal.replace(",","")),Dt.journal=Dt.journal.trim())}catch(e){}}try{if(Dt.journal&&(Ct=e.split(Dt.journal)[1],Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.replace(Dt.url)),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.replace(Dt.doi)),Ct.indexOf(".")<3&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<3&&(Ct=Ct.replace(",","")),(Ct=Ct.trim()).length>4)){if(Ct.includes("retrieved")&&(Ct=Ct.split("retrieved")[0]),Ct.includes("Retrieved")&&(Ct=Ct.split("Retrieved")[0]),Dt.volume=Ct,Dt.volume.includes("(")){Dt.volume=Dt.volume.split("(")[0],Dt.volume=Dt.volume.trim();try{Dt.issue=Ct.split("(")[1].split(")")[0],Dt.issue=Dt.issue.trim()}catch(e){}}if(Dt.volume.includes(",")){Dt.volume=Dt.volume.split(",")[0],Dt.volume=Dt.volume.trim();try{Dt.issue=Ct.split(",")[1],Dt.issue=Dt.issue.trim()}catch(e){}}if(Dt.volume)try{isNaN(parseInt(Dt.volume))&&delete Dt.volume}catch(e){}if(Dt.issue){Dt.issue.includes(",")&&(Dt.issue=Dt.issue.split(",")[0].trim());try{isNaN(parseInt(Dt.issue))&&delete Dt.issue}catch(e){}}if(Dt.volume&&Dt.issue)try{(Ct=e.split(Dt.journal)[1]).includes("retriev")&&(Ct=Ct.split("retriev")[0]),Ct.includes("Retriev")&&(Ct=Ct.split("Retriev")[0]),Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.split(Dt.url)[0]),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.split(Dt.doi)[0]),(Ct=(Ct=Ct.substring(Ct.indexOf(Dt.volume)+(Dt.volume+"").length)).substring(Ct.indexOf(Dt.issue)+(Dt.issue+"").length)).indexOf(".")<2&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<2&&(Ct=Ct.replace(",","")),Ct.indexOf(")")<2&&(Ct=Ct.replace(")","")),Ct=Ct.trim(),isNaN(parseInt(Ct.substring(0,1)))||(Dt.pages=Ct.split(" ")[0].split(".")[0].trim(),Dt.pages.length>5&&(Dt.pages=Dt.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!Dt.author&&e.includes("et al")&&(u=e.split("et al")[0].trim(),e.startsWith(u)&&(Dt.author=[{name:u+"et al"}])),Dt.title&&!Dt.volume)try{(o=e.split(Dt.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Dt.volume=o.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Dt.issue&&o.includes("iss")&&(Dt.issue=o.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Dt.pages&&o.includes("page")&&(Dt.pages=o.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof Dt.year&&(Dt.year=Dt.year.toString()),Dt},N=[].indexOf,t.find_diffs=async function(){var e,t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;for((x={count:[],ignoring:(null!=(c=this.params.ignore)?c:"journal_short,shortname,subject,keyword,DOI").split(","),dois:["10.1073/pnas.1905762116","10.1111/j.1600-051x.1988.tb01596.x","10.1186/s12888-019-2120-9","10.1021/acsanm.8b00798","10.1001/archinte.1963.03860030092007","10.1001/jamainternmed.2019.6770","10.1090/s0002-9939-2014-12202-7","10.1045.joes-fake-doi","10.3726/978-3-653-04227-6","10.1016/b978-1-78242-121-4.00003-4","10.1036/1097-8542.198450","10.1063/1.4905616","10.1080/03071843809419849","10.1134/s1068162014030066","10.15650/hebruniocollannu.89.2018.0221","10.1111/j.1474-919x.1995.tb08455.x","10.2164/jandrol.111.014894","10.1111/j.1600-051x.1988.tb01596.x","10.1103/physreve.83.066702","10.1016/j.foot.2017.04.003","10.1134/S1019331619060042"]}).find={},r=0,n=(p=x.dois).length;r<n;r++){i=p[r],x.find[i]={},u=await this.find_old(i);try{for(f=u.metadata.author,s=0,l=f.length;s<l;s++){e=f[s];try{e.affiliation=e.affiliation.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}}}catch(e){}try{u.metadata.author=u.metadata.author.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}o=await this.find(i);try{o.metadata.author=o.metadata.author.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}for(a in(null!=(m=u.url)?m:"").toLowerCase()!==(null!=(y=o.url)?y:"").toLowerCase()&&(x.find[i].url_old=null!=(g=u.url)?g:"",x.find[i].url_new=null!=(_=o.url)?_:""),u.metadata)"object"==typeof u.metadata[a]&&(u.metadata[a]=JSON.stringify(u.metadata[a])),"object"==typeof o.metadata[a]&&(o.metadata[a]=JSON.stringify(o.metadata[a])),N.call(x.ignoring,a)<0&&(null!=(v=u.metadata[a])?v:"").toLowerCase()!==(null!=(b=o.metadata[a])?b:"").toLowerCase()&&(x.find[i][a+"_old"]=null!=(w=u.metadata[a])?w:"",x.find[i][a+"_new"]=null!=(d=o.metadata[a])?d:"",x.find[i][a+"_old"]&&x.find[i][a+"_new"]&&(x.find[i][a+"_lev"]=(await this.levenshtein(x.find[i][a+"_old"],x.find[i][a+"_new"])).distance),N.call(x.count,i)<0&&x.count.push(i));for(t in o.metadata)N.call(x.ignoring,t)<0&&o.metadata[t]&&null==u.metadata[t]&&(x.find[i][t+"_old"]="",x.find[i][t+"_new"]="object"==typeof o.metadata[t]?JSON.stringify(o.metadata[t]):null!=(h=o.metadata[t])?h:"",N.call(x.count,i)<0&&x.count.push(i))}return x.count=x.count.length+"/"+x.dois.length,x},t.find_old=async function(e,t={},i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;w={},s=async e=>{var i,r;for(r in i=await this.citation_old(e))"url"===r||"paywall"===r?null==w[r]&&(w[r]=i[r]):t[r]||(t[r]=i[r]);return!0},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(d=e.dom)?d:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find_old=e.metadata),e.find_old&&(e.find_old.startsWith("10.")&&e.find_old.includes("/")?e.doi=e.find_old:e.url=e.find_old,delete e.find_old),null==e.url&&(e.url=null!=(h=e.q)?h:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(l="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&l.split("/")[0].length>6&&l.length>8&&((o=l.split("/")).length>2&&(l=o.join("/")),null==t.doi&&(t.doi=l)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(f=e.url.replace("...","").match(/\./gi))?f:[]).length>3||(null!=(m=e.url.match(/\(/gi))?m:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(y=e.title.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(g=e.title.match(/\(/gi))?g:[]).length>2)&&(e.citation=e.title,delete e.title),e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(_=e.pmcid)?_:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}for("string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(w.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(v=e.from)||"eZwJ83xp3oZDaec86"===v)&&null==w.demo&&(w.demo=!0),w.demo&&null==w.test&&(w.test=!0),u=!1,n=async()=>{var r,a,n,l,o;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(o=await this.scrape(null!=i?i:e.url),await s(o)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(l=t.pmcid)?l:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(n=await this.src.crossref.works.title(t.title))?n.type:void 0)&&(null!=n?n.DOI:void 0)&&await s(n),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(a=async()=>{var e;return null==(e=await this.src.oadoi.doi(t.doi))&&(w.doi_not_in_oadoi=t.doi),(null!=e?e.doi:void 0)&&(null!=t?t.doi:void 0)&&e.doi.toLowerCase()===t.doi.toLowerCase()&&await s(e),!0},r=async()=>{if(null!=(n=await this.src.crossref.works.doi(t.doi))?n.type:void 0){try{n.published=await this.src.crossref.works.published(n);try{n.year=n.published.split("-")[0]}catch(e){}try{n.year=parseInt(n.year)}catch(e){}try{n.publishedAt=await this.epoch(n.published)}catch(e){}}catch(e){}await s(n)}else w.doi_not_in_crossref=t.doi;return!0},await Promise.all([a(),r()])),!0},await n(),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==w.ill&&(w.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},a=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==w.permissions&&(w.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),a()]),c=0,p=(b=["title","journal","year","doi"]).length;c<p;c++)e[x=b[c]]&&e[x]!==t[x]&&(t[x]=e[x]);return w.metadata=t,w},t.citation_old=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe,Te,Me,We,Ue,ze,Fe,Be,Je,Xe,$e,Ve,Ge,Ye,He,Ze,Qe,Ke,et,tt,it,rt,st,at,nt,lt,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Et;bt={};try{null==e&&(e=null!=(R=this.params.citation_old)?R:this.params)}catch(e){}if("string"==typeof e)if(e.startsWith("{")||e.startsWith("["))try{e=JSON.parse(e)}catch(e){}else if(e.startsWith("10."))try{e=await this.src.crossref.works.doi(e)}catch(e){}if("object"==typeof e){bt.doi=null!=(q=e.DOI)?q:e.doi,bt.pmid=null!=(V=e.pmid)?V:null!=(se=e.ids)?se.pmid:void 0,bt.pmcid=null!=(me=e.pmcid)?me:null!=(Se=e.ids)?Se.pmcid:void 0;try{bt.type=null!=(Te=null!=(Ge=e.type_crossref)?Ge:e.type)?Te:e.genre}catch(e){}null==bt.issn&&(bt.issn=null!=(at=null!=(yt=null!=(T=null!=(M=e.ISSN)?M:e.issn)?T:null!=(W=e.journalInfo)&&null!=(U=W.journal)?U.issn:void 0)?yt:null!=(z=e.journal)?z.issn:void 0)?at:null!=(F=e.primary_location)&&null!=(B=F.source)?B.issn:void 0),null!=(null!=(J=e.journalInfo)&&null!=(X=J.journal)?X.eissn:void 0)&&(null==bt.issn&&(bt.issn=[]),"string"==typeof bt.issn&&(bt.issn=[bt.issn]),$=e.journalInfo.journal.eissn,N.call(bt.issn,$)<0&&bt.issn.push(e.journalInfo.journal.eissn)),!bt.issn&&e.journal_issns&&(bt.issn=e.journal_issns.split(",")),bt.title=e.title,Array.isArray(bt.title)&&(bt.title=bt.title[0]),bt.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(bt.title+=": "+e.subtitle[0]),null==bt.title&&(bt.title=null!=(G=e.dctitle)?G:null!=(Y=e.bibjson)?Y.title:void 0),404!==(H=bt.title)&&"404"!==H||delete bt.title,"string"==typeof bt.title&&(bt.title=bt.title.replace(/\s\s+/g," ").trim()),null==bt.journal&&(bt.journal=e["container-title"]?e["container-title"][0]:null!=(Z=e.primary_location)&&null!=(Q=Z.source)?Q.display_name:void 0);try{bt.shortname=e["short-container-title"][0]}catch(e){}try{bt.shortname=null!=(K=e.journalInfo.journal.isoabbreviation)?K:e.journalInfo.journal.medlineAbbreviation}catch(e){}bt.shortname&&!bt.journal_short&&(bt.journal_short=bt.shortname),null==bt.journal&&(bt.journal=null!=(ee=null!=(te=e.journal_name)?te:null!=(ie=e.journalInfo)&&null!=(re=ie.journal)?re.title:void 0)?ee:null!=(ae=e.journal)?ae.title:void 0),e.journal&&(bt.journal=e.journal.split("(")[0].trim());try{for(u=0,m=(ne=["title","journal"]).length;u<m;u++)null==bt[d=ne[u]]&&(bt[d]=bt[d].charAt(0).toUpperCase()+bt[d].slice(1))}catch(e){}null==bt.publisher&&(bt.publisher=null!=(le=e.publisher)?le:null!=(oe=e.primary_location)&&null!=(ue=oe.source)?ue.publisher:void 0),bt.publisher&&(bt.publisher=bt.publisher.trim()),null==bt.published&&(bt.published=e.publication_date);try{null==bt.issue&&(bt.issue=null!=(ce=null!=(pe=e.issue)?pe:null!=(de=e.journalInfo)?de.issue:void 0)?ce:null!=(he=e.biblio)?he.issue:void 0)}catch(e){}try{null==bt.volume&&(bt.volume=null!=(fe=null!=(ye=e.volume)?ye:null!=(ge=e.journalInfo)?ge.volume:void 0)?fe:null!=(_e=e.biblio)?_e.volume:void 0)}catch(e){}for((e.page||e.pages||e.pageInfo)&&null==bt.pages&&(bt.pages=(null!=(ve=e.page)?ve:e.pageInfo).toString()),((null!=(be=e.biblio)?be.first_page:void 0)||(null!=(we=e.biblio)?we.last_page:void 0))&&(bt.pages=(null!=(xe=e.biblio.first_page)?xe:"")+(e.biblio.first_page&&e.biblio.last_page?" to ":"")+(null!=(Oe=e.biblio.last_page)?Oe:"")),bt.abstract=null!=(ke=e.abstract)?ke:e.abstractText,c=0,y=(je=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;c<y;c++)if(D=je[c],"string"!=typeof bt.published){if(xt=null!=(Ie=null!=(Ae=e[D])?Ae:null!=(De=e["journal-issue"])?De[D.replace("journal-issue.","")]:void 0)?Ie:null!=(Ce=e.journalInfo)?Ce[D.replace("journalInfo.","")]:void 0){"number"==typeof xt&&(xt=xt.toString());try{"string"!=typeof xt&&(xt=xt["date-time"].toString())}catch(e){}if("string"!=typeof xt)try{for(p in xt["date-parts"][0])"number"!=(Ee=typeof xt["date-parts"][0][p])&&"string"!==Ee&&(xt["date-parts"][0][p]="01");xt=xt["date-parts"][0].join("-")}catch(e){}"string"==typeof xt&&(bt.published=xt.includes("T")?xt.split("T")[0]:xt,bt.published=bt.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),bt.published.includes("-")||(bt.published+="-01"),3!==bt.published.split("-").length&&(bt.published+="-01"),null==bt.year&&(bt.year=bt.published.split("-")[0]),3!==bt.published.split("-").length&&delete bt.published,4!==bt.year.toString().length&&delete bt.year)}if(bt.published)break}e.year&&null==bt.year&&(bt.year=e.year);try{null==bt.year&&(bt.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!bt.year&&bt.published&&bt.published.includes("-")&&(bt.year=bt.published.split("-")[0]),null==bt.author&&(null!=e.author||null!=e.z_authors||(null!=(Ne=e.authorList)?Ne.author:void 0)||e.authorships)){null==bt.author&&(bt.author=[]);try{for(qe=null!=(Le=null!=(Pe=null!=(Re=e.author)?Re:e.z_authors)?Pe:e.authorList.author)?Le:e.authorships,L=0,v=qe.length;L<v;L++)if("string"==typeof(t=qe[L]))bt.author.push({name:t});else{if(s={},"object"==typeof t.author)for(s.name=t.author.display_name,s.family=s.name.split(" ").pop(),s.name.split(" ").length>1&&(s.given=s.name.split(" ")[0]),We=null!=(Me=s.raw_affiliation_strings)?Me:[],P=0,b=We.length;P<b;P++)i=We[P],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i});else for(s.given=null!=(Ue=t.given)?Ue:t.firstName,s.family=null!=(ze=t.family)?ze:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(Fe=s.family)?Fe:""),Je=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=(Be=t.authorAffiliationDetailsList.authorAffiliation)?Be:[],Ot=0,w=Je.length;Ot<w;Ot++)"string"==typeof(i=Je[Ot])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(Xe=i.name)?Xe:i.affiliation).replace(/\s\s+/g," ").trim()}));bt.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(bt.subject=e.subject)}catch(e){}try{null!=(null!=($e=e.keywordList)?$e.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(bt.keyword=e.keywordList.keyword)}catch(e){}if(!bt.keyword&&e.keywords)for(bt.keyword=[],jt=0,x=(Ve=e.keywords).length;jt<x;jt++)h=Ve[jt],bt.keyword.push(h.keyword);try{for(Ke=[...null!=(Ye=null!=(He=e.meshHeadingList)?He.meshHeading:void 0)?Ye:[],...null!=(Ze=null!=(Qe=e.chemicalList)?Qe.chemical:void 0)?Ze:[]],St=0,O=Ke.length;St<O;St++)I=Ke[St],null==bt.keyword&&(bt.keyword=[]),"string"==typeof(A="string"==typeof I?I:null!=(et=I.name)?et:I.descriptorName)&&A&&N.call(bt.keyword,A)<0&&bt.keyword.push(A)}catch(e){}"string"==typeof e.license&&(bt.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(bt.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(tt=e.best_oa_location)?tt.license:void 0)&&null==bt.licence&&(bt.licence=e.best_oa_location.license)}catch(e){}try{(null!=(it=e.primary_location)?it.license:void 0)&&null==bt.licence&&(bt.licence=e.primary_location.license)}catch(e){}if(!bt.licence){for(It=0,k=(st=null!=(rt=e.assertion)?rt:[]).length;It<k;It++)"OPEN ACCESS"===(t=st[It]).label&&t.URL&&t.URL.includes("creativecommons")&&null==bt.licence&&(bt.licence=t.URL);for(At=0,j=(lt=null!=(nt=e.license)?nt:[]).length;At<j;At++)!(f=lt[At]).URL||!f.URL.includes("creativecommons")||bt.licence&&bt.licence.includes("creativecommons")||null==bt.licence&&(bt.licence=f.URL)}if("string"==typeof bt.licence&&bt.licence.includes("/licenses/")&&(bt.licence="cc-"+bt.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==bt.url&&(bt.url=null!=(ot=null!=(ut=null!=(ct=null!=(pt=e.best_oa_location)?pt.pdf_url:void 0)?ct:null!=(dt=e.best_oa_location)?dt.url_for_pdf:void 0)?ut:null!=(ht=e.best_oa_location)?ht.url:void 0)?ot:null!=(ft=e.best_oa_location)?ft.landing_page_url:void 0),!bt.url&&null!=(null!=(mt=e.fullTextUrlList)?mt.fullTextUrl:void 0))for(Dt=0,S=(gt=e.fullTextUrlList.fullTextUrl).length;Dt<S;Dt++)"oa"!==(_t=(n=gt[Dt]).availabilityCode.toLowerCase())&&"f"!==_t||bt.url&&("pdf"!==n.documentStyle||bt.url.includes("pdf"))||(bt.url=n.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(bt.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(bt.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!bt.doi&&e.includes("http")&&(bt.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(bt.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?bt.title=e.split('"')[1].trim():e.split("'").length>2&&null==bt.title&&(bt.title=e.split("'")[1].trim())}catch(e){}try{for(E=e.replace(/,\./g," ").split(" "),Ct=0,g=E.length;Ct<g;Ct++)C=E[Ct],bt.year||4===(C=C.replace(/[^0-9]/g,"")).length&&("number"!=typeof(kt=parseInt(C))||isNaN(kt)||(bt.year=kt))}catch(e){}try{!bt.title&&bt.year&&e.indexOf(bt.year)<e.length/4&&(bt.title=e.split(bt.year)[1].trim(),(!bt.title.includes("(")||bt.title.indexOf(")")<bt.title.indexOf("("))&&(bt.title=bt.title.replace(")","")),bt.title.indexOf(".")<3&&(bt.title=bt.title.replace(".","")),bt.title.indexOf(",")<3&&(bt.title=bt.title.replace(",","")),bt.title=bt.title.trim(),bt.title.includes(".")?bt.title=bt.title.split(".")[0]:bt.title.includes(",")&&(bt.title=bt.title.split(",")[0]))}catch(e){}if(bt.title){try{if(a=e.split(bt.title)[0],bt.year&&a.includes(bt.year)&&(a=a.split(bt.year)[0]),bt.url&&a.indexOf(bt.url)>0&&(a=a.split(bt.url)[0]),bt.url&&a.startsWith(bt.url)&&(a=a.replace(bt.url)),bt.doi&&a.startsWith(bt.doi)&&(a=a.replace(bt.doi)),a.indexOf(".")<3&&(a=a.replace(".","")),a.indexOf(",")<3&&(a=a.replace(",","")),a.lastIndexOf("(")>a.length-3&&(a=a.substring(0,a.lastIndexOf("("))),a.lastIndexOf(")")>a.length-3&&(a=a.substring(0,a.lastIndexOf(")"))),a.lastIndexOf(",")>a.length-3&&(a=a.substring(0,a.lastIndexOf(","))),a.lastIndexOf(".")>a.length-3&&(a=a.substring(0,a.lastIndexOf("."))),(a=a.trim()).length>6)if(a.includes(","))for(bt.author=[],vt=a.split(","),Et=0,_=vt.length;Et<_;Et++)r=vt[Et],bt.author.push({name:r});else bt.author=[{name:a}]}catch(e){}try{wt=e.split(bt.title)[1],bt.url&&wt.includes(bt.url)&&(wt=wt.replace(bt.url)),bt.doi&&wt.includes(bt.doi)&&(wt=wt.replace(bt.doi)),wt.indexOf(".")<3&&(wt=wt.replace(".","")),wt.indexOf(",")<3&&(wt=wt.replace(",","")),(wt=wt.trim()).length>6&&(bt.journal=wt,wt.includes(",")&&(bt.journal=bt.journal.split(",")[0].replace(/in /gi,"").trim()),bt.journal.indexOf(".")<3&&(bt.journal=bt.journal.replace(".","")),bt.journal.indexOf(",")<3&&(bt.journal=bt.journal.replace(",","")),bt.journal=bt.journal.trim())}catch(e){}}try{if(bt.journal&&(wt=e.split(bt.journal)[1],bt.url&&wt.includes(bt.url)&&(wt=wt.replace(bt.url)),bt.doi&&wt.includes(bt.doi)&&(wt=wt.replace(bt.doi)),wt.indexOf(".")<3&&(wt=wt.replace(".","")),wt.indexOf(",")<3&&(wt=wt.replace(",","")),(wt=wt.trim()).length>4)){if(wt.includes("retrieved")&&(wt=wt.split("retrieved")[0]),wt.includes("Retrieved")&&(wt=wt.split("Retrieved")[0]),bt.volume=wt,bt.volume.includes("(")){bt.volume=bt.volume.split("(")[0],bt.volume=bt.volume.trim();try{bt.issue=wt.split("(")[1].split(")")[0],bt.issue=bt.issue.trim()}catch(e){}}if(bt.volume.includes(",")){bt.volume=bt.volume.split(",")[0],bt.volume=bt.volume.trim();try{bt.issue=wt.split(",")[1],bt.issue=bt.issue.trim()}catch(e){}}if(bt.volume)try{isNaN(parseInt(bt.volume))&&delete bt.volume}catch(e){}if(bt.issue){bt.issue.includes(",")&&(bt.issue=bt.issue.split(",")[0].trim());try{isNaN(parseInt(bt.issue))&&delete bt.issue}catch(e){}}if(bt.volume&&bt.issue)try{(wt=e.split(bt.journal)[1]).includes("retriev")&&(wt=wt.split("retriev")[0]),wt.includes("Retriev")&&(wt=wt.split("Retriev")[0]),bt.url&&wt.includes(bt.url)&&(wt=wt.split(bt.url)[0]),bt.doi&&wt.includes(bt.doi)&&(wt=wt.split(bt.doi)[0]),(wt=(wt=wt.substring(wt.indexOf(bt.volume)+(bt.volume+"").length)).substring(wt.indexOf(bt.issue)+(bt.issue+"").length)).indexOf(".")<2&&(wt=wt.replace(".","")),wt.indexOf(",")<2&&(wt=wt.replace(",","")),wt.indexOf(")")<2&&(wt=wt.replace(")","")),wt=wt.trim(),isNaN(parseInt(wt.substring(0,1)))||(bt.pages=wt.split(" ")[0].split(".")[0].trim(),bt.pages.length>5&&(bt.pages=bt.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!bt.author&&e.includes("et al")&&(o=e.split("et al")[0].trim(),e.startsWith(o)&&(bt.author=[{name:o+"et al"}])),bt.title&&!bt.volume)try{(l=e.split(bt.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(bt.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!bt.issue&&l.includes("iss")&&(bt.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!bt.pages&&l.includes("page")&&(bt.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof bt.year&&(bt.year=bt.year.toString()),bt},t.availability=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&e.availability.includes("/")?e.doi=e.availability:e.availability.includes(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(a=null!=(n=null!=(g=null!=(b=null!=(w=null!=(x=null!=(O=null!=(k=e.doi)?k:e.pmid)?O:e.pmc)?x:e.pmcid)?w:e.title)?b:e.url)?g:e.id)?n:e.citation)?a:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.find(e)),null!=i.v2){null==(r=i.data).match&&(r.match=null!=(j=null!=(S=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(p=i.v2.metadata)?p.doi:void 0)?u:null!=(d=i.v2.metadata)?d.title:void 0)?o:null!=(h=i.v2.metadata)?h.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?S:null!=(m=i.v2.metadata)?m.pmcid:void 0)?j:null!=(y=i.v2.metadata)?y.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(s=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(A=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+s+" AND type:article&sort=createdAt:desc"))&&null!=(_=A.hits)?_.total:void 0)&&((D={type:"article",_id:(I=A.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(v=I.user)?v.id:void 0)!==e.uid),i.data.requests.push(D))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},N=[].indexOf,t.ill=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),s=e.config;try{s=JSON.parse(s)}catch(e){}for(p in("string"==typeof s||!s&&e.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=e.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:s)))),null==s&&(s={}),O={name:"librarian",details:""},d=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(c in e[p])"email"!==c&&(e[c]=e[p][c],N.call(d,c)<0&&d.push(c));delete e.metadata}else N.call(d,p)<0&&d.push(p);for(n=0,o=d.length;n<o;n++)if(e[h=d[n]]&&(O[h]=e[h],"author"===h)){for(a=!0,r=[],l=0,u=(y=e[h]).length;l<u;l++)(t=y[l]).family&&(a&&(a=!1),i=t.family+(t.given?" "+t.given:""),r.push(i));O[h]=r}return null!=e.author&&delete e.author,O.illid=e._id=await this.uid(),s.search&&s.search.length&&(e.issn||e.journal)&&(-1!==s.search.indexOf("worldcat")?(b=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",b+=null!=e.issn?"in%3A":"ti%3A",b+="&si0qs="+(null!=(g=e.issn)?g:e.journal),b+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(b=s.search,b+=e.issn?e.issn:e.journal),O.worldcatsearchurl=b),await this.ills(e),w=(w=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!s.email&&!e.email||this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,to:null!=(_=s.email)?_:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id})),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),x=["joe+notifications@oa.works"],(null!=(v=this.S.log)?v.logs:void 0)&&x.push(this.S.log.logs),this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:x})),e},t.ills={_index:!0},t.ill.collect=async function(e){var t,i,r;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},t.ill.openurl=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h;for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=s[r]);for(n in d="",e.ill_added_params&&(d+=e.ill_added_params.replace("?","")+"&"),d+=e.sid+"=InstantILL&",t){if(h="","author"===n)for(a=0,l=(p=Array.isArray(t.author)?t.author:[t.author]).length;a<l;a++)i=p[a],h.length&&(h+=", "),h+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==n&&"pmid"!==n&&"pmc"!==n&&"pmcid"!==n&&"url"!==n&&"journal"!==n&&"title"!==n&&"year"!==n&&"issn"!==n&&"volume"!==n&&"issue"!==n&&"page"!==n&&"crossref_type"!==n&&"publisher"!==n&&"published"!==n&&"notes"!==n||(h=t[n]);h&&(d+=(e[n]?e[n]:n)+"="+encodeURIComponent(h)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(o+"=")?d+="&"+o+"=The user provided some metadata.":d=d.replace(o+"=",o+"=The user provided some metadata. ")),d.replace("/&&/g","&")},t.ill.subscription=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(l=this.params.config)?l:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(p in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),a=await this.ill.openurl(e,t),e.ill_added_params&&(a=a.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(h=e.subscription[p])?(f=h.type,h=h.url):f=null!=(u=e.subscription_type[p])?u:"unknown",h=h.trim()){"serialssolutions"===f||-1!==h.indexOf("serialssolutions")?(-1!==(y=h.split(".search")[0]).indexOf("//")&&(y=y.split("//")[1]),h="http://"+y+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===h.indexOf("sfx.")||-1!==h.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===h.indexOf(".exlibris")||-1!==h.indexOf("response_type")||(h=h.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):h+=(-1===h.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=h+(-1===h.indexOf("?")?"?":"&")+a).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==h.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==h.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),n="",d="",i=!1,c.lookups.push(g);try{null!=(n=await this.fetch(g))&&"object"!=typeof n||(n="",i=!0)}catch(e){i=!0}try{d=-1!==n.indexOf("<body")?n.toLowerCase().split("<body")[1].split("</body")[0]:n,c.contents.push(d)}catch(e){i=!0}if("sfx"===f||-1!==g.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{c.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(e){}else-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==g.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==n.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+n.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">'))(r=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=r,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===d.indexOf("ss_noresults")){m=g.split("?")[0]+"?ShowSupressedLinks"+n.split("?ShowSupressedLinks")[1].split('">')[0];try{-1!==(s=await this.fetch(m)).indexOf("ArticleCL")&&-1!==s.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+s.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(e){i&&c.error.push("serialssolutions")}}}else"exlibris"!==f&&-1===g.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")&&(c.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},t.licence=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d,h,f,m,y;if(null==e&&(e=this.params.url),null==t&&(t=null!=(c=this.params.content)?c:this.body),e||t||!this.params.licence&&!this.params.doi||(e="https://doi.org/"+(null!=(p=this.params.licence)?p:this.params.doi)),e&&(e=e.replace(/(^\s*)|(\s*$)/g,""),!t)){C.log(e);try{t=await this.fetch(e)}catch(e){}}if("number"==typeof t&&(t=void 0),null==i&&(i=this.params.start),null==r&&(r=this.params.end),l={},e&&(l.url=e),"string"==typeof t)for(null!=i&&t.includes(i)&&(t=t.split(i)[1]),r&&(t=t.split(r)[0]),t.length>1e5&&(l.large=!0,t=t.substring(0,5e4)+t.substring(t.length-5e4,t.length)),s=0,n=(f=null!=(d=null!=(o=await this.licences("*",1e4))&&null!=(h=o.hits)?h.hits:void 0)?d:[]).length;s<n;s++)if((!(a=f[s]._source).matchesondomains||"*"===a.matchesondomains||null==e||a.matchesondomains.toLowerCase().includes(e.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=a.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(m=!!(y=!!a.matchtext.includes("://")&&a.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&t.toLowerCase().includes(y))||t.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){l.licence=a.licencetype,l.match=a.matchtext,l.matched=m?y:u;break}return l},t.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1},N=[].indexOf,t.oareport=function(){return"OA.Works OA.report"},t.oareport.works={_index:!0};try{t.oareport.email=t.report.email}catch(e){}t.oareport.orgs={_sheet:"1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data",_format:async function(e=[]){var t,i,r,s,a,n,l,o,u,c,p,d;for(o=[],r=0,a=(c="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<a;r++){for(i in l={},u=c[r]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(e){t=e,C.log("cant parse "+i,u[i],t)}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(l,i,u[i])}catch(e){}else l[i]=u[i]}if(Array.isArray(l.sheets))for(s=0,n=(p=l.sheets).length;s<n;s++)(d=p[s]).url=await this.encrypt(d.url);else delete l.sheets;try{"string"==typeof l.id&&l.id.length&&(l._id=l.id)}catch(e){}"{}"!==JSON.stringify(l)&&o.push(l)}return 1===o.length?o[0]:o}},o=new Map,t.oareport.duplicates=async function(e,t,i){var r,s,a,n,l,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X;if(null==i&&(i=Date.now()),null==e&&(e=null!=(j=this.params.duplicates)?j:this.params.doi),e=e.toLowerCase(),a=o.get(e))(t=a).memory=!0;else{for(u=["DOI","update-to.DOI"],l=0,p=(U=["is-same-as","is-version-of","has-version"]).length;l<p;l++)O=U[l],u.push("relation."+O+".id");for(x=u.join(':"'+e+'" OR ')+':"'+e+'"',null==t&&(t={original:e,doi:e,duplicates:[],count:0,cascades:0,timestamp:void 0,record:void 0,recs:{}}),W=[],n=!0,c=0,d=(F=null!=(S=null!=(z=await this.src.crossref.works(x,{size:1e4,sort:{"indexed.timestamp":"asc"}}))&&null!=(D=z.hits)?D.hits:void 0)?S:[]).length;c<d;c++){if((X=F[c]._source).DOI=X.DOI.toLowerCase(),t.recs[X.DOI]=X,null!=X["update-to"]){for(E=X.DOI,N.call(t.duplicates,E)<0&&t.duplicates.push(X.DOI),g=0,h=(L=X["update-to"]).length;g<h;g++)(J=L[g]).DOI&&(J.DOI=J.DOI.toLowerCase(),P=J.DOI,N.call(t.duplicates,P)<0&&t.duplicates.push(J.DOI),(k=t.duplicates.length)&&k>1&&t.duplicates[k-1].substring(0,t.duplicates[k-1].length-3)!==t.duplicates[k-2].substring(0,t.duplicates[k-2].length-3)&&(n=!1));t.timestamp=X.indexed.timestamp,t.doi=X.DOI}t.duplicates.length&&n&&(t.doi=t.duplicates.sort()[t.duplicates.length-1]),null!=X.relation&&"preprint"!==X.subtype&&W.push(X)}if(t.doi&&t.doi!==e&&null==t.recs[t.doi])return C.log("oareport duplicates looping",e,t.doi,t.original,t.cascades),t.cascades+=1,this.oareport.duplicates(t.doi,t,i);for(_=0,f=W.length;_<f;_++)for(X=W[_],b=0,m=U.length;b<m;b++)for(w=U[b],B=0,y=(T=null!=(R=null!=(q=X.relation)?q[w]:void 0)?R:[]).length;B<y;B++)s=T[B],M=X.DOI,N.call(t.duplicates,M)<0&&t.duplicates.push(X.DOI),t.recs[X.DOI]=X,"string"==typeof(null!=s?s.id:void 0)&&s.id.startsWith("10.")&&(s.id=s.id.toLowerCase(),I=s.id,N.call(t.duplicates,I)<0&&(t.duplicates.push(s.id),s.id.includes(t.doi)?(t.doi=s.id,null!=t.recs[t.doi]&&(t.timestamp=t.recs[t.doi].indexed.timestamp)):t.doi.substring(0,t.doi.length-3)===s.id.substring(0,s.id.length-3)&&(v=[t.doi,s.id].sort()[1])&&v!==t.doi?(t.doi=v,null!=t.recs[t.doi]&&(t.timestamp=t.recs[t.doi].indexed.timestamp)):s.id!==e&&(r=await this.src.crossref.works(s.id))&&(r.DOI=r.DOI.toLowerCase(),t.recs[s.id]=r,r.indexed.timestamp>X.indexed.timestamp&&r.indexed.timestamp>(null!=(A=t.timestamp)?A:0)&&(t.timestamp=r.indexed.timestamp,t.doi=s.id))));null==t.record&&(t.record=t.recs[t.doi]),t.count+=Object.keys(t.recs).length,delete t.recs}return t.memory||o.set(t.original,{doi:t.doi}),t.took=Date.now()-i,t},t.oareport.orgs.analysis=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S;for("string"==typeof e?(y=e,e=[]):"object"==typeof e&&(e=[e]),null!=e&&0!==e.length||(null==y&&(y=this.params.org),e=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")),n={},"string"==typeof y&&(y=y.split(",")),l=0,u=e.length;l<u;l++)if(m=e[l],!y||(v=m.id,N.call(y,v)>=0)){for(i in!1!==t&&(m=await this.report.orgs._format(m,!1)),null!=(b=m.analysis)?b:{})if(m.analysis[i].query&&!1!==(w=m.analysis[i].make_key)&&"false"!==w&&"False"!==w&&"FALSE"!==w)for await(g of(C.log("report orgs anaysing by query",m.id,m.name,i),await this.oareport.works._for(decodeURIComponent(m.analysis[i].query)))){if(null==n[p=g.DOI]&&(n[p]=g),null==(r=n[g.DOI]).meta&&(r.meta={}),null==(s=n[g.DOI].meta).query_matches&&(s.query_matches=[]),f=m.id+"/"+i,N.call(n[g.DOI].meta.query_matches,f)<0&&n[g.DOI].meta.query_matches.push(f),d=null!=(x=null!=(O=m.analysis[i].key)?O:m.analysis[i].name)?x:i,h=null==(k=m.analysis[i].value)||k,m.analysis[i].list){for(null==(a=await this.dot(n[g.DOI],d))&&(a=[]),Array.isArray(a)||(a=[a]),Array.isArray(h)||(h=[h]),o=0,c=h.length;o<c;o++)S=h[o],a.push(S);h=a}await this.dot(n[g.DOI],d,h)}if(m.country_code&&m.paid)for await(g of await this.oareport.works._for('DOI:* AND supplements.org.keyword:"'+m.id+'" AND NOT funder.country.keyword:"'+m.country_code+'"'))n[g.DOI]=await this.oareport._funder_country(null!=(j=n[g.DOI])?j:g,m)}return(_=Object.values(n))&&_.length&&await this.oareport.works(_),_.length},t.oareport.orgs.supplements={_index:!0,_auth:"@oa.works"},t.oareport.orgs.supplement=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A;for(this.params.empty&&await this.oareport.works(""),this.params.empty&&await this.oareport.orgs.supplements(""),k=await this.epoch(),l=await this.datetime(k),null==e&&(e=this.params.org),"string"==typeof e&&(e=e.split(",")),null==t&&(t=this.params.sheet),"string"==typeof t&&(t=t.split(",")),null==i&&(i=this.params.analysis),a=[],S={},I=0,r=async(e,t,r)=>{var s,a,n,o,u,c,p,d,h,f,m,y,g,_,v,b,w,O,j,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$;if(C.log(r.id,r.name,t.name,e,"of",x.length,t.url),!1!==i&&(i=1),$=null==(A=null!=(D=this.params.update)?D:this.params.empty)||A,y=!1,null==this.params.update&&!this.params.empty)try{for(n=!1,o=0;!1===n&&o<5;){o++;try{n=await this.src.google.sheets({sheetid:t.url,sheet:"m_admin",headers:!1})}catch(e){await this.sleep(5e3)}}if("last updated"===n[0][0].toLowerCase()&&(y=n[0][1])&&([_,b]=y.split(" "),y=await this.epoch(_.split("/").reverse().join("-")+"T"+b)),"number"==typeof y&&y>15778368e5){try{g=await this.oareport.works('supplements.sheets.keyword:"'+t.name+'"',{size:1,sort:{"supplements.updated":"desc"}})}catch(e){}null!=(null!=g&&null!=(L=g.hits)?L.hits:void 0)&&(g=g.hits.hits[0]._source),(null!=g&&null!=(P=g.meta)?P.updated:void 0)&&y<=g.meta.updated&&($=y)}}catch(e){$=!1}if(!0!==$)return C.log(r.id,r.name,t.name,"NOT loading because",y,"is not after",$);for(B=!1,X=0;!Array.isArray(B)&&X<5;){X++;try{B=await this.src.google.sheets({sheetid:t.url,sheet:"Export",headers:!1})}catch(e){await this.sleep(5e3)}}if(Array.isArray(B)&&B.length){for(p=[],m=0,v=(R=B.shift()).length;m<v;m++)c=R[m],p.push(c.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(j in u=["apc_cost","wellcome.apc_paid_actual_currency_excluding_vat","wellcome.apc_paid_gbp_inc_vat_if_charged","wellcome.additional_publication_fees_gbp","wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"],C.log(r.id,r.name,t.name,B.length,"rows"),z=[],B){for(h in F=B[j],J={updated:k,org:r.id,sheets:t.name,paid:!!r.paid||void 0},p)if("pmcid"===(d=p[h].toLowerCase())||"openalex"===d)J[d.toUpperCase()]="pmcid"===d?"PMC"+F[h].toLowerCase().replace("pmc",""):F[h];else try{f=N.call(u,d)>=0?parseFloat(F[h]):"number"==typeof F[h]?F[h]:F[h]?"true"===(q=F[h].trim().toLowerCase())||"yes"===q||"false"!==(T=F[h].trim().toLowerCase())&&"no"!==T&&("grant_id"===d||"ror"===d?F[h].replace(/\//g,",").replace(/ /g,"").split(","):F[h]):void 0,"string"==typeof F[h]&&F[h].includes(";")&&(f=F[h].replace(/; /g,";").replace(/ ;/g,";").trim().split(";")),null!=f&&""!==f&&await this.dot(J,p[h],f)}catch(e){}if((J.DOI||J.doi)&&(J.DOI=await this.report.cleandoi(null!=(M=J.DOI)?M:J.doi)),J.OPENALEX&&!J.DOI&&(O=await this.src.openalex.works('ids.openalex.keyword:"https://openalex.org/'+J.OPENALEX+'"',1))&&(null!=(W=O.ids)?W.doi:void 0)&&(J.DOI=O.ids.doi.split("doi.org/").pop()),delete J.doi,s=J.DOI?J.DOI.replace(/\//g,"_"):null!=(U=J.OPENALEX)?U:J.PMCID){i=1===i||i;try{s=s.toLowerCase()}catch(e){}null==S[s]&&(S[s]=null!=(E=await this.oareport.orgs.supplements(s))?E:{_id:s,supplements:[],first_seen:{}}),!S[s].DOI&&J.DOI&&(S[s].DOI=J.DOI),!S[s].OPENALEX&&J.OPENALEX&&(S[s].OPENALEX=J.OPENALEX),!S[s].PMCID&&J.PMCID&&(S[s].PMCID=J.PMCID),S[s].updated=k,null==(a=S[s].first_seen)[w=r.id]&&(a[w]=l),S[s].supplements.push(J)}(I=parseInt(j))&&I%1e3==0?z.push(C.log(r.id,r.name,t.name,e,"of",x.length,"row",j,"of",B.length,Date.now()-k)):z.push(void 0)}return z}},o=0,c=(h=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")).length;o<c;o++)if(d=h[o],!e||(f=d.id,N.call(e,f)>=0)){for(b in d=await this.report.orgs._format(d,!1),w=[],x=Array.isArray(d.sheets)?d.sheets:"string"==typeof d.sheets?d.sheets.replace(/; /g,";").replace(/ ;/g,";").trim().split(";"):[])(!t||(m=x[b].name,N.call(t,m)>=0))&&(await this.sleep(5e3),w.push(r(b,x[b],d)));await Promise.all(w),!0===i&&(i=1,a.push(d))}for await(j of((O=Object.values(S)).length&&(I+=O.length,await this.oareport.orgs.supplements(O),await this.sleep(5e3),S={},O=[]),C.log("report orgs supplements loaded",I,Date.now()-k),A=0,n=[],v=[],s=async(e,t)=>n.push(await this.oareport.works.process(e,t)),await this.oareport.orgs.supplements._for("updated:>"+(k-10))))A+=1,v.push(s(null!=(y=null!=(g=null!=(_=j.DOI)?_:j.OPENALEX)?g:j.PMCID)?y:j._id,j)),100===v.length&&(await Promise.all(v),v=[],n.length>=1e4&&(C.log("report orgs supplementing",n.length,A,Date.now()-k),await this.oareport.works(n),n=[]));for(v.length&&await Promise.all(v),n.length&&await this.oareport.works(n),C.log("report orgs supplemented",A,Date.now()-k),a&&await this.sleep(5e3),u=0,p=a.length;u<p;u++)d=a[u],await this.oareport.orgs.analysis(d,!1);return C.log("report orgs supplement "+(!1!==i?"and analysis ":"")+"complete",I,A,Date.now()-k),I},t.oareport.orgs.supplement._async=!0,t.oareport.orgs.supplement._log=!1,t.oareport._funder_country=function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j;if(null!=t?t.country_code:void 0)for(s=0,n=(_=null!=(g=e.funder)?g:[]).length;s<n;s++){if((i=_[s]).id){if(t.fundref)for(a=0,l=(v="string"===t.fundref?[t.fundref]:t.fundref).length;a<l;a++)if(y=v[a],i.id.includes(y)){i.country=t.country_code;break}if(!i.country&&t.openalex_funder_id)for(p=0,o=(b="string"===t.openalex_funder_id?[t.openalex_funder_id]:t.openalex_funder_id).length;p<o;p++)if(h=b[p],i.id.includes(h)){i.country=t.country_code;break}}if(!i.country&&i.name){if(((r=i.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(port)||port.includes(r)||(null!=(w=t.aliases)?w:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(r)||(null!=(x=t.acronyms)?x:"").toLowerCase().includes(r))&&(i.country=t.country_code),!i.country&&t.acronyms)for(d=0,u=(O=t.acronyms.split(",")).length;d<u;d++)k=O[d].replace(/[^a-z A-Z]/g,""),N.call(i.name.split(" "),k)>=0&&(i.country=t.country_code);if(!i.country&&t.aliases)for(f=0,c=(j=t.aliases).length;f<c;f++)m=j[f],r.includes(m.toLowerCase().replace(/[^a-z ]/g,""))&&(i.country=t.country_code)}}return e},t.oareport._author_display_name=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g;if(n=e.outreach.email_address.includes("@")?e.outreach.email_address:await this.decrypt(e.outreach.email_address),(null!=(p=e.openalex)?p.authorships:void 0)&&1===e.openalex.authorships.length&&(i=null!=(d=e.openalex.authorships[0].author)?d.display_name:void 0))e.outreach.author_display_name="Dr. "+i;else{for(m=n.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),r="",s="",t="",a=1e6,o=0,u=(h=e.openalex.authorships).length;o<u;o++)(c=null!=(f=(y=h[o]).author)?f.display_name:void 0)&&((g=(await this.levenshtein(m,c.toLowerCase().replace(/[^a-z]/g,""))).distance/c.length)<a&&(a=g,s=c),a>.2&&(m.endsWith(c.split(" ").pop().toLowerCase())||c.split(" ")[0].length>4&&m.includes(c.split(" ")[0].toLowerCase()))&&(a=.1,s=c),!r&&m.startsWith((c.split(" ")[0].slice(0,1)+c.split(" ").pop().slice(0,1)).toLowerCase())&&(r=c),!t&&y.author.is_corresponding&&(t=c));(l=s&&a<.7?s.split(" ").pop():r||t||i)&&(e.outreach.author_display_name="Dr. "+l)}return e},t.oareport.works.process=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe,Te,Me,We,Ue,ze,Fe,Be,Je,Xe,$e,Ve,Ge,Ye,He,Ze,Qe,Ke,et,tt,it,rt,st,at,nt,lt,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Et,Nt,Lt,Pt,Rt,qt,Tt,Mt,Wt,Ut,zt,Ft,Bt,Jt,Xt,$t,Vt,Gt,Yt,Ht,Zt,Qt,Kt,ei,ti,ii,ri,si,ai,ni,li,oi,ui,ci,pi,di,hi,fi;C.log("oareport works processing",e,t,i);try{if(li=await this.epoch(),await this.datetime(li),"oareport.works.process"===this.fn&&(i=this.refresh,e=this.params.process),je={ids:{},is_free_to_read:!1,is_open_access:!1,supplements:[],corresponding_authorships:[],corresponding_author_ids:[],meta:{},outreach:{},data_availability_statement:{}},"string"==typeof e)if((e=e.toLowerCase().split(".org/").pop().replace(/\/$/,"")).startsWith("pmc")){je.PMCID=e.toUpperCase();try{he=await this.src.openalex.works('ids.pmcid:"'+e.replace("pmc","")+'"',1)}catch(e){}}else e.startsWith("10.")&&(je.DOI=e);if(je._id=je.DOI?je.DOI.toLowerCase().replace(/\//g,"_"):(null!=he?he.id:void 0)?he.id.split(".org/").pop().toLowerCase():je.PMCID?je.PMCID.toLowerCase():void 0,!i&&(x=await this.oareport.works(je._id))){if(null!=(Se=je.meta)?Se.replaced:void 0)for(null==(l=x.meta).replaced&&(l.replaced=[]),Ie=je.meta.replaced,A=0,q=Ie.length;A<q;A++)si=Ie[A],N.call(x.meta.replaced,si)<0&&x.meta.replaced.push(si);je=x}if(i||null==je.openalex){null==he&&(he=await this.src.openalex.works(e.startsWith("w")?'id.keyword:"https://openalex.org/'+e+'"':e,e.startsWith("w")?1:void 0));try{null==je.DOI&&(je.DOI=he.ids.doi.split("doi.org/").pop())}catch(e){}try{null==je.PMCID&&(je.PMCID="PMC"+he.ids.pmcid.split("/").pop().toLowerCase().replace("pmc",""))}catch(e){}}if(null!=he?he.id:void 0){for(je.openalex={},P=0,T=(Te=["id","abstract","apc_list","apc_paid","authorships","authors_count","best_oa_location","biblio","cited_by_count","concepts","countries_distinct_count","corresponding_author_ids","created_date","display_name","domains","fields","has_fulltext","ids","is_paratext","is_retracted","keywords","language","mesh","open_access","primary_location","publication_date","publication_year","referenced_works_count","sustainable_development_goals","title","type","type_crossref","updated","updated_date"]).length;P<T;P++)le=Te[P],je.openalex[le]=he[le];for(at=null!=(Ge=he.grants)?Ge:[],ae=0,G=at.length;ae<G;ae++)k=at[ae],null==je.funder&&(je.funder=[]),je.funder.push({award:(null!=(yt=k.award_id)?yt:"").replace(/, /g,",").split(","),display_name:k.funder_display_name,source:"openalex",id:k.funder});for(Mt=null!=(It=he.locations)?It:[],oe=0,H=Mt.length;oe<H;oe++)if((re=Mt[oe]).license&&(se=re.license.toLowerCase())&&("pd"!==se&&"public-domain"!==se&&"cc0"!==se&&"cc-by"!==se||(je.is_open_access=!0)),(null!=(Yt=re.source)?Yt.is_in_doaj:void 0)&&(null==je.syp_permissions&&(je.syp_permissions={}),je.syp_permissions.can_archive=!0,je.syp_permissions.archivable_version=re.version),"journal"===(null!=(ri=re.source)?ri.type:void 0)&&re.license&&(!(null!=(Ae=je.publisher)?Ae.license:void 0)||re.license.length<je.publisher.license)&&"publishedVersion"===re.version)null==je.publisher&&(je.publisher={}),je.publisher.license=re.license,je.publisher.url_for_pdf=re.pdf_url,je.publisher.version=re.version;else if("repository"===(null!=(De=re.source)?De.type:void 0)&&(null==je.repository&&(je.repository={}),re.license&&(!je.repository.license||re.license.length<je.repository.license)&&(je.repository.license=re.license),re.landing_page_url&&re.landing_page_url.toLowerCase().includes("pmc")&&(je.PMCID||(_e=re.landing_page_url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(_e))&&(je.PMCID="PMC"+_e),re.license&&!(null!=(Ce=je.epmc)?Ce.license:void 0)&&(null==je.epmc&&(je.epmc={}),je.epmc.license=re.license)),!je.repository.url||!je.repository.url.includes("pmc")||!je.repository.url.includes("ncbi.")&&re.landing_page_url&&re.landing_page_url.includes("ncbi.")))for(fe=0,Z=(Ee=["license","pdf_url","landing_page_url","version"]).length;fe<Z;fe++)re[de=Ee[fe]]&&(je.repository[de]=re[de]);for((null!=(Ne=je.repository)?Ne.url:void 0)&&(je.repository.url.toLowerCase().includes("europepmc.")||je.repository.url.toLowerCase().includes("ncbi."))&&(null==je.PMCID&&(je.PMCID="PMC"+je.repository.url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),je.repository.url_in_pmc=!0),(null!=(Le=he.ids)?Le.pmid:void 0)&&(je.PMID=he.ids.pmid.split("/").pop()),(null!=(Pe=he.open_access)?Pe.is_oa:void 0)&&(je.is_free_to_read=!0),qe=null!=(Re=je.openalex.concepts)?Re:[],ui=0,Q=qe.length;ui<Q;ui++){delete(p=qe[ui]).wikidata;try{p.score=Math.floor(100*p.score)}catch(e){}}for(We=null!=(Me=he.corresponding_author_ids)?Me:[],ci=0,K=We.length;ci<K;ci++)d=We[ci],N.call(je.corresponding_author_ids,d)<0&&je.corresponding_author_ids.push(d);for(ze=null!=(Ue=je.openalex.authorships)?Ue:[],di=0,ee=ze.length;di<ee;di++){for(Be=null!=(Fe=(r=ze[di]).institutions)?Fe:[],hi=0,te=Be.length;hi<te;hi++)delete Be[hi].type;(null!=(Je=r.author)?Je.orcid:void 0)&&r.author.orcid.includes("orcid.org/")&&(r.author.orcid_number=r.author.orcid.split("/").pop()),Xe=null!=($e=r.author)?$e.id:void 0,N.call(je.corresponding_author_ids,Xe)>=0&&je.corresponding_authorships.push(r)}}try{for(null==t&&(t=await this.oareport.orgs.supplements(je._id)),je.supplements=t.supplements,je.meta.first_seen=t.first_seen,Ve=je.supplements,fi=0,ie=Ve.length;fi<ie;fi++){(ni=Ve[fi]).paid&&(je.meta.is_updated||(i=!0),je.meta.is_updated=!0),delete ni.paid,ni.email&&!je.outreach.email_address&&(je.outreach.email_address=ni.email),"string"==typeof ni.email&&ni.email.includes("@")&&(ni.email=await this.encrypt(ni.email)),ni.author_email_name_ic&&!je.outreach.author_display_name&&(je.outreach.author_display_name=ni.author_email_name_ic);try{for(He="string"==typeof ni.corresponding_author_ids?ni.corresponding_author_ids.split(","):null!=(Ye=ni.corresponding_author_ids)?Ye:[],j=0,M=He.length;j<M;j++)d=He[j],N.call(je.corresponding_author_ids,d)<0&&je.corresponding_author_ids.push(d)}catch(e){}for(!ni.publisher_license_ic||"cc-by"!==(Ze=ni.publisher_license_ic)&&"cc0"!==Ze||(je.is_open_access=!0),(!0===ni.is_free_ic||je.is_open_access)&&(je.is_free_to_read=!0),D=0,W=(Qe=["mturk_has_data_availability_statement","has_data_availability_statement_ic","has_data_availability_statement","data_availability_statement","data_availability_statement_ic"]).length;D<W;D++)null==ni[oi=Qe[D]]||je.data_availability_statement.has_data_availability_statement||(je.data_availability_statement.has_data_availability_statement=!!ni[oi],je.data_availability_statement.source="oareport");for(L=0,U=(Ke=["category","accession_number","doi","url"]).length;L<U;L++)null!=ni["data_availability_statement_"+(f=Ke[L])]&&(je.data_availability_statement[f]=ni["data_availability_statement_"+("doi"===f||"url"===f?"resource_":"")+f]);for(E in ni)null!=je[E]&&"object"!=typeof je[E]&&"DOI"!==E&&"corresponding_author_ids"!==E&&"paid"!==E&&"is_updated"!==E&&"email"!==E&&(je[E]="NULL"===ni[E]?void 0:ni[E])}}catch(e){}try{"not data availability statement"===je.data_availability_statement.category.toLowerCase()&&(je.data_availability_statement.has_data_availability_statement=!1)}catch(e){}try{(null!=(et=je.openalex)?et.authorships:void 0)&&je.outreach.email_address&&!je.outreach.author_display_name&&(je=await this.oareport._author_display_name(je))}catch(e){}if(("Public Library of Science"===(null!=(tt=je.openalex)&&null!=(it=tt.primary_location)&&null!=(rt=it.source)?rt.publisher:void 0)||je.DOI&&(je.DOI.startsWith("10.1186")||je.DOI.startsWith("10.12688/gatesopenres")))&&(je.data_availability_statement.has_data_availability_statement=!0,je.data_availability_statement.source="openalex"),je.meta.is_updated){if(I=[],je.DOI&&(null==he||!he.grants||i&&!je.meta.checked_crossref&&(!(null!=(st=je.crossref)?st.subtype:void 0)||!je.acceptance_date||!je.submission_date))&&(h=await this.src.crossref.works(je.DOI))){if(h.ISSN&&(I=h.ISSN),h.is_oa&&(je.is_free_to_read=!0),"preprint"===h.subtype&&(null==je.crossref&&(je.crossref={}),je.crossref.subtype="preprint"),je.meta.checked_crossref=li,!je.submission_date||!je.acceptance_date)for(lt=null!=(nt=h.assertion)?nt:[],R=0,z=lt.length;R<z;R++)((n=(null!=(ot=(a=lt[R]).label)?ot:"").toLowerCase()).includes("accepted")&&n.split(" ").length<3||n.includes("received"))&&(null!=(s=await this.dateparts(a.value))?s.date:void 0)&&s.timestamp&&null==je[ce=(n.includes("received")?"submission":"acceptance")+"_date"]&&(je[ce]=s.date);if(null!=he&&!he.grants)for(ct=null!=(ut=h.funder)?ut:[],ne=0,F=ct.length;ne<F;ne++)O=ct[ne],null==je.funder&&(je.funder=[]),je.funder.push({award:O.award,display_name:O.name,source:"crossref",id:O.DOI})}if((null!=(pt=je.openalex)&&null!=(dt=pt.primary_location)&&null!=(ht=dt.source)?ht.publisher:void 0)&&!je.publisher_simple){if(!b.length)for(mt=null!=(ft=await this.report.publishers("*",1e4))?ft:[],ue=0,B=mt.length;ue<B;ue++)si=mt[ue],b.push(null!=(gt=si._source)?gt:si);for(we=je.openalex.primary_location.source.publisher.toLowerCase(),pe=0,J=b.length;pe<J;pe++)if((be=b[pe]).publisher&&we.includes(be.publisher.toLowerCase())){je.publisher_simple=be.publisher_display_name;break}}if((je.DOI||je.PMID||(null!=(_t=je.ids)?_t.pmid:void 0))&&(!je.PMCID&&!(null!=(vt=je.ids)?vt.pmcid:void 0)||!je.PMID&&!(null!=(bt=je.ids)?bt.pmid:void 0)||null==(null!=(wt=je.pubmed)?wt.pubtype:void 0)||!je.submission_date||!je.acceptance_date)&&(xe=je.PMID||je.ids.pmid?await this.src.pubmed(null!=(xt=je.PMID)?xt:je.ids.pmid):await this.src.pubmed.doi(je.DOI))){for(kt=null!=(Ot=xe.ISSN)?Ot:[],me=0,X=kt.length;me<X;me++)ge=kt[me],N.call(I,ge)<0&&I.push(ge);!je.PMCID&&(null!=xe&&null!=(jt=xe.identifier)?jt.pmc:void 0)&&(je.PMCID="PMC"+xe.identifier.pmc.toLowerCase().replace("pmc","")),!je.PMID&&(null!=xe&&null!=(St=xe.identifier)?St.pubmed:void 0)&&(je.PMID=xe.identifier.pubmed),null==je.pubmed&&(je.pubmed={}),je.pubmed.pubtype=xe.type,null==je.submission_date&&(je.submission_date=null!=(At=xe.dates)&&null!=(Dt=At.PubMedPubDate_received)?Dt.date:void 0),null==je.acceptance_date&&(je.acceptance_date=null!=(Ct=xe.dates)&&null!=(Et=Ct.PubMedPubDate_accepted)?Et.date:void 0)}if((je.PMCID||je.ids.pmcid)&&(i||!je.meta.checked_epmc_license)&&(je.meta.checked_epmc_license=li,v=await this.src.epmc.pmc(null!=(Nt=je.PMCID)?Nt:je.ids.pmcid))){for((null!=(Lt=v.journalInfo)&&null!=(Pt=Lt.journal)?Pt.issn:void 0)&&(Rt=v.journalInfo.journal.issn,N.call(I,Rt)<0)&&I.push(v.journalInfo.journal.issn),(null!=(qt=v.journalInfo)&&null!=(Tt=qt.journal)?Tt.essn:void 0)&&(Wt=v.journalInfo.journal.essn,N.call(I,Wt)<0)&&I.push(v.journalInfo.journal.essn),null==je.PMCID&&(je.PMCID=v.pmcid),null==je.pubmed&&(je.pubmed={}),null==(o=je.pubmed).pubtype&&(o.pubtype=[]),Ft=null!=(Ut=null!=(zt=v.pubTypeList)?zt.pubType:void 0)?Ut:[],Oe=0,$=Ft.length;Oe<$;Oe++)ve=Ft[Oe],N.call(je.pubmed.pubtype,ve)<0&&je.pubmed.pubtype.push(ve);if(null==je.epmc&&(je.epmc={}),je.epmc.license=null!=(Bt=await this.src.epmc.licence(null!=(Jt=je.PMCID)?Jt:je.ids.pmcid,v))?Bt.licence:void 0,(null!=(Xt=je.data_availability_statement)?Xt.has_data_availability_statement:void 0)||(await this.src.pubmed.availability(null!=($t=je.PMCID)?$t:je.ids.pmcid)?(je.data_availability_statement.has_data_availability_statement=!0,je.data_availability_statement.source="pubmed"):(je.data_availability_statement.has_data_availability_statement=!1,je.data_availability_statement.source="pubmed")),!(null!=(Vt=je.data_availability_statement)?Vt.has_data_availability_statement:void 0))if(g=await this.src.epmc.statement(null!=(Gt=je.PMCID)?Gt:je.ids.pmcid,v)){if(je.data_availability_statement.has_data_availability_statement=!0,je.data_availability_statement.source="epmc",je.data_availability_statement.full_text=g,pi=await this.src.epmc.statement.url(null!=(Ht=je.PMCID)?Ht:je.ids.pmcid,v,g))for(ke=0,V=pi.length;ke<V;ke++)(m=pi[ke])&&m.includes("doi.org/")?(y=m.split("doi.org/")[1].toLowerCase(),null==(u=je.data_availability_statement).resource_doi&&(u.resource_doi=[]),N.call(je.data_availability_statement.resource_doi,y)<0&&je.data_availability_statement.resource_doi.push(y)):(null==(c=je.data_availability_statement).resource_url&&(c.resource_url=[]),N.call(je.data_availability_statement.resource_url,m)<0&&je.data_availability_statement.resource_url.push(m))}else je.data_availability_statement.has_data_availability_statement=!1,je.data_availability_statement.source="epmc";null==je.submission_date&&(je.submission_date=await this.src.epmc.submitted(null!=(Zt=je.PMCID)?Zt:je.ids.pmcid,v))}je.DOI&&(null==je.syp_permissions&&(je.syp_permissions={}),(ye=await this.permissions_new({doi:je.DOI},void 0,he))&&null!=ye.best_permission&&(je.syp_permissions.can_archive&&!ye.best_permission.can_archive||(je.syp_permissions.can_archive=ye.best_permission.can_archive,ye.best_permission.version&&(je.syp_permissions.archivable_version=ye.best_permission.version))),(I||null!=he||null!=h)&&(je.syp_permissions.journal_oa_type=null!=(Qt=await this.permissions_new.journals.oa.type(I,void 0,he,h))?Qt:"unsuccessful","gold"!==(Kt=je.syp_permissions.journal_oa_type)&&"diamond"!==Kt||(je.is_open_access=!0)))}for("string"==typeof je.outreach.email_address&&je.outreach.email_address.includes("@")&&(je.outreach.email_address=await this.encrypt(je.outreach.email_address)),je.is_open_access||!(null!=(ei=je.epmc)?ei.license:void 0)||!(_=je.epmc.license.toLowerCase())||"pd"!==_&&"public-domain"!==_&&"cc0"!==_&&"cc-by"!==_||(je.is_open_access=!0),je.meta.updated=await this.epoch(),je.meta.updated_date=await this.date(je.meta.updated),je.meta.took=je.meta.updated-li,ai=0,Y=(ti=["DOI","PMCID","PMID"]).length;ai<Y;ai++)je[S=ti[ai]]&&(je.ids[S.toLowerCase()]=je[S]),"DOI"!==S&&delete je[S];try{je.ids.openalex=je.openalex.id.split("/").pop()}catch(e){}return!1!==this.params.save&&je._id&&je._id===(null!=(ii=this.params.process)?ii:"").toLowerCase().replace(/\//g,"_")&&this.oareport.works(je),je}catch(t){w=t,C.log("report works process error",w);try{C.log(e)}catch(e){}}},t.oareport.works.process._log=!1,t.oareport.works.load=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j;if(O=await this.epoch(),r=null!=(c=this.params.load)?c:(await this.date()).split("-")[0],i=null!=(p=null!=(g=this.params.org)?g:this.params.orgs)?p:"orgs"===this.params.load,null==e&&(e=[]),"string"==typeof e&&(e=e.split(",")),this.params.q)for await(k of(C.log("report works load for query",this.params.q),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"oareport_works",this.params.q,{scroll:"5m",include:["ids"]})))e.push(null!=(_=null!=(v=null!=(b=k.ids)?b.doi:void 0)?v:null!=(w=k.ids)?w.openalex:void 0)?_:null!=(x=k.ids)?x.pmcid:void 0);else if(!e.length){if(s=async(i,s)=>{var a,n,l,o,u;for await(l of(null==i&&(i=(s?"(funder.name:* OR author.affiliation.name:*) AND year.keyword:":"authorships.institutions.display_name:* AND publication_year:")+r),t&&(i="("+i+") AND "+(s?"srcday":"updated_date")+":>"+t),n=await this.src[s?"crossref":"openalex"].works.count(i),C.log("report works load "+(s?"crossref":"openalex")+" by query expects",i,n),u=[],this.index._for(s?"src_crossref_works":"src_openalex_works",i,{include:s?["DOI"]:["id","ids"],scroll:"10m"})))(a=l.DOI?l.DOI:(null!=(o=l.ids)?o.doi:void 0)?"10."+l.ids.doi.split("/10.")[1]:l.id.split("openalex.org/").pop())&&(t||N.call(e,a)<0)?u.push(e.push(a)):u.push(void 0);return u},i||r!==this.params.load)for await(o of(C.log("report works load for org",i||"all","by source.openalex or source.crossref query presence"),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"oareport_orgs","string"==typeof i?'name.keyword:"'+i+'"':"*",{scroll:"10m"})))(null!=(d=o.source)?d.openalex:void 0)&&await s(decodeURIComponent(decodeURIComponent(o.source.openalex))),(null!=(h=o.source)?h.crossref:void 0)&&await s(decodeURIComponent(decodeURIComponent(o.source.crossref)),!0);else C.log("report works load for year",r),await Promise.all([s(),s(void 0,!0)]);if(t)for await(u of(C.log("report works load for updated before",t,await this.date(t)),await this.oareport.works._for("(DOI:* OR ids.doi:*) AND meta.is_updated:true AND updated:<"+t,{include:["DOI","ids"],scroll:"10m"})))(j=null!=(f=null!=(m=null!=(y=u.DOI)?y:ids.doi)?m:ids.openalex)?f:ids.pmcid)&&N.call(e,j)<0&&e.push(j)}for(n=0,l=e.length;n<l;n++)a=e[n],await this.sleep(10),this.oareport.works.process(a);return C.log("Report works load",e.length,await this.epoch()-O),e.length},t.oareport.works.load._log=!1,t.oareport.works.load._bg=!0,t.oareport.works.load._async=!0,t.oareport.works.load._auth="@oa.works",t.oareport.review=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b;for(null==e&&(e=null!=(d=null!=(h=this.params.review)?h:this.params.org)?d:"Bill & Melinda Gates Foundation"),null==t&&(t=null!=(f=this.params.from)?f:"2023-12-31"),null==i&&(i=null!=(m=this.params.to)?m:"2024-06-07"),o="(openalex.publication_date:>"+t+" AND openalex.publication_date:<"+i+")",u="",g="(published_date:>"+t+" AND published_date:<"+i+")",_="",v={org:e,from:t,to:i,counts:{},terms:{},is_oa:{oareport:{},report:{}},queries:{},missing:{}},r=async r=>{var s,a,n,l,c,p,d,h,f,m;for await(d of(c="",this.index._for("paradigm_"+(this.S.dev?"b_":"")+r+"_orgs",'name.keyword:"'+e+'"',{scroll:"10m"})))for(s in null!=(m=d.analysis)?m:{})d.analysis[s].query&&(h=decodeURIComponent(d.analysis[s].query),u||"oareport"!==r||(u=h),_||"report"!==r||(_=h),t&&i&&(h=("oareport"===r?o:g)+" AND "+h),c||"is_paper"!==s||(c=h),null==(a=v.queries)[s]&&(a[s]={}),v.queries[s][r]=h,null==(n=v.counts)[s]&&(n[s]={}),v.counts[s][r]=await this.index.count("paradigm_"+(this.S.dev?"b_":"")+r+"_works",h));if(c){for await(f of this.index._for("paradigm_"+(this.S.dev?"b_":"")+r+"_works",c,{scroll:"10m",include:["DOI"]}))await this["oareport"===r?"report":"oareport"].works(f.DOI)||(null==(l=v.missing)[p="in_"+r+"_not_in_"+("oareport"===r?"report":"oareport")]&&(l[p]=[]),v.missing["in_"+r+"_not_in_"+("oareport"===r?"report":"oareport")].push(f.DOI));return v.missing["not_in_"+("oareport"===r?"report":"oareport")+"_count"]=v.missing["in_"+r+"_not_in_"+("oareport"===r?"report":"oareport")].length}},a=0,n=(y=["oareport","report"]).length;a<n;a++)s=y[a],await r(s);for await(p of(c=decodeURIComponent("(openalex.publication_date:%3E2023-12-31%20AND%20openalex.publication_date:%3C2024-06-07)%20AND%20((openalex.primary_location.source.display_name:%22gates%20open%20research%22%20OR%20supplements.sheets:*pub__bmgf%20OR%20supplements.sheets:(%22grantid_cw__bmgf%22%20OR%20%22pmc__bmgf%22%20OR%20%22all-time__bmgf%22%20OR%20%22name_epmc__bmgf%22%20OR%20%22staff__bmgf%22%20OR%20%22chronos_v2__bmgf%22%20OR%20%22finance__bmgf%22%20OR%20%22users__bmgf%22%20OR%20%22preprints_oa_locations__bmgf%22%20OR%20%22preprints-enrichment__bmgf%22)%20OR%20(funder.id:(%2210.13039/100000865%22%20OR%20%2210.13039/501100005370%22)%20OR%20funder.name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20openalex.grants.funder:(%22F4320306137%22%20OR%20%22F4320323264%22))%20OR%20(openalex.authorships.institutions.ror:(%220456r8d26%22%20OR%20%22033sn5p83%22)%20OR%20openalex.authorships.institutions.display_name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20openalex.authorships.raw_affiliation_string:(%22Bill%20&%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22))%20OR%20supplements.funder.display_name_ic:%22bill-and-melinda-gates-foundation%22)%20AND%20NOT%20(supplements.removed_from_report:%22bill-and-melinda-gates-foundation%22%20OR%20supplements.is_financial_disclosure:%22bill-and-melinda-gates-foundation%22))%20AND%20openalex.type:(%22article%22%20OR%20%22editorial%22%20OR%20%22letter%22%20OR%20%22review%22)%20AND%20NOT%20openalex.type_crossref:%22proceedings-article%22%20AND%20NOT%20(supplements.is_preprint:true%20OR%20(pubtype:preprint%20AND%20NOT%20supplements.is_preprint:false)%20OR%20subtype:preprint)%20AND%20openalex.id:*%20AND%20openalex.primary_location.source.display_name:*"),b=decodeURIComponent("(published_date:%3E2023-12-31%20AND%20published_date:%3C2024-06-07)%20AND%20((journal:%22gates%20open%20research%22%20OR%20supplements.sheets:*pub__bmgf%20OR%20supplements.sheets:(%22grantid_cw__bmgf%22%20OR%20%22pmc__bmgf%22%20OR%20%22all-time__bmgf%22%20OR%20%22name_epmc__bmgf%22%20OR%20%22staff__bmgf%22%20OR%20%22chronos_v2__bmgf%22%20OR%20%22finance__bmgf%22%20OR%20%22users__bmgf%22%20OR%20%22preprints_oa_locations__bmgf%22%20OR%20%22preprints-enrichment__bmgf%22)%20OR%20(funder.DOI:(%2210.13039/100000865%22%20OR%20%2210.13039/501100005370%22)%20OR%20funder.name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20openalx.grants.funder:(%22F4320306137%22%20OR%20%22F4320323264%22))%20OR%20(authorships.institutions.ror:(%220456r8d26%22%20OR%20%22033sn5p83%22)%20OR%20authorships.institutions.display_name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20authorships.raw_affiliation_string:(%22Bill%20&%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22))%20OR%20supplements.funder.display_name_ic:%22bill-and-melinda-gates-foundation%22)%20AND%20NOT%20(supplements.removed_from_report:%22bill-and-melinda-gates-foundation%22%20OR%20supplements.is_financial_disclosure:%22bill-and-melinda-gates-foundation%22))%20AND%20type:(%22article%22%20OR%20%22editorial%22%20OR%20%22letter%22%20OR%20%22review%22)%20AND%20NOT%20openalx.type_crossref:%22proceedings-article%22%20AND%20NOT%20(supplements.is_preprint:true%20OR%20(pubtype:preprint%20AND%20NOT%20supplements.is_preprint:false)%20OR%20subtype:preprint)%20AND%20openalex:*%20AND%20journal:*"),v.terms.oareport=await this.oareport.works.terms("syp_permissions.journal_oa_type.keyword",c),v.terms.report=await this.report.works.terms("journal_oa_type.keyword",b),l='(epmc_licence.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR syp_permissions.journal_oa_type.keyword:("gold" OR "diamond") OR openalex.locations.license.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR supplements.publisher_license_ic.keyword:("cc0" OR "cc-by"))',v.is_oa.oareport.is_oa_derived=await this.oareport.works.count(c+" AND "+l),v.is_oa.oareport.is_oa_but_not_by_derived_dois=[],await this.oareport.works._for(c+" AND is_open_access:true AND NOT "+l,{scroll:"10m",include:["DOI"]})))v.is_oa.oareport.is_oa_but_not_by_derived_dois.push(p.DOI);return v.is_oa.oareport.is_oa_but_not_by_derived=v.is_oa.oareport.is_oa_but_not_by_derived_dois.length,v.is_oa.report.is_oa_derived_from_oareport=await this.report.works.count(b+' AND (epmc_licence.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR journal_oa_type.keyword:("gold" OR "diamond") OR openalx.locations.license.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR supplements.publisher_license_ic.keyword:("cc0" OR "cc-by"))'),v.oareport_has_checked_das=await this.oareport.works.count(c+' AND (data_availability_statement.has_data_availability_statement:true OR openalex.primary_location.source.publisher:"Public Library of Science" OR DOI:"10.1186*" OR DOI:"10.12688/gatesopenres*")'),v},N=[].indexOf,t.oareport2=function(){return"OA.Works OA.report"},t.oareport2.works={_index:!0},t.oareport2.orgs={_sheet:"1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data",_format:async function(e=[]){var t,i,r,s,a,n,l,o,u,c,p,d;for(o=[],r=0,a=(c="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<a;r++){for(i in l={},u=c[r]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(e){t=e,C.log("cant parse "+i,u[i],t)}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(l,i,u[i])}catch(e){}else l[i]=u[i]}if(Array.isArray(l.sheets))for(s=0,n=(p=l.sheets).length;s<n;s++)(d=p[s]).url=await this.encrypt(d.url);else delete l.sheets;try{"string"==typeof l.id&&l.id.length&&(l._id=l.id)}catch(e){}"{}"!==JSON.stringify(l)&&o.push(l)}return 1===o.length?o[0]:o}},new Map,t.oareport2.duplicates=async function(e,t,i){var r,s,a,n,l,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X;if(null==i&&(i=Date.now()),null==e&&(e=null!=(S=this.params.duplicates)?S:this.params.doi),e=e.toLowerCase(),a=o.get(e))(t=a).memory=!0;else{for(u=["DOI","update-to.DOI"],l=0,p=(z=["is-same-as","is-version-of","has-version"]).length;l<p;l++)k=z[l],u.push("relation."+k+".id");for(O=u.join(':"'+e+'" OR ')+':"'+e+'"',null==t&&(t={original:e,doi:e,duplicates:[],count:0,cascades:0,timestamp:void 0,record:void 0,recs:{}}),U=[],n=!0,c=0,d=(B=null!=(I=null!=(F=await this.src.crossref.works(O,{size:1e4,sort:{"indexed.timestamp":"asc"}}))&&null!=(E=F.hits)?E.hits:void 0)?I:[]).length;c<d;c++){if((X=B[c]._source).DOI=X.DOI.toLowerCase(),t.recs[X.DOI]=X,null!=X["update-to"]){for(L=X.DOI,N.call(t.duplicates,L)<0&&t.duplicates.push(X.DOI),g=0,h=(P=X["update-to"]).length;g<h;g++)(J=P[g]).DOI&&(J.DOI=J.DOI.toLowerCase(),R=J.DOI,N.call(t.duplicates,R)<0&&t.duplicates.push(J.DOI),(j=t.duplicates.length)&&j>1&&t.duplicates[j-1].substring(0,t.duplicates[j-1].length-3)!==t.duplicates[j-2].substring(0,t.duplicates[j-2].length-3)&&(n=!1));t.timestamp=X.indexed.timestamp,t.doi=X.DOI}t.duplicates.length&&n&&(t.doi=t.duplicates.sort()[t.duplicates.length-1]),null!=X.relation&&"preprint"!==X.subtype&&U.push(X)}if(t.doi&&t.doi!==e&&null==t.recs[t.doi])return C.log("oareport duplicates looping",e,t.doi,t.original,t.cascades),t.cascades+=1,this.oareport.duplicates(t.doi,t,i);for(_=0,f=U.length;_<f;_++)for(X=U[_],b=0,m=z.length;b<m;b++)for(x=z[b],w=0,y=(M=null!=(q=null!=(T=X.relation)?T[x]:void 0)?q:[]).length;w<y;w++)s=M[w],W=X.DOI,N.call(t.duplicates,W)<0&&t.duplicates.push(X.DOI),t.recs[X.DOI]=X,"string"==typeof(null!=s?s.id:void 0)&&s.id.startsWith("10.")&&(s.id=s.id.toLowerCase(),A=s.id,N.call(t.duplicates,A)<0&&(t.duplicates.push(s.id),s.id.includes(t.doi)?(t.doi=s.id,null!=t.recs[t.doi]&&(t.timestamp=t.recs[t.doi].indexed.timestamp)):t.doi.substring(0,t.doi.length-3)===s.id.substring(0,s.id.length-3)&&(v=[t.doi,s.id].sort()[1])&&v!==t.doi?(t.doi=v,null!=t.recs[t.doi]&&(t.timestamp=t.recs[t.doi].indexed.timestamp)):s.id!==e&&(r=await this.src.crossref.works(s.id))&&(r.DOI=r.DOI.toLowerCase(),t.recs[s.id]=r,r.indexed.timestamp>X.indexed.timestamp&&r.indexed.timestamp>(null!=(D=t.timestamp)?D:0)&&(t.timestamp=r.indexed.timestamp,t.doi=s.id))));null==t.record&&(t.record=t.recs[t.doi]),t.count+=Object.keys(t.recs).length,delete t.recs}return t.memory||o.set(t.original,{doi:t.doi}),t.took=Date.now()-i,t},t.oareport2.orgs.analysis=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z;for("string"==typeof e?(I=e,e=[]):"object"==typeof e&&(e=[e]),null!=e&&0!==e.length||(null==I&&(I=this.params.org),e=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")),o={},"string"==typeof I&&(I=I.split(",")),u=0,p=e.length;u<p;u++)if(S=e[u],!I||(q=S.id,N.call(I,q)>=0)){for(i in!1!==t&&(S=await this.report.orgs._format(S,!1)),null!=(T=S.analysis)?T:{})if(S.analysis[i].query&&!1!==(X=S.analysis[i].make_key)&&"false"!==X&&"False"!==X&&"FALSE"!==X)for await(P of(C.log("report orgs anaysing by query",S.id,S.name,i),await this.oareport.works._for(decodeURIComponent(S.analysis[i].query)))){if(null==o[b=P.DOI]&&(o[b]=P),null==(r=o[P.DOI]).meta&&(r.meta={}),null==(s=o[P.DOI].meta).query_matches&&(s.query_matches=[]),k=S.id+"/"+i,N.call(o[P.DOI].meta.query_matches,k)<0&&o[P.DOI].meta.query_matches.push(k),w=null!=($=null!=(V=S.analysis[i].key)?V:S.analysis[i].name)?$:i,x=null==(G=S.analysis[i].value)||G,S.analysis[i].list){for(null==(l=await this.dot(o[P.DOI],w))&&(l=[]),Array.isArray(l)||(l=[l]),Array.isArray(x)||(x=[x]),c=0,d=x.length;c<d;c++)Z=x[c],l.push(Z);x=l}await this.dot(o[P.DOI],w,x)}if(S.country_code&&S.paid)for await(P of await this.oareport.works._for('DOI:* AND supplements.org.keyword:"'+S.id+'" AND NOT funder.country.keyword:"'+S.country_code+'"')){for(_=0,h=(H=null!=(Y=P.funder)?Y:[]).length;_<h;_++){for(a=H[_],v=0,f=(M="string"===S.fundref?[S.fundref]:Array.isArray(S.fundref)?S.fundref:[]).length;v<f;v++)if(E=M[v],a.id&&a.id.includes(E)){a.country=S.country_code;break}if(!a.country&&S.openalex_funder_id)for(O=0,m=(W="string"===S.openalex_funder_id?[S.openalex_funder_id]:S.openalex_funder_id).length;O<m;O++)if(j=W[O],a.id&&a.id.includes(j)){a.country=S.country_code;break}if(!a.country&&a.name){if(((n=a.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(port)||port.includes(n)||(null!=(U=S.aliases)?U:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(n)||(null!=(z=S.acronyms)?z:"").toLowerCase().includes(n))&&(a.country=S.country_code),!a.country&&S.acronyms)for(A=0,y=(F=S.acronyms.split(",")).length;A<y;A++)B=F[A].replace(/[^a-z A-Z]/g,""),N.call(a.name.split(" "),B)>=0&&(a.country=S.country_code);if(!a.country&&S.aliases)for(L=0,g=(J=S.aliases).length;L<g;L++)D=J[L],n.includes(D.toLowerCase().replace(/[^a-z ]/g,""))&&(a.country=S.country_code)}}o[P.DOI]=P}}return(R=Object.values(o))&&R.length&&await this.oareport.works(R),R.length},t.oareport2.orgs.supplements={_index:!0,_auth:"@oa.works"},t.oareport2.orgs.supplement=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A;for(this.params.empty&&await this.oareport.works(""),this.params.empty&&await this.oareport.orgs.supplements(""),k=await this.epoch(),l=await this.datetime(k),null==e&&(e=this.params.org),"string"==typeof e&&(e=e.split(",")),null==t&&(t=this.params.sheet),"string"==typeof t&&(t=t.split(",")),null==i&&(i=this.params.analysis),a=[],S={},I=0,r=async(e,t,r)=>{var s,a,n,o,u,c,p,d,h,f,m,y,g,_,v,b,w,O,j,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$;if(C.log(r.id,r.name,t.name,e,"of",x.length,t.url),!1!==i&&(i=1),$=null==(A=null!=(D=this.params.update)?D:this.params.empty)||A,y=!1,null==this.params.update&&!this.params.empty)try{for(n=!1,o=0;!1===n&&o<5;){o++;try{n=await this.src.google.sheets({sheetid:t.url,sheet:"m_admin",headers:!1})}catch(e){await this.sleep(5e3)}}if("last updated"===n[0][0].toLowerCase()&&(y=n[0][1])&&([_,b]=y.split(" "),y=await this.epoch(_.split("/").reverse().join("-")+"T"+b)),"number"==typeof y&&y>15778368e5){try{g=await this.oareport.works('supplements.sheets.keyword:"'+t.name+'"',{size:1,sort:{"supplements.updated":"desc"}})}catch(e){}null!=(null!=g&&null!=(L=g.hits)?L.hits:void 0)&&(g=g.hits.hits[0]._source),(null!=g&&null!=(P=g.meta)?P.updated:void 0)&&y<=g.meta.updated&&($=y)}}catch(e){$=!1}if(!0!==$)return C.log(r.id,r.name,t.name,"NOT loading because",y,"is not after",$);for(B=!1,X=0;!Array.isArray(B)&&X<5;){X++;try{B=await this.src.google.sheets({sheetid:t.url,sheet:"Export",headers:!1})}catch(e){await this.sleep(5e3)}}if(Array.isArray(B)&&B.length){for(p=[],m=0,v=(R=B.shift()).length;m<v;m++)c=R[m],p.push(c.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(j in u=["apc_cost","wellcome.apc_paid_actual_currency_excluding_vat","wellcome.apc_paid_gbp_inc_vat_if_charged","wellcome.additional_publication_fees_gbp","wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"],C.log(r.id,r.name,t.name,B.length,"rows"),z=[],B){for(h in F=B[j],J={updated:k,org:r.id,sheets:t.name,paid:!!r.paid||void 0},p)if("pmcid"===(d=p[h].toLowerCase())||"openalex"===d)J[d.toUpperCase()]="pmcid"===d?"PMC"+F[h].toLowerCase().replace("pmc",""):F[h];else try{f=N.call(u,d)>=0?parseFloat(F[h]):"number"==typeof F[h]?F[h]:F[h]?"true"===(q=F[h].trim().toLowerCase())||"yes"===q||"false"!==(T=F[h].trim().toLowerCase())&&"no"!==T&&("grant_id"===d||"ror"===d?F[h].replace(/\//g,",").replace(/ /g,"").split(","):F[h]):void 0,"string"==typeof F[h]&&F[h].includes(";")&&(f=F[h].replace(/; /g,";").replace(/ ;/g,";").trim().split(";")),null!=f&&""!==f&&await this.dot(J,p[h],f)}catch(e){}if((J.DOI||J.doi)&&(J.DOI=await this.report.cleandoi(null!=(M=J.DOI)?M:J.doi)),J.OPENALEX&&!J.DOI&&(O=await this.src.openalex.works('ids.openalex.keyword:"https://openalex.org/'+J.OPENALEX+'"',1))&&(null!=(W=O.ids)?W.doi:void 0)&&(J.DOI=O.ids.doi.split("doi.org/").pop()),delete J.doi,s=J.DOI?J.DOI.replace(/\//g,"_"):null!=(U=J.OPENALEX)?U:J.PMCID){i=1===i||i;try{s=s.toLowerCase()}catch(e){}null==S[s]&&(S[s]=null!=(E=await this.oareport.orgs.supplements(s))?E:{_id:s,supplements:[],first_seen:{}}),!S[s].DOI&&J.DOI&&(S[s].DOI=J.DOI),!S[s].OPENALEX&&J.OPENALEX&&(S[s].OPENALEX=J.OPENALEX),!S[s].PMCID&&J.PMCID&&(S[s].PMCID=J.PMCID),S[s].updated=k,null==(a=S[s].first_seen)[w=r.id]&&(a[w]=l),S[s].supplements.push(J)}(I=parseInt(j))&&I%1e3==0?z.push(C.log(r.id,r.name,t.name,e,"of",x.length,"row",j,"of",B.length,Date.now()-k)):z.push(void 0)}return z}},o=0,c=(h=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")).length;o<c;o++)if(d=h[o],!e||(f=d.id,N.call(e,f)>=0)){for(b in d=await this.report.orgs._format(d,!1),w=[],x=Array.isArray(d.sheets)?d.sheets:"string"==typeof d.sheets?d.sheets.replace(/; /g,";").replace(/ ;/g,";").trim().split(";"):[])(!t||(m=x[b].name,N.call(t,m)>=0))&&(await this.sleep(5e3),w.push(r(b,x[b],d)));await Promise.all(w),!0===i&&(i=1,a.push(d))}for await(j of((O=Object.values(S)).length&&(I+=O.length,await this.oareport.orgs.supplements(O),await this.sleep(5e3),S={},O=[]),C.log("report orgs supplements loaded",I,Date.now()-k),A=0,n=[],v=[],s=async(e,t)=>n.push(await this.oareport.works.process(e,t)),await this.oareport.orgs.supplements._for("updated:>"+(k-10))))A+=1,v.push(s(null!=(y=null!=(g=null!=(_=j.DOI)?_:j.OPENALEX)?g:j.PMCID)?y:j._id,j)),100===v.length&&(await Promise.all(v),v=[],n.length>=1e4&&(C.log("report orgs supplementing",n.length,A,Date.now()-k),await this.oareport.works(n),n=[]));for(v.length&&await Promise.all(v),n.length&&await this.oareport.works(n),C.log("report orgs supplemented",A,Date.now()-k),a&&await this.sleep(5e3),u=0,p=a.length;u<p;u++)d=a[u],await this.oareport.orgs.analysis(d,!1);return C.log("report orgs supplement "+(!1!==i?"and analysis ":"")+"complete",I,A,Date.now()-k),I},t.oareport2.orgs.supplement._async=!0,t.oareport2.orgs.supplement._log=!1,t.oareport2.works.process=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe,Te,Me,We,Ue,ze,Fe,Be,Je,Xe,$e,Ve,Ge,Ye,He,Ze,Qe,Ke,et,tt,it,rt,st,at,nt,lt,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Et,Nt,Lt,Pt,Rt,qt,Tt,Mt,Wt,Ut,zt,Ft,Bt,Jt,Xt,$t,Vt,Gt,Yt,Ht,Zt,Qt,Kt,ei,ti,ii,ri,si,ai,ni,li,oi,ui,ci,pi,di,hi,fi,mi,yi,gi,_i,vi,bi,wi,xi,Oi,ki,ji,Si,Ii,Ai,Di,Ci,Ei;try{if(ki=await this.epoch(),await this.datetime(ki),"oareport.works.process"===this.fn&&(i=this.refresh,e=this.params.process),qe={ids:{},is_free_to_read:!1,is_open_access:!1,supplements:[],corresponding_authorships:[],corresponding_author_ids:[],meta:{},outreach:{},data_availability_statement:{}},"string"==typeof e)if((e=e.toLowerCase().split(".org/").pop().replace(/\/$/,"")).startsWith("pmc")){qe.PMCID=e.toUpperCase();try{xe=await this.src.openalex.works('ids.pmcid:"'+e.replace("pmc","")+'"',1)}catch(e){}}else e.startsWith("10.")&&(qe.DOI=e);if(qe._id=qe.DOI?qe.DOI.toLowerCase().replace(/\//g,"_"):(null!=xe?xe.id:void 0)?xe.id.split(".org/").pop().toLowerCase():qe.PMCID?qe.PMCID.toLowerCase():void 0,!i&&(A=await this.oareport.works(qe._id))){if(null!=(Te=qe.meta)?Te.replaced:void 0)for(null==(l=A.meta).replaced&&(l.replaced=[]),Me=qe.meta.replaced,T=0,B=Me.length;T<B;T++)wi=Me[T],N.call(A.meta.replaced,wi)<0&&A.meta.replaced.push(wi);qe=A}if((i||null==qe.openalex)&&(null!=xe?xe:xe=e.startsWith("w")?await this.src.openalex.works('id.keyword:"https://openalex.org/'+e+'"',1):await this.src.openalex.works(e))){try{null==qe.DOI&&(qe.DOI=xe.ids.doi.split("doi.org/").pop())}catch(e){}try{null==qe.PMCID&&(qe.PMCID="PMC"+xe.ids.pmcid.split("/").pop().toLowerCase().replace("pmc",""))}catch(e){}}if(null!=xe?xe.id:void 0){for(qe.openalex={},z=0,J=(Ge=["id","abstract","apc_list","apc_paid","authorships","authors_count","best_oa_location","biblio","cited_by_count","concepts","countries_distinct_count","corresponding_author_ids","created_date","display_name","domains","fields","has_fulltext","ids","is_paratext","is_retracted","keywords","language","mesh","open_access","primary_location","publication_date","publication_year","referenced_works_count","sustainable_development_goals","title","type","type_crossref","updated","updated_date"]).length;z<J;z++)me=Ge[z],qe.openalex[me]=xe[me];for(yt=null!=(at=xe.grants)?at:[],he=0,te=yt.length;he<te;he++)E=yt[he],null==qe.funder&&(qe.funder=[]),qe.funder.push({award:(null!=(It=E.award_id)?It:"").replace(/, /g,",").split(","),display_name:E.funder_display_name,source:"openalex",id:E.funder});for(Yt=null!=(Mt=xe.locations)?Mt:[],ye=0,se=Yt.length;ye<se;ye++)if((pe=Yt[ye]).license&&(de=pe.license.toLowerCase())&&("pd"!==de&&"public-domain"!==de&&"cc0"!==de&&"cc-by"!==de||(qe.is_open_access=!0)),(null!=(ni=pe.source)?ni.is_in_doaj:void 0)&&(null==qe.syp_permissions&&(qe.syp_permissions={}),qe.syp_permissions.can_archive=!0,qe.syp_permissions.archivable_version=pe.version),"journal"===(null!=(gi=pe.source)?gi.type:void 0)&&pe.license&&(!(null!=(We=qe.publisher)?We.license:void 0)||pe.license.length<qe.publisher.license)&&"publishedVersion"===pe.version)null==qe.publisher&&(qe.publisher={}),qe.publisher.license=pe.license,qe.publisher.url_for_pdf=pe.pdf_url,qe.publisher.version=pe.version;else if("repository"===(null!=(Ue=pe.source)?Ue.type:void 0)&&(null==qe.repository&&(qe.repository={}),pe.license&&(!qe.repository.license||pe.license.length<qe.repository.license)&&(qe.repository.license=pe.license),pe.landing_page_url&&pe.landing_page_url.toLowerCase().includes("pmc")&&(qe.PMCID||(Ie=pe.landing_page_url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(Ie))&&(qe.PMCID="PMC"+Ie),pe.license&&!(null!=(ze=qe.epmc)?ze.license:void 0)&&(null==qe.epmc&&(qe.epmc={}),qe.epmc.license=pe.license)),!qe.repository.url||!qe.repository.url.includes("pmc")||!qe.repository.url.includes("ncbi.")&&pe.landing_page_url&&pe.landing_page_url.includes("ncbi.")))for(ve=0,ae=(Fe=["license","pdf_url","landing_page_url","version"]).length;ve<ae;ve++)pe[we=Fe[ve]]&&(qe.repository[we]=pe[we]);for((null!=(Be=qe.repository)?Be.url:void 0)&&(qe.repository.url.toLowerCase().includes("europepmc.")||qe.repository.url.toLowerCase().includes("ncbi."))&&(null==qe.PMCID&&(qe.PMCID="PMC"+qe.repository.url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),qe.repository.url_in_pmc=!0),(null!=(Je=xe.ids)?Je.pmid:void 0)&&(qe.PMID=xe.ids.pmid.split("/").pop()),(null!=(Xe=xe.open_access)?Xe.is_oa:void 0)&&(qe.is_free_to_read=!0),Ve=null!=($e=qe.openalex.concepts)?$e:[],Oe=0,ne=Ve.length;Oe<ne;Oe++){delete(y=Ve[Oe]).wikidata;try{y.score=Math.floor(100*y.score)}catch(e){}}for(He=null!=(Ye=xe.corresponding_author_ids)?Ye:[],Ne=0,le=He.length;Ne<le;Ne++)g=He[Ne],N.call(qe.corresponding_author_ids,g)<0&&qe.corresponding_author_ids.push(g);for(Qe=null!=(Ze=qe.openalex.authorships)?Ze:[],Si=0,oe=Qe.length;Si<oe;Si++){for(et=null!=(Ke=(r=Qe[Si]).institutions)?Ke:[],Ii=0,ue=et.length;Ii<ue;Ii++)delete et[Ii].type;(null!=(tt=r.author)?tt.orcid:void 0)&&r.author.orcid.includes("orcid.org/")&&(r.author.orcid_number=r.author.orcid.split("/").pop()),it=null!=(rt=r.author)?rt.id:void 0,N.call(qe.corresponding_author_ids,it)>=0&&qe.corresponding_authorships.push(r)}}try{for(null==t&&(t=await this.oareport.orgs.supplements(qe._id)),qe.supplements=t.supplements,qe.meta.first_seen=t.first_seen,st=qe.supplements,Di=0,ce=st.length;Di<ce;Di++){(Oi=st[Di]).paid&&(qe.meta.is_updated||(i=!0),qe.meta.is_updated=!0),delete Oi.paid,Oi.email&&!qe.outreach.email_address&&(qe.outreach.email_address=Oi.email),"string"==typeof Oi.email&&Oi.email.includes("@")&&(Oi.email=await this.encrypt(Oi.email)),Oi.author_email_name_ic&&!qe.outreach.author_display_name&&(qe.outreach.author_display_name=Oi.author_email_name_ic);try{for(lt="string"==typeof Oi.corresponding_author_ids?Oi.corresponding_author_ids.split(","):null!=(nt=Oi.corresponding_author_ids)?nt:[],Ci=0,X=lt.length;Ci<X;Ci++)g=lt[Ci],N.call(qe.corresponding_author_ids,g)<0&&qe.corresponding_author_ids.push(g)}catch(e){}for(!Oi.publisher_license_ic||"cc-by"!==(ot=Oi.publisher_license_ic)&&"cc0"!==ot||(qe.is_open_access=!0),(!0===Oi.is_free_ic||qe.is_open_access)&&(qe.is_free_to_read=!0),Ei=0,$=(ut=["mturk_has_data_availability_statement","has_data_availability_statement_ic","has_data_availability_statement","data_availability_statement","data_availability_statement_ic"]).length;Ei<$;Ei++)null==Oi[ji=ut[Ei]]||qe.data_availability_statement.has_data_availability_statement||(qe.data_availability_statement.has_data_availability_statement=!!Oi[ji],qe.data_availability_statement.source="oareport");for(P=0,V=(ct=["category","accession_number","doi","url"]).length;P<V;P++)null!=Oi["data_availability_statement_"+(v=ct[P])]&&(qe.data_availability_statement[v]=Oi["data_availability_statement_"+("doi"===v||"url"===v?"resource_":"")+v]);for(W in Oi)null!=qe[W]&&"object"!=typeof qe[W]&&"DOI"!==W&&"corresponding_author_ids"!==W&&"paid"!==W&&"is_updated"!==W&&"email"!==W&&(qe[W]="NULL"===Oi[W]?void 0:Oi[W])}}catch(e){}try{"not data availability statement"===qe.data_availability_statement.category.toLowerCase()&&(qe.data_availability_statement.has_data_availability_statement=!1)}catch(e){}if((null!=(pt=qe.openalex)?pt.authorships:void 0)&&qe.outreach.email_address&&!qe.outreach.author_display_name)if(j=qe.outreach.email_address.includes("@")?qe.outreach.email_address:await this.decrypt(qe.outreach.email_address),(null!=(dt=qe.openalex)?dt.authorships:void 0)&&1===qe.openalex.authorships.length&&(d=null!=(ht=qe.openalex.authorships[0].author)?ht.display_name:void 0))qe.outreach.author_display_name="Dr. "+d;else{for(vi=j.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),h="",f="",p="",m=1e6,ft=qe.openalex.authorships,M=0,G=ft.length;M<G;M++)(Re=null!=(mt=(bi=ft[M]).author)?mt.display_name:void 0)&&((xi=(await this.levenshtein(vi,Re.toLowerCase().replace(/[^a-z]/g,""))).distance/Re.length)<m&&(m=xi,f=Re),m>.2&&(vi.endsWith(Re.split(" ").pop().toLowerCase())||Re.split(" ")[0].length>4&&vi.includes(Re.split(" ")[0].toLowerCase()))&&(m=.1,f=Re),!h&&vi.startsWith((Re.split(" ")[0].slice(0,1)+Re.split(" ").pop().slice(0,1)).toLowerCase())&&(h=Re),!p&&bi.author.is_corresponding&&(p=Re));(L=f&&m<.7?f.split(" ").pop():h||p||d)&&(qe.outreach.author_display_name="Dr. "+L)}if(("Public Library of Science"===(null!=(gt=qe.openalex)&&null!=(_t=gt.primary_location)&&null!=(vt=_t.source)?vt.publisher:void 0)||qe.DOI&&(qe.DOI.startsWith("10.1186")||qe.DOI.startsWith("10.12688/gatesopenres")))&&(qe.data_availability_statement.has_data_availability_statement=!0,qe.data_availability_statement.source="openalex"),qe.meta.is_updated){if(q=[],qe.DOI&&(null==xe||!xe.grants||i&&!qe.meta.checked_crossref&&(!(null!=(bt=qe.crossref)?bt.subtype:void 0)||!qe.acceptance_date||!qe.submission_date))&&(_=await this.src.crossref.works(qe.DOI))){if(_.ISSN&&(q=_.ISSN),_.is_oa&&(qe.is_free_to_read=!0),"preprint"===_.subtype&&(null==qe.crossref&&(qe.crossref={}),qe.crossref.subtype="preprint"),qe.meta.checked_crossref=ki,!qe.submission_date||!qe.acceptance_date)for(xt=null!=(wt=_.assertion)?wt:[],U=0,Y=xt.length;U<Y;U++)((n=(null!=(Ot=(a=xt[U]).label)?Ot:"").toLowerCase()).includes("accepted")&&n.split(" ").length<3||n.includes("received"))&&(null!=(s=await this.dateparts(a.value))?s.date:void 0)&&s.timestamp&&null==qe[_e=(n.includes("received")?"submission":"acceptance")+"_date"]&&(qe[_e]=s.date);if(null!=xe&&!xe.grants)for(jt=null!=(kt=_.funder)?kt:[],F=0,H=jt.length;F<H;F++)D=jt[F],null==qe.funder&&(qe.funder=[]),qe.funder.push({award:D.award,display_name:D.name,source:"crossref",id:D.DOI})}if((null!=(St=qe.openalex)&&null!=(At=St.primary_location)&&null!=(Dt=At.source)?Dt.publisher:void 0)&&!qe.publisher_simple){if(!b.length)for(Et=null!=(Ct=await this.report.publishers("*",1e4))?Ct:[],fe=0,Z=Et.length;fe<Z;fe++)wi=Et[fe],b.push(null!=(Nt=wi._source)?Nt:wi);for(Ce=qe.openalex.primary_location.source.publisher.toLowerCase(),ge=0,Q=b.length;ge<Q;ge++)if((De=b[ge]).publisher&&Ce.includes(De.publisher.toLowerCase())){qe.publisher_simple=De.publisher_display_name;break}}if((qe.DOI||qe.PMID||(null!=(Lt=qe.ids)?Lt.pmid:void 0))&&(!qe.PMCID&&!(null!=(Pt=qe.ids)?Pt.pmcid:void 0)||!qe.PMID&&!(null!=(Rt=qe.ids)?Rt.pmid:void 0)||null==(null!=(qt=qe.pubmed)?qt.pubtype:void 0)||!qe.submission_date||!qe.acceptance_date)&&(Ee=qe.PMID||qe.ids.pmid?await this.src.pubmed(null!=(Tt=qe.PMID)?Tt:qe.ids.pmid):await this.src.pubmed.doi(qe.DOI))){for(Ut=null!=(Wt=Ee.ISSN)?Wt:[],be=0,K=Ut.length;be<K;be++)Se=Ut[be],N.call(q,Se)<0&&q.push(Se);!qe.PMCID&&(null!=Ee&&null!=(zt=Ee.identifier)?zt.pmc:void 0)&&(qe.PMCID="PMC"+Ee.identifier.pmc.toLowerCase().replace("pmc","")),!qe.PMID&&(null!=Ee&&null!=(Ft=Ee.identifier)?Ft.pubmed:void 0)&&(qe.PMID=Ee.identifier.pubmed),null==qe.pubmed&&(qe.pubmed={}),qe.pubmed.pubtype=Ee.type,null==qe.submission_date&&(qe.submission_date=null!=(Bt=Ee.dates)&&null!=(Jt=Bt.PubMedPubDate_received)?Jt.date:void 0),null==qe.acceptance_date&&(qe.acceptance_date=null!=(Xt=Ee.dates)&&null!=($t=Xt.PubMedPubDate_accepted)?$t.date:void 0)}if((qe.PMCID||qe.ids.pmcid)&&(i||!qe.meta.checked_epmc_license)&&(qe.meta.checked_epmc_license=ki,S=await this.src.epmc.pmc(null!=(Vt=qe.PMCID)?Vt:qe.ids.pmcid))){for((null!=(Gt=S.journalInfo)&&null!=(Ht=Gt.journal)?Ht.issn:void 0)&&(Zt=S.journalInfo.journal.issn,N.call(q,Zt)<0)&&q.push(S.journalInfo.journal.issn),(null!=(Qt=S.journalInfo)&&null!=(Kt=Qt.journal)?Kt.essn:void 0)&&(ei=S.journalInfo.journal.essn,N.call(q,ei)<0)&&q.push(S.journalInfo.journal.essn),null==qe.PMCID&&(qe.PMCID=S.pmcid),null==qe.pubmed&&(qe.pubmed={}),null==(o=qe.pubmed).pubtype&&(o.pubtype=[]),ri=null!=(ti=null!=(ii=S.pubTypeList)?ii.pubType:void 0)?ti:[],ke=0,ee=ri.length;ke<ee;ke++)Ae=ri[ke],N.call(qe.pubmed.pubtype,Ae)<0&&qe.pubmed.pubtype.push(Ae);if(null==qe.epmc&&(qe.epmc={}),qe.epmc.license=null!=(si=await this.src.epmc.licence(null!=(ai=qe.PMCID)?ai:qe.ids.pmcid,S))?si.licence:void 0,(null!=(li=qe.data_availability_statement)?li.has_data_availability_statement:void 0)||(await this.src.pubmed.availability(null!=(oi=qe.PMCID)?oi:qe.ids.pmcid)?(qe.data_availability_statement.has_data_availability_statement=!0,qe.data_availability_statement.source="pubmed"):(qe.data_availability_statement.has_data_availability_statement=!1,qe.data_availability_statement.source="pubmed")),!(null!=(ui=qe.data_availability_statement)?ui.has_data_availability_statement:void 0))if(O=await this.src.epmc.statement(null!=(ci=qe.PMCID)?ci:qe.ids.pmcid,S)){if(qe.data_availability_statement.has_data_availability_statement=!0,qe.data_availability_statement.source="epmc",qe.data_availability_statement.full_text=O,Ai=await this.src.epmc.statement.url(null!=(pi=qe.PMCID)?pi:qe.ids.pmcid,S,O))for(Le=0,ie=Ai.length;Le<ie;Le++)(w=Ai[Le])&&w.includes("doi.org/")?(x=w.split("doi.org/")[1].toLowerCase(),null==(u=qe.data_availability_statement).resource_doi&&(u.resource_doi=[]),N.call(qe.data_availability_statement.resource_doi,x)<0&&qe.data_availability_statement.resource_doi.push(x)):(null==(c=qe.data_availability_statement).resource_url&&(c.resource_url=[]),N.call(qe.data_availability_statement.resource_url,w)<0&&qe.data_availability_statement.resource_url.push(w))}else qe.data_availability_statement.has_data_availability_statement=!1,qe.data_availability_statement.source="epmc";null==qe.submission_date&&(qe.submission_date=await this.src.epmc.submitted(null!=(di=qe.PMCID)?di:qe.ids.pmcid,S))}qe.DOI&&(null==qe.syp_permissions&&(qe.syp_permissions={}),(je=await this.permissions_new({doi:qe.DOI},void 0,xe))&&null!=je.best_permission&&(qe.syp_permissions.can_archive&&!je.best_permission.can_archive||(qe.syp_permissions.can_archive=je.best_permission.can_archive,je.best_permission.version&&(qe.syp_permissions.archivable_version=je.best_permission.version))),(q||null!=xe||null!=_)&&(qe.syp_permissions.journal_oa_type=null!=(hi=await this.permissions_new.journals.oa.type(q,void 0,xe,_))?hi:"unsuccessful","gold"!==(fi=qe.syp_permissions.journal_oa_type)&&"diamond"!==fi||(qe.is_open_access=!0)))}for("string"==typeof qe.outreach.email_address&&qe.outreach.email_address.includes("@")&&(qe.outreach.email_address=await this.encrypt(qe.outreach.email_address)),qe.is_open_access||!(null!=(mi=qe.epmc)?mi.license:void 0)||!(k=qe.epmc.license.toLowerCase())||"pd"!==k&&"public-domain"!==k&&"cc0"!==k&&"cc-by"!==k||(qe.is_open_access=!0),qe.meta.updated=await this.epoch(),qe.meta.updated_date=await this.date(qe.meta.updated),qe.meta.took=qe.meta.updated-ki,Pe=0,re=(yi=["DOI","PMCID","PMID"]).length;Pe<re;Pe++)qe[R=yi[Pe]]&&(qe.ids[R.toLowerCase()]=qe[R]),"DOI"!==R&&delete qe[R];try{qe.ids.openalex=qe.openalex.id.split("/").pop()}catch(e){}return!1!==this.params.save&&qe._id&&qe._id===(null!=(_i=this.params.process)?_i:"").toLowerCase().replace(/\//g,"_")&&this.oareport.works(qe),qe}catch(t){I=t,C.log("report works process error",I);try{C.log(e)}catch(e){}}},N=[].indexOf,t.permissions=async function(e,t,i,s,a,n){var l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe;if(T=!1,m=!1,l=async function(t){var i,s,n,l,o,u,c,p,d,h,f,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,N,L;if(m&&t.embargo_months&&(e.published||e.year)&&(s=new Date(Date.parse(null!=(g=e.published)?g:e.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+t.embargo_months)),t.embargo_end=s.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(_=t.copyright_owner.toLowerCase())&&"affiliation"!==_?m&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(S=e.author[0].name)?S:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(j=e.journal)?j:"",("publisher"===(I=t.copyright_name.toLowerCase())||"journal"===I)&&(a||e.doi||(null!=(A=t.provenance)?A.example:void 0)))for(null==a&&(a=await this.src.crossref.works.doi(null!=(D=e.doi)?D:t.provenance.example)),o=0,p=(E=null!=(C=null!=a?a.assertion:void 0)?C:[]).length;o<p;o++)if("copyright"===(i=E[o]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(m&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,m&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(l="",u=0,d=(N=t.deposit_statement.split("<<")).length;u<d;u++)if(y=N[u],""!==l||y.includes(">>")){if(null!=(L={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(n=y.split(">>"))[0].toLowerCase()]&&(f=L[f]),"author"===f)try{l+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else l+=null!=(b=null!=(w=e[f])?w:t[f])?b:"";try{l+=n[1]}catch(e){}}else l+=y;t.deposit_statement=l}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(T=t.issuer.has_policy),c=0,h=(k=["_id","hide"]).length;c<h;c++)delete t[k[c]];return t},u=e=>{var t,i,r,s,a,n;return n=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(n+=1e3),null!=e.requirements?n-=10:n+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,e.licence&&(n-=5),n+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(a=e.issuer)?a.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(n-=25),n},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),v=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&e.issn.includes(",")&&(e.issn=e.issn.split(",")),delete e.best,"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(null==n&&(n=this.params.best),n&&e.doi&&!e.ror.length&&(p=await this.permissions.best(e.doi))&&(!0===n||p.updated>n))return delete p.updated,delete p.DOI,{best_permission:p};if(o=async()=>{var t,i,r,s,n;if(i=this.copy(e),"{}"!==JSON.stringify(i)){for(t in s=[],n=null!=(r=null!=a?a:await this.metadata(e.doi))?r:{})s.push(null!=e[t]?e[t]:e[t]=n[t]);return s}},!1===i||!e.doi||e.publisher&&e.issn||await o(),!e.published&&e.year&&(e.published=e.year+"-01-01"),m=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!v.length)for(y=0,x=($=e.issn).length;y<x;y++)_=$[y],N.call(v,_)<0&&v.push(_);try{null==e.doi&&(e.doi=await this.permissions.journals.example(v))}catch(e){}!m&&e.doi&&await o()}if(m&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ce=e.year)?ce:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(U={best_permission:void 0,all_permissions:[]},Se=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(De=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(be=De.hits)?be.total:void 0))try{(null!=(we=(Ce=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')).hits)?we.total:void 0)&&(Ce=Ce.hits.hits[0]._source),Ce.country.country_code&&(De=await this.permissions.affiliations('issuer.id:"'+Ce.country.country_code+'"'))}catch(e){}for(b=0,O=(ke=null!=(xe=null!=De&&null!=(Oe=De.hits)?Oe.hits:void 0)?xe:[]).length;b<O;b++)Ae=ke[b],(Le=await l(Ae._source)).score=await u(Le),Se.push(Le)}if(g=void 0,v){for await(X of this.index._for("src_doaj_journals",'bibjson.pissn:"'+v.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+v.join('" OR bibjson.eissn:"')+'"'))g||(g=X),V=X.bibjson.pissn,N.call(v,V)<0&&v.push(X.bibjson.pissn),G=X.bibjson.eissn,N.call(v,G)<0&&v.push(X.bibjson.eissn);if(v.length)for(P=0,j=(Z=null!=(Y=null!=(z=await this.permissions.journals('issuer.id:"'+v.join('" OR issuer.id:"')+'"'))&&null!=(H=z.hits)?H.hits:void 0)?Y:[]).length;P<j;P++)M=Z[P],(Ie=await l(M._source)).score=await u(Ie),U.all_permissions.push(Ie)}if(e.publisher)for(B='issuer.id:"'+e.publisher+'"',R=0,S=(ee=null!=(Q=null!=(z=await this.permissions.publishers(B))&&null!=(K=z.hits)?K.hits:void 0)?Q:[]).length;R<S;R++)M=ee[R],(Ie=await l(M._source)).score=await u(Ie),U.all_permissions.push(Ie);if(c={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},v&&(null!=g?g:g=await this.src.doaj.journals('bibjson.eissn.keyword:"'+v.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+v.join('" OR bibjson.pissn.keyword:"')+'"',1))){for(q=0,I=(se=null!=(ie=null!=(re=g.bibjson)?re.license:void 0)?ie:[]).length;q<I;q++)h=se[q],(!c.licence||c.licence.length<h.type.length)&&(c.licence=h.type),null==c.licences&&(c.licences=[]),c.licences.push({type:h.type});if(null==c.licence&&(d=await this.src.crossref.journals('ISSN.keyword:"'+v.join('" OR ISSN.keyword:"')+'"',1)))for(F=0,A=(ne=null!=(ae=d.license)?ae:[]).length;F<A;F++)L=ne[F],(!c.licence||c.licence.length<L.type.length)&&(c.licence=L.type);"string"==typeof c.licence?(c.licence=c.licence.toLowerCase().trim(),c.licence.startsWith("cc")?c.licence=c.licence.replace(/ /g,"-"):c.licence.includes("creative")?c.licence=c.licence.includes("0")||c.licence.includes("zero")?"cc0":c.licence.includes("share")?"ccbysa":c.licence.includes("derivative")?"ccbynd":"ccby":delete c.licence):delete c.licence,c.issuer.id=g.bibjson.eissn&&g.bibjson.pissn?[g.bibjson.pissn,g.bibjson.eissn]:g.bibjson.pissn?[g.bibjson.pissn]:[g.bibjson.eissn],c.embargo_months=0,c.provenance={oa_evidence:"In DOAJ"},c.score=await u(c),U.all_permissions.push(c)}else!v&&e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(c.issuer.id=e.publisher,c.meta.creator=["joe+oapublisher@oa.works"],c.meta.contributors=["joe+oapublisher@oa.works"],c.provenance={oa_evidence:"OA publisher"},c.score=await u(c),U.all_permissions.push(c));if(e.doi&&(null==s&&(s=await this.src.oadoi.doi(e.doi)),m&&(null!=s&&null!=(le=s.best_oa_location)?le.license:void 0)&&s.best_oa_location.license.includes("cc")&&((f={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(f.versions="submittedVersion"===f.version?["submittedVersion"]:"acceptedVersion"===f.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),f.score=await u(f),U.all_permissions.push(f))),U.all_permissions.length){for(U.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),J=0,D=(oe=U.all_permissions).length;J<D;J++)null==(qe=oe[J]).licences&&(qe.licences=[],qe.licence&&qe.licences.push({type:qe.licence})),m&&(null!=(ue=qe.issuer)?ue.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(qe.issuer.journal_oa_type_from)&&delete qe.issuer.journal_oa_type,delete qe.issuer.journal_oa_type_from,!v&&"journal"!==(null!=(pe=qe.issuer)?pe.type:void 0)||qe.issuer.journal_oa_type||(qe.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=v?v:qe.issuer.id,g,s,a)),(null!=(de=qe.provenance)?de.enforcement_from:void 0)?(!e.published||Date.parse(e.published)>Date.parse(qe.provenance.enforcement_from.split("/").reverse().join("-")))&&null==U.best_permission&&(U.best_permission=this.copy(qe)):null==U.best_permission&&(U.best_permission=this.copy(qe));if(Se.length)for(Se.sort(((e,t)=>e.score<t.score?1:-1)),Ee=0,C=Se.length;Ee<C;Ee++)if(je=Se[Ee],m&&(null!=(he=je.issuer)?he.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(je.issuer.journal_oa_type_from)&&delete je.issuer.journal_oa_type,delete je.issuer.journal_oa_type_from,!v&&"journal"!==(null!=(fe=je.issuer)?fe.type:void 0)||je.issuer.journal_oa_type||(je.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=v?v:je.issuer.id,g,s,a)),U.all_permissions.push(je),null==(null!=(me=U.best_permission)?me.author_affiliation_requirement:void 0)&&null!=U.best_permission&&(!(null!=(ye=je.provenance)?ye.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(je.provenance.enforcement_from.split("/").reverse().join("-")))){for(W=this.copy(U.best_permission),Ne=0,E=(ge=["versions","locations"]).length;Ne<E;Ne++)for(Pe=0,k=(_e=je[w=ge[Ne]]).length;Pe<k;Pe++)Re=_e[Pe],null==W[w]&&(W[w]=[]),N.call(W[w],Re)<0&&W[w].push(Re);W.version=N.call(W.versions,"publishedVersion")>=0?"publishedVersion":N.call(W.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",W.embargo_end&&je.embargo_end&&Date.parse(je.embargo_end)<Date.parse(W.embargo_end)&&(W.embargo_end=je.embargo_end),W.embargo_months&&null!=je.embargo_months&&je.embargo_months<W.embargo_months&&(W.embargo_months=je.embargo_months),!0===je.can_archive&&(W.can_archive=!0),null==W.requirements&&(W.requirements={}),W.requirements.author_affiliation_requirement=null==e.ror?je.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],W.issuer.affiliation=je.issuer,null==W.meta&&(W.meta={}),W.meta.affiliation=je.meta,null==W.provenance&&(W.provenance={}),W.provenance.affiliation=je.provenance,W.score=parseInt(W.score)+parseInt(je.score),U.best_permission=W,U.all_permissions.push(W)}}return T?{body:"string"!=typeof T?T:null!=(ve={"not publisher":"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it"}[T.toLowerCase()])?ve:T,status:501}:(e.doi&&!Se.length&&U.best_permission&&((p=await this.copy(U.best_permission)).updated=await this.epoch(),p.DOI=e.doi,this.waitUntil(this.permissions.best(p))),!0!==this.params.metadata&&!0!==i||(U.metadata=e),U)},t.permissions._log=!1,t.permissions.best={_index:!0,_key:"DOI"},t.permissions.journals={_sheet:"1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",_prefix:!1,_format:async function(e=[]){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v;for(f=[],s=0,u=(y="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<u;s++){for(n in h={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},m=y[s])if("string"==typeof m[n]&&(m[n]=m[n].trim()),"id"===n)if(h.issuer.id="string"==typeof m.id&&m.id.includes(",")?m.id.split(","):m.id,"string"==typeof h.issuer.id&&h.issuer.id.startsWith("10.")&&h.issuer.id.includes("/")&&!h.issuer.id.includes(" "))h.DOI=h.issuer.id;else{for(r=[],a=0,c=(g="string"==typeof h.issuer.id?[h.issuer.id]:h.issuer.id).length;a<c;a++){if(d=(d=g[a]).trim(),"journal"===h.issuer.type&&d.includes("-")&&!d.includes(" ")&&(d=d.toUpperCase(),t=await this.src.openalex.sources('issn:"'+d+'"',1)))for(o=0,p=(_=t.issn).length;o<p;o++)i=_[o],N.call(r,i)<0&&r.push(i);N.call(r,d)<0&&r.push(d)}h.issuer.id=r}else"embargo_months"===n?(l="number"==typeof m[n]?m[n]:"string"==typeof m[n]?parseInt(m[n].trim()):void 0)&&"number"==typeof l&&(h.embargo_months=l,h.embargo_end=""):n&&null!=m[n]&&""!==(v=m[n])&&"none"!==v&&"unclear"!==v&&("versions"===n&&m.versions.length&&(h.can_archive=!0,h.version=m.versions.includes("ublish")?"publishedVersion":m.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==n&&"locations"!==n&&"meta.contributors"!==n&&"meta.creator"!==n&&"meta.reviewer"!==n&&"provenance.archiving_policy"!==n&&"requirements.funder"!==n&&"journal"!==n||(m[n]=m[n].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(h,"license"===n?"licence":n,m[n]));h.copyright_owner&&"journal"!==h.copyright_owner.toLowerCase()||!h.issuer.type||(h.copyright_owner=h.issuer.type),"{}"===JSON.stringify(h.requirements)&&delete h.requirements,f.push(h)}return 1===f.length?f[0]:f}},t.permissions.publishers={_sheet:"11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.affiliations={_sheet:"15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.journals.example=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.crossref.works('ISSN:"'+e.join('" OR ISSN:"')+'"',1)).DOI}catch(e){}},t.permissions.journals.example._log=!1,t.permissions.journals.transformative={_index:!0,_prefix:!1},t.permissions.journals.transformative.load=async function(){var e,t,i,r,s;for(e=[],t=0,i=(s=(await this.fetch("https://api.journalcheckertool.org/journal?q=tj:true&include=issn&size=10000")).hits.hits).length;t<i;t++)r=s[t],e.push(r._source);return e.length&&(await this.permissions.journals.transformative(""),await this.permissions.journals.transformative(e)),e.length},t.permissions.journals.transformative.load._bg=!0,t.permissions.journals.transformative.load._async=!0,t.permissions.journals.transformative.load._auth="root",t.permissions.journals.oa=async function(e,t){var i,r,s,a,n,l;try{null==e&&(e=null!=(r=null!=(s=null!=(a=this.params.journals)?a:this.params.journal)?s:this.params.issn)?r:this.params.oa)}catch(e){}return l={},e&&(l.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'"'),l.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'" AND is_oa:true'),l.articles===l.open&&(l.oa=!0),await this.src.doaj.journals('bibjson.pissn:"'+e+'" OR bibjson.eissn:"'+e+'"',1)&&(l.open=l.articles,l.doaj=!0,l.oa=!0),(i=await this.permissions.journals.example(e))&&(null==t&&(t=await this.src.oadoi.doi(i)),null!=t?(delete l.oa,l.open=l.articles,l.oadoi=!0,l.oa=(null!=t&&null!=(n=t.best_oa_location)?n.license:void 0)&&t.best_oa_location.license.includes("cc")):l.oa=!1)),l},t.permissions.journals.oa._log=!1,t.permissions.journals.oa.type=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d,h,f,m,y;return null==e&&(e=null!=(n=null!=(l=null!=(u=null!=(c=null!=(p=null!=(d=null!=i?i.journal_issns:void 0)?d:null!=r?r.ISSN:void 0)?p:this.params.journals)?c:this.params.journal)?u:this.params.type)?l:this.params.issn)?n:this.params.issns),"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),e.startsWith("10.")&&(null==i&&(i=await this.src.oadoi.doi(e)),null==r&&(r=await this.src.crossref.works.doi(e)),e=null!=(h=null!=i?i.journal_issns:void 0)?h:null!=r?r.ISSN:void 0)),"string"==typeof e&&(e=e.split(",")),a="unknown",null!=(null!=r?r.type:void 0)&&"journal-article"!==r.type?a="not applicable":(null!=r?r.type:void 0)&&"journal-article"!==r.type||(a="gold"===(null!=i?i.oa_status:void 0)||(null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",null==t&&e&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?a=!1===(null!=(f=t.bibjson)&&null!=(m=f.apc)?m.has_apc:void 0)?"diamond":"gold":e&&(e&&await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?a="transformative":"closed"===a&&(await this.src.oadoi.hybrid(e)?a="hybrid":"closed"!==(y=null!=i?i.oa_status:void 0)&&"bronze"!==y&&"green"!==y&&(s=await this.src.oadoi.oa.type(e)).calculated&&"closed"!==(o=s.calculated)&&"bronze"!==o&&"green"!==o&&(a=s.calculated)))),a},t.permissions.journals.oa.type._log=!1,t.permissions.publishers.oa=async function(e){var t,i,r,s;return s={publisher:(null!=(r=null!=e?e:this.params.publisher)?r:this.params.oa).replace(/&/g,"")},await this.src.crossref.journals('publisher:"'+s.publisher+'"',1)||((t=await this.src.crossref.journals('publisher:"'+s.publisher.split(" ").join('" AND publisher:"')+'"',1))?t.publisher.toLowerCase()!==s.publisher.toLowerCase()&&((i=await this.levenshtein(t.publisher,s.publisher)).distance<5||(i.length.a>i.length.b?i.length.a:i.length.b)/i.distance>10)&&(s.publisher=t.publisher):s.journals=0),null==s.journals&&(s.journals=await this.src.crossref.journals.count('publisher:"'+s.publisher+'" AND NOT discontinued:true')),s.open=await this.src.doaj.journals.count('publisher:"'+s.publisher+'" AND NOT bibjson.discontinued_date:* AND NOT bibjson.is_replaced_by:*'),s.percent=s.journals?Math.ceil(s.open/s.journals*100):s.open?100:0,s.oa=!s.journals&&s.open||s.journals&&s.journals===s.open,s},t.permissions.publishers.oa._log=!1,N=[].indexOf,t.permissions_new=async function(e,t,i){var s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe,Te,Me,We,Ue,ze,Fe,Be,Je,Xe,$e,Ve,Ge,Ye,He,Ze,Qe,Ke,et;W=!1,h=!1,s=function(t){var i,s,a,n,l,o,u,c,p,d,f,m,y,g,_,v,b,w,x,O,k;if(h&&t.embargo_months&&(e.published||e.year)&&(i=new Date(Date.parse(null!=(d=e.published)?d:e.year+"-01-01")),i=new Date(i.setMonth(i.getMonth()+t.embargo_months)),t.embargo_end=i.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(f=t.copyright_owner.toLowerCase())&&"affiliation"!==f?h&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(g=e.author[0].name)?g:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(y=e.journal)?y:"",h&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,h&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(a="",n=0,o=(_=t.deposit_statement.split("<<")).length;n<o;n++)if(p=_[n],""!==a||p.includes(">>")){if(null!=(k={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[c=(s=p.split(">>"))[0].toLowerCase()]&&(c=k[c]),"author"===c)try{a+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else a+=null!=(b=null!=(w=e[c])?w:t[c])?b:"";try{a+=s[1]}catch(e){}}else a+=p;t.deposit_statement=a}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(W=t.issuer.has_policy),l=0,u=(m=["_id","hide"]).length;l<u;l++)delete t[m[l]];return t},a=e=>{var t,i,r,s,a,n;return n=(e.can_archive?1e3:0)+("In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)?1e3:0)+(e.licence?-5:0),n+=null!=e.requirements?-10:"publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,n+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(a=e.issuer)?a.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(n-=25),n},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params));try{e.permissions=e.permissions_new,delete e.permissions_new}catch(e){}if(!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),"string"==typeof e.issn&&(e.issn=e.issn.split(",")),"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};h=e.doi;try{null==e.doi&&(e.doi=await this.permissions_new.journals.example(e.issn))}catch(e){}if(h&&(!e.publisher||!e.issn)&&(null!=i?i:i=await this.src.openalex.works(h))){for(f=0,b=(G=null!=(V=i.authorships)?V:[]).length;f<b;f++){for(n=G[f],(u={}).name=n.author.display_name,u.family=u.name.split(" ").pop(),u.name.split(" ").length>1&&(u.given=u.name.split(" ")[0]),y=0,w=(fe=null!=(se=n.raw_affiliation_strings)?se:[]).length;y<w;y++)l=fe[y],null==u.affiliation&&(u.affiliation=[]),u.affiliation.push({name:l});null==e.author&&(e.author=[]),e.author.push(u)}if(null==e.type&&(e.type=i.type_crossref),"journal"===(null!=(ke=i.primary_location)&&null!=(Pe=ke.source)?Pe.type:void 0))for(null==e.publisher&&(e.publisher=null!=(Me=i.primary_location.source.publisher)?Me:i.primary_location.source.host_organization_name),null==e.journal&&(e.journal=i.primary_location.source.display_name),null==e.issn&&(e.issn=[]),g=0,j=(Ue=null!=(We=i.primary_location.source.issn)?We:[]).length;g<j;g++)T=Ue[g],N.call(e.issn,T)<0&&e.issn.push(T);for(null==e.published&&(e.published=i.publication_date),null==e.year&&(e.year=i.publication_year),e.abstract=i.abstract,v=0,S=(ze=["title"]).length;v<S;v++)i[M=ze[v]]&&null==e[M]&&(e[M]=i[M]);for(P=0,I=(Y=["volume","issue"]).length;P<I;P++)c=Y[P],(null!=(H=i.biblio)?H[c]:void 0)&&null==e[c]&&(e[c]=i.biblio[c]);((null!=(Z=i.biblio)?Z.first_page:void 0)||(null!=(Q=i.biblio)?Q.last_page:void 0))&&(e.pages=(null!=(K=i.biblio.first_page)?K:"")+(i.biblio.first_page&&i.biblio.last_page?" to ":"")+(null!=(ee=i.biblio.last_page)?ee:""))}if(!e.year&&e.published&&e.published.includes("-")&&(e.year=e.published.split("-")[0]),"number"==typeof e.year&&(e.year+=""),!e.published&&e.year&&(e.published=e.year+"-01-01"),"string"==typeof e.issn&&(e.issn=[e.issn]),e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim()),h&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};try{e.citation="["+(e.title?e.title+". ":""),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ie=e.year)?ie:e.published).split("-")[0]+")"),e.citation=e.citation.trim()+"]"}catch(e){}if(F={best_permission:void 0,all_permissions:[]},Be=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=($e=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(re=$e.hits)?re.total:void 0)){try{Ve=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')}catch(e){}(null!=Ve&&null!=(ae=Ve.hits)?ae.total:void 0)&&(Ve=Ve.hits.hits[0]._source),(null!=Ve&&null!=(ne=Ve.country)?ne.country_code:void 0)&&($e=await this.permissions.affiliations('issuer.id:"'+Ve.country.country_code+'"'))}for(R=0,A=(ue=null!=(le=null!=$e&&null!=(oe=$e.hits)?oe.hits:void 0)?le:[]).length;R<A;R++)Xe=ue[R],(He=await s(Xe._source)).score=await a(He),Be.push(He)}if(m=void 0,e.issn){for await($ of this.index._for("src_doaj_journals",'bibjson.pissn:"'+e.issn.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+e.issn.join('" OR bibjson.eissn:"')+'"'))null==m&&(m=$),ce=$.bibjson.pissn,N.call(e.issn,ce)<0&&e.issn.push($.bibjson.pissn),pe=$.bibjson.eissn,N.call(e.issn,pe)<0&&e.issn.push($.bibjson.eissn);for(q=0,D=(me=null!=(de=null!=(B=await this.permissions.journals('issuer.id:"'+e.issn.join('" OR issuer.id:"')+'"'))&&null!=(he=B.hits)?he.hits:void 0)?de:[]).length;q<D;q++)U=me[q],(Je=await s(U._source)).score=await a(Je),F.all_permissions.push(Je)}if(e.publisher)for(J=0,C=(_e=null!=(ye=null!=(B=await this.permissions.publishers('issuer.id:"'+e.publisher+'"'))&&null!=(ge=B.hits)?ge.hits:void 0)?ye:[]).length;J<C;J++)U=_e[J],(Je=await s(U._source)).score=await a(Je),F.all_permissions.push(Je);if(o={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},m){for(X=0,E=(we=null!=(ve=null!=(be=m.bibjson)?be.license:void 0)?ve:[]).length;X<E;X++)p=we[X],(!o.licence||o.licence.length>p.type)&&(o.licence=p.type),null==o.licences&&(o.licences=[]),o.licences.push({type:p.type});"string"==typeof o.licence?(o.licence=o.licence.toLowerCase().trim(),o.licence.startsWith("cc")?o.licence=o.licence.replace(/ /g,"-"):o.licence.includes("creative")?o.licence=o.licence.includes("0")||o.licence.includes("zero")?"cc0":o.licence.includes("share")?"ccbysa":o.licence.includes("derivative")?"ccbynd":"ccby":delete o.licence):delete o.licence,o.issuer.id=m.bibjson.eissn&&m.bibjson.pissn?[m.bibjson.pissn,m.bibjson.eissn]:m.bibjson.pissn?[m.bibjson.pissn]:[m.bibjson.eissn],o.embargo_months=0,o.provenance={oa_evidence:"In DOAJ"},o.score=await a(o),F.all_permissions.push(o)}else e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(o.issuer.id=e.publisher,o.meta.creator=["joe+oapublisher@oa.works"],o.meta.contributors=["joe+oapublisher@oa.works"],o.provenance={oa_evidence:"OA publisher"},o.score=await a(o),F.all_permissions.push(o));if(h&&(null!=i?i:i=await this.src.openalex.works(h))&&(null!=(xe=null!=i&&null!=(Oe=i.best_oa_location)?Oe.license:void 0)?xe:"").includes("cc")&&((d={can_archive:!0,version:i.best_oa_location.version,versions:"submittedVersion"===i.best_oa_location.version?["submittedVersion"]:"acceptedVersion"===i.best_oa_location.version?["submittedVersion","acceptedVersion"]:i.best_oa_location.version?["submittedVersion","acceptedVersion","publishedVersion"]:[],licence:i.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:i.updated},provenance:{oa_evidence:"Openalex"}}).score=await a(d),F.all_permissions.push(d)),F.all_permissions.length){for(F.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),Ge=0,L=(je=F.all_permissions).length;Ge<L;Ge++)null==(et=je[Ge]).licences&&(et.licences=[],et.licence&&et.licences.push({type:et.licence})),h&&(null!=(Se=et.issuer)?Se.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(et.issuer.journal_oa_type_from)&&delete et.issuer.journal_oa_type,delete et.issuer.journal_oa_type_from,!e.issn&&"journal"!==(null!=(Ie=et.issuer)?Ie.type:void 0)||et.issuer.journal_oa_type||(et.issuer.journal_oa_type=await this.permissions_new.journals.oa.type(null!=(Ae=e.issn)?Ae:et.issuer.id,m,i)),(!(null!=(De=et.provenance)?De.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(et.provenance.enforcement_from.split("/").reverse().join("-")))&&null==F.best_permission&&(F.best_permission=et);for(Ce=Be.sort(((e,t)=>e.score<t.score?1:-1)),Ye=0,x=Ce.length;Ye<x;Ye++)if(Fe=Ce[Ye],h&&(null!=(Ee=Fe.issuer)?Ee.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Fe.issuer.journal_oa_type_from)&&delete Fe.issuer.journal_oa_type,delete Fe.issuer.journal_oa_type_from,!e.issn&&"journal"!==(null!=(Ne=Fe.issuer)?Ne.type:void 0)||Fe.issuer.journal_oa_type||(Fe.issuer.journal_oa_type=await this.permissions_new.journals.oa.type(null!=(Le=e.issn)?Le:Fe.issuer.id,m,i)),F.all_permissions.push(Fe),null!=(z=F.best_permission)&&null==z.author_affiliation_requirement&&(!(null!=(Re=Fe.provenance)?Re.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(Fe.provenance.enforcement_from.split("/").reverse().join("-")))){for(Ze=0,O=(qe=["versions","locations"]).length;Ze<O;Ze++)for(Qe=0,k=(Te=Fe[_=qe[Ze]]).length;Qe<k;Qe++)Ke=Te[Qe],N.call(z[_],Ke)<0&&z[_].push(Ke);z.version=N.call(z.versions,"publishedVersion")>=0?"publishedVersion":N.call(z.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",z.embargo_end&&Fe.embargo_end&&Date.parse(Fe.embargo_end)<Date.parse(z.embargo_end)&&(z.embargo_end=Fe.embargo_end),z.embargo_months&&null!=Fe.embargo_months&&Fe.embargo_months<z.embargo_months&&(z.embargo_months=Fe.embargo_months),!0===Fe.can_archive&&(z.can_archive=!0),null==z.requirements&&(z.requirements={}),z.requirements.author_affiliation_requirement=null==e.ror?Fe.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],z.issuer.affiliation=Fe.issuer,null==z.meta&&(z.meta={}),z.meta.affiliation=Fe.meta,null==z.provenance&&(z.provenance={}),z.provenance.affiliation=Fe.provenance,z.score=parseInt(z.score)+parseInt(Fe.score),F.all_permissions.push(z)}}return W?{status:501,body:"string"==typeof W&&"not publisher"===W.toLowerCase()?"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it":W}:(!0===this.params.metadata&&(F.metadata=e),F)},t.permissions_new._log=!1,t.permissions_new.journals={example:async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.openalex.works('ids.doi:* AND locations.source.issn:"'+e.join('" OR locations.source.issn:"')+'"',1)).doi}catch(e){}}},t.permissions_new.journals.example._log=!1,t.permissions_new.journals.oa={type:async function(e,t,i,r){var s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E;if(null==e&&(e=null!=(h=null!=(f=null!=(k=null!=(j=null!=(S=this.params.journals)?S:this.params.journal)?j:this.params.type)?k:this.params.issn)?f:this.params.issns)?h:[]),n=null!=t,"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),null==i&&e.startsWith("10.")&&(i=await this.src.openalex.works.doi(e),null==r&&null==i&&(r=await this.src.crossref.works.doi(e)),e=[])),"string"==typeof e&&(e=e.split(",")),o="unknown",(null!=i?i.type_crossref:void 0)&&"journal-article"!==i.type_crossref||(null!=r?r.type:void 0)&&"journal-article"!==r.type)o="not applicable";else if(!((null!=i?i.type_crossref:void 0)&&"journal-article"!==i.type_crossref||(null!=r?r.type:void 0)&&"journal-article"!==r.type)){if(null!=i){for(a=0,u=(A=null!=(I=i.locations)?I:[]).length;a<u;a++)for((null!=(D=(p=A[a]).source)?D.is_in_doaj:void 0)&&(n=!0),l=0,c=(m=null!=(C=null!=(E=p.source)?E.issn:void 0)?C:[]).length;l<c;l++)(d=m[l])&&N.call(e,d)<0&&e.push(d);o="hybrid"!==(null!=(y=i.open_access)?y.oa_status:void 0)||n?n||"gold"===(null!=(g=i.open_access)?g.oa_status:void 0)?"gold":"closed":"hybrid"}"unknown"!==o||e||n||!(null!=r||(null!=i&&null!=(_=i.ids)?_.doi:void 0)&&(r=await this.src.crossref.works(i.ids.doi.split("doi.org/").pop())))||r.ISSN&&(e=r.ISSN),(e||null!=t)&&(null==t&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?o=!1===(null!=(v=t.bibjson)&&null!=(b=v.apc)?b.has_apc:void 0)?"diamond":"gold":e&&(await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?o="transformative":"closed"===o&&(await this.src.openalex.hybrid(e)?o="hybrid":"closed"!==(w=null!=i&&null!=(x=i.open_access)?x.oa_status:void 0)&&"bronze"!==w&&"green"!==w&&(s=await this.src.openalex.oa.type(e)).calculated&&"closed"!==(O=s.calculated)&&"bronze"!==O&&"green"!==O&&(o=s.calculated))))}return o}},t.permissions_new.journals.oa.type._log=!1,N=[].indexOf;try{r.report=JSON.parse(SECRETS_REPORT)}catch(e){}null==r.report&&(r.report={}),t.report=function(){return"OA.Works report"},t.report.chat=async function(e,t,i,r){var s,a,n;return(s=this.params.pmcid)&&(r=await this.src.epmc.xml(s),!0!==this.params.xml&&(r=r.split("<ref-list>")[0].replace(/\n/g," ").replace(/(<([^>]+)>)/gi,""))),null==e&&(e=null!=(a=this.params.prompt)?a:"Please return the data availability statement"),r&&(e+=" of the following research article: "+r),null==t&&(t=null!=(n=this.params.role)?n:"You are a terse text and data mining extraction tool in the scientific research publishing field"),r?this.src.openai.chat(e,t,this.params.model,this.params.json):{}},y=[],v=[],g=!1,u=[],c=[],f=[],h={},m={},p=[],d=!1,t.report._handle_queue=async function(){var e,t;if(!1===g&&(g=Date.now()),y.length>3e3||y.length&&Date.now()>g+3e4){for(C.log("handle queue saving batch",y.length),e=[];t=y.shift();)v.shift(),t.createdAt=Date.now(),null==t._id&&(t._id=t.identifier.toLowerCase()),e.push(t),e.length>=1e4&&(await this.report.queued(e),e=[]);e.length&&this.report.queued(e),g=Date.now()}return!1===d&&this.report._handle_processed(),setTimeout(this.report._handle_queue,5e3)},t.report._handle_processed=async function(){var e,t,i;if(!1===d&&(d=Date.now()),p.length>=3e3||p.length&&Date.now()>d+3e4){for(C.log("handle processed saving batch",p.length),i=p,p=[],e=c,c=[],this.report.works(i);t=e.shift();)await this.report.queued(t,"");d=Date.now()}return setTimeout(this.report._handle_processed,5e3)},t.report.queued={_index:!0},t.report.queue=async function(e,t,i,r,s="default"){var a,n,l,o,u,p,d,h,f,m,_,b,w,x,O,k;if(this.params.empty)if("string"==typeof this.params.empty)for await(o of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_queued",'action.keyword:"'+this.params.empty+'"'))await this.report.queued(o._id,"");else await this.report.queued("");if(null==e&&(e=null!=(u=null!=(p=null!=(d=this.params.queue)?d:this.params.doi)?p:this.params.openalex)?u:this.params.pmcid),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),e)for(n=0,l=(h=Array.isArray(e)?e:[e]).length;n<l;n++){a=h[n];try{(O="object"==typeof a?null!=(f=null!=(m=null!=(_=null!=(b=null!=(w=a.ident)?w:a.identifier)?b:a.DOI)?_:a.doi)?m:a.openalex)?f:a.pmcid:a).startsWith("w")&&(O=O.replace("w","W")),O.startsWith("pmc")&&(O=O.replace("pmc","PMC")),O.includes("10.")&&!(O=await this.report.cleandoi(O))||(k=O.toLowerCase(),O&&"string"==typeof O&&(O.startsWith("10.")||O.startsWith("W")||O.startsWith("PMC"))&&N.call(v,k)<0&&N.call(c,k)<0&&(v.push(k),x=!0===(x="object"==typeof a&&null!=a.refresh?a.refresh:null!=i?i:"undefined"!=typeof inq&&null!==inq?inq.refresh:void 0)?0:!1===x?void 0:x,y.push({identifier:O,refresh:x,everything:"object"==typeof a&&null!=a.everything?a.everything:null!=r?r:"undefined"!=typeof inq&&null!==inq?inq.everything:void 0,action:"object"==typeof a&&null!=a.action?a.action:s})))}catch(e){}}return!1===g&&this.report._handle_queue(),{queue:y.length}},t.report.queue._bg=!0,t.report.queue._log=!1,t.report.queue._auth="@oa.works",t.report._runqueue=async function(e,t,i,r){var s,a,n,l,o,p,d,h,m,_,v,b,w,x,O,k,j;if(null==t&&(t='action:"default"'),null==i&&(i="desc"),null!=e)t="for requested identifier "+e;else{if(u.length)t="";else if(r&&(!0===r&&(r=(s=(await this.report.queued(t,{size:1,sort:{createdAt:"asc"}})).createdAt)+Math.floor(((await this.report.queued(t,{size:1,sort:{createdAt:"desc"}})).createdAt-s)/2),C.log("queue midpoint",r)),t="("+t+") AND createdAt:"+("desc"===i?"<":">")+r),(null!=(o=await this.report.queued(t,{size:2e3,sort:{createdAt:i}}))&&null!=(d=o.hits)?d.total:void 0)||'action:"default"'!==t||(C.log("no queued records found for specified qry",t,"checking for any other queued records..."),o=await this.report.queued("NOT action:*",{size:2e3,sort:{createdAt:i}}),t="queried * as none for qry "+t),r&&(null!=o&&null!=(h=o.hits)?h.total:void 0)&&o.hits.total<5e3)C.log("not queueing on mid "+i+" queue when only "+o.hits.total+" records to process, waiting 5s..."),await this.sleep(5e3);else if("desc"!==i&&(null!=o&&null!=(_=o.hits)?_.total:void 0)&&o.hits.total<1e4)C.log("not queueing on reverse "+i+" queue when only "+o.hits.total+" records to process, waiting 5s..."),await this.sleep(5e3);else for((null!=o&&null!=(v=o.hits)?v.total:void 0)||y.length||(C.log("no queued records to process, waiting 5s..."),await this.sleep(5e3)),a=0,n=(x=null!=(b=null!=o&&null!=(w=o.hits)?w.hits:void 0)?b:[]).length;a<n;a++)O=(p=x[a])._source.identifier,N.call(f,O)<0&&(k=p._source.identifier,N.call(c,k)<0)&&(j=p._source.identifier,N.call(u,j)<0)&&u.push(p._source);e=null!=(m=null!=(l=u.shift())?l.identifier:void 0)?m:null!=l?l.DOI:void 0}if(C.log("report run queue",f.length,u.length),"string"==typeof e&&(e.startsWith("10.")||e.startsWith("W")||e.startsWith("PMC"))&&N.call(f,e)<0&&N.call(c,e)<0){for(await this.sleep(10);f.length>=5;)await this.sleep(500);f.push(e),this.report.works.process(e,void 0,null!=l?l.refresh:void 0,null!=l?l.everything:void 0,null!=l?l.action:void 0,void 0,e)}return!1===g&&this.report._handle_queue(),!0},t.report._doqueue=function(){return this.report._runqueue()},t.report._doqueue._log=!1,t.report._doqueue._bg=!0,t.report._domidqueue=function(){return this.report._runqueue(void 0,void 0,void 0,!0)},t.report._domidqueue._log=!1,t.report._domidqueue._bg=!0,t.report._domidreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc",!0)},t.report._domidreversequeue._log=!1,t.report._domidreversequeue._bg=!0,t.report._doreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc")},t.report._doreversequeue._log=!1,t.report._doreversequeue._bg=!0,t.report._dochangesqueue=function(){return this.report._runqueue(void 0,'action:"changes" OR action:"years"')},t.report._dochangesqueue._log=!1,t.report._dochangesqueue._bg=!0,t.report.dev2live=async function(e){var t,i,r,s,a,n,l;for await(a of("number"==typeof(l=this.params.toalias)&&(l+=""),s=this.params.org?'orgs.keyword:"'+this.params.org+'"':this.params.q,e?(r="paradigm_report_works",n="paradigm_b_report_works"):(r="paradigm_b_report_works",n="paradigm_report_works"),this.params.clear&&await this.index._send(n,"",void 0,!1,l),i=0,t=[],C.log("report works running",e?"live2dev":"dev2live",r,n,l,s),this.index._for(r,s,{scroll:"30m"})))i+=1,t.push(a),5e4===t.length&&(C.log("report works",e?"live2dev":"dev2live",r,n,l,i),await this.index._bulk(n,t,void 0,void 0,!1,l),t=[]);return t.length&&(C.log("report works",e?"live2dev":"dev2live",r,n,l,i,"remaining",t.length),await this.index._bulk(n,t,void 0,void 0,!1,l),t=[]),C.log(i,"report works",e?"live2dev":"dev2live",r,n,l,"complete",s?"for query "+s:""),i},t.report.dev2live._async=!0,t.report.dev2live._bg=!0,t.report.dev2live._auth="@oa.works",t.report.live2dev=function(){return this.report.dev2live(!0)},t.report.live2dev._async=!0,t.report.live2dev._bg=!0,t.report.live2dev._auth="root",t.report.oapolicy={_sheet:r.report.oapolicy_sheet,_format:function(e=[]){var t,i,r,s,a,n,l,o;for(n=[],r=0,s=(o="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<s;r++){for(i in a={},l=o[r]){if("string"==typeof l[i])if(l[i]=l[i].trim(),"true"===l[i].toLowerCase())l[i]=!0;else if("false"===l[i].toLowerCase())l[i]=!1;else if(l[i].startsWith("[")&&l[i].endsWith("]")||l[i].startsWith("{")&&l[i].endsWith("}"))try{l[i]=JSON.parse(l[i])}catch(e){t=e,C.log("cant parse "+i,l[i],t)}else l[i].includes(";")&&(l[i]=l[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(null!=l[i]&&""!==l[i])if(i.includes("."))try{this.dot(a,i,l[i])}catch(e){}else a[i]=l[i]}"{}"!==JSON.stringify(a)&&n.push(a)}return 1===n.length?n[0]:n}},t.report.cleandoi=function(e){var t;null==e&&(e=null!=(t=this.params.cleandoi)?t:this.params.doi);try{e=e.split(",http")[0]}catch(e){}try{e.startsWith("http")&&(e="10."+e.split("/10.")[1])}catch(e){}try{e.startsWith("doi ")&&(e=e.toLowerCase().replace("doi ",""))}catch(e){}try{e=e.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("&")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{e=e.split("#")[0]}catch(e){}try{e=e.replace(/#/g,"%23")}catch(e){}try{e=e.replace(/\,$/,"")}catch(e){}try{e=e.replace(/\.$/,"")}catch(e){}try{e.includes("(")||(e=e.replace(/\)$/,""))}catch(e){}if("string"==typeof e&&e.startsWith("10.")&&!e.includes("@"))return e},t.report.cleandoi._log=!1,b=[],t.report.publishers={_sheet:"1M2s1KBycWI5j7SIfIY0mzfkRC4cYr0HoROP7MR6k3GU"},t.report.orgs={_sheet:r.report.orgs_sheet,_format:async function(e=[],t){var i,r,s,a,n,l,o,u,c,p,d,h;for(u=[],s=0,n=(p="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<n;s++){for(r in o={},c=p[s]){if("string"==typeof c[r])if(c[r]=c[r].trim(),"true"===c[r].toLowerCase())c[r]=!0;else if("false"===c[r].toLowerCase())c[r]=!1;else if(c[r].startsWith("[")&&c[r].endsWith("]")||c[r].startsWith("{")&&c[r].endsWith("}"))try{c[r]=JSON.parse(c[r])}catch(e){i=e,C.log("cant parse "+r,c[r],i)}else c[r].includes(";")&&(c[r]=c[r].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(r.includes("."))try{this.dot(o,r,c[r])}catch(e){}else o[r]=c[r]}if(Array.isArray(o.sheets)){if(!1!==t)for(a=0,l=(d=o.sheets).length;a<l;a++)(h=d[a]).url=await this.encrypt(h.url)}else delete o.sheets;"{}"!==JSON.stringify(o)&&u.push(o)}return 1===u.length?u[0]:u}},t.report.orgs.orgkeys={_index:!0,_auth:"@oa.works"},t.report.orgs.key=async function(e){var t,i;if(null==e&&(e=this.params.org),null!=e){if(e=e.toLowerCase(),null==(i=await this.report.orgs.orgkeys('org.keyword:"'+e+'"',1))||this.refresh){if(null!=i){i.lastRefreshedAt=await this.epoch();try{i.lastRefreshedBy=this.user.email}catch(e){}}else{i={org:e,createdAt:await this.epoch()};try{i.createdBy=this.user.email}catch(e){}}return t=await this.uid(),i.key=await this.encrypt(t),await this.report.orgs.orgkeys(i),t}i.lastRetrievedAt=await this.epoch();try{i.lastRetrievedBy=this.user.email}catch(e){}return await this.report.orgs.orgkeys(i),this.decrypt(i.key)}},t.report.orgs.key._log=!1,t.report.orgs.key._auth="@oa.works",t.report.orgs.supplements={_index:!0,_auth:"@oa.works"},t.report.orgs.supplements.load=async function(e,t,i){var s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce;if(je=await this.epoch(),"report.orgs.supplements.load"===this.fn&&null==i&&(i=this.params.clear),i&&await this.report.orgs.supplements(""),null==e&&(e=this.params.org),null==t&&(t=this.params.sheet),q=await this.src.google.sheets(r.report.orgs_sheet),Ae=0,p=[],ge={},Oe=[],ke={},xe=[],!i)for await(Se of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements","replaced:*"))ge[Se.replaced]=Se.DOI;for(d=0,g=(T="object"!=typeof q||Array.isArray(q)?q:[q]).length;d<g;d++){for(n in S={},R=T[d]){if("string"==typeof R[n])if(R[n]=R[n].trim(),"true"===R[n].toLowerCase())R[n]=!0;else if("false"===R[n].toLowerCase())R[n]=!1;else if(R[n].startsWith("[")&&R[n].endsWith("]")||R[n].startsWith("{")&&R[n].endsWith("}"))try{R[n]=JSON.parse(R[n])}catch(e){}else R[n].includes(";")&&(R[n]=R[n].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(n.includes("."))try{await this.dot(S,n,R[n])}catch(e){}else S[n]=R[n]}if(Array.isArray(S.sheets))for(h=0,_=(V=S.sheets).length;h<_;h++)if(we=V[h],!(e&&S.name!==e||t&&we.name!==t)){if(C.log(S.name,we.name,we.url),P=0,I=[],o=[],ve=[],Ce=null==(ie=this.params.update)||ie,f=!1,Ie=[],await this.sleep(1e3),null==this.params.update)try{if(a=await this.src.google.sheets({sheetid:we.url,sheet:"m_admin",headers:!1}),await this.sleep(1e3),Array.isArray(a)&&a.length&&"last updated"===a[0][0].toLowerCase()&&(f=a[0][1])){if([y,O]=f.split(" "),y=y.split("/").reverse().join("-"),f=await this.epoch(y+"T"+O),C.log(S.name,we.name,"last updated",f),"number"==typeof f&&f>15778368e5){if(!(m=ke[we.name])){try{m=await this.report.orgs.supplements('sheets.keyword:"'+we.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=m&&null!=(pe=m.hits)?pe.hits:void 0)&&(m=m.hits.hits[0]._source,ke[we.name]=m)}(null!=m?m.updated:void 0)&&f<=m.updated&&(Ce=f)}}else if(Array.isArray(a)&&a.length){if(!(m=ke[we.name])){try{m=await this.report.orgs.supplements('sheets.keyword:"'+we.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=m&&null!=(de=m.hits)?de.hits:void 0)&&(m=m.hits.hits[0]._source,ke[we.name]=m)}(null!=m?m.updated:void 0)&&m.updated>=je-864e5&&(Ce=!1)}else Ce=!1}catch(e){Ce=!1}if(!0!==Ce)C.log(S.name,we.name,"NOT loading because",f,"is not after",Ce);else{await this.sleep(1e3);try{ve=await this.src.google.sheets({sheetid:we.url,sheet:"Export",headers:!1})}catch(e){}for(De=0;(!Array.isArray(ve)||!ve.length)&&De<5;){await this.sleep(5e3),De+=1;try{ve=await this.src.google.sheets({sheetid:we.url,sheet:"Export",headers:!1})}catch(e){}}if(Array.isArray(ve)&&ve.length){for(k=0,v=(he=ve.shift()).length;k<v;k++)l=he[k],o.push(l.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(j=0,b=ve.length;j<b;j++){for(u in _e=ve[j],P+=1,be={org:S.name,sheets:we.name,ror:S.ror,paid:!0===S.paid?S.paid:void 0},o)if("pmcid"===(n=o[u]).toLowerCase())be[n]=_e[u],be.pmcid="PMC"+_e[u].toLowerCase().replace("pmc","");else if("doi"===n||"DOI"===n)be[n]=_e[u];else{if(c="","apc_cost"===n||"wellcome.apc_paid_actual_currency_excluding_vat"===n||"wellcome.apc_paid_gbp_inc_vat_if_charged"===n||"wellcome.additional_publication_fees_gbp"===n||"wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp"===n||"wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp"===n||"wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"===n)try{c=parseFloat(_e[u])}catch(e){}else c="number"==typeof _e[u]?_e[u]:_e[u]?"true"===(fe=_e[u].trim().toLowerCase())||"yes"===fe||"false"!==(me=_e[u].trim().toLowerCase())&&"no"!==me&&("grant_id"===(ye=n.toLowerCase())||"ror"===ye?_e[u].replace(/\//g,",").replace(/ /g,"").split(","):_e[u]):void 0,"string"==typeof _e[u]&&_e[u].includes(";")&&(c=_e[u].split(";"));null!=c&&""!==c&&(n.includes(".")?await this.dot(be,n,c):be[n]=c)}be.doi?null==be.DOI&&(be.DOI=be.doi+""):be.doi=(null!=(M=be.DOI)?M:"")+"";try{be.DOI.startsWith("http")&&(be.DOI="10."+be.DOI.split("/10.")[1])}catch(e){}try{be.DOI.startsWith("doi ")&&(be.DOI=be.DOI.toLowerCase().replace("doi ",""))}catch(e){}try{be.DOI=be.DOI.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{be.DOI=be.DOI.split(",http")[0]}catch(e){}("string"==typeof be.DOI&&be.DOI.startsWith("10.")&&!be.DOI.includes("@")||be.openalex||be.pmcid)&&(!i&&be.DOI&&null!=ge[be.DOI]&&(be.replaced=be.DOI,be.DOI=ge[be.DOI]),"string"==typeof be.email&&be.email.includes("@")&&(be.email=await this.encrypt(be.email)),be.osdid=(S.name.replace(/[^a-zA-Z0-9-_ ]/g,"")+"_"+we.name+"_"+(null!=(W=null!=(U=be.DOI)?U:be.openalex)?W:be.pmcid)).replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),be._id=be.osdid,I.push(be.osdid),z=null!=(F=null!=(B=be.DOI)?B:be.openalex)?F:be.pmcid,N.call(p,z)<0&&p.push(null!=(J=null!=(X=be.DOI)?X:be.openalex)?J:be.pmcid),be.updated=je,Ie.push(be),Ae+=1)}C.log(S.name,we.name,Ie.length,p.length),await this.report.orgs.supplements(Ie)}for await(Se of(await this.sleep(2e3),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'org.keyword:"'+S.name+'" AND sheets.keyword:"'+we.name+'"',{scroll:"30m",include:["osdid","DOI","openalex","pmcid"]})))$=Se.osdid,N.call(I,$)<0&&(await this.report.orgs.supplements(Se.osdid,""),G=null!=(Y=null!=(H=Se.DOI)?H:Se.openalex)?Y:Se.pmcid,N.call(p,G)<0&&p.push(null!=(Z=null!=(Q=Se.DOI)?Q:Se.openalex)?Z:Se.pmcid))}Oe.push({org:S.name,sheet:we.name,rows:P,update:Ce,supplements:Ie.length}),xe.push(we.name)}}if(!i&&!e&&!t)for(D=0,w=(K=await this.report.works.suggest("supplements.sheets",void 0,5e3)).length;D<w;D++)if(s=K[D],N.call(xe,s)<0){for await(Se of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'sheets.keyword:"'+s+'"',{scroll:"30m",include:["osdid"]}))await this.report.orgs.supplements(Se.osdid,"");for await(A of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",'supplements.sheets.keyword:"'+s+'"',{scroll:"30m",include:["DOI","openalex","pmcid"]}))(A.DOI&&(ee=A.DOI,N.call(p,ee)<0)||!A.DOI&&A.openalex&&(te=A.openalex,N.call(p,te)<0)||!A.DOI&&!A.openalex&&A.pmcid&&(re=A.pmcid,N.call(p,re)<0))&&p.push(null!=(se=null!=(ae=A.DOI)?ae:A.openalex)?se:A.pmcid)}if(i)for(L=0,x=(ne=await this.report.works("orgs:* OR supplements.sheets:*",{include:["DOI","openalex","pmcid"]})).length;L<x;L++)((E=ne[L]).DOI&&(le=E.DOI,N.call(p,le)<0)||!E.DOI&&E.openalex&&(oe=E.openalex,N.call(p,oe)<0)||!E.DOI&&!E.openalex&&E.pmcid&&(ue=E.pmcid,N.call(p,ue)<0))&&p.push(null!=(ce=E.DOI)?ce:E.openalex);return await this.sleep(6e4),C.log("report orgs supplements load",Ae,p.length,await this.epoch()-je),p.length&&(C.log("report orgs supplements load ready to call works load",p.length),await this.report.works.load(void 0,void 0,p,void 0,void 0,je,void 0,Oe)),Ae},t.report.orgs.supplements.load._bg=!0,t.report.orgs.supplements.load._async=!0,t.report.orgs.supplements.load._log=!1,t.report.orgs.queries=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g;for await(a of(null==e&&(e=this.params.org),null==t&&(t=null!=(u=this.params.queries)?u:this.params.doi),g={},r=[],n=0,this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs",e?'name:"'+e+'"':"paid:true",{scroll:"30m"})))for(i in null!=(c=a.analysis)?c:[])if(null!=a.analysis[i].query&&(0==(p=!a.analysis[i].make_key)||"false"===p||"False"===p||"FALSE"===p))for await(o of(l=a.analysis[i].query,t&&(l="("+l+') AND  DOI.keyword:"'+t+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",l,{scroll:"30m"})))s=null==(d=a.analysis[i].value)||d,a.analysis[i].list&&(s=[s]),t?g[null!=(h=null!=(f=a.analysis[i].key)?f:a.analysis[i].name)?h:i]=s:(o[null!=(m=null!=(y=a.analysis[i].key)?y:a.analysis[i].name)?m:i]=s,r.push(o),n+=1,r.length>2e4&&(await this.report.works(r),r=[]));return r.length&&await this.report.works(r),t?g:n},t.report.orgs.queries._log=!1,t.report.orgs.queries._bg=!0,t.report.orgs.queries._async=!0,t.report.orgs.queries._auth="@oa.works",t.report.emails={_sheet:r.report.emails_sheet,_key:"doi",_auth:"@oa.works"},t.report.email=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h;if((e||this.params.orgkey)&&(null==e&&(e=null!=(n=this.params.email)?n:this.params.doi),null!=e&&(t=null!=(l=null!=(a=await this.report.works(e))?a.email:void 0)?l:null!=a&&null!=(o=a.outreach)?o.email_address:void 0))){if(t.includes("@"))return t;if(h=await this.encrypt(this.params.orgkey),"string"==typeof(null!=(s=await this.report.orgs.orgkeys('key.keyword:"'+h+'"',1))?s.org:void 0)&&s.org.length){for(p=[],i=0,r=(u=a.orgs).length;i<r;i++)d=u[i],p.push(d.toLowerCase());if(N.call(p,"gates foundation")>=0&&s.org.toLowerCase().includes("gates foundation"))return this.decrypt(t);if(c=s.org.toLowerCase(),N.call(p,c)>=0)return this.decrypt(t)}}},t.report.email._log=!1;try{t.oareport.email=t.report.email}catch(e){}t.report.works={_index:!0},t.report.works.process=async function(e,t,i,r,s,a,n){var l,o,u,d,y,g,_,v,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Ee,Ne,Le,Pe,Re,qe,Te,Me,We,Ue,ze,Fe,Be,Je,Xe,$e,Ve,Ge,Ye,He,Ze,Qe,Ke,et,tt,it,rt,st,at,nt,lt,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Et,Nt,Lt,Pt,Rt,qt,Tt,Mt,Wt,Ut,zt,Ft,Bt,Jt,Xt,$t,Vt,Gt,Yt,Ht,Zt,Qt,Kt,ei,ti,ii,ri,si,ai,ni,li,oi,ui,ci,pi,di,hi,fi,mi,yi,gi,_i,vi,bi,wi,xi,Oi,ki,ji,Si,Ii,Ai,Di,Ci,Ei,Ni,Li,Pi,Ri,qi,Ti,Mi,Wi,Ui,zi,Fi,Bi,Ji,Xi,$i,Vi,Gi;try{if(Ri=await this.epoch(),null==e&&(e=this.params.process),M=!1,0===i&&(i=!0),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),Ve={},"string"==typeof e&&e.toLowerCase().startsWith("pmc")&&(M=e.toLowerCase().replace("pmc","PMC"),e=void 0,null==t&&(t=await this.src.openalex.works('ids.pmcid:"'+M.toLowerCase().replace("pmc","")+'"',1)),null==t&&(L=await this.src.epmc.pmc(M,i))&&(e=L.doi)),!t&&e&&(e.includes("openalex.org/")||e.startsWith("W"))&&(e.includes("openalex.org/")&&(e=e.split("openalex.org/")[1]),t=e,e=void 0),"string"==typeof t&&((t=(t=t.split(t.includes("doi.org")?"doi.org/":"/").pop()).replace(/\/$/,"")).startsWith("10.")&&(t=t.toLowerCase(),null==e&&(e=t)),t.startsWith("W")||t.startsWith("10.")))try{Ce=t.startsWith("W")?await this.src.openalex.works('id.keyword:"https://openalex.org/'+t+'"'):await this.src.openalex.works.doi(t,null!=(Ge=this.params.refresh_sources)&&Ge);try{(null!=Ce&&null!=(Ye=Ce.hits)&&null!=(nt=Ye.hits)?nt.length:void 0)&&(Ce=Ce.hits.hits[0]._source)}catch(e){}(null!=Ce?Ce.id:void 0)&&(t=Ce)}catch(e){}if(("object"==typeof t&&(null!=(yt=t.ids)?yt.doi:void 0)||"string"==typeof t&&t.startsWith("10."))&&(Li=("string"==typeof t?t:t.ids.doi.split(".org/")[1]).toLowerCase(),(null!=(R=await this.report.works(Li))?R.DOI:void 0)&&R.DOI.toLowerCase()!==Li&&(R=void 0),((null!=R?R.updated:void 0)||i&&!0!==i&&R&&R.updated<i)&&(i=!0)),"string"!=typeof t||t.startsWith("W")||t.startsWith("10.")||(t=void 0),null==e&&"object"==typeof t&&(null!=t&&null!=(It=t.ids)?It.doi:void 0)&&(e=t.ids.doi),"string"==typeof e&&e.includes("doi.org/")&&(e=e.split("doi.org/").pop()),"string"!=typeof e||e.startsWith("10.")||(e=void 0),"string"==typeof e&&(e=e.toLowerCase()),"string"==typeof e&&($i=await this.src.crossref.works.doi(e,null!=(Tt=this.params.refresh_sources)&&Tt))&&(e=$i),"object"!=typeof e||e.DOI||(e=void 0),null!=e&&null==R&&(R=await this.report.works("string"==typeof e?e:e.DOI)),(null!=R?R.DOI:void 0)&&R.DOI.toLowerCase()!==("string"==typeof e?e:"object"==typeof e&&e.DOI?e.DOI:"").toLowerCase()&&(R=void 0),!0!==i&&(null==R||r||(null!=R.PMCID&&"PMC"!==R.PMCID&&(Ve.PMCID=R.PMCID),null!=R.pubtype&&(Ve.pubtype=R.pubtype),null!=R.tried_epmc_licence&&(Ve.tried_epmc_licence=R.tried_epmc_licence),null!=R.epmc_licence&&(Ve.epmc_licence=R.epmc_licence),R.pmc_has_data_availability_statement&&(Ve.pmc_has_data_availability_statement=R.pmc_has_data_availability_statement),null!=R.data_availability_statement&&(Ve.data_availability_statement=R.data_availability_statement),null!=R.data_availability_url&&(Ve.data_availability_url=R.data_availability_url),null!=R.data_availability_doi&&(Ve.data_availability_doi=R.data_availability_doi)),(!(null!=R?R.updated:void 0)||i&&!0!==i&&R&&R.updated<i)&&(i=!0)),null!=e&&null==t&&(t=await this.src.openalex.works.doi("object"==typeof e?e.DOI:e,null!=(Gt=this.params.refresh_sources)&&Gt)),"string"!=typeof t&&(null!=t?t.id:void 0)||(t=void 0),"object"==typeof e&&e.DOI){for((null!=R?R.updated:void 0)&&(null!=(ai=e.indexed)?ai.timestamp:void 0)&&R.updated<e.indexed.timestamp&&(i=!0),Ve.DOI=e.DOI.toLowerCase(),Ve.published_year=e.year,Ve.published_date=e.published,Ve.issn=e.ISSN,U=0,V=(yi=["subject","subtitle","volume","issue","publisher","funder","subtype","assertion","relation"]).length;U<V;U++)Ve[S=yi[U]]=e[S];for(He=null!=(Si=e.assertion)?Si:[],J=0,G=He.length;J<G;J++)(y=(null!=(Ze=(d=He[J]).label)?Ze:"").toLowerCase()).includes("accepted")&&y.split(" ").length<3&&(null!=(u=await this.dateparts(d.value))?u.date:void 0)&&(u.timestamp?null==Ve.accepted_date&&(Ve.accepted_date=u.date):null==Ve.bad_accepted_date&&(Ve.bad_accepted_date="bad date "+u.date)),y.includes("received")&&(null!=(Ni=await this.dateparts(d.value))?Ni.date:void 0)&&(Ni.timestamp?null==Ve.submitted_date&&(Ve.submitted_date=Ni.date):null==Ve.bad_submitted_date&&(Ve.bad_submitted_date="bad date "+Ni.date));for(Ke=null!=(Qe=Ve.funder)?Qe:[],xe=0,ae=Ke.length;xe<ae;xe++)delete(q=Ke[xe])["doi-asserted-by"];for(e.title&&"string"!=typeof e.title&&e.title.length&&(Ve.title=e.title[0]),e["container-title"]&&e["container-title"].length&&(Ve.journal=e["container-title"][0]),null!=e["reference-count"]&&(Ve["reference-count"]=e["reference-count"]),tt=null!=(et=e.license)?et:[],je=0,de=tt.length;je<de;je++)"am"!==(it=($=tt[je])["content-version"])&&"vor"!==it&&"tdm"!==it&&"unspecified"!==it||(Ve["crossref_license_url_"+$["content-version"]]=$.URL,(!Ve.publisher_license_crossref||Ve.publisher_license_crossref.length<$.URL.length)&&(Ve.publisher_license_crossref=$.URL));for(Ve.crossref_is_oa=null!=e.is_oa&&e.is_oa,x=[],l=async(t,i)=>(t.DOI=e.DOI,t.replaced=i,await this.report.orgs.supplements(t.osdid,""),t._id=t.osdid=t.osdid.split("_10.")[0]+"_"+t.DOI.replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),x.push(t)),st=null!=(rt=e["update-to"])?rt:[],Ee=0,he=st.length;Ee<he;Ee++)if((Ui=st[Ee]).DOI!==e.DOI&&Ui.type&&"erratum"!==(at=Ui.type.toLowerCase())&&"correction"!==at)for await(qi of(Ve.replaces=[],Ve.replaces.push({DOI:Ui.DOI,type:Ui.type,updated:null!=(lt=Ui.updated)?lt.timestamp:void 0}),await this.report.works(Ui.DOI)&&await this.report.works(Ui.DOI,""),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+Ui.DOI+'"')))l(qi,Ui.DOI);x.length&&await this.report.orgs.supplements(x),a&&(null==Ve.replaces&&(Ve.replaces=[]),Ve.replaces.push({DOI:a,type:"relation"}))}if(null!=t){try{(null!=R?R.updated:void 0)&&!t.is_paratext&&!t.is_retracted&&t.updated_date&&R.updated<await this.epoch(t.updated_date)&&(i=!0)}catch(e){}for(Ve.openalx=JSON.parse(JSON.stringify(t)),Je=0,fe=(ot=["topics","primary_topic","keywords","concepts","domains","fields","subfields"]).length;Je<fe;Je++)I=ot[Je],delete Ve.openalx[I];for(Ve.publisher_license_v2=null!=(ut=Ve.openalx.primary_location)?ut.license:void 0,pt=null!=(ct=Ve.openalx.locations)?ct:[],Mi=0,me=pt.length;Mi<me;Mi++)(be=pt[Mi]).license&&(!Ve.publisher_license_v2||be.license.length<Ve.publisher_license_v2)&&"journal"===(null!=(dt=be.source)?dt.type:void 0)&&(Ve.publisher_license_v2=be.license),be.license&&(!Ve.repository_license_v2||be.license.length<Ve.repository_license_v2)&&"repository"===(null!=(ht=be.source)?ht.type:void 0)&&(Ve.repository_license_v2=be.license);for(t.id&&(Ve.openalex=t.id.split("/").pop()),Ve.DOI||null==(null!=(ft=t.ids)?ft.doi:void 0)||(Ve.DOI=t.ids.doi.split("doi.org/").pop().toLowerCase()),(null!=(mt=t.ids)?mt.pmid:void 0)&&(Ve.PMID=t.ids.pmid.split("/").pop()),!Ve.PMCID&&(null!=(gt=t.ids)?gt.pmcid:void 0)&&(Ve.PMCID="PMC"+t.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),t.title&&(Ve.title=t.title),Fi=0,ye=(_t=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;Fi<ye;Fi++)Ve[De=_t[Fi]]=t[De];for(t.publication_date&&(Ve.published_date=t.publication_date),t.publication_year&&(Ve.published_year=t.publication_year),(null!=(vt=t.host_venue)?vt.issn:void 0)&&t.host_venue.issn.length&&(Ve.issn=t.host_venue.issn),t.biblio&&(Ve.biblio=t.biblio),t.referenced_works&&(Ve.referenced_works=t.referenced_works.length),wt=null!=(bt=Ve.concepts)?bt:[],Ji=0,ge=wt.length;Ji<ge;Ji++){delete(O=wt[Ji]).wikidata;try{O.score=Math.floor(100*O.score)}catch(e){}}for(Ot=null!=(xt=Ve.authorships)?xt:[],Xi=0,_e=Ot.length;Xi<_e;Xi++){for(jt=null!=(kt=(o=Ot[Xi]).institutions)?kt:[],Vi=0,Y=jt.length;Vi<Y;Vi++)delete jt[Vi].type;(null!=(St=o.author)?St.orcid:void 0)&&o.author.orcid.includes("orcid.org/")&&(o.author.orcid_number=o.author.orcid.split("/").pop())}}if(Ve.DOI||"string"!=typeof e||(Ve.DOI=e.toLowerCase()),M&&!Ve.PMCID&&(Ve.PMCID=M),Ve.DOI){for(Ae=await this.src.oadoi.doi(Ve.DOI,24192e5),Ve.oadoi=null!=Ae,Dt=null!=(At=null!=Ae?Ae.oa_locations:void 0)?At:[],Gi=0,H=Dt.length;Gi<H;Gi++)if("publisher"===(we=Dt[Gi]).host_type&&(null==Ve.publisher_license&&(Ve.publisher_license=we.license),null==Ve.publisher_url_for_pdf&&(Ve.publisher_url_for_pdf=we.url_for_pdf),null==Ve.publisher_version&&(Ve.publisher_version=we.version)),"repository"===we.host_type&&(we.url&&we.url.toLowerCase().includes("pmc")&&(Ve.PMCID||(Me=we.url.toLowerCase().split("pmc").pop().split("articles/").pop().split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(Me))&&(Ve.PMCID="PMC"+Me),we.license&&!Ve.epmc_licence&&(Ve.epmc_licence=we.license)),!Ve.repository_url||!Ve.repository_url.includes("pmc")||!Ve.repository_url.includes("ncbi.")&&we.url.includes("ncbi.")))for(W=0,Z=(Ct=["license","url_for_pdf","url","version"]).length;W<Z;W++)we[De=Ct[W]]&&(Ve["repository_"+De]=we[De]);Ve.repository_url&&(Ve.repository_url.toLowerCase().includes("europepmc.")||Ve.repository_url.toLowerCase().includes("ncbi."))&&(null==Ve.PMCID&&(Ve.PMCID="PMC"+Ve.repository_url.toLowerCase().split("pmc").pop().split("articles/").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),Ve.repository_url_in_pmc=!0),null!=Ae&&(Ve.best_oa_location_url=null!=(Et=Ae.best_oa_location)?Et.url:void 0,Ve.best_oa_location_url_for_pdf=null!=(Nt=Ae.best_oa_location)?Nt.url_for_pdf:void 0,Ve.oa_status=Ae.oa_status,Ve.has_repository_copy=Ae.has_repository_copy,Ve.has_oa_locations_embargoed=!(null==Ae.oa_locations_embargoed||!Ae.oa_locations_embargoed.length),Ve.title=Ae.title,!Ve.issn&&"string"==typeof Ae.journal_issns&&Ae.journal_issns.length&&(Ve.issn=Ae.journal_issns.split(",")),null==Ve.journal&&(Ve.journal=Ae.journal_name),null==Ve.publisher&&(Ve.publisher=Ae.publisher),Ae.published_date&&(Ve.published_date=Ae.published_date),Ae.year&&(Ve.published_year=Ae.year),null!=Ae.is_oa&&(Ve.oadoi_is_oa=Ae.is_oa))}if(j=[],Ve.supplements=[],Ve.orgs=[],ke=void 0,Ve.DOI||Ve.openalex||Ve.PMCID)for await(qi of(Pi="",Ve.DOI&&(Pi+='DOI.keyword:"'+Ve.DOI+'"'),Ve.openalex&&(Pi+=(Pi?" OR ":"")+'openalex.keyword:"'+Ve.openalex+'"'),Ve.PMCID&&(Pi+=(Pi?" OR ":"")+'pmcid.keyword:"'+Ve.PMCID+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",Pi,{sort:{"osdid.keyword":"asc"}}))){if(Lt=qi.org,N.call(Ve.orgs,Lt)<0&&Ve.orgs.push(qi.org),qi.paid&&(Ve.paid=!0),!Ve.email&&qi.email&&(Ve.email=qi.email),qi.author_email_name_ic&&(Ve.author_email_name=qi.author_email_name_ic),null!=qi.mturk_has_data_availability_statement&&(ke=qi.mturk_has_data_availability_statement),qi.corresponding_author_ids)for(Pt="string"==typeof qi.corresponding_author_ids?qi.corresponding_author_ids.split(","):qi.corresponding_author_ids,z=0,Q=Pt.length;z<Q;z++)k=Pt[z],N.call(j,k)<0&&j.push(k);Ve.supplements.push(qi)}for(Mt=null!=(Rt=null!=(qt=Ve.openalx)?qt.corresponding_author_ids:void 0)?Rt:[],B=0,K=Mt.length;B<K;B++)k=Mt[B],N.call(j,k)<0&&j.push(k);for(Ve.corresponding_authors=[],zt=null!=(Wt=null!=(Ut=Ve.openalx)?Ut.authorships:void 0)?Wt:[],X=0,ee=zt.length;X<ee;X++)Ft=null!=(Bt=(g=zt[X]).author)?Bt.id:void 0,N.call(j,Ft)>=0&&Ve.corresponding_authors.push(g);if(null!=(null!=(Jt=Ve.openalx)?Jt.authorships:void 0)&&null==Ve.openalx.authors_count&&(Ve.openalx.authors_count=Ve.openalx.authorships.length),null!=R){if(null==i)for(F in!Ve.author_email_name&&R.author_email_name&&R.email&&Ve.email&&Ve.email.toLowerCase()===R.email.toLowerCase()&&(Ve.author_email_name=R.author_email_name),R)"orgs_by_query"!==F&&"PMCID"!==F&&null==Ve[F]&&(Ve[F]=R[F]);Ve.PMCID&&"PMC"!==Ve.PMCID||null==R.PMCID||"PMC"===R.PMCID||(Ve.PMCID=R.PMCID)}if(null!=Ve.authorships&&Ve.email&&!Ve.author_email_name&&(i||null==(null!=R?R.authorships:void 0)||!(null!=R?R.email:void 0)))if(E=Ve.email.includes("@")?Ve.email:await this.decrypt(Ve.email),1===Ve.authorships.length)Ve.author_email_name="Dr. "+(null!=(Xt=Ve.authorships[0].author)?Xt.display_name:void 0);else{for(Ii=E.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),_="",v="",w=1e6,$t=Ve.authorships,Oe=0,te=$t.length;Oe<te;Oe++)($e=null!=(Vt=$t[Oe].author)?Vt.display_name:void 0)&&((Ei=(await this.levenshtein(Ii,$e.toLowerCase().replace(/[^a-z]/g,""))).distance/$e.length)<w&&(w=Ei,v=$e),w>.2&&(Ii.endsWith($e.split(" ").pop().toLowerCase())||$e.split(" ")[0].length>4&&Ii.includes($e.split(" ")[0].toLowerCase()))&&(w=.1,v=$e),!_&&Ii.startsWith(($e.split(" ")[0].slice(0,1)+$e.split(" ").pop().slice(0,1)).toLowerCase())&&(_=$e));v&&w<.7&&(Ve.author_email_name="Dr. "+v.split(" ").pop()),!Ve.author_email_name&&_&&(Ve.author_email_name="Dr. "+_)}if("string"==typeof Ve.email&&Ve.email.includes("@")&&(Ve.email=await this.encrypt(Ve.email)),Ve.publisher&&(null!=i||!Ve.publisher_simple)){if(!b.length)for(Di=await this.report.publishers("*",1e4),Array.isArray(Di)||null==(null!=Di&&null!=(Yt=Di.hits)?Yt.hits:void 0)||(Di=Di.hits.hits),Se=0,ie=(Ht=null!=Di?Di:[]).length;Se<ie;Se++)Ai=Ht[Se],b.push(null!=(Zt=Ai._source)?Zt:Ai);for(ze=Ve.publisher.toLowerCase(),Ie=0,re=b.length;Ie<re;Ie++)if((Ue=b[Ie]).publisher&&ze.includes(Ue.publisher.toLowerCase())){Ve.publisher_simple=Ue.publisher_display_name;break}}for(Ve.PMCID&&Ve.PMID&&null!=Ve.pubtype&&Ve.submitted_date&&Ve.accepted_date||(Fe=Ve.PMID?await this.src.pubmed(Ve.PMID):Ve.DOI?await this.src.pubmed.doi(Ve.DOI):void 0)&&(!Ve.PMCID&&(null!=Fe&&null!=(Qt=Fe.identifier)?Qt.pmc:void 0)&&(Ve.PMCID="PMC"+Fe.identifier.pmc.toLowerCase().replace("pmc","")),!Ve.PMID&&(null!=Fe&&null!=(Kt=Fe.identifier)?Kt.pubmed:void 0)&&(Ve.PMID=Fe.identifier.pubmed),Ve.pubtype=Fe.type,null==Ve.submitted_date&&(Ve.submitted_date=null!=(ei=Fe.dates)&&null!=(ti=ei.PubMedPubDate_received)?ti.date:void 0),null==Ve.accepted_date&&(Ve.accepted_date=null!=(ii=Fe.dates)&&null!=(ri=ii.PubMedPubDate_accepted)?ri.date:void 0)),Ve.DOI&&!Ve.journal_oa_type&&(Le=await this.permissions(await this.copy(Ve),void 0,void 0,Ae,e,Ri-12096e5),Ve.can_archive=null!=Le&&null!=(si=Le.best_permission)?si.can_archive:void 0,null==Ve.can_archive&&((null!=(ni=null!=Ae&&null!=(li=Ae.best_oa_location)?li.license:void 0)?ni:"").includes("cc")||(null!=Ae?Ae.journal_is_in_doaj:void 0))&&(Ve.can_archive=!0),Ve.version=null!=Le&&null!=(oi=Le.best_permission)?oi.version:void 0,Ve.journal_oa_type=await this.permissions.journals.oa.type(Ve.issn,void 0,Ae,e),null==Ve.journal_oa_type&&(Ve.journal_oa_type="unsuccessful")),ci=null!=(ui=Ve.orgs)?ui:[],Ne=0,se=ci.length;Ne<se;Ne++)if("fwf austrian science fund"!==(qe=(Re=ci[Ne]).toLowerCase().trim())&&"dutch research council"!==qe&&"national science center"!==qe&&"uk research and innovation"!==qe&&"agencia nacional de investigación y desarrollo"!==qe&&"national natural science foundation of china"!==qe&&"research foundation - flanders"!==qe&&"ministry of business, innovation and employment"!==qe&&"german research foundation"!==qe&&"national cancer institute"!==qe)r=!0;else if(Ve.funder)try{if(qe=qe.replace(/[^a-z ]/g,""),null==m[qe]&&(m[qe]=await this.report.orgs('name.keyword:"'+Re+'"',1)),null!=(pi=m[qe])?pi.country_code:void 0)for(di=Ve.funder,Be=0,ne=di.length;Be<ne;Be++){if((q=di[Be]).DOI&&m[qe].fundref)for(hi="string"==typeof m[qe].fundref?[m[qe].fundref]:m[qe].fundref,Xe=0,le=hi.length;Xe<le;Xe++)if(Te=hi[Xe],q.DOI.includes(Te)){q.country=m[qe].country_code;break}if(!q.country&&q.name){if(((T=q.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(qe)||qe.includes(T)||(null!=(fi=m[qe].aliases)?fi:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(T)||(null!=(mi=m[qe].acronyms)?mi:"").toLowerCase().includes(T))&&(q.country=m[qe].country_code),!q.country&&m[qe].acronyms)for(gi=m[qe].acronyms.split(","),Ci=0,oe=gi.length;Ci<oe;Ci++)_i=gi[Ci].replace(/[^a-z A-Z]/g,""),N.call(q.name.split(" "),_i)>=0&&(q.country=m[qe].country_code);if(!q.country&&m[qe].aliases)for(vi=m[qe].aliases,Ti=0,ue=vi.length;Ti<ue;Ti++)Pe=vi[Ti],T.includes(Pe.toLowerCase().replace(/[^a-z ]/g,""))&&(q.country=m[qe].country_code)}}}catch(e){}if((Ve.DOI||Ve.PMCID)&&(null!=L||!Ve.PMCID||null==Ve.pubtype)&&(null!=L||r&&(L=Ve.PMCID?await this.src.epmc.pmc(Ve.PMCID,i):await this.src.epmc.doi(Ve.DOI,i))))for(!Ve.PMCID&&L.pmcid&&(Ve.PMCID=L.pmcid),xi=null!=(bi=null!=(wi=L.pubTypeList)?wi.pubType:void 0)?bi:[],Wi=0,ce=xi.length;Wi<ce;Wi++)We=xi[Wi],null==Ve.pubtype&&(Ve.pubtype=[]),N.call(Ve.pubtype,We)<0&&Ve.pubtype.push(We);if(!r&&null==L||!Ve.PMCID||Ve.epmc_licence||!i&&Ve.tried_epmc_licence||(Ve.tried_epmc_licence=!0,ve=await this.src.epmc.licence(Ve.PMCID,L,void 0,i),Ve.epmc_licence=null!=ve?ve.licence:void 0),Ve.pmc_has_data_availability_statement||(Ve.pmc_has_data_availability_statement=Ve.PMCID&&await this.src.pubmed.availability(Ve.PMCID)),r&&Ve.PMCID&&(i||!Ve.data_availability_statement||!Ve.submitted_date)){if(Ve.data_availability_statement=await this.src.epmc.statement(Ve.PMCID,L,i),Ve.data_availability_statement&&(zi=await this.src.epmc.statement.url(Ve.PMCID,L,Ve.data_availability_statement)))for(Bi=0,pe=zi.length;Bi<pe;Bi++)(A=zi[Bi]).includes("doi.org/")?(D=A.split("doi.org/")[1].toLowerCase(),null==Ve.data_availability_doi&&(Ve.data_availability_doi=[]),N.call(Ve.data_availability_doi,D)<0&&Ve.data_availability_doi.push(D)):(null==Ve.data_availability_url&&(Ve.data_availability_url=[]),N.call(Ve.data_availability_url,A)<0&&Ve.data_availability_url.push(A));null==Ve.submitted_date&&(Ve.submitted_date=await this.src.epmc.submitted(Ve.PMCID,L))}return(Ve.PMCID||(null!=(Oi=Ve.openalx)&&null!=(ki=Oi.open_access)?ki.any_repository_has_fulltext:void 0))&&(Ve.has_repository_copy=!0),Ve.is_oa=Ve.oadoi_is_oa||Ve.crossref_is_oa||"gold"===Ve.journal_oa_type,Ve.has_data_availability_statement=!!(Ve.pmc_has_data_availability_statement||ke||Ve.DOI&&(Ve.DOI.startsWith("10.1186")||Ve.DOI.startsWith("10.12688")||Ve.DOI.startsWith("10.1371")))||(null!=(ji=Ve.pmc_has_data_availability_statement)?ji:ke),null==Ve._id&&(Ve._id=Ve.DOI?Ve.DOI.toLowerCase().replace(/\//g,"_"):Ve.openalex?Ve.openalex.toLowerCase():Ve.PMCID?Ve.PMCID.toLowerCase():void 0),Ve.supplemented=await this.epoch(),Ve.updated=Ve.supplemented,Ve.took=Ve.supplemented-Ri,Ve.supplemented_date=await this.datetime(Ve.supplemented),Ve.updated_date=await this.datetime(Ve.updated),this.params.process&&!1!==this.params.save&&(Ve.DOI&&Ve.DOI.toLowerCase()===this.params.process.toLowerCase()||Ve.openalex&&Ve.openalex.toLowerCase()===this.params.process.toLowerCase()||Ve.PMCID&&Ve.PMCID.toLowerCase()===this.params.process.toLowerCase())?await this.report.works(Ve):n&&(c.push(n.toLowerCase()),null!=Ve._id&&p.push(Ve),f.splice(f.indexOf(n),1)),Ve}catch(t){P=t,C.log("report works process error",P,"object"==typeof e?e.DOI:e),n&&(await this.sleep(3e3),f.splice(f.indexOf(n),1),null==h[n]&&(h[n]=0),h[n]+=1,4!==h[n]?this.report.queue(n,void 0,i,r,s):delete h[n])}},t.report.works.process._log=!1,t.report.works.load=async function(e,t,i,r,s,a,n,l){var o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,N,L,P,R,q;if(E=await this.epoch(),null==r&&(r=null!=(m=this.params.load)?m:(await this.date()).split("-")[0]),null==t&&(t=null!=(y=null!=(O=this.params.org)?O:this.params.orgs)?y:"orgs"===this.params.load),null==i&&"string"==typeof this.params.load&&(this.params.load.startsWith("10.")||this.params.load.toLowerCase().startsWith("pmc")||this.params.load.toLowerCase().startsWith("w"))&&(i=this.params.load),"string"==typeof i&&(i=[i]),this.fn.startsWith("report.works.load")&&null==s&&(s=this.params.clear),D=this.refresh,null==n&&(n=null!=(k=this.params.everything)?k:"everything"===this.params.load),q=0,this.params.q){for await(L of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",this.params.q,{scroll:"5m",include:["DOI","openalex","PMCID"]})))i.push(null!=(j=null!=(S=L.DOI)?S:L.openalex)?j:L.PMCID),i.length%1e3==0&&C.log("report works preparing to load from query",i.length);C.log("report works supplements to load from query",this.params.q)}else if("supplements"===this.params.load){for await(N of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",e?"updated:<"+e:t?'org:"'+t+'"':void 0,{scroll:"5m",include:["DOI","openalex","pmcid"]})))i.push(null!=(I=null!=(A=N.DOI)?A:N.openalex)?I:N.pmcid);C.log("report works supplements to load",e,t,i.length)}else if(n){for await(N of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","NOT pmc_has_data_availability_statement:*",{scroll:"5m",include:["DOI","openalex","PMCID"]})))i.push(null!=(g=null!=(_=N.DOI)?_:N.openalex)?g:N.PMCID);C.log("report works supplements to load everything for records that do not yet have everything",i.length)}if(Array.isArray(i))C.log("report works queueing identifiers batch",i.length),await this.report.queue(i,void 0,null!=e?e:D,n),q+=i.length;else{for await(f of(o=async(i,s)=>{var a,l,o;for await(a of(null==i&&(i="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+r),e&&(i="("+i+") AND srcday:>"+e),l=await this.src.crossref.works.count(i),C.log("report works load crossref by query expects",i,l),o=[],this.index._for("src_crossref_works",i,{include:["DOI"],scroll:"30m"})))t||r!==this.params.load||!await this.report.works(a.DOI)?(q+=1,o.push(await this.report.queue(a.DOI,void 0,null!=e?e:D,n,s))):o.push(void 0);return o},!0!==t&&r===this.params.load&&await o(void 0,"years"),u=async(i,s)=>{var a,l,o,u,c;for await(a of(null==i&&(i="authorships.institutions.display_name:* AND publication_year:"+r),e&&(i="("+i+") AND updated_date:>"+e),o=await this.src.openalex.works.count(i),C.log("report works load openalex by query expects",i,o),c=[],this.index._for("src_openalex_works",i,{include:["id","ids"],scroll:"30m"})))(l=(null!=(u=a.ids)?u.doi:void 0)?"10."+a.ids.doi.split("/10.")[1]:a.id.split("openalex.org/").pop())?!t&&r===this.params.load&&l.startsWith("10.")&&await this.report.works(l)?c.push(void 0):(q+=1,c.push(await this.report.queue(l,void 0,null!=e?e:D,n,s))):c.push(void 0);return c},!0!==t&&r===this.params.load&&await u(void 0,"years"),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs","string"==typeof t?'name:"'+t+'"':"paid:true",{scroll:"10m"}))){if(null!=(v=f.source)?v.crossref:void 0){try{f.source.crossref.includes("%")&&(f.source.crossref=decodeURIComponent(decodeURIComponent(f.source.crossref)))}catch(e){}C.log("report works load crossref by org",f.name,f.source.crossref),await o(f.source.crossref)}if(null!=(b=f.source)?b.openalex:void 0){try{f.source.openalex.includes("%")&&(f.source.openalex=decodeURIComponent(decodeURIComponent(f.source.openalex)))}catch(e){}C.log("report works load openalex by org",f.name,f.source.openalex),await u(f.source.openalex)}}if(e)for await(c of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs:* AND updated:<"+e,{scroll:"10m"}))await this.src.crossref.works.count('DOI.keyword:"'+c.DOI+'" AND srcday:>'+e)&&await this.report.queue(c.DOI,void 0,null!=e?e:D,n)}for(R=await this.epoch()-E,P="Report works queued "+q+(this.S.dev?" (dev)":"")+"\n",i&&i.length&&(P+=i.length+" identifiers were provided to process\n"),this.params.q&&(P+="These were derived by searching for provided query"+JSON.stringify(this.params.q)+"\n"),"supplements"===this.params.load&&(P+="These were derived by searching for all works that already have supplements attached\n"),n&&!this.params.q&&(P+="These were derived by searching for all works that have not yet had everything fully processed\n"),a&&(P+="These were provided by an orgs supplements refresh which took "+Math.ceil((E-a)/1e3/60)+"m\n"),"string"==typeof t&&(P+="The load process was "+(this.params.q?"matched":"limited")+" to "+t+"\n"),e&&(P+="The load process was run for changes since "+await this.datetime(e)+"\n"),!r||"string"==typeof t||!this.params.load&&e||(null!=i?i:[]).length||(P+="The load process was run for year "+r+"\n"),d=0,h=(w=null!=l?l:[]).length;d<h;d++)p=w[d],P+="\n"+JSON.stringify(p)+"\n";return C.log("Report works loaded",q,R),await this.mail({to:null!=(x=this.S.log)?x.logs:void 0,subject:"Report works loaded "+q,text:P}),q},t.report.works.load._log=!1,t.report.works.load._bg=!0,t.report.works.load._async=!0,t.report.works.load._auth="@oa.works",t.report.works.load.mains=async function(){var e,t,i,r;for(e=0,t=(r=this.params.orgs?this.params.orgs.split(","):["Gates Foundation","Robert Wood Johnson Foundation","Howard Hughes Medical Institute","Templeton World Charity Foundation","Michael J. Fox Foundation","Parkinson’s Progression Markers Initiative"]).length;e<t;e++)i=r[e],await this.report.works.load(void 0,i);return!0},t.report.works.load.mains._log=!1,t.report.works.load.mains._bg=!0,t.report.works.load.mains._async=!0,t.report.works.load.mains._auth="@oa.works",t.report.works.changes=function(e,t){var i,r;return null==e&&(e=null!=(i=null!=(r=this.params.changes)?r:this.params.timestamp)?i:Date.now()-9e7),null==t&&(t=this.params.org),this.report.works.load(e,t),!0},t.report.works.changes._log=!1,t.report.works.changes._bg=!0,t.report.works.changes._async=!0,t.report.works.changes._auth="@oa.works",t.report.rs={_index:!0},t.report.rs.retrieve=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;for await(y of(p=this.params.max,O=this.params.retrieve,S=this.params.save,w=this.params.refresh,f=this.params.plus,c=null!=(g=this.params.limit)?g:1e3,(r=this.params.empty)&&await this.report.rs(""),m=null!=(_=this.params.q)?_:'prefix.keyword:"10.21203" AND DOI:"v1" AND type.keyword:"posted-content"',h={include:["DOI"],scroll:"30m"},!e||this.params.q&&!this.params.since||("string"==typeof e&&e.includes(" ")&&(e=await this.epoch(e.replace(" ","T"))),m+=" AND created.timestamp:>"+e),(x={started:I=Date.now(),ended:void 0,took:void 0,limit:c,empty:r,since:e,q:m,expected:0,total:0,refresh:w,existed:void 0,existing:0,local:0,tried:0,retrieved:0,max:p,save:S,saved:0,confirm:0}).expected=await this.src.crossref.works.count(m),x.existed=await this.report.works.count('DOI:"10.21203" AND DOI:"v1"'),i=[],this.index._for("src_crossref_works",m,h))){if(p&&x.tried>=p||O&&x.tried>=O)break;if(x.total+=1,(k=y.DOI.split(".").pop()).startsWith("rs-")||(k="rs-"+k),j="https://www.researchsquare.com/api/article/"+k,x.total%100==0?(x.took=Date.now()-I,C.log(j),C.log(x)):p<=10&&C.log(j),w||f||!await this.report.works(y.DOI))if(w||r||!await this.report.rs('identity.keyword:"'+k+'"')){if(x.tried+=1,(t=await this.fetch(j))&&(await this.sleep(x.limit),t.identity===k.split("/")[0])){try{t=JSON.parse(JSON.stringify(t).replace(/""/g,"null"))}catch(e){s=e,C.log(t),C.log(s,typeof t)}for(a=0,o=(v=["nonDraftVersions"]).length;a<o;a++)t[n=v[a]]=JSON.stringify(t[n]);for(l=0,u=(b=["declarations"]).length;l<u;l++)"object"!=typeof t[d=b[l]]&&delete t[d];x.retrieved+=1,t.DOI=y.DOI.toLowerCase(),t._id=t.DOI.replace(/\//g,"_"),i.push(t)}}else p<=10&&C.log(y.DOI,"already exists in local RS"),x.local+=1;else p<=10&&C.log(y.DOI,"already exists in report/works"),x.existing+=1;i.length>=50&&(!1!==S&&await this.report.rs(i),x.saved+=i.length,i=[])}return i.length&&(!1!==S&&await this.report.rs(i),x.saved+=i.length,i=[]),await this.sleep(5e3),x.confirm=await this.report.rs.count(),x.ended=Date.now(),x.took=x.ended-I,C.log(x),await this.mail({to:this.S.log.notify,subject:"Report RS retrieved "+x.retrieved,text:JSON.stringify(x,"",2)}),x},t.report.rs.retrieve._log=!1,t.report.rs.retrieve._bg=!0,t.report.rs.retrieve._async=!0,t.report.rs.retrieve._auth="@oa.works",t.report.rs.changes=async function(e){var t;return null==e&&(e=null!=(t=this.params.changes)?t:this.params.since),e||(e=(await this.report.rs("*",{sort:"createdAt.keyword:desc",size:1})).createdAt),C.log("Running report RS retrieve for new crossref records since",e),!1},t.report.rs.changes._log=!1,t.report.rs.changes._bg=!0,t.report.rs.changes._async=!0,t.report.rs.changes._auth="@oa.works",t.report.rs.check=async function(){var e,t,i,r,s,a,n,l,o;for(o={rows:0,checked:0,failed:[],found:0,not_found:[],dups:0,ids:[]},n=this.params.max,s=0,a=(l=(await fs.readFile(this.S.static.folder+"/rscheck.csv","utf8")).split("\n")).length;s<a&&(e=l[s],!(n&&o.rows>=n));s++)o.rows+=1,e&&((r=e.replace("10.21203/","").split("/v")[0].split(".").pop())&&!r.startsWith("rs-")&&(r="rs-"+r),t=e+"_("+r+")",(n||o.rows%50==0)&&C.log(o.rows,e,r),r?(N.call(o.ids,t)>=0?o.dups+=1:o.ids.push(t),o.checked+=1,(i=await this.report.rs('identity.keyword:"'+r+'"'))?(C.log(i.identity,"exists in report/rs"),o.found+=1):(o.not_found.push("("+o.rows+")_"+t),C.log(t,"not found in report/rs"))):o.failed.push("("+o.rows+")_"+t));return o},t.report.fixoatype=async function(){var e,t,i,r,s,a,n,l,o,u,c,p;for await(l of(r=0,t=0,a=0,s={},p={},e=[],n='journal_oa_type.keyword:"closed" AND issn:* AND orgs:*',i=await this.report.works.count(n),C.log("check oa type expecting",i),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",n,{scroll:"30m"})))t+=1,l.issn||(a+=1),t%100==0&&C.log("check oa type checked",t,r,a),l.issn&&s[l.issn[0]]?"closed"!==(o=s[l.issn[0]])&&"unknown"!==o&&(p[s[l.issn[0]]]+=1,r+=1,l.journal_oa_type=s[l.issn[0]],e.push(l)):(l.issn||l.DOI)&&(c=await this.permissions.journals.oa.type(null!=(u=l.issn)?u:l.DOI))&&(l.issn&&(s[l.issn[0]]=c),c&&"closed"!==c&&"unknown"!==c&&(null==p[c]&&(p[c]=0),p[c]+=1,r+=1,l.journal_oa_type=c,e.push(l))),e.length>=2e4&&(await this.report.works(e),e=[]);e.length&&await this.report.works(e),C.log("check oa type completed with",t,r,a,i),C.log(p);try{C.log(Object.keys(s).length)}catch(e){}return r},t.report.fixoatype._bg=!0,t.report.fixoatype._async=!0,t.report.fixoatype._auth="@oa.works",N=[].indexOf,null==t.svc&&(t.svc={}),t.svc.rscvd={_index:!0},t.svc.rscvd.form=async function(){var e,t,i,r,s,a,n,l;if(this.keys(this.params).length>1){delete(t=this.copy(this.params)).form,t.status="Awaiting verification";try{(n=await this.svc.rscvd.requestees('email:"'+t.email+'"'))&&((null!=n?n.verified:void 0)||"Approved"===(null!=n?n.verification:void 0)?(t.status="Verified",t.verified=!0):((null!=n?n.denied:void 0)||"Denied"===(null!=n?n.verification:void 0))&&(t.status="Denied",t.verified=!1))}catch(e){}if("Awaiting verification"===t.status)try{(null!=(e=await this.svc.rscvd('email:"'+t.email+'" AND verified:*'))&&null!=(i=e.hits)?i.hits:void 0)&&!0===e.hits.hits[0]._source.verified?(t.status="Verified",t.verified=!0):!1===e.hits.hits[0]._source.verified&&(t.status="Denied",t.verified=!1)}catch(e){}null==t.type&&(t.type="paper");try{t.createdAt=new Date}catch(e){}try{t.neededAt=await this.epoch(t["needed-by"])}catch(e){}t._id=await this.svc.rscvd(t);try{l="Hi "+t.name+",<br><br>We got your request:<br><br>Title: "+(null!=(r=null!=(s=t.atitle)?s:t.title)?r:"Unknown")+"\nReference (if provided): "+(null!=(a=t.reference)?a:"")+"<br><br>",l+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+t._id+'">cancel your request</a>, it only takes a second.<br><br>',l+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',l+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:t.email,subject:"RSCVD Request Receipt",text:l})}catch(e){}return t}},t.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},t.svc.rscvd.resolves=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h;for(null==e&&(e=this.params.resolves),null==t&&(t=this.params.resolver),e?n="object"==typeof e?e:await this.svc.rscvd(e):l=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+t+'" AND NOT unresolved:"'+t+'"'),d={},i=0,r=(c=null!=n?[n]:null!=(o=null!=l&&null!=(u=l.hits)?u.hits:void 0)?o:[]).length;i<r;i++)null!=(a=c[i])._source&&null==(n=a._source)._id&&(n._id=a._id),(s=this.copy(n)).title&&(s.journal=s.title),s.atitle&&(s.title=s.atitle),(null!=(h=await this.ill.subscription({subscription:t},s))?h.url:void 0)?(null==n.resolved&&(n.resolved=[]),n.resolved.push(t),null==n.resolves&&(n.resolves=[]),n.resolves.push({resolver:t,url:h.url,user:null!=(p=this.user)?p._id:void 0}),d[a._id]=!0):(null==n.unresolved&&(n.unresolved=[]),n.unresolved.push(t),d[a._id]=!1),this.svc.rscvd(n);return e&&d[e]?d[e]:d},t.svc.rscvd.cancel=async function(){var e;if(this.params.cancel)return(e=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(e),e},t.svc.rscvd.verify=async function(e,t=!0){var i,r;if(null==e&&(e=this.params.verify),e)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:e,createdAt:Date.now()}),t?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+e+'"',{action:"index"},(function(e){return e.status&&"Awaiting verification"!==e.status||(e.verified=t,t?(e.status="Verified",e.verified_by=this.user.email):(e.status="Denied",e.denied_by=this.user.email)),e})),!0},t.svc.rscvd.verify._auth=!0,t.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},t.svc.rscvd.deny._auth=!0,t.svc.rscvd.status=async function(){var e,t,i;if(this.params.status){[t,i]=this.params.status.split("/"),(e=await this.svc.rscvd(t)).status=i;try{"Done"===e.status?e.done_by=this.user.email:"In Progress"===e.status&&(e.progressed_by=this.user.email)}catch(e){}return this.svc.rscvd(e),e}},t.svc.rscvd.status._auth=!0,t.svc.rscvd.poll=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E;if(null==e&&(e=null!=(v=this.params.poll)?v:Date.now()-18e4),"string"==typeof(t=null!=(b=this.params.which)?b:["new","verify","deny","cancel","status","overdue"])&&(t=t.split(",")),N.call(t,"overdue")>=0&&this.svc.rscvd.overdue(),A={new:[],verify:[],deny:[],cancel:[],status:{}},N.call(t,"new")>=0)for(n=0,c=(O=null!=(w=null!=(_=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+e,500))&&null!=(x=_.hits)?x.hits:void 0)?w:[]).length;n<c;n++)null==(i=(y=O[n])._source)._id&&(i._id=y._id),A.new.push(y._source);if(N.call(t,"verify")>=0)for(l=0,p=(k=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;l<p;l++)E=k[l]._source.parts.pop(),N.call(A.verify,E)<0&&A.verify.push(E);if(N.call(t,"deny")>=0)for(o=0,d=(j=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<d;o++)a=j[o]._source.parts.pop(),N.call(A.deny,a)<0&&A.deny.push(a);if(N.call(t,"cancel")>=0)for(u=0,h=(S=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<h;u++)s=S[u]._source.parts.pop(),N.call(A.cancel,s)<0&&A.cancel.push(s);if(N.call(t,"status")>=0)for(m=0,f=(I=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;m<f;m++)C=(D=I[m])._source.parts.pop(),null==(r=A.status)[g=D._source.parts.pop()]&&(r[g]=C);return A},t.svc.rscvd.poll._log=!1,t.svc.rscvd.overdue=async function(){var e,t,i,r,s,a,n,l,o,u,c;if(t=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(r=0,a=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;r<a;r++)null==(e=(l=c[r])._source)._id&&(e._id=l._id),u.push(l._source);for(s=0,n=u.length;s<n;s++)(o=u[s]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),t+=1;return t},N=[].indexOf,t.test=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z;for(Y=null!=(j=this.params.row)?j:this.params.id,h=null!=(S=this.params.test)?S:this.params.group,null==t&&(t=null!=(M=this.params.max)?M:Y?1:1e3),($={summary:{ran:0,max:t,id:Y,responded:0,errors:0,differences:0,difference:null==(W=null!=(U=this.params.diff)?U:this.params.difference)||W,anomalous:0},anomalies:{},differences:{}}).sheet={id:null!=(z=null!=e?e:this.params.sheet)?z:"1GQhgRCZ9ovfTN_wwKCvoAqf9QlO7ozcxScBgjEnpfl8/tests"},null==(s=$.sheet).url&&(s.url="https://docs.google.com/spreadsheets/d/"+$.sheet.id.split("/")[0]),$.sheet.content=await this.src.google.sheets($.sheet.id),$.responses=[],$.diffs=[],C.log($.sheet.content.length,"tests found to run in",$.sheet.id),m=0,_=(F=$.sheet.content).length;m<_&&(Z=F[m],$.summary.ran!==t);m++)if(null==Z.PARAMS&&null!=Z.QUERY&&(Z.PARAMS=Z.QUERY),null==Z.ENDPOINT&&null!=Z.ENDPOINT_PRIMARY&&(Z.ENDPOINT=Z.ENDPOINT_PRIMARY),null==Z.DIFF&&null!=Z.ENDPOINT_SECONDARY&&(Z.DIFF=Z.ENDPOINT_SECONDARY),Z.ENDPOINT&&Z.ID&&(null==Y||Z.ID.toString().toLowerCase()===Y.toString().toLowerCase())&&(!h||(B=h.toString().toLowerCase(),N.call(Z.GROUP.toString().toLowerCase().replace(/ /g,"").split(";"),B)>=0))){try{Z.PARAMS=Z.PARAMS.trim()}catch(e){}$.summary.ran++;try{for(a in G=Z.ENDPOINT.startsWith("http")?await this.fetch(Z.ENDPOINT+(Z.ENDPOINT.endsWith("/")||(null!=(J=Z.PARAMS)?J:"").startsWith("/")?"":"/")+(null!=(X=Z.PARAMS)?X:"")):await this[Z.ENDPOINT](Z.PARAMS),$.summary.responded++,Z)if(""==(i=(null!=(I=null!=(A=null!=(D=Z.NAME)?D:Z.ID)?A:Z.ENDPOINT)?I:"")+(Z.PARAMS?" ("+Z.PARAMS+")":""))&&(i="UNIDENTIFIED_TEST_"+$.summary.ran),"ID"!==a&&"GROUP"!==a&&"ENDPOINT"!==a&&"ENDPOINT_PRIMARY"!==a&&"ENDPOINT_SECONDARY"!==a&&"DIFF"!==a&&"PARAMS"!==a&&"QUERY"!==a&&"NAME"!==a&&"SPEC"!==a&&"TEST_LINK"!==a&&"PRIMARY_URL"!==a&&"GROUP_MANUAL"!==a&&"ID_MANUAL"!==a&&"TEST_REQUIREMENTS_MET"!==a&&""!==a&&!a.startsWith("OPTIONS.")&&null!=(d=Z[a])&&""!==d){if(k=await this.dot(G,a),f=!1,b=!1,O=!1,l="string"==typeof d&&(d.startsWith("~")||Array.isArray(k)&&(!d.includes(",")||k.length!==d.split(",").length)),"object"==typeof k)l||("string"==typeof d&&Array.isArray(k)&&(d=d.split(",")),k=JSON.stringify(k),"object"==typeof d&&(d=JSON.stringify(d)));else try{"number"!=typeof(w=parseFloat(k))||w.toString().trim().length!==k.toString().trim().length||isNaN(w)||(k=w,d.startsWith(">")?(f=!0,d=parseFloat(d.slice(1))):d.startsWith("<")?(b=!0,d=parseFloat(d.slice(1))):d.startsWith("!")?(O=!0,d=parseFloat(d.slice(1))):d=parseFloat(d))}catch(e){}if("boolean"==typeof d||"boolean"==typeof k)try{d=d.toString().trim().toLowerCase(),k=k.toString().trim().toLowerCase()}catch(e){}x="!*"===d||"UNDEFINED"===d||"NULL"===d||"NONE"===d,H=(y=!(r="*"===d)&&!x&&"string"==typeof d&&(d.startsWith("*")||d.endsWith("*")))&&!d.startsWith("*"),c=y&&!d.endsWith("*"),y&&(d=d.replace(/\*/g,"")),x&&(l=!1),l&&("string"==typeof d&&d.startsWith("~")&&(d=d.slice(1)),n=r||N.call(k,d)>=0||(E=parseFloat(d),N.call(k,E)>=0)||(L=parseInt(d),N.call(k,L)>=0)||"true"===d.toLowerCase()&&N.call(k,!0)>=0||"false"===d.toLowerCase()&&N.call(k,!1)>=0),C.log($.summary.ran,a,"part:",typeof k,k,"expect:",typeof d,d,typeof Z[a],Z[a],"gt:",f,"lt:",b,"nt:",O,"nothing:",x,"anything:",r,"includes:",y,"starts:",H,"ends:",c,"contains:",l,"contained:",n),!(null==k&&!x||null!=k&&"[]"!==(P=JSON.stringify(k))&&"{}"!==P&&x||l&&!n||H&&!k.startsWith(d)||c&&!k.endsWith(d)||!H&&!c&&y&&!k.includes(d)||O&&k===d||f&&k<=d||b&&k>=d)&&(f||b||O||r||x||l||y||k===d)||(null==$.anomalies[i]&&($.summary.anomalous++,$.anomalies[i]={}),$.anomalies[i][a]={expected:Z[a],reported:null==k?"UNDEFINED":k})}if($.responses.push(G),Z.DIFF&&!1!==this.params.diff&&!1!==this.params.difference)try{V=Z.DIFF.startsWith("http")?await this.fetch(Z.DIFF+(Z.DIFF.endsWith("/")||(null!=(R=Z.PARAMS)?R:"").startsWith("/")?"":"/")+(null!=(q=Z.PARAMS)?q:"")):await this[Z.DIFF](Z.PARAMS),u=await this.fetch("https://s.leviathan.sh/diff",{body:{a:G,b:V}}),$.diffs.push(u),u.diff.length&&($.summary.differences+=1,$.differences[i]=u.diff)}catch(e){}await this.sleep(200)}catch(e){p=e,C.log(p),$.summary.errors++}}if(!this.params.verbose){try{for(o in $.differences)$.differences[o]=$.differences[o].length}catch(e){}for(g=0,v=(T=["responses","diffs"]).length;g<v;g++)delete $[T[g]];delete $.sheet.content}return $},t.tests=t.test,N=[].indexOf,t.src.crossref=function(){return"Crossref API wrapper"},t.src.crossref.works={_index:{settings:{number_of_shards:15}}},t.src.crossref.works._key="DOI",t.src.crossref.works._prefix=!1,t.src.crossref.works.doi=async function(e,t,i){var r,s,a,n,l,o,u;return null==e&&(e=this.params.doi),null==t&&"src.crossref.works.doi"===this.fn&&(t=this.refresh),null==i&&(i=null==(s=this.params.save)||s),"string"==typeof e&&e.startsWith("10.")&&(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),!t&&(r=await this.src.crossref.works(e))||null!=(null!=(u=await this.fetch("https://api.crossref.org/works/"+e,{headers:{"User-Agent":(null!=(a=this.S.name)?a:"OA.Works")+"; mailto:"+(null!=(n=null!=(l=this.S.mail)?l.to:void 0)?n:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}))&&null!=(o=u.message)?o.DOI:void 0)&&(r=await this.src.crossref.works._format(u.message),i&&await this.src.crossref.works(r))),r},t.src.crossref.works.title=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g;if(null==e&&(e=null!=(o=this.params.title)?o:this.params.q),n='title:"'+e+'"',e.split(" ").length>2){for(n+=" OR (",t=0,i=(u=e.split(" ")).length;t<i;t++)g=u[t],n.endsWith("(")||(n+=" AND "),n+='(title:"'+g+'" OR subtitle:"'+g+'")';n+=")"}for(h=await this.src.crossref.works(n),s=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),a=0,r=(d=null!=(c=null!=h&&null!=(p=h.hits)?p.hits:void 0)?c:[]).length;a<r;a++)(l=d[a])._source.DOI&&l._source.title&&l._source.title.length&&(m=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(y=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&y.length&&N.call(m,y)<0&&(m+=" "+y),m=m.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==s.indexOf(m)||-1!==m.indexOf(s))&&s.length/m.length>.7&&s.length/m.length<1.3&&("journal-article"===l._source.type||null==f||"journal-article"!==f.type&&"journal-article"===l._source.type)&&(f=l._source));return f},t.src.crossref.works._format=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y;for(e.abstract&&(e.abstract=e.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==e._id&&(e._id=e.DOI.replace(/\//g,"_")),r=0,a=(p=null!=(c=e.assertion)?c:[]).length;r<a;r++)"OPEN ACCESS"===(t=p[r]).label&&(t.URL&&-1!==t.URL.indexOf("creativecommons")&&(null==e.license&&(e.license=[]),e.license.push({URL:t.URL})),e.is_oa=!0);for(o=0,n=(h=null!=(d=e.license)?d:[]).length;o<n;o++)if((s=h[o]).URL&&-1!==s.URL.indexOf("creativecommons")&&(!e.licence||-1===e.licence.indexOf("creativecommons"))){e.licence=s.URL;try{e.licence="cc-"+e.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(e){}e.is_oa=!0}try{e.reference&&e.reference.length>100&&(e.reference_original_length=e.reference.length,e.reference=e.reference.slice(0,100))}catch(e){}try{e.relation&&e.relation.length>100&&(e.relation_original_length=e.relation.length,e.relation=e.relation.slice(0,100))}catch(e){}for(u=0,l=(m=null!=(f=e.author)?f:[]).length;u<l;u++)(i=m[u]).name=(i.given?i.given+" ":"")+(null!=(y=i.family)?y:"");if(e.published=await this.src.crossref.works.published(e)){try{e.year=e.published.split("-")[0]}catch(e){}try{parseInt(e.year)}catch(e){}try{e.publishedAt=await this.epoch(e.published)}catch(e){}}return e},t.src.crossref.works.published=async function(e){var t,i,r,s,a,n,l,o,u;if(null==e&&(e=this.params.published),"string"==typeof e&&(e=await this.src.crossref.works(e)),null!=e){for(a=void 0,s=void 0,t=0,i=(l=["published","published-print","published-online","issued","deposited"]).length;t<i;t++)"object"==typeof e[r=l[t]]&&(n=void 0,"string"==typeof e[r]["date-time"]&&3===e[r]["date-time"].split("T")[0].split("-").length?n=e[r]["date-time"].split("T")[0]:Array.isArray(e[r]["date-parts"])&&e[r]["date-parts"].length&&Array.isArray(e[r]["date-parts"][0])&&("string"!=(o=typeof(u=e[r]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(n=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),n&&(!s||a>await this.epoch(n))&&(s=n,a=await this.epoch(s)));return s}},t.src.crossref.works.published._log=!1,t.src.crossref.works.search=async function(e,t,i,r,s,a,n,l){var o,u,c,p,d,h,f,m,y,g,_;if(null==e&&(e=null!=(d=this.params.q)?d:this.params.search),null==t&&(t=this.params.from),null==i&&(i=this.params.size),null==r&&(r=this.params.filter),null==s&&(s=this.params.start),null==a&&(a=this.params.end),null==n&&(n=this.params.sort),null==l&&(l=null!=(h=this.params.order)?h:"asc"),o="",s&&(null==r&&(r=null!=n?n:"updated"),"string"==typeof s&&-1!==s.indexOf("-")||(s=await this.date(s)),o="from-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+s),a&&(null==r&&(r=null!=n?n:"updated"),"string"==typeof a&&-1!==a.indexOf("-")||(a=await this.date(a)),o+=(o?",":"")+"until-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+a),o&&(r=o),_="https://api.crossref.org/works?",null!=n&&(_+="sort="+n+"&order="+l+"&"),"object"==typeof e)for(c in e)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(_+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(e[c])+"&");else e&&"all"!==e&&(p=(p=e.replace(/\w+?\:/g,"")).replace(/ /g,"+"),_+="query="+encodeURIComponent(p)+"&");if(null!=t){if("*"!==t&&"string"==typeof t&&!t.replace(/[0-9]/g,"").length)try{u=parseInt(t),isNaN(u)||(t=u)}catch(e){}_+="number"!=typeof t?"cursor="+encodeURIComponent(t)+"&":"offset="+t+"&"}null!=i&&(_+="rows="+i+"&"),r&&(_+="filter="+encodeURIComponent(r)+"&"),_=_.replace("?&","?").replace(/&$/,"");try{return{total:(g=await this.fetch(_,{headers:{"User-Agent":(null!=(f=this.S.name)?f:"OA.Works")+"; mailto:"+(null!=(m=null!=(y=this.S.mail)?y.to:void 0)?m:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}})).message["total-results"],cursor:g.message["next-cursor"],data:g.message.items,facets:g.message.facets}}catch(e){}},t.src.crossref.journals={_index:!0,_prefix:!1},t.src.crossref.journals.load=async function(){var e,t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;for(await this.src.crossref.journals(""),t=0,j=0,e=[],i="*";i&&(0===t||t<j);){for(S="https://api.crossref.org/journals?cursor="+i+"&rows=1000",O=await this.fetch(S,{headers:{"User-Agent":(null!=(p=this.S.name)?p:"OA.Works")+"; mailto:"+(null!=(d=null!=(m=this.S.mail)?m.to:void 0)?d:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}),0===j&&(j=O.message["total-results"]),i=O.message["next-cursor"],s=0,a=(y=O.message.items).length;s<a;s++){for(null==(c=y[s]).ISSN&&(c.ISSN=[]),c.issn=[],o=0,n=(g=c.ISSN).length;o<n;o++)"string"==typeof(r=g[o])&&r.length&&N.call(c.issn,r)<0&&c.issn.push(r);if(c.dois=null!=(_=c.counts)?_["total-dois"]:void 0,null!=(null!=(v=c.breakdowns)?v["dois-by-issued-year"]:void 0)){for(c.years=[],u=0,l=(b=c.breakdowns["dois-by-issued-year"]).length;u<l;u++)2===(I=b[u]).length&&(w=I[0],N.call(c.years,w)<0)&&c.years.push(I[0]);c.years.sort()}null!=c.years&&c.years.length&&c.dois?(k=(new Date).getFullYear(),N.call(c.years,k)<0&&(x=k-1,N.call(c.years,x)<0)&&(h=k-2,N.call(c.years,h)<0)&&(f=k-3,N.call(c.years,f)<0)&&(c.discontinued=!0)):c.discontinued=!0,e.push(c)}t+=1e3,e.length>=1e4&&(await this.src.crossref.journals(e),e=[])}return e.length&&(await this.src.crossref.journals(e),e=[]),C.log(t),t},t.src.crossref.journals.load._bg=!0,t.src.crossref.journals.load._async=!0,t.src.crossref.journals.load._auth="root",t.src.crossref.changes=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b;if(null==e&&(e=this.params.changes),"string"==typeof e&&(e.includes("/")||e.includes("-"))&&(e=await this.epoch(e)),!e)try{e=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday+864e5,C.log("Crossref changes start day set from latest record srcday",await this.date(e))}catch(e){}if(!e)try{e=(await this.src.crossref.works("indexed.timestamp:*",{size:1,sort:{"indexed.timestamp":"desc"}})).indexed.timestamp,C.log("Crossref changes start day set from latest record indexed timestamp",await this.date(e))}catch(e){}if(null==e&&(e=16935264e5),e=await this.epoch(await this.date(e)),null==t&&(t=this.params.end),"string"==typeof t&&(t.includes("/")||t.includes("-"))&&(t=await this.epoch(t)),null==i&&(i=this.params.created),n=null!=t?t:Date.now(),d=0,h=[],a=0,r=[],e>=(n=await this.epoch(await this.date(n)))&&"src.crossref.changes"!==this.fn)C.log("crossref works changes waiting an hour before looping to check for new changes because start day is not yet a day or more in the past"),await this.sleep(36e5);else{for(;e<n;){for(C.log("Crossref changes",e,a),s="*",a+=1,b=!1,u=0,_=0;_<3&&(!1===b||u<b);)if(await this.sleep(500),null!=(v=await this.src.crossref.works.search(void 0,s,1e3,"indexed",e,e))?v.data:void 0){for(c=0,p=(m=v.data).length;c<p;c++)f=m[c],(o=await this.src.crossref.works._format(f)).srcday=e,r.push(o),d+=1;r.length>=1e4&&(C.log("Crossref bulk load",e,a,b,u,d,h.length),await this.src.crossref.works(r),r=[]),!1===b&&(b=null!=(y=v.total)?y:0,C.log(e,b)),u+=1e3,s=v.cursor}else C.log("crossref error"),await this.sleep(2e3),_+=1;e+=864e5}r.length&&await this.src.crossref.works(r),C.log("crossref works changes completed",d,a,h.length),(d>0||1===(new Date).getDay())&&(l=await this.datetime(),await this.mail({to:null!=(g=this.S.log)?g.logs:void 0,subject:"Crossref works load or changes "+d+" at "+l,text:"loaded "+d}))}return d},t.src.crossref.changes._bg=!0,t.src.crossref.changes._async=!0,t.src.crossref.changes._log=!1,t.src.crossref.changes._auth="root",t.src.crossref.changes._notify=!1,t.src.crossref.plus={},t.src.crossref.plus.load=async function(){var e,t,i,r,s,a,n,l,o,u,c,p,d,h;if(c=await this.epoch(),s=0,this.params.clear)await this.src.crossref.works(""),(n={properties:{}}).properties.assertion={properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},explanation:{properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},group:{properties:{label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},order:{type:"long"},value:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},await this.src.crossref.works.mapping(n);else try{s=(await this.src.crossref.works("srcfile:*",{size:1,sort:{srcfile:"desc"}})).srcfile}catch(e){}i=this.S.directory+"/import/crossref/all.json.tar.gz";try{await fs.stat(i)}catch(e){C.log("crossref downloading snapshot"),(r={})["Crossref-Plus-API-Token"]="Bearer "+this.S.crossref,o=await fetch("https://api.crossref.org/snapshots/monthly/latest/all.json.tar.gz",{headers:r}),h=fs.createWriteStream(i),await new Promise(((e,t)=>(o.body.pipe(h),o.body.on("error",t),h.on("finish",e)))),C.log("snapshot downloaded")}for(d=0,u=0,a="",e=!1,p=fs.createReadStream(i).pipe(zlib.createGunzip()),l="",p.on("data",(async e=>{var t,i,r,n,o,c,p,h,f,m;if(r=e.toString("utf8"),a+=r,(l+r).includes('\n  "items" : ['))for(;a.includes('\n  "items" : [');)if([n,a]=a.replace('\n  "items" : [',"X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),n.includes("\n  } ]")){if(o=n.split("\n  } ]"),m=parseInt(o.pop().split(".json")[0].replace(/[^0-9]/g,"")),u<s)C.log("crossref plus load waiting for file",u,s);else{for(p=[],t=0,i=(h=f=JSON.parse("["+o.join("]")+"}]")).length;t<i;t++)c=h[t],(null!=(c=await this.src.crossref.works._format(c))?c.DOI:void 0)&&(c.srcfile=u,p.push(c));C.log("crossref plus load",f.length,p.length),d+=p.length,p.length&&await this.src.crossref.works(p)}u=m}return l=r})),p.on("error",(e=>C.log("crossref plus load file stream error",JSON.stringify(e)))),p.on("end",(()=>(C.log("stream complete for crossref plus load"),e=!0)));!e;)C.log("crossref plus load streaming file",a.length,u,d,Math.floor((Date.now()-c)/1e3/60)+"m"),await this.sleep(3e4);return t=Date.now(),C.log("crossref plus load complete",u,d,c,t,Math.floor((t-c)/1e3/60)+"m"),d},t.src.crossref.plus.load._log=!1,t.src.crossref.plus.load._bg=!0,t.src.crossref.plus.load._async=!0,null==(O=r.src).doaj&&(O.doaj={});try{r.src.doaj.secrets=JSON.parse(SECRETS_DOAJ)}catch(e){}t.src.doaj={},t.src.doaj.journals={_index:!0,_prefix:!1},t.src.doaj.journals.load=async function(){var e,t,i,s,a,n,l,o;for(i="/tmp/doaj_"+await this.uid(),await fs.mkdir(i),i+="/",await fs.writeFile(i+"doaj.tar",await this.fetch("https://doaj.org/public-data-dump/journal?api_key="+r.src.doaj.secrets.apikey,{buffer:!0})),tar.extract({file:i+"doaj.tar",cwd:i,sync:!0}),e=!1,s=0,n=(l=await fs.readdir(i)).length;s<n;s++)(t=l[s]).includes("doaj_journal_data")&&(e=t);return o=0,e&&(o=(a=JSON.parse(await fs.readFile(i+e+"/journal_batch_1.json"))).length,await this.src.doaj.journals(""),await this.src.doaj.journals(a),await fs.unlink(i+e+"/journal_batch_1.json")),await fs.rmdir(i+e),await fs.unlink(i+"doaj.tar"),await fs.rmdir(i),o},t.src.doaj.journals.load._bg=!0,t.src.doaj.journals.load._async=!0,t.src.doaj.journals.load._auth="root",N=[].indexOf,t.src.epmc={_index:!0,_prefix:!1,_key:"id"},t.src.epmc.notinepmc={_index:!0,_prefix:!1,_key:"id",_hide:!0},t.src.epmc.search=async function(e,t,i){var r,s,a,n,l,o,u,c;return null==e&&(e=null!=(r=null!=(s=null!=(a=this.params.search)?a:this.params.epmc)?s:this.params.doi)?r:""),e.startsWith("10.")&&!e.includes(" ")&&e.split("/").length>=2&&(e="DOI:"+e),"string"!=typeof e||e.startsWith("PMCID:")||!e.toLowerCase().startsWith("pmc")||e.includes(" ")||(e="PMCID:PMC"+e.toLowerCase().replace("pmc","")),"number"==typeof e&&(e="PMCID:PMC"+e),c="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(c+="&pageSize="+i),null!=t&&(c+="&cursorMark="+t),u={},await this.sleep(150),o=await this.fetch(c),u.total=o.hitCount,u.data=null!=(n=null!=(l=o.resultList)?l.result:void 0)?n:[],u.cursor=o.nextCursorMark,u.data.length&&this.waitUntil(this.src.epmc(u.data)),u},t.src.epmc.doi=async function(e,t){var i,r,s,a,n;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.doi),null!=(i=await this.src.epmc('doi:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(a=await this.src.epmc.notinepmc(e))?a.checkedAt:void 0)?s:0)<24192e5);else{if((n=await this.src.epmc.search("DOI:"+e)).total)return n.data[0].doi||(n.data[0].doi=e,this.waitUntil(this.src.epmc(n.data[0]))),n.data[0];await this.src.epmc.notinepmc({id:e.replace(/\//g,"_"),doi:e,checkedAt:Date.now()})}},t.src.epmc.pmid=async function(e,t){var i,r,s,a,n;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.pmid),null!=(i=await this.src.epmc('pmid:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(a=await this.src.epmc.notinepmc(e))?a.checkedAt:void 0)?s:0)<24192e5);else{if((n=await this.src.epmc.search("EXT_ID:"+e+" AND SRC:MED")).total)return n.data[0];await this.src.epmc.notinepmc({id:e,pmid:e,checkedAt:Date.now()})}},t.src.epmc.pmc=async function(e,t){var i,r,s,a,n,l;if(e||null==t&&(t=this.refresh),null==e&&(e=null!=(r=this.params.pmc)?r:this.params.pmcid),e="PMC"+e.toLowerCase().replace("pmc",""),null!=(i=await this.src.epmc('pmcid:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(a=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?a:0)<24192e5);else{if((l=await this.src.epmc.search("PMCID:"+e)).total)return l.data[0];await this.src.epmc.notinepmc({id:e,pmcid:e,checkedAt:Date.now()})}},t.src.epmc.title=async function(e){var t,i,r;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(null!=(t=await this.src.epmc('title:"'+e+'"'))&&null!=(i=t.hits)?i.total:void 0)?t.hits.hits[0]._source:(r=await this.src.epmc.search('title:"'+e+'"')).total?r.data[0]:void 0},t.src.epmc.licence=async function(e,t,i,r){var s,a,n;if(e||null==r&&(r=this.refresh),null==e&&(e=null!=(a=null!=(n=this.params.licence)?n:this.params.pmcid)?a:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),e&&null==t&&(t=await this.src.epmc.pmc(e,r)),t||i){if(null!=(null!=t?t.calculated_licence:void 0)&&!r)return"not found"===t.calculated_licence.licence?void 0:t.calculated_licence;if(null==e&&(e=null!=t?t.pmcid:void 0),(null!=t?t.license:void 0)&&"string"==typeof t.license?(s={licence:t.license,source:"epmc_api"}).licence.startsWith("cc")&&(s.licence=s.licence.replace(/ /g,"-")):(!i&&e&&(i=await this.src.epmc.xml(e,t,r)),null!=this.licence&&i&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(s=await this.licence(void 0,i,"<permissions>","</permissions>"))?s.licence:void 0)&&(s.source="epmc_xml_permissions"),null==(null!=s?s.licence:void 0)&&null!=(null!=(s=await this.licence(void 0,i))?s.licence:void 0)&&(s.source="epmc_xml_outside_permissions")),null==(null!=s?s.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(s={licence:"non-standard-licence",source:"epmc_xml_permissions"})),null!=(null!=s?s.licence:void 0))return t.calculated_licence=s,await this.src.epmc(t.id,t),s;t.calculated_licence={licence:"not found"},await this.src.epmc(t.id,t)}},w=Date.now(),x=0,t.src.epmc.xml=async function(e,t,i){var r,s,a,n,l;if(null==e&&(e=null!=(a=null!=(n=this.params.xml)?n:this.params.pmcid)?a:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),null==i&&(i=this.refresh),e)try{return(r=await fs.readFile(this.S.directory+"/epmc/fulltext/"+e+".xml")).toString()}catch(a){if(null==t&&(t=await this.src.epmc.pmc(e,i)),i||!(null!=t?t.no_ft:void 0)){for(s=Date.now()-w;s<500||x>=2;)await this.sleep(500-s),s=Date.now()-w;if(w=Date.now(),x+=1,l="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&id="+e,r=await this.fetch(l),x-=1,"string"==typeof r&&r.length||null==t||(l="https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",r=await this.fetch(l)),"string"==typeof r&&r.length){try{await fs.writeFile(this.S.directory+"/epmc/fulltext/"+e+".xml",r)}catch(e){}return r}null!=t&&(t.no_ft=!0,await this.src.epmc(t.id,t))}}},t.src.epmc.fulltext=async function(e){var t,i,r;if(null==e&&(e=null!=(i=null!=(r=this.params.fulltext)?r:this.params.pmcid)?i:this.params.epmc),e)return await this.sleep(150),200===(null!=(t=await this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",{method:"HEAD"}))?t.status:void 0)},t.src.epmc.aam=async function(e,t,i,r){var s,a,n,l;if(null==e&&(e=null!=(a=null!=(n=this.params.aam)?n:this.params.pmcid)?a:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{e&&!t&&(t=await this.src.epmc.pmc(e,r))}catch(e){}return null==e&&(e=null!=t?t.pmcid:void 0),e?"string"==typeof(i=await this.src.epmc.xml(e,t,r))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),l="https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc",""),(s=await this.fetch(l))?"string"==typeof s?s.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||s.includes("Author manuscript; available in PMC")||s.includes("logo-nihpa.gif")||s.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}:null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},t.src.epmc.submitted=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h;if(null==e&&(e=null!=(o=null!=(u=null!=(c=null!=(p=this.params.submitted)?p:this.params.pmc)?c:this.params.pmcid)?u:this.params.PMC)?o:this.params.PMCID),null==i&&(i=this.refresh),e){e="PMC"+(e+"").toLowerCase().replace("pmc","");try{if(r=await this.src.epmc.xml(e,t,i)){if((r=r.split("<article-meta")[1].split("/article-meta")[0].split('date-type="received"')[1].split("</date")[0]).includes("<year")){h=r.split("<year")[1].split("</year>")[0].split(">").pop();try{h+="-"+r.split("<month")[1].split("</month>")[0].split(">").pop()}catch(e){h+="-01"}try{h+="-"+r.split("<day")[1].split("</day>")[0].split(">").pop()}catch(e){h+="-01"}r=h}else r=r.includes("<")?r.replace(">","").split("<")[0]:r.split('"')[1];if(r=r.replace("\n","").trim()){if(10!==r.length){for(l=[],d=r.split("T")[0].split("-"),a=0,n=d.length;a<n;a++)s=d[a],l.push(1===s.length?"0"+s:s);r=l.join("-")}return r}}}catch(e){}}},t.src.epmc.statement=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C;if(null==e&&(e=null!=(_=null!=(v=null!=(b=null!=(w=this.params.statement)?w:this.params.pmc)?b:this.params.pmcid)?v:this.params.PMC)?_:this.params.PMCID),null==i&&(i=this.refresh),null==r&&(r=this.params.verbose),m=[],d=[],j=[],C=[],A=[],e&&(e="PMC"+(e+"").toLowerCase().replace("pmc",""),n=await this.src.epmc.xml(e,t,i)))for(n=n.split("<ref-list")[0].replace(/\<p\>/g,"").replace(/\<\/p\>/g,""),I="",l=0,o=(x=['"data',">Data",">Availab",">data",">Code",">code"]).length;l<o;l++){O=x[l];try{if(n.includes(O))for(j.push(O),f=(k=n.split(O)).shift();f&&(c=k.shift());){if(m.push(f.slice(-1e3)),D=f.split("<").pop().split(">")[0].split(" ")[0].replace("/",""),!O.startsWith('"')&&f.endsWith("><"+D)&&(D=f.split("</"+D+">").pop().split("><"+D)[0].split("<").pop().split(">")[0].split(" ")[0].replace("/","")),p=(O.startsWith('"')?c.split(/\>(.*)/s)[1]:c.startsWith("il")||c.startsWith("l")?"Availab":"Data")+c,d.push(p.slice(0,1e3)),p.includes("</"+D+">")&&p.indexOf("</"+D+">")<40)try{(u=(y=f.split("<"))[y.length-2].split(">")[0].split(" ")[0]).startsWith("/")||(D=u)}catch(e){}if(C.push(D),S="\n"+(g=f.split("<"+D)).slice(0,g.length-1).pop().split("\n").pop()+"</"+D+">",p.split("</"+D+">")[0].includes("\n"))for(;!p.includes(S)&&k.length;)p+=(O.startsWith(">")?">":"")+(k[0].startsWith("il")||k[0].startsWith("l")?"Availab":"Data")+k.shift();p=(p=p.split(S)[0]).replace("</title>","|TTT|").replace(/\n/g," ").replace(/\s+/g," ").replace(/(<([^>]+)>)/gi,""),h=(m[m.length-1]+p).toLowerCase(),p.length>20&&p.length<3e3&&(h.includes("availab")||h.includes("accessib"))&&(h.includes("data")||h.includes("code"))&&(p.includes("|TTT|")&&(p=p.split("|TTT|")[1]),a=(s=(s=(s=(await this.decode(p.trim())).replace(/"/g,"").replace(/\s+/g," ")).replace("<title","").replace("<p","")).trim()).toLowerCase(),s.length>20&&(a.includes("data")||a.includes("code")||a.includes("availab")||a.includes("accessib"))&&!I.includes(a)&&(I+=a,A.push(s))),f=c}}catch(e){}}return r?{pmcid:e,file:"https://static.oa.works/epmc/fulltext/"+e+".xml",pres:m,posts:d,splits:j,tags:C,statements:A,url:A?await this.src.epmc.statement.url(void 0,void 0,A,i):void 0}:A.length?A:void 0},t.src.epmc.statement.url=async function(e,t,i,r){var s,a,n,l,o,u;for(null==i&&(i=await this.src.epmc.statement(e,t,r)),u=[],s=(e,t)=>{var i,r,s,a,n;for((r=e.split(t)).shift(),n=[],s=0,a=r.length;s<a;s++)(i=t+(i=r[s]).split(" ")[0]).length>10&&i.includes("/")?((i=i.toLowerCase()).includes(")")&&(e.includes("(h")||e.includes("(10"))&&(i=i.split(")")[0].replace("(","")),i.endsWith(".")&&(i=i.slice(0,-1)),i.startsWith("10.")&&(i="https://doi.org/"+i),N.call(u,i)<0?n.push(u.push(i)):n.push(void 0)):n.push(void 0);return n},n=0,l=(o=null!=i?i:[]).length;n<l;n++)(a=o[n]).includes("http")&&await s(a,"http"),a.includes("10.")&&await s(a,"10.");return u.length?u:void 0},null==(O=r.src).google&&(O.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}t.src.google=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d;return null==e&&(e=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(a=this.params)?a.google:void 0),null==t&&(t=null!=(n=this.S.src.google)&&null!=(l=n.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(p=c.search)?p.key:void 0),e&&t&&i?(d="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(d)):{}},t.src.google.sheets=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;if(null==e&&(e=this.copy(this.params)),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(c=e.sheet)?c:e.sheets,delete e.sheet,delete e.sheets),!e.sheetid)return[];if(e.sheetid.startsWith("http")&&e.sheetid.includes("sheets.googleapis.com/v4/")?b=e.sheetid:(e.sheetid.includes("/spreadsheets/")?(_=e.sheetid.replace("/spreadsheets/d/","/spreadsheets/").split("/spreadsheets/")[1].split("/")[0],!e.sheet&&e.sheetid.includes("/values/")&&(e.sheet=e.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),e.sheetid=_):2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="Sheet1"),b="https://sheets.googleapis.com/v4/spreadsheets/"+e.sheetid+"/values/"+e.sheet+"?alt=json&key="+(null!=(p=null!=(d=this.S.src.google)&&null!=(h=d.secrets)?h.serverkey:void 0)?p:null!=(f=this.S.src.google)&&null!=(m=f.secrets)?m.apikey:void 0)),t=await this.fetch(b,{headers:{"Cache-Control":"no-cache"}}),!1===e.values)return t;if(!1===e.headers)return t.values;if(Array.isArray(e.headers))s=e.headers;else if(s=[],null!=t.values)for(a=0,o=(v=t.values.shift()).length;a<o;a++){r=v[a];try{r=r.trim()}catch(e){}s.push(r)}for(x=[],n=0,u=(g=null!=(y=t.values)?y:[]).length;n<u;n++){for(i in l=g[n],w={},s)try{w[s[i]]=l[i]}catch(e){}"{}"!==JSON.stringify(w)&&x.push(w)}return x},t.src.google.sheets._bg=!0,t.src.google.sheets._log=!1,null==(O=r.src).microsoft&&(O.microsoft={});try{r.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(e){}t.src.microsoft={},t.src.microsoft.bing=async function(e,t,i,s,a){var n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;return null==e&&(e=null!=(n=null!=(l=null!=this&&null!=(h=this.params)?h.bing:void 0)?l:null!=this&&null!=(f=this.params)?f.q:void 0)?n:null!=this&&null!=(m=this.params)?m.query:void 0),null==t&&(t=null!=(y=null!=this&&null!=(g=this.params)?g.key:void 0)?y:null!=(_=r.src.microsoft.bing)?_.key:void 0),null==i&&(i=null!=(v=null!=this&&null!=(b=this.params)?b.market:void 0)?v:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==a&&(a=null!=(c=null!=this&&null!=(p=this.params)?p.cache:void 0)?c:259200),null!=e&&null!=t&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+e,null!=(w=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":t},cache:a}))&&null!=(d=w.webPages)?d.value:void 0)?{total:w.webPages.totalEstimatedMatches,data:w.webPages.value}:{total:0,data:[]}},t.src.microsoft.bing._auth="@oa.works",null==(O=r.src).oadoi&&(O.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(e){}t.src.oadoi={_index:{settings:{number_of_shards:9}}},t.src.oadoi._key="doi",t.src.oadoi._prefix=!1,t.src.oadoi.search=async function(e){var t,i,s;if(null==e&&(e=null!=(t=null!=(i=this.params.oadoi)?i:this.params.doi)?t:this.params.search),"string"==typeof e&&e.startsWith("10."))return await this.sleep(900),s="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,this.fetch(s)},t.src.oadoi.doi=async function(e,t){var i,s,a;if(null==e&&(e=this.params.doi),null==t&&"src.oadoi.doi"===this.fn&&(t=this.refresh),"string"==typeof e&&e.startsWith("10.")){if(!0!==t&&(i=await this.src.oadoi(e))&&("number"!=typeof t||null!=i.updated&&new Date(i.updated).valueOf()>Date.now()-t))return i;try{if(C.log("getting from OADOI",e),await this.sleep(500),a="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,(s=await this.fetch(a))&&s.doi){try{await this.src.oadoi(await this.src.oadoi._format(s))}catch(e){}return s}}catch(e){}}},t.src.oadoi.hybrid=async function(e){var t,i,r,s,a,n;if(null==e&&(e=null!=(s=null!=(a=this.params.hybrid)?a:this.params.issn)?s:this.params.issns),"object"!=typeof e||Array.isArray(e)||(e=null!=(n=e.journal_issns)?n:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return(r="journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(r="("+r+")"),t=await this.src.oadoi.count(r+' AND oa_status:"closed"'),i=await this.src.oadoi.count(r+' AND oa_status:"hybrid"'),!!(t&&i/t>.001)},t.src.oadoi.oa={type:async function(e){var t,i,r,s,a;return null==e&&(e=null!=(i=null!=(r=this.params.type)?r:this.params.issn)?i:this.params.issns),"string"==typeof e&&e.startsWith("10.")&&(t=await this.src.oadoi.doi(e))&&(e=t.journal_issns),e&&"object"==typeof e&&!Array.isArray(e)&&(e=null!=(s=e.journal_issns)?s:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length?(a=await this.src.oadoi.terms("oa_status.keyword","journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*"),{issn:e,calculated:1===a.length?a[0].term:0===a.length?"unknown":JSON.stringify(a).toLowerCase().includes('"hybrid"')?await this.src.oadoi.hybrid(e):a[1].count/a[0].count>.001?a[0].term:"unknown",types:a}):{issn:e,calculated:"",types:[]}}},t.src.oadoi.load=async function(e,t,i,r,s){var a,n,l,o,u,c,p,d,h,f,m,y,g;null==e&&(e=null!=(d=this.params.url)?d:"https://api.unpaywall.org/feed/snapshot"),f=await this.epoch(),c=this.S.directory+"/import/oadoi/snapshot.jsonl";try{await fs.stat(c)}catch(t){C.log("OADOI downloading snapshot"),e.includes("api_key=")||(e+=(e.includes("?")?"&":"?")+"api_key="+this.S.src.oadoi.apikey),C.log(e),h=await fetch(e),g=fs.createWriteStream(c),await new Promise(((e,t)=>(h.body.pipe(g),h.body.on("error",t),g.on("finish",e)))),C.log("snapshot downloaded")}if(null==t&&(t="src_oadoi"),null==i&&(i=this.params.toalias),"number"==typeof i&&(i+=""),null==r&&(r=this.params.clear),C.log("loading oadoi",t,i,s),r){try{await this.index._send(t,"",void 0,!1,i,s),C.log("cleared"),await this.sleep(2e4)}catch(e){}await this.index._send(t,{settings:{number_of_shards:9}},void 0,!1,i,s),C.log("mapped"),await this.sleep(5e3)}for(y=0,l=[],n=[],p="",o=!1,a=async()=>{var e;if(l.length)return e=l.shift(),y+=e.length,C.log("OADOI bulk loading",e.length,y,l.length),await this.index._bulk(t,e,void 0,void 0,!1,i,s)},(m=fs.createReadStream(c)).on("data",(async e=>{var t,i,r;for("string"==typeof(t=e.toString("utf8"))&&t&&(p+=t);p.includes("\n");){[i,p]=p.replace("\n","X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),r={};try{r=JSON.parse(i)}catch(e){}(null!=r?r.doi:void 0)?(r=await this.src.oadoi._format(r),n.push(r)):C.log("oadoi load failed to parse record from string",i),3e4===n.length&&(l.push(n),n=[],a())}return null!=p?p:p=""})),m.on("error",(e=>C.log("oadoi load file stream error",JSON.stringify(e)))),m.on("end",(()=>(C.log("stream complete for oadoi load"),o=!0)));!o;)C.log("oadoi load streaming file",p.length,y,Math.floor((Date.now()-f)/1e3/60)+"m"),await this.sleep(3e4);for(;l.length;)await a();return u=Date.now(),C.log("oadoi load complete",y,f,u,Math.floor((u-f)/1e3/60)+"m"),y},t.src.oadoi.load._bg=!0,t.src.oadoi.load._async=!0,t.src.oadoi.load._log=!1,t.src.oadoi.load._auth="root",t.src.oadoi.load2025=function(){return this.src.oadoi.load(void 0,void 0,"2025",!0,this.S.dev?"http://10.108.0.3:9200":void 0)},t.src.oadoi.load2025._bg=!0,t.src.oadoi.load2025._async=!0,t.src.oadoi.load2025._log=!1,t.src.oadoi.load2025._auth="root",t.src.oadoi[2025]={_index:!0},t.src.oadoi[2025]._key="doi",t.src.oadoi[2025]._prefix=!1,t.src.oadoi.changes=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;if(null==t&&(t="src_oadoi"),null==i&&(i=this.params.toalias),"number"==typeof i&&(i+=""),i="2025",x=this.S.directory+"/import/oadoi/upto"+(i?"_"+i:""),null==e&&(e=this.params.changes),!e)try{e=parseInt((await fs.readFile(x)).toString())}catch(e){}if(!e)try{y=await this.index.translate("*",{size:1,sort:{updated:{order:"desc"}}}),e=(u=(await this.index._send(t+"/_search",y,void 0,!1,i,r)).hits.hits[0]._source).updated}catch(e){}if("string"==typeof e)try{e=new Date(e).valueOf()}catch(t){e=parseInt(e)}if("number"==typeof e){for(a=0,n=0,w=!1,o=0,p=(_=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;o<p;o++){if(m=_[o],f=new Date(m.last_modified).valueOf(),C.log(m.last_modified,f,e,null!=u?u.updated:void 0),"jsonl"===m.filetype&&(!e||f>e)){for await(h of(C.log("OADOI importing changes for",m.last_modified),n+=1,s=[],c=0,d=this.S.directory+"/import/oadoi/"+m.date+".jsonl.gz",b=await fetch(m.url),O=fs.createWriteStream(d),await new Promise(((e,t)=>(b.body.pipe(O),b.body.on("error",t),O.on("finish",e)))),readline.createInterface({input:fs.createReadStream(d).pipe(zlib.createGunzip())})))w=f,c+=1,g=JSON.parse(h.trim().replace(/\,$/,"")),g=await this.src.oadoi._format(g),s.push(g),a+=1,s.length>=3e4&&(C.log("OADOI bulk loading changes",n,s.length,c),await this.index._bulk(t,s,void 0,void 0,!1,i,r),s=[]);s.length&&await this.index._bulk(t,s,void 0,void 0,!1,i,r),fs.unlink(d)}if(w)try{await fs.writeFile(x,w)}catch(e){}}return l=await this.datetime(),await this.mail({to:null!=(v=this.S.log)?v.logs:void 0,subject:"OADOI changes "+a+" at "+l,text:JSON.stringify("Changes found "+a+" over "+n+" for "+e+" to "+w)}),C.log("oadoi changes complete",n,a),a}C.log("Timestamp day to work since is required - run load first to auto-generate")},t.src.oadoi.changes._bg=!0,t.src.oadoi.changes._async=!0,t.src.oadoi.changes._log=!1,t.src.oadoi.changes._auth="root",t.src.oadoi.changes._notify=!1,t.src.oadoi._format=function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m;for(t=["updated","evidence"],i=0,n=(f=null!=(h=e.oa_locations)?h:[]).length;i<n;i++)for(c=f[i],r=0,l=t.length;r<l;r++)c[s=t[r]]&&"string"==typeof c[s]&&c[s].includes("deprecated")&&(c[s]=void 0);for(a=0,o=(m=["best_oa_location","first_oa_location"]).length;a<o;a++)if(null!=e[d=m[a]])for(p=0,u=t.length;p<u;p++)s=t[p],e[d][s]&&"string"==typeof e[d][s]&&e[d][s].includes("deprecated")&&(e[d][s]=void 0);return e._id=e.doi.replace(/\//g,"_").toLowerCase(),e},null==(O=r.src).openai&&(O.openai={});try{r.src.openai=JSON.parse(SECRETS_OPENAI)}catch(e){}t.src.openai={},t.src.openai.chat=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d;return null==e&&(e=null!=(n=null!=(l=null!=(o=this.params.chat)?o:this.params.prompt)?l:this.params.q)?n:""),null==t&&(t=null!=(u=this.params.role)?u:"You are a helpful assistant"),null==i&&(i=null!=(c=this.params.model)?c:"gpt-4-1106-preview"),null==r&&(r=this.params.json),"string"==typeof e&&e.length&&(null!=(p=this.S.src.openai)?p.key:void 0)?(s={"Content-Type":"application/json",Authorization:"Bearer "+this.S.src.openai.key},a={model:i,messages:[]},r&&(a.response_format={type:"json_object"}),d={role:"system",content:t},a.messages.push(d),e={role:"user",content:e},a.messages.push(e),await this.fetch("https://api.openai.com/v1/chat/completions",{headers:s,body:a})):{}},t.src.openai.chat._auth="@oa.works",t.src.openai.grantid=async function(e,t){var i,r,s,a,n,l;if(null==e&&(e=null!=(s=this.params.prompt)?s:"Please extract the grant ID requested from the provided acknowledgements text."),null==t&&(t=null!=(a=this.params.text)?a:"Bill & Melinda Gates Foundation:\n\nThis work was supported by the USDA-NIFA Hatch/Multistate project W4147-TEN00539, the Bill and Melinda Gates Foundation (grant ID OPP1052983 and OPP1213329) and the Illumina Agricultural Greater Good Initiative grant."),"string"==typeof t&&t.length&&(null!=(n=this.S.src.openai)?n.key:void 0))try{return i={"Content-Type":"application/json",Authorization:"Bearer "+this.S.src.openai.key},r={model:"gpt-4o-2024-08-06",messages:[{role:"system",content:[{text:e,type:"text"}]},{role:"user",content:[{text:t,type:"text"}]}],response_format:{type:"json_schema",json_schema:{name:"grantid_response",schema:{type:"object",required:[],properties:{grantid:{type:["string","null"],description:"The grant id found, semi-colon seperated"}}},strict:!1}},temperature:1,max_tokens:256,top_p:1,frequency_penalty:0,presence_penalty:0},l=await this.fetch("https://api.openai.com/v1/chat/completions",{headers:i,body:r}),JSON.parse(l.choices[0].message.content)}catch(e){}return{}},t.src.openai.assistant=async function(e,t,i,r,s){var a,n;if(a=new OpenAI({apiKey:this.S.src.openai.key}),null==e&&(e=this.params.assistant),null==t&&(t=this.params.message),null==i&&(i=this.params.thread),null==r&&(r=this.params.instruct),null==s&&(s=this.params.model),e&&t){n={assistant:e,thread:i,message:t,response:void 0},i?n.posted=await a.beta.threads.messages.create(i,{role:"user",content:t}):(n.posted=await a.beta.threads.create({messages:[{role:"user",content:t}]}),n.thread=n.posted.id),n.run=await a.beta.threads.runs.createAndPoll(n.thread,{assistant_id:e,model:s,additional_instructions:r});try{n.messages=await a.beta.threads.messages.list(n.thread)}catch(e){}try{n.response=n.messages.body.data[0].content[0].text.value}catch(e){}try{n.response=JSON.parse(n.response)}catch(e){}return delete n.posted,delete n.run,delete n.messages,n}},t.src.openai.assistant._bg=!0,N=[].indexOf,null==(O=r.src).openalex&&(O.openalex={});try{r.src.openalex=JSON.parse(SECRETS_OPENALEX)}catch(e){}t.src.openalex=function(){return!0},t.src.openalex.works={_index:{settings:{number_of_shards:15}},_prefix:!1},t.src.openalex.works._format=function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E;for(i=0,n=(m=["concepts","topics","keywords","sustainable_development_goals","domains","fields","subfields","authorships","locations"]).length;i<n;i++)for(r=0,l=(w=null!=(y=e[m[i]])?y:[]).length;r<l;r++){E=w[r];try{null!=E.score&&(E.score=Math.floor(E.score))}catch(e){}try{null!=E.id&&"string"!=typeof E.id&&(E.id="https://openalex.org/"+E.id)}catch(e){}for(s=0,o=(x=["source","author","institutions","domain","field","subfield"]).length;s<o;s++){D=x[s];try{null!=(null!=(O=E[D])?O.id:void 0)&&"string"!=typeof E[D].id&&(E[D].id="https://openalex.org/"+E[D].id)}catch(e){}}}for(a=0,u=(k=["best_oa_location","primary_location","primary_topic"]).length;a<u;a++){d=k[a];try{(null!=(j=e[d])?j.score:void 0)&&(e[d].score=Math.floor(e[d].score))}catch(e){}try{null!=(null!=(S=e[d])?S.id:void 0)&&"string"!=typeof e[d].id&&(e[d].id="https://openalex.org/"+e[d].id)}catch(e){}for(h=0,c=(I=["source","domain","field","subfield"]).length;h<c;h++){D=I[h];try{null!=(null!=(A=e[d][D])?A.id:void 0)&&"string"!=typeof e[d][D].id&&(e[d][D].id="https://openalex.org/"+e[d][D].id)}catch(e){}}}try{e._id=null!=(g=null!=(_=e.doi)?_:e.DOI)?g:null!=(v=e.ids)?v.doi:void 0,e._id.includes("http")&&e._id.includes("/10.")&&(e._id="10."+e._id.split("/10.").pop()),e._id&&e._id.startsWith("10.")||(e._id=e.id.split("/").pop())}catch(t){e._id=e.id.split("/").pop()}try{for(C in t=[],e.abstract_inverted_index)for(b=e.abstract_inverted_index[C],f=0,p=b.length;f<p;f++)t[b[f]]=C;t.length&&(e.abstract=t.join(" "))}catch(e){}try{delete e.abstract_inverted_index}catch(e){}return e},t.src.openalex.works.doi=async function(e,t,i){var r,s,a;return null==e&&(e=this.params.doi),null==t&&"src.openalex.works.doi"===this.fn&&(t=this.refresh),null==i&&(i=null==(s=this.params.save)||s),!t&&(r=await this.src.openalex.works('ids.doi.keyword:"https://doi.org/'+e+'"',1))||(r=await this.fetch("https://api.openalex.org/works/https://doi.org/"+e+((null!=(a=this.S.src.openalex)?a.apikey:void 0)?"?api_key="+this.S.src.openalex.apikey:"")))&&r.id&&(r=await this.src.openalex.works._format(r),i&&await this.src.openalex.works(r)),r},t.src.openalex.works.title=async function(e){if(null!=e?e:e=this.params.title)return await this.src.openalex.works('title:"'+e+'"',1)},t.src.openalex.oa={type:async function(e){var t,i,r,s,a,n,l,o,u,c;return null==e&&(e=null!=(i=null!=(r=this.params.type)?r:this.params.issn)?i:this.params.issns),"string"==typeof e&&e.startsWith("10.")&&(t=await this.src.openalex.works.doi(e))&&(e=null!=(s=t.primary_location)&&null!=(a=s.source)?a.issn:void 0),"object"!=typeof e||Array.isArray(e)||(e=null!=(n=null!=(l=e.journal_issns)?l:e.ISSN)?n:null!=(o=e.primary_location)&&null!=(u=o.source)?u.issn:void 0),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length?(c=await this.src.openalex.works.terms("open_access.oa_status.keyword",'locations.source.issn.keyword:"'+e.join('" OR locations.source.issn.keyword:')+'"'),{issn:e,calculated:1===c.length?c[0].term:0===c.length?"unknown":JSON.stringify(c).toLowerCase().includes('"hybrid"')?await this.src.openalex.hybrid(e):c[1].count/c[0].count>.001?c[0].term:"unknown",types:c}):{issn:e,calculated:"",types:[]}}},t.src.openalex.manifest=async function(){var e,t,i,r,s;if("works"!==(s=null!=(t=null!=(i=this.params.manifest)?i:this.params.openalex)?t:"works"))return!1;e=async e=>{var t,i,r,s,a,n,l;for(l="",s=0,r=0,a=(n=e.entries).length;r<a;r++)i=n[r].url.split("=")[1].split("/")[0],(t=await this.epoch(i))>s&&(s=t,l=i);return l},(r={last:"",previous:"",manifest:await this.fetch("https://openalex.s3.amazonaws.com/data/"+s+"/manifest")}).last=await e(r.manifest);try{r.previous=await e(JSON.parse((await fs.readFile(this.S.directory+"/import/openalex/data/"+s+"/manifest")).toString()))}catch(e){}return r},t.src.openalex.load=async function(e,t,i,r,s,a){var n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G;if(X=await this.epoch(),null==e&&(e=null!=(E=null!=(L=this.params.load)?L:this.params.openalex)?E:"works"),"works"!==e)return!1;I=null!=(R=this.params.onlyinfo)&&R,null==t&&(t=this.params.changes),y=this.S.directory+"/import/openalex/data/"+e,null==a&&(a=this.params.toalias),"number"==typeof a&&(a+=""),a="15032024",null==i&&(i=this.params.clear),i&&(C.log("clearing",e,a),await this.index._send("src_openalex_"+e,"",void 0,!1,a),await this.sleep(2e4),await this.index._send("src_openalex_"+e,{settings:{number_of_shards:15}},void 0,!1,a),C.log("cleared and mapped"),await this.sleep(1e3)),null==s&&(s=0),b="";try{for(A=(await fs.readFile(y+"/manifest")).toString(),q=JSON.parse(A).entries,f=0,w=q.length;f<w;f++)p=q[f].url.split("=")[1].split("/")[0],(u=await this.epoch(p))>s&&(s=u,b=p)}catch(e){}if(null==r&&(r=null!=(T=this.params.sync)&&T),r&&(C.log("Openalex load syncing",e),$=await this._child("aws",["s3","sync","s3://openalex/data/"+e,y,"--no-sign-request"]),C.log("Openalex sync returned",$)),"string"==typeof t&&(t=[t]),!0===t)for(C.log("Checking for Openalex changes in",e),t=[],r||(await fs.writeFile(y+"/manifest"+(I?"info":""),await this.fetch("https://openalex.s3.amazonaws.com/data/"+e+"/manifest",{buffer:!0})),C.log("Openalex manifest "+(I?"temp saved for info":"updated"))),g=0,x=(M=JSON.parse((await fs.readFile(y+"/manifest"+(I?"info":""))).toString()).entries).length;g<x;g++)u=M[g].url.split("=")[1].split("/")[0],N.call(t,u)<0&&await this.epoch(u)>s&&t.push(u);for(C.log(t,s,b),_=0,O=(W=null!=t?t:[]).length;_<O;_++){o=W[_],C.log("Openalex checking if sync required for possibly changed files",e,o);try{await fs.stat(y+"/updated_date="+o)}catch(t){await this._child("aws",["s3","sync","s3://openalex/data/"+e+"/updated_date="+o,y+"/updated_date="+o,"--no-sign-request"]),C.log(o,"was not present, now synced")}}for(l=!0,V=0,d=0,D=0,J=[],n=async t=>{var i,r,s;for await(r of(i=[],readline.createInterface({input:fs.createReadStream(t).pipe(zlib.createGunzip())})))s=JSON.parse(r.trim().replace(/\,$/,"")),V+=1,i.push(await this.src.openalex.works._format(s)),i.length>=2e4&&(C.log("Openalex "+e+" "+a+" bulk loading",t,i.length,V),await this.index._bulk("src_openalex_"+e,i,void 0,void 0,!1,a),i=[]);return i.length&&(C.log("Openalex "+e+" "+a+" bulk loading final set for",t,i.length,d,D,V),await this.index._bulk("src_openalex_"+e,i,void 0,void 0,!1,a)),C.log("removing",t),await fs.unlink(t),D+=1,J.splice(J.indexOf(t),1),!0},v=0,k=(U=await fs.readdir(y)).length;v<k;v++)if(!(G=U[v]).startsWith("manifest")&&(null==t||(z=G.split("=")[1],N.call(t,z)>=0))){for(S=0,j=(F=await fs.readdir(y+"/"+G)).length;S<j;S++)if(m=F[S],l){for(d+=1;5===J.length;)await this.sleep(3e3);h=y+"/"+G+"/"+m,I?C.log("Openalex load would run",h):(J.push(h),C.log("Openalex load running",J),n(h))}else C.log("awaiting catch up",G,m,l),G.includes(l[0])&&(1===l.length||m.includes(l[1]))&&(l=!0);for(;0!==J.length;)await this.sleep(5e3);await fs.rmdir(y+"/"+G)}if(I)try{await fs.unlink(y+"/manifestinfo")}catch(e){}else null!=A&&Array.isArray(t)&&t.length&&await fs.writeFile(y+"/manifestprevious",A);return B={started:X,took:await this.epoch()-X,expected:d,processed:D,total:V,sync:r,last:s,lasth:b,changes:t},(V>0||1===(new Date).getDay())&&(c=await this.datetime(),await this.mail({to:null!=(P=this.S.log)?P.logs:void 0,subject:"Openalex works load or changes "+V+" at "+c,text:JSON.stringify(B)})),C.log(B),B},t.src.openalex.load._bg=!0,t.src.openalex.load._log=!1,t.src.openalex.load._auth="root",t.src.openalex.changes=async function(e){var t,i,r,s,a;if(s=await this.epoch(),C.log("Openalex checking for changes by running load on comparison to manifest"),r=await this.src.openalex.load(void 0,!0),a=(t=await this.epoch())-s,"src.openalex.changes"!==this.fn)for(;a<36e5;)i=36e5-a,C.log("Openalex changes waiting",i,"to loop"),await this.sleep(i),a=(t=await this.epoch())-s;return C.log("Openalex changes took",t-s),r},t.src.openalex.changes._log=!1,t.src.openalex.changes._bg=!0,t.src.openalex.changes._async=!0,t.src.openalex.changes._auth="root",t.src.openalex.sources={_index:!0,_prefix:!1},t.src.openalex.sources.load=async function(){var e,t,i,r,s,a,n,l,o,u;for(await this.src.openalex.sources(""),o=0,e=[],u="https://api.openalex.org/sources?"+((null!=(s=this.S.src.openalex)?s.apikey:void 0)?"api_key="+this.S.src.openalex.apikey+"&":"")+"per-page=200&cursor=",l=await this.fetch(u+"*");null!=l&&"object"==typeof l&&Array.isArray(l.results)&&l.results.length;){for(t=0,i=(a=l.results).length;t<i;t++)(r=a[t])._id=r.id.split("/").pop(),e.push(r);e.length>=2e4?(o+=e.length,await this.src.openalex.sources(e),e=[]):await this.sleep(200),(null!=(n=l.meta)?n.next_cursor:void 0)&&(l=await this.fetch(u+encodeURIComponent(l.meta.next_cursor)))}return e.length&&await this.src.openalex.sources(e),o},t.src.openalex.sources.load._async=!0,t.src.openalex.sources.load._bg=!0,t.src.openalex.hybrid=async function(e){var t,i,r,s,a;if(null==e&&(e=null!=(s=null!=(a=this.params.hybrid)?a:this.params.issn)?s:this.params.issns),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return r='(locations.source.issn.keyword:"'+e.join('" OR locations.source.issn.keyword:"')+'" OR locations.source.issn_l.keyword:"'+e.join('" OR locations.source.issn_l.keyword:"')+'")',t=await this.src.openalex.works.count(r+' AND open_access.oa_status:"closed"'),i=await this.src.openalex.works.count(r+' AND open_access.oa_status:"hybrid"'),t&&i/t>.001},N=[].indexOf,t.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},t.src.pubmed.doi=async function(e){var t;if(null==e&&(e=this.params.doi),e&&(t=await this.src.pubmed('identifier.doi:"'+e+'"',1)))return t},t.src.pubmed.pmc=async function(e){var t;if(null==e&&(e=this.params.pmc),e&&(t=await this.src.pubmed('identifier.pmc:"PMC'+e.toString().toLowerCase().replace("pmc","")+'"',1)))return t},t.src.pubmed.entrez={},t.src.pubmed.entrez.summary=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v;v="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),v+="&id="+i):v+="&query_key="+e+"&WebEnv="+t;try{for(p=await this.convert.xml2json(await this.fetch(v)),h=[],Array.isArray(p.eSummaryResult.DocSum)||(p.eSummaryResult.DocSum=[p.eSummaryResult.DocSum]),f=p.eSummaryResult.DocSum,s=0,o=f.length;s<o;s++){for(r={id:(d=f[s]).Id},m=d.Item,n=0,u=m.length;n<u;n++)if("List"===(a=m[n])._.Type){if(r[a._.Name]=[],null!=a.Item)for(y=a.Item,l=0,c=y.length;l<c;l++)g=y[l],(_={})[g._.Name]=g.$,r[a._.Name].push(_)}else r[a._.Name]=a.$;if(h.push(r),null==i||!i.includes(","))return h[0]}return h}catch(e){}},t.src.pubmed.entrez.pmid=async function(e){var t,i,r;null==e&&(e=this.params.pmid),r="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return await this.sleep(200),t=await this.fetch(r),i=await this.convert.xml2json(t),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey,i.ePostResult.WebEnv)}catch(e){}},t.src.pubmed.search=async function(e,t,i=10,r=!1){var s,a,n,l,o,u,c,p,d,h,f,m;null==e&&(e=null!=(c=this.params.search)?c:this.params.q),m="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof r&&(r=r.split(",")),Array.isArray(r))d={total:r.length,data:[]};else{if(await this.sleep(200),d=await this.fetch(m),d={total:(h=await this.convert.xml2json(d)).eSearchResult.Count[0],data:[]},!0===r)return d.data=h.eSearchResult.IdList[0].Id,d;r=h.eSearchResult.IdList[0].Id}if(t)for(s=0,n=r.length;s<n&&(f=r[s],o=await this.src.pubmed.pmid(f),d.data.push(o),d.data.length!==i);s++);else for(p=await this.src.pubmed.entrez.summary(void 0,void 0,r),a=0,l=p.length;a<l&&(u=p[a],d.data.push(u),d.data.length!==i);a++);return d}catch(e){}},t.src.pubmed.pmid=function(e){null==e&&(e=this.params.pmid);try{return this.src.pubmed.entrez.pmid(e)}catch(e){}},t.src.pubmed.aheadofprint=async function(e){null==e&&(e=this.params.pmid);try{return await this.sleep(100),(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).includes("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){}},t.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},t.src.pubmed.availability=async function(e){var t,i,r,s,a;return null==e&&(e=null!=(t=null!=(i=null!=(r=null!=(s=null!=(a=this.params.pubmed)?a:this.params.availability)?s:this.params.pmc)?r:this.params.pmcid)?i:this.params.PMC)?t:this.params.PMCID),e="pmc"+(e+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(e)},t.src.pubmed.availability.statement=function(e,i){return t.src.epmc.statement(e,i)},t.src.pubmed.load=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m;for(null==e&&"changes"===this.params.load&&(e=!0),f=null!=(c=this.params.streamers)?c:1,n=null!=(p=this.params.howmany)?p:-1,this.refresh&&!e&&await this.src.pubmed(""),i=e?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",s=[],a="number"==typeof this.params.load?this.params.load:"number"==typeof this.params.changes?this.params.changes:void 0,l=0,o=(d=(await this.fetch(i)).split('href="')).length;l<o;l++)(r=d[l].split('"')[0]).endsWith(".gz")&&r.includes(a+".xml")||!a&&r.startsWith("pubmed")&&r.endsWith(".gz")&&("baseline"===this.params.load||this.refresh&&!e||!await this.src.pubmed.count('srcfile:"'+i+r+'"'))?s.push(i+r):r.endsWith(".md5")||C.log("pubmed load skipping file",i+r);for(h=0,m=0,t=async t=>{var i,r,a,l,o,u,c,p,d,f,y,g,_,v,b,w,x,O,k,j,S;C.log("Pubmed loading"+(e?" changes":""),t,s.length,h),u=[],b={};try{for await(g of readline.createInterface({input:(await fetch(t)).body.pipe(zlib.createGunzip())}))if("</PubmedArticle>"===(g=g.trim().replace("&amp;","&"))){if(m+=1,b.srcfile=t,b._id=b.PMID,u.push(b),b={},m===n)break}else if(!(g.startsWith("<?")||g.includes("?xml")||g.includes("!DOCTYPE")||g.includes("/>")||g.includes("PubmedArticle")||g.includes("PubmedData")||g.includes("History")||g.includes("ArticleIdList")||g.includes("List>"))){for(d in g.split(">")[0].split(" ")[0].replace("<",""),f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(g.includes(d)||g.includes(d.replace(">"," ")))&&null==b[v=f[d]]&&(b[v]=g.split(">")[1].split("</")[0]);if(g.includes("<MedlinePgn>"))b.pages=g.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ");else if(g.includes("<ISSN"))null==b.ISSN&&(b.ISSN=[]),S=g.split(">")[1].split("</")[0],N.call(b.ISSN,S)<0&&b.ISSN.push(S);else if(g.includes("<Keyword>"))null==b.keyword&&(b.keyword=[]),S=g.split(">")[1].split("</")[0],N.call(b.keyword,S)<0&&b.keyword.push(S);else if(g.includes("<GeneSymbol>"))null==b.gene&&(b.gene=[]),S=g.split(">")[1].split("</")[0],N.call(b.gene,S)<0&&b.gene.push(S);else if(g.includes("<PublicationType>")||g.includes("<PublicationType "))null==b.type&&(b.type=[]),S=g.split(">")[1].split("</")[0],N.call(b.type,S)<0&&b.type.push(S);else if(g.includes("<Chemical>"))null==b.chemical&&(b.chemical=[]),b.chemical.push({});else if(g.includes("<NameOfSubstance>")||g.includes("<NameOfSubstance "))null==b.chemical&&(b.chemical=[{}]),b.chemical[b.chemical.length-1].name=g.split(">")[1].split("</")[0],b.chemical[b.chemical.length-1].nameID=g.split('UI="')[1].split('"')[0];else if(g.includes("<RegistryNumber>"))null==b.chemical&&(b.chemical=[{}]),b.chemical[b.chemical.length-1].registry=g.split(">")[1].split("</")[0];else if(g.includes("<DataBank>")||g.includes("<DataBank "))null==b.databank&&(b.databank=[]),b.databank.push({});else if(g.includes("<DataBankName>"))null==b.databank&&(b.databank=[{}]),b.databank[b.databank.length-1].name=g.split(">")[1].split("</")[0];else if(g.includes("<AccessionNumber>"))null==b.databank&&(b.databank=[{}]),null==(r=b.databank[b.databank.length-1]).accession&&(r.accession=[]),b.databank[b.databank.length-1].accession.push(g.split(">")[1].split("</")[0]);else if(g.includes("<Grant>")||g.includes("<Grant "))null==b.grant&&(b.grant=[]),b.grant.push({});else if(g.includes("<GrantID>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].id=g.split(">")[1].split("</")[0];else if(g.includes("<Acronym>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].acronym=g.split(">")[1].split("</")[0];else if(g.includes("<Agency>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].agency=g.split(">")[1].split("</")[0];else if(g.includes("<Country>"))b.grant&&!b.grant[b.grant.length-1].country||b.country?b.grant&&b.grant.length&&(b.grant[b.grant.length-1].country=g.split(">")[1].split("</")[0]):b.country=g.split(">")[1].split("</")[0];else if(g.includes("<MeshHeading>")||g.includes("<MeshHeading "))null==b.mesh&&(b.mesh=[]),b.mesh.push({});else if(g.includes("<DescriptorName>")||g.includes("<DescriptorName "))null==b.mesh&&(b.mesh=[{}]),b.mesh[b.mesh.length-1].description=g.split(">")[1].split("</")[0],b.mesh[b.mesh.length-1].descriptionID=g.split('UI="')[1].split('"')[0];else if(g.includes("<QualifierName>")||g.includes("<QualifierName "))null==b.mesh&&(b.mesh=[{}]),null==(a=b.mesh[b.mesh.length-1]).qualifier&&(a.qualifier=[]),b.mesh[b.mesh.length-1].qualifier.push({name:g.split(">")[1].split("</")[0],id:g.split('UI="')[1].split('"')[0]});else if(g.includes("<Author>")||g.includes("<Author ")||g.includes("<Investigator>")||g.includes("<Investigator "))null==b.author&&(b.author=[]),b.author.push(g.includes("<Investigator")?{investigator:!0}:{});else if(g.includes("<LastName>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].lastname=g.split(">")[1].split("</")[0];else if(g.includes("<ForeName>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].firstname=g.split(">")[1].split("</")[0];else if(g.includes("<Affiliation>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].affiliation=g.split(">")[1].split("</")[0];else if(g.includes("<Identifier>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].identifier=g.split(">")[1].split("</")[0];else if(g.includes("<Note>")||g.includes("<Note ")||g.includes("<GeneralNote>")||g.includes("<GeneralNote "))null==b.notes&&(b.notes=[]),b.notes.push(g.split(">")[1].split("</")[0]);else if(g.includes("<DeleteCitation>")||g.includes("<DeleteCitation "))b.deletedFromMedline=!0;else if(g.includes("<ArticleId>")||g.includes("<ArticleId ")){null==b.identifier&&(b.identifier={});try{c=g.split('IdType="')[1].split('"')[0],null==(l=b.identifier)[c]&&(l[c]=g.split(">")[1].split("</")[0])}catch(e){}}else if(!g.includes("</")&&(g.includes("Date>")||g.includes("<Date")||g.includes("<PubMedPubDate")||g.includes("<ArticleDate>")||g.includes("ArticleDate ")||g.includes("<PubDate>")||g.includes("<PubDate "))){k=g.split(">")[0].split(" ")[0].replace("<","");try{(_=g.toLowerCase()).includes("pubstatus")&&(j=_.split(">")[0].split("pubstatus")[1]),j.includes('"')&&(j=j.split('"')[1])}catch(e){}}else if(k&&(g.includes("<Year>")||g.includes("<Month>")||g.includes("<Day>"))){null==b.dates&&(b.dates={}),O=k+(j?"_"+j:""),null==(o=b.dates)[O]&&(o[O]={}),b.dates[O][g.split(">")[0].replace("<","").toLowerCase()]=g.split(">")[1].split("</")[0],delete b.dates[O].date,delete b.dates[O].timestamp;try{b.dates[O]=await this.dateparts(b.dates[O])}catch(e){}try{j&&(b.dates[O].pubstatus=j)}catch(e){}}else if(k&&g.includes("</"+k))k="",j="";else if(g.includes("<Reference>")||g.includes("<Reference "))null==b.references&&(b.references=[]);else if(g.includes("<Citation")){null==b.references&&(b.references=[]),x={author:[]};try{for(w=g.split(". ")[0].split(", "),p=0,y=w.length;p<y;p++)i=w[p],x.author.push({name:i})}catch(e){}try{x.title=g.split(". ")[1].split("?")[0].trim()}catch(e){}try{x.journal=g.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{g.includes("doi.org/")&&(x.doi=g.split("doi.org/")[1].split(" ")[0].trim())}catch(e){}try{x.url="http"+rc.split("http")[1].split(" ")[0]}catch(e){}"{}"!==JSON.stringify(x)&&b.references.push(x)}}u.length&&(await this.src.pubmed(u),C.log(t,m))}catch(e){}return h-=1};s.length&&!(n>0&&m>=n);)await this.sleep(1e3),h<f&&(h+=1,u=s.shift(),await t(u));return C.log(m,s.length),this.params.howmany?batch:m},t.src.pubmed.load._bg=!0,t.src.pubmed.load._log=!1,t.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},t.src.pubmed.changes._bg=!0,t.src.pubmed.changes._log=!1,t.src.pubmed.changes._notify=!1,t.src.ror={_index:!0,_prefix:!1},t.src.ror.query=function(e){var t;if(null==e&&(e=null!=(t=this.params.query)?t:this.params.q),"string"==typeof e)return this.fetch('https://api.ror.org/organizations?query="'+e+'"')},t.src.ror.ror=async function(e,t){var i,r,s;if(null==t&&(t=this.refresh),null==e&&(e=this.params.ror),"string"==typeof e&&!e.includes(" ")&&(e=e.split("/").pop()).length<11){if((null!=(r=t?void 0:await this.src.ror(e))?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.fetch("https://api.ror.org/organizations/"+e))?r.id:void 0)return s=await this.src.ror._format(r),this.waitUntil(this.src.ror(s)),s}},t.src.ror.grid=async function(e){var t,i,r,s;if(null==e&&(e=this.params.grid),"string"==typeof e&&e.startsWith("grid.")){if((null!=(r=await this.src.ror('external_ids.GRID.all:"'+e+'"'))?r.id:void 0)||1===(null!=r&&null!=(t=r.hits)?t.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(e))&&null!=(i=r.items)?i[0]:void 0)return s=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(s)),s}},t.src.ror.title=async function(e){var t,i,r,s,a;if(null==e&&(e=null!=(t=this.params.title)?t:this.params.q),"string"==typeof e){if(this.refresh||(s=await this.src.ror('title:"'+e+'"')),(null!=s?s.id:void 0)||1===(null!=s&&null!=(i=s.hits)?i.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(e))&&null!=(r=s.items)?r[0]:void 0)return a=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(a)),a}},t.src.ror._format=async function(e,t){try{e._id=e.id.split("/").pop()}catch(e){}return null==e.createdAt&&(e.createdAt=null!=t?t:await this.epoch()),e},t.src.ror.dumps=function(){return this.fetch("https://zenodo.org/api/records/?communities=ror-data&sort=mostrecent")},t.src.ror.load=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y;null==e&&(e=this.refresh),m=0,t=[];try{a=await this.src.ror.dumps(),null==e&&(o=await this.epoch(a.hits.hits[0].created.split("+")[0]),null!=(null!=(l=await this.src.ror("src:*",{sort:{createdAt:"desc"},size:1}))?l.hits:void 0)&&(l=l.hits.hits[0]._source))}catch(e){}if(C.log(o,null!=l?l.createdAt:void 0,null!=l?l.src:void 0),e||null==l||null==o||null!=l&&null!=o&&l.createdAt<o)for await(u of(n=a.hits.hits[0].files[0].links.self,C.log(n),i=await this.epoch(),f=!1,s=!1,c="",r=n.replace("/content","").split("/").pop(),h=this.S.directory+"/import/ror/"+r,d=await fetch(n),y=fs.createWriteStream(h),await new Promise(((e,t)=>(d.body.pipe(y),d.body.on("error",t),y.on("finish",e)))),await this._child("unzip",[h,"-d",this.S.directory+"/import/ror/"]),C.log("ROR snapshot downloaded"),await this.src.ror(""),readline.createInterface({input:fs.createReadStream(h.replace(".zip",".json"))})))try{f||5!==u.length||"{"!==u.replace(/\s\s\s\s/,"")?s||5!==u.replace(",","").length||"}"!==u.replace(/\s\s\s\s/,"").replace(",","")?"["!==u&&"]"!==u&&(c+=u):(s=!0,c+="}"):(f=!0,c="{"),!0===f&&!0===s&&(f=!1,s=!1,(p=await this.src.ror._format(JSON.parse(c),i)).src=n,null==p.createdAt&&(p.createdAt=i),c="",m+=1,t.push(p),2e4===t.length&&(C.log("ROR bulk loading",t.length,m),await this.src.ror(t),t=[]))}catch(e){}return t.length&&await this.src.ror(t),C.log(m),m},t.src.ror.load._bg=!0,t.src.ror.load._async=!0,t.src.ror.load._auth="root",null==(O=r.src).zenodo&&(O.zenodo={});try{r.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(e){}t.src.zenodo={deposition:{},records:{}},t.src.zenodo.records.search=function(e,t){var i,r,s;return null==e&&(e=this.params),null==t&&(t=this.params.dev),r=null!=(i=this.params.size)?i:10,s="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+r+"&q="+encodeURIComponent(e),this.fetch(s)},t.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},t.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){}},t.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},t.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},t.src.zenodo.records.format=function(e){var t,i,r,s,a,n,l,o,u,c,p;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=e.metadata.description}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,s=0,n=c.length;s<n;s++)if("pdf"===(r=c[s]).type){null==o.pdf&&(o.pdf=r.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),p=e.metadata.creators,a=0,l=p.length;a<l;a++){if("string"==typeof(t=p[a])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},t.src.zenodo.deposition.create=async function(e,t,i,r){var s,a,n,l,o,u,c,p,d;return null==r&&(r=null!=(n=this.params.dev)?n:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=r?null!=(l=this.S.src)&&null!=(o=l.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(d="https://"+(r?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(a={metadata:e}).metadata.upload_type||(a.metadata.upload_type="publication",a.metadata.publication_type="article"),null==(s=a.metadata).creators&&(s.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(p=await this.fetch(d,{method:"POST",body:a,mode:"cors",credentials:"include",headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))?p.id:void 0)&&(t.content||t.file)&&(p.uploaded=await this.src.zenodo.deposition.upload(p.id,t.content,t.file,t.name,t.url,i,r)),t.publish&&(p.published=await this.src.zenodo.deposition.publish(p.id,i,r)),p):await this.fetch(d,{method:"POST",body:a,headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.upload=async function(e,t,i,r,s,a,n){var l,o,u,c;if(null==e&&(e=null!=(l=this.params.upload)?l:this.params.id),null==t&&(t=this.params.content),null==r&&(r=this.params.filename),!t&&!i)try{i=this.request.files[0]}catch(e){}if(s&&!t&&!i)try{t=await this.fetch(s,{buffer:!0,headers:{referer:this.S.dev||n?"https://sandbox.zenodo.org":"https://zenodo.org"}})}catch(e){}return null==a&&(a=this.params.token),null==a&&(a=this.S.dev||n?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==n&&(n=this.params.dev),null!=a&&null!=e&&(s="https://"+(this.S.dev||n?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+a,this.fetch(s,{file:null!=t?t:i,filename:r,headers:{referer:this.S.dev||n?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.publish=function(e,t,i){var r,s,a,n,l;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(a=this.S.src)&&null!=(n=a.zenodo)?n.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(l,{method:"POST",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.delete=async function(e,t,i){var r,s,a,n;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(a=this.S.src.zenodo)?a.token:void 0),null!=t&&null!=e&&(n="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(n,{method:"DELETE",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}),!0)},t.blacklist=async function(e){var t,i,r,s,a,n,l,o;if(null==e&&(e=this.params.url),"number"==typeof e&&(e=e.toString()),null!=e&&(e.length<4||-1===e.indexOf(".")))return!1;for(i=[],s=0,n=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;s<n;s++)r=o[s],i.push(r.url.toLowerCase());if(e){if(!e.startsWith("http")&&e.includes(" "))return!1;for(a=0,l=i.length;a<l;a++)if(t=i[a],e.includes(t.toLowerCase()))return!0;return!1}return i},t.bug=function(){var e,t,i,r,s,a,n,l,o,u,c;if(this.params.contact)return"";for(e in c=["help@oa.works"],u="",this.params)u+=e+": "+JSON.stringify(this.params[e],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(r=this.params)?r.form:void 0)?o+=" Wrong article":"bug"===(null!=(s=this.params)?s.form:void 0)?o+=" Bug":"general"===(null!=(a=this.params)?a.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(n=null!=(l=this.params)?l.form:void 0)&&"uninstall"!==n||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:t=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:t}},t.cache=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==e&&(e=this.request);try{for(d=e.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)a=u[l],-1!==d.indexOf(a+"=")&&(n=new RegExp(a+"=.*?&"),d=d.replace(n,"")),-1!==d.indexOf("&"+a+"=")&&(d=d.split("&"+a+"=")[0]);s=new URL(d)}catch(e){}}catch(e){}if(null!=e)try{if(null==s&&(s=new URL(e.url)),r=new Request(s.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t)return p=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),p;t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,c))}catch(e){}}},t.cache._auth="system",N=[].indexOf,null==t.convert&&(t.convert={}),t.convert.json2csv=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;if(null==e&&(e=null!=(m=this.body)?m:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(y=e.hits)?y.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),p=null!=(g=t.quote)?g:'"',O=null!=(_=t.separator)?_:",",u=null!=(v=t.newline)?v:"\n",e.length){for(r=null!=(b=t.keys)?b:[],f="",s=0,l=e.length;s<l;s++){if(h=e[s],f.length&&(f+=u),!1!==t.es&&(h._source||h.fields)){for(c in d={},x=null!=(w=h._source)?w:h.fields)null==d[c]&&(d[c]=x[c]);h=d}if(t.flatten&&(h=await this.flatten(h)),t.subset&&(h=await this.dot(h,t.subset)),!t.keys)for(n in h)null!=h[n]&&N.call(r,n)<0&&r.push(n);for(a=0,o=r.length;a<o;a++){if(i=r[a],f.length&&!f.endsWith(u)&&(f+=O),f+=p,null!=h[i]){try{Array.isArray(h[i])&&1===h[i].length&&Array.isArray(h[i][0])&&(h[i]=h[i][0])}catch(e){}try{Array.isArray(h[i])&&h[i].length&&"object"!=typeof h[i][0]&&(h[i]=h[i].join(","))}catch(e){}try{"object"==typeof h[i]&&(h[i]=JSON.stringify(h[i]))}catch(e){}try{'"'===p&&-1!==h[i].indexOf(p)&&(h[i]=h[i].replace(/"/g,p+p))}catch(e){}try{h[i]=h[i].replace(/\n/g," ")}catch(e){}try{h[i]=h[i].replace(/\s\s/g," ")}catch(e){}try{f+=h[i]}catch(e){}}f+=p}}return p+r.join(p+O+p)+p+"\n"+f}return""},t.convert.csv2json=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w;if(null==t&&(t=this.params),null==e&&(e=null!=(h=this.body)?h:this.params.csv),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(f=t.url)?f:e)),_=[],"string"==typeof e&&e.length&&(d=null!=(m=t.quote)?m:'"',b=null!=(y=t.separator)?y:",",c=null!=(g=t.newline)?g:"\n",(u=e.split(c)).length))for(r=u.shift().split(d+b),p="",s=0,n=u.length;s<n;s++)if((w=(p+=(p?c:"")+(o=u[s])).split(d+b)).length===r.length&&(!d||o.endsWith(d))){for(p="",v={},a=0,l=r.length;a<l;a++)if((i=r[a]).startsWith(d)&&(i=i.replace(d,"")),i.endsWith(d)&&(i=i.substring(0,i.length-1)),w.length&&(v[i]=w.shift(),v[i])){v[i].startsWith(d)&&(v[i]=v[i].replace(d,"")),!w.length&&v[i].endsWith(d)&&(v[i]=v[i].substring(0,v[i].length-1));try{v[i]=JSON.parse(v[i])}catch(e){}}_.push(v)}return _},t.convert.csv2html=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g;if(null==e&&(e=null!=(p=this.body)?p:this.params.csv),null==t&&(t=this.params),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(d=t.url)?d:e)),'"',m="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",m+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(o=e.split("\n")).length){for(m+="<thead><tr>",u=0,i=0,s=(h=o.shift().split('","')).length;i<s;i++)m+='<th style="padding:2px; border:1px solid #ccc;">'+h[i].replace(/"/g,"")+"</th>",u+=1;for(m+="</tr></thead>\n<tbody>\n",r=0,a=o.length;r<a;r++){for(l=o[r],m+="<tr>";-1!==l.indexOf(',"",');)l=l.replace(',"",',',"XXX_EMPTY_XXX",');for(;l.startsWith('"",');)l=l.replace('"",','"XXX_EMPTY_XXX",');for(;l.endsWith(',""');)l=l.slice(0,l.length-3);for(g=0,c=0,n=(f=(l=l.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<n;c++)g+=1,m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(y=(y=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===y.indexOf("{")||0===y.indexOf("[")?(m+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",m+=await this.convert.json2html(JSON.parse(y.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),m+="</div>"):m+=y.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),m+="</td>";for(;g<u;)m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',g+=1;m+="</tr>\n"}m+="</tbody>\n"}return m+"</table>"},t.convert.json2html=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d;if(null==e&&(e=null!=(u=this.body)?u:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.new)for(null==t.edit&&(t.edit=!0),e={},r=0,a=(c=await this.index.keys(this.route.replace(/\//g,"_"))).length;r<a;r++)e[c[r]]="";if(t.subset&&!Array.isArray(e))for(o=t.subset.split(".");(l=o.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[l];)e=e[l];if(Array.isArray(e)||null!=(null!=e&&null!=(p=e.hits)?p.hits:void 0)&&!1!==t.es)return null!=o&&(t.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(e,t));if(d="<div>",t.flatten&&(e=await this.flatten(e),d+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(o.length)for(s=0,n=o.length;s<n;s++)e=e[o[s]];d+="<h3>"+t.subset+":</h3>",d+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return i=e=>{var r,s,a,n,l,o,u,c,p,h,f;if(t.edit&&null==e.comments&&(e.comments=""),t.keys)for(n=0,s=(c=t.keys).length;n<s;n++)null==e[u=c[n]]&&(e[u]="");for(r in h=[],e){try{Array.isArray(e[r])&&1===e[r].length&&Array.isArray(e[r][0])&&(e[r]=e[r][0])}catch(e){}if(null==e[r]||Array.isArray(e[r])&&!e[r].length||t.keys&&!(N.call(t.keys,r)>=0))h.push(void 0);else{if(d+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+r+"</p></b></div>",d+='<div style="float:left;">',d+=t.edit?'<textarea class="PForm" id="'+r+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[r]))if("object"==typeof e[r][0])for(l=0,a=(p=e[r]).length;l<a;l++)o=p[l],i(o);else{try{f=e[r].join(", ")}catch(t){try{f=JSON.stringify(e[r])}catch(t){f=e[r]}}try{d+=(t.edit?"":"<p>")+f+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[r]?i(e[r]):d+=(t.edit?"":"<p>")+e[r]+(t.edit?"":"</p>");d+=t.edit?"</textarea>":"",h.push(d+="</div></div>")}}return h},i(e),d+="</div>"},t.convert.json2txt=async function(e){var t,i,r;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),r=[],t=async function(e){var i,s,a,n,l;if(Array.isArray(e)){for(n=[],s=0,a=e.length;s<a;s++)i=e[s],n.push(await t(i));return n}if("object"==typeof e){for(i in l=[],e)l.push(await t(e[i]));return l}if(e)return r.push(e)},await t(e),r.join(" ")},t.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},t.convert.hex2bin=function(e){var i,r,s,a,n;for(n=[],i=0,s=(a=Array.isArray(e)?e:[e]).length;i<s;i++)r=a[i],n.push(t.convert._hexMatch[r.toLowerCase()]);return n.join("")},t.convert.bin2hex=function(e){var i,r,s,a,n,l,o,u,c;if(!Array.isArray(e)){for(i=[],c=e.split(""),o="";c.length;)4===(o+=c.shift()).length&&(i.push(o),o="");e=i}for(a in u=[],r={},t.convert._hexMatch)r[t.convert._hexMatch[a]]=a;for(s=0,l=e.length;s<l;s++)n=e[s],u.push("0x"+r[n]);return new E(u).toString()},t.convert.buf2bin=async function(e){var i,r;for(E.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),r="",i=0;i<e.length;)r+=await t.convert.hex2bin(e[i]),i++;return r},t.convert.stream2txt=function(e){var t;return t=[],new Promise(((i,r)=>(e.on("data",(e=>t.push(E.from(e)))),e.on("error",(e=>r(e))),e.on("end",(()=>i(E.concat(t).toString("utf8")))))))},t.convert.xml2json=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h,f,m,y;if(null==e&&(e=null!=(d=this.params.xml2json)?d:this.params.url),f={},"string"==typeof e)for(e.startsWith("http")&&(e=await this.fetch(e)),i="",u="",m=!1,r=!1;t=e[0];)if(e=e.slice(1),"\ufeff"!==t&&"\t"!==t&&"\r"!==t&&"\n"!==t&&(" "!==t||i.length&&!i.endsWith(">"))&&("<"===i&&"/"!==t&&"?"!==t&&"!"!==t&&(m=!0),((i+=t).endsWith("</")&&i.split("</").length-1===i.split(">").length||i.endsWith("/>")&&!i.split("/>")[0].includes(">"))&&(r=!0),">"===t)){if(C.log(u),r){if(r=!1,""!==(i=i.split("</")[0])){if(p=await this.dot(f,u,void 0,void 0,!0))Array.isArray(p)?(p.length||(p=[{}]),null!=p[p.length-1].$?(Array.isArray(p[p.length-1].$)||(p[p.length-1].$=[p[p.length-1].$]),p[p.length-1].$.push(i)):p[p.length-1].$=i):p.$=i,i=p;else{i={$:i};try{(c=await this.dot(f,u.slice(0,u.lastIndexOf(".")),void 0,void 0,!0))&&(i._=c[u.split(".").pop()]._)}catch(e){}}"object"==typeof i&&null==i._&&null!=i.$&&(i=i.$),await this.dot(f,u,i,void 0,!0)}u=u.includes(".")?u.slice(0,u.lastIndexOf(".")):""}else if(m){for(m=!1,l={},s=0,n=(h=i.replace("<","").replace(">","").split(" ")).length;s<n;s++)(o=h[s]).includes("=")?o.length&&([a,y]=o.split("="),l[a.trim().replace(/"/g,"")]=y.trim().replace(/"/g,"")):u+=(u&&!u.endsWith(".")?".":"")+o;(p=await this.dot(f,u,void 0,void 0,!0))?(Array.isArray(p)||(p=[p]),p.push("{}"!==JSON.stringify(l)?{_:l}:{}),await this.dot(f,u,p,void 0,!0)):"{}"!==JSON.stringify(l)&&await this.dot(f,u+"._",l,void 0,!0)}i=""}return f},t.dateparts=async function(e){var t,i,r,s,a,n,l,o,u,c,p;t={},null==e&&(e=null!=(a=this.params.dateparts)?a:t.date);try{if("object"==typeof e){for(i in e)t[i]=e[i];e=null!=(n=t.date)?n:""}else if(null==e){for(i in params)null==t[i]&&(t[i]=this.params[i]);e=null!=(l=t.date)?l:""}if(("number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))&&(e=await this.date(e)),e.includes("T")&&e.includes("-")&&(e=e.split("T")[0]),(e=(e=e.trim().toLowerCase().replace(", "," ").replace(" of ","").replace("st "," ").replace("nd "," ").replace("rd "," ").replace("th "," ")).replace(/-/g," ").replace(/\//g," ")).includes(" "))for(i in s=e.split(" "))(r=s[i]).includes(":")||(r.length>=3?isNaN(parseInt(r))?(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(r.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""):t.year=r:parseInt(r)<13&&(2===s.length||3===s.length&&"1"===i)?t.month=r:1===s.length?t.year=r:t.day=r);t.day=(null!=(o=t.day)?o:"01").toString(),1===t.day.length&&(t.day="0"+t.day),"string"==typeof t.month&&t.month.length&&isNaN(parseInt(t.month))&&(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(t.month.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""),t.month=(null!=(u=t.month)?u:"01").toString(),1===t.month.length&&(t.month="0"+t.month),t.year=t.year.toString(),2===t.year.length&&(t.year=parseInt(t.year)<30?"20":"19"+t.year),"31"!==t.day||"04"!==(c=t.month)&&"06"!==c&&"09"!==c&&"11"!==c||(t.day="30"),"02"===t.month&&("30"===(p=t.day)||"31"===p||"29"===t.day&&parseInt(t.year)%4)&&(t.day="28"),t.date=t.year+"-"+t.month+"-"+t.day;try{t.timestamp=await this.epoch(t.date)}catch(e){}}catch(e){}return t},t.dateparts._cache=!1,t.date=function(e,t,i=!0,r=!0){var s,a,n,l,o;if(null==e&&(e=null!=(n=this.params.date)?n:Date.now()),null==t&&(t=this.params.time),"number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))try{return o=(o=new Date(parseInt(e))).toISOString(),t?i?r||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(e){}try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(s in e)"number"!=(l=typeof e[s])&&"string"!==l&&(e[s]="01");e=e.join("-")}catch(e){}return(e=decodeURIComponent(e)).includes("T")&&(e=e.split("T")[0]),(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).includes("-")||(e+="-01-01"),3!==e.split("-").length&&(e+="-01"),3!==(a=e.split("-")).length&&(e=void 0),a[0].length<a[2].length&&(e=a.reverse().join("-")),e}catch(e){}},t.date._cache=!1,t.datetime=function(e,t){var i,r;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(r=null!=e?e:this.params.secs)?r:this.params.s,null!=t?t:this.params.ms)},t.datetime._cache=!1,t.epoch=function(e){var t,i,r,s,a,n;if(null==e&&(e=this.params.epoch),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&e.includes("/")&&(3===(r=e.split("/")).length&&4===r[2].length&&r.reverse(),e=r.join("-")),!e)return Date.now();if(!(e.startsWith("+")||e.startsWith("-")||2===e.split("+").length&&e.split("+")[0].length>4||2===e.split("-").length&&e.split("-")[0].length>4)){if(e.length>8&&!e.includes("-")&&!isNaN(parseInt(e)))return this.date(e,null==(s=this.params.time)||s);for(4===e.length&&(e+="-01"),e.split("-").length<3&&(e+="-01"),e.includes("T")||(e+="T"),e.includes(":")||(e+="00:00"),e.split(":").length<3&&(e+=":00"),e.includes(".")||(e+="."),[a,i]=e.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return i.includes("Z")||(i+="Z"),new Date(a+"."+i).valueOf()}return(e.startsWith("+")||e.startsWith("-"))&&(e=Date.now()+e),e.includes("+")?([e,t]=e.replace("/","").split("+"),(parseInt(e)+parseInt(t)).toString()):e.includes("-")?([e,n]=e.replace("/","").split("-"),(parseInt(e)-parseInt(n)).toString()):void 0},t.epoch._cache=!1,t.uid=function(t){var i,r,s,a,n,l,o,u,c,p,d;return null==t&&(t="uid"===this.fn&&null!=(i=null!=(r=null!=(s=null!=(a=null!=this&&null!=(n=this.params)?n.len:void 0)?a:null!=this&&null!=(l=this.params)?l.length:void 0)?s:null!=this&&null!=(o=this.params)?o.size:void 0)?r:null!=this&&null!=(u=this.params)?u.uid:void 0)?i:21),"string"==typeof t&&(d=parseInt(t),t=isNaN(d)?void 0:d),((t,i=21)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,s=-~(1.6*r*t/e.length);return(a=t)=>{let n="";for(;;){let t=i(s),l=s;for(;l--;)if(n+=e[t[l]&r]||"",n.length===a)return n}}})(t,i,e))(null!=(c=null!=this&&null!=(p=this.params)?p.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",t)()},t.uid._cache=!1,t.encrypt=async function(e){var t,i,r,s,a,n;null==e&&(e=null!=(i=null!=(r=null!=(s=null!=(a=this.params.encrypt)?a:this.params.content)?s:this.params.q)?r:this.params)?i:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createCipheriv("aes-256-ctr",this.S.encrypt.salt,null!=(n=this.params.iv)?n:this.S.encrypt.iv),E.concat([t.update(e),t.final()]).toString("hex")},t.encrypt._cache=!1,t.encrypt._bg=!0,t.decrypt=async function(e){var t,i,r,s,a,n,l;null==e&&(e=null!=(r=null!=(s=null!=(a=null!=(n=this.params.decrypt)?n:this.params.content)?a:this.params.q)?s:this.params)?r:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"object"==typeof e?(i=e.iv,e=e.content):i=null!=(l=this.params.iv)?l:this.S.encrypt.iv,"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createDecipheriv("aes-256-ctr",this.S.encrypt.salt,i),E.concat([t.update(E.from(e,"hex")),t.final()]).toString()},t.decrypt._cache=!1,t.decrypt._bg=!0,t.decrypt._auth="@oa.works",t.hash=async function(e){var t,i,r,s,a,n,l,o,u,c;null==e&&(e=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?l:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(r),n=[],s=0,a=t.length;s<a;s++)i=t[s],n.push(("00"+i.toString(16)).slice(-2));return n.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},t.hashcode=function(e){var t,i,r,s,a,n;for(null==e&&(e=null!=(r=null!=(s=null!=(a=null!=(n=this.params.hashcode)?n:this.params.content)?a:this.params.q)?s:this.params)?r:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),t=0,i=0;i<e.length;)t=(t<<5)-t+e.charCodeAt(i),t&=t,i++;return t},t.hashhex=function(e){var t;return null==e&&(e=this.params.hashhex),(t=this.hashcode(e))<0&&(t=4294967295+t+1),t.toString(16)},t.shorthash=function(e,t){var i,r,s,a,n,l,o,u;for(null==e&&(e=null!=(s=null!=(a=null!=(n=null!=(l=this.params.shorthash)?l:this.params.content)?n:this.params.q)?a:this.params)?s:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),r=this.hashcode(e),t?(u=t.substring(0,1),t=t.replace(u,"")):(t="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=t.length,o=r<0?u:"",r=Math.abs(r);r>=i;)o+=t[r%i],r=Math.floor(r/i);return o+(r>0?t[r]:"")},t.fetch=async function(e,t){var i,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,N,L,P,R,q,T,M,W,U,z,F,B,J,X,$;if(null==e&&null==t)try{t=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==t&&(e=(t=e).url),null==t&&(t={}),"number"==typeof t&&(t={cache:t}),"number"==typeof t.cache&&(null==t.cf&&(t.cf={cacheEverything:!0}),t.cf.cacheTtl=t.cache,delete t.cache),!e&&t.url&&(e=t.url,delete t.url),!0===t.bg&&"string"==typeof r.bg&&(t.url=e,e=r.bg+"/fetch",delete t.bg),t.username&&t.password&&(t.auth=t.username+":"+t.password,delete t.username,delete t.password),e.split("?")[0].includes("@")&&e.includes(":")&&e.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(t.auth=e.split("//")[1].split("@")[0],e=e.replace(t.auth+"@","")),t.auth&&(null==t.headers&&(t.headers={}),t.headers.Authorization="Basic "+E.from(t.auth).toString("base64"),delete t.auth),p=0,m=(N=["data","content","json"]).length;p<m;p++)null!=t[n=N[p]]&&(t.body=t[n],delete t[n]);if(null==t.attachment&&(t.attachment=t.attachments),null==t.file&&(t.file=t.attachment),null!=t.file){for(null==t.headers&&(t.headers={}),null!=t.body&&null==t.form&&(t.form=t.body),t.body=new FormData,Array.isArray(t.file)||(u="object"==typeof t.file&&null!=t.file.file?[{file:t.file.file,filename:null!=(L=null!=(T=t.file.filename)?T:t.file.name)?L:t.filename}]:[{file:t.file,filename:t.filename}],t.file=u),d=0,y=(M=t.file).length;d<y;d++)null==(null!=(c=M[d])?c.file:void 0)&&null==(null!=c?c.data:void 0)||t.body.append(null!=t.attachment?"attachment":"file",null!=(W=c.file)?W:c.data,null!=(U=null!=(z=null!=(F=c.filename)?F:c.name)?z:t.filename)?U:"file");delete t.filename,null==t.method&&(t.method="POST")}else null!=t.body&&(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="object"==typeof t.body?"application/json":"text/plain"),"object"!=(B=typeof t.body)&&"boolean"!==B&&"number"!==B||(t.body=JSON.stringify(t.body)),null==t.method&&(t.method="POST"));if(null!=t.form){if(null!=t.file){if("object"==typeof t.form)for(o in t.form)for(f=0,g=(J=Array.isArray(t.form[o])?t.form[o]:[t.form[o]]).length;f<g;f++)s=J[f],t.body.append(o,"object"==typeof s?JSON.stringify(s):s)}else{if(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof t.form){for(k in j="",t.form)for(""!==j&&(j+="&"),b=0,_=(P=Array.isArray(t.form[k])?t.form[k]:[t.form[k]]).length;b<_;b++)null!=(S=P[b])&&(j.endsWith("&")||(j+="&"),j+=k+"="+encodeURIComponent("object"==typeof S?JSON.stringify(S):S));t.form=j}t.body=t.form}delete t.form,null==t.method&&(t.method="POST")}if(delete t.file,delete t.attachment,delete t.attachments,"string"!=typeof e);else{if(!e.startsWith("http:")&&e.includes("localhost"))try{null==t.agent&&(t.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(e.includes("?")){for(O=(A=e.split("?")).shift()+"?",w=0,v=(R=A.join("?").split("&")).length;w<v;w++)D=R[w],O.endsWith("?")||(O+="&"),[h,$]=D.split("="),null==$&&($=""),h&&(O+=encodeURIComponent(h)+($?"="+($.includes("%")?$:encodeURIComponent($)):""));e=O}if(t.params&&"{}"!==JSON.stringify(t.params)){for(h in e.includes("?")||(e+="?"),q=t.params)$=q[h],e.endsWith("&")||e.endsWith("?")||(e+="&"),h&&(e+=encodeURIComponent(h)+"="+encodeURIComponent("object"==typeof $?JSON.stringify($):$));delete t.params}r.system&&("string"==typeof r.bg&&e.startsWith(r.bg)||"string"==typeof r.async&&e.startsWith(r.async)||"string"==typeof r.kv&&r.kv.startsWith("http")&&e.startsWith(r.kv))&&(null==t.headers&&(t.headers={}),null==(a=t.headers)[x="x-"+r.name.toLowerCase()+"-system"]&&(a[x]=r.system),t.headers.Authorization||t.headers.authorization||t.headers["x-apikey"]||!this.user||(t.headers["x-apikey"]=this.user.apikey)),i=async()=>{var i,s,a,n,l,o,u,c;if(t.stream)return delete t.stream,fetch(e,t);i=!1,t.buffer&&(i=!0,delete t.buffer),c=await fetch(e,t);try{(!e.includes("localhost")||200!==(o=c.status)&&404!==o)&&r.dev&&!0===r.bg&&C.log(c.status+" "+e),t.verbose&&(c.status>300&&C.log(c.body),C.log(c.status+" "+e))}catch(e){C.log("Error logging to console for fetch"),C.log(c)}if(i)l=await c.buffer();else if("HEAD"===t.method)for(l={status:c.status},n=0,a=(u=[...c.headers]).length;n<a;n++)l[(s=u[n])[0]]=s[1];else{try{l=await c.text()}catch(e){}try{"string"==typeof l&&(l.startsWith("{")||l.startsWith("["))&&(l=JSON.parse(l))}catch(e){}}return 404!==c.status?c.status>=400?(r.dev&&!0===r.bg&&C.log(t,JSON.stringify(l),"FETCH ERROR",c.status),{status:c.status}):l:void 0};try{t.timeout&&null!=(null!=this?this._timeout:void 0)?(I=!0===t.timeout?3e4:t.timeout,delete t.timeout,X=await this._timeout(I,i())):X=await i();try{((X=X.trim()).startsWith("[")||X.startsWith("{"))&&(X=JSON.parse(X))}catch(e){}return X}catch(t){l=t,r.dev&&!0===r.bg&&C.log("ERROR TRYING TO CALL FETCH",e,l,JSON.stringify(l));try{this.log(l)}catch(e){}}}},t.fetch._auth="system",t._timeout=function(e,t){return new Promise(((t,i)=>{var r;return r=setTimeout((()=>i(new Error("TIMEOUT"))),e),promise.then(value((()=>(clearTimeout(r),t(value))))).catch(reason((()=>(clearTimeout(r),i(reason)))))}))},N=[].indexOf,null==r.index&&(r.index={}),null==(O=r.index).name&&(O.name=null!=(j=r.name)?j:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(k=r.index).url&&(k.url=r.bg+"/index"),t.index=async function(e,i,r,s){var a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w;if("object"==typeof e&&(i=e,e=void 0),null==e&&null==i&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(p=this.parts[1])||"src"===p))return{status:403};if("object"==typeof this.body?i=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(i=this.body):i=this.copy(this.params),delete i.route,delete i.index,delete i[this.fn.split(".").pop()],delete i._id,null!=i.script||-1!==JSON.stringify(i).toLowerCase().indexOf("<script"))return}if("object"!=typeof i||Array.isArray(i)||(null==e&&(e=null!=(d=i.route)?d:i.index),delete i.route,delete i.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(l in g=[],(await this.index._send("_stats")).indices)l.startsWith(".")||l.startsWith("security-")||g.push(l);return g}2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e)if(e.includes("?")?([e,w]=e.split("?"),w="?"+w):w="",e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof i&&!Array.isArray(i)&&i._id&&(n=(i=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i))._id.replace(/\//g,"_").toLowerCase(),-1===e.indexOf("/")&&-1===e.indexOf(n)&&(e+="/"+n),delete i._id,"{}"===JSON.stringify(i)&&(i=void 0)),b=(e=e.toLowerCase()).split("/").length,null==this.index&&(this.index=t.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===e.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===i)_=await this.index._send(e.replace("/","/_doc/")+w,"");else if(1===b){if("string"==typeof i&&(""===i||-1!==i.indexOf("\n"))||Array.isArray(i))return""===i?this.index._send(e+w,i):this.index._bulk(e+w,i);if("object"!=(h=typeof i)&&"string"!==h)return this.index._send(e+"/_search"+w);if("{}"!==JSON.stringify(i)&&(c=await this.index.translate(i,r)))return this.index._send(e+"/_search"+w,c);if("object"==typeof i){for(a=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete a[f[o]];return"{}"===JSON.stringify(a)?(await this.index._send(e+w)||await this.index._send(e+w,{settings:i.settings,aliases:i.aliases,mappings:null!=(m=i.mappings)?m:i.mapping}),this.index._send(e+"/_search"+w)):"created"===(null!=(_=await this.index._send(e+"/_doc"+w,i))?_.result:void 0)&&_._id?_._id:_}}else if(2===b&&(null==i||"object"==typeof i&&!Array.isArray(i)))return e.startsWith("_")||e.includes("/_")||(e=e.replace("/","/_doc/")),null!=i&&"{}"!==JSON.stringify(i)?("object"==typeof i&&null!=i.script&&(e+="_update",w+=(w.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(_=await this.index._send(e+w,i))?_.result:void 0)&&_._id?_._id:_):("object"==typeof(_=await this.index._send(e+w))&&(_._source||_.fields)&&(null==(v=null!=(y=_._source)?y:_.fields)._id&&(v._id=_._id),_=v),_)},t.index._auths="system",t.index._caches=!1,t.index.status=async function(){var e,t,i,r,s,a,n,l,o,u,c,p,d,h,f;c={status:"green",docs:0,size:0,shards:0,failed:0};try{for(i in(f=await this.index._send("_nodes/stats/indices/search")).nodes)null==c.scrolls&&(c.scrolls=0),c.scrolls+=f.nodes[i].indices.search.open_contexts}catch(e){}for(i in c.indices={},p=await this.index._send("_stats"),h=await this.index._send("_cat/shards?format=json"),p.indices)if(!i.startsWith(".")&&!i.startsWith("security-")){for(c.indices[i]={docs:p.indices[i].primaries.docs.count,size:Math.ceil(p.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},r=0,n=h.length;r<n;r++)(d=h[r]).index===i&&"p"===d.prirep&&(null==(e=c.indices[i]).shards&&(e.shards=0),c.indices[i].shards+=1,null==(t=c.indices[i]).failed&&(t.failed=0),"UNASSIGNED"===d.state&&(c.indices[i].failed+=1));c.docs+=c.indices[i].docs;try{c.size+=parseInt(c.indices[i].size.replace("mb",""))}catch(e){}c.shards+=c.indices[i].shards,c.failed+=c.indices[i].failed}c.size=Math.ceil(c.size/1e3+"gb");try{for("green"!==(o=c.cluster.status)&&"yellow"!==o&&(c.status="red"),a=0,l=(u=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;a<l;a++)s=u[a],delete c.cluster[s]}catch(e){}return c},t.index.keys=async function(e,t){var i,r,s,a,n,l;return null==e&&(e=null!=(a=null!=(n=this.params.index)?n:this.params.keys)?a:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys",""),null==t&&(t=null!=(l=this.params.type)?l:this.params.types),"string"==typeof t&&(t=[t]),r=!0===t?{}:[],s="object"==typeof e?e:await this.index.mapping(e),i=async(e,s="")=>{var a,n,l,o;for(a in s&&(s+="."),o=[],e)null!=e[a].properties?o.push(await i(e[a].properties,s+a)):!t||!0===t||(n=e[a].type,N.call(t,n)>=0)?!0===t?o.push(r[s+a]=e[a].type):(l=s+a,N.call(r,l)<0?o.push(r.push(s+a)):o.push(void 0)):o.push(void 0);return o},"object"==typeof s&&await i(s),r},t.index.terms=async function(e,t,i,r=100,s=!0,a="count"){var n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k;if(null==e&&(e=null!=(m=this.params.index)?m:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),!t||!i){if(null==t&&(t=null!=(y=this.params.terms)?y:this.params.key),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),!t)return[];for(n=this.copy(this.params),l=0,u=(g=["index","route","terms","key"]).length;l<u;l++)delete n[g[l]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(n)),f="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&f.query.bool.must.push({query_string:{query:i}}),null==f.aggregations&&(f.aggregations={}),null==f.size&&(f.size=0),null!=this.params.size&&(r=this.params.size),null!=this.params.counts&&(s=this.params.counts),null!=this.params.order&&(a=this.params.order),d={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof a&&null!=d[a]&&(a=d[a]),t.endsWith(".keyword")||(p=await this.index.mapping(e)),f.aggregations[t]={terms:{field:t+(t.endsWith(".keyword")||"text"!==(null!=(_=p[t])?_:{}).type?"":".keyword"),size:r,order:a}},O=[],o=0,c=(x=null!=(v=null!=(k=await this.index._send("/"+e+"/_search",f,"POST"))&&null!=(b=k.aggregations)&&null!=(w=b[t])?w.buckets:void 0)?v:[]).length;o<c;o++)h=x[o],O.push(s?{term:h.key,count:h.doc_count}:h.key);return O},t.index.suggest=async function(e,t,i,r=100,s){var a,n,l,o,u,c,p,d,h,f,m,y,g;if(t&&i||(null==t&&(t=null!=(d=this.params.suggest)?d:this.params.key),"string"==typeof t&&t.includes("/")&&([t,i]=t.split("/"))),!t)return this.index.keys(e,"text");if(null==e&&(e=null!=(h=this.params.index)?h:this.fn.replace(/\./g,"/")),e=e.replace("index/","").split("/suggest")[0],null==s&&(s=this.params.include),"string"==typeof s&&(s=s.replace(/,\s/g,",").split(",")),Array.isArray(s)&&N.call(s,t)<0&&s.push(t),"string"==typeof i&&(c=(i=i.trim()).toLowerCase(),(g={should:[{match:{}},{prefix:{}},{query_string:{query:t+":"+i.split(" ").join(" AND "+t+":")+"*"}}]}).should[0].match[t]={query:i,boost:3},g.should[1].prefix[t]={value:i,boost:2}),m=[],y=[],s){for await(p of this.index._for(e,null!=g?g:i,{sort:t+".keyword",until:r,include:!0===s?[t]:s}))if(l=await this.dot(p,t)){for(;Array.isArray(l)&&(a=l.shift());)a.toLowerCase().includes(c)&&(l=a);o=l.toLowerCase(),N.call(y,o)<0&&(!c||o.includes(c))&&m.push(p),y.push(o)}}else for(n=0,u=(f=await this.index.terms(e,t,null!=g?g:i,r,!1,"term")).length;n<u;n++)o=(l=f[n]).toLowerCase(),N.call(y,o)<0&&(!c||o.includes(c))&&m.push(l),y.push(o);return m},t.index.count=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h;for(null==i&&(i=null!=(l=this.params.count)?l:this.params.key),null==e&&(e=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),r=this.copy(this.params),s=0,a=(u=["index","route","count","key"]).length;s<a;s++)delete r[u[s]];return null==t&&(n=await this.index.translate(r))&&(t=n),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(h=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(c=h.aggregations)&&null!=(p=c.keyed)?p.value:void 0):null!=(h=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(d=h.hits)?d.total:void 0},t.index.percent=async function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m;for(null==i&&(i=null!=(o=this.params.count)?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),s=this.copy(this.params),a=0,n=(c=["index","route","count","key"]).length;a<n;a++)delete s[c[a]];return null==t&&(l=await this.index.translate(s))&&(t=l),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),m=await this.index.count(e,"*"),r=0,i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(p=f.aggregations)&&null!=(d=p.keyed)?d.value:void 0):r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(h=f.hits)?h.total:void 0,Math.ceil(r/m*1e4)/100},t.index.min=async function(e,t,i,r="min"){var s,a,n,l,o,u,c,p;for(null==t&&(t=null!=(o=this.params[r])?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(e=e.replace("index/","").replace("/"+r,"")).indexOf("/")&&([e,t]=e.split("/")),s=this.copy(this.params),a=0,n=(c=["index","route","min","max","key","sum","average"]).length;a<n;a++)delete s[c[a]];return null==i&&(i=await this.index.translate(s)),(l="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,"sum"===r?l.aggs={sum:{sum:{field:t}}}:"average"===r?l.aggs={average:{avg:{field:t}}}:(l.aggs={},"min"!==r&&"range"!==r||(l.aggs.min={min:{field:t}}),"max"!==r&&"range"!==r||(l.aggs.max={max:{field:t}})),p=await this.index._send("/"+e+"/_search",l,"POST"),"range"===r?{min:p.aggregations.min.value,max:p.aggregations.max.value}:p.aggregations[r].value},t.index.max=function(e,t,i){return this.index.min(e,t,i,"max")},t.index.range=function(e,t,i){return this.index.min(e,t,i,"range")},t.index.sum=function(e,t,i){return this.index.min(e,t,i,"sum")},t.index.average=function(e,t,i){return this.index.min(e,t,i,"average")},t.index.mapping=async function(e,t){var i,r;return-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),null!=t&&(i=await this.index._send(e,t,"PUT"),C.log(e,"mapped",i)),(r=await this.index._send(e))[(await this.keys(r))[0]].mappings.properties},t.index._for=async function*(e,i,s,a,n,l){var o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,N,L,P,R;for("number"==typeof s&&(s={until:s}),(null!=s?s.scroll:void 0)?("number"!=typeof(R=s.scroll)&&R.endsWith("m")||(R+="m"),delete s.scroll):R="2m",((null!=s?s.until:void 0)||(null!=s?s.max:void 0))&&(c=null!=(f=s.until)?f:s.max,delete s.until,delete s.max),null==i&&(i="*"),null==(d=await this.index.translate(i,s)).from&&(d.from=0),null==d.size&&(d.size=500),null==d.sort&&(d.sort=["_doc"]),P=e.split("/")[0],u=await this.dot(t,P.replace(/_/g,".")),null==n&&(n=null!=(O=null!=(k=this.params._alias)?k:null!=(j=this.S.alias)?j[P.startsWith(this.S.index.name+"_")?P.replace(this.S.index.name+"_",""):P]:void 0)?O:null!=u?u._alias:void 0),"string"==typeof n&&(n.startsWith("_")||(n="_"+n),n=n.replace(/\//g,"_"),P.endsWith(n)||(e=e.replace(P,P+n))),!0===a&&(a=this.S.index.name),null==a&&(a=null!=(S=null!=u?u._prefix:void 0)?S:this.S.index.name),"string"==typeof a&&(a.length&&!a.endsWith("_")&&(a+="_"),e.startsWith(a)||(e=a+e)),L=P.startsWith(this.S.index.name+"_")?P.replace(this.S.index.name+"_",""):P,null==l&&(l=null!=(I=null!=(A=null!=(D=null!=(C=this.S.route)?C[L+n]:void 0)?D:null!=(m=this.S.route)?m[L]:void 0)?A:null!=u?u._route:void 0)?I:(null!=this&&null!=(y=this.S)&&null!=(g=y.index)?g.url:void 0)?this.S.index.url:null!=(_=r.index)?_.url:void 0),Array.isArray(l)&&(l=l[Math.floor(Math.random()*l.length)]),(null!=(E=await this.index._send(e+"/_search?scroll="+R,d,void 0,a,n))?E._scroll_id:void 0)&&(p=E._scroll_id.replace(/==$/,"")),(null!=E&&null!=(v=E.hits)?v.total:void 0)&&(null==c||c>E.hits.total)&&(c=E.hits.total),o=0;;){if((null!=E&&null!=(b=E.hits)?b.hits:void 0)&&0!==E.hits.hits.length||!(null!=E?E._scroll_id:void 0)||(null!=(E=await this.index._send("/_search/scroll?scroll="+R+"&scroll_id="+E._scroll_id,void 0,void 0,a,n,l))?E._scroll_id:void 0)!==p&&(await this.index._send("/_search/scroll?scroll_id="+p,"",void 0,a,n,l),p=null!=E?E._scroll_id:void 0),o===c||null==(null!=E&&null!=(w=E.hits)?w.hits:void 0)||!E.hits.hits.length){p&&await this.index._send("/_search/scroll?scroll_id="+p,"",void 0,a,n,l);break}o+=1,null==(N=null!=(x=(h=E.hits.hits.shift())._source)?x:h.fields)._id&&(N._id=h._id),yield N}},t.index._each=async function(e,t,i,r,s,a){var n,l,o,u,c,p,d,h,f,m,y;for await(d of(null==r&&null==i&&"function"==typeof t&&(r=t,t="*"),null==r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),"string"==typeof i&&(n=i,i=void 0),(null!=i?i.action:void 0)&&(n=i.action,delete i.action),(m=null!=(h=i.size)?h:"object"==typeof t&&null!=t.size?t.size:1e3)>50&&((p=await this.index.translate(t,i)).size=1,null!=(null!=(l=await this.index._send(e,p,void 0,s,a))&&null!=(f=l.hits)?f.total:void 0)&&0!==l.hits.total&&(u=Math.floor(1e9/(E.byteLength(JSON.stringify(l.hits.hits[0]))*l._shards.total)))<m&&(m=u),p.size=m),c=0,y=[],this.index._for(e,null!=p?p:t,i,s,a)))c+=1,null==(o=await r.call(this,d))||"object"!=typeof o&&"string"!=typeof o||y.push(o),n&&y.length>m&&(await this.index._bulk(e,y,n,void 0,s,a),y=[]);if(n&&y.length&&this.index._bulk(e,y,n,void 0,s,a),this.S.dev&&!0===this.S.bg)return C.log("_each processed "+c)},t.index._bulk=async function(e,i,s="index",a=5e4,n,l,o){var u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,E,N,L,P,R,q,T,M,W,U,z,F,B,J,X,$;if(!0===s&&(s="index"),$=e.split("/")[0],c=await this.dot(t,$.replace(/_/g,".")),null==l&&(l=null!=(v=null!=(E=this.params._alias)?E:null!=(P=this.S.alias)?P[$.startsWith(this.S.index.name+"_")?$.replace(this.S.index.name+"_",""):$]:void 0)?v:null!=c?c._alias:void 0),"string"==typeof l&&(l.startsWith("_")||(l="_"+l),l=l.replace(/\//g,"_"),$.endsWith(l)||(e=e.replace($,$+l))),!0===n&&(n=this.S.index.name),null==n&&(n=null!=(R=null!=c?c._prefix:void 0)?R:this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e)),J=$.startsWith(this.S.index.name+"_")?$.replace(this.S.index.name+"_",""):$,null==o&&(o=null!=(q=null!=(T=null!=(M=null!=(W=this.S.route)?W[J+l]:void 0)?M:null!=(U=this.S.route)?U[J]:void 0)?T:null!=c?c._route:void 0)?q:(null!=this&&null!=(b=this.S)&&null!=(w=b.index)?w.url:void 0)?this.S.index.url:null!=(x=r.index)?x.url:void 0),Array.isArray(o)&&(o=o[Math.floor(Math.random()*o.length)]),null==this.index&&(this.index=t.index),"string"==typeof i&&-1!==i.indexOf("\n"))return await this.index._send("/_bulk",{body:i,headers:{"Content-Type":"application/x-ndjson"}},void 0,n,l,o),!0;for(_ in B="object"!=typeof i||Array.isArray(i)||null==(null!=i&&null!=(O=i.hits)?O.hits:void 0)?i:i.hits.hits,Array.isArray(B)||(B=[B]),u=0,p=0,g="",B)if(u+=1,"object"==typeof(F=B[_])&&("string"==typeof(z=null!=(k=null!=(j=F._id)?j:null!=(S=F._source)?S._id:void 0)?k:await this.uid())&&(z=z.replace(/\//g,"_")),F._source&&(F=F._source),delete F._id),(y={})[s]={_index:e},y[s]._id="delete"!==s||"string"!=(I=typeof F)&&"number"!==I?z:F,g+=JSON.stringify(y)+"\n","create"===s||"index"===s?g+=JSON.stringify(F)+"\n":"update"===s&&(g+=JSON.stringify({doc:F})+"\n"),u===a||parseInt(_)===B.length-1||g.length>7e7){if(X=await this.index._send("/_bulk",{body:g,headers:{"Content-Type":"application/x-ndjson"}},void 0,n,l,o),(null!=this&&null!=(A=this.S)?A.dev:void 0)&&!0===(null!=this&&null!=(D=this.S)?D.bg:void 0)&&(null!=X?X.errors:void 0)){for(d=[],f=0,m=(N=X.items).length;f<m;f++){h=N[f];try{200!==(L=h[s].status)&&201!==L&&(d.push(h[s]),p+=1)}catch(e){p+=1}}try{C.log(d)}catch(e){}try{C.log(0===d.length?"SOME":d.length,"INDEX ERRORS BULK LOADING",X.items.length)}catch(e){}}g="",u=0}return B.length-p},t.index.translate=function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,E,N,L,P,R,q,T,M,W,U,z,F,B,J,X,$,V,G,Y,H,Z,Q,K,ee,te,ie,re,se,ae,ne,le,oe,ue,ce,pe,de,he;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==e&&(e=null!=this?this.params:void 0),"string"==typeof e){if(""===e||-1!==e.indexOf("\n"))return}else{if("object"!=typeof e||Array.isArray(e))return;for(y=0,v=(P=["settings","aliases","mappings","index","_id"]).length;y<v;y++)if(null!=e[g=P[y]])return;if(L=!1,e.source)try{L=JSON.parse(decodeURIComponent(e.source))}catch(e){}if("{}"!==JSON.stringify(e)&&null==e.q&&null==e.query&&!1===L&&null==e.must&&null==e.should&&null==e.must_not&&null==e.filter&&null==e.aggs&&null==e.aggregations)return}try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if(null==t&&(t={}),("string"==typeof t||Array.isArray(t))&&(t={fields:t}),"random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null!=t.newest&&(t.sort={createdAt:t.newest?"desc":"asc"},delete t.newest),null==(N=null!=(X=null!=t?t.query:void 0)?X:{}).query&&(N.query={}),null==(a=N.query).bool&&(a.bool={must:[],filter:[]}),"string"==typeof e)ne={query_string:{query:e}},null!=(null!=t?t.fields:void 0)&&(ne.query_string.fields="string"==typeof t.fields?t.fields.split(","):t.fields,delete t.fields),N.query.bool.filter.push(ne);else if("object"==typeof e)if(null!=e.query)N=e;else for(A in null!=e.source?"string"==typeof e.source&&"object"==typeof L?N=L:"object"==typeof e.source&&(N=e.source):null!=e.q&&("object"==typeof e.q?N.query=e.q:(e.q=decodeURIComponent(e.q),null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(C={})[(E=e.q.split(":"))[0]]=E[1],N.query.bool.must.push({prefix:C})):null!=e.fields?(N.query.bool.filter.push({query_string:{query:e.q,fields:e.fields.split(",")}}),delete e.fields):N.query.bool.filter.push({query_string:{query:e.q}}))),e)null==t[A]&&(t[A]=e[A]);if(null!=(null!=(Y=N.query)&&null!=(H=Y.filtered)&&null!=(Z=H.query)?Z.bool:void 0)&&(N.query.bool=N.query.filtered.query.bool,N.query.bool.filter=N.query.filtered.filter,delete N.query.filtered),null!=N.facets&&(N.aggregations=JSON.parse(JSON.stringify(N.facets).replace(/\.exact/g,".keyword")),delete N.facets),null!=N.query&&null==N.query.bool&&"{}"!==JSON.stringify(N.query)&&(N.query={bool:{must:[],filter:[N.query]}}),null==N.query&&(N.query={bool:{must:[],filter:[]}}),null==(n=N.query).bool&&(n.bool={must:[],filter:[]}),null==(l=N.query.bool).filter&&(l.filter=[]),"string"==typeof t.sort){for(ae=[],_=0,b=(Q=t.sort.split(",")).length;_<b;_++)se=Q[_],[g,A]=se.split(":"),A?(ae.push({}),ae[ae.length-1][g.trim()]=A.trim()):ae.push(g.trim());t.sort=ae}if(t.random&&(h={function_score:{random_score:{}}},null!=t.seed&&(h.function_score.random_score.seed=seed),h.function_score.query=N.query,N.query=h,delete t.random,delete t.seed),(m=null!=(K=null!=(ee=null!=(te=t._include)?te:t.include)?ee:t._includes)?K:t.includes)&&(null==N._source&&(N._source={}),N._source.includes="string"==typeof m?m.replace(/,\s/g,",").split(","):m),p=null!=(R=null!=(q=null!=(T=t._exclude)?T:t.exclude)?q:t._excludes)?R:t.excludes)for(null==N._source&&(N._source={}),N._source.excludes="string"==typeof p?p.replace(/,\s/g,",").split(","):p,I=0,w=(U=null!=(M=null!=(W=N._source)?W.includes:void 0)?M:[]).length;I<w;I++)f=U[I],N._source.excludes=N._source.excludes.filter((function(e){return e!==f}));for(le=0,x=(z=["filter","restrict","must","and","must_not","not","should","or"]).length;le<x;le++)if(null!=t[ue=z[le]])for(S=Array.isArray(t[ue])?t[ue]:[t[ue]],delete t[ue],c="filter"===ue||"restrict"===ue||"must"===ue||"and"===ue?"filter":"must_not"===ue||"not"===ue?"must_not":"should",null==(o=N.query.bool)[c]&&(o[c]=[]),ce=0,O=S.length;ce<O;ce++)"object"==typeof(re=S[ce])?1===(ie=this.keys(re)).length&&"object"!=typeof re[ie[0]]&&(re={term:re}):re={query_string:{query:re}},N.query.bool[c].push(re);if(null!=t.terms){try{t.terms=t.terms.replace(/,\s/g,",").split(",")}catch(e){}for(null==N.aggregations&&(N.aggregations={}),de=0,k=(F=t.terms).length;de<k;de++)oe=F[de],N.aggregations[oe]={terms:{field:oe+(oe.endsWith(".keyword")?"":".keyword"),size:1e3}};delete t.terms}for(he=0,j=(B=["aggs","aggregations"]).length;he<j;he++)if(null!=t[i=B[he]]){for(d in null==N[i]&&(N[i]={}),t[i])N[i][d]=t[i][d];delete t[i]}for(g in t){if(pe=t[g],("from"===g||"size"===g)&&"number"!=typeof pe)try{pe=parseInt(pe),isNaN(pe)&&(pe=void 0)}catch(e){}null!=pe&&"apikey"!==g&&"_"!==g&&"callback"!==g&&"refresh"!==g&&"key"!==g&&"counts"!==g&&"order"!==g&&"index"!==g&&"search"!==g&&"source"!==g&&"q"!==g&&"_alias"!==g&&"include"!==(J=g.replace("_","").replace("s",""))&&"exclude"!==J&&(N[g]=pe)}try{for(r in D={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},N.aggregations)"string"==typeof(null!=($=N.aggregations[r].terms)?$.order:void 0)&&null!=D[N.aggregations[r].terms.order]&&(N.aggregations[r].terms.order=D[N.aggregations[r].terms.order])}catch(e){}if(null!=(null!=(V=N.query)?V.bool:void 0))for(u in N.query.bool)for(s in N.query.bool[u])"string"==typeof(null!=(G=N.query.bool[u][s].query_string)?G.query:void 0)&&-1!==N.query.bool[u][s].query_string.query.indexOf("/")&&-1===N.query.bool[u][s].query_string.query.indexOf('"')&&(N.query.bool[u][s].query_string.query='"'+N.query.bool[u][s].query_string.query+'"');return null!=N._source&&null!=N.fields&&delete N._source,N},t.index.translate._auth=!1,t.index._send=async function(e,i,s,a,n,l){var o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A;e.includes("?")?([e,S]=e.split("?"),S="?"+S):S="",(e=e.toLowerCase()).startsWith("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,""));try{e.split("/").pop().includes("#")&&(e=e.replace(/#/g,"%23"))}catch(e){}if(null==s&&(s=""===i?"DELETE":null==i||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=i||"_refresh"===(p=e.split("/").pop().split("?")[0])||"_aliases"===p?"POST":"GET":"PUT"),"DELETE"===s&&-1!==e.indexOf("/_all"))return!1;if(!e.startsWith("http")){if(A=e.split("/")[0],e.startsWith("_")||(o=await this.dot(t,A.replace(/_/g,".")),null==n&&(n=null!=(g=null!=(_=this.params._alias)?_:null!=(v=this.S.alias)?v[A.startsWith(this.S.index.name+"_")?A.replace(this.S.index.name+"_",""):A]:void 0)?g:null!=o?o._alias:void 0),"string"==typeof n&&(n.startsWith("_")||(n="_"+n),n=n.replace(/\//g,"_"),A.endsWith(n)||(e=e.replace(A,A+n))),null==a&&(a=null!=(b=null!=o?o._prefix:void 0)?b:this.S.index.name),!0===a&&(a=this.S.index.name),"string"==typeof a&&(a.length&&!a.endsWith("_")&&(a+="_"),e.startsWith(a)||(e=a+e))),I=A.startsWith(this.S.index.name+"_")?A.replace(this.S.index.name+"_",""):A,null==l&&(l=null!=(w=null!=(x=null!=(O=null!=(k=this.S.route)?k[I+n]:void 0)?O:null!=(d=this.S.route)?d[I]:void 0)?x:null!=o?o._route:void 0)?w:(null!=this&&null!=(h=this.S)&&null!=(f=h.index)?f.url:void 0)?this.S.index.url:null!=(m=r.index)?m.url:void 0),Array.isArray(l)&&(l=l[Math.floor(Math.random()*l.length)]),"string"!=typeof l)return;e=l+"/"+e}if(e.startsWith("http")){if(c=!1,e.includes("/_search")&&"object"==typeof i&&(null!=i.scroll_id||i.scroll)&&(!0===i.scroll&&(i.scroll="2m"),("number"==typeof i.scroll||"string"==typeof i.scroll&&!i.scroll.endsWith("m"))&&(i.scroll+="m"),e+=(-1===e.indexOf("?")?"?":"&")+"scroll="+(null!=(y=i.scroll)?y:"2m"),i.scroll_id?(c=i.scroll_id,e=e.split("://")[0]+"://"+e.split("://")[1].split("/")[0]+"/_search/scroll"+(e.includes("?")?"?"+e.split("?")[1]:""),e+=(-1===e.indexOf("?")?"?":"&")+"scroll_id="+i.scroll_id,i=void 0):(delete i.scroll_id,delete i.scroll)),u=-1!==(e=e+=S).indexOf("/_bulk")||"object"==typeof i&&"object"==typeof i.headers?i:{body:i},-1===e.indexOf("/_search")||"GET"!==s&&"POST"!==s||(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),e.includes("/_doc/")&&e.split("/_doc/")[1].includes("%")&&(e=e.split("/_doc/")[0]+"/_doc/"+encodeURIComponent(e.split("/_doc/")[1])),u.method=s,!(null==(j=await this.fetch(e,u))||"object"==typeof j&&"number"==typeof j.status&&j.status>=400&&j.status<=600)){if(this.S.dev&&"object"==typeof j&&null!=j.hits){try{null!=(null!=i?i.query:void 0)&&(j.q=i)}catch(e){}try{n&&(j._alias=n)}catch(e){}}return(null!=j?j._scroll_id:void 0)&&(j._scroll_id=j._scroll_id.replace(/==$/,"")),c&&c!==(null!=j?j._scroll_id:void 0)&&await this.index._send("/_search/scroll?scroll_id="+c,""),j}}else C.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!i.g[r.kv]&&(i.g[r.kv]={},i.g[r.kv].get=function(e){return t.fetch(r.kv+"/"+e)},i.g[r.kv].getWithMetadata=async function(e){return{value:await t.fetch(r.kv+"/"+e),metadata:{}}},i.g[r.kv].put=function(e,i){return t.fetch(r.kv+"/"+e,{body:i})},i.g[r.kv].delete=function(e){return t.fetch(r.kv+"/"+e,{method:"DELETE"})},i.g[r.kv].list=function(e){return null==e&&(e={}),t.fetch(r.kv+"/list"+(e.prefix?"/"+e.prefix:"")+(e.cursor?"?cursor="+e.cursor:""))}),t.kv=async function(e,t,r,s,a){var n,l,o,u,c,p,d,h,f,m,y,g,_,v;if(null==e&&(e=null!=(d=null!=(h=this.params.kv)?h:this.params.key)?d:this.parts.join("_"),null==t)){if("DELETE"===this.request.method)t="";else if(this.body)t=this.body;else if(this.params.val)t=this.params.val;else{for(t=this.params,n=0,u=(f=["key","kv","refresh","apikey"]).length;n<u;n++)delete t[o=f[n]];for(l=0,c=(m=this.parts).length;l<c;l++)delete t[o=m[l]]}"string"!=typeof t||0!==t.indexOf("[")&&0!==t.indexOf("{")||(t=JSON.parse(t)),"{}"!==(y=JSON.stringify(t))&&"[]"!==y||(t=void 0)}if("object"!=typeof t||"{}"!==(g=JSON.stringify(t))&&"[]"!==g||(t=void 0),"object"==typeof e&&null==t&&(e=null!=(_=(t=e)._id)?_:await this.uid()),null!=e&&this.S.kv&&i.g[this.S.kv]){if(null!=t&&""!==t){if(p={metadata:s},"number"==typeof r&&(1e3*r>Date.now()?p.expiration=r:p.expirationTtl=r),"object"==typeof t&&(!0===r&&(r=await this.kv(e)),"object"==typeof r))for(o in r)null==t[o]&&(t[o]=r[o]);return this.waitUntil(i.g[this.S.kv].put(e,"object"==typeof t?JSON.stringify(t):t,p)),t}if(({value:v,metadata:s}=await i.g[this.S.kv].getWithMetadata(e,a)),null!=v){try{v=JSON.parse(v)}catch(e){}try{s=JSON.parse(s)}catch(e){}return""===t&&this.waitUntil(i.g[this.S.kv].delete(e)),!0===s?{value:v,metadata:s}:v}}},t.kv._auths="system",t.kv._caches=!1,t.kv.list=async function(e,t){var r,s;try{null==e&&(e=null!=(r=null!=(s=this.params.kv)?s:this.params.prefix)?r:this.params.list)}catch(e){}try{null==t&&(t=this.params.cursor)}catch(e){}return await i.g[this.S.kv].list({prefix:e,cursor:t})},t.kv.count=async function(e){var t,r,s,a,n,l,o,u,c;if(r=0,this.S.kv&&null!=i.g[this.S.kv])for(null==e&&(e=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),t=!1,s=void 0;!t;){for(s=(l=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,a=0,n=(c=l.keys).length;a<n;a++)c[a],r+=1;t=l.list_complete}return r},t.kv.prefixes=async function(){var e;return e={},await this.kv._each(void 0,(function(t){var i;return i=t.split("/")[0],null==e[i]&&(e[i]=0),e[i]+=1})),e},t.kv.clear=function(e){var t;if(this.S.dev)return null==e&&(e=null!=(t=this.params.clear)?t:this.params.kv),this.waitUntil(this.kv._each(e,(function(e){return this.waitUntil(i.g[this.S.kv].delete(e))}))),!0},t.kv.delete=async function(e){var t,i,r,s;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==e&&(e=null!=(i=null!=(r=this.params.kv)?r:this.params.delete)?i:this.params.prefix),s=t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));t&&"0"!==t;)this.S.dev&&C.log(e,t),await this.fetch(this.S.kv+"/clear"+(e?"/"+e:"")),await this.sleep(500),t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));return s}},t.kv.delete._bg=!0,t.kv._each=async function(e,t){var r,s,a,n,l,o,u,c;if(this.S.kv&&null!=i.g[this.S.kv]){for("function"==typeof e&&null==t&&(t=e,e=void 0),r=!1,s=void 0,c=[];!r;){for(s=(o=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,a=0,l=(u=o.keys).length;a<l;a++)n=u[a],"function"==typeof t?this.waitUntil(t.call(this,n.name)):""===t?this.waitUntil(i.g[this.S.kv].delete(n.name)):null!=t&&this.waitUntil(this.kv(n.name,t));c.push(r=o.list_complete)}return c}},null==r.log&&(r.log={}),I=[],A=!1,S=!1,t.log=function(e,t){var i,s,a,n,l,o,u,c,p,d;if(i=async()=>{var e,t;for(!1!==A&&clearTimeout(A),A=setTimeout(i,3e4),S=Date.now(),t=new Date(S).toISOString().replace("T"," ").split(".")[0],e=[];e.length<400&&I.length;)e.push(I.shift());if(e.length)return!0===this.S.bg&&C.log("Writing "+e.length+" logs to index",e[0]._id,e[e.length-1]._id,t),await this.index("logs",e)||(await this.index("logs",{}),await this.index("logs",e)),[]},!1!==this.S.log){if(!0!==t&&(t=null==e),!0!==t&&(this._logs.length>3e4||I.length>3e4)&&(t=!0),"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(s=0,l=e.length;s<l;s++)n=e[s],this._logs.push(n);e=void 0}if(null==e){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return I.push(this.body),!1===A&&i(),!0;e="object"==typeof this.body?this.body:this.params,Array.isArray(e)&&(e={logs:e})}null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers,e.request.headers.cookie&&(e.cookie=!0,delete e.request.headers.cookie)}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(u in e.params={},this.params)e.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(e){}try{e.apikey=null!=this.apikey}catch(e){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}if(t){if(!e.logs&&(e.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(a=0,o=(p=this._logs).length;a<o;a++)(n=p[a]).alert&&null==e.alert&&(e.alert=n.alert),n.notify&&null==e.notify&&(e.notify=n.notify),e.logs.push(n);e.createdAt=new Date,null==e.name&&(e.name=r.name),null==e.version&&(e.version=r.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(e._id=this.rid,null!=(null!=(d=this.S.index)?d.url:void 0))!0===this.S.bg?(I.push(e),("object"==typeof this.S.log&&!1===this.S.log.batch||I.length>300||!1===S||Date.now()>S+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(I.push(e),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:e}));else try{this.kv("logs/"+e._id,e)}catch(t){C.log("Logging unable to save to kv or index"),consolg.log(e)}}else this._logs.push(e)}else this.S.dev&&!0===this.S.bg&&C.log("NOT logging",e);return!0},t.logs={_index:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(e){r.mail={}}t.mail=async function(e){var i,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S;if(null!=(p=r.mail)?p.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(d=this.copy(null!=this?this.params:void 0))?d:{}),e.template){for(o in u=await this.template(e.template,null!=(_=null!=(v=e.vars)?v:e.params)?_:e))e[o]=u[o];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(b=null!=(w=null!=(x=null!=(O=e.content)?O:e.msg)?x:e.body)?w:this.body)?b:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}if(delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),l=(e.svc||e.service)&&null!=(null!=(k=this.S.svc[null!=(j=e.svc)?j:e.service])?k.mail:void 0)?this.S.svc[null!=(h=e.svc)?h:e.service].mail:null!=(f=null!=this&&null!=(m=this.S)?m.mail:void 0)?f:r.mail,null==e.from&&(e.from=l.from),null==e.to&&(e.to=l.to),delete e.svc,S="https://api.mailgun.net/v3/"+l.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),e.to){for(i=null!=(y=null!=this?this.fetch:void 0)?y:t.fetch,c={method:"POST",auth:"api:"+l.apikey},a=0,n=(g=["file","files","attachment","attachments"]).length;a<n;a++)null!=e[s=g[a]]&&(c[s]=e[s],delete e[s]);return c.form=e,await i(S,c)}return C.log(e),C.log("NO ADDRESS TO EMAIL TO"),{}},t.mail._auth="system",t.mail.validate=async function(e,t){var i,r,s,a,n;if(null==e&&(e=null!=this&&null!=(s=this.params)?s.email:void 0),"string"==typeof e&&e.length&&(-1===e.indexOf(" ")||e.startsWith('"')&&2===e.split('"@').length)){try{if("string"==typeof t)return null!=(a=(n=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)).did_you_mean)?a:n.is_valid}catch(e){}if(2===(i=e.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(r=i[1].split(".")).length>1&&(2!==r.length||"example"!==r[0]))return!0}return!1},N=[].indexOf,t.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},t.copy._log=!1,t.dot=function(e,i,r,s,a){var n,l,o;return"string"==typeof i?t.dot(e,i.split("."),r,s,a):0===i.length?e:1!==i.length||null==r&&null==s?null==e[i[0]]?null!=r?(e[i[0]]="number"!=typeof i[0]&&isNaN(parseInt(i[0]))?{}:[],t.dot(e[i[0]],i.slice(1),r,s,a)):a&&Array.isArray(e)&&e.length&&(o=e[e.length-1]&&"object"==typeof o&&null!=o[i[0]])?t.dot(o[i[0]],i.slice(1),r,s,a):Array.isArray(e)&&e.length&&"object"==typeof e[0]?t.dot(e.flatMap((function(e){return null!=e[i[0]]?e[i[0]]:[]})),i.slice(1),r,s,a):void 0:a&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))&&e.length&&"object"==typeof e[e.length-1]?(null!=r&&null==(n=e[e.length-1])[l=i[0]]&&(n[l]={}),t.dot(e[e.length-1][i[0]],i.slice(1),r,s,a)):t.dot(e[i[0]],i.slice(1),r,s,a):null!=s?(e instanceof Array?e.splice(i[0],1):delete e[i[0]],!0):(a&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))?(e.length||(e=[{}]),e[e.length-1][i[0]]=r):e[i[0]]=r,!0)},t.dot._log=!1,t.flatten=async function(e,t){var i,r,s,a,n,l,o;if(null==t&&(t=null!=(n=this.params.arrayed)&&n),null==e&&delete(e=this.params).arrayed,l={},i=async function(e,r){var s,a,n,o,u,c,p;if("object"!=typeof e)return l=e;for(n in c=[],e){a=!1;try{a=!isNaN(parseInt(n))}catch(e){}u=a&&!t?r:r?r+"."+n:n,"object"!=typeof(p=e[n])?null!=l[u]?(Array.isArray(l[u])||(l[u]=[l[u]]),c.push(l[u].push(p))):c.push(l[u]=p):Array.isArray(p)?"object"==typeof p[0]?c.push(await async function(){var e;for(o in e=[],p)e.push(await i(p[o],u+(t?"."+o:"")));return e}()):(null==l[u]&&(l[u]=[]),Array.isArray(l[u])||(l[u]=[l[u]]),c.push(function(){var e,t,i;for(i=[],e=0,t=p.length;e<t;e++)s=p[e],i.push(l[u].push(s));return i}())):c.push(await i(p,u))}return c},Array.isArray(e)){for(o=[],s=0,a=e.length;s<a;s++)r=e[s],l={},await i(r),o.push(l);return o}return await i(e),l},t.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&N.call(i,t)<0&&i.push(t);return i},t.pings={_index:!0},t.ping=async function(){var e,t,i;return e=this.copy(this.params),"{}"!==JSON.stringify(e)&&(e.ip=null!=(t=null!=(i=this.headers["x-forwarded-for"])?i:this.headers["cf-connecting-ip"])?t:this.headers["x-real-ip"],e.forwarded=this.headers["x-forwarded-for"],await this.pings(e),!0)},t.scrape=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C;if(null==e&&(e=null!=(k=null!=(j=this.params.scrape)?j:this.params.content)?k:this.params.url),null==t&&(t=this.params.doi),f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(C=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&C.length>1&&9<C[1].length&&C[1].length<45&&-1!==C[1].indexOf("/")&&0===C[1].indexOf("10.")&&(f.doi=C[1]),e=await this.fetch(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{for(r=0,S=e.split(" "),a=0,o=S.length;a<o;a++)if(D=S[a],(r+=1)<600&&(-1!==(D=D.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(D=D.split("doi.org")[1]),0===D.indexOf("/")&&(D=D.replace("/","")),0===(D=D.trim()).indexOf("10.")&&-1!==D.indexOf("/"))){f.doi=D;break}}catch(e){}if(!f.doi)try{for(I=(s=await this.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=I.length;l<u;l++)b=I[l],!f.doi&&9<s.matches[b].result[1].length&&s.matches[b].result[1].length<45&&(f.doi=s.matches[b].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(e){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(w=0,c=m.length;w<c;w++)(v=m[w]).length>2&&(f.year=v)}catch(e){}if(!f.keywords)try{-1!==(n=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(n=n.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=n.split(";")):(n=n.replace(/, /g,",").replace(/ ,/g,","),f.keywords=n.split(","))}catch(e){}if(!f.email){y=[];try{for(A=(await this.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,p=A.length;x<p;x++)(g=A[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===y.indexOf(g)&&y.push(g)}catch(e){}for(y.sort((function(e,t){return t.length-e.length})),_="",O=0,d=y.length;O<d;O++)h=y[O],null==f.email&&(f.email=[]),-1===_.indexOf(h)&&f.email.push(h),_+=h}return f},t.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise((t=>setTimeout(t,null!=e?e:1e3)))},t.sleep._auth="root",t.sleep._log=!1,N=[].indexOf,t.template=async function(e,t){var i,r,s,a,n,l,o,u,c,p,d,h,f,m,y,g,_,v,b;if(null==e&&(e=null!=(f=null!=(m=this.params.content)?m:this.params.template)?f:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(y=this.params.url)?y:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{r=await this.templates(e),e=r.content}catch(e){}if(_={},(i=function(t,r=""){var s,a,n,l;for(s in n=[],t)a=r?r+"."+s:s,"object"!=typeof t[s]||Array.isArray(t[s])?-1!==e.toLowerCase().indexOf("{{"+a+"}}")?(l=new RegExp("{{"+a+"}}","gi"),n.push(e=e.replace(l,Array.isArray(t[s])?t[s].join(", "):"string"==typeof t[s]?t[s]:!0===t[s]?"Yes":!1===t[s]?"No":""))):n.push(void 0):n.push(i(t[s],r+(""===r?"":".")+s));return n})(t),u=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(b=["subject","from","to","cc","bcc"],s=0,p=(g=e.toLowerCase().split("{{")).length;s<p;s++)h=g[s].split("{{")[0].split("}}")[0].split(" ")[0],N.call(b,h)<0&&b.push(h);for(a=0,d=b.length;a<d;a++)n=b[a],(l=-1!==e.toLowerCase().indexOf("{{"+n)?n:void 0)&&(o=-1!==e.indexOf("{{"+l.toUpperCase())?l.toUpperCase():l,(v=e.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(v=v.replace(u,"")),(v=v.split("}}")[0].trim())&&(_[l]=v),c=new RegExp("{{"+o+".*?}}","gi"),e=e.replace(c,""))}return-1!==e.indexOf("{{")&&(e=e.replace(u,"")),_.content=e,_},t.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},t.levenshtein=function(e,t,i){var r,s,a,n,l,o,u,c,p,d,h,f,m;for(null==e&&(e=null!=this&&null!=(d=this.params)?d.a:void 0),null==t&&(t=null!=this&&null!=(h=this.params)?h.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(l=e.length)<(u=t.length)&&(r=e,e=t,t=r,c=l,l=u,u=c),p=[[]],r=0;r<u+1;)p[0][r]=r,r++;for(a=1;a<l+1;){for(p[a]=[a],n=1;n<u+1;)s=e.charAt(a-1)===t.charAt(n-1)?0:1,p[a][n]=o(p[a-1][n]+1,p[a][n-1]+1,p[a-1][n-1]+s),n++;a++}return{distance:p[p.length-1][p[p.length-1].length-1],length:{a:l,b:u}}},t.extract=async function(e){var t,i,r,s,a,n,l,o,u,c,p;if(null==e&&(e=this.copy(this.params)),e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=await this.fetch(e.url)),e.convert)try{p=await this.convert[e.convert+"2txt"](null!=(o=e.url)?o:e.content)}catch(e){}if(null==p&&(p=e.content),null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(l=p.split(e.start),p=l.length>1?l[1]:l[0]),null!=e.end&&(p=p.split(e.end)[0]),e.lowercase&&(p=p.toLowerCase()),e.ascii&&(p=p.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(p=p.replace(/ /g,"")),c={length:p.length,matched:0,matches:[],matchers:e.matchers,text:p},p&&"number"!=typeof p)for(t=0,r=(u="string"==typeof e.matchers?e.matchers.split(","):e.matchers).length;t<r;t++){"string"==typeof(a=u[t])?(n="",0===a.indexOf("/")?(i=a.lastIndexOf("/"))+1!==a.length&&(n=a.substring(i+1),a=a.substring(1,i)):a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):n="",e.lowercase&&(n+="i");try{(s=new RegExp(a,n).exec(p))&&(c.matched+=1,c.matches.push({matched:a.toString(),result:s}))}catch(e){}}return c},t.decode=async function(e){var t,i,r,s,a,n,l,o,u,c,p,d,h;for(null==e&&(e=null!=(n=null!=(l=null!=(o=null!=this&&null!=(u=this.params)?u.decode:void 0)?o:null!=this&&null!=(c=this.params)?c.content:void 0)?l:null!=this&&null!=(p=this.params)?p.text:void 0)?n:null!=this?this.body:void 0),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(x?[0-9A-Fa-f]+);/gi,(function(e,t){var i;return i=t.startsWith("x")?parseInt(t.replace("x",""),16):parseInt(t,10),String.fromCharCode(i)}))},h=(h=await t(e)).replace(/\n/g," "),r=0,s=(d=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;r<s;r++)i=d[r],a=new RegExp(i.bad,"g"),h=h.replace(a,i.good);try{-1!==h.indexOf("%2")&&(h=decodeURIComponent(h))}catch(e){}try{-1!==h.indexOf("%2")&&(h=decodeURIComponent(h))}catch(e){}return h},r.built="Thu Aug 07 2025 12:05:12 GMT+0100",t.convert.doc2txt={_bg:!0},t.convert.docx2txt={_bg:!0},t.convert.pdf2txt={_bg:!0}})()})();