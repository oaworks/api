/*! For license information please see worker.min.js.LICENSE.txt */
(()=>{var e={282:(e,t,i)=>{"use strict";var r=i(155),s=i(108);function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}var a,l,o=i(136).codes,u=o.ERR_AMBIGUOUS_ARGUMENT,c=o.ERR_INVALID_ARG_TYPE,p=o.ERR_INVALID_ARG_VALUE,h=o.ERR_INVALID_RETURN_VALUE,d=o.ERR_MISSING_ARGS,f=i(961),m=i(539).inspect,y=i(539).types,g=y.isPromise,_=y.isRegExp,v=Object.assign?Object.assign:i(91).assign,b=Object.is?Object.is:i(609);function w(){var e=i(158);a=e.isDeepEqual,l=e.isDeepStrictEqual}new Map;var x=!1,O=e.exports=A,k={};function j(e){if(e.message instanceof Error)throw e.message;throw new f(e)}function S(e,t,i,r){if(!i){var s=!1;if(0===t)s=!0,r="No value argument passed to `assert.ok()`";else if(r instanceof Error)throw r;var n=new f({actual:i,expected:!0,message:r,operator:"==",stackStartFn:e});throw n.generatedMessage=s,n}}function A(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];S.apply(void 0,[A,t.length].concat(t))}O.fail=function e(t,i,n,a,l){var o,u=arguments.length;if(0===u?o="Failed":1===u?(n=t,t=void 0):(!1===x&&(x=!0,(r.emitWarning?r.emitWarning:s.warn.bind(s))("assert.fail() with more than one argument is deprecated. Please use assert.strictEqual() instead or only pass a message.","DeprecationWarning","DEP0094")),2===u&&(a="!=")),n instanceof Error)throw n;var c={actual:t,expected:i,operator:void 0===a?"fail":a,stackStartFn:l||e};void 0!==n&&(c.message=n);var p=new f(c);throw o&&(p.message=o,p.generatedMessage=!0),p},O.AssertionError=f,O.ok=A,O.equal=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");t!=i&&j({actual:t,expected:i,message:r,operator:"==",stackStartFn:e})},O.notEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");t==i&&j({actual:t,expected:i,message:r,operator:"!=",stackStartFn:e})},O.deepEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&w(),a(t,i)||j({actual:t,expected:i,message:r,operator:"deepEqual",stackStartFn:e})},O.notDeepEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&w(),a(t,i)&&j({actual:t,expected:i,message:r,operator:"notDeepEqual",stackStartFn:e})},O.deepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&w(),l(t,i)||j({actual:t,expected:i,message:r,operator:"deepStrictEqual",stackStartFn:e})},O.notDeepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&w(),l(t,i)&&j({actual:t,expected:i,message:r,operator:"notDeepStrictEqual",stackStartFn:e})},O.strictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");b(t,i)||j({actual:t,expected:i,message:r,operator:"strictEqual",stackStartFn:e})},O.notStrictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");b(t,i)&&j({actual:t,expected:i,message:r,operator:"notStrictEqual",stackStartFn:e})};var I=function e(t,i,r){var s=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i.forEach((function(e){e in t&&(void 0!==r&&"string"==typeof r[e]&&_(t[e])&&t[e].test(r[e])?s[e]=r[e]:s[e]=t[e])}))};function D(e,t,i,r){if("function"!=typeof t){if(_(t))return t.test(e);if(2===arguments.length)throw new c("expected",["Function","RegExp"],t);if("object"!==n(e)||null===e){var s=new f({actual:e,expected:t,message:i,operator:"deepStrictEqual",stackStartFn:r});throw s.operator=r.name,s}var o=Object.keys(t);if(t instanceof Error)o.push("name","message");else if(0===o.length)throw new p("error",t,"may not be an empty object");return void 0===a&&w(),o.forEach((function(s){"string"==typeof e[s]&&_(t[s])&&t[s].test(e[s])||function(e,t,i,r,s,n){if(!(i in e)||!l(e[i],t[i])){if(!r){var a=new I(e,s),o=new I(t,s,e),u=new f({actual:a,expected:o,operator:"deepStrictEqual",stackStartFn:n});throw u.actual=e,u.expected=t,u.operator=n.name,u}j({actual:e,expected:t,message:r,operator:n.name,stackStartFn:n})}}(e,t,s,i,o,r)})),!0}return void 0!==t.prototype&&e instanceof t||!Error.isPrototypeOf(t)&&!0===t.call({},e)}function C(e){if("function"!=typeof e)throw new c("fn","Function",e);try{e()}catch(e){return e}return k}function E(e){return g(e)||null!==e&&"object"===n(e)&&"function"==typeof e.then&&"function"==typeof e.catch}function R(e){return Promise.resolve().then((function(){var t;if("function"==typeof e){if(!E(t=e()))throw new h("instance of Promise","promiseFn",t)}else{if(!E(e))throw new c("promiseFn",["Function","Promise"],e);t=e}return Promise.resolve().then((function(){return t})).then((function(){return k})).catch((function(e){return e}))}))}function N(e,t,i,r){if("string"==typeof i){if(4===arguments.length)throw new c("error",["Object","Error","Function","RegExp"],i);if("object"===n(t)&&null!==t){if(t.message===i)throw new u("error/message",'The error message "'.concat(t.message,'" is identical to the message.'))}else if(t===i)throw new u("error/message",'The error "'.concat(t,'" is identical to the message.'));r=i,i=void 0}else if(null!=i&&"object"!==n(i)&&"function"!=typeof i)throw new c("error",["Object","Error","Function","RegExp"],i);if(t===k){var s="";i&&i.name&&(s+=" (".concat(i.name,")")),s+=r?": ".concat(r):".";var a="rejects"===e.name?"rejection":"exception";j({actual:void 0,expected:i,operator:e.name,message:"Missing expected ".concat(a).concat(s),stackStartFn:e})}if(i&&!D(t,i,r,e))throw t}function L(e,t,i,r){if(t!==k){if("string"==typeof i&&(r=i,i=void 0),!i||D(t,i)){var s=r?": ".concat(r):".",n="doesNotReject"===e.name?"rejection":"exception";j({actual:t,expected:i,operator:e.name,message:"Got unwanted ".concat(n).concat(s,"\n")+'Actual message: "'.concat(t&&t.message,'"'),stackStartFn:e})}throw t}}function P(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];S.apply(void 0,[P,t.length].concat(t))}O.throws=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];N.apply(void 0,[e,C(t)].concat(r))},O.rejects=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return R(t).then((function(t){return N.apply(void 0,[e,t].concat(r))}))},O.doesNotThrow=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];L.apply(void 0,[e,C(t)].concat(r))},O.doesNotReject=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return R(t).then((function(t){return L.apply(void 0,[e,t].concat(r))}))},O.ifError=function e(t){if(null!=t){var i="ifError got unwanted exception: ";"object"===n(t)&&"string"==typeof t.message?0===t.message.length&&t.constructor?i+=t.constructor.name:i+=t.message:i+=m(t);var r=new f({actual:t,expected:null,operator:"ifError",message:i,stackStartFn:e}),s=t.stack;if("string"==typeof s){var a=s.split("\n");a.shift();for(var l=r.stack.split("\n"),o=0;o<a.length;o++){var u=l.indexOf(a[o]);if(-1!==u){l=l.slice(0,u);break}}r.stack="".concat(l.join("\n"),"\n").concat(a.join("\n"))}throw r}},O.strict=v(P,O,{equal:O.strictEqual,deepEqual:O.deepStrictEqual,notEqual:O.notStrictEqual,notDeepEqual:O.notDeepStrictEqual}),O.strict.strict=O.strict},961:(e,t,i)=>{"use strict";var r=i(155);function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return!t||"object"!==h(t)&&"function"!=typeof t?l(e):t}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,p(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},o(e)}function u(e,t,i){return u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var r=[null];r.push.apply(r,t);var s=new(Function.bind.apply(e,r));return i&&c(s,i.prototype),s},u.apply(null,arguments)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}var d=i(539).inspect,f=i(136).codes.ERR_INVALID_ARG_TYPE;function m(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t}var y="",g="",_="",v="",b={deepStrictEqual:"Expected values to be strictly deep-equal:",strictEqual:"Expected values to be strictly equal:",strictEqualObject:'Expected "actual" to be reference-equal to "expected":',deepEqual:"Expected values to be loosely deep-equal:",equal:"Expected values to be loosely equal:",notDeepStrictEqual:'Expected "actual" not to be strictly deep-equal to:',notStrictEqual:'Expected "actual" to be strictly unequal to:',notStrictEqualObject:'Expected "actual" not to be reference-equal to "expected":',notDeepEqual:'Expected "actual" not to be loosely deep-equal to:',notEqual:'Expected "actual" to be loosely unequal to:',notIdentical:"Values identical but not reference-equal:"};function w(e){var t=Object.keys(e),i=Object.create(Object.getPrototypeOf(e));return t.forEach((function(t){i[t]=e[t]})),Object.defineProperty(i,"message",{value:e.message}),i}function x(e){return d(e,{compact:!1,customInspect:!1,depth:1e3,maxArrayLength:1/0,showHidden:!1,breakLength:1/0,showProxy:!1,sorted:!0,getters:!0})}var O=function(e){function t(e){var i;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),"object"!==h(e)||null===e)throw new f("options","Object",e);var s=e.message,n=e.operator,o=e.stackStartFn,u=e.actual,c=e.expected,d=Error.stackTraceLimit;if(Error.stackTraceLimit=0,null!=s)i=a(this,p(t).call(this,String(s)));else if(r.stderr&&r.stderr.isTTY&&(r.stderr&&r.stderr.getColorDepth&&1!==r.stderr.getColorDepth()?(y="[34m",g="[32m",v="[39m",_="[31m"):(y="",g="",v="",_="")),"object"===h(u)&&null!==u&&"object"===h(c)&&null!==c&&"stack"in u&&u instanceof Error&&"stack"in c&&c instanceof Error&&(u=w(u),c=w(c)),"deepStrictEqual"===n||"strictEqual"===n)i=a(this,p(t).call(this,function(e,t,i){var s="",n="",a=0,l="",o=!1,u=x(e),c=u.split("\n"),p=x(t).split("\n"),d=0,f="";if("strictEqual"===i&&"object"===h(e)&&"object"===h(t)&&null!==e&&null!==t&&(i="strictEqualObject"),1===c.length&&1===p.length&&c[0]!==p[0]){var w=c[0].length+p[0].length;if(w<=10){if(!("object"===h(e)&&null!==e||"object"===h(t)&&null!==t||0===e&&0===t))return"".concat(b[i],"\n\n")+"".concat(c[0]," !== ").concat(p[0],"\n")}else if("strictEqualObject"!==i&&w<(r.stderr&&r.stderr.isTTY?r.stderr.columns:80)){for(;c[0][d]===p[0][d];)d++;d>2&&(f="\n  ".concat(function(e,t){if(t=Math.floor(t),0==e.length||0==t)return"";var i=e.length*t;for(t=Math.floor(Math.log(t)/Math.log(2));t;)e+=e,t--;return e+e.substring(0,i-e.length)}(" ",d),"^"),d=0)}}for(var O=c[c.length-1],k=p[p.length-1];O===k&&(d++<2?l="\n  ".concat(O).concat(l):s=O,c.pop(),p.pop(),0!==c.length&&0!==p.length);)O=c[c.length-1],k=p[p.length-1];var j=Math.max(c.length,p.length);if(0===j){var S=u.split("\n");if(S.length>30)for(S[26]="".concat(y,"...").concat(v);S.length>27;)S.pop();return"".concat(b.notIdentical,"\n\n").concat(S.join("\n"),"\n")}d>3&&(l="\n".concat(y,"...").concat(v).concat(l),o=!0),""!==s&&(l="\n  ".concat(s).concat(l),s="");var A=0,I=b[i]+"\n".concat(g,"+ actual").concat(v," ").concat(_,"- expected").concat(v),D=" ".concat(y,"...").concat(v," Lines skipped");for(d=0;d<j;d++){var C=d-a;if(c.length<d+1)C>1&&d>2&&(C>4?(n+="\n".concat(y,"...").concat(v),o=!0):C>3&&(n+="\n  ".concat(p[d-2]),A++),n+="\n  ".concat(p[d-1]),A++),a=d,s+="\n".concat(_,"-").concat(v," ").concat(p[d]),A++;else if(p.length<d+1)C>1&&d>2&&(C>4?(n+="\n".concat(y,"...").concat(v),o=!0):C>3&&(n+="\n  ".concat(c[d-2]),A++),n+="\n  ".concat(c[d-1]),A++),a=d,n+="\n".concat(g,"+").concat(v," ").concat(c[d]),A++;else{var E=p[d],R=c[d],N=R!==E&&(!m(R,",")||R.slice(0,-1)!==E);N&&m(E,",")&&E.slice(0,-1)===R&&(N=!1,R+=","),N?(C>1&&d>2&&(C>4?(n+="\n".concat(y,"...").concat(v),o=!0):C>3&&(n+="\n  ".concat(c[d-2]),A++),n+="\n  ".concat(c[d-1]),A++),a=d,n+="\n".concat(g,"+").concat(v," ").concat(R),s+="\n".concat(_,"-").concat(v," ").concat(E),A+=2):(n+=s,s="",1!==C&&0!==d||(n+="\n  ".concat(R),A++))}if(A>20&&d<j-2)return"".concat(I).concat(D,"\n").concat(n,"\n").concat(y,"...").concat(v).concat(s,"\n")+"".concat(y,"...").concat(v)}return"".concat(I).concat(o?D:"","\n").concat(n).concat(s).concat(l).concat(f)}(u,c,n)));else if("notDeepStrictEqual"===n||"notStrictEqual"===n){var O=b[n],k=x(u).split("\n");if("notStrictEqual"===n&&"object"===h(u)&&null!==u&&(O=b.notStrictEqualObject),k.length>30)for(k[26]="".concat(y,"...").concat(v);k.length>27;)k.pop();i=1===k.length?a(this,p(t).call(this,"".concat(O," ").concat(k[0]))):a(this,p(t).call(this,"".concat(O,"\n\n").concat(k.join("\n"),"\n")))}else{var j=x(u),S="",A=b[n];"notDeepEqual"===n||"notEqual"===n?(j="".concat(b[n],"\n\n").concat(j)).length>1024&&(j="".concat(j.slice(0,1021),"...")):(S="".concat(x(c)),j.length>512&&(j="".concat(j.slice(0,509),"...")),S.length>512&&(S="".concat(S.slice(0,509),"...")),"deepEqual"===n||"equal"===n?j="".concat(A,"\n\n").concat(j,"\n\nshould equal\n\n"):S=" ".concat(n," ").concat(S)),i=a(this,p(t).call(this,"".concat(j).concat(S)))}return Error.stackTraceLimit=d,i.generatedMessage=!s,Object.defineProperty(l(i),"name",{value:"AssertionError [ERR_ASSERTION]",enumerable:!1,writable:!0,configurable:!0}),i.code="ERR_ASSERTION",i.actual=u,i.expected=c,i.operator=n,Error.captureStackTrace&&Error.captureStackTrace(l(i),o),i.stack,i.name="AssertionError",a(i)}var i,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),i=t,o=[{key:"toString",value:function(){return"".concat(this.name," [").concat(this.code,"]: ").concat(this.message)}},{key:d.custom,value:function(e,t){return d(this,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),r.forEach((function(t){s(e,t,i[t])}))}return e}({},t,{customInspect:!1,depth:0}))}}],o&&n(i.prototype,o),t}(o(Error));e.exports=O},136:(e,t,i)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function n(e,t){return n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,t)}var a,l,o={};function u(e,t,i){i||(i=Error);var a=function(i){function a(i,n,l){var o,u,c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),u=this,c=s(a).call(this,function(e,i,r){return"string"==typeof t?t:t(e,i,r)}(i,n,l)),o=!c||"object"!==r(c)&&"function"!=typeof c?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(u):c,o.code=e,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}(a,i),a}(i);o[e]=a}function c(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map((function(e){return String(e)})),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:2===i?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}u("ERR_AMBIGUOUS_ARGUMENT",'The "%s" argument is ambiguous. %s',TypeError),u("ERR_INVALID_ARG_TYPE",(function(e,t,s){var n,l,o,u,p;if(void 0===a&&(a=i(282)),a("string"==typeof e,"'name' must be a string"),"string"==typeof t&&(l="not ",t.substr(0,4)===l)?(n="must not be",t=t.replace(/^not /,"")):n="must be",function(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-9,i)===t}(e," argument"))o="The ".concat(e," ").concat(n," ").concat(c(t,"type"));else{var h=("number"!=typeof p&&(p=0),p+1>(u=e).length||-1===u.indexOf(".",p)?"argument":"property");o='The "'.concat(e,'" ').concat(h," ").concat(n," ").concat(c(t,"type"))}return o+". Received type ".concat(r(s))}),TypeError),u("ERR_INVALID_ARG_VALUE",(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"is invalid";void 0===l&&(l=i(539));var s=l.inspect(t);return s.length>128&&(s="".concat(s.slice(0,128),"...")),"The argument '".concat(e,"' ").concat(r,". Received ").concat(s)}),TypeError,RangeError),u("ERR_INVALID_RETURN_VALUE",(function(e,t,i){var s;return s=i&&i.constructor&&i.constructor.name?"instance of ".concat(i.constructor.name):"type ".concat(r(i)),"Expected ".concat(e,' to be returned from the "').concat(t,'"')+" function but got ".concat(s,".")}),TypeError),u("ERR_MISSING_ARGS",(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];void 0===a&&(a=i(282)),a(t.length>0,"At least one arg needs to be specified");var s="The ",n=t.length;switch(t=t.map((function(e){return'"'.concat(e,'"')})),n){case 1:s+="".concat(t[0]," argument");break;case 2:s+="".concat(t[0]," and ").concat(t[1]," arguments");break;default:s+=t.slice(0,n-1).join(", "),s+=", and ".concat(t[n-1]," arguments")}return"".concat(s," must be specified")}),TypeError),e.exports.codes=o},158:(e,t,i)=>{"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=[],r=!0,s=!1,n=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){s=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(s)throw n}}return i}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}var n=void 0!==/a/g.flags,a=function(e){var t=[];return e.forEach((function(e){return t.push(e)})),t},l=function(e){var t=[];return e.forEach((function(e,i){return t.push([i,e])})),t},o=Object.is?Object.is:i(609),u=Object.getOwnPropertySymbols?Object.getOwnPropertySymbols:function(){return[]},c=Number.isNaN?Number.isNaN:i(360);function p(e){return e.call.bind(e)}var h=p(Object.prototype.hasOwnProperty),d=p(Object.prototype.propertyIsEnumerable),f=p(Object.prototype.toString),m=i(539).types,y=m.isAnyArrayBuffer,g=m.isArrayBufferView,_=m.isDate,v=m.isMap,b=m.isRegExp,w=m.isSet,x=m.isNativeError,O=m.isBoxedPrimitive,k=m.isNumberObject,j=m.isStringObject,S=m.isBooleanObject,A=m.isBigIntObject,I=m.isSymbolObject,D=m.isFloat32Array,C=m.isFloat64Array;function E(e){if(0===e.length||e.length>10)return!0;for(var t=0;t<e.length;t++){var i=e.charCodeAt(t);if(i<48||i>57)return!0}return 10===e.length&&e>=Math.pow(2,32)}function R(e){return Object.keys(e).filter(E).concat(u(e).filter(Object.prototype.propertyIsEnumerable.bind(e)))}function N(e,t){if(e===t)return 0;for(var i=e.length,r=t.length,s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0}var L=0,P=1,q=2,T=3;function W(e,t,i,r){if(e===t)return 0!==e||!i||o(e,t);if(i){if("object"!==s(e))return"number"==typeof e&&c(e)&&c(t);if("object"!==s(t)||null===e||null===t)return!1;if(Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1}else{if(null===e||"object"!==s(e))return(null===t||"object"!==s(t))&&e==t;if(null===t||"object"!==s(t))return!1}var a,l,u,p,h=f(e);if(h!==f(t))return!1;if(Array.isArray(e)){if(e.length!==t.length)return!1;var d=R(e),m=R(t);return d.length===m.length&&U(e,t,i,r,P,d)}if("[object Object]"===h&&(!v(e)&&v(t)||!w(e)&&w(t)))return!1;if(_(e)){if(!_(t)||Date.prototype.getTime.call(e)!==Date.prototype.getTime.call(t))return!1}else if(b(e)){if(!b(t)||(u=e,p=t,!(n?u.source===p.source&&u.flags===p.flags:RegExp.prototype.toString.call(u)===RegExp.prototype.toString.call(p))))return!1}else if(x(e)||e instanceof Error){if(e.message!==t.message||e.name!==t.name)return!1}else{if(g(e)){if(i||!D(e)&&!C(e)){if(!function(e,t){return e.byteLength===t.byteLength&&0===N(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new Uint8Array(t.buffer,t.byteOffset,t.byteLength))}(e,t))return!1}else if(!function(e,t){if(e.byteLength!==t.byteLength)return!1;for(var i=0;i<e.byteLength;i++)if(e[i]!==t[i])return!1;return!0}(e,t))return!1;var E=R(e),W=R(t);return E.length===W.length&&U(e,t,i,r,L,E)}if(w(e))return!(!w(t)||e.size!==t.size)&&U(e,t,i,r,q);if(v(e))return!(!v(t)||e.size!==t.size)&&U(e,t,i,r,T);if(y(e)){if(l=t,(a=e).byteLength!==l.byteLength||0!==N(new Uint8Array(a),new Uint8Array(l)))return!1}else if(O(e)&&!function(e,t){return k(e)?k(t)&&o(Number.prototype.valueOf.call(e),Number.prototype.valueOf.call(t)):j(e)?j(t)&&String.prototype.valueOf.call(e)===String.prototype.valueOf.call(t):S(e)?S(t)&&Boolean.prototype.valueOf.call(e)===Boolean.prototype.valueOf.call(t):A(e)?A(t)&&BigInt.prototype.valueOf.call(e)===BigInt.prototype.valueOf.call(t):I(t)&&Symbol.prototype.valueOf.call(e)===Symbol.prototype.valueOf.call(t)}(e,t))return!1}return U(e,t,i,r,L)}function M(e,t){return t.filter((function(t){return d(e,t)}))}function U(e,t,i,n,o,c){if(5===arguments.length){c=Object.keys(e);var p=Object.keys(t);if(c.length!==p.length)return!1}for(var f=0;f<c.length;f++)if(!h(t,c[f]))return!1;if(i&&5===arguments.length){var m=u(e);if(0!==m.length){var y=0;for(f=0;f<m.length;f++){var g=m[f];if(d(e,g)){if(!d(t,g))return!1;c.push(g),y++}else if(d(t,g))return!1}var _=u(t);if(m.length!==_.length&&M(t,_).length!==y)return!1}else{var v=u(t);if(0!==v.length&&0!==M(t,v).length)return!1}}if(0===c.length&&(o===L||o===P&&0===e.length||0===e.size))return!0;if(void 0===n)n={val1:new Map,val2:new Map,position:0};else{var b=n.val1.get(e);if(void 0!==b){var w=n.val2.get(t);if(void 0!==w)return b===w}n.position++}n.val1.set(e,n.position),n.val2.set(t,n.position);var x=function(e,t,i,n,o,u){var c=0;if(u===q){if(!function(e,t,i,r){for(var n=null,l=a(e),o=0;o<l.length;o++){var u=l[o];if("object"===s(u)&&null!==u)null===n&&(n=new Set),n.add(u);else if(!t.has(u)){if(i)return!1;if(!F(e,t,u))return!1;null===n&&(n=new Set),n.add(u)}}if(null!==n){for(var c=a(t),p=0;p<c.length;p++){var h=c[p];if("object"===s(h)&&null!==h){if(!z(n,h,i,r))return!1}else if(!i&&!e.has(h)&&!z(n,h,i,r))return!1}return 0===n.size}return!0}(e,t,i,o))return!1}else if(u===T){if(!function(e,t,i,n){for(var a=null,o=l(e),u=0;u<o.length;u++){var c=r(o[u],2),p=c[0],h=c[1];if("object"===s(p)&&null!==p)null===a&&(a=new Set),a.add(p);else{var d=t.get(p);if(void 0===d&&!t.has(p)||!W(h,d,i,n)){if(i)return!1;if(!J(e,t,p,h,n))return!1;null===a&&(a=new Set),a.add(p)}}}if(null!==a){for(var f=l(t),m=0;m<f.length;m++){var y=r(f[m],2),g=(p=y[0],y[1]);if("object"===s(p)&&null!==p){if(!$(a,e,p,g,i,n))return!1}else if(!(i||e.has(p)&&W(e.get(p),g,!1,n)||$(a,e,p,g,!1,n)))return!1}return 0===a.size}return!0}(e,t,i,o))return!1}else if(u===P)for(;c<e.length;c++){if(!h(e,c)){if(h(t,c))return!1;for(var p=Object.keys(e);c<p.length;c++){var d=p[c];if(!h(t,d)||!W(e[d],t[d],i,o))return!1}return p.length===Object.keys(t).length}if(!h(t,c)||!W(e[c],t[c],i,o))return!1}for(c=0;c<n.length;c++){var f=n[c];if(!W(e[f],t[f],i,o))return!1}return!0}(e,t,i,c,n,o);return n.val1.delete(e),n.val2.delete(t),x}function z(e,t,i,r){for(var s=a(e),n=0;n<s.length;n++){var l=s[n];if(W(t,l,i,r))return e.delete(l),!0}return!1}function B(e){switch(s(e)){case"undefined":return null;case"object":return;case"symbol":return!1;case"string":e=+e;case"number":if(c(e))return!1}return!0}function F(e,t,i){var r=B(i);return null!=r?r:t.has(r)&&!e.has(r)}function J(e,t,i,r,s){var n=B(i);if(null!=n)return n;var a=t.get(n);return!(void 0===a&&!t.has(n)||!W(r,a,!1,s))&&!e.has(n)&&W(r,a,!1,s)}function $(e,t,i,r,s,n){for(var l=a(e),o=0;o<l.length;o++){var u=l[o];if(W(i,u,s,n)&&W(r,t.get(u),s,n))return e.delete(u),!0}return!1}e.exports={isDeepEqual:function(e,t){return W(e,t,!1)},isDeepStrictEqual:function(e,t){return W(e,t,!0)}}},742:(e,t)=>{"use strict";t.byteLength=function(e){var t=l(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,n=l(e),a=n[0],o=n[1],u=new s(function(e,t,i){return 3*(t+i)/4-i}(0,a,o)),c=0,p=o>0?a-4:a;for(i=0;i<p;i+=4)t=r[e.charCodeAt(i)]<<18|r[e.charCodeAt(i+1)]<<12|r[e.charCodeAt(i+2)]<<6|r[e.charCodeAt(i+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;return 2===o&&(t=r[e.charCodeAt(i)]<<2|r[e.charCodeAt(i+1)]>>4,u[c++]=255&t),1===o&&(t=r[e.charCodeAt(i)]<<10|r[e.charCodeAt(i+1)]<<4|r[e.charCodeAt(i+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,s=r%3,n=[],a=16383,l=0,u=r-s;l<u;l+=a)n.push(o(e,l,l+a>u?u:l+a));return 1===s?(t=e[r-1],n.push(i[t>>2]+i[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],n.push(i[t>>10]+i[t>>4&63]+i[t<<2&63]+"=")),n.join("")};for(var i=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)i[a]=n[a],r[n.charCodeAt(a)]=a;function l(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function o(e,t,r){for(var s,n,a=[],l=t;l<r;l+=3)s=(e[l]<<16&16711680)+(e[l+1]<<8&65280)+(255&e[l+2]),a.push(i[(n=s)>>18&63]+i[n>>12&63]+i[n>>6&63]+i[63&n]);return a.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},764:(e,t,i)=>{"use strict";var r=i(108);const s=i(742),n=i(645),a="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.lW=u,t.h2=50;const l=2147483647;function o(e){if(e>l)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,u.prototype),t}function u(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return h(e)}return c(e,t,i)}function c(e,t,i){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!u.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const i=0|y(e,t);let r=o(i);const s=r.write(e,t);return s!==i&&(r=r.slice(0,s)),r}(e,t);if(ArrayBuffer.isView(e))return function(e){if(H(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return d(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(H(e,ArrayBuffer)||e&&H(e.buffer,ArrayBuffer))return f(e,t,i);if("undefined"!=typeof SharedArrayBuffer&&(H(e,SharedArrayBuffer)||e&&H(e.buffer,SharedArrayBuffer)))return f(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return u.from(r,t,i);const s=function(e){if(u.isBuffer(e)){const t=0|m(e.length),i=o(t);return 0===i.length||e.copy(i,0,0,t),i}return void 0!==e.length?"number"!=typeof e.length||Z(e.length)?o(0):d(e):"Buffer"===e.type&&Array.isArray(e.data)?d(e.data):void 0}(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return u.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function p(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e){return p(e),o(e<0?0:0|m(e))}function d(e){const t=e.length<0?0:0|m(e.length),i=o(t);for(let r=0;r<t;r+=1)i[r]=255&e[r];return i}function f(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i),Object.setPrototypeOf(r,u.prototype),r}function m(e){if(e>=l)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l.toString(16)+" bytes");return 0|e}function y(e,t){if(u.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||H(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const i=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===i)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return V(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return G(e).length;default:if(s)return r?-1:V(e).length;t=(""+t).toLowerCase(),s=!0}}function g(e,t,i){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,i);case"utf8":case"utf-8":return A(this,t,i);case"ascii":return D(this,t,i);case"latin1":case"binary":return C(this,t,i);case"base64":return S(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function _(e,t,i){const r=e[t];e[t]=e[i],e[i]=r}function v(e,t,i,r,s){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Z(i=+i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=u.from(t,r)),u.isBuffer(t))return 0===t.length?-1:b(e,t,i,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):b(e,[t],i,r,s);throw new TypeError("val must be string, number or Buffer")}function b(e,t,i,r,s){let n,a=1,l=e.length,o=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;a=2,l/=2,o/=2,i/=2}function u(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(s){let r=-1;for(n=i;n<l;n++)if(u(e,n)===u(t,-1===r?0:n-r)){if(-1===r&&(r=n),n-r+1===o)return r*a}else-1!==r&&(n-=n-r),r=-1}else for(i+o>l&&(i=l-o),n=i;n>=0;n--){let i=!0;for(let r=0;r<o;r++)if(u(e,n+r)!==u(t,r)){i=!1;break}if(i)return n}return-1}function w(e,t,i,r){i=Number(i)||0;const s=e.length-i;r?(r=Number(r))>s&&(r=s):r=s;const n=t.length;let a;for(r>n/2&&(r=n/2),a=0;a<r;++a){const r=parseInt(t.substr(2*a,2),16);if(Z(r))return a;e[i+a]=r}return a}function x(e,t,i,r){return Y(V(t,e.length-i),e,i,r)}function O(e,t,i,r){return Y(function(e){const t=[];for(let i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function k(e,t,i,r){return Y(G(t),e,i,r)}function j(e,t,i,r){return Y(function(e,t){let i,r,s;const n=[];for(let a=0;a<e.length&&!((t-=2)<0);++a)i=e.charCodeAt(a),r=i>>8,s=i%256,n.push(s),n.push(r);return n}(t,e.length-i),e,i,r)}function S(e,t,i){return 0===t&&i===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,i))}function A(e,t,i){i=Math.min(e.length,i);const r=[];let s=t;for(;s<i;){const t=e[s];let n=null,a=t>239?4:t>223?3:t>191?2:1;if(s+a<=i){let i,r,l,o;switch(a){case 1:t<128&&(n=t);break;case 2:i=e[s+1],128==(192&i)&&(o=(31&t)<<6|63&i,o>127&&(n=o));break;case 3:i=e[s+1],r=e[s+2],128==(192&i)&&128==(192&r)&&(o=(15&t)<<12|(63&i)<<6|63&r,o>2047&&(o<55296||o>57343)&&(n=o));break;case 4:i=e[s+1],r=e[s+2],l=e[s+3],128==(192&i)&&128==(192&r)&&128==(192&l)&&(o=(15&t)<<18|(63&i)<<12|(63&r)<<6|63&l,o>65535&&o<1114112&&(n=o))}}null===n?(n=65533,a=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=a}return function(e){const t=e.length;if(t<=I)return String.fromCharCode.apply(String,e);let i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=I));return i}(r)}u.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),u.TYPED_ARRAY_SUPPORT||void 0===r||"function"!=typeof r.error||r.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}}),u.poolSize=8192,u.from=function(e,t,i){return c(e,t,i)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array),u.alloc=function(e,t,i){return function(e,t,i){return p(e),e<=0?o(e):void 0!==t?"string"==typeof i?o(e).fill(t,i):o(e).fill(t):o(e)}(e,t,i)},u.allocUnsafe=function(e){return h(e)},u.allocUnsafeSlow=function(e){return h(e)},u.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==u.prototype},u.compare=function(e,t){if(H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),H(t,Uint8Array)&&(t=u.from(t,t.offset,t.byteLength)),!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let i=e.length,r=t.length;for(let s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);let i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;const r=u.allocUnsafe(t);let s=0;for(i=0;i<e.length;++i){let t=e[i];if(H(t,Uint8Array))s+t.length>r.length?(u.isBuffer(t)||(t=u.from(t)),t.copy(r,s)):Uint8Array.prototype.set.call(r,t,s);else{if(!u.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,s)}s+=t.length}return r},u.byteLength=y,u.prototype._isBuffer=!0,u.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)_(this,t,t+1);return this},u.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},u.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},u.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?A(this,0,e):g.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){let e="";const i=t.h2;return e=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(e+=" ... "),"<Buffer "+e+">"},a&&(u.prototype[a]=u.prototype.inspect),u.prototype.compare=function(e,t,i,r,s){if(H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),!u.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||i>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=i)return 0;if(r>=s)return-1;if(t>=i)return 1;if(this===e)return 0;let n=(s>>>=0)-(r>>>=0),a=(i>>>=0)-(t>>>=0);const l=Math.min(n,a),o=this.slice(r,s),c=e.slice(t,i);for(let e=0;e<l;++e)if(o[e]!==c[e]){n=o[e],a=c[e];break}return n<a?-1:a<n?1:0},u.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},u.prototype.indexOf=function(e,t,i){return v(this,e,t,i,!0)},u.prototype.lastIndexOf=function(e,t,i){return v(this,e,t,i,!1)},u.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}const s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let n=!1;for(;;)switch(r){case"hex":return w(this,e,t,i);case"utf8":case"utf-8":return x(this,e,t,i);case"ascii":case"latin1":case"binary":return O(this,e,t,i);case"base64":return k(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,e,t,i);default:if(n)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),n=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const I=4096;function D(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(127&e[s]);return r}function C(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(e[s]);return r}function E(e,t,i){const r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);let s="";for(let r=t;r<i;++r)s+=K[e[r]];return s}function R(e,t,i){const r=e.slice(t,i);let s="";for(let e=0;e<r.length-1;e+=2)s+=String.fromCharCode(r[e]+256*r[e+1]);return s}function N(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function L(e,t,i,r,s,n){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function P(e,t,i,r,s){F(t,r,s,e,i,7);let n=Number(t&BigInt(4294967295));e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n;let a=Number(t>>BigInt(32)&BigInt(4294967295));return e[i++]=a,a>>=8,e[i++]=a,a>>=8,e[i++]=a,a>>=8,e[i++]=a,i}function q(e,t,i,r,s){F(t,r,s,e,i,7);let n=Number(t&BigInt(4294967295));e[i+7]=n,n>>=8,e[i+6]=n,n>>=8,e[i+5]=n,n>>=8,e[i+4]=n;let a=Number(t>>BigInt(32)&BigInt(4294967295));return e[i+3]=a,a>>=8,e[i+2]=a,a>>=8,e[i+1]=a,a>>=8,e[i]=a,i+8}function T(e,t,i,r,s,n){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function W(e,t,i,r,s){return t=+t,i>>>=0,s||T(e,0,i,4),n.write(e,t,i,r,23,4),i+4}function M(e,t,i,r,s){return t=+t,i>>>=0,s||T(e,0,i,8),n.write(e,t,i,r,52,8),i+8}u.prototype.slice=function(e,t){const i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,u.prototype),r},u.prototype.readUintLE=u.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||N(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return r},u.prototype.readUintBE=u.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||N(e,t,this.length);let r=this[e+--t],s=1;for(;t>0&&(s*=256);)r+=this[e+--t]*s;return r},u.prototype.readUint8=u.prototype.readUInt8=function(e,t){return e>>>=0,t||N(e,1,this.length),this[e]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(e,t){return e>>>=0,t||N(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(e,t){return e>>>=0,t||N(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readBigUInt64LE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,s=this[++e]+256*this[++e]+65536*this[++e]+i*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))})),u.prototype.readBigUInt64BE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],s=this[++e]*2**24+65536*this[++e]+256*this[++e]+i;return(BigInt(r)<<BigInt(32))+BigInt(s)})),u.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||N(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},u.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||N(e,t,this.length);let r=t,s=1,n=this[e+--r];for(;r>0&&(s*=256);)n+=this[e+--r]*s;return s*=128,n>=s&&(n-=Math.pow(2,8*t)),n},u.prototype.readInt8=function(e,t){return e>>>=0,t||N(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){e>>>=0,t||N(e,2,this.length);const i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt16BE=function(e,t){e>>>=0,t||N(e,2,this.length);const i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt32LE=function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readBigInt64LE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(i<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),u.prototype.readBigInt64BE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+i)})),u.prototype.readFloatLE=function(e,t){return e>>>=0,t||N(e,4,this.length),n.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return e>>>=0,t||N(e,4,this.length),n.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return e>>>=0,t||N(e,8,this.length),n.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return e>>>=0,t||N(e,8,this.length),n.read(this,e,!1,52,8)},u.prototype.writeUintLE=u.prototype.writeUIntLE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||L(this,e,t,i,Math.pow(2,8*i)-1,0);let s=1,n=0;for(this[t]=255&e;++n<i&&(s*=256);)this[t+n]=e/s&255;return t+i},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||L(this,e,t,i,Math.pow(2,8*i)-1,0);let s=i-1,n=1;for(this[t+s]=255&e;--s>=0&&(n*=256);)this[t+s]=e/n&255;return t+i},u.prototype.writeUint8=u.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,1,255,0),this[t]=255&e,t+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigUInt64LE=Q((function(e,t=0){return P(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeBigUInt64BE=Q((function(e,t=0){return q(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);L(this,e,t,i,r-1,-r)}let s=0,n=1,a=0;for(this[t]=255&e;++s<i&&(n*=256);)e<0&&0===a&&0!==this[t+s-1]&&(a=1),this[t+s]=(e/n>>0)-a&255;return t+i},u.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);L(this,e,t,i,r-1,-r)}let s=i-1,n=1,a=0;for(this[t+s]=255&e;--s>=0&&(n*=256);)e<0&&0===a&&0!==this[t+s+1]&&(a=1),this[t+s]=(e/n>>0)-a&255;return t+i},u.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},u.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||L(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigInt64LE=Q((function(e,t=0){return P(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeBigInt64BE=Q((function(e,t=0){return q(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeFloatLE=function(e,t,i){return W(this,e,t,!0,i)},u.prototype.writeFloatBE=function(e,t,i){return W(this,e,t,!1,i)},u.prototype.writeDoubleLE=function(e,t,i){return M(this,e,t,!0,i)},u.prototype.writeDoubleBE=function(e,t,i){return M(this,e,t,!1,i)},u.prototype.copy=function(e,t,i,r){if(!u.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);const s=r-i;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,i,r):Uint8Array.prototype.set.call(e,this.subarray(i,r),t),s},u.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;let s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{const n=u.isBuffer(e)?e:u.from(e,r),a=n.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<i-t;++s)this[s+t]=n[s%a]}return this};const U={};function z(e,t,i){U[e]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function B(e){let t="",i=e.length;const r="-"===e[0]?1:0;for(;i>=r+4;i-=3)t=`_${e.slice(i-3,i)}${t}`;return`${e.slice(0,i)}${t}`}function F(e,t,i,r,s,n){if(e>i||e<t){const r="bigint"==typeof t?"n":"";let s;throw s=n>3?0===t||t===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(n+1)}${r}`:`>= -(2${r} ** ${8*(n+1)-1}${r}) and < 2 ** ${8*(n+1)-1}${r}`:`>= ${t}${r} and <= ${i}${r}`,new U.ERR_OUT_OF_RANGE("value",s,e)}!function(e,t,i){J(t,"offset"),void 0!==e[t]&&void 0!==e[t+i]||$(t,e.length-(i+1))}(r,s,n)}function J(e,t){if("number"!=typeof e)throw new U.ERR_INVALID_ARG_TYPE(t,"number",e)}function $(e,t,i){if(Math.floor(e)!==e)throw J(e,i),new U.ERR_OUT_OF_RANGE(i||"offset","an integer",e);if(t<0)throw new U.ERR_BUFFER_OUT_OF_BOUNDS;throw new U.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${t}`,e)}z("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),z("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),z("ERR_OUT_OF_RANGE",(function(e,t,i){let r=`The value of "${e}" is out of range.`,s=i;return Number.isInteger(i)&&Math.abs(i)>2**32?s=B(String(i)):"bigint"==typeof i&&(s=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(s=B(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r}),RangeError);const X=/[^+/0-9A-Za-z-_]/g;function V(e,t){let i;t=t||1/0;const r=e.length;let s=null;const n=[];for(let a=0;a<r;++a){if(i=e.charCodeAt(a),i>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(a+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&n.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;n.push(i)}else if(i<2048){if((t-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function G(e){return s.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(X,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,i,r){let s;for(s=0;s<r&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}function H(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Z(e){return e!=e}const K=function(){const e="0123456789abcdef",t=new Array(256);for(let i=0;i<16;++i){const r=16*i;for(let s=0;s<16;++s)t[r+s]=e[i]+e[s]}return t}();function Q(e){return"undefined"==typeof BigInt?ee:e}function ee(){throw new Error("BigInt not supported")}},924:(e,t,i)=>{"use strict";var r=i(210),s=i(559),n=s(r("String.prototype.indexOf"));e.exports=function(e,t){var i=r(e,!!t);return"function"==typeof i&&n(e,".prototype.")>-1?s(i):i}},559:(e,t,i)=>{"use strict";var r=i(612),s=i(210),n=s("%Function.prototype.apply%"),a=s("%Function.prototype.call%"),l=s("%Reflect.apply%",!0)||r.call(a,n),o=s("%Object.getOwnPropertyDescriptor%",!0),u=s("%Object.defineProperty%",!0),c=s("%Math.max%");if(u)try{u({},"a",{value:1})}catch(e){u=null}e.exports=function(e){var t=l(r,a,arguments);return o&&u&&o(t,"length").configurable&&u(t,"length",{value:1+c(0,e.length-(arguments.length-1))}),t};var p=function(){return l(r,n,arguments)};u?u(e.exports,"apply",{value:p}):e.exports.apply=p},108:(e,t,i)=>{var r=i(539),s=i(282);function n(){return(new Date).getTime()}var a,l=Array.prototype.slice,o={};a=void 0!==i.g&&i.g.console?i.g.console:"undefined"!=typeof window&&window.console?window.console:{};for(var u=[[function(){},"log"],[function(){a.log.apply(a,arguments)},"info"],[function(){a.log.apply(a,arguments)},"warn"],[function(){a.warn.apply(a,arguments)},"error"],[function(e){o[e]=n()},"time"],[function(e){var t=o[e];if(!t)throw new Error("No such label: "+e);delete o[e];var i=n()-t;a.log(e+": "+i+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=r.format.apply(null,arguments),a.error(e.stack)},"trace"],[function(e){a.log(r.inspect(e)+"\n")},"dir"],[function(e){if(!e){var t=l.call(arguments,1);s.ok(!1,r.format.apply(null,t))}},"assert"]],c=0;c<u.length;c++){var p=u[c],h=p[0],d=p[1];a[d]||(a[d]=h)}e.exports=a},289:(e,t,i)=>{"use strict";var r=i(215),s="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),n=Object.prototype.toString,a=Array.prototype.concat,l=Object.defineProperty,o=i(44)(),u=l&&o,c=function(e,t,i,r){if(t in e)if(!0===r){if(e[t]===i)return}else if("function"!=typeof(s=r)||"[object Function]"!==n.call(s)||!r())return;var s;u?l(e,t,{configurable:!0,enumerable:!1,value:i,writable:!0}):e[t]=i},p=function(e,t){var i=arguments.length>2?arguments[2]:{},n=r(t);s&&(n=a.call(n,Object.getOwnPropertySymbols(t)));for(var l=0;l<n.length;l+=1)c(e,n[l],t[n[l]],i[n[l]])};p.supportsDescriptors=!!u,e.exports=p},91:e=>{"use strict";function t(e,t){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var i=Object(e),r=1;r<arguments.length;r++){var s=arguments[r];if(null!=s)for(var n=Object.keys(Object(s)),a=0,l=n.length;a<l;a++){var o=n[a],u=Object.getOwnPropertyDescriptor(s,o);void 0!==u&&u.enumerable&&(i[o]=s[o])}}return i}e.exports={assign:t,polyfill:function(){Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:t})}}},29:(e,t,i)=>{"use strict";var r=i(320),s=Object.prototype.toString,n=Object.prototype.hasOwnProperty;e.exports=function(e,t,i){if(!r(t))throw new TypeError("iterator must be a function");var a;arguments.length>=3&&(a=i),"[object Array]"===s.call(e)?function(e,t,i){for(var r=0,s=e.length;r<s;r++)n.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,a):"string"==typeof e?function(e,t,i){for(var r=0,s=e.length;r<s;r++)null==i?t(e.charAt(r),r,e):t.call(i,e.charAt(r),r,e)}(e,t,a):function(e,t,i){for(var r in e)n.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,a)}},648:e=>{"use strict";var t=Array.prototype.slice,i=Object.prototype.toString;e.exports=function(e){var r=this;if("function"!=typeof r||"[object Function]"!==i.call(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var s,n=t.call(arguments,1),a=Math.max(0,r.length-n.length),l=[],o=0;o<a;o++)l.push("$"+o);if(s=Function("binder","return function ("+l.join(",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var i=r.apply(this,n.concat(t.call(arguments)));return Object(i)===i?i:this}return r.apply(e,n.concat(t.call(arguments)))})),r.prototype){var u=function(){};u.prototype=r.prototype,s.prototype=new u,u.prototype=null}return s}},612:(e,t,i)=>{"use strict";var r=i(648);e.exports=Function.prototype.bind||r},210:(e,t,i)=>{"use strict";var r,s=SyntaxError,n=Function,a=TypeError,l=function(e){try{return n('"use strict"; return ('+e+").constructor;")()}catch(e){}},o=Object.getOwnPropertyDescriptor;if(o)try{o({},"")}catch(e){o=null}var u=function(){throw new a},c=o?function(){try{return u}catch(e){try{return o(arguments,"callee").get}catch(e){return u}}}():u,p=i(405)(),h=i(185)(),d=Object.getPrototypeOf||(h?function(e){return e.__proto__}:null),f={},m="undefined"!=typeof Uint8Array&&d?d(Uint8Array):r,y={"%AggregateError%":"undefined"==typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":p&&d?d([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":f,"%AsyncGenerator%":f,"%AsyncGeneratorFunction%":f,"%AsyncIteratorPrototype%":f,"%Atomics%":"undefined"==typeof Atomics?r:Atomics,"%BigInt%":"undefined"==typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":n,"%GeneratorFunction%":f,"%Int8Array%":"undefined"==typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":p&&d?d(d([][Symbol.iterator]())):r,"%JSON%":"object"==typeof JSON?JSON:r,"%Map%":"undefined"==typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&p&&d?d((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?r:Promise,"%Proxy%":"undefined"==typeof Proxy?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&p&&d?d((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":p&&d?d(""[Symbol.iterator]()):r,"%Symbol%":p?Symbol:r,"%SyntaxError%":s,"%ThrowTypeError%":c,"%TypedArray%":m,"%TypeError%":a,"%Uint8Array%":"undefined"==typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?r:WeakSet};if(d)try{null.error}catch(e){var g=d(d(e));y["%Error.prototype%"]=g}var _=function e(t){var i;if("%AsyncFunction%"===t)i=l("async function () {}");else if("%GeneratorFunction%"===t)i=l("function* () {}");else if("%AsyncGeneratorFunction%"===t)i=l("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(i=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var s=e("%AsyncGenerator%");s&&d&&(i=d(s.prototype))}return y[t]=i,i},v={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},b=i(612),w=i(642),x=b.call(Function.call,Array.prototype.concat),O=b.call(Function.apply,Array.prototype.splice),k=b.call(Function.call,String.prototype.replace),j=b.call(Function.call,String.prototype.slice),S=b.call(Function.call,RegExp.prototype.exec),A=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,I=/\\(\\)?/g,D=function(e,t){var i,r=e;if(w(v,r)&&(r="%"+(i=v[r])[0]+"%"),w(y,r)){var n=y[r];if(n===f&&(n=_(r)),void 0===n&&!t)throw new a("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:i,name:r,value:n}}throw new s("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new a('"allowMissing" argument must be a boolean');if(null===S(/^%?[^%]*%?$/,e))throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(e){var t=j(e,0,1),i=j(e,-1);if("%"===t&&"%"!==i)throw new s("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==t)throw new s("invalid intrinsic syntax, expected opening `%`");var r=[];return k(e,A,(function(e,t,i,s){r[r.length]=i?k(s,I,"$1"):t||e})),r}(e),r=i.length>0?i[0]:"",n=D("%"+r+"%",t),l=n.name,u=n.value,c=!1,p=n.alias;p&&(r=p[0],O(i,x([0,1],p)));for(var h=1,d=!0;h<i.length;h+=1){var f=i[h],m=j(f,0,1),g=j(f,-1);if(('"'===m||"'"===m||"`"===m||'"'===g||"'"===g||"`"===g)&&m!==g)throw new s("property names with quotes must have matching quotes");if("constructor"!==f&&d||(c=!0),w(y,l="%"+(r+="."+f)+"%"))u=y[l];else if(null!=u){if(!(f in u)){if(!t)throw new a("base intrinsic for "+e+" exists, but the property is not available.");return}if(o&&h+1>=i.length){var _=o(u,f);u=(d=!!_)&&"get"in _&&!("originalValue"in _.get)?_.get:u[f]}else d=w(u,f),u=u[f];d&&!c&&(y[l]=u)}}return u}},296:(e,t,i)=>{"use strict";var r=i(210)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(e){r=null}e.exports=r},44:(e,t,i)=>{"use strict";var r=i(210)("%Object.defineProperty%",!0),s=function(){if(r)try{return r({},"a",{value:1}),!0}catch(e){return!1}return!1};s.hasArrayLengthDefineBug=function(){if(!s())return null;try{return 1!==r([],"length",{value:1}).length}catch(e){return!0}},e.exports=s},185:e=>{"use strict";var t={foo:{}},i=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!({__proto__:null}instanceof i)}},405:(e,t,i)=>{"use strict";var r="undefined"!=typeof Symbol&&Symbol,s=i(419);e.exports=function(){return"function"==typeof r&&"function"==typeof Symbol&&"symbol"==typeof r("foo")&&"symbol"==typeof Symbol("bar")&&s()}},419:e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(e,t);if(42!==s.value||!0!==s.enumerable)return!1}return!0}},410:(e,t,i)=>{"use strict";var r=i(419);e.exports=function(){return r()&&!!Symbol.toStringTag}},642:(e,t,i)=>{"use strict";var r=i(612);e.exports=r.call(Function.call,Object.prototype.hasOwnProperty)},645:(e,t)=>{t.read=function(e,t,i,r,s){var n,a,l=8*s-r-1,o=(1<<l)-1,u=o>>1,c=-7,p=i?s-1:0,h=i?-1:1,d=e[t+p];for(p+=h,n=d&(1<<-c)-1,d>>=-c,c+=l;c>0;n=256*n+e[t+p],p+=h,c-=8);for(a=n&(1<<-c)-1,n>>=-c,c+=r;c>0;a=256*a+e[t+p],p+=h,c-=8);if(0===n)n=1-u;else{if(n===o)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,r),n-=u}return(d?-1:1)*a*Math.pow(2,n-r)},t.write=function(e,t,i,r,s,n){var a,l,o,u=8*n-s-1,c=(1<<u)-1,p=c>>1,h=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:n-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,a=c):(a=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-a))<1&&(a--,o*=2),(t+=a+p>=1?h/o:h*Math.pow(2,1-p))*o>=2&&(a++,o/=2),a+p>=c?(l=0,a=c):a+p>=1?(l=(t*o-1)*Math.pow(2,s),a+=p):(l=t*Math.pow(2,p-1)*Math.pow(2,s),a=0));s>=8;e[i+d]=255&l,d+=f,l/=256,s-=8);for(a=a<<s|l,u+=s;u>0;e[i+d]=255&a,d+=f,a/=256,u-=8);e[i+d-f]|=128*m}},717:e=>{"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},584:(e,t,i)=>{"use strict";var r=i(410)(),s=i(924)("Object.prototype.toString"),n=function(e){return!(r&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===s(e)},a=function(e){return!!n(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==s(e)&&"[object Function]"===s(e.callee)},l=function(){return n(arguments)}();n.isLegacyArguments=a,e.exports=l?n:a},320:e=>{"use strict";var t,i,r=Function.prototype.toString,s="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof s&&"function"==typeof Object.defineProperty)try{t=Object.defineProperty({},"length",{get:function(){throw i}}),i={},s((function(){throw 42}),null,t)}catch(e){e!==i&&(s=null)}else s=null;var n=/^\s*class\b/,a=function(e){try{var t=r.call(e);return n.test(t)}catch(e){return!1}},l=function(e){try{return!a(e)&&(r.call(e),!0)}catch(e){return!1}},o=Object.prototype.toString,u="function"==typeof Symbol&&!!Symbol.toStringTag,c=!(0 in[,]),p=function(){return!1};if("object"==typeof document){var h=document.all;o.call(h)===o.call(document.all)&&(p=function(e){if((c||!e)&&(void 0===e||"object"==typeof e))try{var t=o.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}e.exports=s?function(e){if(p(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{s(e,null,t)}catch(e){if(e!==i)return!1}return!a(e)&&l(e)}:function(e){if(p(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(u)return l(e);if(a(e))return!1;var t=o.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&l(e)}},662:(e,t,i)=>{"use strict";var r,s=Object.prototype.toString,n=Function.prototype.toString,a=/^\s*(?:function)?\*/,l=i(410)(),o=Object.getPrototypeOf;e.exports=function(e){if("function"!=typeof e)return!1;if(a.test(n.call(e)))return!0;if(!l)return"[object GeneratorFunction]"===s.call(e);if(!o)return!1;if(void 0===r){var t=function(){if(!l)return!1;try{return Function("return function*() {}")()}catch(e){}}();r=!!t&&o(t)}return o(e)===r}},611:e=>{"use strict";e.exports=function(e){return e!=e}},360:(e,t,i)=>{"use strict";var r=i(559),s=i(289),n=i(611),a=i(415),l=i(194),o=r(a(),Number);s(o,{getPolyfill:a,implementation:n,shim:l}),e.exports=o},415:(e,t,i)=>{"use strict";var r=i(611);e.exports=function(){return Number.isNaN&&Number.isNaN(NaN)&&!Number.isNaN("a")?Number.isNaN:r}},194:(e,t,i)=>{"use strict";var r=i(289),s=i(415);e.exports=function(){var e=s();return r(Number,{isNaN:e},{isNaN:function(){return Number.isNaN!==e}}),e}},692:(e,t,i)=>{"use strict";var r=i(430);e.exports=function(e){return!!r(e)}},244:e=>{"use strict";var t=function(e){return e!=e};e.exports=function(e,i){return 0===e&&0===i?1/e==1/i:e===i||!(!t(e)||!t(i))}},609:(e,t,i)=>{"use strict";var r=i(289),s=i(559),n=i(244),a=i(624),l=i(281),o=s(a(),Object);r(o,{getPolyfill:a,implementation:n,shim:l}),e.exports=o},624:(e,t,i)=>{"use strict";var r=i(244);e.exports=function(){return"function"==typeof Object.is?Object.is:r}},281:(e,t,i)=>{"use strict";var r=i(624),s=i(289);e.exports=function(){var e=r();return s(Object,{is:e},{is:function(){return Object.is!==e}}),e}},987:(e,t,i)=>{"use strict";var r;if(!Object.keys){var s=Object.prototype.hasOwnProperty,n=Object.prototype.toString,a=i(414),l=Object.prototype.propertyIsEnumerable,o=!l.call({toString:null},"toString"),u=l.call((function(){}),"prototype"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],p=function(e){var t=e.constructor;return t&&t.prototype===e},h={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},d=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!h["$"+e]&&s.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{p(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();r=function(e){var t=null!==e&&"object"==typeof e,i="[object Function]"===n.call(e),r=a(e),l=t&&"[object String]"===n.call(e),h=[];if(!t&&!i&&!r)throw new TypeError("Object.keys called on a non-object");var f=u&&i;if(l&&e.length>0&&!s.call(e,0))for(var m=0;m<e.length;++m)h.push(String(m));if(r&&e.length>0)for(var y=0;y<e.length;++y)h.push(String(y));else for(var g in e)f&&"prototype"===g||!s.call(e,g)||h.push(String(g));if(o)for(var _=function(e){if("undefined"==typeof window||!d)return p(e);try{return p(e)}catch(e){return!1}}(e),v=0;v<c.length;++v)_&&"constructor"===c[v]||!s.call(e,c[v])||h.push(c[v]);return h}}e.exports=r},215:(e,t,i)=>{"use strict";var r=Array.prototype.slice,s=i(414),n=Object.keys,a=n?function(e){return n(e)}:i(987),l=Object.keys;a.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return s(e)?l(r.call(e)):l(e)})}else Object.keys=a;return Object.keys||a},e.exports=a},414:e=>{"use strict";var t=Object.prototype.toString;e.exports=function(e){var i=t.call(e),r="[object Arguments]"===i;return r||(r="[object Array]"!==i&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===t.call(e.callee)),r}},155:e=>{var t,i,r=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function a(e){if(t===setTimeout)return setTimeout(e,0);if((t===s||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(i){try{return t.call(null,e,0)}catch(i){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:s}catch(e){t=s}try{i="function"==typeof clearTimeout?clearTimeout:n}catch(e){i=n}}();var l,o=[],u=!1,c=-1;function p(){u&&l&&(u=!1,l.length?o=l.concat(o):c=-1,o.length&&h())}function h(){if(!u){var e=a(p);u=!0;for(var t=o.length;t;){for(l=o,o=[];++c<t;)l&&l[c].run();c=-1,t=o.length}l=null,u=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===n||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function f(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];o.push(new d(e,t)),1!==o.length||u||a(h)},d.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},384:e=>{e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},955:(e,t,i)=>{"use strict";var r=i(584),s=i(662),n=i(430),a=i(692);function l(e){return e.call.bind(e)}var o="undefined"!=typeof BigInt,u="undefined"!=typeof Symbol,c=l(Object.prototype.toString),p=l(Number.prototype.valueOf),h=l(String.prototype.valueOf),d=l(Boolean.prototype.valueOf);if(o)var f=l(BigInt.prototype.valueOf);if(u)var m=l(Symbol.prototype.valueOf);function y(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function g(e){return"[object Map]"===c(e)}function _(e){return"[object Set]"===c(e)}function v(e){return"[object WeakMap]"===c(e)}function b(e){return"[object WeakSet]"===c(e)}function w(e){return"[object ArrayBuffer]"===c(e)}function x(e){return"undefined"!=typeof ArrayBuffer&&(w.working?w(e):e instanceof ArrayBuffer)}function O(e){return"[object DataView]"===c(e)}function k(e){return"undefined"!=typeof DataView&&(O.working?O(e):e instanceof DataView)}t.isArgumentsObject=r,t.isGeneratorFunction=s,t.isTypedArray=a,t.isPromise=function(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch},t.isArrayBufferView=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):a(e)||k(e)},t.isUint8Array=function(e){return"Uint8Array"===n(e)},t.isUint8ClampedArray=function(e){return"Uint8ClampedArray"===n(e)},t.isUint16Array=function(e){return"Uint16Array"===n(e)},t.isUint32Array=function(e){return"Uint32Array"===n(e)},t.isInt8Array=function(e){return"Int8Array"===n(e)},t.isInt16Array=function(e){return"Int16Array"===n(e)},t.isInt32Array=function(e){return"Int32Array"===n(e)},t.isFloat32Array=function(e){return"Float32Array"===n(e)},t.isFloat64Array=function(e){return"Float64Array"===n(e)},t.isBigInt64Array=function(e){return"BigInt64Array"===n(e)},t.isBigUint64Array=function(e){return"BigUint64Array"===n(e)},g.working="undefined"!=typeof Map&&g(new Map),t.isMap=function(e){return"undefined"!=typeof Map&&(g.working?g(e):e instanceof Map)},_.working="undefined"!=typeof Set&&_(new Set),t.isSet=function(e){return"undefined"!=typeof Set&&(_.working?_(e):e instanceof Set)},v.working="undefined"!=typeof WeakMap&&v(new WeakMap),t.isWeakMap=function(e){return"undefined"!=typeof WeakMap&&(v.working?v(e):e instanceof WeakMap)},b.working="undefined"!=typeof WeakSet&&b(new WeakSet),t.isWeakSet=function(e){return b(e)},w.working="undefined"!=typeof ArrayBuffer&&w(new ArrayBuffer),t.isArrayBuffer=x,O.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&O(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=k;var j="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function S(e){return"[object SharedArrayBuffer]"===c(e)}function A(e){return void 0!==j&&(void 0===S.working&&(S.working=S(new j)),S.working?S(e):e instanceof j)}function I(e){return y(e,p)}function D(e){return y(e,h)}function C(e){return y(e,d)}function E(e){return o&&y(e,f)}function R(e){return u&&y(e,m)}t.isSharedArrayBuffer=A,t.isAsyncFunction=function(e){return"[object AsyncFunction]"===c(e)},t.isMapIterator=function(e){return"[object Map Iterator]"===c(e)},t.isSetIterator=function(e){return"[object Set Iterator]"===c(e)},t.isGeneratorObject=function(e){return"[object Generator]"===c(e)},t.isWebAssemblyCompiledModule=function(e){return"[object WebAssembly.Module]"===c(e)},t.isNumberObject=I,t.isStringObject=D,t.isBooleanObject=C,t.isBigIntObject=E,t.isSymbolObject=R,t.isBoxedPrimitive=function(e){return I(e)||D(e)||C(e)||E(e)||R(e)},t.isAnyArrayBuffer=function(e){return"undefined"!=typeof Uint8Array&&(x(e)||A(e))},["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},539:(e,t,i)=>{var r=i(155),s=i(108),n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++)i[t[r]]=Object.getOwnPropertyDescriptor(e,t[r]);return i},a=/%[sdj%]/g;t.format=function(e){if(!b(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(c(arguments[i]));return t.join(" ")}i=1;for(var r=arguments,s=r.length,n=String(e).replace(a,(function(e){if("%%"===e)return"%";if(i>=s)return e;switch(e){case"%s":return String(r[i++]);case"%d":return Number(r[i++]);case"%j":try{return JSON.stringify(r[i++])}catch(e){return"[Circular]"}default:return e}})),l=r[i];i<s;l=r[++i])_(l)||!O(l)?n+=" "+l:n+=" "+c(l);return n},t.deprecate=function(e,i){if(void 0!==r&&!0===r.noDeprecation)return e;if(void 0===r)return function(){return t.deprecate(e,i).apply(this,arguments)};var n=!1;return function(){if(!n){if(r.throwDeprecation)throw new Error(i);r.traceDeprecation?s.trace(i):s.error(i),n=!0}return e.apply(this,arguments)}};var l={},o=/^$/;if(r.env.NODE_DEBUG){var u=r.env.NODE_DEBUG;u=u.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+u+"$","i")}function c(e,i){var r={seen:[],stylize:h};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),g(i)?r.showHidden=i:i&&t._extend(r,i),w(r.showHidden)&&(r.showHidden=!1),w(r.depth)&&(r.depth=2),w(r.colors)&&(r.colors=!1),w(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=p),d(r,e,r.depth)}function p(e,t){var i=c.styles[t];return i?"["+c.colors[i][0]+"m"+e+"["+c.colors[i][1]+"m":e}function h(e,t){return e}function d(e,i,r){if(e.customInspect&&i&&S(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(r,e);return b(s)||(s=d(e,s,r)),s}var n=function(e,t){if(w(t))return e.stylize("undefined","undefined");if(b(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return v(t)?e.stylize(""+t,"number"):g(t)?e.stylize(""+t,"boolean"):_(t)?e.stylize("null","null"):void 0}(e,i);if(n)return n;var a=Object.keys(i),l=function(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}(a);if(e.showHidden&&(a=Object.getOwnPropertyNames(i)),j(i)&&(a.indexOf("message")>=0||a.indexOf("description")>=0))return f(i);if(0===a.length){if(S(i)){var o=i.name?": "+i.name:"";return e.stylize("[Function"+o+"]","special")}if(x(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(k(i))return e.stylize(Date.prototype.toString.call(i),"date");if(j(i))return f(i)}var u,c="",p=!1,h=["{","}"];return y(i)&&(p=!0,h=["[","]"]),S(i)&&(c=" [Function"+(i.name?": "+i.name:"")+"]"),x(i)&&(c=" "+RegExp.prototype.toString.call(i)),k(i)&&(c=" "+Date.prototype.toUTCString.call(i)),j(i)&&(c=" "+f(i)),0!==a.length||p&&0!=i.length?r<0?x(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),u=p?function(e,t,i,r,s){for(var n=[],a=0,l=t.length;a<l;++a)C(t,String(a))?n.push(m(e,t,i,r,String(a),!0)):n.push("");return s.forEach((function(s){s.match(/^\d+$/)||n.push(m(e,t,i,r,s,!0))})),n}(e,i,r,l,a):a.map((function(t){return m(e,i,r,l,t,p)})),e.seen.pop(),function(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]}(u,c,h)):h[0]+c+h[1]}function f(e){return"["+Error.prototype.toString.call(e)+"]"}function m(e,t,i,r,s,n){var a,l,o;if((o=Object.getOwnPropertyDescriptor(t,s)||{value:t[s]}).get?l=o.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):o.set&&(l=e.stylize("[Setter]","special")),C(r,s)||(a="["+s+"]"),l||(e.seen.indexOf(o.value)<0?(l=_(i)?d(e,o.value,null):d(e,o.value,i-1)).indexOf("\n")>-1&&(l=n?l.split("\n").map((function(e){return"  "+e})).join("\n").slice(2):"\n"+l.split("\n").map((function(e){return"   "+e})).join("\n")):l=e.stylize("[Circular]","special")),w(a)){if(n&&s.match(/^\d+$/))return l;(a=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.slice(1,-1),a=e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=e.stylize(a,"string"))}return a+": "+l}function y(e){return Array.isArray(e)}function g(e){return"boolean"==typeof e}function _(e){return null===e}function v(e){return"number"==typeof e}function b(e){return"string"==typeof e}function w(e){return void 0===e}function x(e){return O(e)&&"[object RegExp]"===A(e)}function O(e){return"object"==typeof e&&null!==e}function k(e){return O(e)&&"[object Date]"===A(e)}function j(e){return O(e)&&("[object Error]"===A(e)||e instanceof Error)}function S(e){return"function"==typeof e}function A(e){return Object.prototype.toString.call(e)}function I(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(e=e.toUpperCase(),!l[e])if(o.test(e)){var i=r.pid;l[e]=function(){var r=t.format.apply(t,arguments);s.error("%s %d: %s",e,i,r)}}else l[e]=function(){};return l[e]},t.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=i(955),t.isArray=y,t.isBoolean=g,t.isNull=_,t.isNullOrUndefined=function(e){return null==e},t.isNumber=v,t.isString=b,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=w,t.isRegExp=x,t.types.isRegExp=x,t.isObject=O,t.isDate=k,t.types.isDate=k,t.isError=j,t.types.isNativeError=j,t.isFunction=S,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=i(384);var D=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function C(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){var e,i;s.log("%s - %s",(i=[I((e=new Date).getHours()),I(e.getMinutes()),I(e.getSeconds())].join(":"),[e.getDate(),D[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=i(717),t._extend=function(e,t){if(!t||!O(t))return e;for(var i=Object.keys(t),r=i.length;r--;)e[i[r]]=t[i[r]];return e};var E="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function R(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(E&&e[E]){var t;if("function"!=typeof(t=e[E]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,E,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,r=new Promise((function(e,r){t=e,i=r})),s=[],n=0;n<arguments.length;n++)s.push(arguments[n]);s.push((function(e,r){e?i(e):t(r)}));try{e.apply(this,s)}catch(e){i(e)}return r}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),E&&Object.defineProperty(t,E,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},t.promisify.custom=E,t.callbackify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);var s=t.pop();if("function"!=typeof s)throw new TypeError("The last argument must be of type Function");var n=this,a=function(){return s.apply(n,arguments)};e.apply(this,t).then((function(e){r.nextTick(a.bind(null,null,e))}),(function(e){r.nextTick(R.bind(null,e,a))}))}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,n(e)),t}},430:(e,t,i)=>{"use strict";var r=i(29),s=i(83),n=i(559),a=i(924),l=i(296),o=a("Object.prototype.toString"),u=i(410)(),c="undefined"==typeof globalThis?i.g:globalThis,p=s(),h=a("String.prototype.slice"),d=Object.getPrototypeOf,f=a("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},m={__proto__:null};r(p,u&&l&&d?function(e){var t=new c[e];if(Symbol.toStringTag in t){var i=d(t),r=l(i,Symbol.toStringTag);if(!r){var s=d(i);r=l(s,Symbol.toStringTag)}m["$"+e]=n(r.get)}}:function(e){var t=new c[e];m["$"+e]=n(t.slice)}),e.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!u){var t=h(o(e),8,-1);return f(p,t)>-1?t:"Object"===t&&function(e){var t=!1;return r(m,(function(i,r){if(!t)try{i(e),t=h(r,1)}catch(e){}})),t}(e)}return l?function(e){var t=!1;return r(m,(function(i,r){if(!t)try{"$"+i(e)===r&&(t=h(r,1))}catch(e){}})),t}(e):null}},83:(e,t,i)=>{"use strict";var r=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],s="undefined"==typeof globalThis?i.g:globalThis;e.exports=function(){for(var e=[],t=0;t<r.length;t++)"function"==typeof s[r[t]]&&(e[e.length]=r[t]);return e}}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,i),n.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{"use strict";let e=e=>crypto.getRandomValues(new Uint8Array(e));var t,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,v,b,w,x,O,k,j,S,A,I,D=i(155),C=i(108),E=i(764).lW,R=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(l in s=JSON.parse(SECRETS_SERVER))r[l]=s[l]}catch(e){}null==r&&(r={}),null==r.name&&(r.name="OA.Works"),null==r.kv&&(r.kv="oaworks"),null==r.version&&(r.version="6.1.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0);try{D.env.name&&D.env.name.endsWith("_async")&&(r.async=!0)}catch(e){}try{D.env.name&&D.env.name.endsWith("_loop")&&(r.async_loop=!0)}catch(e){}try{D.env.name&&D.env.name.endsWith("_schedule")&&(r.async_schedule=!0)}catch(e){}null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.formats&&(r.formats=["html","csv","json"]),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(e){return!1!==r.pass&&e.passThroughOnException(),e.respondWith(t.call(e))}))}catch(e){}a={},n={},t=async function(){var e,s,a,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke;this.started=Date.now();try{null==(o=r.headers)[E="x-"+r.name.toLowerCase()]&&(o[E]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(u=this.S).cache&&(u.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),i.g[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(T="",b=0,j=(z=this.request.url.split("?")[1].split("&")).length;b<j;b++)if((x=(U=z[b]).split("="))[0].length){if(1===x.length&&T&&(x[0].startsWith(" ")||x[0].includes("%")))this.params[T]+="&"+decodeURIComponent(x[0]);else{if(this.params[x[0]]=1===x.length||"string"==typeof x[1]&&"true"===x[1].toLowerCase()||("string"!=typeof x[1]||"false"!==x[1].toLowerCase())&&(!!U.endsWith("=")||x[1]),"string"!=typeof this.params[x[0]]||0!==this.params[x[0]].replace(/[0-9]/g,"").length||"0"!==this.params[x[0]]&&this.params[x[0]].startsWith("0")||(O=parseInt(this.params[x[0]]),isNaN(O)||(this.params[x[0]]=O)),"string"==typeof this.params[x[0]]&&this.params[x[0]].includes("%"))try{this.params[x[0]]=decodeURIComponent(this.params[x[0]])}catch(e){}if("string"==typeof this.params[x[0]]&&(this.params[x[0]].startsWith("[")||this.params[x[0]].startsWith("{")))try{this.params[x[0]]=JSON.parse(this.params[x[0]])}catch(e){}}T=x[0]}this.headers={};try{for(B=[...this.request.headers],w=0,S=B.length;w<S;w++)_=B[w],this.headers[_[0].toLowerCase()]=_[1]}catch(e){try{for(v in this.request.headers)this.headers[v.toLowerCase()]=this.request.headers[v]}catch(e){}}if(null==(c=this.headers).ip&&(c.ip=null!=(Q=this.headers["x-real-ip"])?Q:this.headers["x-forwarded-for"]),f=null!=(ce=this.headers["content-type"])?ce:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(f.includes("/json"))this.body=await this.request.json();else if(f.includes("form")){for(y in h={},(await this.request.formData()).entries())y[0]&&(null!=h[y[0]]?(Array.isArray(h[y[0]])||(h[y[0]]=[h[y[0]]]),h[y[0]].push(y[1])):h[y[0]]=y[1]);null!=h&&"{}"!==JSON.stringify(h)&&(this.body=h)}if(null==this.body&&("POST"===(fe=this.request.method)||"PUT"===fe||"DELETE"===fe)){try{h=await this.request.text()}catch(e){}h&&(this.body=h)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(e){}if("object"==typeof this.body&&!Array.isArray(this.body))for(U in this.body)U&&null==(p=this.params)[U]&&(p[U]=this.body[U]);try{this.cookie=null!=(me=this.headers.Cookie)?me:this.headers.cookie}catch(e){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(e){}null==this.rid&&(this.rid=t.uid());try{this.apikey=null!=(ye=null!=(ge=this.headers["x-apikey"])?ge:this.headers.apikey)?ye:this.params.apikey}catch(e){}for(k=0,A=(_e=["x-apikey","apikey"]).length;k<A;k++)xe=_e[k],null!=this.headers[xe]&&delete this.headers[xe],null!=this.params[xe]&&delete this.params[xe];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(e){}this.parts=(null!=m?m:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(e){}this.parts=this.url.length?(null!=m?m:this.url).split("/"):[];try{this.base=this.headers.host}catch(e){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(L=this.parts[this.parts.length-1].split(".").pop().toLowerCase(),R.call(this.S.formats,L)>=0&&(this.format=L,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+L,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(ve=this.parts[0],R.call(this.S.pass,ve)>=0))throw new Error;if(Oe="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[Oe]===this.S.system&&(delete this.headers[Oe],this.system=!0),this._logs=[],this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(F=this.request.method)||"OPTIONS"===F?t._response.call(this,""):t._response.call(this,{name:null!=(J=this.S.name)?J:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=($=null!=(X=this.user)?X.email:void 0)?$:void 0});for(g=void 0,M=[...this.parts],P=void 0,W=[],e=async(i,r,s,a,o)=>{var u,c,p,h,d,f,m,y,_,v,b,w,x,O,k,j,S,A;if(P&&this.fn.startsWith(s))for(;M.length&&null==i[M[0]];)this.params[P]=(this.params[P]?this.params[P]+"/":"")+M.shift(),R.call(W,P)<0&&W.push(P);for(l in j=[],i)if("function"!=(x=typeof i[l])&&"object"!==x)j.push(r[l]=i[l]);else if(null!=i[l]){if(b=s+(s?".":"")+l,"object"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._sheet||i[l]._kv||i[l]._bg){if(null==(p=i[l])._auth&&(p._auth=null!=(h=i[l])._auths?h._auths:h._auths=a),Array.isArray(i[l]._auths)&&0===i[l]._auths.length&&(i[l]._auths=b.split(".")),Array.isArray(i[l]._auth)&&0===i[l]._auth.length&&(i[l]._auth=b.split(".")),null==(d=i[l])._cache&&(d._cache=null!=(f=i[l])._caches?f._caches:f._caches=o),b.startsWith("auth")&&null==(m=i[l])._cache&&(m._cache=!1),i[l]._sheet&&null==(y=i[l])._index&&(y._index=!0),i[l]._index)for(w=0,v=(O=["keys","terms","suggest","count","percent","min","max","range","sum","average","mapping","_for","_each","_bulk","_refresh"]).length;w<v;w++)_=O[w],null==(u=i[l])[_]&&(u[_]={_indexed:_,_auth:_.startsWith("_")?"system":i[l]._auth});for(A in"function"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._kv||i[l]._bg||b.includes(".")&&!s.startsWith("index")&&!b.split(".").pop().startsWith("_")?r[l]=t._wrapper(i[l],b).bind(this):r[l]=i[l].bind(this),i[l])A.startsWith("_")&&(r[l][A]=i[l][A])}else r[l]=JSON.parse(JSON.stringify(i[l]));null==(c=r[l])._name&&(c._name=b),r[l]._schedule&&!n[b]&&!0===this.S.bg&&!1!==this.S.cron&&(C.log("Adding schedule",r[l]._schedule,b),n[b]={schedule:r[l]._schedule,fn:r[l]},S=e=>async()=>{var t,i,r,s,a,l,o,u,c;if(s=n[e].fn,t=null!=(a=this.S.async_runner)?a[null!=(l=s._runner)?l:e]:void 0,!(!0===this.S.dev||this.S.async||this.S.async_loop||this.S.async_schedule||null==D.env.pm_id||1===(o=D.env.pm_id)||"1"===o))return C.log("NOT running scheduled task because not on dev and process pid is not 1",e,this.datetime());if("string"!=typeof t&&!this.S.async_schedule&&"string"==typeof this.S.async)return C.log("NOT running scheduled task because not on the available async process",e,this.datetime());if(!("string"==typeof t||"string"!=typeof this.S.async_schedule||"loop"===s._schedule&&this.S.async_loop))return C.log("NOT running scheduled task because not on the available async scheduled process",e,this.datetime());if("string"!=typeof t&&"string"==typeof this.S.async_loop&&"loop"===s._schedule)return C.log("NOT running scheduled looped task because not on the available loop process",e,this.datetime());if("string"==typeof t&&D.env.name&&!D.env.name.endsWith((null!=(u=s._runner)?u:e).replace(/\./g,"_").replace("__","_")))return C.log("NOT running scheduled task because not on the specified process runner",null!=(c=s._runner)?c:e,this.datetime());C.log("scheduled task",e,this.datetime()),n[e].last=await this.datetime(),delete n[e].error;try{i=s._sheet?await this._loadsheet(n[e].fn,s._name.replace(/\./g,"_")):await n[e].fn(s._args);try{n[e].result=JSON.stringify(i).substr(0,200)}catch(e){}if(n[e].success=!0,C.log("scheduled task result",i),"loop"===s._schedule)return C.log("Schedule looping",e),(await S(e))()}catch(t){r=t,n[e].success=!1;try{return n[e].error=JSON.stringify(r)}catch(e){}}},"loop"===(k=r[l]._schedule)||"startup"===k?(C.log("Starting scheduled",r[l]._schedule,b),(await S(b))()):cron.schedule(r[l]._schedule,S(b))),l.startsWith("_")||(M.length&&M[0]===l&&this.fn.startsWith(s)&&(P=M.shift(),this.fn+=(""===this.fn?"":".")+P,"function"!=typeof r[l]||s.includes("._")||(g=r[l])),"function"==typeof r[l]&&1===b.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(b.replace(/\./g,"/"))),Array.isArray(i[l])||l.startsWith("_")&&"function"!=typeof r[l]||"fn"===l?j.push(void 0):j.push(e(i[l],r[l],b,null!=a?a:i[l]._auths,null!=o?o:i[l]._caches))}else j.push(void 0);return j},e(t,this,""),P&&M.length&&(this.params[P]=this.params[P]?this.params[P]+"/"+M.join("/"):M.join("/")),N=0,I=W.length;N<I;N++)d=W[N],"true"===this.params[d].toLowerCase()&&(this.params[d]=!0),"false"===this.params[d].toLowerCase()&&(this.params[d]=!1),"string"!=typeof this.params[d]||0!==this.params[d].replace(/[0-9]/g,"").length||this.params[d].startsWith("0")||(q=parseInt(this.params[d]),isNaN(q)||(this.params[d]=q));if(this.S.dev&&!0===this.S.bg&&C.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(V=typeof g)||"function"===V)&&g._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("object"!=(G=typeof g)&&"function"!==G||!(g._async||"all"===this.params.size&&g._index&&!(null!=(Y=D.env.name)?Y:"").endsWith("_makecsv"))||"string"!=typeof this.S.async||"string"==typeof(null!=(H=this.S.async_runner)?H[null!=(Z=g._runner)?Z:this.fn]:void 0)&&D.env.name&&D.env.name.endsWith((null!=(K=g._runner)?K:this.fn).replace(/\./g,"_"))?"function"==typeof g&&("object"==typeof(a="auth"===this.fn?void 0:await this.auth())&&a._id&&a.email&&(this.user=a),(a="function"==typeof g._auth?await g._auth():!0===g._auth&&null!=this.user||!g._auth||await this.auth.role(g._auth))||this.system?"HEAD"===(se=this.request.method)||"OPTIONS"===se?be="":!1!==g._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(be=await this.cache())?(this.cached="cache",(be=new Response(be.body,be)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),be.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(be=await g(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(be={status:401}).body=await this.auth(!1))):(s="all"===this.params.size&&g._index&&(null!=(ee=this.S.async_runner)?ee._makecsv:void 0)?this.S.async_runner._makecsv:null!=(te=null!=(ie=this.S.async_runner)?ie[null!=(re=g._runner)?re:this.fn]:void 0)?te:this.S.async,C.log("Fetching from async process",s,this.request.url),be=await this.fetch(s+this.request.url,{method:this.request.method,headers:this.headers,body:this.request.body}),delete this.format),(null==be||"object"==typeof be&&404===be.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(be=""),we="object"!=typeof be||Array.isArray(be)||"function"!=typeof(null!=(ne=be.headers)?ne.append:void 0)?await this._response(be,g):be,this.parts.length&&"log"!==(ae=this.parts[0])&&"status"!==ae&&(!this.system||"kv"!==(le=this.parts[0])&&"index"!==le)&&"HEAD"!==(oe=this.request.method)&&"OPTIONS"!==oe&&null!=be&&""!==be&&(!this.completed||!1===g._cache||200!==we.status||"object"==typeof be&&!Array.isArray(be)&&0===(null!=(ue=be.hits)?ue.total:void 0)||"number"==typeof be&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(ke=g._cache)||"object"!=typeof be||Array.isArray(be)||null==(null!=(pe=be.hits)?pe.hits:void 0)||(ke=60),this.cache(void 0,we,ke)),"object"!=(he=typeof g)&&"function"!==he||!1===g._log||this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(de=this.request.method)||"OPTIONS"===de)return we;throw new Error},t._response=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k;if(null==(s=this.S).headers&&(s.headers={}),null==e)e=404,O=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(l in e.headers)this.S.headers[l]=e.headers[l];delete e.headers}O=null!=(g=e.status)?g:200,delete e.status,0===(h=this.keys(e)).length?e=O:1===h.length&&(e=e[h[0]])}else O=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&(_=this.format,R.call(this.S.formats,_)>=0)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}if("string"==typeof e&&"html"===this.format&&!(e=e.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(w='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',w+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',e.includes("<title")?([y,k]=e.split("<title"),[k,r]=k.split("</title>"),w+="<title"+k+"</title>\n",e=y+r):e.includes('id="title"')&&(w+="<title>"+e.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),c=0,d=(v=["<meta ","<link "]).length;c<d;c++)if(o=v[c],e.includes(o))for(p=0,f=(b=e.split(o)).length;p<f;p++)x=o+b[p].split(">")[0],e=e.replace(x,""),w+=x+"\n";e.includes("<head>")&&([m,u]=e.split("<head>"),[u,i]=u.split("</head>"),w+=u,e=m+i),w.includes("icon")||(w+='<link rel="icon" href="data:,">'),w+="\n</head>\n",w+=e.includes("<body")?e:"\n<body>\n"+e+"\n</body>\n",e=w+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(n=this.S.headers)["Content-Type"]&&(n["Content-Type"]="application/json; charset=UTF-8")}try{null==(a=this.S.headers)["Content-Length"]&&(a["Content-Length"]=E.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(e){}try{return!0===this.S.bg?{status:O,headers:this.S.headers,body:e}:new Response(e,{status:O,headers:this.S.headers})}catch(t){return{status:O,headers:this.S.headers,body:e}}},t._loadsheet=async function(e,t){var i,r,s,n,a,l;if(e._sheet.startsWith("http")&&e._sheet.includes("csv")?a=await this.convert.csv2json(e._sheet):e._sheet.startsWith("http")&&e._sheet.includes("json")?(a=await this.fetch(e._sheet))&&!Array.isArray(a)&&(a=[a]):a=await this.src.google.sheets(e._sheet),Array.isArray(a)&&a.length){if("function"==typeof e._format&&(a=await e._format.apply(this,[a])),e._key)for(i=0,r=a.length;i<r;i++)null==(l=a[i])._id&&(l._id=(null!=(s=l[e._key])?s:this.uid()).replace(/\//g,"_").toLowerCase());return await this.index(t,""),await this.index(t,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(n=e._index.mappings)?n:e._index.mapping,aliases:e._index.aliases}),await this.index(t,a),a.length}return 0},t._wrapper=function(e,t){return async function(){var i,r,s,n,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye;if(fe=Date.now(),de=t.replace(/\./g,"_"),j={fn:t},e._limit)for(S=await this.kv("limit/"+t);S;)null==j.limited&&(j.limited=0),j.limited+=S,await this.sleep(S-fe),S=await this.kv("limit/"+t);if("string"==(U=typeof this.params._async)||"number"===U)if(he=await this.kv("async/"+this.params._async,"")){if("string"==typeof he&&he.includes("/")&&!he.includes(" ")&&!he.includes(":")&&!he.startsWith("10.")&&2===he.split("/").length){try{e._kv&&(he=await this.kv(he))}catch(e){}try{null==he&&e._index&&(he=await this.index(he))}catch(e){}}try{"string"==typeof he&&(he.startsWith("{")||he.startsWith("["))&&(he=JSON.parse(he))}catch(e){}}else he={_async:this.params._async};else if(this.fn===t&&e._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)he={status:302},e._sheet.startsWith("http")?he.body=e._sheet:"json"===this.format?he.body="https://sheets.googleapis.com/v4/spreadsheets/"+e._sheet.split("/")[0]+"/values/"+(null!=(z=null!=(K=e._sheetid)?K:e._sheet.split("/")[1])?z:"Sheet1")+"?alt=json":he.body="https://docs.google.com/spreadsheets/d/"+e._sheet.split("/")[0],he.headers={Location:he.body};else if(e._indexed)(n=[...arguments]).unshift(de.replace("_"+e._indexed,"")),he=await this.index[e._indexed](...n);else if((e._index||e._kv)&&(!e._sheet||this.fn!==t||!this.refresh)){if(this.fn===t?(this.fn.replace(/\./g,"/")!==this.route&&(j.key=this.route.split(t.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!j.key&&e._index&&(W=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\*~\?="]/g,"").length&&(j.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(j.key=arguments[0].toString()),e._index&&!j.key&&(W=await this.index.translate(arguments[0],arguments[1])),M=null!=W?void 0:j.key?arguments[1]:e._index?arguments[0]:void 0),"object"==typeof M)if(Array.isArray(M)){if(M.length)for(y=0,b=M.length;y<b;y++)null==(c=M[y])._id&&(c._id=(null!=(le=c[e._key])?le:this.uid()).replace(/\//g,"_").toLowerCase())}else null==M._id&&(M._id=(null!=(ne=null!=(ae=j.key)?ae:M[e._key])?ne:this.uid()).replace(/\//g,"_").toLowerCase()),null==j.key&&(j.key=M._id.replace(/\//g,"_").toLowerCase());if((null!=M||!this.refresh||"function"!=typeof e)&&(e._kv&&j.key&&null!=(he=await this.kv(de+"/"+j.key,M))&&null==M&&(j.cached="kv"),e._index)){if("all"===this.params.size){if(!0!==this.S.bg){if("string"==typeof this.S.bg)throw new Error;he={status:404}}if(A=null!=(oe=null!=(ue=this.params.email)?ue:this.params.notify)?oe:null!=(ce=this.user)?ce.email:void 0,this.params.orgkey&&(L=this.params.orgkey,delete this.params.orgkey),E=null!=(pe=this.params.funders)?pe:this.params.flatten,s=null!=(B=this.params.authorships)?B:this.params.flatten,delete W.orgkey,delete W.funders,delete W.authorships,delete W.flatten,delete W.email,delete this.params.size,delete W.size,(ye=await this.index.count(de,W))>3e6||!(null!=(F=this.S.static)?F.folder:void 0))he={status:401};else{m=(this.fn?this.fn.replace(/\./g,"_"):"")+"_"+this.uid(),p=this.S.static.url+"/export/"+m+".csv",ye>1e5&&await this.mail({to:null!=(J=null!=($=this.S.log)?$.notify:void 0)?J:"mark+notifications@oa.works",text:"Someone is creating a large csv of size "+ye+"\n\n"+p}),C=this.S.static.folder+"/export";try{(d=(await fs.readdir(C)).length)>900&&d%20==0&&this.mail({to:null!=(X=null!=(V=this.S.log)?V.notify:void 0)?X:"mark+notifications@oa.works",text:"Warning, export file count is "+d+" they will be deleted at 1000"})}catch(e){await fs.mkdir(C),d=0}try{if(d>999){for(G=await fs.readdir(C),g=0,w=G.length;g<w;g++)f=G[g],await fs.unlink(C+"/"+f);this.mail({to:null!=(Y=null!=(H=this.S.log)?H.notify:void 0)?Y:"mark+notifications@oa.works",text:"Export files had reached 1000 so have been deleted "})}}catch(e){}if(d>1e3)he={status:401};else{if(C+="/"+m+".csv",await fs.appendFile(C,""),null!=this.params.includes&&(this.params.include=this.params.includes,delete this.params.includes),null!=this.params.excludes&&(this.params.exclude=this.params.excludes,delete this.params.excludes),null!=this.params.include)_="string"==typeof this.params.include?this.params.include.split(","):this.params.include,L&&("string"!=typeof this.params.include||this.params.include.includes("orgs")?Array.isArray(this.params.include)&&R.call(this.params.include,"orgs")<0&&this.params.include.push("orgs"):this.params.include+=",orgs",R.call(W._source.includes,"orgs")<0&&W._source.includes.push("orgs"));else for(_=[],v=0,x=(Z=await this.index.keys(de)).length;v<x;v++)me=Z[v].split(".")[0],R.call(_,me)<0&&"_id"!==me&&_.push(me);if(null!=this.params.exclude){for(I=0,O=(Q="string"==typeof this.params.exclude?this.params.exclude.split(","):this.params.exclude).length;I<O;I++)h=Q[I],-1===(N=_.indexOf(h))||L&&"orgs"===h||(_=_.splice(N,1));L&&-1!==(D=W._source.excludes.indexOf("orgs"))&&(W._source.excludes=W._source.excludes.splice(D,1))}A&&await this.mail({to:A,subject:"Your export has started (ref: "+m+".csv)",text:'Your export has started. You can download the file any time, it will keep growing until it is complete, when you will get another notification.<br><br><a href="'+p+'">Download CSV</a><br><br>Thanks'}),r=async(e,t,i,r,s,n,a,o,u)=>{var c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se;if(x=!0,null!=u&&(me=await this.encrypt(u),V=await this.report.orgs.orgkeys('key.keyword:"'+me+'"',1)),a||o){if(r=["DOI"],a)for(G=0,W=(Y=["funder.name","funder.award"]).length;G<W;G++)b=Y[G],r.push(b);if(o)for(ye=0,M=(H=["authorships.institutions.display_name","authorships.institutions.ror","authorships.author.orcid","authorships.author.raw_affiliation_string"]).length;ye<M;ye++)b=H[ye],r.push(b)}for(ve=0,U=r.length;ve<U;ve++)D=r[ve],await fs.appendFile(i,(x?'"':',"')+D.replace("supplements.","")+'"'),x=!1;for(_e=1e5,be=0,z=(Z=["@oa.works","pcastromartin@","wbschmal@","mailparser.io"]).length;be<z;be++)c=Z[be],s&&s.includes(c)&&(_e=3e6);for await(g of this.index._for(e,t,{scroll:"30m",max:_e}))if(await fs.appendFile(i,"\n"),a||o){if(J="",d="",S="",de="",X="",p="",null!=g.funder&&a)for(x=!0,Oe=0,B=(K=g.funder).length;Oe<B;Oe++)J+=(x?"":";")+(null!=(Q=(O=K[Oe]).name)?Q:"").replace(/"/g,""),null!=O.award&&O.award.length&&(O.award=O.award.join(" ")),null==O.award&&(O.award=""),Array.isArray(O.award)&&(O.award.length?O.award=O.award.join(" "):O.award=""),O.award=O.award.replace(/;/g,""),d+=(x?"":";")+O.award,x=!1;if(null!=g.authorships&&o)for(x=!0,ke=0,F=(ee=g.authorships).length;ke<F;ke++){if(x||(S+=";",de+=";"),x=!1,null!=(h=ee[ke]).institutions)for(w=!0,je=0,E=(te=h.institutions).length;je<E;je++)S+=(w?"":",")+(null!=(ie=(j=te[je]).display_name)?ie:"").replace(/"/g,""),de+=(w?"":",")+(null!=(re=j.ror)?re:""),w=!1;(null!=(se=h.author)?se.orcid:void 0)&&(X+=(X?",":"")+h.author.orcid),h.raw_affiliation_string&&(p+=(p?",":"")+h.raw_affiliation_string.replace(/"/g,""))}await fs.appendFile(i,'"'+g.DOI+(a?'","'+J+'","'+d:"")+(o?'","'+S+'","'+de+'","'+X+'","'+p:"")+'"')}else for(x=!0,Se=0,N=r.length;Se<N;Se++){if((l=r[Se]).includes("."))try{f=await this.flatten(g)}catch(e){f=void 0}else f=g;if(Array.isArray(f)){if(f.length&&"object"==typeof f[0]){for(ge=[],k=0,L=f.length;k<L;k++)null!=(null!=(y=f[k])?y[l]:void 0)&&ge.push(y[l]);f=ge}($={})[l]=f,f=$}if(null==f||null==f[l])we="";else if("object"==typeof f[l]){if(Array.isArray(f[l])){for(m="",A=0,P=(ne=f[l]).length;A<P;A++)"object"==typeof(_=ne[A])&&("sheets"===l&&_.url&&("string"==typeof(null!=V?V.org:void 0)&&V.org.length&&V.org===g.name.toLowerCase()||"string"==typeof(null!=(ae=this.user)?ae.email:void 0)&&this.user.email.endsWith("@oa.works"))&&(_.url=await this.decrypt(_.url)),_=JSON.stringify(_)),m.includes(_)||(m+=(m?";":"")+_);f[l]=m}we=JSON.stringify(f[l])}else we=f[l];if("string"==typeof we&&(we=we.replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")),"sheets.url"===l&&("string"==typeof(null!=V?V.org:void 0)&&V.org.length&&V.org===g.name.toLowerCase()||"string"==typeof(null!=(le=this.user)?le.email:void 0)&&this.user.email.endsWith("@oa.works"))){for(v=[],I=0,q=(oe=Array.isArray(we)?we:we.split(",")).length;I<q;I++)xe=oe[I],v.push(await this.decrypt(xe));we=JSON.stringify(v)}else if(("email"===l||"supplements.email"===l)&&!we.includes("@")&&"string"==typeof(null!=V?V.org:void 0)&&V.org.length){for(he=[],C=0,T=(ce=null!=(ue=g.orgs)?ue:[]).length;C<T;C++)fe=ce[C],he.push(fe.toLowerCase());pe=V.org.toLowerCase(),R.call(he,pe)>=0&&(we=await this.decrypt(we))}await fs.appendFile(i,(x?'"':',"')+we+'"'),x=!1}if(s)return await this.mail({to:s,subject:"Your export is complete (ref: "+i.split("/").pop()+")",text:'Your export is complete. We recommend you download and store files elsewhere as soon as possible as we may delete this file at any time.<br><br><a href="'+n+'">Download CSV</a><br><br>Thanks'})},this.waitUntil(r(de,W,C,_,A,p,E,s,L)),delete this.format,he=p}}}else he=await this.index(de+(j.key?"/"+j.key:""),null!=M?M:W);if(null!=he||j.key&&null!=M||(await this.index(de,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(ee=e._index.mappings)?ee:e._index.mapping,aliases:e._index.aliases}),""!==M&&(he=await this.index(de+(j.key?"/"+j.key:""),null!=M?M:j.key?void 0:W))),null==he&&null==M&&j.key&&"string"==typeof arguments[0]&&(W=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(T=await this.index(de,W))&&null!=(te=T.hits)?te.total:void 0))for(q=0,k=(ie=await this.keys(T.hits.hits[0]._source)).length;q<k;q++)if(l=ie[q],"string"==typeof T.hits.hits[0]._source[l]&&arguments[0]===T.hits.hits[0]._source[l]||Array.isArray(T.hits.hits[0]._source[l])&&(re=arguments[0],R.call(T.hits.hits[0]._source[l],re)>=0)){null==(he=T.hits.hits[0]._source)._id&&(he._id=T.hits.hits[0]._id);break}1===(null!=W?W.size:void 0)&&"object"==typeof he&&null!=(null!=(se=he.hits)?se.hits:void 0)&&(he.hits.hits.length?(null==(o=he.hits.hits[0]._source)._id&&(o._id=he.hits.hits[0]._id),he=he.hits.hits[0]._source):he=void 0)}null!=W&&(j.qry=JSON.stringify(W)),null==he||null!=M||j.cached||(j.cached="index"),j.cached&&this.fn===t&&(this.cached=j.cached)}return null==he&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(u={headers:{},body:M,params:this.copy(this.params)},this.refresh&&(u.params.refresh=!0),u.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,he=await this.fetch(this.S.bg+"/"+de.replace(/\_/g,"/"),u),j.bg=!0),null==he&&e._sheet&&""!==M&&(this.refresh&&this.fn===t||!await this.index(de))&&(he=await this._loadsheet(e,de),(arguments.length||"{}"!==JSON.stringify(this.params))&&(he=void 0)),null!=he||e._index&&""===M||"function"!=typeof e||(i=async(e,t,i,r,s)=>{var n,l,o,u,p,h,d,f;if(t._limit&&(n=!0===t._limit?86400:t._limit,await this.kv("limit/"+s,fe+n,n)),u=await t.apply(this,i),delete a[s],"object"==typeof u&&(t._kv||t._index)&&null==u.took&&null==u.hits){if(t._key&&Array.isArray(u)&&u.length&&null==u[0]._id&&null!=u[0][t._key])for(d=0,o=u.length;d<o;d++)null==(c=u[d])._id&&(c._id=c[t._key].replace(/\//g,"_").toLowerCase());l=Array.isArray(u)?"":"/"+(null!=(p=null!=(h=u[t._key])?h:u._id)?p:this.uid()).replace(/\//g,"_").toLowerCase(),t._kv&&!Array.isArray(u)&&this.kv(e+l,he,t._kv),t._index&&this.waitUntil(this.index(e+l,u))}return!0===t._limit&&await this.kv("limit/"+s,""),t._async&&"loop"!==t._schedule&&(this.kv("async/"+this.rid,null==l||Array.isArray(u)?Array.isArray(u)?u.length:u:e+l,172800),this.fn===s&&!1!==t._notify&&(f=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(u)+"\n\n"+this.base+"/"+e+"?_async="+this.rid,r&&this.mail({to:r,text:f}))),u},e._async&&this.fn===t?(j.async=!0,e._unique&&(P=a[t])?he={_async:P}:(e._unique&&(a[this.fn]=this.rid),he={_async:this.rid},this.waitUntil(i(de,e,arguments,this.params.notify,t)))):he=await i(de,e,arguments)),he}},t.svc={},t.src={},t.status=async function(){var e,t,s,a,o,u,c,p,h;p={name:r.name,version:r.version,built:r.built};try{p.pmid=D.env.pm_id}catch(e){}try{p.pmname=D.env.name}catch(e){}for(e=0,s=(o=["rid","params","base","parts","opts","routes"]).length;e<s;e++){l=o[e];try{null==p[l]&&(p[l]=this[l])}catch(e){}}if(!0===this.S.bg)try{for(h in p.schedule={},n)for(l in p.schedule[h]={},n[h])"fn"!==l&&(p.schedule[h][l]=n[h][l])}catch(e){}!0===this.S.bg&&(p.bg=!0),p.kv=("string"==typeof this.S.kv&&i.g[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{p.index=await this.index.status()}catch(e){}if(r.dev){if(p.bg=this.S.bg,!0!==this.S.bg)try{p.request=this.request}catch(e){}for(t=0,a=(u=["headers","cookie","user","body"]).length;t<a;t++){l=u[t];try{null==p[l]&&(p[l]=this[l])}catch(e){}}}else{try{p.index=p.index.status}catch(e){}p.kv&&(p.kv=!0),p.user=null!=(c=this.user)?c.email:void 0}return p},R=[].indexOf,t.auth=async function(e){var t,i,s,n,a,l,o,u,c,p,h,d,f;if("string"==typeof e)return this.users._get(e);if(e||null==this.user||"auth"!==this.fn&&!1!==e){if(!1!==e&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(n=this.params.token)?n:this.params.auth),"")))&&((f=await this.users._get(null!=(a=null!=s?s.email:void 0)?a:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(d=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(d))),!f&&(this.params.resume||this.cookie))){if(!(p=this.params.resume))try{p=(t=JSON.parse(decodeURIComponent(this.cookie).split((null!=(l=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?l:"oaworksLogin")+"=")[1].split(";")[0])).resume,d=t._id}catch(e){}null==d&&(d=this.headers["x-id"]),this.params.email&&!d&&(d=this.hashhex(this.params.email.trim().toLowerCase())),p&&d&&await this.kv("auth/resume/"+d+"/"+p)&&null!=(f=await this.users._get(d))&&(f.resume=p)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),e||"html"!==this.format?f:(h="<body>",h+='<script type="text/javascript" src="/client/oaworksLogin.min.js?v='+this.S.version+'"><\/script>\n',h+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(h+='<input autofocus id="OALoginEmail" class="OALoginEmail" type="text" name="email" placeholder="email">',h+='<input id="OALoginToken" class="OALoginToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',h+='<p class="OALoginWelcome" style="display:none;">Welcome back</p>',h+='<p class="OALoginLogout" style="display:none;"><a id="OALoginLogout" href="#">logout</a></p>'):h+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',h+"</body>")},t.auth.token=function(e,t,i,s,n,a,l){var o,u,c;if(null==e&&(e=this.params.email),e)return e=e.trim().toLowerCase(),null==t&&(t=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&C.log(e,c),null==l&&(l=this.params.url),l?(l+="#"+c,null==i&&(i="Complete your login to "+(l.includes("//")?l.split("//")[1]:l).split("/")[0])):(l=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,e,1200),this.waitUntil(this.mail({from:t,to:e,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+l+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=n?n:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+l+'">'+l+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:l}})),{email:e}},t.auth.role=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m;if(null==e&&(e=this.params.role),t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,"system"===e&&this.system)return"system";if((null!=t?t.email:void 0)&&(u=t.email,R.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],u)>=0))return"root";if(e.startsWith("@")&&null!=(null!=t?t.email:void 0)&&t.email.endsWith(e))return e;if(null!=(null!=t?t.roles:void 0))for(n=0,l=(c="string"==typeof e?e.split(","):e||[]).length;n<l;n++){if(r=c[n],[s,m]=r.replace("/",".").split("."),s===t._id)return"owner";if(m){if(R.call(null!=(p=t.roles[s])?p:[],m)>=0)return m;if(null!=t.roles[s]&&-1<(d=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(m)))for(a=0,o=(h=i.splice(0,d)).length;a<o;a++)if(f=h[a],R.call(t.roles[s],f)>=0)return f}}return!1},t.auth.add=async function(e,t,i,r){var s,n,a,l,o,u,c;return t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,!(!e&&this.user._id!==t._id&&!await this.auth.role("system"))&&(null==e&&(e=null!=(a=null!=(l=this.params.add)?l:this.params.remove)?a:this.params.deny),!!e&&([n,c]=e.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==n&&"root"!==c&&(r?(t.roles[n]=["deny"],this.users._update(t)):c?(null!=(o=t.roles)?o[n]:void 0)&&R.call(t.roles[n],c)>=0?null!=i&&(t.roles[n].splice(t.roles[n].indexOf(c),1),t.roles[n].length||delete t.roles[n],this.users._update(t)):("request"!==c||R.call(null!=(u=t.roles[n])?u:[],"deny")<0)&&(null==(s=t.roles)[n]&&(s[n]=[]),R.call(t.roles[n],"request")>=0&&(t.roles[n]=t.roles[n].splice(t.roles[n].indexOf("request"),1)),t.roles.group.push(c),this.users._update(t)):null!=t.roles[n]?null!=i&&(delete t.roles[n],this.users._update(t)):(t.roles[n]=["user"],this.users._update(t)),t)))},t.auth.remove=function(e,t){return this.auth.add(e,t,!0)},t.auth.deny=function(e,t){return this.auth.add(e,t,void 0,!0)},t.auth.request=function(e,t){return null==e&&(e=this.params.request),e=e.split("/")[0]+"/request",this.auth.add(e,t)},t.auth.logout=async function(e){return null==e&&(e=this.user),!!e&&(await this.kv._each("auth/resume/"+("string"==typeof e?e.includes("@")?this.hashhex(e.trim().toLowerCase()):e:e._id),""),!0)},t.auth._oauth=async function(e,t){var i,s,n,a,l,o,u,c,p,h,d,f,m,y;if(e)try{if(y=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(s=this.S.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(p=r.use)&&null!=(h=p.google)&&null!=(d=h.oauth)&&null!=(f=d.client)?f.id:void 0),null!=t&&(null!=(n=y.data)?n.aud:void 0)===t)return{email:(m=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e)).data.email.toLowerCase(),google:{id:m.data.id},name:null!=(a=m.data.name)?a:m.data.given_name+(m.data.family_name?" "+m.data.family_name:""),avatar:m.data.picture}}catch(e){}},t.users={_index:!0,_auth:"system"},t.users._get=async function(e,t){var i,r,s;if(t)1===(null!=(r=await this.index("users",'apikey:"'+t+'"'))&&null!=(i=r.hits)?i.total:void 0)&&null==(s=r.hits.hits[0]._source)._id&&(s._id=r.hits.hits[0]._id);else if("string"==typeof e){if(e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),!0!==this.S.bg)try{s=await this.kv("users/"+e)}catch(e){}if(null==s){try{s=await this.index("users/"+e)}catch(e){}if(null!=s&&!0!==this.S.bg){try{await this.kv("users/"+e,s)}catch(e){}try{await this.kv("auth/apikey/"+s.apikey,e)}catch(e){}}}}return s},t.users._create=async function(e){var t;if("string"==typeof e&&(e={email:e}),"string"!=typeof e.email||!e.email.includes("@"))return!1;t={_id:this.hashhex(e.email.trim().toLowerCase()),email:e.email,apikey:this.uid()},delete e.email;try{t.profile=e}catch(e){}try{t.creation=this.base+"/"+this.route}catch(e){}t.roles={},t.createdAt=new Date;try{await this.kv("users/"+t._id,t)}catch(e){}try{await this.kv("auth/apikey/"+t.apikey,t._id)}catch(e){}try{this.waitUntil(this.index("users/"+t._id,t))}catch(e){}return t},t.users._update=async function(e,t){if("object"==typeof e&&t._id&&null==t&&(e=(t=e)._id),"string"==typeof e&&"object"==typeof t&&"{}"!==JSON.stringify(t)){e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),t.updatedAt=new Date;try{await this.kv("users/"+e,t)}catch(e){}try{this.waitUntil(this.index("users/"+e,t))}catch(e){}return!0}return!1},t.users._delete=async function(e){var t,i;if(i="object"==typeof e?e:(null!=(t=this.user)?t._id:void 0)===e?this.user:await this.users._get(e)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(e){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(e){}try{await this.kv("users/"+i._id,"")}catch(e){}try{return await this.index("users/"+i._id,"")}catch(e){}}},t.deal={_index:!0,_prefix:!1},t.deal.institution={_index:!0,_prefix:!1},t.deal.load=async function(){var e,t,i,r,s,n,a,l,o,u,c,p,h;for(t={},r=0,n=(c=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;r<n;r++){for(u=c[r],s=0,a=(p=["Institution","Publisher","Collection","Year(s)","Length of Agreement","Package Price","2015 Carnegie Basic Classification","FTE","Source","URL","Share URL Publicly?","Notes"]).length;s<a;s++)u[(h=p[s]).toLowerCase().replace(/ /g,"").replace("?","").replace("(","").replace(")","")]=u[h],delete u[h];try{if(u.value=parseInt(u.packageprice.replace(/[^0-9]/g,"")),"string"==typeof u.fte)try{u.fte=parseInt(u.fte)}catch(e){delete u.fte}"string"==typeof u.notes&&u.notes.toLowerCase().includes("canadian")?(u.gbpvalue=Math.floor(.57*u.value),u.usdvalue=Math.floor(.75*u.value)):u.packageprice.includes("$")?(u.gbpvalue=Math.floor(.77*u.value),u.usdvalue=Math.floor(u.value)):(u.gbpvalue=Math.floor(u.value),u.usdvalue=Math.floor(1.3*u.value))}catch(e){}null==u.usdvalue&&(u.usdvalue="");try{"2103"===u.years&&(u.years="2013")}catch(e){}try{"yes"!==u.shareurlpublicly.toLowerCase()&&delete u.url}catch(e){}try{delete u.shareurlpublicly}catch(e){}try{""===u.collection&&(u.collection="Unclassified")}catch(e){}try{u.carnegiebasicclassification=u["2015carnegiebasicclassification"],delete u["2015carnegiebasicclassification"]}catch(e){}try{null==t[l=u.institution]&&(t[l]={institution:u.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),o=JSON.parse(JSON.stringify(u));try{delete o.institution}catch(e){}try{t[u.institution].value+=u.value,t[u.institution].gbpvalue+=u.gbpvalue,t[u.institution].usdvalue+=u.usdvalue}catch(e){}t[u.institution].deals.push(o)}catch(e){}}for(e in i=[],t)i.push(t[e]);return await this.deal(""),await this.deal.institution(""),await this.deal(c),await this.deal.institution(i),{retrieved:c.length,institutions:i.length}},R=[].indexOf,t.deposits={_index:!0,_auth:"@oa.works"},t.deposit=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je;for(null==e&&(e=this.copy(this.params)),(null!=(I=e.metadata)?I.doi:void 0)&&!e.doi&&(e.doi=e.metadata.doi),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),null==i&&(i=this.S.dev),(p={createdAt:Date.now()}).created_date=await this.datetime(p.createdAt),d=0,g=(D=["embedded","demo","pilot","live","email","plugin"]).length;d<g;d++)p[y=D[d]]=e[y];if(!0===p.pilot&&(p.pilot=Date.now()),!0===p.live&&(p.live=Date.now()),p.name=null!=(z=null!=t?t.filename:void 0)?z:null!=t?t.name:void 0,"anonymous"!==e.from&&(p.from=e.from),e.confirmed&&(p.confirmed=decodeURIComponent(e.confirmed)),p.doi=null!=(K=e.doi)?K:null!=(ue=e.metadata)?ue.doi:void 0,null==e.metadata&&e.doi&&(e.metadata=await this.metadata(e.doi)),p.metadata=e.metadata,xe=e.config,"string"==typeof e.config&&(xe=JSON.parse(e.config)),!e.config&&e.from&&(xe=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from)),p.permissions=null!=(fe=e.permissions)?fe:await this.permissions(null!=(me=e.metadata)?me:e.doi),e.redeposit||(null==t&&e.email&&null!=e.metadata?p.type="dark":(p.archivable=await this.archivable(t,void 0,p.confirmed,e.metadata,p.permissions,i),null!=(null!=(ye=p.archivable)?ye.metadata:void 0)&&delete p.archivable.metadata)),(null!=(ge=p.archivable)?ge.archivable:void 0)&&(!p.confirmed||p.confirmed===p.archivable.checksum)){for((ke={content:t.data,name:p.archivable.name}).publish=!0,c=[],m=0,_=(E=null!=(_e=null!=(C=e.metadata)?C.author:void 0)?_e:[]).length;m<_;m++)if(null!=(r=E[m]).family){n={name:r.family+(r.given?", "+r.given:"")};try{r.ORCID&&(n.orcid=r.ORCID.split("/").pop())}catch(e){}try{"object"==typeof r.affiliation&&null!=r.affiliation.name&&(n.affiliation=r.affiliation.name)}catch(e){}c.push(n)}0===c.length&&(c=[{name:"Unknown"}]),h=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(h=(h+=null!=(N=null!=(L=p.permissions.best_permission)?L.deposit_statement:void 0)?N:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+e.metadata.doi:"").trim()).lastIndexOf(".")!==h.length-1&&(h+="."),h.length&&(h+=" "),h+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",O={title:null!=(P=e.metadata.title)?P:"Unknown",description:h.trim(),creators:c,version:"submittedVersion"===p.archivable.version?"Submitted Version":"acceptedVersion"===p.archivable.version?"Accepted Version":"publishedVersion"===p.archivable.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},e.doi&&((null!=(je=await this.src.zenodo.records.search('"'+e.doi+'"',i))&&null!=(q=je.hits)?q.total:void 0)&&(f=je.hits.hits[0]),f&&p.confirmed!==p.archivable.checksum&&!i?p.zenodo={already:f.id}:O.related_identifiers=[{relation:"postprint"===O.version||"AAM"===O.version||"preprint"===O.version?"isPreviousVersionOf":"isIdenticalTo",identifier:e.doi}]),O.prereserve_doi=!0,O.access_right="open",O.license=null!=(T=null!=(W=p.permissions.best_permission)?W.licence:void 0)?T:"cc-by",O.license.includes("other")&&O.license.includes("closed")&&(O.license="other-closed"),O.license.includes("other")&&O.license.includes("non")&&O.license.includes("commercial")&&(O.license="other-nc"),O.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(O.license.substring(O.license.length-1)))&&(O.license+="-4.0");try{(null!=(M=p.permissions.best_permission)?M.embargo_end:void 0)&&await this.epoch(p.permissions.best_permission.embargo_end)>Date.now()&&(O.access_right="embargoed",O.embargo_date=p.permissions.best_permission.embargo_end,p.embargo=p.permissions.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(O.publication_date=e.metadata.published)}catch(e){}if(null!=xe){if(p.config=xe,null!=xe.community_ID&&null==xe.community&&(xe.community=xe.community_ID),xe.community)for(null==xe.communities&&(xe.communities=[]),x=0,v=(U="string"==typeof xe.community?xe.community.split(","):xe.community).length;x<v;x++)o=U[x],xe.communities.push({identifier:o});if(null!=xe.community||null!=xe.communities)for(null==xe.communities&&(xe.communities=xe.community),Array.isArray(xe.communities)||(xe.communities=[xe.communities]),O.communities=[],j=0,b=(B=xe.communities).length;j<b;j++)u=B[j],O.communities.push("string"==typeof u?{identifier:u}:u);O.communities&&O.communities.length&&(p.community=O.communities[0].identifier)}if(ve=i||p.demo?null!=(F=this.S.src.zenodo)?F.sandbox:void 0:null!=(J=this.S.src.zenodo)?J.token:void 0){if(!(null!=($=p.zenodo)?$.already:void 0))if((Oe=await this.src.zenodo.deposition.create(O,ke,ve,i)).id)p.zenodo={id:Oe.id,url:"https://"+(i||p.demo?"sandbox.":"")+"zenodo.org/record/"+Oe.id,doi:null!=(null!=(X=Oe.metadata)&&null!=(V=X.prereserve_doi)?V.doi:void 0)?Oe.metadata.prereserve_doi.doi:void 0,file:null!=(G=null!=(Y=Oe.uploaded)&&null!=(H=Y.links)?H.download:void 0)?G:null!=(Z=Oe.uploaded)&&null!=(Q=Z.links)?Q.download:void 0},null==p.doi&&(p.doi=p.zenodo.doi),p.type="zenodo";else{p.error="Deposit to Zenodo failed";try{p.error+=": "+JSON.stringify(Oe)}catch(e){}p.type="review"}}else p.error="No Zenodo credentials available",p.type="review"}if((null!=(ee=p.archivable)?ee.timeout:void 0)&&(p.error="Archivable timeout",p.type="review"),p.version=null!=(te=p.archivable)?te.version:void 0,p.type||!e.from||p.embedded&&(p.embedded.includes("oa.works")||p.embedded.includes("openaccessbutton.org")||p.embedded.includes("shareyourpaper.org"))||(p.type=e.redeposit?"redeposit":t?"forward":"dark"),p.doi&&(null==p.type&&(p.type="review"),p.url="string"==typeof e.redeposit?e.redeposit:e.url?e.url:void 0,await this.deposits(p),("review"!==p.type||null!=t)&&!1!==(null!=(ie=p.archivable)?ie.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(re=exists.zenodo)?re.already:void 0)||i))){for(l=["joe+notifications@oa.works","shared@oa.works"],i&&l.push("mark+notifications@oa.works"),we=[],"string"==typeof(null!=xe?xe.owner:void 0)&&xe.owner.includes("@")&&!p.error?we.push(xe.owner):(null!=xe?xe.email:void 0)&&we.push(xe.email),0===we.length&&(we=this.copy(l),l=[]),s=[],S=0,w=(ae=null!=(se=null!=(ne=p.metadata)?ne.author:void 0)?se:[]).length;S<w;S++)(a=ae[S]).family&&s.push((a.given?a.given+" ":"")+a.family);p.metadata.author=s,p.adminlink=p.embedded?p.embedded:"https://shareyourpaper.org"+(p.metadata.doi?"/"+p.metadata.doi:""),p.adminlink+=p.adminlink.includes("?")?"&":"?",null!=(null!=(le=p.archivable)?le.checksum:void 0)&&(p.confirmed=encodeURIComponent(p.archivable.checksum),p.adminlink+="confirmed="+p.confirmed+"&"),oe=p.email,R.call(p.adminlink,oe)<0&&(p.adminlink+="email="+p.email),be=await this.templates(p.type+"_deposit"),A=await this.template(be.content,p),delete p.adminlink,delete p.confirmed,k={from:"deposits@oa.works",to:we,subject:null!=(ce=A.subject)?ce:p.type+" deposit",html:A.content},l&&l.length&&(k.bcc=l),t&&(k.attachment={file:t.data,filename:null!=(pe=null!=(he=null!=(de=p.archivable)?de.name:void 0)?he:t.name)?pe:t.filename}),await this.mail(k)}if(p.embargo)try{p.embargo_UI=new Date(p.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(e){}return p},t.deposit._bg=!0,t.archivable=async function(e,t,i,r,s,n){var a,l,o;for(null==n&&(n=this.S.dev),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),l={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},a=async()=>{var a,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,R,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z;if(("string"==typeof r||null==r&&(this.params.doi||this.params.title))&&(r=await this.metadata(null!=(E=null!=r?r:this.params.doi)?E:this.params.title)),null==r&&(r={}),"string"==typeof e&&(e={data:e}),null==e&&null!=t&&(e=await this.fetch(t)),null!=e){null==e.name&&(e.name=e.filename);try{l.name=e.name}catch(e){}try{l.format=null!=e.name&&e.name.includes(".")?e.name.split(".").pop():"html"}catch(e){}if(l.format=l.format.toLowerCase(),e.data){if(null==h&&null!=l.format&&null!=this.convert[l.format+"2txt"])try{h=await this.convert[l.format+"2txt"](e.data)}catch(e){}try{null==h&&(h=e.data)}catch(e){}try{h=h.toString()}catch(e){}}}if(null!=h||i){S=((j=(d=h.length<2e4?h:h.substring(0,6e3)+h.substring(h.length-6e3,h.length)).toLowerCase()).length<6e3?j:j.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==l.name&&(l.name=r.title);try{l.checksum=crypto.createHash("md5").update(h,"utf8").digest("base64")}catch(e){}l.same_paper_evidence={};try{l.same_paper_evidence.words_count=h.split(" ").length}catch(e){}try{l.same_paper_evidence.words_more_than_threshold=l.same_paper_evidence.words_count>500}catch(e){}try{l.same_paper_evidence.doi_match=!(!r.doi||!S.includes(r.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}try{l.same_paper_evidence.title_match=!(!r.title||!S.includes(r.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}if(null!=r.author)try{for(c=0,l.same_paper_evidence.author_match=!1,"string"==typeof r.author&&(r.author={name:r.author}),Array.isArray(r.author)||(r.author=[r.author]),U=r.author,g=0,x=U.length;g<x&&(a=U[g],!0!==l.same_paper_evidence.author_match);g++)try{if(u=(null!=(z=null!=(B=null!=(F=null!=(J=a.last)?J:a.lastname)?F:a.family)?B:a.surname)?z:a.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),o=(null!=($=null!=(X=null!=(V=a.first)?V:a.firstname)?X:a.given)?$:a.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),_=S.indexOf(u),u.length>2&&o.length>0&&-1!==_&&S.substring(_-20,_+u.length+20).includes(o)&&(c+=1,r.author.length<3&&1===c||r.author.length>2&&c>1)){l.same_paper_evidence.author_match=!0;break}}catch(e){}}catch(e){}if(null!=l.format)for(b=0,O=(N=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;b<O;b++)if(m=N[b],l.format.includes(m)){l.same_paper_evidence.document_format=!0;break}l.same_paper=!!(l.same_paper_evidence.words_more_than_threshold&&(l.same_paper_evidence.doi_match||l.same_paper_evidence.title_match||l.same_paper_evidence.author_match)&&l.same_paper_evidence.document_format),l.same_paper_evidence.words_count<150&&"pdf"===l.format&&(l.same_paper_evidence.words_count=0,l.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),l.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(L=await this.src.google.sheets(n?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),I=0,k=L.length;I<k;I++){w=L[I],l.version_evidence.strings_checked+=1,Z=w["what to search"],G=w["where to search"],y=w["how to search"],v=w["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&(H=Z.split("<<")[1].split(">>")[0],null!=r[H.toLowerCase()]&&(Z=Z.replace("<<"+H+">>",r[H.toLowerCase()]))),D=!1,"string"===y?D=!!("file"===G&&d.includes(Z)||"file"!==G&&(null!=r.title&&r.title.includes(Z)||null!=l.name&&l.name.includes(Z))):(C=new RegExp(Z,"gium"),D="file"===G&&null!==j.match(C)||"file"!==G&&(null!=r.title&&null!==r.title.match(C)||null!=l.name&&null!==l.name.match(C))),D){if("string"==typeof(Y=w.value))try{Y=parseInt(Y)}catch(e){}"number"!=typeof Y&&(Y=1),!v||"publisher pdf"!==(P=v.toLowerCase())&&"publishedversion"!==P?l.version_evidence.score-=Y:l.version_evidence.score+=Y,l.version_evidence.strings_matched.push({indicates:v,found:y+" "+Z,in:G,score_value:Y})}}catch(e){f=e,null==(p=l.version_evidence).strings_errored&&(p.strings_errored=[]),l.version_evidence.strings_errored.push({tried:y+" "+Z,in:G,error:f.toString()})}}}catch(e){}l.version_evidence.score>0&&(l.version="publishedVersion"),l.version_evidence.score<0&&(l.version="acceptedVersion"),"unknown"===l.version&&l.version_evidence.strings_checked>0&&(l.version="acceptedVersion");try{null!=(null!=(A=await this.licence(void 0,j))?A.licence:void 0)&&(l.licence=A.licence,l.licence_evidence=A)}catch(e){}l.archivable=!1,i?(l.archivable=!0,i===l.checksum?(l.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",l.admin_confirms=!0):(l.archivable_reason="The depositor says that this file is a version that can be archived",l.depositor_says=!0)):l.same_paper?("pdf"!==l.format&&(l.archivable=!0,l.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!l.archivable&&null!=l.licence&&l.licence.toLowerCase().startsWith("cc")&&(l.archivable=!0,l.archivable_reason="It appears this file contains a "+l.licence+" licence statement. Under this licence the article can be archived"),l.archivable||(l.version?(null!=r&&"{}"!==JSON.stringify(r)&&null==s&&(s=await this.permissions(r)),l.version===(null!=s&&null!=(q=s.best_permission)?q.version:void 0)?(l.archivable=!0,l.archivable_reason="We believe this is a "+l.version.split("V")[0]+" version and our permission system says that version can be shared"):null==l.archivable_reason&&(l.archivable_reason="We believe this file is a "+l.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):l.archivable_reason="We cannot confirm if it is an archivable version or not")):null==l.archivable_reason&&(l.archivable_reason=l.same_paper_evidence.words_more_than_threshold?l.same_paper_evidence.document_format?r.doi||r.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+l.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==e&&null==t||(l.error=null!=(R=e.error)?R:"Could not extract any content");return l.archivable&&null==l.licence&&((null!=s&&null!=(T=s.best_permission)?T.licence:void 0)?l.licence=s.best_permission.licence:(null!=(W=null!=s&&null!=(M=s.best_permission)?M.deposit_statement:void 0)?W:"").toLowerCase().startsWith("cc")&&(l.licence=s.best_permission.deposit_statement)),l.metadata=r},a(),setTimeout((()=>l.timeout=!0),null!=(o=this.params.timeout)?o:6e4);null==l.archivable&&!l.timeout;)await this.sleep(500);return l},t.archivable._bg=!0,R=[].indexOf,t.metadata=async function(e){var t;return null!=(t=await this.find(e))?t.metadata:void 0},t.metadata._log=!1,t.find=async function(e,t={},i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x;w={},s=async e=>{var i,r;for(r in i=await this.citation(e))"url"===r||"paywall"===r?null==w[r]&&(w[r]=i[r]):t[r]||(t[r]=i[r]);return!0},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(h=e.dom)?h:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(e.find.startsWith("10.")&&e.find.includes("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(d=e.q)?d:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(l="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&l.split("/")[0].length>6&&l.length>8&&((o=l.split("/")).length>2&&(l=o.join("/")),null==t.doi&&(t.doi=l)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(f=e.url.replace("...","").match(/\./gi))?f:[]).length>3||(null!=(m=e.url.match(/\(/gi))?m:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(y=e.title.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(g=e.title.match(/\(/gi))?g:[]).length>2)&&(e.citation=e.title,delete e.title),e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(_=e.pmcid)?_:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}for("string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(w.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(v=e.from)||"eZwJ83xp3oZDaec86"===v)&&null==w.demo&&(w.demo=!0),w.demo&&null==w.test&&(w.test=!0),u=!1,a=async()=>{var r,n,a,l,o;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(o=await this.scrape(null!=i?i:e.url),await s(o)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(l=t.pmcid)?l:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(a=await this.src.crossref.works.title(t.title))?a.type:void 0)&&(null!=a?a.DOI:void 0)&&await s(a),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(n=async()=>{var e;return null==(e=await this.src.oadoi.doi(t.doi))&&(w.doi_not_in_oadoi=t.doi),(null!=e?e.doi:void 0)&&(null!=t?t.doi:void 0)&&e.doi.toLowerCase()===t.doi.toLowerCase()&&await s(e),!0},r=async()=>{if(null!=(a=await this.src.crossref.works.doi(t.doi))?a.type:void 0){try{a.published=await this.src.crossref.works.published(a);try{a.year=a.published.split("-")[0]}catch(e){}try{a.year=parseInt(a.year)}catch(e){}try{a.publishedAt=await this.epoch(a.published)}catch(e){}}catch(e){}await s(a)}else w.doi_not_in_crossref=t.doi;return!0},await Promise.all([n(),r()])),!0},await a(),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==w.ill&&(w.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==w.permissions&&(w.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]),c=0,p=(b=["title","journal","year","doi"]).length;c<p;c++)e[x=b[c]]&&e[x]!==t[x]&&(t[x]=e[x]);return w.metadata=t,w},t.citation=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ae,Ie,De,Ce,Ee,Re,Ne,Le,Pe,qe,Te,We,Me,Ue,ze,Be,Fe,Je,$e,Xe,Ve,Ge,Ye,He,Ze,Ke,Qe,et,tt,it,rt,st,nt,at,lt,ot,ut,ct,pt,ht,dt,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,At,It,Dt,Ct,Et;xt={};try{null==e&&(e=null!=(T=this.params.citation)?T:this.params)}catch(e){}if("string"==typeof e)if(e.startsWith("{")||e.startsWith("["))try{e=JSON.parse(e)}catch(e){}else if(e.startsWith("10."))try{e=await this.src.crossref.works.doi(e)}catch(e){}if("object"==typeof e){xt.doi=null!=(W=e.DOI)?W:e.doi,xt.pmid=null!=(Y=e.pmid)?Y:null!=(ae=e.ids)?ae.pmid:void 0,xt.pmcid=null!=(ge=e.pmcid)?ge:null!=(Ie=e.ids)?Ie.pmcid:void 0;try{xt.type=null!=(Me=null!=(He=e.type_crossref)?He:e.type)?Me:e.genre}catch(e){}null==xt.issn&&(xt.issn=null!=(lt=null!=(_t=null!=(M=null!=(U=e.ISSN)?U:e.issn)?M:null!=(z=e.journalInfo)&&null!=(B=z.journal)?B.issn:void 0)?_t:null!=(F=e.journal)?F.issn:void 0)?lt:null!=(J=e.primary_location)&&null!=($=J.source)?$.issn:void 0),null!=(null!=(X=e.journalInfo)&&null!=(V=X.journal)?V.eissn:void 0)&&(null==xt.issn&&(xt.issn=[]),"string"==typeof xt.issn&&(xt.issn=[xt.issn]),G=e.journalInfo.journal.eissn,R.call(xt.issn,G)<0&&xt.issn.push(e.journalInfo.journal.eissn)),!xt.issn&&e.journal_issns&&(xt.issn=e.journal_issns.split(",")),xt.title=e.title,Array.isArray(xt.title)&&(xt.title=xt.title[0]),xt.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(xt.title+=": "+e.subtitle[0]),null==xt.title&&(xt.title=null!=(H=e.dctitle)?H:null!=(Z=e.bibjson)?Z.title:void 0),404!==(K=xt.title)&&"404"!==K||delete xt.title,"string"==typeof xt.title&&(xt.title=xt.title.replace(/\s\s+/g," ").trim()),null==xt.journal&&(xt.journal=e["container-title"]?e["container-title"][0]:null!=(Q=e.primary_location)&&null!=(ee=Q.source)?ee.display_name:void 0);try{xt.shortname=e["short-container-title"][0]}catch(e){}try{xt.shortname=null!=(te=e.journalInfo.journal.isoabbreviation)?te:e.journalInfo.journal.medlineAbbreviation}catch(e){}xt.shortname&&!xt.journal_short&&(xt.journal_short=xt.shortname),null==xt.journal&&(xt.journal=null!=(ie=null!=(re=e.journal_name)?re:null!=(se=e.journalInfo)&&null!=(ne=se.journal)?ne.title:void 0)?ie:null!=(le=e.journal)?le.title:void 0),e.journal&&(xt.journal=e.journal.split("(")[0].trim());try{for(u=0,m=(oe=["title","journal"]).length;u<m;u++)null==xt[h=oe[u]]&&(xt[h]=xt[h].charAt(0).toUpperCase()+xt[h].slice(1))}catch(e){}null==xt.publisher&&(xt.publisher=null!=(ue=e.publisher)?ue:null!=(ce=e.primary_location)&&null!=(pe=ce.source)?pe.publisher:void 0),xt.publisher&&(xt.publisher=xt.publisher.trim()),null==xt.published&&(xt.published=e.publication_date);try{null==xt.issue&&(xt.issue=null!=(he=null!=(de=e.issue)?de:null!=(fe=e.journalInfo)?fe.issue:void 0)?he:null!=(me=e.biblio)?me.issue:void 0)}catch(e){}try{null==xt.volume&&(xt.volume=null!=(ye=null!=(_e=e.volume)?_e:null!=(ve=e.journalInfo)?ve.volume:void 0)?ye:null!=(be=e.biblio)?be.volume:void 0)}catch(e){}for((e.page||e.pages||e.pageInfo)&&null==xt.pages&&(xt.pages=(null!=(we=e.page)?we:e.pageInfo).toString()),((null!=(xe=e.biblio)?xe.first_page:void 0)||(null!=(Oe=e.biblio)?Oe.last_page:void 0))&&(xt.pages=(null!=(ke=e.biblio.first_page)?ke:"")+(e.biblio.first_page&&e.biblio.last_page?" to ":"")+(null!=(je=e.biblio.last_page)?je:"")),xt.abstract=null!=(Se=e.abstract)?Se:e.abstractText,c=0,y=(Ae=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;c<y;c++)if(E=Ae[c],"string"!=typeof xt.published){if(kt=null!=(De=null!=(Ce=e[E])?Ce:null!=(Ee=e["journal-issue"])?Ee[E.replace("journal-issue.","")]:void 0)?De:null!=(Re=e.journalInfo)?Re[E.replace("journalInfo.","")]:void 0){"number"==typeof kt&&(kt=kt.toString());try{"string"!=typeof kt&&(kt=kt["date-time"].toString())}catch(e){}if("string"!=typeof kt)try{for(p in kt["date-parts"][0])"number"!=(Ne=typeof kt["date-parts"][0][p])&&"string"!==Ne&&(kt["date-parts"][0][p]="01");kt=kt["date-parts"][0].join("-")}catch(e){}"string"==typeof kt&&(xt.published=kt.includes("T")?kt.split("T")[0]:kt,xt.published=xt.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),xt.published.includes("-")||(xt.published+="-01"),3!==xt.published.split("-").length&&(xt.published+="-01"),null==xt.year&&(xt.year=xt.published.split("-")[0]),3!==xt.published.split("-").length&&delete xt.published,4!==xt.year.toString().length&&delete xt.year)}if(xt.published)break}e.year&&null==xt.year&&(xt.year=e.year);try{null==xt.year&&(xt.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!xt.year&&xt.published&&xt.published.includes("-")&&(xt.year=xt.published.split("-")[0]),null==xt.author&&(null!=e.author||null!=e.z_authors||(null!=(Le=e.authorList)?Le.author:void 0)||e.authorships)){null==xt.author&&(xt.author=[]);try{for(We=null!=(Pe=null!=(qe=null!=(Te=e.author)?Te:e.z_authors)?qe:e.authorList.author)?Pe:e.authorships,D=0,v=We.length;D<v;D++)if("string"==typeof(t=We[D]))xt.author.push({name:t});else{if(s={},"object"==typeof t.author)for(s.name=t.author.display_name,s.family=s.name.split(" ").pop(),s.name.split(" ").length>1&&(s.given=s.name.split(" ")[0]),ze=null!=(Ue=s.raw_affiliation_strings)?Ue:[],C=0,b=ze.length;C<b;C++)i=ze[C],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i});else for(s.given=null!=(Be=t.given)?Be:t.firstName,s.family=null!=(Fe=t.family)?Fe:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(Je=s.family)?Je:""),Xe=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=($e=t.authorAffiliationDetailsList.authorAffiliation)?$e:[],P=0,w=Xe.length;P<w;P++)"string"==typeof(i=Xe[P])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(Ve=i.name)?Ve:i.affiliation).replace(/\s\s+/g," ").trim()}));xt.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(xt.subject=e.subject)}catch(e){}try{null!=(null!=(Ge=e.keywordList)?Ge.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(xt.keyword=e.keywordList.keyword)}catch(e){}if(!xt.keyword&&e.keywords)for(xt.keyword=[],q=0,x=(Ye=e.keywords).length;q<x;q++)d=Ye[q],xt.keyword.push(d.keyword);try{for(tt=[...null!=(Ze=null!=(Ke=e.meshHeadingList)?Ke.meshHeading:void 0)?Ze:[],...null!=(Qe=null!=(et=e.chemicalList)?et.chemical:void 0)?Qe:[]],jt=0,O=tt.length;jt<O;jt++)A=tt[jt],null==xt.keyword&&(xt.keyword=[]),"string"==typeof(I="string"==typeof A?A:null!=(it=A.name)?it:A.descriptorName)&&I&&R.call(xt.keyword,I)<0&&xt.keyword.push(I)}catch(e){}"string"==typeof e.license&&(xt.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(xt.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(rt=e.best_oa_location)?rt.license:void 0)&&null==xt.licence&&(xt.licence=e.best_oa_location.license)}catch(e){}try{(null!=(st=e.primary_location)?st.license:void 0)&&null==xt.licence&&(xt.licence=e.primary_location.license)}catch(e){}if(!xt.licence){for(At=0,k=(at=null!=(nt=e.assertion)?nt:[]).length;At<k;At++)"OPEN ACCESS"===(t=at[At]).label&&t.URL&&t.URL.includes("creativecommons")&&null==xt.licence&&(xt.licence=t.URL);for(It=0,j=(ut=null!=(ot=e.license)?ot:[]).length;It<j;It++)!(f=ut[It]).URL||!f.URL.includes("creativecommons")||xt.licence&&xt.licence.includes("creativecommons")||null==xt.licence&&(xt.licence=f.URL)}if("string"==typeof xt.licence&&xt.licence.includes("/licenses/")&&(xt.licence="cc-"+xt.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==xt.url&&(xt.url=null!=(ct=null!=(pt=null!=(ht=null!=(dt=e.best_oa_location)?dt.pdf_url:void 0)?ht:null!=(ft=e.best_oa_location)?ft.url_for_pdf:void 0)?pt:null!=(mt=e.best_oa_location)?mt.url:void 0)?ct:null!=(yt=e.best_oa_location)?yt.landing_page_url:void 0),!xt.url&&null!=(null!=(gt=e.fullTextUrlList)?gt.fullTextUrl:void 0))for(Dt=0,S=(vt=e.fullTextUrlList.fullTextUrl).length;Dt<S;Dt++)"oa"!==(bt=(a=vt[Dt]).availabilityCode.toLowerCase())&&"f"!==bt||xt.url&&("pdf"!==a.documentStyle||xt.url.includes("pdf"))||(xt.url=a.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(xt.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(xt.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!xt.doi&&e.includes("http")&&(xt.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(xt.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?xt.title=e.split('"')[1].trim():e.split("'").length>2&&null==xt.title&&(xt.title=e.split("'")[1].trim())}catch(e){}try{for(L=e.replace(/,\./g," ").split(" "),Ct=0,g=L.length;Ct<g;Ct++)N=L[Ct],xt.year||4===(N=N.replace(/[^0-9]/g,"")).length&&("number"!=typeof(St=parseInt(N))||isNaN(St)||(xt.year=St))}catch(e){}try{!xt.title&&xt.year&&e.indexOf(xt.year)<e.length/4&&(xt.title=e.split(xt.year)[1].trim(),(!xt.title.includes("(")||xt.title.indexOf(")")<xt.title.indexOf("("))&&(xt.title=xt.title.replace(")","")),xt.title.indexOf(".")<3&&(xt.title=xt.title.replace(".","")),xt.title.indexOf(",")<3&&(xt.title=xt.title.replace(",","")),xt.title=xt.title.trim(),xt.title.includes(".")?xt.title=xt.title.split(".")[0]:xt.title.includes(",")&&(xt.title=xt.title.split(",")[0]))}catch(e){}if(xt.title){try{if(n=e.split(xt.title)[0],xt.year&&n.includes(xt.year)&&(n=n.split(xt.year)[0]),xt.url&&n.indexOf(xt.url)>0&&(n=n.split(xt.url)[0]),xt.url&&n.startsWith(xt.url)&&(n=n.replace(xt.url)),xt.doi&&n.startsWith(xt.doi)&&(n=n.replace(xt.doi)),n.indexOf(".")<3&&(n=n.replace(".","")),n.indexOf(",")<3&&(n=n.replace(",","")),n.lastIndexOf("(")>n.length-3&&(n=n.substring(0,n.lastIndexOf("("))),n.lastIndexOf(")")>n.length-3&&(n=n.substring(0,n.lastIndexOf(")"))),n.lastIndexOf(",")>n.length-3&&(n=n.substring(0,n.lastIndexOf(","))),n.lastIndexOf(".")>n.length-3&&(n=n.substring(0,n.lastIndexOf("."))),(n=n.trim()).length>6)if(n.includes(","))for(xt.author=[],wt=n.split(","),Et=0,_=wt.length;Et<_;Et++)r=wt[Et],xt.author.push({name:r});else xt.author=[{name:n}]}catch(e){}try{Ot=e.split(xt.title)[1],xt.url&&Ot.includes(xt.url)&&(Ot=Ot.replace(xt.url)),xt.doi&&Ot.includes(xt.doi)&&(Ot=Ot.replace(xt.doi)),Ot.indexOf(".")<3&&(Ot=Ot.replace(".","")),Ot.indexOf(",")<3&&(Ot=Ot.replace(",","")),(Ot=Ot.trim()).length>6&&(xt.journal=Ot,Ot.includes(",")&&(xt.journal=xt.journal.split(",")[0].replace(/in /gi,"").trim()),xt.journal.indexOf(".")<3&&(xt.journal=xt.journal.replace(".","")),xt.journal.indexOf(",")<3&&(xt.journal=xt.journal.replace(",","")),xt.journal=xt.journal.trim())}catch(e){}}try{if(xt.journal&&(Ot=e.split(xt.journal)[1],xt.url&&Ot.includes(xt.url)&&(Ot=Ot.replace(xt.url)),xt.doi&&Ot.includes(xt.doi)&&(Ot=Ot.replace(xt.doi)),Ot.indexOf(".")<3&&(Ot=Ot.replace(".","")),Ot.indexOf(",")<3&&(Ot=Ot.replace(",","")),(Ot=Ot.trim()).length>4)){if(Ot.includes("retrieved")&&(Ot=Ot.split("retrieved")[0]),Ot.includes("Retrieved")&&(Ot=Ot.split("Retrieved")[0]),xt.volume=Ot,xt.volume.includes("(")){xt.volume=xt.volume.split("(")[0],xt.volume=xt.volume.trim();try{xt.issue=Ot.split("(")[1].split(")")[0],xt.issue=xt.issue.trim()}catch(e){}}if(xt.volume.includes(",")){xt.volume=xt.volume.split(",")[0],xt.volume=xt.volume.trim();try{xt.issue=Ot.split(",")[1],xt.issue=xt.issue.trim()}catch(e){}}if(xt.volume)try{isNaN(parseInt(xt.volume))&&delete xt.volume}catch(e){}if(xt.issue){xt.issue.includes(",")&&(xt.issue=xt.issue.split(",")[0].trim());try{isNaN(parseInt(xt.issue))&&delete xt.issue}catch(e){}}if(xt.volume&&xt.issue)try{(Ot=e.split(xt.journal)[1]).includes("retriev")&&(Ot=Ot.split("retriev")[0]),Ot.includes("Retriev")&&(Ot=Ot.split("Retriev")[0]),xt.url&&Ot.includes(xt.url)&&(Ot=Ot.split(xt.url)[0]),xt.doi&&Ot.includes(xt.doi)&&(Ot=Ot.split(xt.doi)[0]),(Ot=(Ot=Ot.substring(Ot.indexOf(xt.volume)+(xt.volume+"").length)).substring(Ot.indexOf(xt.issue)+(xt.issue+"").length)).indexOf(".")<2&&(Ot=Ot.replace(".","")),Ot.indexOf(",")<2&&(Ot=Ot.replace(",","")),Ot.indexOf(")")<2&&(Ot=Ot.replace(")","")),Ot=Ot.trim(),isNaN(parseInt(Ot.substring(0,1)))||(xt.pages=Ot.split(" ")[0].split(".")[0].trim(),xt.pages.length>5&&(xt.pages=xt.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!xt.author&&e.includes("et al")&&(o=e.split("et al")[0].trim(),e.startsWith(o)&&(xt.author=[{name:o+"et al"}])),xt.title&&!xt.volume)try{(l=e.split(xt.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(xt.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!xt.issue&&l.includes("iss")&&(xt.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!xt.pages&&l.includes("page")&&(xt.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof xt.year&&(xt.year=xt.year.toString()),xt},t.availability=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&e.availability.includes("/")?e.doi=e.availability:e.availability.includes(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(n=null!=(a=null!=(g=null!=(b=null!=(w=null!=(x=null!=(O=null!=(k=e.doi)?k:e.pmid)?O:e.pmc)?x:e.pmcid)?w:e.title)?b:e.url)?g:e.id)?a:e.citation)?n:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.find(e)),null!=i.v2){null==(r=i.data).match&&(r.match=null!=(j=null!=(S=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(p=i.v2.metadata)?p.doi:void 0)?u:null!=(h=i.v2.metadata)?h.title:void 0)?o:null!=(d=i.v2.metadata)?d.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?S:null!=(m=i.v2.metadata)?m.pmcid:void 0)?j:null!=(y=i.v2.metadata)?y.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(s=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(I=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+s+" AND type:article&sort=createdAt:desc"))&&null!=(_=I.hits)?_.total:void 0)&&((D={type:"article",_id:(A=I.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(v=A.user)?v.id:void 0)!==e.uid),i.data.requests.push(D))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},t.find_new=async function(e,t={},i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O;x={},s=async e=>{var i,r,s;for(r in s=[],i=await this.citation(e))"url"===r||"paywall"===r?s.push(null!=x[r]?x[r]:x[r]=i[r]):s.push(null!=t[r]?t[r]:t[r]=i[r]);return s},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(h=e.dom)?h:"string"==typeof this.body?this.body:void 0),null==e.find&&(e.find=e.find_new),delete e.find_new,e.metadata&&(e.find=e.metadata),e.find&&(e.find.startsWith("10.")&&e.find.includes("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(d=e.q)?d:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(a="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&a.split("/")[0].length>6&&a.length>8&&((l=a.split("/")).length>2&&(a=l.join("/")),null==t.doi&&(t.doi=a)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(f=e.url.replace("...","").match(/\./gi))?f:[]).length>3||(null!=(m=e.url.match(/\(/gi))?m:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(y=e.title.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(g=e.title.match(/\(/gi))?g:[]).length>2)&&(e.citation=e.title,delete e.title),e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(_=e.pmcid)?_:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}for("string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(x.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(v=e.from)||"eZwJ83xp3oZDaec86"===v)&&null==x.demo&&(x.demo=!0),x.demo&&null==x.test&&(x.test=!0),o=!1,null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await s(await this.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(o=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(b=t.pmcid)?b:t.pmid),await s(o)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(p=await this.src.openalex.works.title(t.title))?p.type:void 0)&&(null!=p?p.doi:void 0)&&await s(p),t.doi||o||!1!==(o=await this.src.epmc.title(t.title))&&await s(o))),t.doi&&!p&&(p=await this.src.openalex.works.doi(t.doi))&&await s(p),t.doi&&!(null!=p?p.type_crossref:void 0)&&(x.doi_not_in_openalex=!0),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==x.ill&&(x.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==x.permissions&&(x.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]),u=0,c=(w=["title","journal","year","doi"]).length;u<c;u++)e[O=w[u]]&&e[O]!==t[O]&&(t[O]=e[O]);return x.metadata=t,x},R=[].indexOf,t.ill=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w;null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),s=e.config;try{s=JSON.parse(s)}catch(e){}for(p in("string"==typeof s||!s&&e.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=e.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:s)))),null==s&&(s={}),w={name:"librarian",details:""},h=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(c in e[p])"email"!==c&&(e[c]=e[p][c],R.call(h,c)<0&&h.push(c));delete e.metadata}else R.call(h,p)<0&&h.push(p);for(a=0,o=h.length;a<o;a++)if(e[d=h[a]]&&(w[d]=e[d],"author"===d)){for(n=!0,r=[],l=0,u=(y=e[d]).length;l<u;l++)(t=y[l]).family&&(n&&(n=!1),i=t.family+(t.given?" "+t.given:""),r.push(i));w[d]=r}return null!=e.author&&delete e.author,w.illid=e._id=await this.uid(),s.search&&s.search.length&&(e.issn||e.journal)&&(-1!==s.search.indexOf("worldcat")?(v=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",v+=null!=e.issn?"in%3A":"ti%3A",v+="&si0qs="+(null!=(g=e.issn)?g:e.journal),v+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(v=s.search,v+=e.issn?e.issn:e.journal),w.worldcatsearchurl=v),await this.ills(e),b=(b=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!s.email&&!e.email||this.waitUntil(this.mail({svc:"oaworks",vars:w,template:b,to:null!=(_=s.email)?_:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id})),b=b.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:w,template:b,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:"joe+notifications@oa.works"})),e},t.ills={_index:!0},t.ill.collect=async function(e){var t,i,r;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},t.ill.openurl=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d;for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=s[r]);for(a in h="",e.ill_added_params&&(h+=e.ill_added_params.replace("?","")+"&"),h+=e.sid+"=InstantILL&",t){if(d="","author"===a)for(n=0,l=(p=Array.isArray(t.author)?t.author:[t.author]).length;n<l;n++)i=p[n],d.length&&(d+=", "),d+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==a&&"pmid"!==a&&"pmc"!==a&&"pmcid"!==a&&"url"!==a&&"journal"!==a&&"title"!==a&&"year"!==a&&"issn"!==a&&"volume"!==a&&"issue"!==a&&"page"!==a&&"crossref_type"!==a&&"publisher"!==a&&"published"!==a&&"notes"!==a||(d=t[a]);d&&(h+=(e[a]?e[a]:a)+"="+encodeURIComponent(d)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(h=h.replace("usermetadata=true","")).indexOf(o+"=")?h+="&"+o+"=The user provided some metadata.":h=h.replace(o+"=",o+"=The user provided some metadata. ")),h.replace("/&&/g","&")},t.ill.subscription=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(o=this.params.config)?o:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(u=opts.from)?u:e)))),null==t&&(t=this.params.meta),p={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(h in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),a=await this.ill.openurl(e,t),e.ill_added_params&&(a=a.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(f=e.subscription[h])?(m=f.type,f=f.url):m=null!=(c=e.subscription_type[h])?c:"unknown",f=f.trim()){"serialssolutions"===m||-1!==f.indexOf("serialssolutions")?(-1!==(g=f.split(".search")[0]).indexOf("//")&&(g=g.split("//")[1]),f="http://"+g+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==m&&-1===f.indexOf("sfx.")||-1!==f.indexOf("sfx.response_type=simplexml")?"exlibris"!==m&&-1===f.indexOf(".exlibris")||-1!==f.indexOf("response_type")||(f=f.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):f+=(-1===f.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(_=f+(-1===f.indexOf("?")?"?":"&")+a).indexOf("snc.idm.oclc.org/login?url=")&&(_=_.split("snc.idm.oclc.org/login?url=")[1]),_=_.replace("cache=true",""),("sfx"===m||-1!==f.indexOf("sfx.")&&-1!==_.indexOf("=10."))&&(_=_.replace("=10.","=doi:10.")),("exlibris"===m||-1!==f.indexOf(".exlibris")&&-1!==_.indexOf("doi=10."))&&(_=_.replace("doi=10.","ID=doi:10.")),l="",d="",r=!1,p.lookups.push(_);try{l=await this.fetch(_);try{await this.mail({to:"mark@oa.works",subject:"oa.works serials solutions dev query running",text:_+"\n\n"+JSON.stringify(l)})}catch(e){}if(null==l||"object"==typeof l){if("serialssolutions"===m)try{await this.mail({to:"mark@oa.works",subject:"oa.works serials solutions error",text:_+"\n\n"+JSON.stringify(l)})}catch(e){}l="",r=!0}}catch(e){if(i=e,r=!0,"serialssolutions"===m)try{await this.mail({to:"mark@oa.works",subject:"oa.works serials solutions error",text:_+"\n\n"+JSON.stringify(l)+"\n\n"+JSON.stringify(i)})}catch(e){}}try{d=-1!==l.indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,p.contents.push(d)}catch(e){if(i=e,r=!0,"serialssolutions"===m)try{await this.mail({to:"mark@oa.works",subject:"oa.works serials solutions error",text:_+"\n\n"+JSON.stringify(l)+"\n\n"+JSON.stringify(i)})}catch(e){}}if("sfx"===m||-1!==_.indexOf("sfx."))if(r&&p.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{p.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),p.findings.sfx=p.url,null!=p.url&&(-1===p.url.indexOf("getitnow")?p.found="sfx":(p.url=void 0,p.findings.sfx=void 0))}catch(e){}else-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(p.url=_,p.findings.sfx=p.url,null!=p.url&&(-1===p.url.indexOf("getitnow")?p.found="sfx":(p.url=void 0,p.findings.sfx=void 0)));else if("eds"===m||-1!==_.indexOf("ebscohost."))r&&p.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(p.url=_.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],p.findings.eds=p.url,null!=p.url&&(-1===p.url.indexOf("getitnow")?p.found="eds":p.url=void 0));else if("serialssolutions"===m||-1!==_.indexOf("serialssolutions.")){if(r&&p.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">'))(s=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(p.url=s,p.findings.serials=p.url,null!=p.url&&(-1===p.url.indexOf("getitnow")?p.found="serials":(p.url=void 0,p.findings.serials=void 0)));else if(-1===d.indexOf("ss_noresults"))try{y=_.split("?")[0]+"?ShowSupressedLinks"+l.split("?ShowSupressedLinks")[1].split('">')[0],n=await this.fetch(y);try{await this.mail({to:"mark@oa.works",subject:"oa.works serials solutions dev query running second stage",text:y+"\n\n"+JSON.stringify(n)})}catch(e){}-1!==n.indexOf("ArticleCL")&&-1!==n.split("DatabaseCL")[0].indexOf('href="./log')&&(p.url=y.split("?")[0]+n.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),p.findings.serials=p.url,null!=p.url&&(-1===p.url.indexOf("getitnow")?p.found="serials":(p.url=void 0,p.findings.serials=void 0)))}catch(e){i=e,r&&p.error.push("serialssolutions");try{await this.mail({to:"mark@oa.works",subject:"oa.works serials solutions error",text:"serials solutions later error\n\n"+_+"\n\n"+y+"\n\n"+JSON.stringify(n)+"\n\n"+JSON.stringify(i)})}catch(e){}}}else"exlibris"!==m&&-1===_.indexOf(".exlibris")||(r&&p.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")&&(p.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),p.findings.exlibris=p.url,p.found="exlibris"))}return p.url&&(p.url=await this.decode(p.url)),p},t.licence=async function(e,t,i,r){var s,n,a,l,o,u,c,p,h,d,f,m,y;if(null==e&&(e=this.params.url),null==t&&(t=null!=(c=this.params.content)?c:this.body),e||t||!this.params.licence&&!this.params.doi||(e="https://doi.org/"+(null!=(p=this.params.licence)?p:this.params.doi)),e&&(e=e.replace(/(^\s*)|(\s*$)/g,""),!t)){C.log(e);try{t=await this.fetch(e)}catch(e){}}if("number"==typeof t&&(t=void 0),null==i&&(i=this.params.start),null==r&&(r=this.params.end),l={},e&&(l.url=e),"string"==typeof t)for(null!=i&&t.includes(i)&&(t=t.split(i)[1]),r&&(t=t.split(r)[0]),t.length>1e5&&(l.large=!0,t=t.substring(0,5e4)+t.substring(t.length-5e4,t.length)),s=0,a=(f=null!=(h=null!=(o=await this.licences("*",1e4))&&null!=(d=o.hits)?d.hits:void 0)?h:[]).length;s<a;s++)if((!(n=f[s]._source).matchesondomains||"*"===n.matchesondomains||null==e||n.matchesondomains.toLowerCase().includes(e.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=n.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(m=!!(y=!!n.matchtext.includes("://")&&n.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&t.toLowerCase().includes(y))||t.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){l.licence=n.licencetype,l.match=n.matchtext,l.matched=m?y:u;break}return l},t.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1},R=[].indexOf,t.permissions=async function(e,t,i,s,n,a){var l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ae,Ie,De,Ce,Ee,Re,Ne,Le,Pe,qe;if(T=!1,m=!1,l=async function(t){var i,s,a,l,o,u,c,p,h,d,f,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,R,N;if(m&&t.embargo_months&&(e.published||e.year)&&(s=new Date(Date.parse(null!=(g=e.published)?g:e.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+t.embargo_months)),t.embargo_end=s.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(_=t.copyright_owner.toLowerCase())&&"affiliation"!==_?m&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(S=e.author[0].name)?S:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(j=e.journal)?j:"",("publisher"===(A=t.copyright_name.toLowerCase())||"journal"===A)&&(n||e.doi||(null!=(I=t.provenance)?I.example:void 0)))for(null==n&&(n=await this.src.crossref.works.doi(null!=(D=e.doi)?D:t.provenance.example)),o=0,p=(E=null!=(C=null!=n?n.assertion:void 0)?C:[]).length;o<p;o++)if("copyright"===(i=E[o]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(m&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,m&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(l="",u=0,h=(R=t.deposit_statement.split("<<")).length;u<h;u++)if(y=R[u],""!==l||y.includes(">>")){if(null!=(N={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(a=y.split(">>"))[0].toLowerCase()]&&(f=N[f]),"author"===f)try{l+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else l+=null!=(b=null!=(w=e[f])?w:t[f])?b:"";try{l+=a[1]}catch(e){}}else l+=y;t.deposit_statement=l}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(T=t.issuer.has_policy),c=0,d=(k=["_id","hide"]).length;c<d;c++)delete t[k[c]];return t},u=e=>{var t,i,r,s,n,a;return a=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(a+=1e3),null!=e.requirements?a-=10:a+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,e.licence&&(a-=5),a+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(n=e.issuer)?n.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(a-=25),a},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),v=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&e.issn.includes(",")&&(e.issn=e.issn.split(",")),delete e.best,"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(null==a&&(a=this.params.best),a&&e.doi&&!e.ror.length&&(p=await this.permissions.best(e.doi))&&(!0===a||p.updated>a))return delete p.updated,delete p.DOI,{best_permission:p};if(o=async()=>{var t,i,r,s,a;if(i=this.copy(e),"{}"!==JSON.stringify(i)){for(t in s=[],a=null!=(r=null!=n?n:await this.metadata(e.doi))?r:{})s.push(null!=e[t]?e[t]:e[t]=a[t]);return s}},!1===i||!e.doi||e.publisher&&e.issn||await o(),!e.published&&e.year&&(e.published=e.year+"-01-01"),m=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!v.length)for(y=0,x=(X=e.issn).length;y<x;y++)_=X[y],R.call(v,_)<0&&v.push(_);try{null==e.doi&&(e.doi=await this.permissions.journals.example(v))}catch(e){}!m&&e.doi&&await o()}if(m&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ce=e.year)?ce:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(U={best_permission:void 0,all_permissions:[]},Se=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(De=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(be=De.hits)?be.total:void 0))try{(null!=(we=(Ce=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')).hits)?we.total:void 0)&&(Ce=Ce.hits.hits[0]._source),Ce.country.country_code&&(De=await this.permissions.affiliations('issuer.id:"'+Ce.country.country_code+'"'))}catch(e){}for(b=0,O=(ke=null!=(xe=null!=De&&null!=(Oe=De.hits)?Oe.hits:void 0)?xe:[]).length;b<O;b++)Ie=ke[b],(Ne=await l(Ie._source)).score=await u(Ne),Se.push(Ne)}if(g=void 0,v){for await($ of this.index._for("src_doaj_journals",'bibjson.pissn:"'+v.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+v.join('" OR bibjson.eissn:"')+'"'))g||(g=$),V=$.bibjson.pissn,R.call(v,V)<0&&v.push($.bibjson.pissn),G=$.bibjson.eissn,R.call(v,G)<0&&v.push($.bibjson.eissn);if(v.length)for(L=0,j=(Z=null!=(Y=null!=(z=await this.permissions.journals('issuer.id:"'+v.join('" OR issuer.id:"')+'"'))&&null!=(H=z.hits)?H.hits:void 0)?Y:[]).length;L<j;L++)W=Z[L],(Ae=await l(W._source)).score=await u(Ae),U.all_permissions.push(Ae)}if(e.publisher)for(F='issuer.id:"'+e.publisher+'"',P=0,S=(ee=null!=(K=null!=(z=await this.permissions.publishers(F))&&null!=(Q=z.hits)?Q.hits:void 0)?K:[]).length;P<S;P++)W=ee[P],(Ae=await l(W._source)).score=await u(Ae),U.all_permissions.push(Ae);if(c={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},v&&(null!=g?g:g=await this.src.doaj.journals('bibjson.eissn.keyword:"'+v.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+v.join('" OR bibjson.pissn.keyword:"')+'"',1))){for(q=0,A=(se=null!=(ie=null!=(re=g.bibjson)?re.license:void 0)?ie:[]).length;q<A;q++)d=se[q],(!c.licence||c.licence.length>d.type)&&(c.licence=d.type),null==c.licences&&(c.licences=[]),c.licences.push({type:d.type});if(null==c.licence&&(h=await this.src.crossref.journals('ISSN.keyword:"'+v.join('" OR ISSN.keyword:"')+'"',1)))for(B=0,I=(ae=null!=(ne=h.license)?ne:[]).length;B<I;B++)N=ae[B],(!c.licence||c.licence.length>N.type)&&(c.licence=N.type);"string"==typeof c.licence?(c.licence=c.licence.toLowerCase().trim(),c.licence.startsWith("cc")?c.licence=c.licence.replace(/ /g,"-"):c.licence.includes("creative")?c.licence=c.licence.includes("0")||c.licence.includes("zero")?"cc0":c.licence.includes("share")?"ccbysa":c.licence.includes("derivative")?"ccbynd":"ccby":delete c.licence):delete c.licence,c.issuer.id=g.bibjson.eissn&&g.bibjson.pissn?[g.bibjson.pissn,g.bibjson.eissn]:g.bibjson.pissn?[g.bibjson.pissn]:[g.bibjson.eissn],c.embargo_months=0,c.provenance={oa_evidence:"In DOAJ"},c.score=await u(c),U.all_permissions.push(c)}else!v&&e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(c.issuer.id=e.publisher,c.meta.creator=["joe+oapublisher@oa.works"],c.meta.contributors=["joe+oapublisher@oa.works"],c.provenance={oa_evidence:"OA publisher"},c.score=await u(c),U.all_permissions.push(c));if(e.doi&&(null==s&&(s=await this.src.oadoi.doi(e.doi)),m&&(null!=s&&null!=(le=s.best_oa_location)?le.license:void 0)&&s.best_oa_location.license.includes("cc")&&((f={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(f.versions="submittedVersion"===f.version?["submittedVersion"]:"acceptedVersion"===f.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),f.score=await u(f),U.all_permissions.push(f))),U.all_permissions.length){for(U.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),J=0,D=(oe=U.all_permissions).length;J<D;J++)null==(qe=oe[J]).licences&&(qe.licences=[],qe.licence&&qe.licences.push({type:qe.licence})),m&&(null!=(ue=qe.issuer)?ue.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(qe.issuer.journal_oa_type_from)&&delete qe.issuer.journal_oa_type,delete qe.issuer.journal_oa_type_from,!v&&"journal"!==(null!=(pe=qe.issuer)?pe.type:void 0)||qe.issuer.journal_oa_type||(qe.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=v?v:qe.issuer.id,g,s,n)),(null!=(he=qe.provenance)?he.enforcement_from:void 0)?(!e.published||Date.parse(e.published)>Date.parse(qe.provenance.enforcement_from.split("/").reverse().join("-")))&&null==U.best_permission&&(U.best_permission=this.copy(qe)):null==U.best_permission&&(U.best_permission=this.copy(qe));if(Se.length)for(Se.sort(((e,t)=>e.score<t.score?1:-1)),Ee=0,C=Se.length;Ee<C;Ee++)if(je=Se[Ee],m&&(null!=(de=je.issuer)?de.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(je.issuer.journal_oa_type_from)&&delete je.issuer.journal_oa_type,delete je.issuer.journal_oa_type_from,!v&&"journal"!==(null!=(fe=je.issuer)?fe.type:void 0)||je.issuer.journal_oa_type||(je.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=v?v:je.issuer.id,g,s,n)),U.all_permissions.push(je),null==(null!=(me=U.best_permission)?me.author_affiliation_requirement:void 0)&&null!=U.best_permission&&(!(null!=(ye=je.provenance)?ye.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(je.provenance.enforcement_from.split("/").reverse().join("-")))){for(M=this.copy(U.best_permission),Re=0,E=(ge=["versions","locations"]).length;Re<E;Re++)for(Le=0,k=(_e=je[w=ge[Re]]).length;Le<k;Le++)Pe=_e[Le],null==M[w]&&(M[w]=[]),R.call(M[w],Pe)<0&&M[w].push(Pe);M.version=R.call(M.versions,"publishedVersion")>=0?"publishedVersion":R.call(M.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",M.embargo_end&&je.embargo_end&&Date.parse(je.embargo_end)<Date.parse(M.embargo_end)&&(M.embargo_end=je.embargo_end),M.embargo_months&&null!=je.embargo_months&&je.embargo_months<M.embargo_months&&(M.embargo_months=je.embargo_months),!0===je.can_archive&&(M.can_archive=!0),null==M.requirements&&(M.requirements={}),M.requirements.author_affiliation_requirement=null==e.ror?je.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],M.issuer.affiliation=je.issuer,null==M.meta&&(M.meta={}),M.meta.affiliation=je.meta,null==M.provenance&&(M.provenance={}),M.provenance.affiliation=je.provenance,M.score=parseInt(M.score)+parseInt(je.score),U.best_permission=M,U.all_permissions.push(M)}}return T?{body:"string"!=typeof T?T:null!=(ve={"not publisher":"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it"}[T.toLowerCase()])?ve:T,status:501}:(e.doi&&!Se.length&&U.best_permission&&((p=await this.copy(U.best_permission)).updated=await this.epoch(),p.DOI=e.doi,this.waitUntil(this.permissions.best(p))),!0!==this.params.metadata&&!0!==i||(U.metadata=e),U)},t.permissions._log=!1,t.permissions.best={_index:!0,_key:"DOI"},t.permissions.journals={_sheet:"1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",_prefix:!1,_format:async function(e=[]){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v;for(f=[],s=0,u=(y="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<u;s++){for(a in d={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},m=y[s])if("string"==typeof m[a]&&(m[a]=m[a].trim()),"id"===a)if(d.issuer.id="string"==typeof m.id&&m.id.includes(",")?m.id.split(","):m.id,"string"==typeof d.issuer.id&&d.issuer.id.startsWith("10.")&&d.issuer.id.includes("/")&&!d.issuer.id.includes(" "))d.DOI=d.issuer.id;else{for(r=[],n=0,c=(g="string"==typeof d.issuer.id?[d.issuer.id]:d.issuer.id).length;n<c;n++){if(h=(h=g[n]).trim(),"journal"===d.issuer.type&&h.includes("-")&&!h.includes(" ")&&(h=h.toUpperCase(),t=await this.src.openalex.sources('issn:"'+h+'"',1)))for(o=0,p=(_=t.issn).length;o<p;o++)i=_[o],R.call(r,i)<0&&r.push(i);R.call(r,h)<0&&r.push(h)}d.issuer.id=r}else"embargo_months"===a?(l="number"==typeof m[a]?m[a]:"string"==typeof m[a]?parseInt(m[a].trim()):void 0)&&"number"==typeof l&&(d.embargo_months=l,d.embargo_end=""):a&&null!=m[a]&&""!==(v=m[a])&&"none"!==v&&"unclear"!==v&&("versions"===a&&m.versions.length&&(d.can_archive=!0,d.version=m.versions.includes("ublish")?"publishedVersion":m.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==a&&"locations"!==a&&"meta.contributors"!==a&&"meta.creator"!==a&&"meta.reviewer"!==a&&"provenance.archiving_policy"!==a&&"requirements.funder"!==a&&"journal"!==a||(m[a]=m[a].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(d,"license"===a?"licence":a,m[a]));d.copyright_owner&&"journal"!==d.copyright_owner.toLowerCase()||!d.issuer.type||(d.copyright_owner=d.issuer.type),"{}"===JSON.stringify(d.requirements)&&delete d.requirements,f.push(d)}return 1===f.length?f[0]:f}},t.permissions.publishers={_sheet:"11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.affiliations={_sheet:"15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.journals.example=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.crossref.works('ISSN:"'+e.join('" OR ISSN:"')+'"',1)).DOI}catch(e){}},t.permissions.journals.example._log=!1,t.permissions.journals.transformative={_index:!0,_prefix:!1},t.permissions.journals.transformative.load=async function(){var e,t,i,r,s;for(e=[],t=0,i=(s=(await this.fetch("https://api.journalcheckertool.org/journal?q=tj:true&include=issn&size=10000")).hits.hits).length;t<i;t++)r=s[t],e.push(r._source);return e.length&&(await this.permissions.journals.transformative(""),await this.permissions.journals.transformative(e)),e.length},t.permissions.journals.transformative.load._bg=!0,t.permissions.journals.transformative.load._async=!0,t.permissions.journals.transformative.load._auth="root",t.permissions.journals.oa=async function(e,t){var i,r,s,n,a,l;try{null==e&&(e=null!=(r=null!=(s=null!=(n=this.params.journals)?n:this.params.journal)?s:this.params.issn)?r:this.params.oa)}catch(e){}return l={},e&&(l.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'"'),l.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'" AND is_oa:true'),l.articles===l.open&&(l.oa=!0),await this.src.doaj.journals('bibjson.pissn:"'+e+'" OR bibjson.eissn:"'+e+'"',1)&&(l.open=l.articles,l.doaj=!0,l.oa=!0),(i=await this.permissions.journals.example(e))&&(null==t&&(t=await this.src.oadoi.doi(i)),null!=t?(delete l.oa,l.open=l.articles,l.oadoi=!0,l.oa=(null!=t&&null!=(a=t.best_oa_location)?a.license:void 0)&&t.best_oa_location.license.includes("cc")):l.oa=!1)),l},t.permissions.journals.oa._log=!1,t.permissions.journals.oa.type=async function(e,t,i,r){var s,n,a,l,o,u,c,p,h,d;return null==e&&(e=null!=(n=null!=(a=null!=(l=null!=(o=null!=(u=null!=(c=null!=i?i.journal_issns:void 0)?c:null!=r?r.ISSN:void 0)?u:this.params.journals)?o:this.params.journal)?l:this.params.type)?a:this.params.issn)?n:this.params.issns),"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),e.startsWith("10.")&&(null==i&&(i=await this.src.oadoi.doi(e)),null==r&&(r=await this.src.crossref.works.doi(e)),e=null!=(p=null!=i?i.journal_issns:void 0)?p:null!=r?r.ISSN:void 0)),"string"==typeof e&&(e=e.split(",")),s="unknown",null!=(null!=r?r.type:void 0)&&"journal-article"!==r.type?s="not applicable":(null!=r?r.type:void 0)&&"journal-article"!==r.type||(s="gold"===(null!=i?i.oa_status:void 0)||(null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",null==t&&e&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?s=!1===(null!=(h=t.bibjson)&&null!=(d=h.apc)?d.has_apc:void 0)?"diamond":"gold":e&&(e&&await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?s="transformative":"closed"===s&&await this.src.oadoi.hybrid(e)&&(s="hybrid"))),s},t.permissions.journals.oa.type._log=!1,t.permissions.publishers.oa=async function(e){var t,i,r,s;return s={publisher:(null!=(r=null!=e?e:this.params.publisher)?r:this.params.oa).replace(/&/g,"")},await this.src.crossref.journals('publisher:"'+s.publisher+'"',1)||((t=await this.src.crossref.journals('publisher:"'+s.publisher.split(" ").join('" AND publisher:"')+'"',1))?t.publisher.toLowerCase()!==s.publisher.toLowerCase()&&((i=await this.levenshtein(t.publisher,s.publisher)).distance<5||(i.length.a>i.length.b?i.length.a:i.length.b)/i.distance>10)&&(s.publisher=t.publisher):s.journals=0),null==s.journals&&(s.journals=await this.src.crossref.journals.count('publisher:"'+s.publisher+'" AND NOT discontinued:true')),s.open=await this.src.doaj.journals.count('publisher:"'+s.publisher+'" AND NOT bibjson.discontinued_date:* AND NOT bibjson.is_replaced_by:*'),s.percent=s.journals?Math.ceil(s.open/s.journals*100):s.open?100:0,s.oa=!s.journals&&s.open||s.journals&&s.journals===s.open,s},t.permissions.publishers.oa._log=!1,R=[].indexOf,t.permissions_new=async function(e,t,i){var s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ae,Ie,De,Ce,Ee,Re,Ne,Le,Pe,qe,Te,We,Me,Ue,ze,Be,Fe,Je,$e,Xe,Ve,Ge,Ye,He,Ze,Ke,Qe,et;M=!1,d=!1,s=function(t){var i,s,n,a,l,o,u,c,p,h,f,m,y,g,_,v,b,w,x,O,k;if(d&&t.embargo_months&&(e.published||e.year)&&(i=new Date(Date.parse(null!=(h=e.published)?h:e.year+"-01-01")),i=new Date(i.setMonth(i.getMonth()+t.embargo_months)),t.embargo_end=i.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(f=t.copyright_owner.toLowerCase())&&"affiliation"!==f?d&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(g=e.author[0].name)?g:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(y=e.journal)?y:"",d&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,d&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(n="",a=0,o=(_=t.deposit_statement.split("<<")).length;a<o;a++)if(p=_[a],""!==n||p.includes(">>")){if(null!=(k={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[c=(s=p.split(">>"))[0].toLowerCase()]&&(c=k[c]),"author"===c)try{n+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else n+=null!=(b=null!=(w=e[c])?w:t[c])?b:"";try{n+=s[1]}catch(e){}}else n+=p;t.deposit_statement=n}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(M=t.issuer.has_policy),l=0,u=(m=["_id","hide"]).length;l<u;l++)delete t[m[l]];return t},n=e=>{var t,i,r,s,n,a;return a=(e.can_archive?1e3:0)+("In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)?1e3:0)+(e.licence?-5:0),a+=null!=e.requirements?-10:"publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,a+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(n=e.issuer)?n.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(a-=25),a},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params));try{e.permissions=e.permissions_new,delete e.permissions_new}catch(e){}if(!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),"string"==typeof e.issn&&(e.issn=e.issn.split(",")),"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};d=e.doi;try{null==e.doi&&(e.doi=await this.permissions_new.journals.example(e.issn))}catch(e){}if(d&&(!e.publisher||!e.issn)&&(null!=i?i:i=await this.src.openalex.works(d))){for(f=0,b=(G=null!=(V=i.authorships)?V:[]).length;f<b;f++){for(a=G[f],(u={}).name=a.author.display_name,u.family=u.name.split(" ").pop(),u.name.split(" ").length>1&&(u.given=u.name.split(" ")[0]),y=0,w=(fe=null!=(se=a.raw_affiliation_strings)?se:[]).length;y<w;y++)l=fe[y],null==u.affiliation&&(u.affiliation=[]),u.affiliation.push({name:l});null==e.author&&(e.author=[]),e.author.push(u)}if(null==e.type&&(e.type=i.type_crossref),"journal"===(null!=(ke=i.primary_location)&&null!=(Le=ke.source)?Le.type:void 0))for(null==e.publisher&&(e.publisher=null!=(We=i.primary_location.source.publisher)?We:i.primary_location.source.host_organization_name),null==e.journal&&(e.journal=i.primary_location.source.display_name),null==e.issn&&(e.issn=[]),g=0,j=(Ue=null!=(Me=i.primary_location.source.issn)?Me:[]).length;g<j;g++)T=Ue[g],R.call(e.issn,T)<0&&e.issn.push(T);for(null==e.published&&(e.published=i.publication_date),null==e.year&&(e.year=i.publication_year),e.abstract=i.abstract,v=0,S=(ze=["title"]).length;v<S;v++)i[W=ze[v]]&&null==e[W]&&(e[W]=i[W]);for(L=0,A=(Y=["volume","issue"]).length;L<A;L++)c=Y[L],(null!=(H=i.biblio)?H[c]:void 0)&&null==e[c]&&(e[c]=i.biblio[c]);((null!=(Z=i.biblio)?Z.first_page:void 0)||(null!=(K=i.biblio)?K.last_page:void 0))&&(e.pages=(null!=(Q=i.biblio.first_page)?Q:"")+(i.biblio.first_page&&i.biblio.last_page?" to ":"")+(null!=(ee=i.biblio.last_page)?ee:""))}if(!e.year&&e.published&&e.published.includes("-")&&(e.year=e.published.split("-")[0]),"number"==typeof e.year&&(e.year+=""),!e.published&&e.year&&(e.published=e.year+"-01-01"),"string"==typeof e.issn&&(e.issn=[e.issn]),e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim()),d&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};try{e.citation="["+(e.title?e.title+". ":""),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ie=e.year)?ie:e.published).split("-")[0]+")"),e.citation=e.citation.trim()+"]"}catch(e){}if(B={best_permission:void 0,all_permissions:[]},Fe=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(Xe=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(re=Xe.hits)?re.total:void 0)){try{Ve=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')}catch(e){}(null!=Ve&&null!=(ne=Ve.hits)?ne.total:void 0)&&(Ve=Ve.hits.hits[0]._source),(null!=Ve&&null!=(ae=Ve.country)?ae.country_code:void 0)&&(Xe=await this.permissions.affiliations('issuer.id:"'+Ve.country.country_code+'"'))}for(P=0,I=(ue=null!=(le=null!=Xe&&null!=(oe=Xe.hits)?oe.hits:void 0)?le:[]).length;P<I;P++)$e=ue[P],(He=await s($e._source)).score=await n(He),Fe.push(He)}if(m=void 0,e.issn){for await(X of this.index._for("src_doaj_journals",'bibjson.pissn:"'+e.issn.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+e.issn.join('" OR bibjson.eissn:"')+'"'))null==m&&(m=X),ce=X.bibjson.pissn,R.call(e.issn,ce)<0&&e.issn.push(X.bibjson.pissn),pe=X.bibjson.eissn,R.call(e.issn,pe)<0&&e.issn.push(X.bibjson.eissn);for(q=0,D=(me=null!=(he=null!=(F=await this.permissions.journals('issuer.id:"'+e.issn.join('" OR issuer.id:"')+'"'))&&null!=(de=F.hits)?de.hits:void 0)?he:[]).length;q<D;q++)U=me[q],(Je=await s(U._source)).score=await n(Je),B.all_permissions.push(Je)}if(e.publisher)for(J=0,C=(_e=null!=(ye=null!=(F=await this.permissions.publishers('issuer.id:"'+e.publisher+'"'))&&null!=(ge=F.hits)?ge.hits:void 0)?ye:[]).length;J<C;J++)U=_e[J],(Je=await s(U._source)).score=await n(Je),B.all_permissions.push(Je);if(o={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},m){for($=0,E=(we=null!=(ve=null!=(be=m.bibjson)?be.license:void 0)?ve:[]).length;$<E;$++)p=we[$],(!o.licence||o.licence.length>p.type)&&(o.licence=p.type),null==o.licences&&(o.licences=[]),o.licences.push({type:p.type});"string"==typeof o.licence?(o.licence=o.licence.toLowerCase().trim(),o.licence.startsWith("cc")?o.licence=o.licence.replace(/ /g,"-"):o.licence.includes("creative")?o.licence=o.licence.includes("0")||o.licence.includes("zero")?"cc0":o.licence.includes("share")?"ccbysa":o.licence.includes("derivative")?"ccbynd":"ccby":delete o.licence):delete o.licence,o.issuer.id=m.bibjson.eissn&&m.bibjson.pissn?[m.bibjson.pissn,m.bibjson.eissn]:m.bibjson.pissn?[m.bibjson.pissn]:[m.bibjson.eissn],o.embargo_months=0,o.provenance={oa_evidence:"In DOAJ"},o.score=await n(o),B.all_permissions.push(o)}else e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(o.issuer.id=e.publisher,o.meta.creator=["joe+oapublisher@oa.works"],o.meta.contributors=["joe+oapublisher@oa.works"],o.provenance={oa_evidence:"OA publisher"},o.score=await n(o),B.all_permissions.push(o));if(d&&(null!=i?i:i=await this.src.openalex.works(d))&&(null!=(xe=null!=i&&null!=(Oe=i.best_oa_location)?Oe.license:void 0)?xe:"").includes("cc")&&((h={can_archive:!0,version:i.best_oa_location.version,versions:"submittedVersion"===i.best_oa_location.version?["submittedVersion"]:"acceptedVersion"===i.best_oa_location.version?["submittedVersion","acceptedVersion"]:i.best_oa_location.version?["submittedVersion","acceptedVersion","publishedVersion"]:[],licence:i.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:i.updated},provenance:{oa_evidence:"Openalex"}}).score=await n(h),B.all_permissions.push(h)),B.all_permissions.length){for(B.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),Ge=0,N=(je=B.all_permissions).length;Ge<N;Ge++)null==(et=je[Ge]).licences&&(et.licences=[],et.licence&&et.licences.push({type:et.licence})),d&&(null!=(Se=et.issuer)?Se.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(et.issuer.journal_oa_type_from)&&delete et.issuer.journal_oa_type,delete et.issuer.journal_oa_type_from,!e.issn&&"journal"!==(null!=(Ae=et.issuer)?Ae.type:void 0)||et.issuer.journal_oa_type||(et.issuer.journal_oa_type=await this.permissions_new.journals.oa.type(null!=(Ie=e.issn)?Ie:et.issuer.id,m,i)),(!(null!=(De=et.provenance)?De.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(et.provenance.enforcement_from.split("/").reverse().join("-")))&&null==B.best_permission&&(B.best_permission=et);for(Ce=Fe.sort(((e,t)=>e.score<t.score?1:-1)),Ye=0,x=Ce.length;Ye<x;Ye++)if(Be=Ce[Ye],d&&(null!=(Ee=Be.issuer)?Ee.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Be.issuer.journal_oa_type_from)&&delete Be.issuer.journal_oa_type,delete Be.issuer.journal_oa_type_from,!e.issn&&"journal"!==(null!=(Re=Be.issuer)?Re.type:void 0)||Be.issuer.journal_oa_type||(Be.issuer.journal_oa_type=await this.permissions_new.journals.oa.type(null!=(Ne=e.issn)?Ne:Be.issuer.id,m,i)),B.all_permissions.push(Be),null!=(z=B.best_permission)&&null==z.author_affiliation_requirement&&(!(null!=(Pe=Be.provenance)?Pe.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(Be.provenance.enforcement_from.split("/").reverse().join("-")))){for(Ze=0,O=(qe=["versions","locations"]).length;Ze<O;Ze++)for(Ke=0,k=(Te=Be[_=qe[Ze]]).length;Ke<k;Ke++)Qe=Te[Ke],R.call(z[_],Qe)<0&&z[_].push(Qe);z.version=R.call(z.versions,"publishedVersion")>=0?"publishedVersion":R.call(z.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",z.embargo_end&&Be.embargo_end&&Date.parse(Be.embargo_end)<Date.parse(z.embargo_end)&&(z.embargo_end=Be.embargo_end),z.embargo_months&&null!=Be.embargo_months&&Be.embargo_months<z.embargo_months&&(z.embargo_months=Be.embargo_months),!0===Be.can_archive&&(z.can_archive=!0),null==z.requirements&&(z.requirements={}),z.requirements.author_affiliation_requirement=null==e.ror?Be.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],z.issuer.affiliation=Be.issuer,null==z.meta&&(z.meta={}),z.meta.affiliation=Be.meta,null==z.provenance&&(z.provenance={}),z.provenance.affiliation=Be.provenance,z.score=parseInt(z.score)+parseInt(Be.score),B.all_permissions.push(z)}}return M?{status:501,body:"string"==typeof M&&"not publisher"===M.toLowerCase()?"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it":M}:(!0===this.params.metadata&&(B.metadata=e),B)},t.permissions_new._log=!1,t.permissions_new.journals={example:async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.openalex.works('ids.doi:* AND locations.source.issn:"'+e.join('" OR locations.source.issn:"')+'"',1)).doi}catch(e){}}},t.permissions_new.journals.example._log=!1,t.permissions_new.journals.oa={type:async function(e,t,i,r){var s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A;if(null==e&&(e=null!=(h=null!=(d=null!=(b=null!=(w=null!=(x=this.params.journals)?x:this.params.journal)?w:this.params.type)?b:this.params.issn)?d:this.params.issns)?h:[]),n=null!=t,"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),null==i&&e.startsWith("10.")&&(i=await this.src.openalex.works.doi(e),null==r&&null==i&&(r=await this.src.crossref.works.doi(e)),e=[])),"string"==typeof e&&(e=e.split(",")),l="unknown",(null!=i?i.type_crossref:void 0)&&"journal-article"!==i.type_crossref||(null!=r?r.type:void 0)&&"journal-article"!==r.type)l="not applicable";else if(!((null!=i?i.type_crossref:void 0)&&"journal-article"!==i.type_crossref||(null!=r?r.type:void 0)&&"journal-article"!==r.type)){if(null!=i){for(s=0,o=(k=null!=(O=i.locations)?O:[]).length;s<o;s++)for((null!=(j=(c=k[s]).source)?j.is_in_doaj:void 0)&&(n=!0),a=0,u=(f=null!=(S=null!=(A=c.source)?A.issn:void 0)?S:[]).length;a<u;a++)(p=f[a])&&R.call(e,p)<0&&e.push(p);l="hybrid"!==(null!=(m=i.open_access)?m.oa_status:void 0)||n?n||"gold"===(null!=(y=i.open_access)?y.oa_status:void 0)?"gold":"closed":"hybrid"}"unknown"!==l||e||n||!(null!=r||(null!=i&&null!=(g=i.ids)?g.doi:void 0)&&(r=await this.src.crossref.works(i.ids.doi.split("doi.org/").pop())))||r.ISSN&&(e=r.ISSN),(e||null!=t)&&(null==t&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?l=!1===(null!=(_=t.bibjson)&&null!=(v=_.apc)?v.has_apc:void 0)?"diamond":"gold":e&&(await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?l="transformative":"closed"===l&&await this.src.openalex.hybrid(e)&&(l="hybrid")))}return l}},t.permissions_new.journals.oa.type._log=!1,R=[].indexOf;try{r.report=JSON.parse(SECRETS_REPORT)}catch(e){}null==r.report&&(r.report={}),t.report=function(){return"OA.Works report"},t.report.chat=async function(e,t,i,r){var s,n,a;return(s=this.params.pmcid)&&(r=await this.src.epmc.xml(s),!0!==this.params.xml&&(r=r.split("<ref-list>")[0].replace(/\n/g," ").replace(/(<([^>]+)>)/gi,""))),null==e&&(e=null!=(n=this.params.prompt)?n:"Please return the data availability statement"),r&&(e+=" of the following research article: "+r),null==t&&(t=null!=(a=this.params.role)?a:"You are a terse text and data mining extraction tool in the scientific research publishing field"),r?this.src.openai.chat(e,t,this.params.model,this.params.json):{}},m=[],g=[],y=!1,o=[],u=[],d=[],h={},f={},c=[],p=!1,t.report._handle_queue=async function(){var e,t;if(!1===y&&(y=Date.now()),m.length>3e3||m.length&&Date.now()>y+3e4){for(C.log("handle queue saving batch",m.length),e=[];t=m.shift();)g.shift(),t.createdAt=Date.now(),null==t._id&&(t._id=t.identifier.toLowerCase()),e.push(t),e.length>=1e4&&(await this.report.queued(e),e=[]);e.length&&this.report.queued(e),y=Date.now()}return!1===p&&this.report._handle_processed(),setTimeout(this.report._handle_queue,5e3)},t.report._handle_processed=async function(){var e,t,i;if(!1===p&&(p=Date.now()),c.length>=3e3||c.length&&Date.now()>p+3e4){for(C.log("handle processed saving batch",c.length),i=c,c=[],e=u,u=[],this.report.works(i);t=e.shift();)await this.report.queued(t,"");p=Date.now()}return setTimeout(this.report._handle_processed,5e3)},t.report.queued={_index:!0},t.report.queue=async function(e,t,i,r,s="default"){var n,a,l,o,c,p,h,d,f,_,v,b,w,x,O,k;if(this.params.empty)if("string"==typeof this.params.empty)for await(o of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_queued",'action.keyword:"'+this.params.empty+'"'))await this.report.queued(o._id,"");else await this.report.queued("");if(null==e&&(e=null!=(c=null!=(p=null!=(h=this.params.queue)?h:this.params.doi)?p:this.params.openalex)?c:this.params.pmcid),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),e)for(a=0,l=(d=Array.isArray(e)?e:[e]).length;a<l;a++){n=d[a];try{(O="object"==typeof n?null!=(f=null!=(_=null!=(v=null!=(b=null!=(w=n.ident)?w:n.identifier)?b:n.DOI)?v:n.doi)?_:n.openalex)?f:n.pmcid:n).startsWith("w")&&(O=O.replace("w","W")),O.startsWith("pmc")&&(O=O.replace("pmc","PMC")),O.includes("10.")&&!(O=await this.report.cleandoi(O))||(k=O.toLowerCase(),O&&"string"==typeof O&&(O.startsWith("10.")||O.startsWith("W")||O.startsWith("PMC"))&&R.call(g,k)<0&&R.call(u,k)<0&&(g.push(k),x=!0===(x="object"==typeof n&&null!=n.refresh?n.refresh:null!=i?i:"undefined"!=typeof inq&&null!==inq?inq.refresh:void 0)?0:!1===x?void 0:x,m.push({identifier:O,refresh:x,everything:"object"==typeof n&&null!=n.everything?n.everything:null!=r?r:"undefined"!=typeof inq&&null!==inq?inq.everything:void 0,action:"object"==typeof n&&null!=n.action?n.action:s})))}catch(e){}}return!1===y&&this.report._handle_queue(),{queue:m.length}},t.report.queue._bg=!0,t.report.queue._log=!1,t.report.queue._auth="@oa.works",t.report._runqueue=async function(e,t,i,r){var s,n,a,l,c,p,h,f,g,_,v,b,w,x,O,k,j;if(null==t&&(t='action:"default"'),null==i&&(i="desc"),null!=e)t="for requested identifier "+e;else{if(o.length)t="";else if(r&&(!0===r&&(r=(s=(await this.report.queued(t,{size:1,sort:{createdAt:"asc"}})).createdAt)+Math.floor(((await this.report.queued(t,{size:1,sort:{createdAt:"desc"}})).createdAt-s)/2),C.log("queue midpoint",r)),t="("+t+") AND createdAt:"+("desc"===i?"<":">")+r),(null!=(c=await this.report.queued(t,{size:2e3,sort:{createdAt:i}}))&&null!=(h=c.hits)?h.total:void 0)||'action:"default"'!==t||(C.log("no queued records found for specified qry",t,"checking for any other queued records..."),c=await this.report.queued("NOT action:*",{size:2e3,sort:{createdAt:i}}),t="queried * as none for qry "+t),r&&(null!=c&&null!=(f=c.hits)?f.total:void 0)&&c.hits.total<5e3)C.log("not queueing on mid "+i+" queue when only "+c.hits.total+" records to process, waiting 5s..."),await this.sleep(5e3);else if("desc"!==i&&(null!=c&&null!=(_=c.hits)?_.total:void 0)&&c.hits.total<25e3)C.log("not queueing on reverse "+i+" queue when only "+c.hits.total+" records to process, waiting 5s..."),await this.sleep(5e3);else for((null!=c&&null!=(v=c.hits)?v.total:void 0)||m.length||(C.log("no queued records to process, waiting 5s..."),await this.sleep(5e3)),n=0,a=(x=null!=(b=null!=c&&null!=(w=c.hits)?w.hits:void 0)?b:[]).length;n<a;n++)O=(p=x[n])._source.identifier,R.call(d,O)<0&&(k=p._source.identifier,R.call(u,k)<0)&&(j=p._source.identifier,R.call(o,j)<0)&&o.push(p._source);e=null!=(g=null!=(l=o.shift())?l.identifier:void 0)?g:null!=l?l.DOI:void 0}if(C.log("report run queue",d.length,o.length),"string"==typeof e&&(e.startsWith("10.")||e.startsWith("W")||e.startsWith("PMC"))&&R.call(d,e)<0&&R.call(u,e)<0){for(await this.sleep(10);d.length>=5;)await this.sleep(500);d.push(e),this.report.works.process(e,void 0,null!=l?l.refresh:void 0,null!=l?l.everything:void 0,null!=l?l.action:void 0,void 0,e)}return!1===y&&this.report._handle_queue(),!0},t.report._doqueue=function(){return this.report._runqueue()},t.report._doqueue._log=!1,t.report._doqueue._bg=!0,t.report._domidqueue=function(){return this.report._runqueue(void 0,void 0,void 0,!0)},t.report._domidqueue._log=!1,t.report._domidqueue._bg=!0,t.report._domidreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc",!0)},t.report._domidreversequeue._log=!1,t.report._domidreversequeue._bg=!0,t.report._doreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc")},t.report._doreversequeue._log=!1,t.report._doreversequeue._bg=!0,t.report._dochangesqueue=function(){return this.report._runqueue(void 0,'action:"changes" OR action:"years"')},t.report._dochangesqueue._log=!1,t.report._dochangesqueue._bg=!0,t.report.dev2live=async function(e){var t,i,r,s,n,a,l;for await(n of("number"==typeof(l=this.params.toalias)&&(l+=""),s=this.params.org?'orgs.keyword:"'+this.params.org+'"':this.params.q,e?(r="paradigm_report_works",a="paradigm_b_report_works"):(r="paradigm_b_report_works",a="paradigm_report_works"),this.params.clear&&await this.index._send(a,"",void 0,!1,l),i=0,t=[],C.log("report works running",e?"live2dev":"dev2live",r,a,l,s),this.index._for(r,s,{scroll:"30m"})))i+=1,t.push(n),5e4===t.length&&(C.log("report works",e?"live2dev":"dev2live",r,a,l,i),await this.index._bulk(a,t,void 0,void 0,!1,l),t=[]);return t.length&&(C.log("report works",e?"live2dev":"dev2live",r,a,l,i,"remaining",t.length),await this.index._bulk(a,t,void 0,void 0,!1,l),t=[]),C.log(i,"report works",e?"live2dev":"dev2live",r,a,l,"complete",s?"for query "+s:""),i},t.report.dev2live._async=!0,t.report.dev2live._bg=!0,t.report.dev2live._auth="@oa.works",t.report.live2dev=function(){return this.report.dev2live(!0)},t.report.live2dev._async=!0,t.report.live2dev._bg=!0,t.report.live2dev._auth="root",t.report.oapolicy={_sheet:r.report.oapolicy_sheet,_format:function(e=[]){var t,i,r,s,n,a,l,o;for(a=[],r=0,s=(o="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<s;r++){for(i in n={},l=o[r]){if("string"==typeof l[i])if(l[i]=l[i].trim(),"true"===l[i].toLowerCase())l[i]=!0;else if("false"===l[i].toLowerCase())l[i]=!1;else if(l[i].startsWith("[")&&l[i].endsWith("]")||l[i].startsWith("{")&&l[i].endsWith("}"))try{l[i]=JSON.parse(l[i])}catch(e){t=e,C.log("cant parse "+i,l[i],t)}else l[i].includes(";")&&(l[i]=l[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(null!=l[i]&&""!==l[i])if(i.includes("."))try{this.dot(n,i,l[i])}catch(e){}else n[i]=l[i]}"{}"!==JSON.stringify(n)&&a.push(n)}return 1===a.length?a[0]:a}},t.report.cleandoi=function(e){var t;null==e&&(e=null!=(t=this.params.cleandoi)?t:this.params.doi);try{e=e.split(",http")[0]}catch(e){}try{e.startsWith("http")&&(e="10."+e.split("/10.")[1])}catch(e){}try{e.startsWith("doi ")&&(e=e.toLowerCase().replace("doi ",""))}catch(e){}try{e=e.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("&")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{e=e.split("#")[0]}catch(e){}try{e=e.replace(/#/g,"%23")}catch(e){}try{e=e.replace(/\,$/,"")}catch(e){}try{e=e.replace(/\.$/,"")}catch(e){}try{e=e.replace(/\)$/,"")}catch(e){}if("string"==typeof e&&e.startsWith("10.")&&!e.includes("@"))return e},t.report.cleandoi._log=!1,v=[],t.report.publishers={_sheet:"1M2s1KBycWI5j7SIfIY0mzfkRC4cYr0HoROP7MR6k3GU"},t.report.orgs={_sheet:r.report.orgs_sheet,_format:async function(e=[],t){var i,r,s,n,a,l,o,u,c,p,h,d;for(u=[],s=0,a=(p="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<a;s++){for(r in o={},c=p[s]){if("string"==typeof c[r])if(c[r]=c[r].trim(),"true"===c[r].toLowerCase())c[r]=!0;else if("false"===c[r].toLowerCase())c[r]=!1;else if(c[r].startsWith("[")&&c[r].endsWith("]")||c[r].startsWith("{")&&c[r].endsWith("}"))try{c[r]=JSON.parse(c[r])}catch(e){i=e,C.log("cant parse "+r,c[r],i)}else c[r].includes(";")&&(c[r]=c[r].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(r.includes("."))try{this.dot(o,r,c[r])}catch(e){}else o[r]=c[r]}if(Array.isArray(o.sheets)){if(!1!==t)for(n=0,l=(h=o.sheets).length;n<l;n++)(d=h[n]).url=await this.encrypt(d.url)}else delete o.sheets;"{}"!==JSON.stringify(o)&&u.push(o)}return 1===u.length?u[0]:u}},t.report.orgs.orgkeys={_index:!0,_auth:"@oa.works"},t.report.orgs.key=async function(e){var t,i;if(null==e&&(e=this.params.org),null!=e){if(e=e.toLowerCase(),null==(i=await this.report.orgs.orgkeys('org.keyword:"'+e+'"',1))||this.refresh){if(null!=i){i.lastRefreshedAt=await this.epoch();try{i.lastRefreshedBy=this.user.email}catch(e){}}else{i={org:e,createdAt:await this.epoch()};try{i.createdBy=this.user.email}catch(e){}}return t=await this.uid(),i.key=await this.encrypt(t),await this.report.orgs.orgkeys(i),t}i.lastRetrievedAt=await this.epoch();try{i.lastRetrievedBy=this.user.email}catch(e){}return await this.report.orgs.orgkeys(i),this.decrypt(i.key)}},t.report.orgs.key._log=!1,t.report.orgs.key._auth="@oa.works",t.report.orgs.supplements={_index:!0,_auth:"@oa.works"},t.report.orgs.supplements.load=async function(e,t,i){var s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ae,Ie,De,Ce;if(je=await this.epoch(),"report.orgs.supplements.load"===this.fn&&null==i&&(i=this.params.clear),i&&await this.report.orgs.supplements(""),null==e&&(e=this.params.org),null==t&&(t=this.params.sheet),q=await this.src.google.sheets(r.report.orgs_sheet),Ie=0,p=[],ge={},Oe=[],ke={},xe=[],!i)for await(Se of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements","replaced:*"))ge[Se.replaced]=Se.DOI;for(h=0,g=(T="object"!=typeof q||Array.isArray(q)?q:[q]).length;h<g;h++){for(a in S={},P=T[h]){if("string"==typeof P[a])if(P[a]=P[a].trim(),"true"===P[a].toLowerCase())P[a]=!0;else if("false"===P[a].toLowerCase())P[a]=!1;else if(P[a].startsWith("[")&&P[a].endsWith("]")||P[a].startsWith("{")&&P[a].endsWith("}"))try{P[a]=JSON.parse(P[a])}catch(e){}else P[a].includes(";")&&(P[a]=P[a].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(a.includes("."))try{await this.dot(S,a,P[a])}catch(e){}else S[a]=P[a]}if(Array.isArray(S.sheets))for(d=0,_=(V=S.sheets).length;d<_;d++)if(we=V[d],!(e&&S.name!==e||t&&we.name!==t)){if(C.log(S.name,we.name,we.url),L=0,A=[],o=[],ve=[],Ce=null==(ie=this.params.update)||ie,f=!1,Ae=[],await this.sleep(1e3),null==this.params.update)try{if(n=await this.src.google.sheets({sheetid:we.url,sheet:"m_admin",headers:!1}),await this.sleep(1e3),Array.isArray(n)&&n.length&&"last updated"===n[0][0].toLowerCase()&&(f=n[0][1])){if([y,O]=f.split(" "),y=y.split("/").reverse().join("-"),f=await this.epoch(y+"T"+O),C.log(S.name,we.name,"last updated",f),"number"==typeof f&&f>15778368e5){if(!(m=ke[we.name])){try{m=await this.report.orgs.supplements('sheets.keyword:"'+we.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=m&&null!=(pe=m.hits)?pe.hits:void 0)&&(m=m.hits.hits[0]._source,ke[we.name]=m)}(null!=m?m.updated:void 0)&&f<=m.updated&&(Ce=f)}}else if(Array.isArray(n)&&n.length){if(!(m=ke[we.name])){try{m=await this.report.orgs.supplements('sheets.keyword:"'+we.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=m&&null!=(he=m.hits)?he.hits:void 0)&&(m=m.hits.hits[0]._source,ke[we.name]=m)}(null!=m?m.updated:void 0)&&m.updated>=je-864e5&&(Ce=!1)}else Ce=!1}catch(e){Ce=!1}if(!0!==Ce)C.log(S.name,we.name,"NOT loading because",f,"is not after",Ce);else{await this.sleep(1e3);try{ve=await this.src.google.sheets({sheetid:we.url,sheet:"Export",headers:!1})}catch(e){}for(De=0;(!Array.isArray(ve)||!ve.length)&&De<5;){await this.sleep(5e3),De+=1;try{ve=await this.src.google.sheets({sheetid:we.url,sheet:"Export",headers:!1})}catch(e){}}if(Array.isArray(ve)&&ve.length){for(k=0,v=(de=ve.shift()).length;k<v;k++)l=de[k],o.push(l.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(j=0,b=ve.length;j<b;j++){for(u in _e=ve[j],L+=1,be={org:S.name,sheets:we.name,ror:S.ror,paid:!0===S.paid?S.paid:void 0},o)if("pmcid"===(a=o[u]).toLowerCase())be[a]=_e[u],be.pmcid="PMC"+_e[u].toLowerCase().replace("pmc","");else if("doi"===a||"DOI"===a)be[a]=_e[u];else{if(c="","apc_cost"===a||"wellcome.apc_paid_actual_currency_excluding_vat"===a||"wellcome.apc_paid_gbp_inc_vat_if_charged"===a||"wellcome.additional_publication_fees_gbp"===a||"wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp"===a||"wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp"===a||"wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"===a)try{c=parseFloat(_e[u])}catch(e){}else c="number"==typeof _e[u]?_e[u]:_e[u]?"true"===(fe=_e[u].trim().toLowerCase())||"yes"===fe||"false"!==(me=_e[u].trim().toLowerCase())&&"no"!==me&&("grant_id"===(ye=a.toLowerCase())||"ror"===ye?_e[u].replace(/\//g,",").replace(/ /g,"").split(","):_e[u]):void 0,"string"==typeof _e[u]&&_e[u].includes(";")&&(c=_e[u].split(";"));null!=c&&""!==c&&(a.includes(".")?await this.dot(be,a,c):be[a]=c)}be.doi?null==be.DOI&&(be.DOI=be.doi+""):be.doi=(null!=(W=be.DOI)?W:"")+"";try{be.DOI.startsWith("http")&&(be.DOI="10."+be.DOI.split("/10.")[1])}catch(e){}try{be.DOI.startsWith("doi ")&&(be.DOI=be.DOI.toLowerCase().replace("doi ",""))}catch(e){}try{be.DOI=be.DOI.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{be.DOI=be.DOI.split(",http")[0]}catch(e){}("string"==typeof be.DOI&&be.DOI.startsWith("10.")&&!be.DOI.includes("@")||be.openalex||be.pmcid)&&(!i&&be.DOI&&null!=ge[be.DOI]&&(be.replaced=be.DOI,be.DOI=ge[be.DOI]),"string"==typeof be.email&&be.email.includes("@")&&(be.email=await this.encrypt(be.email)),be.osdid=(S.name.replace(/[^a-zA-Z0-9-_ ]/g,"")+"_"+we.name+"_"+(null!=(M=null!=(U=be.DOI)?U:be.openalex)?M:be.pmcid)).replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),be._id=be.osdid,A.push(be.osdid),z=null!=(B=null!=(F=be.DOI)?F:be.openalex)?B:be.pmcid,R.call(p,z)<0&&p.push(null!=(J=null!=($=be.DOI)?$:be.openalex)?J:be.pmcid),be.updated=je,Ae.push(be),Ie+=1)}C.log(S.name,we.name,Ae.length,p.length),await this.report.orgs.supplements(Ae)}for await(Se of(await this.sleep(2e3),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'org.keyword:"'+S.name+'" AND sheets.keyword:"'+we.name+'"',{scroll:"30m",include:["osdid","DOI","openalex","pmcid"]})))X=Se.osdid,R.call(A,X)<0&&(await this.report.orgs.supplements(Se.osdid,""),G=null!=(Y=null!=(H=Se.DOI)?H:Se.openalex)?Y:Se.pmcid,R.call(p,G)<0&&p.push(null!=(Z=null!=(K=Se.DOI)?K:Se.openalex)?Z:Se.pmcid))}Oe.push({org:S.name,sheet:we.name,rows:L,update:Ce,supplements:Ae.length}),xe.push(we.name)}}if(!i&&!e&&!t)for(D=0,w=(Q=await this.report.works.suggest("supplements.sheets",void 0,5e3)).length;D<w;D++)if(s=Q[D],R.call(xe,s)<0){for await(Se of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'sheets.keyword:"'+s+'"',{scroll:"30m",include:["osdid"]}))await this.report.orgs.supplements(Se.osdid,"");for await(I of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",'supplements.sheets.keyword:"'+s+'"',{scroll:"30m",include:["DOI","openalex","pmcid"]}))(I.DOI&&(ee=I.DOI,R.call(p,ee)<0)||!I.DOI&&I.openalex&&(te=I.openalex,R.call(p,te)<0)||!I.DOI&&!I.openalex&&I.pmcid&&(re=I.pmcid,R.call(p,re)<0))&&p.push(null!=(se=null!=(ne=I.DOI)?ne:I.openalex)?se:I.pmcid)}if(i)for(N=0,x=(ae=await this.report.works("orgs:* OR supplements.sheets:*",{include:["DOI","openalex","pmcid"]})).length;N<x;N++)((E=ae[N]).DOI&&(le=E.DOI,R.call(p,le)<0)||!E.DOI&&E.openalex&&(oe=E.openalex,R.call(p,oe)<0)||!E.DOI&&!E.openalex&&E.pmcid&&(ue=E.pmcid,R.call(p,ue)<0))&&p.push(null!=(ce=E.DOI)?ce:E.openalex);return await this.sleep(6e4),C.log("report orgs supplements load",Ie,p.length,await this.epoch()-je),p.length&&(C.log("report orgs supplements load ready to call works load",p.length),await this.report.works.load(void 0,void 0,p,void 0,void 0,je,void 0,Oe)),Ie},t.report.orgs.supplements.load._bg=!0,t.report.orgs.supplements.load._async=!0,t.report.orgs.supplements.load._log=!1,t.report.orgs.queries=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g;for await(n of(null==e&&(e=this.params.org),null==t&&(t=null!=(u=this.params.queries)?u:this.params.doi),g={},r=[],a=0,this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs",e?'name:"'+e+'"':"paid:true",{scroll:"30m"})))for(i in null!=(c=n.analysis)?c:[])if(null!=n.analysis[i].query&&(0==(p=!n.analysis[i].make_key)||"false"===p||"False"===p||"FALSE"===p))for await(o of(l=n.analysis[i].query,t&&(l="("+l+') AND  DOI.keyword:"'+t+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",l,{scroll:"30m"})))s=null==(h=n.analysis[i].value)||h,n.analysis[i].list&&(s=[s]),t?g[null!=(d=null!=(f=n.analysis[i].key)?f:n.analysis[i].name)?d:i]=s:(o[null!=(m=null!=(y=n.analysis[i].key)?y:n.analysis[i].name)?m:i]=s,r.push(o),a+=1,r.length>2e4&&(await this.report.works(r),r=[]));return r.length&&await this.report.works(r),t?g:a},t.report.orgs.queries._log=!1,t.report.orgs.queries._bg=!0,t.report.orgs.queries._async=!0,t.report.orgs.queries._auth="@oa.works",t.report.emails={_sheet:r.report.emails_sheet,_key:"doi",_auth:"@oa.works"},t.report.email=async function(e){var t,i,r,s,n,a,l,o,u,c;if((e||this.params.orgkey)&&(null==e&&(e=null!=(n=this.params.email)?n:this.params.doi),null!=e&&(null!=(s=await this.report.works(e))?s.email:void 0))){if(s.email.includes("@"))return s.email;if(c=await this.encrypt(this.params.orgkey),"string"==typeof(null!=(r=await this.report.orgs.orgkeys('key.keyword:"'+c+'"',1))?r.org:void 0)&&r.org.length){for(o=[],t=0,i=(a=s.orgs).length;t<i;t++)u=a[t],o.push(u.toLowerCase());if(l=r.org,R.call(o,l)>=0)return this.decrypt(s.email)}}},t.report.email._log=!1,t.report.works={_index:!0},t.report.works.process=async function(e,t,i,r,s,n,a){var l,o,p,m,y,g,_,b,w,x,O,k,j,S,A,I,D,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ae,Ie,De,Ce,Ee,Re,Ne,Le,Pe,qe,Te,We,Me,Ue,ze,Be,Fe,Je,$e,Xe,Ve,Ge,Ye,He,Ze,Ke,Qe,et,tt,it,rt,st,nt,at,lt,ot,ut,ct,pt,ht,dt,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,At,It,Dt,Ct,Et,Rt,Nt,Lt,Pt,qt,Tt,Wt,Mt,Ut,zt,Bt,Ft,Jt,$t,Xt,Vt,Gt,Yt,Ht,Zt,Kt,Qt,ei,ti,ii,ri,si,ni,ai,li,oi,ui,ci,pi,hi,di,fi,mi,yi,gi,_i,vi,bi,wi,xi,Oi,ki,ji,Si,Ai,Ii,Di,Ci,Ei,Ri,Ni,Li,Pi,qi,Ti,Wi,Mi,Ui,zi,Bi,Fi,Ji,$i,Xi;try{if(Ni=await this.epoch(),null==e&&(e=this.params.process),W=!1,0===i&&(i=!0),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),Ve={},"string"==typeof e&&e.toLowerCase().startsWith("pmc")&&(W=e.toLowerCase().replace("pmc","PMC"),e=void 0,null==t&&(t=await this.src.openalex.works('ids.pmcid:"'+W.toLowerCase().replace("pmc","")+'"',1)),null==t&&(N=await this.src.epmc.pmc(W,i))&&(e=N.doi)),!t&&e&&(e.includes("openalex.org/")||e.startsWith("W"))&&(e.includes("openalex.org/")&&(e=e.split("openalex.org/")[1]),t=e,e=void 0),"string"==typeof t&&((t=(t=t.split(t.includes("doi.org")?"doi.org/":"/").pop()).replace(/\/$/,"")).startsWith("10.")&&(t=t.toLowerCase(),null==e&&(e=t)),t.startsWith("W")||t.startsWith("10.")))try{Ce=t.startsWith("W")?await this.src.openalex.works('id.keyword:"https://openalex.org/'+t+'"'):await this.src.openalex.works.doi(t,null!=(Ge=this.params.refresh_sources)&&Ge);try{(null!=Ce&&null!=(Ye=Ce.hits)&&null!=(at=Ye.hits)?at.length:void 0)&&(Ce=Ce.hits.hits[0]._source)}catch(e){}(null!=Ce?Ce.id:void 0)&&(t=Ce)}catch(e){}if(("object"==typeof t&&(null!=(yt=t.ids)?yt.doi:void 0)||"string"==typeof t&&t.startsWith("10."))&&(Ei=("string"==typeof t?t:t.ids.doi.split(".org/")[1]).toLowerCase(),(null!=(P=await this.report.works(Ei))?P.DOI:void 0)&&P.DOI.toLowerCase()!==Ei&&(P=void 0),((null!=P?P.updated:void 0)||i&&!0!==i&&P&&P.updated<i)&&(i=!0)),"string"!=typeof t||t.startsWith("W")||t.startsWith("10.")||(t=void 0),null==e&&"object"==typeof t&&(null!=t&&null!=(At=t.ids)?At.doi:void 0)&&(e=t.ids.doi),"string"==typeof e&&e.includes("doi.org/")&&(e=e.split("doi.org/").pop()),"string"!=typeof e||e.startsWith("10.")||(e=void 0),"string"==typeof e&&(e=e.toLowerCase()),"string"==typeof e&&(Ji=await this.src.crossref.works.doi(e,null!=(Tt=this.params.refresh_sources)&&Tt))&&(e=Ji),"object"!=typeof e||e.DOI||(e=void 0),null!=e&&null==P&&(P=await this.report.works("string"==typeof e?e:e.DOI)),(null!=P?P.DOI:void 0)&&P.DOI.toLowerCase()!==("string"==typeof e?e:"object"==typeof e&&e.DOI?e.DOI:"").toLowerCase()&&(P=void 0),!0!==i&&(null==P||r||(null!=P.PMCID&&(Ve.PMCID=P.PMCID),null!=P.pubtype&&(Ve.pubtype=P.pubtype),null!=P.tried_epmc_licence&&(Ve.tried_epmc_licence=P.tried_epmc_licence),null!=P.epmc_licence&&(Ve.epmc_licence=P.epmc_licence),null!=P.pmc_has_data_availability_statement&&(Ve.pmc_has_data_availability_statement=P.pmc_has_data_availability_statement),null!=P.data_availability_statement&&(Ve.data_availability_statement=P.data_availability_statement),null!=P.data_availability_url&&(Ve.data_availability_url=P.data_availability_url),null!=P.data_availability_doi&&(Ve.data_availability_doi=P.data_availability_doi)),(!(null!=P?P.updated:void 0)||i&&!0!==i&&P&&P.updated<i)&&(i=!0)),null!=e&&null==t&&(t=await this.src.openalex.works.doi("object"==typeof e?e.DOI:e,null!=(Gt=this.params.refresh_sources)&&Gt)),"string"!=typeof t&&(null!=t?t.id:void 0)||(t=void 0),"object"==typeof e&&e.DOI){for((null!=P?P.updated:void 0)&&(null!=(ni=e.indexed)?ni.timestamp:void 0)&&P.updated<e.indexed.timestamp&&(i=!0),Ve.DOI=e.DOI.toLowerCase(),Ve.published_year=e.year,Ve.published_date=e.published,Ve.issn=e.ISSN,U=0,V=(yi=["subject","subtitle","volume","issue","publisher","funder","subtype","assertion","relation"]).length;U<V;U++)Ve[S=yi[U]]=e[S];for(He=null!=(ki=e.assertion)?ki:[],J=0,G=He.length;J<G;J++)(y=(null!=(Ze=(m=He[J]).label)?Ze:"").toLowerCase()).includes("accepted")&&y.split(" ").length<3&&(null!=(p=await this.dateparts(m.value))?p.date:void 0)&&(p.timestamp?null==Ve.accepted_date&&(Ve.accepted_date=p.date):null==Ve.bad_accepted_date&&(Ve.bad_accepted_date="bad date "+p.date)),y.includes("received")&&(null!=(Ci=await this.dateparts(m.value))?Ci.date:void 0)&&(Ci.timestamp?null==Ve.submitted_date&&(Ve.submitted_date=Ci.date):null==Ve.bad_submitted_date&&(Ve.bad_submitted_date="bad date "+Ci.date));for(Qe=null!=(Ke=Ve.funder)?Ke:[],xe=0,ne=Qe.length;xe<ne;xe++)delete(q=Qe[xe])["doi-asserted-by"];for(e.title&&"string"!=typeof e.title&&e.title.length&&(Ve.title=e.title[0]),e["container-title"]&&e["container-title"].length&&(Ve.journal=e["container-title"][0]),null!=e["reference-count"]&&(Ve["reference-count"]=e["reference-count"]),tt=null!=(et=e.license)?et:[],je=0,he=tt.length;je<he;je++)"am"!==(it=(X=tt[je])["content-version"])&&"vor"!==it&&"tdm"!==it&&"unspecified"!==it||(Ve["crossref_license_url_"+X["content-version"]]=X.URL,(!Ve.publisher_license_crossref||Ve.publisher_license_crossref.length<X.URL.length)&&(Ve.publisher_license_crossref=X.URL));for(Ve.crossref_is_oa=null!=e.is_oa&&e.is_oa,x=[],l=async(t,i)=>(t.DOI=e.DOI,t.replaced=i,await this.report.orgs.supplements(t.osdid,""),t._id=t.osdid=t.osdid.split("_10.")[0]+"_"+t.DOI.replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),x.push(t)),st=null!=(rt=e["update-to"])?rt:[],Ee=0,de=st.length;Ee<de;Ee++)if((Wi=st[Ee]).DOI!==e.DOI&&Wi.type&&"erratum"!==(nt=Wi.type.toLowerCase())&&"correction"!==nt)for await(Li of(Ve.replaces=[],Ve.replaces.push({DOI:Wi.DOI,type:Wi.type,updated:null!=(lt=Wi.updated)?lt.timestamp:void 0}),await this.report.works(Wi.DOI)&&await this.report.works(Wi.DOI,""),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+Wi.DOI+'"')))l(Li,Wi.DOI);x.length&&await this.report.orgs.supplements(x),n&&(null==Ve.replaces&&(Ve.replaces=[]),Ve.replaces.push({DOI:n,type:"relation"}))}if(null!=t){try{(null!=P?P.updated:void 0)&&!t.is_paratext&&!t.is_retracted&&t.updated_date&&P.updated<await this.epoch(t.updated_date)&&(i=!0)}catch(e){}for(Ve.openalx=JSON.parse(JSON.stringify(t)),Je=0,fe=(ot=["topics","primary_topic","keywords","concepts","domains","fields","subfields"]).length;Je<fe;Je++)A=ot[Je],delete Ve.openalx[A];for(Ve.publisher_license_v2=null!=(ut=Ve.openalx.primary_location)?ut.license:void 0,pt=null!=(ct=Ve.openalx.locations)?ct:[],qi=0,me=pt.length;qi<me;qi++)(be=pt[qi]).license&&(!Ve.publisher_license_v2||be.license.length<Ve.publisher_license_v2)&&"journal"===(null!=(ht=be.source)?ht.type:void 0)&&(Ve.publisher_license_v2=be.license),be.license&&(!Ve.repository_license_v2||be.license.length<Ve.repository_license_v2)&&"repository"===(null!=(dt=be.source)?dt.type:void 0)&&(Ve.repository_license_v2=be.license);for(t.id&&(Ve.openalex=t.id.split("/").pop()),Ve.DOI||null==(null!=(ft=t.ids)?ft.doi:void 0)||(Ve.DOI=t.ids.doi.split("doi.org/").pop().toLowerCase()),(null!=(mt=t.ids)?mt.pmid:void 0)&&(Ve.PMID=t.ids.pmid.split("/").pop()),!Ve.PMCID&&(null!=(gt=t.ids)?gt.pmcid:void 0)&&(Ve.PMCID="PMC"+t.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),t.title&&(Ve.title=t.title),Ui=0,ye=(_t=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;Ui<ye;Ui++)Ve[De=_t[Ui]]=t[De];for(t.publication_date&&(Ve.published_date=t.publication_date),t.publication_year&&(Ve.published_year=t.publication_year),(null!=(vt=t.host_venue)?vt.issn:void 0)&&t.host_venue.issn.length&&(Ve.issn=t.host_venue.issn),t.biblio&&(Ve.biblio=t.biblio),t.referenced_works&&(Ve.referenced_works=t.referenced_works.length),wt=null!=(bt=Ve.concepts)?bt:[],Bi=0,ge=wt.length;Bi<ge;Bi++){delete(O=wt[Bi]).wikidata;try{O.score=Math.floor(100*O.score)}catch(e){}}for(Ot=null!=(xt=Ve.authorships)?xt:[],Fi=0,_e=Ot.length;Fi<_e;Fi++){for(jt=null!=(kt=(o=Ot[Fi]).institutions)?kt:[],$i=0,Y=jt.length;$i<Y;$i++)delete jt[$i].type;(null!=(St=o.author)?St.orcid:void 0)&&o.author.orcid.includes("orcid.org/")&&(o.author.orcid_number=o.author.orcid.split("/").pop())}}if(Ve.DOI||"string"!=typeof e||(Ve.DOI=e.toLowerCase()),W&&!Ve.PMCID&&(Ve.PMCID=W),(i||!(null!=P?P.oadoi:void 0))&&Ve.DOI){for(Ve.oadoi=!0,Dt=null!=(It=null!=(Ie=await this.src.oadoi(Ve.DOI))?Ie.oa_locations:void 0)?It:[],Xi=0,H=Dt.length;Xi<H;Xi++)if("publisher"===(we=Dt[Xi]).host_type&&(null==Ve.publisher_license&&(Ve.publisher_license=we.license),null==Ve.publisher_url_for_pdf&&(Ve.publisher_url_for_pdf=we.url_for_pdf),null==Ve.publisher_version&&(Ve.publisher_version=we.version)),"repository"===we.host_type&&(we.url&&we.url.toLowerCase().includes("pmc")&&(Ve.PMCID||(We=we.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(We))&&(Ve.PMCID="PMC"+We),we.license&&!Ve.epmc_licence&&(Ve.epmc_licence=we.license)),!Ve.repository_url||!Ve.repository_url.includes("pmc")||!Ve.repository_url.includes("ncbi.")&&we.url.includes("ncbi.")))for(M=0,Z=(Ct=["license","url_for_pdf","url","version"]).length;M<Z;M++)we[De=Ct[M]]&&(Ve["repository_"+De]=we[De]);Ve.repository_url&&(Ve.repository_url.toLowerCase().includes("europepmc.")||Ve.repository_url.toLowerCase().includes("ncbi."))&&(null==Ve.PMCID&&(Ve.PMCID="PMC"+Ve.repository_url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),Ve.repository_url_in_pmc=!0),null!=Ie&&(Ve.best_oa_location_url=null!=(Et=Ie.best_oa_location)?Et.url:void 0,Ve.best_oa_location_url_for_pdf=null!=(Rt=Ie.best_oa_location)?Rt.url_for_pdf:void 0,Ve.oa_status=Ie.oa_status,Ve.has_repository_copy=Ie.has_repository_copy,Ve.has_oa_locations_embargoed=!(null==Ie.oa_locations_embargoed||!Ie.oa_locations_embargoed.length),Ve.title=Ie.title,!Ve.issn&&"string"==typeof Ie.journal_issns&&Ie.journal_issns.length&&(Ve.issn=Ie.journal_issns.split(",")),null==Ve.journal&&(Ve.journal=Ie.journal_name),null==Ve.publisher&&(Ve.publisher=Ie.publisher),Ie.published_date&&(Ve.published_date=Ie.published_date),Ie.year&&(Ve.published_year=Ie.year),null!=Ie.is_oa&&(Ve.oadoi_is_oa=Ie.is_oa))}if(j=[],Ve.supplements=[],Ve.orgs=[],ke=void 0,Ve.DOI||Ve.openalex||Ve.PMCID)for await(Li of(Ri="",Ve.DOI&&(Ri+='DOI.keyword:"'+Ve.DOI+'"'),Ve.openalex&&(Ri+=(Ri?" OR ":"")+'openalex.keyword:"'+Ve.openalex+'"'),Ve.PMCID&&(Ri+=(Ri?" OR ":"")+'pmcid.keyword:"'+Ve.PMCID+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",Ri,{sort:{"osdid.keyword":"asc"}}))){if(Nt=Li.org,R.call(Ve.orgs,Nt)<0&&Ve.orgs.push(Li.org),Li.paid&&(Ve.paid=!0),!Ve.email&&Li.email&&(Ve.email=Li.email),Li.author_email_name_ic&&(Ve.author_email_name=Li.author_email_name_ic),null!=Li.mturk_has_data_availability_statement&&(ke=Li.mturk_has_data_availability_statement),Li.corresponding_author_ids)for(Lt="string"==typeof Li.corresponding_author_ids?Li.corresponding_author_ids.split(","):Li.corresponding_author_ids,z=0,K=Lt.length;z<K;z++)k=Lt[z],R.call(j,k)<0&&j.push(k);Ve.supplements.push(Li)}for(Wt=null!=(Pt=null!=(qt=Ve.openalx)?qt.corresponding_author_ids:void 0)?Pt:[],F=0,Q=Wt.length;F<Q;F++)k=Wt[F],R.call(j,k)<0&&j.push(k);for(Ve.corresponding_authors=[],zt=null!=(Mt=null!=(Ut=Ve.openalx)?Ut.authorships:void 0)?Mt:[],$=0,ee=zt.length;$<ee;$++)Bt=null!=(Ft=(g=zt[$]).author)?Ft.id:void 0,R.call(j,Bt)>=0&&Ve.corresponding_authors.push(g);if(null!=(null!=(Jt=Ve.openalx)?Jt.authorships:void 0)&&null==Ve.openalx.authors_count&&(Ve.openalx.authors_count=Ve.openalx.authorships.length),null!=P){if(null==i)for(B in!Ve.author_email_name&&P.author_email_name&&P.email&&Ve.email&&Ve.email.toLowerCase()===P.email.toLowerCase()&&(Ve.author_email_name=P.author_email_name),P)"orgs_by_query"!==B&&null==Ve[B]&&(Ve[B]=P[B]);null==Ve.PMCID&&(Ve.PMCID=P.PMCID)}if(null!=Ve.authorships&&Ve.email&&!Ve.author_email_name&&(i||null==(null!=P?P.authorships:void 0)||!(null!=P?P.email:void 0)))if(E=Ve.email.includes("@")?Ve.email:await this.decrypt(Ve.email),1===Ve.authorships.length)Ve.author_email_name="Dr. "+(null!=($t=Ve.authorships[0].author)?$t.display_name:void 0);else{for(ji=E.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),_="",b="",w=1e6,Xt=Ve.authorships,Oe=0,te=Xt.length;Oe<te;Oe++)(Xe=null!=(Vt=Xt[Oe].author)?Vt.display_name:void 0)&&((Di=(await this.levenshtein(ji,Xe.toLowerCase().replace(/[^a-z]/g,""))).distance/Xe.length)<w&&(w=Di,b=Xe),w>.2&&(ji.endsWith(Xe.split(" ").pop().toLowerCase())||Xe.split(" ")[0].length>4&&ji.includes(Xe.split(" ")[0].toLowerCase()))&&(w=.1,b=Xe),!_&&ji.startsWith((Xe.split(" ")[0].slice(0,1)+Xe.split(" ").pop().slice(0,1)).toLowerCase())&&(_=Xe));b&&w<.7&&(Ve.author_email_name="Dr. "+b.split(" ").pop()),!Ve.author_email_name&&_&&(Ve.author_email_name="Dr. "+_)}if("string"==typeof Ve.email&&Ve.email.includes("@")&&(Ve.email=await this.encrypt(Ve.email)),Ve.publisher&&(null!=i||!Ve.publisher_simple)){if(!v.length)for(Ai=await this.report.publishers("*",1e4),Array.isArray(Ai)||null==(null!=Ai&&null!=(Yt=Ai.hits)?Yt.hits:void 0)||(Ai=Ai.hits.hits),Se=0,ie=(Ht=null!=Ai?Ai:[]).length;Se<ie;Se++)Si=Ht[Se],v.push(null!=(Zt=Si._source)?Zt:Si);for(ze=Ve.publisher.toLowerCase(),Ae=0,re=v.length;Ae<re;Ae++)if((Ue=v[Ae]).publisher&&ze.includes(Ue.publisher.toLowerCase())){Ve.publisher_simple=Ue.publisher_display_name;break}}for(Ve.PMCID&&Ve.PMID&&null!=Ve.pubtype&&Ve.submitted_date&&Ve.accepted_date||(Be=Ve.PMID?await this.src.pubmed(Ve.PMID):Ve.DOI?await this.src.pubmed.doi(Ve.DOI):void 0)&&(!Ve.PMCID&&(null!=Be&&null!=(Kt=Be.identifier)?Kt.pmc:void 0)&&(Ve.PMCID="PMC"+Be.identifier.pmc.toLowerCase().replace("pmc","")),!Ve.PMID&&(null!=Be&&null!=(Qt=Be.identifier)?Qt.pubmed:void 0)&&(Ve.PMID=Be.identifier.pubmed),Ve.pubtype=Be.type,null==Ve.submitted_date&&(Ve.submitted_date=null!=(ei=Be.dates)&&null!=(ti=ei.PubMedPubDate_received)?ti.date:void 0),null==Ve.accepted_date&&(Ve.accepted_date=null!=(ii=Be.dates)&&null!=(ri=ii.PubMedPubDate_accepted)?ri.date:void 0)),Ve.DOI&&!Ve.journal_oa_type&&(Ne=await this.permissions(await this.copy(Ve),void 0,void 0,Ie,e,Ni-12096e5),Ve.can_archive=null!=Ne&&null!=(si=Ne.best_permission)?si.can_archive:void 0,null==Ve.can_archive&&((null!=(ai=null!=Ie&&null!=(li=Ie.best_oa_location)?li.license:void 0)?ai:"").includes("cc")||(null!=Ie?Ie.journal_is_in_doaj:void 0))&&(Ve.can_archive=!0),Ve.version=null!=Ne&&null!=(oi=Ne.best_permission)?oi.version:void 0,Ve.journal_oa_type=await this.permissions.journals.oa.type(Ve.issn,void 0,Ie,e),null==Ve.journal_oa_type&&(Ve.journal_oa_type="unsuccessful")),ci=null!=(ui=Ve.orgs)?ui:[],Re=0,se=ci.length;Re<se;Re++)if("fwf austrian science fund"!==(qe=(Pe=ci[Re]).toLowerCase().trim())&&"dutch research council"!==qe&&"national science center"!==qe&&"uk research and innovation"!==qe&&"agencia nacional de investigación y desarrollo"!==qe&&"national natural science foundation of china"!==qe&&"research foundation - flanders"!==qe&&"ministry of business, innovation and employment"!==qe&&"german research foundation"!==qe&&"national cancer institute"!==qe)r=!0;else if(Ve.funder)try{if(qe=qe.replace(/[^a-z ]/g,""),null==f[qe]&&(f[qe]=await this.report.orgs('name.keyword:"'+Pe+'"',1)),null!=(pi=f[qe])?pi.country_code:void 0)for(hi=Ve.funder,Fe=0,ae=hi.length;Fe<ae;Fe++){if((q=hi[Fe]).DOI&&f[qe].fundref)for(di="string"==typeof f[qe].fundref?[f[qe].fundref]:f[qe].fundref,$e=0,le=di.length;$e<le;$e++)if(Te=di[$e],q.DOI.includes(Te)){q.country=f[qe].country_code;break}if(!q.country&&q.name){if(((T=q.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(qe)||qe.includes(T)||(null!=(fi=f[qe].aliases)?fi:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(T)||(null!=(mi=f[qe].acronyms)?mi:"").toLowerCase().includes(T))&&(q.country=f[qe].country_code),!q.country&&f[qe].acronyms)for(gi=f[qe].acronyms.split(","),Ii=0,oe=gi.length;Ii<oe;Ii++)_i=gi[Ii].replace(/[^a-z A-Z]/g,""),R.call(q.name.split(" "),_i)>=0&&(q.country=f[qe].country_code);if(!q.country&&f[qe].aliases)for(vi=f[qe].aliases,Pi=0,ue=vi.length;Pi<ue;Pi++)Le=vi[Pi],T.includes(Le.toLowerCase().replace(/[^a-z ]/g,""))&&(q.country=f[qe].country_code)}}}catch(e){}if((Ve.DOI||Ve.PMCID)&&(null!=N||!Ve.PMCID||null==Ve.pubtype)&&(null!=N||r&&(N=Ve.PMCID?await this.src.epmc.pmc(Ve.PMCID,i):await this.src.epmc.doi(Ve.DOI,i))))for(!Ve.PMCID&&N.pmcid&&(Ve.PMCID=N.pmcid),xi=null!=(bi=null!=(wi=N.pubTypeList)?wi.pubType:void 0)?bi:[],Ti=0,ce=xi.length;Ti<ce;Ti++)Me=xi[Ti],null==Ve.pubtype&&(Ve.pubtype=[]),R.call(Ve.pubtype,Me)<0&&Ve.pubtype.push(Me);if(!r&&null==N||!Ve.PMCID||Ve.epmc_licence||!i&&Ve.tried_epmc_licence||(Ve.tried_epmc_licence=!0,ve=await this.src.epmc.licence(Ve.PMCID,N,void 0,i),Ve.epmc_licence=null!=ve?ve.licence:void 0),null==Ve.pmc_has_data_availability_statement&&(Ve.pmc_has_data_availability_statement=Ve.PMCID&&await this.src.pubmed.availability(Ve.PMCID)),r&&Ve.PMCID&&(i||!Ve.data_availability_statement||!Ve.submitted_date)){if(Ve.data_availability_statement=await this.src.epmc.statement(Ve.PMCID,N,i),Ve.data_availability_statement&&(Mi=await this.src.epmc.statement.url(Ve.PMCID,N,Ve.data_availability_statement)))for(zi=0,pe=Mi.length;zi<pe;zi++)(I=Mi[zi]).includes("doi.org/")?(D=I.split("doi.org/")[1].toLowerCase(),null==Ve.data_availability_doi&&(Ve.data_availability_doi=[]),R.call(Ve.data_availability_doi,D)<0&&Ve.data_availability_doi.push(D)):(null==Ve.data_availability_url&&(Ve.data_availability_url=[]),R.call(Ve.data_availability_url,I)<0&&Ve.data_availability_url.push(I));null==Ve.submitted_date&&(Ve.submitted_date=await this.src.epmc.submitted(Ve.PMCID,N))}return Ve.is_oa=Ve.oadoi_is_oa||Ve.crossref_is_oa||"gold"===Ve.journal_oa_type,Ve.has_data_availability_statement=!!(Ve.pmc_has_data_availability_statement||ke||Ve.DOI&&(Ve.DOI.startsWith("10.1186")||Ve.DOI.startsWith("10.12688")||Ve.DOI.startsWith("10.1371")))||(null!=(Oi=Ve.pmc_has_data_availability_statement)?Oi:ke),null==Ve._id&&(Ve._id=Ve.DOI?Ve.DOI.toLowerCase().replace(/\//g,"_"):Ve.openalex?Ve.openalex.toLowerCase():Ve.PMCID?Ve.PMCID.toLowerCase():void 0),Ve.supplemented=await this.epoch(),Ve.updated=Ve.supplemented,Ve.took=Ve.supplemented-Ni,Ve.supplemented_date=await this.datetime(Ve.supplemented),Ve.updated_date=await this.datetime(Ve.updated),this.params.process&&!1!==this.params.save&&(Ve.DOI&&Ve.DOI.toLowerCase()===this.params.process.toLowerCase()||Ve.openalex&&Ve.openalex.toLowerCase()===this.params.process.toLowerCase()||Ve.PMCID&&Ve.PMCID.toLowerCase()===this.params.process.toLowerCase())?await this.report.works(Ve):a&&(u.push(a.toLowerCase()),null!=Ve._id&&c.push(Ve),d.splice(d.indexOf(a),1)),Ve}catch(t){L=t,C.log("report works process error",L,"object"==typeof e?e.DOI:e),a&&(await this.sleep(3e3),d.splice(d.indexOf(a),1),null==h[a]&&(h[a]=0),h[a]+=1,4!==h[a]?this.report.queue(a,void 0,i,r,s):delete h[a])}},t.report.works.process._log=!1,t.report.works.load=async function(e,t,i,r,s,n,a,l){var o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,E,R,N,L,P;if(D=await this.epoch(),null==r&&(r=null!=(m=this.params.load)?m:(await this.date()).split("-")[0]),null==t&&(t=null!=(y=null!=(x=this.params.org)?x:this.params.orgs)?y:"orgs"===this.params.load),null==i&&"string"==typeof this.params.load&&(this.params.load.startsWith("10.")||this.params.load.toLowerCase().startsWith("pmc")||this.params.load.toLowerCase().startsWith("w"))&&(i=this.params.load),"string"==typeof i&&(i=[i]),this.fn.startsWith("report.works.load")&&null==s&&(s=this.params.clear),I=this.refresh,null==a&&(a=null!=(O=this.params.everything)?O:"everything"===this.params.load),P=0,this.params.q){for await(R of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",this.params.q,{scroll:"5m",include:["DOI","openalex","PMCID"]})))i.push(null!=(k=null!=(j=R.DOI)?j:R.openalex)?k:R.PMCID),i.length%1e3==0&&C.log("report works preparing to load from query",i.length);C.log("report works supplements to load from query",this.params.q)}else if("supplements"===this.params.load){for await(E of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",e?"updated:<"+e:t?'org:"'+t+'"':void 0,{scroll:"5m",include:["DOI","openalex","pmcid"]})))i.push(null!=(S=null!=(A=E.DOI)?A:E.openalex)?S:E.pmcid);C.log("report works supplements to load",e,t,i.length)}else if(a){for await(E of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","NOT pmc_has_data_availability_statement:*",{scroll:"5m",include:["DOI","openalex","PMCID"]})))i.push(null!=(g=null!=(_=E.DOI)?_:E.openalex)?g:E.PMCID);C.log("report works supplements to load everything for records that do not yet have everything",i.length)}if(Array.isArray(i))C.log("report works queueing identifiers batch",i.length),await this.report.queue(i,void 0,null!=e?e:I,a),P+=i.length;else{for await(f of(o=async(i,s)=>{var n,l,o;for await(n of(null==i&&(i="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+r),e&&(i="("+i+") AND srcday:>"+e),l=await this.src.crossref.works.count(i),C.log("report works load crossref by query expects",i,l),o=[],this.index._for("src_crossref_works",i,{include:["DOI"],scroll:"30m"})))t||r!==this.params.load||!await this.report.works(n.DOI)?(P+=1,o.push(await this.report.queue(n.DOI,void 0,null!=e?e:I,a,s))):o.push(void 0);return o},!0!==t&&r===this.params.load&&await o(void 0,"years"),u=async(i,s)=>{var n,l,o,u,c;for await(n of(null==i&&(i="authorships.institutions.display_name:* AND publication_year:"+r),e&&(i="("+i+") AND updated_date:>"+e),o=await this.src.openalex.works.count(i),C.log("report works load openalex by query expects",i,o),c=[],this.index._for("src_openalex_works",i,{include:["id","ids"],scroll:"30m"})))(l=(null!=(u=n.ids)?u.doi:void 0)?"10."+n.ids.doi.split("/10.")[1]:n.id.split("openalex.org/").pop())?!t&&r===this.params.load&&l.startsWith("10.")&&await this.report.works(l)?c.push(void 0):(P+=1,c.push(await this.report.queue(l,void 0,null!=e?e:I,a,s))):c.push(void 0);return c},!0!==t&&r===this.params.load&&await u(void 0,"years"),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs","string"==typeof t?'name:"'+t+'"':"paid:true",{scroll:"10m"}))){if(null!=(v=f.source)?v.crossref:void 0){try{f.source.crossref.includes("%")&&(f.source.crossref=decodeURIComponent(decodeURIComponent(f.source.crossref)))}catch(e){}C.log("report works load crossref by org",f.name,f.source.crossref),await o(f.source.crossref)}if(null!=(b=f.source)?b.openalex:void 0){try{f.source.openalex.includes("%")&&(f.source.openalex=decodeURIComponent(decodeURIComponent(f.source.openalex)))}catch(e){}C.log("report works load openalex by org",f.name,f.source.openalex),await u(f.source.openalex)}}if(e)for await(c of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs:* AND updated:<"+e,{scroll:"10m"}))await this.src.crossref.works.count('DOI.keyword:"'+c.DOI+'" AND srcday:>'+e)&&await this.report.queue(c.DOI,void 0,null!=e?e:I,a)}for(L=await this.epoch()-D,N="Report works queued "+P+(this.S.dev?" (dev)":"")+"\n",i&&i.length&&(N+=i.length+" identifiers were provided to process\n"),this.params.q&&(N+="These were derived by searching for provided query"+JSON.stringify(this.params.q)+"\n"),"supplements"===this.params.load&&(N+="These were derived by searching for all works that already have supplements attached\n"),a&&!this.params.q&&(N+="These were derived by searching for all works that have not yet had everything fully processed\n"),n&&(N+="These were provided by an orgs supplements refresh which took "+Math.ceil((D-n)/1e3/60)+"m\n"),"string"==typeof t&&(N+="The load process was "+(this.params.q?"matched":"limited")+" to "+t+"\n"),e&&(N+="The load process was run for changes since "+await this.datetime(e)+"\n"),!r||"string"==typeof t||!this.params.load&&e||(null!=i?i:[]).length||(N+="The load process was run for year "+r+"\n"),h=0,d=(w=null!=l?l:[]).length;h<d;h++)p=w[h],N+="\n"+JSON.stringify(p)+"\n";return C.log("Report works loaded",P,L),await this.mail({to:["mark+notifications@oa.works","joe+notifications@oa.works"],subject:"OA report works loaded "+P,text:N}),P},t.report.works.load._log=!1,t.report.works.load._bg=!0,t.report.works.load._async=!0,t.report.works.load._auth="@oa.works",t.report.works.changes=function(e,t){var i,r;return null==e&&(e=null!=(i=null!=(r=this.params.changes)?r:this.params.timestamp)?i:Date.now()-9e7),null==t&&(t=this.params.org),this.report.works.load(e,t),!0},t.report.works.changes._log=!1,t.report.works.changes._bg=!0,t.report.works.changes._async=!0,t.report.works.changes._auth="@oa.works",t.report.removeobq=async function(){var e,t,i,r;for await(t of(e=0,this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs_by_query:*",{scroll:"30m",include:["DOI","openalex","PMCID"]})))e+=1,this.report.queue(null!=(i=null!=(r=t.DOI)?r:t.openalex)?i:t.PMCID,void 0,!0),e%100==0&&C.log("fix orgs by query",e);return C.log("fix orgs by query completed with",e),e},t.report.removeobq._bg=!0,t.report.removeobq._async=!0,t.report.removeobq._auth="@oa.works",t.report.fixsupps=async function(){var e,t,i;for await(t of(e=0,i=0,this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements","byquery:*")))e+=1,await this.report.orgs.supplements(t._id,""),i+=1;return C.log("fix supps completed with",e,i),e},t.report.fixsupps._bg=!0,t.report.fixsupps._async=!0,t.report.fixsupps._auth="@oa.works",R=[].indexOf,t.oareport=function(){return"OA.Works OA.report"},t.oareport.works={_index:!0},t.oareport.orgs={_sheet:"1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data",_format:async function(e=[]){var t,i,r,s,n,a,l,o,u,c,p,h;for(o=[],r=0,s=(c="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<s;r++){for(i in l={},u=c[r]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(e){t=e,C.log("cant parse "+i,u[i],t)}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(l,i,u[i])}catch(e){}else l[i]=u[i]}if(Array.isArray(l.sheets))for(a=0,n=(p=l.sheets).length;a<n;a++)(h=p[a]).url=await this.encrypt(h.url);else delete l.sheets;"{}"!==JSON.stringify(l)&&o.push(l)}return 1===o.length?o[0]:o}},b=new Map,t.oareport.duplicates=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,w,x,O,k,j,S,A,I,D,E,N,L,P,q,T,W,M,U,z,B,F,J,$;if(null==i&&(i=Date.now()),null==e&&(e=null!=(k=this.params.duplicates)?k:this.params.doi),e=e.toLowerCase(),n=b.get(e))(t=n).memory=!0;else{for(l=["DOI","update-to.DOI"],o=0,u=(M=["is-same-as","is-version-of","has-version"]).length;o<u;o++)x=M[o],l.push("relation."+x+".id");for(w=l.join(':"'+e+'" OR ')+':"'+e+'"',null==t&&(t={original:e,doi:e,duplicates:[],count:0,cascades:0,timestamp:void 0,record:void 0,recs:{}}),W=[],a=!0,m=0,c=(z=null!=(j=null!=(U=await this.src.crossref.works(w,{size:1e4,sort:{"indexed.timestamp":"asc"}}))&&null!=(I=U.hits)?I.hits:void 0)?j:[]).length;m<c;m++){if(($=z[m]._source).DOI=$.DOI.toLowerCase(),t.recs[$.DOI]=$,null!=$["update-to"]){for(D=$.DOI,R.call(t.duplicates,D)<0&&t.duplicates.push($.DOI),y=0,p=(E=$["update-to"]).length;y<p;y++)(J=E[y]).DOI&&(J.DOI=J.DOI.toLowerCase(),N=J.DOI,R.call(t.duplicates,N)<0&&t.duplicates.push(J.DOI),(O=t.duplicates.length)&&O>1&&t.duplicates[O-1].substring(0,t.duplicates[O-1].length-3)!==t.duplicates[O-2].substring(0,t.duplicates[O-2].length-3)&&(a=!1));t.timestamp=$.indexed.timestamp,t.doi=$.DOI}t.duplicates.length&&a&&(t.doi=t.duplicates.sort()[t.duplicates.length-1]),null!=$.relation&&"preprint"!==$.subtype&&W.push($)}if(t.doi&&t.doi!==e&&null==t.recs[t.doi])return C.log("oareport duplicates looping",e,t.doi,t.original,t.cascades),t.cascades+=1,this.oareport.duplicates(t.doi,t,i);for(_=0,h=W.length;_<h;_++)for($=W[_],B=0,d=M.length;B<d;B++)for(v=M[B],F=0,f=(q=null!=(L=null!=(P=$.relation)?P[v]:void 0)?L:[]).length;F<f;F++)s=q[F],T=$.DOI,R.call(t.duplicates,T)<0&&t.duplicates.push($.DOI),t.recs[$.DOI]=$,"string"==typeof(null!=s?s.id:void 0)&&s.id.startsWith("10.")&&(s.id=s.id.toLowerCase(),S=s.id,R.call(t.duplicates,S)<0&&(t.duplicates.push(s.id),s.id.includes(t.doi)?(t.doi=s.id,null!=t.recs[t.doi]&&(t.timestamp=t.recs[t.doi].indexed.timestamp)):t.doi.substring(0,t.doi.length-3)===s.id.substring(0,s.id.length-3)&&(g=[t.doi,s.id].sort()[1])&&g!==t.doi?(t.doi=g,null!=t.recs[t.doi]&&(t.timestamp=t.recs[t.doi].indexed.timestamp)):s.id!==e&&(r=await this.src.crossref.works(s.id))&&(r.DOI=r.DOI.toLowerCase(),t.recs[s.id]=r,r.indexed.timestamp>$.indexed.timestamp&&r.indexed.timestamp>(null!=(A=t.timestamp)?A:0)&&(t.timestamp=r.indexed.timestamp,t.doi=s.id))));null==t.record&&(t.record=t.recs[t.doi]),t.count+=Object.keys(t.recs).length,delete t.recs}return t.memory||b.set(t.original,{doi:t.doi}),t.took=Date.now()-i,t},t.oareport.orgs.analysis=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y;for("string"==typeof e?(o=e,e=[]):"object"==typeof e&&(e=[e]),null!=e&&0!==e.length||(null==o&&(o=this.params.org),e=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")),r={},s=0,n=e.length;s<n;s++)if(l=e[s],!o||l.name===o)for(i in!1!==t&&(l=await this.report.orgs._format(l,!1)),null!=(p=l.analysis)?p:{})if(l.analysis[i].query&&!1!==(h=l.analysis[i].make_key)&&"false"!==h&&"False"!==h&&"FALSE"!==h)for await(u of(C.log("report orgs anaysing by query",l.name,i),await this.oareport.works._for(decodeURIComponent(l.analysis[i].query))))null==r[a=u.DOI]&&(r[a]=u),await this.dot(r[u.DOI],null!=(d=null!=(f=l.analysis[i].key)?f:l.analysis[i].name)?d:i,l.analysis[i].list?[null==(m=l.analysis[i].value)||m]:null==(y=l.analysis[i].value)||y);return(c=Object.values(r))&&c.length&&await this.oareport.works(c),c.length},t.oareport.orgs.supplement=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y;for(this.params.empty&&await this.oareport.works(""),m=await this.epoch(),await this.datetime(m),null==e&&(e=this.params.org),null==t&&(t=this.params.sheet),null==i&&(i=this.params.analysis),s=[],y=0,r=async(e,t,i)=>{var r,a,l,o,u,c,p,h,d,y,g,_,v,b,w,x,O,k,j,S,A,I,D,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z;if(C.log(i.name,t.name,e,"of",f.length,t.url),Z=null==(L=null!=(P=this.params.update)?P:this.params.empty)||L,_=!1,null==this.params.update&&!this.params.empty)try{for(a=!1,o=0;!1===a&&o<5;){o++;try{a=await this.src.google.sheets({sheetid:t.url,sheet:"m_admin",headers:!1})}catch(e){await this.sleep(5e3)}}if("last updated"===a[0][0].toLowerCase()&&(_=a[0][1])&&([b,O]=_.split(" "),_=await this.epoch(b.split("/").reverse().join("-")+"T"+O)),"number"==typeof _&&_>15778368e5){try{v=await this.oareport.works('supplements.sheets.keyword:"'+t.name+'"',{size:1,sort:{"supplements.updated":"desc"}})}catch(e){}null!=(null!=v&&null!=(M=v.hits)?M.hits:void 0)&&(v=v.hits.hits[0]._source),(null!=v&&null!=(U=v.meta)?U.updated:void 0)&&_<=v.meta.updated&&(Z=_)}}catch(e){Z=!1}if(!0===Z){for(G=!1,H=0;!Array.isArray(G)&&H<5;){H++;try{G=await this.src.google.sheets({sheetid:t.url,sheet:"Export",headers:!1})}catch(e){await this.sleep(5e3)}}if(Array.isArray(G)&&G.length){if(!this.params.empty)for await(D of await this.oareport.works._for('DOI:* AND supplements.sheets.keyword:"'+t.name+'"')){for(null==n[j=D.DOI]&&(n[j]=D),l=[],g=0,w=(z=n[D.DOI].supplements).length;g<w;g++)(I=z[g]).sheets!==t.name&&l.push(I);n[D.DOI].supplements=l}for(s.push(i.name),p=[],k=0,x=(B=G.shift()).length;k<x;k++)c=B[k],p.push(c.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(E in u=["apc_cost","wellcome.apc_paid_actual_currency_excluding_vat","wellcome.apc_paid_gbp_inc_vat_if_charged","wellcome.additional_publication_fees_gbp","wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"],C.log(i.name,t.name,G.length,"rows"),X=[],G){for(d in V=G[E],Y={updated:m,org:i.name,sheets:t.name,ror:i.ror?"string"==typeof i.ror?i.ror.split(";"):i.ror:void 0,paid:!!i.paid||void 0},p)if("pmcid"===(h=p[d].toLowerCase())||"openalex"===h)Y[h.toUpperCase()]="pmcid"===h?"PMC"+V[d].toLowerCase().replace("pmc",""):V[d];else try{y=R.call(u,h)>=0?parseFloat(V[d]):"number"==typeof V[d]?V[d]:V[d]?"true"===(F=V[d].trim().toLowerCase())||"yes"===F||"false"!==(J=V[d].trim().toLowerCase())&&"no"!==J&&("grant_id"===h||"ror"===h?V[d].replace(/\//g,",").replace(/ /g,"").split(","):V[d]):void 0,"string"==typeof V[d]&&V[d].includes(";")&&(y=V[d].replace(/; /g,";").replace(/ ;/g,";").trim().split(";")),null!=y&&""!==y&&await this.dot(Y,p[d],y)}catch(e){}(Y.DOI||Y.doi)&&(Y.DOI=await this.report.cleandoi(null!=($=Y.DOI)?$:Y.doi)),Y.OPENALEX&&!Y.DOI&&(S=await this.src.openalex.works('ids.openalex.keyword:"https://openalex.org/'+Y.OPENALEX+'"',1))&&(null!=(q=S.ids)?q.doi:void 0)&&(Y.DOI=S.ids.doi.split("doi.org/").pop()),(r=null!=(T=null!=(W=Y.DOI)?W:Y.OPENALEX)?T:Y.PMCID)&&(null==n[r]&&(n[r]={supplements:[]}),n[r].supplements.push(Y),(A=await this.oareport.works.process(r,i,void 0,this.refresh,n[r]))&&(n[r]=A)),(N=parseInt(E))&&N%1e3==0?X.push(C.log(i.name,t.name,e,"of",f.length,"row",E,"of",G.length,Date.now()-m)):X.push(void 0)}return X}}},a=0,l=(c=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")).length;a<l;a++)if(o=c[a],!e||o.name===e){for(h in o=await this.report.orgs._format(o,!1),n={},d=[],f=Array.isArray(o.sheets)?o.sheets:"string"==typeof o.sheets?o.sheets.replace(/; /g,";").replace(/ ;/g,";").trim().split(";"):[])t&&f[h].name!==t||i||(await this.sleep(5e3),d.push(r(h,f[h],o)));await Promise.all(d),await this.oareport.works(Object.values(n)),y+=u=Object.keys(n).length,C.log("report orgs supplemented",o.name,u,y,Date.now()-m),!1!==i&&o.paid&&(p=o.name,R.call(s,p)>=0)&&await this.oareport.orgs.analysis(o,!1)}return C.log("report orgs supplement "+(!1!==i?"and analysis ":"")+"complete",y,Date.now()-m),y},t.oareport.orgs.supplement._async=!0,t.oareport.orgs.supplement._log=!1,t.oareport._funder_country=function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j;if(null!=t?t.country_code:void 0)for(s=0,n=(g=null!=(y=e.funder)?y:[]).length;s<n;s++){if((i=g[s]).id){if(t.fundref)for(c=0,a=(_="string"===t.fundref?[t.fundref]:t.fundref).length;c<a;c++)if(m=_[c],i.id.includes(m)){i.country=t.country_code;break}if(!i.country&&t.openalex_funder_id)for(p=0,l=(v="string"===t.openalex_funder_id?[t.openalex_funder_id]:t.openalex_funder_id).length;p<l;p++)if(h=v[p],i.id.includes(h)){i.country=t.country_code;break}}if(!i.country&&i.name){if(((r=i.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(port)||port.includes(r)||(null!=(b=t.aliases)?b:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(r)||(null!=(w=t.acronyms)?w:"").toLowerCase().includes(r))&&(i.country=t.country_code),!i.country&&t.acronyms)for(d=0,o=(x=t.acronyms.split(",")).length;d<o;d++)O=x[d].replace(/[^a-z A-Z]/g,""),R.call(i.name.split(" "),O)>=0&&(i.country=t.country_code);if(!i.country&&t.aliases)for(j=0,u=(k=t.aliases).length;j<u;j++)f=k[j],r.includes(f.toLowerCase().replace(/[^a-z ]/g,""))&&(i.country=t.country_code)}}return e},t.oareport._author_display_name=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y;if(a=e.outreach.email_address.includes("@")?e.outreach.email_address:await this.decrypt(e.outreach.email_address),(null!=(c=e.openalex)?c.authorships:void 0)&&1===e.openalex.authorships.length&&(i=null!=(p=e.openalex.authorships[0].author)?p.display_name:void 0))e.outreach.author_display_name="Dr. "+i;else{for(f=a.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),r="",s="",t="",n=1e6,l=0,o=(h=e.openalex.authorships).length;l<o;l++)(u=null!=(d=(m=h[l]).author)?d.display_name:void 0)&&((y=(await this.levenshtein(f,u.toLowerCase().replace(/[^a-z]/g,""))).distance/u.length)<n&&(n=y,s=u),n>.2&&(f.endsWith(u.split(" ").pop().toLowerCase())||u.split(" ")[0].length>4&&f.includes(u.split(" ")[0].toLowerCase()))&&(n=.1,s=u),!r&&f.startsWith((u.split(" ")[0].slice(0,1)+u.split(" ").pop().slice(0,1)).toLowerCase())&&(r=u),!t&&m.author.is_corresponding&&(t=u));e.outreach.author_display_name="Dr. "+(s&&n<.7?s.split(" ").pop():r||t||i)}return e},t.oareport._process_sups=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y;for(m in e.supplements){y=e.supplements[m],(null!=t?t.name:void 0)&&!JSON.stringify(e.first_seen).includes(t.name)&&e.first_seen.push({org:t.name,date:i}),y.email&&!e.outreach.email_address&&(e.outreach.email_address=y.email),"string"==typeof y.email&&y.email.includes("@")&&(e.supplements[m].email=await this.encrypt(y.email)),y.author_email_name_ic&&!e.outreach.author_display_name&&(e.outreach.author_display_name=y.author_email_name_ic);try{for(p="string"==typeof y.corresponding_author_ids?y.corresponding_author_ids.split(","):null!=(c=y.corresponding_author_ids)?c:[],a=0,l=p.length;a<l;a++)r=p[a],R.call(e.corresponding_author_ids,r)<0&&e.corresponding_author_ids.push(r)}catch(e){}for(!y.publisher_license_ic||"cc-by"!==(h=y.publisher_license_ic)&&"cc0"!==h||(e.is_open_access=!0),(!0===y.is_free_ic||e.is_open_access)&&(e.is_free_to_read=!0),y.mturk_has_data_availability_statement&&(e.data_availability_statement.has_data_availability_statement=!0,e.data_availability_statement.source="oareport"),u=0,o=(d=["category","accession_number","doi","url"]).length;u<o;u++)y["data_availability_statement_"+(s=d[u])]&&(e.data_availability_statement[s]=y["data_availability_statement_"+s]);for(n in y)null!=e[n]&&"object"!=typeof e[n]&&"DOI"!==n&&"corresponding_author_ids"!==n&&"paid"!==n&&"email"!==n&&(e[n]="NULL"===y[n]?void 0:y[n])}try{(null!=(f=e.openalex)?f.authorships:void 0)&&e.outreach.email_address&&!e.outreach.author_display_name&&(e=await this.oareport._author_display_name(e))}catch(e){}return e},t.oareport.works.process=async function(e,t,i,r,s,n=24192e5){var a,l,o,u,c,p,h,d,f,m,y,g,_,b,w,x,O,k,j,S,A,I,D,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ae,Ie,De,Ce,Ee,Re,Ne,Le,Pe,qe,Te,We,Me,Ue,ze,Be,Fe,Je,$e,Xe,Ve,Ge,Ye,He,Ze,Ke,Qe,et,tt,it,rt,st,nt,at,lt,ot,ut,ct,pt,ht,dt,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,At,It,Dt,Ct,Et,Rt,Nt,Lt,Pt,qt,Tt,Wt,Mt,Ut;try{if(Nt=await this.epoch(),k=await this.datetime(Nt),(!0===t||null==t&&this.params.paid)&&(t={paid:!0}),Array.isArray(s)&&(s={supplements:s}),null==r&&"oareport.works.process"===this.fn&&(r=this.refresh),pe={is_free_to_read:!1,is_open_access:!1,supplements:[],corresponding_authorships:[],corresponding_author_ids:[],meta:{},first_seen:[],outreach:{},data_availability_statement:{}},null==e&&(e=this.params.process),"string"==typeof e){if(e.startsWith("10.")&&(y=await this.oareport.duplicates(e))&&y.doi!==e){try{y.memory||this.oareport.works(e,"")}catch(e){}pe.meta.replaced=e,e=y.doi}if((e=e.toLowerCase().split(".org/").pop().replace(/\/$/,"")).startsWith("pmc")){pe.PMCID=e.toUpperCase();try{ie=await this.src.openalex.works('ids.pmcid:"'+e.replace("pmc","")+'"',1)}catch(e){}}else if(e.startsWith("10.")&&(pe.DOI=e),r||!(null!=s?s.openalex:void 0)||Nt-(null!=(he=null!=s?s.meta.updated:void 0)?he:0)>n){try{ie=e.startsWith("w")?await this.src.openalex.works('id.keyword:"https://openalex.org/'+e+'"',1):await this.src.openalex.works(e)}catch(e){}try{null==pe.DOI&&(pe.DOI=ie.ids.doi.split("doi.org/").pop())}catch(e){}try{null==pe.PMCID&&(pe.PMCID="PMC"+ie.ids.pmcid.split("/").pop().toLowerCase().replace("pmc",""))}catch(e){}}}if(pe._id=pe.DOI?pe.DOI.toLowerCase().replace(/\//g,"_"):(null!=ie?ie.id:void 0)?ie.id.split(".org/").pop().toLowerCase():pe.PMCID?pe.PMCID.toLowerCase():void 0,((null!=s?s._id:void 0)||pe._id&&(s=await this.oareport.works(pe._id)))&&(pe=s),null==(null!=s?s.supplements:void 0)||s._id||(pe.supplements=s.supplements),!r&&Nt-(null!=(de=null!=s?s.meta.updated:void 0)?de:0)>n&&(r=!0),(null!=t?t.paid:void 0)&&(pe.meta.paid=t.paid),null!=ie?ie.id:void 0){for(pe.openalex={},D=0,N=(Oe=["abstract","apc_list","apc_paid","authorships","authors_count","best_oa_location","biblio","cited_by_count","concepts","countries_distinct_count","corresponding_author_ids","created_date","display_name","doi","domains","fields","has_fulltext","id","ids","is_paratext","is_retracted","keywords","language","mesh","open_access","primary_location","publication_date","publication_year","referenced_works_count","sustainable_development_goals","title","type","type_crossref","updated","updated_date"]).length;D<N;D++)K=Oe[D],pe.openalex[K]=ie[K];for($e=null!=(Le=ie.grants)?Le:[],H=0,L=$e.length;H<L;H++)O=$e[H],null==pe.funder&&(pe.funder=[]),pe.funder.push({award:(null!=(it=O.award_id)?it:"").replace(/, /g,",").split(","),display_name:O.funder_display_name,source:"openalex",id:O.funder});for(kt=null!=(dt=ie.locations)?dt:[],Q=0,U=kt.length;Q<U;Q++)if((G=kt[Q]).license&&(Y=G.license.toLowerCase())&&("pd"!==Y&&"public-domain"!==Y&&"cc0"!==Y&&"cc-by"!==Y||(pe.is_open_access=!0)),(null!=(Ct=G.source)?Ct.is_in_doaj:void 0)&&(null==pe.syp_permissions&&(pe.syp_permissions={}),pe.syp_permissions.can_archive=!0,pe.syp_permissions.archivable_version=G.version),"journal"===(null!=(Et=G.source)?Et.type:void 0)&&G.license&&(!pe.publisher_license||G.license.length<pe.publisher_license)&&"publishedVersion"===G.version)pe.publisher_license=G.license,pe.publisher_url_for_pdf=G.pdf_url,pe.publisher_version=G.version;else if("repository"===(null!=(fe=G.source)?fe.type:void 0)&&(G.license&&(!pe.repository_license||G.license.length<pe.repository_license)&&(pe.repository_license=G.license),G.landing_page_url&&G.landing_page_url.toLowerCase().includes("pmc")&&(pe.PMCID||(ae=G.landing_page_url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(ae))&&(pe.PMCID="PMC"+ae),G.license&&!pe.epmc_licence&&(pe.epmc_licence=G.license)),!pe.repository_url||!pe.repository_url.includes("pmc")||!pe.repository_url.includes("ncbi.")&&G.landing_page_url&&G.landing_page_url.includes("ncbi.")))for(re=0,z=(me=["license","pdf_url","landing_page_url","version"]).length;re<z;re++)G[te=me[re]]&&(pe["repository_"+te]=G[te]);for(pe.repository_url&&(pe.repository_url.toLowerCase().includes("europepmc.")||pe.repository_url.toLowerCase().includes("ncbi."))&&(null==pe.PMCID&&(pe.PMCID="PMC"+pe.repository_url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),pe.repository_url_in_pmc=!0),(null!=(ye=ie.ids)?ye.pmid:void 0)&&(pe.PMID=ie.ids.pmid.split("/").pop()),delete ie.ids,(null!=(ge=ie.open_access)?ge.is_oa:void 0)&&(pe.is_free_to_read=!0),ve=null!=(_e=pe.openalex.concepts)?_e:[],Lt=0,B=ve.length;Lt<B;Lt++){delete(h=ve[Lt]).wikidata;try{h.score=Math.floor(100*h.score)}catch(e){}}for(we=null!=(be=ie.corresponding_author_ids)?be:[],Pt=0,F=we.length;Pt<F;Pt++)d=we[Pt],R.call(pe.corresponding_author_ids,d)<0&&pe.corresponding_author_ids.push(d);for(ke=null!=(xe=pe.openalex.authorships)?xe:[],Tt=0,J=ke.length;Tt<J;Tt++){for(Se=null!=(je=(a=ke[Tt]).institutions)?je:[],Wt=0,$=Se.length;Wt<$;Wt++)delete Se[Wt].type;(null!=(Ae=a.author)?Ae.orcid:void 0)&&a.author.orcid.includes("orcid.org/")&&(a.author.orcid_number=a.author.orcid.split("/").pop()),Ie=null!=(De=a.author)?De.id:void 0,R.call(pe.corresponding_author_ids,Ie)>=0&&pe.corresponding_authorships.push(a)}}if((pe=await this.oareport._process_sups(pe,t,k)).meta.paid&&(r||!(null!=s?s.meta.paid:void 0)||!(null!=(Ce=pe.syp_permissions)?Ce.journal_oa_type:void 0))){if(S=[],pe.DOI&&(null==ie||!ie.grants||r&&!pe.meta.checked_crossref&&(!pe.subtype||!pe.accepted_date||!pe.submitted_date))&&(null!=i?i:i=await this.src.crossref.works(pe.DOI))){if(i.ISSN&&(S=i.ISSN),i.is_oa&&(pe.is_free_to_read=!0),"preprint"===i.subtype&&(pe.subtype="preprint"),pe.meta.checked_crossref=Nt,!pe.submitted_date||!pe.accepted_date)for(Re=null!=(Ee=i.assertion)?Ee:[],Mt=0,X=Re.length;Mt<X;Mt++)((u=(null!=(Ne=(o=Re[Mt]).label)?Ne:"").toLowerCase()).includes("accepted")&&u.split(" ").length<3||u.includes("received"))&&(null!=(l=await this.dateparts(o.value))?l.date:void 0)&&l.timestamp&&null==pe[ee=(u.includes("received")?"submitted":"accepted")+"_date"]&&(pe[ee]=l.date);if(null!=ie&&!ie.grants)for(qe=null!=(Pe=i.funder)?Pe:[],Ut=0,V=qe.length;Ut<V;Ut++)x=qe[Ut],null==pe.funder&&(pe.funder=[]),pe.funder.push({award:x.award,display_name:x.name,source:"crossref",id:x.DOI})}if((null!=(Te=pe.openalex)&&null!=(We=Te.primary_location)&&null!=(Me=We.source)?Me.publisher:void 0)&&(!pe.publisher_simple||(null!=(Ue=pe.openalex)&&null!=(ze=Ue.primary_location)&&null!=(Be=ze.source)?Be.publisher:void 0)&&(null!=(Fe=pe.openalex)&&null!=(Je=Fe.primary_location)&&null!=(Xe=Je.source)?Xe.publisher:void 0)!==(null!=s&&null!=(Ve=s.openalex)&&null!=(Ge=Ve.primary_location)&&null!=(Ye=Ge.source)?Ye.publisher:void 0))){if(!v.length)for(Ze=null!=(He=await this.report.publishers("*",1e4))?He:[],j=0,P=Ze.length;j<P;j++)Rt=Ze[j],v.push(null!=(Ke=Rt._source)?Ke:Rt);for(ue=pe.openalex.primary_location.source.publisher.toLowerCase(),A=0,q=v.length;A<q;A++)if((oe=v[A]).publisher&&ue.includes(oe.publisher.toLowerCase())){pe.publisher_simple=oe.publisher_display_name;break}}if(((pe.DOI||pe.PMID)&&!pe.PMCID||!pe.PMID||null==pe.pubtype||!pe.submitted_date||!pe.accepted_date)&&(ce=pe.PMID?await this.src.pubmed(pe.PMID):await this.src.pubmed.doi(pe.DOI))){for(et=null!=(Qe=ce.ISSN)?Qe:[],I=0,T=et.length;I<T;I++)ne=et[I],R.call(S,ne)<0&&S.push(ne);!pe.PMCID&&(null!=ce&&null!=(tt=ce.identifier)?tt.pmc:void 0)&&(pe.PMCID="PMC"+ce.identifier.pmc.toLowerCase().replace("pmc","")),!pe.PMID&&(null!=ce&&null!=(rt=ce.identifier)?rt.pubmed:void 0)&&(pe.PMID=ce.identifier.pubmed),pe.pubtype=ce.type,null==pe.submitted_date&&(pe.submitted_date=null!=(st=ce.dates)&&null!=(nt=st.PubMedPubDate_received)?nt.date:void 0),null==pe.accepted_date&&(pe.accepted_date=null!=(at=ce.dates)&&null!=(lt=at.PubMedPubDate_accepted)?lt.date:void 0)}if(pe.PMCID&&(r||!pe.epmc_licence&&Nt-(null!=(ot=pe.meta.tried_epmc_licence)?ot:0)>n)&&(b=await this.src.epmc.pmc(pe.PMCID))){for((null!=(ut=b.journalInfo)&&null!=(ct=ut.journal)?ct.issn:void 0)&&(pt=b.journalInfo.journal.issn,R.call(S,pt)<0)&&S.push(b.journalInfo.journal.issn),(null!=(ht=b.journalInfo)&&null!=(ft=ht.journal)?ft.essn:void 0)&&(mt=b.journalInfo.journal.essn,R.call(S,mt)<0)&&S.push(b.journalInfo.journal.essn),null==pe.PMCID&&(pe.PMCID=b.pmcid),null==pe.pubtype&&(pe.pubtype=[]),_t=null!=(yt=null!=(gt=b.pubTypeList)?gt.pubType:void 0)?yt:[],E=0,W=_t.length;E<W;E++)le=_t[E],R.call(pe.pubtype,le)<0&&pe.pubtype.push(le);if(!r&&pe.epmc_licence||(pe.meta.tried_epmc_licence=Nt,pe.epmc_licence=null!=(vt=await this.src.epmc.licence(pe.PMCID,b))?vt.licence:void 0),!(null!=(bt=pe.data_availability_statement)?bt.has_data_availability_statement:void 0)&&await this.src.pubmed.availability(pe.PMCID)&&(null==pe.data_availability_statement&&(pe.data_availability_statement={}),pe.data_availability_statement.has_data_availability_statement=!0,pe.data_availability_statement.source="pubmed"),!(null!=(wt=pe.data_availability_statement)?wt.has_data_availability_statement:void 0)&&(g=await this.src.epmc.statement(pe.PMCID,b))&&(null==pe.data_availability_statement&&(pe.data_availability_statement={}),pe.data_availability_statement.has_data_availability_statement=!0,pe.data_availability_statement.source="epmc",pe.data_availability_statement.full_text=g,qt=await this.src.epmc.statement.url(pe.PMCID,b,g)))for(Z=0,M=qt.length;Z<M;Z++)(f=qt[Z])&&f.includes("doi.org/")?(m=f.split("doi.org/")[1].toLowerCase(),null==(c=pe.data_availability_statement).doi&&(c.doi=[]),R.call(pe.data_availability_statement.doi,m)<0&&pe.data_availability_statement.doi.push(m)):(null==(p=pe.data_availability_statement).url&&(p.url=[]),R.call(pe.data_availability_statement.url,f)<0&&pe.data_availability_statement.url.push(f));null==pe.submitted_date&&(pe.submitted_date=await this.src.epmc.submitted(pe.PMCID,b))}if(pe.DOI&&(r||!(null!=(xt=pe.syp_permissions)?xt.journal_oa_type:void 0))&&((r||null==(null!=(Ot=pe.syp_permissions)?Ot.archivable_version:void 0))&&(se=await this.permissions_new({doi:pe.DOI},void 0,ie))&&null!=se.best_permission&&(pe.syp_permissions={can_archive:se.best_permission.can_archive,archivable_version:se.best_permission.version}),S||null!=ie||null!=i)){null==pe.syp_permissions&&(pe.syp_permissions={}),pe.syp_permissions.journal_oa_type=null!=(jt=await this.permissions_new.journals.oa.type(S,void 0,ie,i))?jt:"unsuccessful";try{pe.syp_permissions.journal_oa_type_report=(await this.report.works(pe.DOI)).journal_oa_type}catch(e){}pe.syp_permissions.journal_oa_type_old=null!=(St=await this.permissions.journals.oa.type(S,void 0,void 0,i))?St:"unsuccessful","gold"!==(At=pe.syp_permissions.journal_oa_type)&&"diamond"!==At||(pe.is_open_access=!0)}}return(null!=t?t.country_code:void 0)&&t.paid&&!pe.meta.checked_funder_country&&(pe.meta.checked_funder_country=Nt,pe=await this.oareport._funder_country(pe,t)),"string"==typeof pe.outreach.email_address&&pe.outreach.email_address.includes("@")&&(pe.outreach.email_address=await this.encrypt(pe.outreach.email_address)),pe.is_open_access||!pe.epmc_licence||!(_=pe.epmc_licence.toLowerCase())||"pd"!==_&&"public-domain"!==_&&"cc0"!==_&&"cc-by"!==_||(pe.is_open_access=!0),pe.meta.updated=await this.epoch(),pe.meta.updated_date=await this.datetime(pe.meta.updated),pe.meta.took=pe.meta.updated-Nt,pe._id&&pe._id===(null!=(It=null!=(Dt=this.params.process)?Dt:pe.meta.replaced)?It:"").toLowerCase().replace(/\//g,"_")&&!1!==this.params.save&&this.oareport.works(pe),pe}catch(t){w=t,C.log("report works process error",w,e)}},t.oareport.works.process._log=!1,t.oareport.works.load=async function(e,t,i,r){var s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v;if(_=await this.epoch(),r=null!=(c=this.params.load)?c:(await this.date()).split("-")[0],i=null!=(p=null!=(d=this.params.org)?d:this.params.orgs)?p:"orgs"===this.params.load,null==e&&"string"==typeof this.params.load&&(this.params.load.startsWith("10.")||this.params.load.toLowerCase().startsWith("pmc")||this.params.load.toLowerCase().startsWith("w"))&&(e=this.params.load),"string"==typeof e&&(e=[e]),this.params.q)for await(v of await this.oareport.works._for(this.params.q,{scroll:"5m",include:["DOI","openalex","PMCID"]}))e.push(null!=(f=null!=(m=v.DOI)?m:v.openalex)?f:v.PMCID);else if(!e){if(s=async(i,s)=>{var n,a,l,o;for await(a of(null==i&&(i=(s?"(funder.name:* OR author.affiliation.name:*) AND year.keyword:":"authorships.institutions.display_name:* AND publication_year:")+r),t&&(i="("+i+") AND "+(s?"srcday":"updated_date")+":>"+t),o=[],await this.src[s?"crossref":"openalex"].works._for(i,{include:s?["DOI"]:["id","ids"],scroll:"10m"})))(n=(a.DOI?a.DOI:(null!=(l=a.ids)?l.doi:void 0)?"10."+a.ids.doi.split("/10.")[1]:a.id.split("openalex.org/").pop())&&(t||R.call(e,n)<0))?o.push(e.push(n)):o.push(void 0);return o},i||r!==this.params.load)for await(o of await this.oareport.orgs._for("string"==typeof i?'name.keyword:"'+i+'"':"meta.paid:true",{scroll:"10m"}))(null!=(y=o.source)?y.openalex:void 0)&&await s(decodeURIComponent(decodeURIComponent(o.source.openalex))),(null!=(g=o.source)?g.crossref:void 0)&&await s(decodeURIComponent(decodeURIComponent(o.source.crossref)),!0);else await Promise.all(s(),s(void 0,!0));if(t)for await(u of await this.oareport.works._for("DOI:* AND meta.paid:true AND updated:<"+t,{include:["DOI"],scroll:"10m"}))h=u.DOI,R.call(e,h)<0&&e.push(u.DOI)}for(a=0,l=e.length;a<l;a++)n=e[a],await this.sleep(20),this.oareport.works.process(n);return C.log("Report works load",e.length,await this.epoch()-_),e.length},t.oareport.works.load._log=!1,t.oareport.works.load._bg=!0,t.oareport.works.load._async=!0,t.oareport.works.load._auth="@oa.works",t.oareport.journal_oa_type=async function(){var e,t,i,r,s,n;for await(s of(n={count:0,dc:0,wasgold:0,wasdiamond:0,pretypes:{},posttypes:{},diffs:[]},this.index._for("paradigm_b_oareport_works","DOI:* AND supplements.org:Gates AND (syp_permissions.journal_oa_type:Gold OR syp_permissions.journal_oa_type:Diamond)",{scroll:"10m",include:["DOI","syp_permissions"]})))n.count+=1,(i=await this.permissions_new.journals.oa.type(s.DOI))!==s.syp_permissions.journal_oa_type&&(n.diffs.push({doi:s.DOI,was:s.syp_permissions.journal_oa_type,now:i}),n["gold"===s.syp_permissions.journal_oa_type?"wasgold":"wasdiamond"]+=1),null==(e=n.pretypes)[r=s.syp_permissions.journal_oa_type]&&(e[r]=0),n.pretypes[s.syp_permissions.journal_oa_type]+=1,null==(t=n.posttypes)[i]&&(t[i]=0),n.posttypes[i]+=1;return n.dc=n.diffs.length,C.log(n),await this.mail({to:["mark+notifications@oa.works"],subject:"OA report journal oa type tested "+n.count,text:JSON.stringify(n)}),n},t.oareport.journal_oa_type._async=!0,t.oareport.review=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b;for(null==e&&(e=null!=(h=null!=(d=this.params.review)?d:this.params.org)?h:"Bill & Melinda Gates Foundation"),null==t&&(t=null!=(f=this.params.from)?f:"2023-12-31"),null==i&&(i=null!=(m=this.params.to)?m:"2024-06-07"),o="(openalex.publication_date:>"+t+" AND openalex.publication_date:<"+i+")",u="",g="(published_date:>"+t+" AND published_date:<"+i+")",_="",v={org:e,from:t,to:i,counts:{},terms:{},is_oa:{oareport:{},report:{}},queries:{},missing:{}},r=async r=>{var s,n,a,l,c,p,h,d,f,m;for await(h of(c="",this.index._for("paradigm_"+(this.S.dev?"b_":"")+r+"_orgs",'name.keyword:"'+e+'"',{scroll:"10m"})))for(s in null!=(m=h.analysis)?m:{})h.analysis[s].query&&(d=decodeURIComponent(h.analysis[s].query),u||"oareport"!==r||(u=d),_||"report"!==r||(_=d),t&&i&&(d=("oareport"===r?o:g)+" AND "+d),c||"is_paper"!==s||(c=d),null==(n=v.queries)[s]&&(n[s]={}),v.queries[s][r]=d,null==(a=v.counts)[s]&&(a[s]={}),v.counts[s][r]=await this.index.count("paradigm_"+(this.S.dev?"b_":"")+r+"_works",d));if(c){for await(f of this.index._for("paradigm_"+(this.S.dev?"b_":"")+r+"_works",c,{scroll:"10m",include:["DOI"]}))await this["oareport"===r?"report":"oareport"].works(f.DOI)||(null==(l=v.missing)[p="in_"+r+"_not_in_"+("oareport"===r?"report":"oareport")]&&(l[p]=[]),v.missing["in_"+r+"_not_in_"+("oareport"===r?"report":"oareport")].push(f.DOI));return v.missing["not_in_"+("oareport"===r?"report":"oareport")+"_count"]=v.missing["in_"+r+"_not_in_"+("oareport"===r?"report":"oareport")].length}},n=0,a=(y=["oareport","report"]).length;n<a;n++)s=y[n],await r(s);for await(p of(c=decodeURIComponent("(openalex.publication_date:%3E2023-12-31%20AND%20openalex.publication_date:%3C2024-06-07)%20AND%20((openalex.primary_location.source.display_name:%22gates%20open%20research%22%20OR%20supplements.sheets:*pub__bmgf%20OR%20supplements.sheets:(%22grantid_cw__bmgf%22%20OR%20%22pmc__bmgf%22%20OR%20%22all-time__bmgf%22%20OR%20%22name_epmc__bmgf%22%20OR%20%22staff__bmgf%22%20OR%20%22chronos_v2__bmgf%22%20OR%20%22finance__bmgf%22%20OR%20%22users__bmgf%22%20OR%20%22preprints_oa_locations__bmgf%22%20OR%20%22preprints-enrichment__bmgf%22)%20OR%20(funder.id:(%2210.13039/100000865%22%20OR%20%2210.13039/501100005370%22)%20OR%20funder.name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20openalex.grants.funder:(%22F4320306137%22%20OR%20%22F4320323264%22))%20OR%20(openalex.authorships.institutions.ror:(%220456r8d26%22%20OR%20%22033sn5p83%22)%20OR%20openalex.authorships.institutions.display_name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20openalex.authorships.raw_affiliation_string:(%22Bill%20&%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22))%20OR%20supplements.funder.display_name_ic:%22bill-and-melinda-gates-foundation%22)%20AND%20NOT%20(supplements.removed_from_report:%22bill-and-melinda-gates-foundation%22%20OR%20supplements.is_financial_disclosure:%22bill-and-melinda-gates-foundation%22))%20AND%20openalex.type:(%22article%22%20OR%20%22editorial%22%20OR%20%22letter%22%20OR%20%22review%22)%20AND%20NOT%20openalex.type_crossref:%22proceedings-article%22%20AND%20NOT%20(supplements.is_preprint:true%20OR%20(pubtype:preprint%20AND%20NOT%20supplements.is_preprint:false)%20OR%20subtype:preprint)%20AND%20openalex.id:*%20AND%20openalex.primary_location.source.display_name:*"),b=decodeURIComponent("(published_date:%3E2023-12-31%20AND%20published_date:%3C2024-06-07)%20AND%20((journal:%22gates%20open%20research%22%20OR%20supplements.sheets:*pub__bmgf%20OR%20supplements.sheets:(%22grantid_cw__bmgf%22%20OR%20%22pmc__bmgf%22%20OR%20%22all-time__bmgf%22%20OR%20%22name_epmc__bmgf%22%20OR%20%22staff__bmgf%22%20OR%20%22chronos_v2__bmgf%22%20OR%20%22finance__bmgf%22%20OR%20%22users__bmgf%22%20OR%20%22preprints_oa_locations__bmgf%22%20OR%20%22preprints-enrichment__bmgf%22)%20OR%20(funder.DOI:(%2210.13039/100000865%22%20OR%20%2210.13039/501100005370%22)%20OR%20funder.name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20openalx.grants.funder:(%22F4320306137%22%20OR%20%22F4320323264%22))%20OR%20(authorships.institutions.ror:(%220456r8d26%22%20OR%20%22033sn5p83%22)%20OR%20authorships.institutions.display_name:(%22Bill%20%26%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22)%20OR%20authorships.raw_affiliation_string:(%22Bill%20&%20Melinda%20Gates%20Foundation%22%20OR%20%22melinda%20gates%20foundation%22%20OR%20%22gates%20cambridge%20trust%22%20OR%20%22gates%20ventures%22))%20OR%20supplements.funder.display_name_ic:%22bill-and-melinda-gates-foundation%22)%20AND%20NOT%20(supplements.removed_from_report:%22bill-and-melinda-gates-foundation%22%20OR%20supplements.is_financial_disclosure:%22bill-and-melinda-gates-foundation%22))%20AND%20type:(%22article%22%20OR%20%22editorial%22%20OR%20%22letter%22%20OR%20%22review%22)%20AND%20NOT%20openalx.type_crossref:%22proceedings-article%22%20AND%20NOT%20(supplements.is_preprint:true%20OR%20(pubtype:preprint%20AND%20NOT%20supplements.is_preprint:false)%20OR%20subtype:preprint)%20AND%20openalex:*%20AND%20journal:*"),v.terms.oareport=await this.oareport.works.terms("syp_permissions.journal_oa_type.keyword",c),v.terms.report=await this.report.works.terms("journal_oa_type.keyword",b),l='(epmc_licence.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR syp_permissions.journal_oa_type.keyword:("gold" OR "diamond") OR openalex.locations.license.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR supplements.publisher_license_ic.keyword:("cc0" OR "cc-by"))',v.is_oa.oareport.is_oa_derived=await this.oareport.works.count(c+" AND "+l),v.is_oa.oareport.is_oa_but_not_by_derived_dois=[],await this.oareport.works._for(c+" AND is_open_access:true AND NOT "+l,{scroll:"10m",include:["DOI"]})))v.is_oa.oareport.is_oa_but_not_by_derived_dois.push(p.DOI);return v.is_oa.oareport.is_oa_but_not_by_derived=v.is_oa.oareport.is_oa_but_not_by_derived_dois.length,v.is_oa.report.is_oa_derived_from_oareport=await this.report.works.count(b+' AND (epmc_licence.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR journal_oa_type.keyword:("gold" OR "diamond") OR openalx.locations.license.keyword:("pd" OR "public-domain" OR "cc0" OR "cc-by") OR supplements.publisher_license_ic.keyword:("cc0" OR "cc-by"))'),v.oareport_has_checked_das=await this.oareport.works.count(c+' AND (data_availability_statement.has_data_availability_statement:true OR openalex.primary_location.source.publisher:"Public Library of Science" OR DOI:"10.1186*" OR DOI:"10.12688/gatesopenres*")'),v},R=[].indexOf,null==t.svc&&(t.svc={}),t.svc.rscvd={_index:!0},t.svc.rscvd.form=async function(){var e,t,i,r,s,n,a,l;if(this.keys(this.params).length>1){delete(t=this.copy(this.params)).form,t.status="Awaiting verification";try{(a=await this.svc.rscvd.requestees('email:"'+t.email+'"'))&&((null!=a?a.verified:void 0)||"Approved"===(null!=a?a.verification:void 0)?(t.status="Verified",t.verified=!0):((null!=a?a.denied:void 0)||"Denied"===(null!=a?a.verification:void 0))&&(t.status="Denied",t.verified=!1))}catch(e){}if("Awaiting verification"===t.status)try{(null!=(e=await this.svc.rscvd('email:"'+t.email+'" AND verified:*'))&&null!=(i=e.hits)?i.hits:void 0)&&!0===e.hits.hits[0]._source.verified?(t.status="Verified",t.verified=!0):!1===e.hits.hits[0]._source.verified&&(t.status="Denied",t.verified=!1)}catch(e){}null==t.type&&(t.type="paper");try{t.createdAt=new Date}catch(e){}try{t.neededAt=await this.epoch(t["needed-by"])}catch(e){}t._id=await this.svc.rscvd(t);try{l="Hi "+t.name+",<br><br>We got your request:<br><br>Title: "+(null!=(r=null!=(s=t.atitle)?s:t.title)?r:"Unknown")+"\nReference (if provided): "+(null!=(n=t.reference)?n:"")+"<br><br>",l+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+t._id+'">cancel your request</a>, it only takes a second.<br><br>',l+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',l+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:t.email,subject:"RSCVD Request Receipt",text:l})}catch(e){}return t}},t.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},t.svc.rscvd.resolves=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d;for(null==e&&(e=this.params.resolves),null==t&&(t=this.params.resolver),e?a="object"==typeof e?e:await this.svc.rscvd(e):l=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+t+'" AND NOT unresolved:"'+t+'"'),h={},i=0,r=(c=null!=a?[a]:null!=(o=null!=l&&null!=(u=l.hits)?u.hits:void 0)?o:[]).length;i<r;i++)null!=(n=c[i])._source&&null==(a=n._source)._id&&(a._id=n._id),(s=this.copy(a)).title&&(s.journal=s.title),s.atitle&&(s.title=s.atitle),(null!=(d=await this.ill.subscription({subscription:t},s))?d.url:void 0)?(null==a.resolved&&(a.resolved=[]),a.resolved.push(t),null==a.resolves&&(a.resolves=[]),a.resolves.push({resolver:t,url:d.url,user:null!=(p=this.user)?p._id:void 0}),h[n._id]=!0):(null==a.unresolved&&(a.unresolved=[]),a.unresolved.push(t),h[n._id]=!1),this.svc.rscvd(a);return e&&h[e]?h[e]:h},t.svc.rscvd.cancel=async function(){var e;if(this.params.cancel)return(e=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(e),e},t.svc.rscvd.verify=async function(e,t=!0){var i,r;if(null==e&&(e=this.params.verify),e)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:e,createdAt:Date.now()}),t?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+e+'"',{action:"index"},(function(e){return e.status&&"Awaiting verification"!==e.status||(e.verified=t,t?(e.status="Verified",e.verified_by=this.user.email):(e.status="Denied",e.denied_by=this.user.email)),e})),!0},t.svc.rscvd.verify._auth=!0,t.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},t.svc.rscvd.deny._auth=!0,t.svc.rscvd.status=async function(){var e,t,i;if(this.params.status){[t,i]=this.params.status.split("/"),(e=await this.svc.rscvd(t)).status=i;try{"Done"===e.status?e.done_by=this.user.email:"In Progress"===e.status&&(e.progressed_by=this.user.email)}catch(e){}return this.svc.rscvd(e),e}},t.svc.rscvd.status._auth=!0,t.svc.rscvd.poll=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E;if(null==e&&(e=null!=(v=this.params.poll)?v:Date.now()-18e4),"string"==typeof(t=null!=(b=this.params.which)?b:["new","verify","deny","cancel","status","overdue"])&&(t=t.split(",")),R.call(t,"overdue")>=0&&this.svc.rscvd.overdue(),I={new:[],verify:[],deny:[],cancel:[],status:{}},R.call(t,"new")>=0)for(a=0,c=(O=null!=(w=null!=(_=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+e,500))&&null!=(x=_.hits)?x.hits:void 0)?w:[]).length;a<c;a++)null==(i=(y=O[a])._source)._id&&(i._id=y._id),I.new.push(y._source);if(R.call(t,"verify")>=0)for(l=0,p=(k=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;l<p;l++)E=k[l]._source.parts.pop(),R.call(I.verify,E)<0&&I.verify.push(E);if(R.call(t,"deny")>=0)for(o=0,h=(j=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<h;o++)n=j[o]._source.parts.pop(),R.call(I.deny,n)<0&&I.deny.push(n);if(R.call(t,"cancel")>=0)for(u=0,d=(S=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<d;u++)s=S[u]._source.parts.pop(),R.call(I.cancel,s)<0&&I.cancel.push(s);if(R.call(t,"status")>=0)for(m=0,f=(A=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;m<f;m++)C=(D=A[m])._source.parts.pop(),null==(r=I.status)[g=D._source.parts.pop()]&&(r[g]=C);return I},t.svc.rscvd.poll._log=!1,t.svc.rscvd.overdue=async function(){var e,t,i,r,s,n,a,l,o,u,c;if(t=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(r=0,n=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;r<n;r++)null==(e=(l=c[r])._source)._id&&(e._id=l._id),u.push(l._source);for(s=0,a=u.length;s<a;s++)(o=u[s]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),t+=1;return t},R=[].indexOf,t.src.crossref=function(){return"Crossref API wrapper"},t.src.crossref.works={_index:{settings:{number_of_shards:15}}},t.src.crossref.works._key="DOI",t.src.crossref.works._prefix=!1,t.src.crossref.works.doi=async function(e,t,i){var r,s,n,a,l,o,u;return null==e&&(e=this.params.doi),null==t&&"src.crossref.works.doi"===this.fn&&(t=this.refresh),null==i&&(i=null==(s=this.params.save)||s),"string"==typeof e&&e.startsWith("10.")&&(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),!t&&(r=await this.src.crossref.works(e))||null!=(null!=(u=await this.fetch("https://api.crossref.org/works/"+e,{headers:{"User-Agent":(null!=(n=this.S.name)?n:"OA.Works")+"; mailto:"+(null!=(a=null!=(l=this.S.mail)?l.to:void 0)?a:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}))&&null!=(o=u.message)?o.DOI:void 0)&&(r=await this.src.crossref.works._format(u.message),i&&await this.src.crossref.works(r))),r},t.src.crossref.works.title=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g;if(null==e&&(e=null!=(o=this.params.title)?o:this.params.q),a='title:"'+e+'"',e.split(" ").length>2){for(a+=" OR (",t=0,i=(u=e.split(" ")).length;t<i;t++)g=u[t],a.endsWith("(")||(a+=" AND "),a+='(title:"'+g+'" OR subtitle:"'+g+'")';a+=")"}for(d=await this.src.crossref.works(a),s=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),n=0,r=(h=null!=(c=null!=d&&null!=(p=d.hits)?p.hits:void 0)?c:[]).length;n<r;n++)(l=h[n])._source.DOI&&l._source.title&&l._source.title.length&&(m=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(y=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&y.length&&R.call(m,y)<0&&(m+=" "+y),m=m.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==s.indexOf(m)||-1!==m.indexOf(s))&&s.length/m.length>.7&&s.length/m.length<1.3&&("journal-article"===l._source.type||null==f||"journal-article"!==f.type&&"journal-article"===l._source.type)&&(f=l._source));return f},t.src.crossref.works._format=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y;for(e.abstract&&(e.abstract=e.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==e._id&&(e._id=e.DOI.replace(/\//g,"_")),r=0,n=(p=null!=(c=e.assertion)?c:[]).length;r<n;r++)"OPEN ACCESS"===(t=p[r]).label&&(t.URL&&-1!==t.URL.indexOf("creativecommons")&&(null==e.license&&(e.license=[]),e.license.push({URL:t.URL})),e.is_oa=!0);for(o=0,a=(d=null!=(h=e.license)?h:[]).length;o<a;o++)if((s=d[o]).URL&&-1!==s.URL.indexOf("creativecommons")&&(!e.licence||-1===e.licence.indexOf("creativecommons"))){e.licence=s.URL;try{e.licence="cc-"+e.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(e){}e.is_oa=!0}try{e.reference&&e.reference.length>100&&(e.reference_original_length=e.reference.length,e.reference=e.reference.slice(0,100))}catch(e){}try{e.relation&&e.relation.length>100&&(e.relation_original_length=e.relation.length,e.relation=e.relation.slice(0,100))}catch(e){}for(u=0,l=(m=null!=(f=e.author)?f:[]).length;u<l;u++)(i=m[u]).name=(i.given?i.given+" ":"")+(null!=(y=i.family)?y:"");if(e.published=await this.src.crossref.works.published(e)){try{e.year=e.published.split("-")[0]}catch(e){}try{parseInt(e.year)}catch(e){}try{e.publishedAt=await this.epoch(e.published)}catch(e){}}return e},t.src.crossref.works.published=async function(e){var t,i,r,s,n,a,l,o,u;if(null==e&&(e=this.params.published),"string"==typeof e&&(e=await this.src.crossref.works(e)),null!=e){for(n=void 0,s=void 0,t=0,i=(l=["published","published-print","published-online","issued","deposited"]).length;t<i;t++)"object"==typeof e[r=l[t]]&&(a=void 0,"string"==typeof e[r]["date-time"]&&3===e[r]["date-time"].split("T")[0].split("-").length?a=e[r]["date-time"].split("T")[0]:Array.isArray(e[r]["date-parts"])&&e[r]["date-parts"].length&&Array.isArray(e[r]["date-parts"][0])&&("string"!=(o=typeof(u=e[r]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(a=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),a&&(!s||n>await this.epoch(a))&&(s=a,n=await this.epoch(s)));return s}},t.src.crossref.works.published._log=!1,t.src.crossref.works.search=async function(e,t,i,r,s,n,a,l){var o,u,c,p,h,d,f,m,y,g,_;if(null==e&&(e=null!=(h=this.params.q)?h:this.params.search),null==t&&(t=this.params.from),null==i&&(i=this.params.size),null==r&&(r=this.params.filter),null==s&&(s=this.params.start),null==n&&(n=this.params.end),null==a&&(a=this.params.sort),null==l&&(l=null!=(d=this.params.order)?d:"asc"),o="",s&&(null==r&&(r=null!=a?a:"updated"),"string"==typeof s&&-1!==s.indexOf("-")||(s=await this.date(s)),o="from-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+s),n&&(null==r&&(r=null!=a?a:"updated"),"string"==typeof n&&-1!==n.indexOf("-")||(n=await this.date(n)),o+=(o?",":"")+"until-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+n),o&&(r=o),_="https://api.crossref.org/works?",null!=a&&(_+="sort="+a+"&order="+l+"&"),"object"==typeof e)for(c in e)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(_+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(e[c])+"&");else e&&"all"!==e&&(p=(p=e.replace(/\w+?\:/g,"")).replace(/ /g,"+"),_+="query="+encodeURIComponent(p)+"&");if(null!=t){if("*"!==t&&"string"==typeof t&&!t.replace(/[0-9]/g,"").length)try{u=parseInt(t),isNaN(u)||(t=u)}catch(e){}_+="number"!=typeof t?"cursor="+encodeURIComponent(t)+"&":"offset="+t+"&"}null!=i&&(_+="rows="+i+"&"),r&&(_+="filter="+encodeURIComponent(r)+"&"),_=_.replace("?&","?").replace(/&$/,"");try{return{total:(g=await this.fetch(_,{headers:{"User-Agent":(null!=(f=this.S.name)?f:"OA.Works")+"; mailto:"+(null!=(m=null!=(y=this.S.mail)?y.to:void 0)?m:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}})).message["total-results"],cursor:g.message["next-cursor"],data:g.message.items,facets:g.message.facets}}catch(e){}},t.src.crossref.journals={_index:!0,_prefix:!1},t.src.crossref.journals.load=async function(){var e,t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A;for(await this.src.crossref.journals(""),t=0,j=0,e=[],i="*";i&&(0===t||t<j);){for(S="https://api.crossref.org/journals?cursor="+i+"&rows=1000",O=await this.fetch(S,{headers:{"User-Agent":(null!=(p=this.S.name)?p:"OA.Works")+"; mailto:"+(null!=(h=null!=(m=this.S.mail)?m.to:void 0)?h:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}),0===j&&(j=O.message["total-results"]),i=O.message["next-cursor"],s=0,n=(y=O.message.items).length;s<n;s++){for(null==(c=y[s]).ISSN&&(c.ISSN=[]),c.issn=[],o=0,a=(g=c.ISSN).length;o<a;o++)"string"==typeof(r=g[o])&&r.length&&R.call(c.issn,r)<0&&c.issn.push(r);if(c.dois=null!=(_=c.counts)?_["total-dois"]:void 0,null!=(null!=(v=c.breakdowns)?v["dois-by-issued-year"]:void 0)){for(c.years=[],u=0,l=(b=c.breakdowns["dois-by-issued-year"]).length;u<l;u++)2===(A=b[u]).length&&(w=A[0],R.call(c.years,w)<0)&&c.years.push(A[0]);c.years.sort()}null!=c.years&&c.years.length&&c.dois?(k=(new Date).getFullYear(),R.call(c.years,k)<0&&(x=k-1,R.call(c.years,x)<0)&&(d=k-2,R.call(c.years,d)<0)&&(f=k-3,R.call(c.years,f)<0)&&(c.discontinued=!0)):c.discontinued=!0,e.push(c)}t+=1e3,e.length>=1e4&&(await this.src.crossref.journals(e),e=[])}return e.length&&(await this.src.crossref.journals(e),e=[]),C.log(t),t},t.src.crossref.journals.load._bg=!0,t.src.crossref.journals.load._async=!0,t.src.crossref.journals.load._auth="root",t.src.crossref.changes=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_;if(null==e&&(e=this.params.changes),"string"==typeof e&&(e.includes("/")||e.includes("-"))&&(e=await this.epoch(e)),!e)try{e=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday+864e5,C.log("Crossref changes start day set from latest record srcday",await this.date(e))}catch(e){}if(!e)try{e=(await this.src.crossref.works("indexed.timestamp:*",{size:1,sort:{"indexed.timestamp":"desc"}})).indexed.timestamp,C.log("Crossref changes start day set from latest record indexed timestamp",await this.date(e))}catch(e){}if(null==e&&(e=16935264e5),e=await this.epoch(await this.date(e)),null==t&&(t=this.params.end),"string"==typeof t&&(t.includes("/")||t.includes("-"))&&(t=await this.epoch(t)),null==i&&(i=this.params.created),a=null!=t?t:Date.now(),p=0,h=[],n=0,r=[],e>=(a=await this.epoch(await this.date(a)))&&"src.crossref.changes"!==this.fn)C.log("crossref works changes waiting an hour before looping to check for new changes because start day is not yet a day or more in the past"),await this.sleep(36e5);else{for(;e<a;){for(C.log("Crossref changes",e,n),s="*",n+=1,_=!1,o=0,y=0;y<3&&(!1===_||o<_);)if(await this.sleep(500),null!=(g=await this.src.crossref.works.search(void 0,s,1e3,"indexed",e,e))?g.data:void 0){for(u=0,c=(f=g.data).length;u<c;u++)d=f[u],(l=await this.src.crossref.works._format(d)).srcday=e,r.push(l),p+=1;r.length>=1e4&&(C.log("Crossref bulk load",e,n,_,o,p,h.length),await this.src.crossref.works(r),r=[]),!1===_&&(_=null!=(m=g.total)?m:0,C.log(e,_)),o+=1e3,s=g.cursor}else C.log("crossref error"),await this.sleep(2e3),y+=1;e+=864e5}r.length&&await this.src.crossref.works(r),C.log("crossref works changes completed",p,n,h.length),await this.mail({to:["mark+notifications@oa.works","joe+notifications@oa.works"],subject:"Crossref works load or changes "+p,text:"loaded "+p})}return p},t.src.crossref.changes._bg=!0,t.src.crossref.changes._async=!0,t.src.crossref.changes._log=!1,t.src.crossref.changes._auth="root",t.src.crossref.changes._notify=!1,t.src.crossref.plus={},t.src.crossref.plus.load=async function(){var e,t,i,r,s,n,a,l,o,u,c,p,h,d;if(c=await this.epoch(),s=0,this.params.clear)await this.src.crossref.works(""),(a={properties:{}}).properties.assertion={properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},explanation:{properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},group:{properties:{label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},order:{type:"long"},value:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},await this.src.crossref.works.mapping(a);else try{s=(await this.src.crossref.works("srcfile:*",{size:1,sort:{srcfile:"desc"}})).srcfile}catch(e){}i=this.S.directory+"/import/crossref/all.json.tar.gz";try{await fs.stat(i)}catch(e){C.log("crossref downloading snapshot"),(r={})["Crossref-Plus-API-Token"]="Bearer "+this.S.crossref,o=await fetch("https://api.crossref.org/snapshots/monthly/latest/all.json.tar.gz",{headers:r}),d=fs.createWriteStream(i),await new Promise(((e,t)=>(o.body.pipe(d),o.body.on("error",t),d.on("finish",e)))),C.log("snapshot downloaded")}for(h=0,u=0,n="",e=!1,p=fs.createReadStream(i).pipe(zlib.createGunzip()),l="",p.on("data",(async e=>{var t,i,r,a,o,c,p,d,f,m;if(r=e.toString("utf8"),n+=r,(l+r).includes('\n  "items" : ['))for(;n.includes('\n  "items" : [');)if([a,n]=n.replace('\n  "items" : [',"X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),a.includes("\n  } ]")){if(o=a.split("\n  } ]"),m=parseInt(o.pop().split(".json")[0].replace(/[^0-9]/g,"")),u<s)C.log("crossref plus load waiting for file",u,s);else{for(p=[],t=0,i=(d=f=JSON.parse("["+o.join("]")+"}]")).length;t<i;t++)c=d[t],(null!=(c=await this.src.crossref.works._format(c))?c.DOI:void 0)&&(c.srcfile=u,p.push(c));C.log("crossref plus load",f.length,p.length),h+=p.length,p.length&&await this.src.crossref.works(p)}u=m}return l=r})),p.on("error",(e=>C.log("crossref plus load file stream error",JSON.stringify(e)))),p.on("end",(()=>(C.log("stream complete for crossref plus load"),e=!0)));!e;)C.log("crossref plus load streaming file",n.length,u,h,Math.floor((Date.now()-c)/1e3/60)+"m"),await this.sleep(3e4);return t=Date.now(),C.log("crossref plus load complete",u,h,c,t,Math.floor((t-c)/1e3/60)+"m"),h},t.src.crossref.plus.load._log=!1,t.src.crossref.plus.load._bg=!0,t.src.crossref.plus.load._async=!0,null==(O=r.src).doaj&&(O.doaj={});try{r.src.doaj.secrets=JSON.parse(SECRETS_DOAJ)}catch(e){}t.src.doaj={},t.src.doaj.journals={_index:!0,_prefix:!1},t.src.doaj.journals.load=async function(){var e,t,i,s,n,a,l,o;for(i="/tmp/doaj_"+await this.uid(),await fs.mkdir(i),i+="/",await fs.writeFile(i+"doaj.tar",await this.fetch("https://doaj.org/public-data-dump/journal?api_key="+r.src.doaj.secrets.apikey,{buffer:!0})),tar.extract({file:i+"doaj.tar",cwd:i,sync:!0}),e=!1,s=0,a=(l=await fs.readdir(i)).length;s<a;s++)(t=l[s]).includes("doaj_journal_data")&&(e=t);return o=0,e&&(o=(n=JSON.parse(await fs.readFile(i+e+"/journal_batch_1.json"))).length,await this.src.doaj.journals(""),await this.src.doaj.journals(n),await fs.unlink(i+e+"/journal_batch_1.json")),await fs.rmdir(i+e),await fs.unlink(i+"doaj.tar"),await fs.rmdir(i),o},t.src.doaj.journals.load._bg=!0,t.src.doaj.journals.load._async=!0,t.src.doaj.journals.load._auth="root",R=[].indexOf,t.src.epmc={_index:!0,_prefix:!1,_key:"id"},t.src.epmc.notinepmc={_index:!0,_prefix:!1,_key:"id",_hide:!0},t.src.epmc.search=async function(e,t,i){var r,s,n,a,l,o,u,c;return null==e&&(e=null!=(r=null!=(s=null!=(n=this.params.search)?n:this.params.epmc)?s:this.params.doi)?r:""),e.startsWith("10.")&&!e.includes(" ")&&e.split("/").length>=2&&(e="DOI:"+e),"string"!=typeof e||e.startsWith("PMCID:")||!e.toLowerCase().startsWith("pmc")||e.includes(" ")||(e="PMCID:PMC"+e.toLowerCase().replace("pmc","")),"number"==typeof e&&(e="PMCID:PMC"+e),c="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(c+="&pageSize="+i),null!=t&&(c+="&cursorMark="+t),u={},await this.sleep(150),o=await this.fetch(c),u.total=o.hitCount,u.data=null!=(a=null!=(l=o.resultList)?l.result:void 0)?a:[],u.cursor=o.nextCursorMark,u.data.length&&this.waitUntil(this.src.epmc(u.data)),u},t.src.epmc.doi=async function(e,t){var i,r,s,n,a;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.doi),null!=(i=await this.src.epmc('doi:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?s:0)<24192e5);else{if((a=await this.src.epmc.search("DOI:"+e)).total)return a.data[0].doi||(a.data[0].doi=e,this.waitUntil(this.src.epmc(a.data[0]))),a.data[0];await this.src.epmc.notinepmc({id:e.replace(/\//g,"_"),doi:e,checkedAt:Date.now()})}},t.src.epmc.pmid=async function(e,t){var i,r,s,n,a;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.pmid),null!=(i=await this.src.epmc('pmid:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?s:0)<24192e5);else{if((a=await this.src.epmc.search("EXT_ID:"+e+" AND SRC:MED")).total)return a.data[0];await this.src.epmc.notinepmc({id:e,pmid:e,checkedAt:Date.now()})}},t.src.epmc.pmc=async function(e,t){var i,r,s,n,a,l;if(e||null==t&&(t=this.refresh),null==e&&(e=null!=(r=this.params.pmc)?r:this.params.pmcid),e="PMC"+e.toLowerCase().replace("pmc",""),null!=(i=await this.src.epmc('pmcid:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(n=null!=(a=await this.src.epmc.notinepmc(e))?a.checkedAt:void 0)?n:0)<24192e5);else{if((l=await this.src.epmc.search("PMCID:"+e)).total)return l.data[0];await this.src.epmc.notinepmc({id:e,pmcid:e,checkedAt:Date.now()})}},t.src.epmc.title=async function(e){var t,i,r;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(null!=(t=await this.src.epmc('title:"'+e+'"'))&&null!=(i=t.hits)?i.total:void 0)?t.hits.hits[0]._source:(r=await this.src.epmc.search('title:"'+e+'"')).total?r.data[0]:void 0},t.src.epmc.licence=async function(e,t,i,r){var s,n,a;if(e||null==r&&(r=this.refresh),null==e&&(e=null!=(n=null!=(a=this.params.licence)?a:this.params.pmcid)?n:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),e&&null==t&&(t=await this.src.epmc.pmc(e,r)),t||i){if(null!=(null!=t?t.calculated_licence:void 0)&&!r)return"not found"===t.calculated_licence.licence?void 0:t.calculated_licence;if(null==e&&(e=null!=t?t.pmcid:void 0),(null!=t?t.license:void 0)&&"string"==typeof t.license?(s={licence:t.license,source:"epmc_api"}).licence.startsWith("cc")&&(s.licence=s.licence.replace(/ /g,"-")):(!i&&e&&(i=await this.src.epmc.xml(e,t,r)),null!=this.licence&&i&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(s=await this.licence(void 0,i,"<permissions>","</permissions>"))?s.licence:void 0)&&(s.source="epmc_xml_permissions"),null==(null!=s?s.licence:void 0)&&null!=(null!=(s=await this.licence(void 0,i))?s.licence:void 0)&&(s.source="epmc_xml_outside_permissions")),null==(null!=s?s.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(s={licence:"non-standard-licence",source:"epmc_xml_permissions"})),null!=(null!=s?s.licence:void 0))return t.calculated_licence=s,await this.src.epmc(t.id,t),s;t.calculated_licence={licence:"not found"},await this.src.epmc(t.id,t)}},w=Date.now(),x=0,t.src.epmc.xml=async function(e,t,i){var r,s,n,a,l;if(null==e&&(e=null!=(n=null!=(a=this.params.xml)?a:this.params.pmcid)?n:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),null==i&&(i=this.refresh),e)try{return(r=await fs.readFile(this.S.directory+"/epmc/fulltext/"+e+".xml")).toString()}catch(n){if(null==t&&(t=await this.src.epmc.pmc(e,i)),i||!(null!=t?t.no_ft:void 0)){for(s=Date.now()-w;s<500||x>=2;)await this.sleep(500-s),s=Date.now()-w;if(w=Date.now(),x+=1,l="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&id="+e,r=await this.fetch(l),x-=1,"string"==typeof r&&r.length||null==t||(l="https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",r=await this.fetch(l)),"string"==typeof r&&r.length){try{await fs.writeFile(this.S.directory+"/epmc/fulltext/"+e+".xml",r)}catch(e){}return r}null!=t&&(t.no_ft=!0,await this.src.epmc(t.id,t))}}},t.src.epmc.fulltext=async function(e){var t,i,r;if(null==e&&(e=null!=(i=null!=(r=this.params.fulltext)?r:this.params.pmcid)?i:this.params.epmc),e)return await this.sleep(150),200===(null!=(t=await this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",{method:"HEAD"}))?t.status:void 0)},t.src.epmc.aam=async function(e,t,i,r){var s,n,a,l;if(null==e&&(e=null!=(n=null!=(a=this.params.aam)?a:this.params.pmcid)?n:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{e&&!t&&(t=await this.src.epmc.pmc(e,r))}catch(e){}return null==e&&(e=null!=t?t.pmcid:void 0),e?"string"==typeof(i=await this.src.epmc.xml(e,t,r))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),l="https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc",""),(s=await this.fetch(l))?"string"==typeof s?s.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||s.includes("Author manuscript; available in PMC")||s.includes("logo-nihpa.gif")||s.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}:null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},t.src.epmc.submitted=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d;if(null==e&&(e=null!=(o=null!=(u=null!=(c=null!=(p=this.params.submitted)?p:this.params.pmc)?c:this.params.pmcid)?u:this.params.PMC)?o:this.params.PMCID),null==i&&(i=this.refresh),e){e="PMC"+(e+"").toLowerCase().replace("pmc","");try{if(r=await this.src.epmc.xml(e,t,i)){if((r=r.split("<article-meta")[1].split("/article-meta")[0].split('date-type="received"')[1].split("</date")[0]).includes("<year")){d=r.split("<year")[1].split("</year>")[0].split(">").pop();try{d+="-"+r.split("<month")[1].split("</month>")[0].split(">").pop()}catch(e){d+="-01"}try{d+="-"+r.split("<day")[1].split("</day>")[0].split(">").pop()}catch(e){d+="-01"}r=d}else r=r.includes("<")?r.replace(">","").split("<")[0]:r.split('"')[1];if(r=r.replace("\n","").trim()){if(10!==r.length){for(l=[],h=r.split("T")[0].split("-"),n=0,a=h.length;n<a;n++)s=h[n],l.push(1===s.length?"0"+s:s);r=l.join("-")}return r}}}catch(e){}}},t.src.epmc.statement=async function(e,t,i,r){var s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C;if(null==e&&(e=null!=(_=null!=(v=null!=(b=null!=(w=this.params.statement)?w:this.params.pmc)?b:this.params.pmcid)?v:this.params.PMC)?_:this.params.PMCID),null==i&&(i=this.refresh),null==r&&(r=this.params.verbose),m=[],h=[],j=[],C=[],I=[],e&&(e="PMC"+(e+"").toLowerCase().replace("pmc",""),a=await this.src.epmc.xml(e,t,i)))for(a=a.split("<ref-list")[0].replace(/\<p\>/g,"").replace(/\<\/p\>/g,""),A="",l=0,o=(x=['"data',">Data",">Availab",">data",">Code",">code"]).length;l<o;l++){O=x[l];try{if(a.includes(O))for(j.push(O),f=(k=a.split(O)).shift();f&&(c=k.shift());){if(m.push(f.slice(-1e3)),D=f.split("<").pop().split(">")[0].split(" ")[0].replace("/",""),!O.startsWith('"')&&f.endsWith("><"+D)&&(D=f.split("</"+D+">").pop().split("><"+D)[0].split("<").pop().split(">")[0].split(" ")[0].replace("/","")),p=(O.startsWith('"')?c.split(/\>(.*)/s)[1]:c.startsWith("il")||c.startsWith("l")?"Availab":"Data")+c,h.push(p.slice(0,1e3)),p.includes("</"+D+">")&&p.indexOf("</"+D+">")<40)try{(u=(y=f.split("<"))[y.length-2].split(">")[0].split(" ")[0]).startsWith("/")||(D=u)}catch(e){}if(C.push(D),S="\n"+(g=f.split("<"+D)).slice(0,g.length-1).pop().split("\n").pop()+"</"+D+">",p.split("</"+D+">")[0].includes("\n"))for(;!p.includes(S)&&k.length;)p+=(O.startsWith(">")?">":"")+(k[0].startsWith("il")||k[0].startsWith("l")?"Availab":"Data")+k.shift();p=(p=p.split(S)[0]).replace("</title>","|TTT|").replace(/\n/g," ").replace(/\s+/g," ").replace(/(<([^>]+)>)/gi,""),d=(m[m.length-1]+p).toLowerCase(),p.length>20&&p.length<3e3&&(d.includes("availab")||d.includes("accessib"))&&(d.includes("data")||d.includes("code"))&&(p.includes("|TTT|")&&(p=p.split("|TTT|")[1]),n=(s=(s=(s=(await this.decode(p.trim())).replace(/"/g,"").replace(/\s+/g," ")).replace("<title","").replace("<p","")).trim()).toLowerCase(),s.length>20&&(n.includes("data")||n.includes("code")||n.includes("availab")||n.includes("accessib"))&&!A.includes(n)&&(A+=n,I.push(s))),f=c}}catch(e){}}return r?{pmcid:e,file:"https://static.oa.works/epmc/fulltext/"+e+".xml",pres:m,posts:h,splits:j,tags:C,statements:I,url:I?await this.src.epmc.statement.url(void 0,void 0,I,i):void 0}:I.length?I:void 0},t.src.epmc.statement.url=async function(e,t,i,r){var s,n,a,l,o,u;for(null==i&&(i=await this.src.epmc.statement(e,t,r)),u=[],s=(e,t)=>{var i,r,s,n,a;for((r=e.split(t)).shift(),a=[],s=0,n=r.length;s<n;s++)(i=t+(i=r[s]).split(" ")[0]).length>10&&i.includes("/")?((i=i.toLowerCase()).includes(")")&&(e.includes("(h")||e.includes("(10"))&&(i=i.split(")")[0].replace("(","")),i.endsWith(".")&&(i=i.slice(0,-1)),i.startsWith("10.")&&(i="https://doi.org/"+i),R.call(u,i)<0?a.push(u.push(i)):a.push(void 0)):a.push(void 0);return a},a=0,l=(o=null!=i?i:[]).length;a<l;a++)(n=o[a]).includes("http")&&await s(n,"http"),n.includes("10.")&&await s(n,"10.");return u.length?u:void 0},null==(O=r.src).google&&(O.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}t.src.google=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h;return null==e&&(e=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(n=this.params)?n.google:void 0),null==t&&(t=null!=(a=this.S.src.google)&&null!=(l=a.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(p=c.search)?p.key:void 0),e&&t&&i?(h="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(h)):{}},t.src.google.sheets=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x;if(null==e&&(e=this.copy(this.params)),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(c=e.sheet)?c:e.sheets,delete e.sheet,delete e.sheets),!e.sheetid)return[];if(e.sheetid.startsWith("http")&&e.sheetid.includes("sheets.googleapis.com/v4/")?b=e.sheetid:(e.sheetid.includes("/spreadsheets/")?(_=e.sheetid.replace("/spreadsheets/d/","/spreadsheets/").split("/spreadsheets/")[1].split("/")[0],!e.sheet&&e.sheetid.includes("/values/")&&(e.sheet=e.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),e.sheetid=_):2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="Sheet1"),b="https://sheets.googleapis.com/v4/spreadsheets/"+e.sheetid+"/values/"+e.sheet+"?alt=json&key="+(null!=(p=null!=(h=this.S.src.google)&&null!=(d=h.secrets)?d.serverkey:void 0)?p:null!=(f=this.S.src.google)&&null!=(m=f.secrets)?m.apikey:void 0)),t=await this.fetch(b,{headers:{"Cache-Control":"no-cache"}}),!1===e.values)return t;if(!1===e.headers)return t.values;if(Array.isArray(e.headers))s=e.headers;else if(s=[],null!=t.values)for(n=0,o=(v=t.values.shift()).length;n<o;n++){r=v[n];try{r=r.trim()}catch(e){}s.push(r)}for(x=[],a=0,u=(g=null!=(y=t.values)?y:[]).length;a<u;a++){for(i in l=g[a],w={},s)try{w[s[i]]=l[i]}catch(e){}"{}"!==JSON.stringify(w)&&x.push(w)}return x},t.src.google.sheets._bg=!0,t.src.google.sheets._log=!1,null==(O=r.src).microsoft&&(O.microsoft={});try{r.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(e){}t.src.microsoft={},t.src.microsoft.bing=async function(e,t,i,s,n){var a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x;return null==e&&(e=null!=(a=null!=(l=null!=this&&null!=(d=this.params)?d.bing:void 0)?l:null!=this&&null!=(f=this.params)?f.q:void 0)?a:null!=this&&null!=(m=this.params)?m.query:void 0),null==t&&(t=null!=(y=null!=this&&null!=(g=this.params)?g.key:void 0)?y:null!=(_=r.src.microsoft.bing)?_.key:void 0),null==i&&(i=null!=(v=null!=this&&null!=(b=this.params)?b.market:void 0)?v:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==n&&(n=null!=(c=null!=this&&null!=(p=this.params)?p.cache:void 0)?c:259200),null!=e&&null!=t&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+e,null!=(w=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":t},cache:n}))&&null!=(h=w.webPages)?h.value:void 0)?{total:w.webPages.totalEstimatedMatches,data:w.webPages.value}:{total:0,data:[]}},t.src.microsoft.bing._auth="@oa.works",null==(O=r.src).oadoi&&(O.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(e){}t.src.oadoi={_index:{settings:{number_of_shards:15}}},t.src.oadoi._key="doi",t.src.oadoi._prefix=!1,t.src.oadoi.search=async function(e){var t,i,s;if(null==e&&(e=null!=(t=null!=(i=this.params.oadoi)?i:this.params.doi)?t:this.params.search),"string"==typeof e&&e.startsWith("10."))return await this.sleep(900),s="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,this.fetch(s)},t.src.oadoi.doi=async function(e){var t,i,s;if(null==e&&(e=this.params.doi),"string"==typeof e&&e.startsWith("10.")){if(t=await this.src.oadoi(e))return t;try{if(await this.sleep(500),s="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,(i=await this.fetch(s))&&i.doi)return await this.src.oadoi(i),i}catch(e){}}},t.src.oadoi.hybrid=async function(e){var t,i,r,s,n,a;if(null==e&&(e=null!=(s=null!=(n=this.params.hybrid)?n:this.params.issn)?s:this.params.issns),"object"!=typeof e||Array.isArray(e)||(e=null!=(a=e.journal_issns)?a:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return(r="journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(r="("+r+")"),t=await this.src.oadoi.count(r+' AND oa_status:"closed"'),i=await this.src.oadoi.count(r+' AND oa_status:"hybrid"'),!!(t&&i/t>.001)},t.src.oadoi.load=async function(){var e,t,i,r,s,n,a,l,o,u;a=await this.epoch(),r=this.S.directory+"/import/oadoi/snapshot.jsonl";try{await fs.stat(r)}catch(e){C.log("OADOI downloading snapshot"),n=await fetch("https://api.unpaywall.org/feed/snapshot?api_key="+this.S.src.oadoi.apikey),u=fs.createWriteStream(r),await new Promise(((e,t)=>(n.body.pipe(u),n.body.on("error",t),u.on("finish",e)))),C.log("snapshot downloaded")}for(this.params.clear&&await this.src.oadoi(""),o=0,e=[],s="",t=!1,(l=fs.createReadStream(r).pipe(zlib.createGunzip())).on("data",(async t=>{var i,r,n;for("string"==typeof(i=t.toString("utf8"))&&i&&(s+=i);s.includes("\n");){[r,s]=s.replace("\n","X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),n={};try{n=JSON.parse(r)}catch(e){}(null!=n?n.doi:void 0)?e.push(n):C.log("oadoi load failed to parse record from string",r),e.length>=1e4&&(o+=e.length,C.log("OADOI bulk loading",e.length,o),await this.src.oadoi(e),e=[])}return null!=s?s:s=""})),l.on("error",(e=>C.log("oadoi load file stream error",JSON.stringify(e)))),l.on("end",(()=>(C.log("stream complete for oadoi load"),t=!0)));!t;)C.log("oadoi load streaming file",s.length,o,Math.floor((Date.now()-a)/1e3/60)+"m"),await this.sleep(3e4);return e.length&&await this.src.oadoi(e),i=Date.now(),C.log("oadoi load complete",o,a,i,Math.floor((i-a)/1e3/60)+"m"),o},t.src.oadoi.load._bg=!0,t.src.oadoi.load._async=!0,t.src.oadoi.load._log=!1,t.src.oadoi.changes=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g;if(y=this.S.directory+"/import/oadoi/upto",null==e&&(e=this.params.changes),!e)try{e=parseInt((await fs.readFile(y)).toString())}catch(e){}if(!e)try{n=await this.src.oadoi("*",{size:1,sort:{updated:{order:"desc"}}}),e=new Date(n.updated).valueOf()}catch(e){}if(e){for(i=0,r=0,m=!1,s=0,l=(d=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;s<l;s++){if(p=d[s],c=new Date(p.last_modified).valueOf(),C.log(p.last_modified,c,e,null!=n?n.updated:void 0),"jsonl"===p.filetype&&(!e||c>e)){for await(u of(C.log("OADOI importing changes for",p.last_modified),r+=1,t=[],a=0,o=this.S.directory+"/import/oadoi/"+p.date+".jsonl.gz",f=await fetch(p.url),g=fs.createWriteStream(o),await new Promise(((e,t)=>(f.body.pipe(g),f.body.on("error",t),g.on("finish",e)))),readline.createInterface({input:fs.createReadStream(o).pipe(zlib.createGunzip())})))m=c,a+=1,(h=JSON.parse(u.trim().replace(/\,$/,"")))._id=h.doi.replace(/\//g,"_"),t.push(h),i+=1,t.length>=3e4&&(C.log("OADOI bulk loading changes",r,t.length,a),await this.src.oadoi(t),t=[]);t.length&&await this.src.oadoi(t),fs.unlink(o)}if(m)try{await fs.writeFile(y,m)}catch(e){}}return C.log("oadoi changes complete",r,i),i}C.log("Timestamp day to work since is required - run load first to auto-generate")},t.src.oadoi.changes._bg=!0,t.src.oadoi.changes._async=!0,t.src.oadoi.changes._log=!1,t.src.oadoi.changes._auth="root",t.src.oadoi.changes._notify=!1,null==(O=r.src).openai&&(O.openai={});try{r.src.openai=JSON.parse(SECRETS_OPENAI)}catch(e){}t.src.openai={},t.src.openai.chat=async function(e,t,i,r){var s,n,a,l,o,u,c,p,h;return null==e&&(e=null!=(a=null!=(l=null!=(o=this.params.chat)?o:this.params.prompt)?l:this.params.q)?a:""),null==t&&(t=null!=(u=this.params.role)?u:"You are a helpful assistant"),null==i&&(i=null!=(c=this.params.model)?c:"gpt-4-1106-preview"),null==r&&(r=this.params.json),"string"==typeof e&&e.length&&(null!=(p=this.S.src.openai)?p.key:void 0)?(s={"Content-Type":"application/json",Authorization:"Bearer "+this.S.src.openai.key},n={model:i,messages:[]},r&&(n.response_format={type:"json_object"}),h={role:"system",content:t},n.messages.push(h),e={role:"user",content:e},n.messages.push(e),await this.fetch("https://api.openai.com/v1/chat/completions",{headers:s,body:n})):{}},t.src.openai.chat._auth="@oa.works",R=[].indexOf,null==(O=r.src).openalex&&(O.openalex={});try{r.src.openalex=JSON.parse(SECRETS_OPENALEX)}catch(e){}t.src.openalex=function(){return!0},t.src.openalex.works={_index:{settings:{number_of_shards:15}},_prefix:!1},t.src.openalex.works._format=function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E;for(i=0,a=(m=["concepts","topics","keywords","sustainable_development_goals","domains","fields","subfields","authorships","locations"]).length;i<a;i++)for(r=0,l=(w=null!=(y=e[m[i]])?y:[]).length;r<l;r++){E=w[r];try{null!=E.score&&(E.score=Math.floor(E.score))}catch(e){}try{null!=E.id&&"string"!=typeof E.id&&(E.id="https://openalex.org/"+E.id)}catch(e){}for(s=0,o=(x=["source","author","institutions","domain","field","subfield"]).length;s<o;s++){D=x[s];try{null!=(null!=(O=E[D])?O.id:void 0)&&"string"!=typeof E[D].id&&(E[D].id="https://openalex.org/"+E[D].id)}catch(e){}}}for(n=0,u=(k=["best_oa_location","primary_location","primary_topic"]).length;n<u;n++){h=k[n];try{(null!=(j=e[h])?j.score:void 0)&&(e[h].score=Math.floor(e[h].score))}catch(e){}try{null!=(null!=(S=e[h])?S.id:void 0)&&"string"!=typeof e[h].id&&(e[h].id="https://openalex.org/"+e[h].id)}catch(e){}for(d=0,c=(A=["source","domain","field","subfield"]).length;d<c;d++){D=A[d];try{null!=(null!=(I=e[h][D])?I.id:void 0)&&"string"!=typeof e[h][D].id&&(e[h][D].id="https://openalex.org/"+e[h][D].id)}catch(e){}}}try{e._id=null!=(g=null!=(_=e.doi)?_:e.DOI)?g:null!=(v=e.ids)?v.doi:void 0,e._id.includes("http")&&e._id.includes("/10.")&&(e._id="10."+e._id.split("/10.").pop()),e._id&&e._id.startsWith("10.")||(e._id=e.id.split("/").pop())}catch(t){e._id=e.id.split("/").pop()}try{for(C in t=[],e.abstract_inverted_index)for(b=e.abstract_inverted_index[C],f=0,p=b.length;f<p;f++)t[b[f]]=C;t.length&&(e.abstract=t.join(" "))}catch(e){}try{delete e.abstract_inverted_index}catch(e){}return e},t.src.openalex.works.doi=async function(e,t,i){var r,s,n;return null==e&&(e=this.params.doi),null==t&&"src.openalex.works.doi"===this.fn&&(t=this.refresh),null==i&&(i=null==(s=this.params.save)||s),!t&&(r=await this.src.openalex.works('ids.doi.keyword:"https://doi.org/'+e+'"',1))||(r=await this.fetch("https://api.openalex.org/works/https://doi.org/"+e+((null!=(n=this.S.src.openalex)?n.apikey:void 0)?"?api_key="+this.S.src.openalex.apikey:"")))&&r.id&&(r=await this.src.openalex.works._format(r),i&&await this.src.openalex.works(r)),r},t.src.openalex.works.title=async function(e){if(null!=e?e:e=this.params.title)return await this.src.openalex.works('title:"'+e+'"',1)},t.src.openalex.manifest=async function(){var e,t,i,r,s;if("works"!==(s=null!=(t=null!=(i=this.params.manifest)?i:this.params.openalex)?t:"works"))return!1;e=async e=>{var t,i,r,s,n,a,l;for(l="",s=0,r=0,n=(a=e.entries).length;r<n;r++)i=a[r].url.split("=")[1].split("/")[0],(t=await this.epoch(i))>s&&(s=t,l=i);return l},(r={last:"",previous:"",manifest:await this.fetch("https://openalex.s3.amazonaws.com/data/"+s+"/manifest")}).last=await e(r.manifest);try{r.previous=await e(JSON.parse((await fs.readFile(this.S.directory+"/import/openalex/data/"+s+"/manifest")).toString()))}catch(e){}return r},t.src.openalex.load=async function(e,t,i,r,s,n){var a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,E,N,L,P,q,T,W,M,U,z,B,F,J,$,X;if(F=await this.epoch(),null==e&&(e=null!=(D=null!=(E=this.params.load)?E:this.params.openalex)?D:"works"),"works"!==e)return!1;S=null!=(N=this.params.onlyinfo)&&N,null==t&&(t=this.params.changes),m=this.S.directory+"/import/openalex/data/"+e,null==n&&(n=this.params.toalias),"number"==typeof n&&(n+=""),n="15032024",null==i&&(i=this.params.clear),i&&(C.log("clearing",e,n),await this.index._send("src_openalex_"+e,"",void 0,!1,n),await this.sleep(2e4),await this.index._send("src_openalex_"+e,{settings:{number_of_shards:15}},void 0,!1,n),C.log("cleared and mapped"),await this.sleep(1e3)),null==s&&(s=0),v="";try{for(A=(await fs.readFile(m+"/manifest")).toString(),L=JSON.parse(A).entries,d=0,b=L.length;d<b;d++)c=L[d].url.split("=")[1].split("/")[0],(u=await this.epoch(c))>s&&(s=u,v=c)}catch(e){}if(null==r&&(r=null!=(P=this.params.sync)&&P),r&&(C.log("Openalex load syncing",e),J=await this._child("aws",["s3","sync","s3://openalex/data/"+e,m,"--no-sign-request"]),C.log("Openalex sync returned",J)),"string"==typeof t&&(t=[t]),!0===t)for(C.log("Checking for Openalex changes in",e),t=[],r||(await fs.writeFile(m+"/manifest"+(S?"info":""),await this.fetch("https://openalex.s3.amazonaws.com/data/"+e+"/manifest",{buffer:!0})),C.log("Openalex manifest "+(S?"temp saved for info":"updated"))),y=0,w=(q=JSON.parse((await fs.readFile(m+"/manifest"+(S?"info":""))).toString()).entries).length;y<w;y++)u=q[y].url.split("=")[1].split("/")[0],R.call(t,u)<0&&await this.epoch(u)>s&&t.push(u);for(C.log(t,s,v),g=0,x=(T=null!=t?t:[]).length;g<x;g++){o=T[g],C.log("Openalex checking if sync required for possibly changed files",e,o);try{await fs.stat(m+"/updated_date="+o)}catch(t){await this._child("aws",["s3","sync","s3://openalex/data/"+e+"/updated_date="+o,m+"/updated_date="+o,"--no-sign-request"]),C.log(o,"was not present, now synced")}}for(l=!0,$=0,p=0,I=0,B=[],a=async t=>{var i,r,s;for await(r of(i=[],readline.createInterface({input:fs.createReadStream(t).pipe(zlib.createGunzip())})))s=JSON.parse(r.trim().replace(/\,$/,"")),$+=1,i.push(await this.src.openalex.works._format(s)),i.length>=2e4&&(C.log("Openalex "+e+" "+n+" bulk loading",t,i.length,$),await this.index._bulk("src_openalex_"+e,i,void 0,void 0,!1,n),i=[]);return i.length&&(C.log("Openalex "+e+" "+n+" bulk loading final set for",t,i.length,p,I,$),await this.index._bulk("src_openalex_"+e,i,void 0,void 0,!1,n)),C.log("removing",t),await fs.unlink(t),I+=1,B.splice(B.indexOf(t),1),!0},_=0,O=(W=await fs.readdir(m)).length;_<O;_++)if(!(X=W[_]).startsWith("manifest")&&(null==t||(M=X.split("=")[1],R.call(t,M)>=0))){for(j=0,k=(U=await fs.readdir(m+"/"+X)).length;j<k;j++)if(f=U[j],l){for(p+=1;5===B.length;)await this.sleep(3e3);h=m+"/"+X+"/"+f,S?C.log("Openalex load would run",h):(B.push(h),C.log("Openalex load running",B),a(h))}else C.log("awaiting catch up",X,f,l),X.includes(l[0])&&(1===l.length||f.includes(l[1]))&&(l=!0);for(;0!==B.length;)await this.sleep(5e3);await fs.rmdir(m+"/"+X)}if(S)try{await fs.unlink(m+"/manifestinfo")}catch(e){}else null!=A&&Array.isArray(t)&&t.length&&await fs.writeFile(m+"/manifestprevious",A);return z={started:F,took:await this.epoch()-F,expected:p,processed:I,total:$,sync:r,last:s,lasth:v,changes:t},await this.mail({to:["mark+notifications@oa.works","joe+notifications@oa.works"],subject:"Openalex works load or changes "+$,text:JSON.stringify(z)}),C.log(z),z},t.src.openalex.load._bg=!0,t.src.openalex.load._log=!1,t.src.openalex.load._auth="root",t.src.openalex.changes=async function(e){var t,i,r,s,n;if(s=await this.epoch(),C.log("Openalex checking for changes by running load on comparison to manifest"),r=await this.src.openalex.load(void 0,!0),n=(t=await this.epoch())-s,"src.openalex.changes"!==this.fn)for(;n<36e5;)i=36e5-n,C.log("Openalex changes waiting",i,"to loop"),await this.sleep(i),n=(t=await this.epoch())-s;return C.log("Openalex changes took",t-s),r},t.src.openalex.changes._log=!1,t.src.openalex.changes._bg=!0,t.src.openalex.changes._async=!0,t.src.openalex.changes._auth="root",t.src.openalex.sources={_index:!0,_prefix:!1},t.src.openalex.sources.load=async function(){var e,t,i,r,s,n,a,l,o,u;for(await this.src.openalex.sources(""),o=0,e=[],u="https://api.openalex.org/sources?"+((null!=(s=this.S.src.openalex)?s.apikey:void 0)?"api_key="+this.S.src.openalex.apikey+"&":"")+"per-page=200&cursor=",l=await this.fetch(u+"*");null!=l&&"object"==typeof l&&Array.isArray(l.results)&&l.results.length;){for(t=0,i=(n=l.results).length;t<i;t++)(r=n[t])._id=r.id.split("/").pop(),e.push(r);e.length>=2e4?(o+=e.length,await this.src.openalex.sources(e),e=[]):await this.sleep(200),(null!=(a=l.meta)?a.next_cursor:void 0)&&(l=await this.fetch(u+encodeURIComponent(l.meta.next_cursor)))}return e.length&&await this.src.openalex.sources(e),o},t.src.openalex.sources.load._async=!0,t.src.openalex.sources.load._bg=!0,t.src.openalex.hybrid=async function(e){var t,i,r,s,n;if(null==e&&(e=null!=(s=null!=(n=this.params.hybrid)?n:this.params.issn)?s:this.params.issns),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return r='(locations.source.issn.keyword:"'+e.join('" OR locations.source.issn.keyword:"')+'" OR locations.source.issn_l.keyword:"'+e.join('" OR locations.source.issn_l.keyword:"')+'")',t=await this.src.openalex.works.count(r+' AND open_access.oa_status:"closed"'),i=await this.src.openalex.works.count(r+' AND open_access.oa_status:"hybrid"'),t&&i/t>.001},R=[].indexOf,t.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},t.src.pubmed.doi=async function(e){var t;if(null==e&&(e=this.params.doi),e&&(t=await this.src.pubmed('identifier.doi:"'+e+'"',1)))return t},t.src.pubmed.pmc=async function(e){var t;if(null==e&&(e=this.params.pmc),e&&(t=await this.src.pubmed('identifier.pmc:"PMC'+e.toString().toLowerCase().replace("pmc","")+'"',1)))return t},t.src.pubmed.entrez={},t.src.pubmed.entrez.summary=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v;v="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),v+="&id="+i):v+="&query_key="+e+"&WebEnv="+t;try{for(p=await this.convert.xml2json(await this.fetch(v)),d=[],Array.isArray(p.eSummaryResult.DocSum)||(p.eSummaryResult.DocSum=[p.eSummaryResult.DocSum]),f=p.eSummaryResult.DocSum,s=0,o=f.length;s<o;s++){for(r={id:(h=f[s]).Id},m=h.Item,a=0,u=m.length;a<u;a++)if("List"===(n=m[a])._.Type){if(r[n._.Name]=[],null!=n.Item)for(y=n.Item,l=0,c=y.length;l<c;l++)g=y[l],(_={})[g._.Name]=g.$,r[n._.Name].push(_)}else r[n._.Name]=n.$;if(d.push(r),null==i||!i.includes(","))return d[0]}return d}catch(e){}},t.src.pubmed.entrez.pmid=async function(e){var t,i,r;null==e&&(e=this.params.pmid),r="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return await this.sleep(200),t=await this.fetch(r),i=await this.convert.xml2json(t),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey,i.ePostResult.WebEnv)}catch(e){}},t.src.pubmed.search=async function(e,t,i=10,r=!1){var s,n,a,l,o,u,c,p,h,d,f,m;null==e&&(e=null!=(c=this.params.search)?c:this.params.q),m="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof r&&(r=r.split(",")),Array.isArray(r))h={total:r.length,data:[]};else{if(await this.sleep(200),h=await this.fetch(m),h={total:(d=await this.convert.xml2json(h)).eSearchResult.Count[0],data:[]},!0===r)return h.data=d.eSearchResult.IdList[0].Id,h;r=d.eSearchResult.IdList[0].Id}if(t)for(s=0,a=r.length;s<a&&(f=r[s],o=await this.src.pubmed.pmid(f),h.data.push(o),h.data.length!==i);s++);else for(p=await this.src.pubmed.entrez.summary(void 0,void 0,r),n=0,l=p.length;n<l&&(u=p[n],h.data.push(u),h.data.length!==i);n++);return h}catch(e){}},t.src.pubmed.pmid=function(e){null==e&&(e=this.params.pmid);try{return this.src.pubmed.entrez.pmid(e)}catch(e){}},t.src.pubmed.aheadofprint=async function(e){null==e&&(e=this.params.pmid);try{return await this.sleep(100),(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).includes("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){}},t.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},t.src.pubmed.availability=async function(e){var t,i,r,s,n;return null==e&&(e=null!=(t=null!=(i=null!=(r=null!=(s=null!=(n=this.params.pubmed)?n:this.params.availability)?s:this.params.pmc)?r:this.params.pmcid)?i:this.params.PMC)?t:this.params.PMCID),e="pmc"+(e+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(e)},t.src.pubmed.availability.statement=function(e,i){return t.src.epmc.statement(e,i)},t.src.pubmed.load=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m;for(null==e&&"changes"===this.params.load&&(e=!0),f=null!=(c=this.params.streamers)?c:1,a=null!=(p=this.params.howmany)?p:-1,this.refresh&&!e&&await this.src.pubmed(""),i=e?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",s=[],n="number"==typeof this.params.load?this.params.load:"number"==typeof this.params.changes?this.params.changes:void 0,l=0,o=(h=(await this.fetch(i)).split('href="')).length;l<o;l++)(r=h[l].split('"')[0]).endsWith(".gz")&&r.includes(n+".xml")||!n&&r.startsWith("pubmed")&&r.endsWith(".gz")&&("baseline"===this.params.load||this.refresh&&!e||!await this.src.pubmed.count('srcfile:"'+i+r+'"'))?s.push(i+r):r.endsWith(".md5")||C.log("pubmed load skipping file",i+r);for(d=0,m=0,t=async t=>{var i,r,n,l,o,u,c,p,h,f,y,g,_,v,b,w,x,O,k,j,S;C.log("Pubmed loading"+(e?" changes":""),t,s.length,d),u=[],b={};try{for await(g of readline.createInterface({input:(await fetch(t)).body.pipe(zlib.createGunzip())}))if("</PubmedArticle>"===(g=g.trim().replace("&amp;","&"))){if(m+=1,b.srcfile=t,b._id=b.PMID,u.push(b),b={},m===a)break}else if(!(g.startsWith("<?")||g.includes("?xml")||g.includes("!DOCTYPE")||g.includes("/>")||g.includes("PubmedArticle")||g.includes("PubmedData")||g.includes("History")||g.includes("ArticleIdList")||g.includes("List>"))){for(h in g.split(">")[0].split(" ")[0].replace("<",""),f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(g.includes(h)||g.includes(h.replace(">"," ")))&&null==b[v=f[h]]&&(b[v]=g.split(">")[1].split("</")[0]);if(g.includes("<MedlinePgn>"))b.pages=g.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ");else if(g.includes("<ISSN"))null==b.ISSN&&(b.ISSN=[]),S=g.split(">")[1].split("</")[0],R.call(b.ISSN,S)<0&&b.ISSN.push(S);else if(g.includes("<Keyword>"))null==b.keyword&&(b.keyword=[]),S=g.split(">")[1].split("</")[0],R.call(b.keyword,S)<0&&b.keyword.push(S);else if(g.includes("<GeneSymbol>"))null==b.gene&&(b.gene=[]),S=g.split(">")[1].split("</")[0],R.call(b.gene,S)<0&&b.gene.push(S);else if(g.includes("<PublicationType>")||g.includes("<PublicationType "))null==b.type&&(b.type=[]),S=g.split(">")[1].split("</")[0],R.call(b.type,S)<0&&b.type.push(S);else if(g.includes("<Chemical>"))null==b.chemical&&(b.chemical=[]),b.chemical.push({});else if(g.includes("<NameOfSubstance>")||g.includes("<NameOfSubstance "))null==b.chemical&&(b.chemical=[{}]),b.chemical[b.chemical.length-1].name=g.split(">")[1].split("</")[0],b.chemical[b.chemical.length-1].nameID=g.split('UI="')[1].split('"')[0];else if(g.includes("<RegistryNumber>"))null==b.chemical&&(b.chemical=[{}]),b.chemical[b.chemical.length-1].registry=g.split(">")[1].split("</")[0];else if(g.includes("<DataBank>")||g.includes("<DataBank "))null==b.databank&&(b.databank=[]),b.databank.push({});else if(g.includes("<DataBankName>"))null==b.databank&&(b.databank=[{}]),b.databank[b.databank.length-1].name=g.split(">")[1].split("</")[0];else if(g.includes("<AccessionNumber>"))null==b.databank&&(b.databank=[{}]),null==(r=b.databank[b.databank.length-1]).accession&&(r.accession=[]),b.databank[b.databank.length-1].accession.push(g.split(">")[1].split("</")[0]);else if(g.includes("<Grant>")||g.includes("<Grant "))null==b.grant&&(b.grant=[]),b.grant.push({});else if(g.includes("<GrantID>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].id=g.split(">")[1].split("</")[0];else if(g.includes("<Acronym>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].acronym=g.split(">")[1].split("</")[0];else if(g.includes("<Agency>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].agency=g.split(">")[1].split("</")[0];else if(g.includes("<Country>"))b.grant&&!b.grant[b.grant.length-1].country||b.country?b.grant&&b.grant.length&&(b.grant[b.grant.length-1].country=g.split(">")[1].split("</")[0]):b.country=g.split(">")[1].split("</")[0];else if(g.includes("<MeshHeading>")||g.includes("<MeshHeading "))null==b.mesh&&(b.mesh=[]),b.mesh.push({});else if(g.includes("<DescriptorName>")||g.includes("<DescriptorName "))null==b.mesh&&(b.mesh=[{}]),b.mesh[b.mesh.length-1].description=g.split(">")[1].split("</")[0],b.mesh[b.mesh.length-1].descriptionID=g.split('UI="')[1].split('"')[0];else if(g.includes("<QualifierName>")||g.includes("<QualifierName "))null==b.mesh&&(b.mesh=[{}]),null==(n=b.mesh[b.mesh.length-1]).qualifier&&(n.qualifier=[]),b.mesh[b.mesh.length-1].qualifier.push({name:g.split(">")[1].split("</")[0],id:g.split('UI="')[1].split('"')[0]});else if(g.includes("<Author>")||g.includes("<Author ")||g.includes("<Investigator>")||g.includes("<Investigator "))null==b.author&&(b.author=[]),b.author.push(g.includes("<Investigator")?{investigator:!0}:{});else if(g.includes("<LastName>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].lastname=g.split(">")[1].split("</")[0];else if(g.includes("<ForeName>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].firstname=g.split(">")[1].split("</")[0];else if(g.includes("<Affiliation>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].affiliation=g.split(">")[1].split("</")[0];else if(g.includes("<Identifier>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].identifier=g.split(">")[1].split("</")[0];else if(g.includes("<Note>")||g.includes("<Note ")||g.includes("<GeneralNote>")||g.includes("<GeneralNote "))null==b.notes&&(b.notes=[]),b.notes.push(g.split(">")[1].split("</")[0]);else if(g.includes("<DeleteCitation>")||g.includes("<DeleteCitation "))b.deletedFromMedline=!0;else if(g.includes("<ArticleId>")||g.includes("<ArticleId ")){null==b.identifier&&(b.identifier={});try{c=g.split('IdType="')[1].split('"')[0],null==(l=b.identifier)[c]&&(l[c]=g.split(">")[1].split("</")[0])}catch(e){}}else if(!g.includes("</")&&(g.includes("Date>")||g.includes("<Date")||g.includes("<PubMedPubDate")||g.includes("<ArticleDate>")||g.includes("ArticleDate ")||g.includes("<PubDate>")||g.includes("<PubDate "))){k=g.split(">")[0].split(" ")[0].replace("<","");try{(_=g.toLowerCase()).includes("pubstatus")&&(j=_.split(">")[0].split("pubstatus")[1]),j.includes('"')&&(j=j.split('"')[1])}catch(e){}}else if(k&&(g.includes("<Year>")||g.includes("<Month>")||g.includes("<Day>"))){null==b.dates&&(b.dates={}),O=k+(j?"_"+j:""),null==(o=b.dates)[O]&&(o[O]={}),b.dates[O][g.split(">")[0].replace("<","").toLowerCase()]=g.split(">")[1].split("</")[0],delete b.dates[O].date,delete b.dates[O].timestamp;try{b.dates[O]=await this.dateparts(b.dates[O])}catch(e){}try{j&&(b.dates[O].pubstatus=j)}catch(e){}}else if(k&&g.includes("</"+k))k="",j="";else if(g.includes("<Reference>")||g.includes("<Reference "))null==b.references&&(b.references=[]);else if(g.includes("<Citation")){null==b.references&&(b.references=[]),x={author:[]};try{for(w=g.split(". ")[0].split(", "),p=0,y=w.length;p<y;p++)i=w[p],x.author.push({name:i})}catch(e){}try{x.title=g.split(". ")[1].split("?")[0].trim()}catch(e){}try{x.journal=g.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{g.includes("doi.org/")&&(x.doi=g.split("doi.org/")[1].split(" ")[0].trim())}catch(e){}try{x.url="http"+rc.split("http")[1].split(" ")[0]}catch(e){}"{}"!==JSON.stringify(x)&&b.references.push(x)}}u.length&&(await this.src.pubmed(u),C.log(t,m))}catch(e){}return d-=1};s.length&&!(a>0&&m>=a);)await this.sleep(1e3),d<f&&(d+=1,u=s.shift(),await t(u));return C.log(m,s.length),this.params.howmany?batch:m},t.src.pubmed.load._bg=!0,t.src.pubmed.load._log=!1,t.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},t.src.pubmed.changes._bg=!0,t.src.pubmed.changes._log=!1,t.src.pubmed.changes._notify=!1,t.src.ror={_index:!0,_prefix:!1},t.src.ror.query=function(e){var t;if(null==e&&(e=null!=(t=this.params.query)?t:this.params.q),"string"==typeof e)return this.fetch('https://api.ror.org/organizations?query="'+e+'"')},t.src.ror.ror=async function(e,t){var i,r,s;if(null==t&&(t=this.refresh),null==e&&(e=this.params.ror),"string"==typeof e&&!e.includes(" ")&&(e=e.split("/").pop()).length<11){if((null!=(r=t?void 0:await this.src.ror(e))?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.fetch("https://api.ror.org/organizations/"+e))?r.id:void 0)return s=await this.src.ror._format(r),this.waitUntil(this.src.ror(s)),s}},t.src.ror.grid=async function(e){var t,i,r,s;if(null==e&&(e=this.params.grid),"string"==typeof e&&e.startsWith("grid.")){if((null!=(r=await this.src.ror('external_ids.GRID.all:"'+e+'"'))?r.id:void 0)||1===(null!=r&&null!=(t=r.hits)?t.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(e))&&null!=(i=r.items)?i[0]:void 0)return s=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(s)),s}},t.src.ror.title=async function(e){var t,i,r,s,n;if(null==e&&(e=null!=(t=this.params.title)?t:this.params.q),"string"==typeof e){if(this.refresh||(s=await this.src.ror('title:"'+e+'"')),(null!=s?s.id:void 0)||1===(null!=s&&null!=(i=s.hits)?i.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(e))&&null!=(r=s.items)?r[0]:void 0)return n=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(n)),n}},t.src.ror._format=async function(e,t){try{e._id=e.id.split("/").pop()}catch(e){}return null==e.createdAt&&(e.createdAt=null!=t?t:await this.epoch()),e},t.src.ror.dumps=function(){return this.fetch("https://zenodo.org/api/records/?communities=ror-data&sort=mostrecent")},t.src.ror.load=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y;null==e&&(e=this.refresh),m=0,t=[];try{n=await this.src.ror.dumps(),null==e&&(o=await this.epoch(n.hits.hits[0].created.split("+")[0]),null!=(null!=(l=await this.src.ror("src:*",{sort:{createdAt:"desc"},size:1}))?l.hits:void 0)&&(l=l.hits.hits[0]._source))}catch(e){}if(C.log(o,null!=l?l.createdAt:void 0,null!=l?l.src:void 0),e||null==l||null==o||null!=l&&null!=o&&l.createdAt<o)for await(u of(a=n.hits.hits[0].files[0].links.self,C.log(a),i=await this.epoch(),f=!1,s=!1,c="",r=a.replace("/content","").split("/").pop(),d=this.S.directory+"/import/ror/"+r,h=await fetch(a),y=fs.createWriteStream(d),await new Promise(((e,t)=>(h.body.pipe(y),h.body.on("error",t),y.on("finish",e)))),await this._child("unzip",[d,"-d",this.S.directory+"/import/ror/"]),C.log("ROR snapshot downloaded"),await this.src.ror(""),readline.createInterface({input:fs.createReadStream(d.replace(".zip",".json"))})))try{f||5!==u.length||"{"!==u.replace(/\s\s\s\s/,"")?s||5!==u.replace(",","").length||"}"!==u.replace(/\s\s\s\s/,"").replace(",","")?"["!==u&&"]"!==u&&(c+=u):(s=!0,c+="}"):(f=!0,c="{"),!0===f&&!0===s&&(f=!1,s=!1,(p=await this.src.ror._format(JSON.parse(c),i)).src=a,null==p.createdAt&&(p.createdAt=i),c="",m+=1,t.push(p),2e4===t.length&&(C.log("ROR bulk loading",t.length,m),await this.src.ror(t),t=[]))}catch(e){}return t.length&&await this.src.ror(t),C.log(m),m},t.src.ror.load._bg=!0,t.src.ror.load._async=!0,t.src.ror.load._auth="root",null==(O=r.src).zenodo&&(O.zenodo={});try{r.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(e){}t.src.zenodo={deposition:{},records:{}},t.src.zenodo.records.search=function(e,t){var i,r,s;return null==e&&(e=this.params),null==t&&(t=this.params.dev),r=null!=(i=this.params.size)?i:10,s="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+r+"&q="+encodeURIComponent(e),this.fetch(s)},t.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},t.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){}},t.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},t.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},t.src.zenodo.records.format=function(e){var t,i,r,s,n,a,l,o,u,c,p;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=e.metadata.description}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,s=0,a=c.length;s<a;s++)if("pdf"===(r=c[s]).type){null==o.pdf&&(o.pdf=r.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),p=e.metadata.creators,n=0,l=p.length;n<l;n++){if("string"==typeof(t=p[n])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},t.src.zenodo.deposition.create=async function(e,t,i,r){var s,n,a,l,o,u,c,p,h;return null==r&&(r=null!=(a=this.params.dev)?a:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=r?null!=(l=this.S.src)&&null!=(o=l.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(h="https://"+(r?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(n={metadata:e}).metadata.upload_type||(n.metadata.upload_type="publication",n.metadata.publication_type="article"),null==(s=n.metadata).creators&&(s.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(p=await this.fetch(h,{method:"POST",body:n,mode:"cors",credentials:"include",headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))?p.id:void 0)&&(t.content||t.file)&&(p.uploaded=await this.src.zenodo.deposition.upload(p.id,t.content,t.file,t.name,t.url,i,r)),t.publish&&(p.published=await this.src.zenodo.deposition.publish(p.id,i,r)),p):await this.fetch(h,{method:"POST",body:n,headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.upload=async function(e,t,i,r,s,n,a){var l,o,u,c;if(null==e&&(e=null!=(l=this.params.upload)?l:this.params.id),null==t&&(t=this.params.content),null==r&&(r=this.params.filename),!t&&!i)try{i=this.request.files[0]}catch(e){}if(s&&!t&&!i)try{t=await this.fetch(s,{buffer:!0,headers:{referer:this.S.dev||a?"https://sandbox.zenodo.org":"https://zenodo.org"}})}catch(e){}return null==n&&(n=this.params.token),null==n&&(n=this.S.dev||a?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==a&&(a=this.params.dev),null!=n&&null!=e&&(s="https://"+(this.S.dev||a?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+n,this.fetch(s,{file:null!=t?t:i,filename:r,headers:{referer:this.S.dev||a?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.publish=function(e,t,i){var r,s,n,a,l;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src)&&null!=(a=n.zenodo)?a.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(l,{method:"POST",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.delete=async function(e,t,i){var r,s,n,a;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src.zenodo)?n.token:void 0),null!=t&&null!=e&&(a="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(a,{method:"DELETE",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}),!0)},t.src.zenodo.test=async function(){var e,t,i,r,s;return 0===(e=[]).length&&(e=[{name:"MacGillivray, Mark"}]),(t={title:"Our latest test upload "+await this.uid(),description:"This is a test description. <br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",creators:e,version:"Accepted Version",journal_title:"Our great journal"}).access_right="open",t.license="cc-by",s={publish:!0,name:t.title,content:await fs.readFile("/home/oaw/static/ExtendedInterval.pdf")},i=this.S.src.zenodo.sandbox,r=await this.src.zenodo.deposition.create(t,s,i,!0),C.log(r),r},t.blacklist=async function(e){var t,i,r,s,n,a,l,o;if(null==e&&(e=this.params.url),"number"==typeof e&&(e=e.toString()),null!=e&&(e.length<4||-1===e.indexOf(".")))return!1;for(i=[],s=0,a=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;s<a;s++)r=o[s],i.push(r.url.toLowerCase());if(e){if(!e.startsWith("http")&&e.includes(" "))return!1;for(n=0,l=i.length;n<l;n++)if(t=i[n],e.includes(t.toLowerCase()))return!0;return!1}return i},t.bug=function(){var e,t,i,r,s,n,a,l,o,u,c;if(this.params.contact)return"";for(e in c=["help@oa.works"],u="",this.params)u+=e+": "+JSON.stringify(this.params[e],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(r=this.params)?r.form:void 0)?o+=" Wrong article":"bug"===(null!=(s=this.params)?s.form:void 0)?o+=" Bug":"general"===(null!=(n=this.params)?n.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(a=null!=(l=this.params)?l.form:void 0)&&"uninstall"!==a||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:t=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:t}},t.cache=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==e&&(e=this.request);try{for(h=e.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)n=u[l],-1!==h.indexOf(n+"=")&&(a=new RegExp(n+"=.*?&"),h=h.replace(a,"")),-1!==h.indexOf("&"+n+"=")&&(h=h.split("&"+n+"=")[0]);s=new URL(h)}catch(e){}}catch(e){}if(null!=e)try{if(null==s&&(s=new URL(e.url)),r=new Request(s.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t)return p=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),p;t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,c))}catch(e){}}},t.cache._auth="system",R=[].indexOf,null==t.convert&&(t.convert={}),t.convert.json2csv=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O;if(null==e&&(e=null!=(m=this.body)?m:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(y=e.hits)?y.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),p=null!=(g=t.quote)?g:'"',O=null!=(_=t.separator)?_:",",u=null!=(v=t.newline)?v:"\n",e.length){for(r=null!=(b=t.keys)?b:[],f="",s=0,l=e.length;s<l;s++){if(d=e[s],f.length&&(f+=u),!1!==t.es&&(d._source||d.fields)){for(c in h={},x=null!=(w=d._source)?w:d.fields)null==h[c]&&(h[c]=x[c]);d=h}if(t.flatten&&(d=await this.flatten(d)),t.subset&&(d=await this.dot(d,t.subset)),!t.keys)for(a in d)null!=d[a]&&R.call(r,a)<0&&r.push(a);for(n=0,o=r.length;n<o;n++){if(i=r[n],f.length&&!f.endsWith(u)&&(f+=O),f+=p,null!=d[i]){try{Array.isArray(d[i])&&1===d[i].length&&Array.isArray(d[i][0])&&(d[i]=d[i][0])}catch(e){}try{Array.isArray(d[i])&&d[i].length&&"object"!=typeof d[i][0]&&(d[i]=d[i].join(","))}catch(e){}try{"object"==typeof d[i]&&(d[i]=JSON.stringify(d[i]))}catch(e){}try{'"'===p&&-1!==d[i].indexOf(p)&&(d[i]=d[i].replace(/"/g,p+p))}catch(e){}try{d[i]=d[i].replace(/\n/g," ")}catch(e){}try{d[i]=d[i].replace(/\s\s/g," ")}catch(e){}try{f+=d[i]}catch(e){}}f+=p}}return p+r.join(p+O+p)+p+"\n"+f}return""},t.convert.csv2json=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w;if(null==t&&(t=this.params),null==e&&(e=null!=(d=this.body)?d:this.params.csv),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(f=t.url)?f:e)),_=[],"string"==typeof e&&e.length&&(h=null!=(m=t.quote)?m:'"',b=null!=(y=t.separator)?y:",",c=null!=(g=t.newline)?g:"\n",(u=e.split(c)).length))for(r=u.shift().split(h+b),p="",s=0,a=u.length;s<a;s++)if((w=(p+=(p?c:"")+(o=u[s])).split(h+b)).length===r.length&&(!h||o.endsWith(h))){for(p="",v={},n=0,l=r.length;n<l;n++)if((i=r[n]).startsWith(h)&&(i=i.replace(h,"")),i.endsWith(h)&&(i=i.substring(0,i.length-1)),w.length&&(v[i]=w.shift(),v[i])){v[i].startsWith(h)&&(v[i]=v[i].replace(h,"")),!w.length&&v[i].endsWith(h)&&(v[i]=v[i].substring(0,v[i].length-1));try{v[i]=JSON.parse(v[i])}catch(e){}}_.push(v)}return _},t.convert.csv2html=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g;if(null==e&&(e=null!=(p=this.body)?p:this.params.csv),null==t&&(t=this.params),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(h=t.url)?h:e)),'"',m="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",m+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(o=e.split("\n")).length){for(m+="<thead><tr>",u=0,i=0,s=(d=o.shift().split('","')).length;i<s;i++)m+='<th style="padding:2px; border:1px solid #ccc;">'+d[i].replace(/"/g,"")+"</th>",u+=1;for(m+="</tr></thead>\n<tbody>\n",r=0,n=o.length;r<n;r++){for(l=o[r],m+="<tr>";-1!==l.indexOf(',"",');)l=l.replace(',"",',',"XXX_EMPTY_XXX",');for(;l.startsWith('"",');)l=l.replace('"",','"XXX_EMPTY_XXX",');for(;l.endsWith(',""');)l=l.slice(0,l.length-3);for(g=0,c=0,a=(f=(l=l.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<a;c++)g+=1,m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(y=(y=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===y.indexOf("{")||0===y.indexOf("[")?(m+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",m+=await this.convert.json2html(JSON.parse(y.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),m+="</div>"):m+=y.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),m+="</td>";for(;g<u;)m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',g+=1;m+="</tr>\n"}m+="</tbody>\n"}return m+"</table>"},t.convert.json2html=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h;if(null==e&&(e=null!=(u=this.body)?u:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.new)for(null==t.edit&&(t.edit=!0),e={},r=0,n=(c=await this.index.keys(this.route.replace(/\//g,"_"))).length;r<n;r++)e[c[r]]="";if(t.subset&&!Array.isArray(e))for(o=t.subset.split(".");(l=o.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[l];)e=e[l];if(Array.isArray(e)||null!=(null!=e&&null!=(p=e.hits)?p.hits:void 0)&&!1!==t.es)return null!=o&&(t.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(e,t));if(h="<div>",t.flatten&&(e=await this.flatten(e),h+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(o.length)for(s=0,a=o.length;s<a;s++)e=e[o[s]];h+="<h3>"+t.subset+":</h3>",h+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return i=e=>{var r,s,n,a,l,o,u,c,p,d,f;if(t.edit&&null==e.comments&&(e.comments=""),t.keys)for(a=0,s=(c=t.keys).length;a<s;a++)null==e[u=c[a]]&&(e[u]="");for(r in d=[],e){try{Array.isArray(e[r])&&1===e[r].length&&Array.isArray(e[r][0])&&(e[r]=e[r][0])}catch(e){}if(null==e[r]||Array.isArray(e[r])&&!e[r].length||t.keys&&!(R.call(t.keys,r)>=0))d.push(void 0);else{if(h+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+r+"</p></b></div>",h+='<div style="float:left;">',h+=t.edit?'<textarea class="PForm" id="'+r+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[r]))if("object"==typeof e[r][0])for(l=0,n=(p=e[r]).length;l<n;l++)o=p[l],i(o);else{try{f=e[r].join(", ")}catch(t){try{f=JSON.stringify(e[r])}catch(t){f=e[r]}}try{h+=(t.edit?"":"<p>")+f+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[r]?i(e[r]):h+=(t.edit?"":"<p>")+e[r]+(t.edit?"":"</p>");h+=t.edit?"</textarea>":"",d.push(h+="</div></div>")}}return d},i(e),h+="</div>"},t.convert.json2txt=async function(e){var t,i,r;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),r=[],t=async function(e){var i,s,n,a,l;if(Array.isArray(e)){for(a=[],s=0,n=e.length;s<n;s++)i=e[s],a.push(await t(i));return a}if("object"==typeof e){for(i in l=[],e)l.push(await t(e[i]));return l}if(e)return r.push(e)},await t(e),r.join(" ")},t.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},t.convert.hex2bin=function(e){var i,r,s,n,a;for(a=[],i=0,s=(n=Array.isArray(e)?e:[e]).length;i<s;i++)r=n[i],a.push(t.convert._hexMatch[r.toLowerCase()]);return a.join("")},t.convert.bin2hex=function(e){var i,r,s,n,a,l,o,u,c;if(!Array.isArray(e)){for(i=[],c=e.split(""),o="";c.length;)4===(o+=c.shift()).length&&(i.push(o),o="");e=i}for(n in u=[],r={},t.convert._hexMatch)r[t.convert._hexMatch[n]]=n;for(s=0,l=e.length;s<l;s++)a=e[s],u.push("0x"+r[a]);return new E(u).toString()},t.convert.buf2bin=async function(e){var i,r;for(E.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),r="",i=0;i<e.length;)r+=await t.convert.hex2bin(e[i]),i++;return r},t.convert.stream2txt=function(e){var t;return t=[],new Promise(((i,r)=>(e.on("data",(e=>t.push(E.from(e)))),e.on("error",(e=>r(e))),e.on("end",(()=>i(E.concat(t).toString("utf8")))))))},t.convert.xml2json=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d,f,m,y;if(null==e&&(e=null!=(h=this.params.xml2json)?h:this.params.url),f={},"string"==typeof e)for(e.startsWith("http")&&(e=await this.fetch(e)),i="",u="",m=!1,r=!1;t=e[0];)if(e=e.slice(1),"\ufeff"!==t&&"\t"!==t&&"\r"!==t&&"\n"!==t&&(" "!==t||i.length&&!i.endsWith(">"))&&("<"===i&&"/"!==t&&"?"!==t&&"!"!==t&&(m=!0),((i+=t).endsWith("</")&&i.split("</").length-1===i.split(">").length||i.endsWith("/>")&&!i.split("/>")[0].includes(">"))&&(r=!0),">"===t)){if(C.log(u),r){if(r=!1,""!==(i=i.split("</")[0])){if(p=await this.dot(f,u,void 0,void 0,!0))Array.isArray(p)?(p.length||(p=[{}]),null!=p[p.length-1].$?(Array.isArray(p[p.length-1].$)||(p[p.length-1].$=[p[p.length-1].$]),p[p.length-1].$.push(i)):p[p.length-1].$=i):p.$=i,i=p;else{i={$:i};try{(c=await this.dot(f,u.slice(0,u.lastIndexOf(".")),void 0,void 0,!0))&&(i._=c[u.split(".").pop()]._)}catch(e){}}"object"==typeof i&&null==i._&&null!=i.$&&(i=i.$),await this.dot(f,u,i,void 0,!0)}u=u.includes(".")?u.slice(0,u.lastIndexOf(".")):""}else if(m){for(m=!1,l={},s=0,a=(d=i.replace("<","").replace(">","").split(" ")).length;s<a;s++)(o=d[s]).includes("=")?o.length&&([n,y]=o.split("="),l[n.trim().replace(/"/g,"")]=y.trim().replace(/"/g,"")):u+=(u&&!u.endsWith(".")?".":"")+o;(p=await this.dot(f,u,void 0,void 0,!0))?(Array.isArray(p)||(p=[p]),p.push("{}"!==JSON.stringify(l)?{_:l}:{}),await this.dot(f,u,p,void 0,!0)):"{}"!==JSON.stringify(l)&&await this.dot(f,u+"._",l,void 0,!0)}i=""}return f},t.dateparts=async function(e){var t,i,r,s,n,a,l,o,u,c,p;t={},null==e&&(e=null!=(n=this.params.dateparts)?n:t.date);try{if("object"==typeof e){for(i in e)t[i]=e[i];e=null!=(a=t.date)?a:""}else if(null==e){for(i in params)null==t[i]&&(t[i]=this.params[i]);e=null!=(l=t.date)?l:""}if(("number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))&&(e=await this.date(e)),e.includes("T")&&e.includes("-")&&(e=e.split("T")[0]),(e=(e=e.trim().toLowerCase().replace(", "," ").replace(" of ","").replace("st "," ").replace("nd "," ").replace("rd "," ").replace("th "," ")).replace(/-/g," ").replace(/\//g," ")).includes(" "))for(i in s=e.split(" "))(r=s[i]).includes(":")||(r.length>=3?isNaN(parseInt(r))?(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(r.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""):t.year=r:parseInt(r)<13&&(2===s.length||3===s.length&&"1"===i)?t.month=r:1===s.length?t.year=r:t.day=r);t.day=(null!=(o=t.day)?o:"01").toString(),1===t.day.length&&(t.day="0"+t.day),"string"==typeof t.month&&t.month.length&&isNaN(parseInt(t.month))&&(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(t.month.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""),t.month=(null!=(u=t.month)?u:"01").toString(),1===t.month.length&&(t.month="0"+t.month),t.year=t.year.toString(),2===t.year.length&&(t.year=parseInt(t.year)<30?"20":"19"+t.year),"31"!==t.day||"04"!==(c=t.month)&&"06"!==c&&"09"!==c&&"11"!==c||(t.day="30"),"02"===t.month&&("30"===(p=t.day)||"31"===p||"29"===t.day&&parseInt(t.year)%4)&&(t.day="28"),t.date=t.year+"-"+t.month+"-"+t.day;try{t.timestamp=await this.epoch(t.date)}catch(e){}}catch(e){}return t},t.dateparts._cache=!1,t.date=function(e,t,i=!0,r=!0){var s,n,a,l,o;if(null==e&&(e=null!=(a=this.params.date)?a:Date.now()),null==t&&(t=this.params.time),"number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))try{return o=(o=new Date(parseInt(e))).toISOString(),t?i?r||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(e){}try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(s in e)"number"!=(l=typeof e[s])&&"string"!==l&&(e[s]="01");e=e.join("-")}catch(e){}return(e=decodeURIComponent(e)).includes("T")&&(e=e.split("T")[0]),(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).includes("-")||(e+="-01-01"),3!==e.split("-").length&&(e+="-01"),3!==(n=e.split("-")).length&&(e=void 0),n[0].length<n[2].length&&(e=n.reverse().join("-")),e}catch(e){}},t.date._cache=!1,t.datetime=function(e,t){var i,r;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(r=null!=e?e:this.params.secs)?r:this.params.s,null!=t?t:this.params.ms)},t.datetime._cache=!1,t.epoch=function(e){var t,i,r,s,n,a;if(null==e&&(e=this.params.epoch),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&e.includes("/")&&(3===(r=e.split("/")).length&&4===r[2].length&&r.reverse(),e=r.join("-")),!e)return Date.now();if(!(e.startsWith("+")||e.startsWith("-")||2===e.split("+").length&&e.split("+")[0].length>4||2===e.split("-").length&&e.split("-")[0].length>4)){if(e.length>8&&!e.includes("-")&&!isNaN(parseInt(e)))return this.date(e,null==(s=this.params.time)||s);for(4===e.length&&(e+="-01"),e.split("-").length<3&&(e+="-01"),e.includes("T")||(e+="T"),e.includes(":")||(e+="00:00"),e.split(":").length<3&&(e+=":00"),e.includes(".")||(e+="."),[n,i]=e.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return i.includes("Z")||(i+="Z"),new Date(n+"."+i).valueOf()}return(e.startsWith("+")||e.startsWith("-"))&&(e=Date.now()+e),e.includes("+")?([e,t]=e.replace("/","").split("+"),(parseInt(e)+parseInt(t)).toString()):e.includes("-")?([e,a]=e.replace("/","").split("-"),(parseInt(e)-parseInt(a)).toString()):void 0},t.epoch._cache=!1,t.uid=function(t){var i,r,s,n,a,l,o,u,c,p,h;return null==t&&(t="uid"===this.fn&&null!=(i=null!=(r=null!=(s=null!=(n=null!=this&&null!=(a=this.params)?a.len:void 0)?n:null!=this&&null!=(l=this.params)?l.length:void 0)?s:null!=this&&null!=(o=this.params)?o.size:void 0)?r:null!=this&&null!=(u=this.params)?u.uid:void 0)?i:21),"string"==typeof t&&(h=parseInt(t),t=isNaN(h)?void 0:h),((t,i=21)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,s=-~(1.6*r*t/e.length);return(n=t)=>{let a="";for(;;){let t=i(s),l=s;for(;l--;)if(a+=e[t[l]&r]||"",a.length===n)return a}}})(t,i,e))(null!=(c=null!=this&&null!=(p=this.params)?p.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",t)()},t.uid._cache=!1,t.encrypt=async function(e){var t,i,r,s,n,a;null==e&&(e=null!=(i=null!=(r=null!=(s=null!=(n=this.params.encrypt)?n:this.params.content)?s:this.params.q)?r:this.params)?i:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createCipheriv("aes-256-ctr",this.S.encrypt.salt,null!=(a=this.params.iv)?a:this.S.encrypt.iv),E.concat([t.update(e),t.final()]).toString("hex")},t.encrypt._cache=!1,t.encrypt._bg=!0,t.decrypt=async function(e){var t,i,r,s,n,a,l;null==e&&(e=null!=(r=null!=(s=null!=(n=null!=(a=this.params.decrypt)?a:this.params.content)?n:this.params.q)?s:this.params)?r:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"object"==typeof e?(i=e.iv,e=e.content):i=null!=(l=this.params.iv)?l:this.S.encrypt.iv,"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createDecipheriv("aes-256-ctr",this.S.encrypt.salt,i),E.concat([t.update(E.from(e,"hex")),t.final()]).toString()},t.decrypt._cache=!1,t.decrypt._bg=!0,t.decrypt._auth="@oa.works",t.hash=async function(e){var t,i,r,s,n,a,l,o,u,c;null==e&&(e=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?l:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(r),a=[],s=0,n=t.length;s<n;s++)i=t[s],a.push(("00"+i.toString(16)).slice(-2));return a.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},t.hashcode=function(e){var t,i,r,s,n,a;for(null==e&&(e=null!=(r=null!=(s=null!=(n=null!=(a=this.params.hashcode)?a:this.params.content)?n:this.params.q)?s:this.params)?r:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),t=0,i=0;i<e.length;)t=(t<<5)-t+e.charCodeAt(i),t&=t,i++;return t},t.hashhex=function(e){var t;return null==e&&(e=this.params.hashhex),(t=this.hashcode(e))<0&&(t=4294967295+t+1),t.toString(16)},t.shorthash=function(e,t){var i,r,s,n,a,l,o,u;for(null==e&&(e=null!=(s=null!=(n=null!=(a=null!=(l=this.params.shorthash)?l:this.params.content)?a:this.params.q)?n:this.params)?s:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),r=this.hashcode(e),t?(u=t.substring(0,1),t=t.replace(u,"")):(t="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=t.length,o=r<0?u:"",r=Math.abs(r);r>=i;)o+=t[r%i],r=Math.floor(r/i);return o+(r>0?t[r]:"")},t.fetch=async function(e,t){var i,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,R,N,L,P,q,T,W,M,U,z,B,F,J,$,X;if(null==e&&null==t)try{t=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==t&&(e=(t=e).url),null==t&&(t={}),"number"==typeof t&&(t={cache:t}),"number"==typeof t.cache&&(null==t.cf&&(t.cf={cacheEverything:!0}),t.cf.cacheTtl=t.cache,delete t.cache),!e&&t.url&&(e=t.url,delete t.url),!0===t.bg&&"string"==typeof r.bg&&(t.url=e,e=r.bg+"/fetch",delete t.bg),t.username&&t.password&&(t.auth=t.username+":"+t.password,delete t.username,delete t.password),e.split("?")[0].includes("@")&&e.includes(":")&&e.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(t.auth=e.split("//")[1].split("@")[0],e=e.replace(t.auth+"@","")),t.auth&&(null==t.headers&&(t.headers={}),t.headers.Authorization="Basic "+E.from(t.auth).toString("base64"),delete t.auth),p=0,m=(R=["data","content","json"]).length;p<m;p++)null!=t[a=R[p]]&&(t.body=t[a],delete t[a]);if(null==t.attachment&&(t.attachment=t.attachments),null==t.file&&(t.file=t.attachment),null!=t.file){for(null==t.headers&&(t.headers={}),null!=t.body&&null==t.form&&(t.form=t.body),t.body=new FormData,Array.isArray(t.file)||(u="object"==typeof t.file&&null!=t.file.file?[{file:t.file.file,filename:null!=(N=null!=(T=t.file.filename)?T:t.file.name)?N:t.filename}]:[{file:t.file,filename:t.filename}],t.file=u),h=0,y=(W=t.file).length;h<y;h++)null==(null!=(c=W[h])?c.file:void 0)&&null==(null!=c?c.data:void 0)||t.body.append(null!=t.attachment?"attachment":"file",null!=(M=c.file)?M:c.data,null!=(U=null!=(z=null!=(B=c.filename)?B:c.name)?z:t.filename)?U:"file");delete t.filename,null==t.method&&(t.method="POST")}else null!=t.body&&(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="object"==typeof t.body?"application/json":"text/plain"),"object"!=(F=typeof t.body)&&"boolean"!==F&&"number"!==F||(t.body=JSON.stringify(t.body)),null==t.method&&(t.method="POST"));if(null!=t.form){if(null!=t.file){if("object"==typeof t.form)for(o in t.form)for(f=0,g=(J=Array.isArray(t.form[o])?t.form[o]:[t.form[o]]).length;f<g;f++)s=J[f],t.body.append(o,"object"==typeof s?JSON.stringify(s):s)}else{if(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof t.form){for(k in j="",t.form)for(""!==j&&(j+="&"),b=0,_=(L=Array.isArray(t.form[k])?t.form[k]:[t.form[k]]).length;b<_;b++)null!=(S=L[b])&&(j.endsWith("&")||(j+="&"),j+=k+"="+encodeURIComponent("object"==typeof S?JSON.stringify(S):S));t.form=j}t.body=t.form}delete t.form,null==t.method&&(t.method="POST")}if(delete t.file,delete t.attachment,delete t.attachments,"string"!=typeof e);else{if(!e.startsWith("http:")&&e.includes("localhost"))try{null==t.agent&&(t.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(e.includes("?")){for(O=(I=e.split("?")).shift()+"?",w=0,v=(P=I.join("?").split("&")).length;w<v;w++)D=P[w],O.endsWith("?")||(O+="&"),[d,X]=D.split("="),null==X&&(X=""),d&&(O+=encodeURIComponent(d)+(X?"="+(X.includes("%")?X:encodeURIComponent(X)):""));e=O}if(t.params&&"{}"!==JSON.stringify(t.params)){for(d in e.includes("?")||(e+="?"),q=t.params)X=q[d],e.endsWith("&")||e.endsWith("?")||(e+="&"),d&&(e+=encodeURIComponent(d)+"="+encodeURIComponent("object"==typeof X?JSON.stringify(X):X));delete t.params}r.system&&("string"==typeof r.bg&&e.startsWith(r.bg)||"string"==typeof r.async&&e.startsWith(r.async)||"string"==typeof r.kv&&r.kv.startsWith("http")&&e.startsWith(r.kv))&&(null==t.headers&&(t.headers={}),null==(n=t.headers)[x="x-"+r.name.toLowerCase()+"-system"]&&(n[x]=r.system),t.headers.Authorization||t.headers.authorization||t.headers["x-apikey"]||!this.user||(t.headers["x-apikey"]=this.user.apikey)),i=async()=>{var i,s,n,a,l,o,u,c;if(t.stream)return delete t.stream,fetch(e,t);i=!1,t.buffer&&(i=!0,delete t.buffer),c=await fetch(e,t);try{(!e.includes("localhost")||200!==(o=c.status)&&404!==o)&&r.dev&&!0===r.bg&&C.log(c.status+" "+e),t.verbose&&(c.status>300&&C.log(c.body),C.log(c.status+" "+e))}catch(e){C.log("Error logging to console for fetch"),C.log(c)}if(i)l=await c.buffer();else if("HEAD"===t.method)for(l={status:c.status},a=0,n=(u=[...c.headers]).length;a<n;a++)l[(s=u[a])[0]]=s[1];else{try{l=await c.text()}catch(e){}try{"string"==typeof l&&(l.startsWith("{")||l.startsWith("["))&&(l=JSON.parse(l))}catch(e){}}return 404!==c.status?c.status>=400?(r.dev&&!0===r.bg&&C.log(t,JSON.stringify(l),"FETCH ERROR",c.status),{status:c.status}):l:void 0};try{t.timeout&&null!=(null!=this?this._timeout:void 0)?(A=!0===t.timeout?3e4:t.timeout,delete t.timeout,$=await this._timeout(A,i())):$=await i();try{(($=$.trim()).startsWith("[")||$.startsWith("{"))&&($=JSON.parse($))}catch(e){}return $}catch(t){l=t,r.dev&&!0===r.bg&&C.log("ERROR TRYING TO CALL FETCH",e,l,JSON.stringify(l));try{this.log(l)}catch(e){}}}},t.fetch._auth="system",t._timeout=function(e,t){return new Promise(((t,i)=>{var r;return r=setTimeout((()=>i(new Error("TIMEOUT"))),e),promise.then(value((()=>(clearTimeout(r),t(value))))).catch(reason((()=>(clearTimeout(r),i(reason)))))}))},R=[].indexOf,null==r.index&&(r.index={}),null==(O=r.index).name&&(O.name=null!=(j=r.name)?j:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(k=r.index).url&&(k.url=r.bg+"/index"),t.index=async function(e,i,r,s){var n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w;if("object"==typeof e&&(i=e,e=void 0),null==e&&null==i&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(p=this.parts[1])||"src"===p))return{status:403};if("object"==typeof this.body?i=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(i=this.body):i=this.copy(this.params),delete i.route,delete i.index,delete i[this.fn.split(".").pop()],delete i._id,null!=i.script||-1!==JSON.stringify(i).toLowerCase().indexOf("<script"))return}if("object"!=typeof i||Array.isArray(i)||(null==e&&(e=null!=(h=i.route)?h:i.index),delete i.route,delete i.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(l in g=[],(await this.index._send("_stats")).indices)l.startsWith(".")||l.startsWith("security-")||g.push(l);return g}2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e)if(e.includes("?")?([e,w]=e.split("?"),w="?"+w):w="",e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof i&&!Array.isArray(i)&&i._id&&(a=(i=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i))._id.replace(/\//g,"_").toLowerCase(),-1===e.indexOf("/")&&-1===e.indexOf(a)&&(e+="/"+a),delete i._id,"{}"===JSON.stringify(i)&&(i=void 0)),b=(e=e.toLowerCase()).split("/").length,null==this.index&&(this.index=t.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===e.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===i)_=await this.index._send(e.replace("/","/_doc/")+w,"");else if(1===b){if("string"==typeof i&&(""===i||-1!==i.indexOf("\n"))||Array.isArray(i))return""===i?this.index._send(e+w,i):this.index._bulk(e+w,i);if("object"!=(d=typeof i)&&"string"!==d)return this.index._send(e+"/_search"+w);if("{}"!==JSON.stringify(i)&&(c=await this.index.translate(i,r)))return this.index._send(e+"/_search"+w,c);if("object"==typeof i){for(n=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete n[f[o]];return"{}"===JSON.stringify(n)?(await this.index._send(e+w)||await this.index._send(e+w,{settings:i.settings,aliases:i.aliases,mappings:null!=(m=i.mappings)?m:i.mapping}),this.index._send(e+"/_search"+w)):"created"===(null!=(_=await this.index._send(e+"/_doc"+w,i))?_.result:void 0)&&_._id?_._id:_}}else if(2===b&&(null==i||"object"==typeof i&&!Array.isArray(i)))return e.startsWith("_")||e.includes("/_")||(e=e.replace("/","/_doc/")),null!=i&&"{}"!==JSON.stringify(i)?("object"==typeof i&&null!=i.script&&(e+="_update",w+=(w.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(_=await this.index._send(e+w,i))?_.result:void 0)&&_._id?_._id:_):("object"==typeof(_=await this.index._send(e+w))&&(_._source||_.fields)&&(null==(v=null!=(y=_._source)?y:_.fields)._id&&(v._id=_._id),_=v),_)},t.index._auths="system",t.index._caches=!1,t.index.status=async function(){var e,t,i,r,s,n,a,l,o,u,c,p,h,d,f;c={status:"green",docs:0,size:0,shards:0,failed:0};try{for(i in(f=await this.index._send("_nodes/stats/indices/search")).nodes)null==c.scrolls&&(c.scrolls=0),c.scrolls+=f.nodes[i].indices.search.open_contexts}catch(e){}for(i in c.indices={},p=await this.index._send("_stats"),d=await this.index._send("_cat/shards?format=json"),p.indices)if(!i.startsWith(".")&&!i.startsWith("security-")){for(c.indices[i]={docs:p.indices[i].primaries.docs.count,size:Math.ceil(p.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},r=0,a=d.length;r<a;r++)(h=d[r]).index===i&&"p"===h.prirep&&(null==(e=c.indices[i]).shards&&(e.shards=0),c.indices[i].shards+=1,null==(t=c.indices[i]).failed&&(t.failed=0),"UNASSIGNED"===h.state&&(c.indices[i].failed+=1));c.docs+=c.indices[i].docs;try{c.size+=parseInt(c.indices[i].size.replace("mb",""))}catch(e){}c.shards+=c.indices[i].shards,c.failed+=c.indices[i].failed}c.size=Math.ceil(c.size/1e3+"gb");try{for("green"!==(o=c.cluster.status)&&"yellow"!==o&&(c.status="red"),n=0,l=(u=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;n<l;n++)s=u[n],delete c.cluster[s]}catch(e){}return c},t.index.keys=async function(e,t){var i,r,s,n,a,l;return null==e&&(e=null!=(n=null!=(a=this.params.index)?a:this.params.keys)?n:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys",""),null==t&&(t=null!=(l=this.params.type)?l:this.params.types),"string"==typeof t&&(t=[t]),r=!0===t?{}:[],s="object"==typeof e?e:await this.index.mapping(e),i=async(e,s="")=>{var n,a,l,o;for(n in s&&(s+="."),o=[],e)null!=e[n].properties?o.push(await i(e[n].properties,s+n)):!t||!0===t||(a=e[n].type,R.call(t,a)>=0)?!0===t?o.push(r[s+n]=e[n].type):(l=s+n,R.call(r,l)<0?o.push(r.push(s+n)):o.push(void 0)):o.push(void 0);return o},"object"==typeof s&&await i(s),r},t.index.terms=async function(e,t,i,r=100,s=!0,n="count"){var a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k;if(null==e&&(e=null!=(m=this.params.index)?m:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),!t||!i){if(null==t&&(t=null!=(y=this.params.terms)?y:this.params.key),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),!t)return[];for(a=this.copy(this.params),l=0,u=(g=["index","route","terms","key"]).length;l<u;l++)delete a[g[l]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(a)),f="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&f.query.bool.must.push({query_string:{query:i}}),null==f.aggregations&&(f.aggregations={}),null==f.size&&(f.size=0),null!=this.params.size&&(r=this.params.size),null!=this.params.counts&&(s=this.params.counts),null!=this.params.order&&(n=this.params.order),h={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof n&&null!=h[n]&&(n=h[n]),t.endsWith(".keyword")||(p=await this.index.mapping(e)),f.aggregations[t]={terms:{field:t+(t.endsWith(".keyword")||"text"!==(null!=(_=p[t])?_:{}).type?"":".keyword"),size:r,order:n}},O=[],o=0,c=(x=null!=(v=null!=(k=await this.index._send("/"+e+"/_search",f,"POST"))&&null!=(b=k.aggregations)&&null!=(w=b[t])?w.buckets:void 0)?v:[]).length;o<c;o++)d=x[o],O.push(s?{term:d.key,count:d.doc_count}:d.key);return O},t.index.suggest=async function(e,t,i,r=100,s){var n,a,l,o,u,c,p,h,d,f,m,y,g;if(t&&i||(null==t&&(t=null!=(h=this.params.suggest)?h:this.params.key),"string"==typeof t&&t.includes("/")&&([t,i]=t.split("/"))),!t)return this.index.keys(e,"text");if(null==e&&(e=null!=(d=this.params.index)?d:this.fn.replace(/\./g,"/")),e=e.replace("index/","").split("/suggest")[0],null==s&&(s=this.params.include),"string"==typeof s&&(s=s.replace(/,\s/g,",").split(",")),Array.isArray(s)&&R.call(s,t)<0&&s.push(t),"string"==typeof i&&(c=(i=i.trim()).toLowerCase(),(g={should:[{match:{}},{prefix:{}},{query_string:{query:t+":"+i.split(" ").join(" AND "+t+":")+"*"}}]}).should[0].match[t]={query:i,boost:3},g.should[1].prefix[t]={value:i,boost:2}),m=[],y=[],s){for await(p of this.index._for(e,null!=g?g:i,{sort:t+".keyword",until:r,include:!0===s?[t]:s}))if(l=await this.dot(p,t)){for(;Array.isArray(l)&&(n=l.shift());)n.toLowerCase().includes(c)&&(l=n);o=l.toLowerCase(),R.call(y,o)<0&&(!c||o.includes(c))&&m.push(p),y.push(o)}}else for(a=0,u=(f=await this.index.terms(e,t,null!=g?g:i,r,!1,"term")).length;a<u;a++)o=(l=f[a]).toLowerCase(),R.call(y,o)<0&&(!c||o.includes(c))&&m.push(l),y.push(o);return m},t.index.count=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d;for(null==i&&(i=null!=(l=this.params.count)?l:this.params.key),null==e&&(e=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),r=this.copy(this.params),s=0,n=(u=["index","route","count","key"]).length;s<n;s++)delete r[u[s]];return null==t&&(a=await this.index.translate(r))&&(t=a),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(d=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(c=d.aggregations)&&null!=(p=c.keyed)?p.value:void 0):null!=(d=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(h=d.hits)?h.total:void 0},t.index.percent=async function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m;for(null==i&&(i=null!=(o=this.params.count)?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),s=this.copy(this.params),n=0,a=(c=["index","route","count","key"]).length;n<a;n++)delete s[c[n]];return null==t&&(l=await this.index.translate(s))&&(t=l),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),m=await this.index.count(e,"*"),r=0,i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(p=f.aggregations)&&null!=(h=p.keyed)?h.value:void 0):r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(d=f.hits)?d.total:void 0,Math.ceil(r/m*1e4)/100},t.index.min=async function(e,t,i,r="min"){var s,n,a,l,o,u,c,p;for(null==t&&(t=null!=(o=this.params[r])?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(e=e.replace("index/","").replace("/"+r,"")).indexOf("/")&&([e,t]=e.split("/")),s=this.copy(this.params),n=0,a=(c=["index","route","min","max","key","sum","average"]).length;n<a;n++)delete s[c[n]];return null==i&&(i=await this.index.translate(s)),(l="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,"sum"===r?l.aggs={sum:{sum:{field:t}}}:"average"===r?l.aggs={average:{avg:{field:t}}}:(l.aggs={},"min"!==r&&"range"!==r||(l.aggs.min={min:{field:t}}),"max"!==r&&"range"!==r||(l.aggs.max={max:{field:t}})),p=await this.index._send("/"+e+"/_search",l,"POST"),"range"===r?{min:p.aggregations.min.value,max:p.aggregations.max.value}:p.aggregations[r].value},t.index.max=function(e,t,i){return this.index.min(e,t,i,"max")},t.index.range=function(e,t,i){return this.index.min(e,t,i,"range")},t.index.sum=function(e,t,i){return this.index.min(e,t,i,"sum")},t.index.average=function(e,t,i){return this.index.min(e,t,i,"average")},t.index.mapping=async function(e,t){var i,r;return-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),null!=t&&(i=await this.index._send(e,t,"PUT"),C.log(e,"mapped",i)),(r=await this.index._send(e))[(await this.keys(r))[0]].mappings.properties},t.index._for=async function*(e,i,s,n,a,l){var o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,R;for("number"==typeof s&&(s={until:s}),(null!=s?s.scroll:void 0)?("number"!=typeof(R=s.scroll)&&R.endsWith("m")||(R+="m"),delete s.scroll):R="2m",((null!=s?s.until:void 0)||(null!=s?s.max:void 0))&&(c=null!=(f=s.until)?f:s.max,delete s.until,delete s.max),null==i&&(i="*"),null==(h=await this.index.translate(i,s)).from&&(h.from=0),null==h.size&&(h.size=500),null==h.sort&&(h.sort=["_doc"]),E=e.split("/")[0],u=await this.dot(t,E.replace(/_/g,".")),null==a&&(a=null!=(w=null!=(x=this.params._alias)?x:null!=(O=this.S.alias)?O[E.startsWith(this.S.index.name+"_")?E.replace(this.S.index.name+"_",""):E]:void 0)?w:null!=u?u._alias:void 0),"string"==typeof a&&(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),E.endsWith(a)||(e=e.replace(E,E+a))),!0===n&&(n=this.S.index.name),null==n&&(n=null!=(k=null!=u?u._prefix:void 0)?k:this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e)),null==l&&(l=null!=(j=null!=(S=null!=(A=this.S.route)?A[E.startsWith(this.S.index.name+"_")?E.replace(this.S.index.name+"_",""):E]:void 0)?S:null!=u?u._route:void 0)?j:(null!=this&&null!=(I=this.S)&&null!=(m=I.index)?m.url:void 0)?this.S.index.url:null!=(y=r.index)?y.url:void 0),Array.isArray(l)&&(l=l[Math.floor(Math.random()*l.length)]),(null!=(D=await this.index._send(e+"/_search?scroll="+R,h,void 0,n,a))?D._scroll_id:void 0)&&(p=D._scroll_id.replace(/==$/,"")),(null!=D&&null!=(g=D.hits)?g.total:void 0)&&(null==c||c>D.hits.total)&&(c=D.hits.total),o=0;;){if((null!=D&&null!=(_=D.hits)?_.hits:void 0)&&0!==D.hits.hits.length||!(null!=D?D._scroll_id:void 0)||(null!=(D=await this.index._send("/_search/scroll?scroll="+R+"&scroll_id="+D._scroll_id,void 0,void 0,n,a,l))?D._scroll_id:void 0)!==p&&(await this.index._send("/_search/scroll?scroll_id="+p,"",void 0,n,a,l),p=null!=D?D._scroll_id:void 0),o===c||null==(null!=D&&null!=(v=D.hits)?v.hits:void 0)||!D.hits.hits.length){p&&await this.index._send("/_search/scroll?scroll_id="+p,"",void 0,n,a,l);break}o+=1,null==(C=null!=(b=(d=D.hits.hits.shift())._source)?b:d.fields)._id&&(C._id=d._id),yield C}},t.index._each=async function(e,t,i,r,s,n){var a,l,o,u,c,p,h,d,f,m,y;for await(h of(null==r&&null==i&&"function"==typeof t&&(r=t,t="*"),null==r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),"string"==typeof i&&(a=i,i=void 0),(null!=i?i.action:void 0)&&(a=i.action,delete i.action),(m=null!=(d=i.size)?d:"object"==typeof t&&null!=t.size?t.size:1e3)>50&&((p=await this.index.translate(t,i)).size=1,null!=(null!=(l=await this.index._send(e,p,void 0,s,n))&&null!=(f=l.hits)?f.total:void 0)&&0!==l.hits.total&&(u=Math.floor(1e9/(E.byteLength(JSON.stringify(l.hits.hits[0]))*l._shards.total)))<m&&(m=u),p.size=m),c=0,y=[],this.index._for(e,null!=p?p:t,i,s,n)))c+=1,null==(o=await r.call(this,h))||"object"!=typeof o&&"string"!=typeof o||y.push(o),a&&y.length>m&&(await this.index._bulk(e,y,a,void 0,s,n),y=[]);if(a&&y.length&&this.index._bulk(e,y,a,void 0,s,n),this.S.dev&&!0===this.S.bg)return C.log("_each processed "+c)},t.index._bulk=async function(e,i,s="index",n=5e4,a,l,o){var u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,E,R,N,L,P,q,T,W,M,U,z,B,F;if(!0===s&&(s="index"),F=e.split("/")[0],c=await this.dot(t,F.replace(/_/g,".")),null==l&&(l=null!=(v=null!=(E=this.params._alias)?E:null!=(R=this.S.alias)?R[F.startsWith(this.S.index.name+"_")?F.replace(this.S.index.name+"_",""):F]:void 0)?v:null!=c?c._alias:void 0),"string"==typeof l&&(l.startsWith("_")||(l="_"+l),l=l.replace(/\//g,"_"),F.endsWith(l)||(e=e.replace(F,F+l))),!0===a&&(a=this.S.index.name),null==a&&(a=null!=(N=null!=c?c._prefix:void 0)?N:this.S.index.name),"string"==typeof a&&(a.length&&!a.endsWith("_")&&(a+="_"),e.startsWith(a)||(e=a+e)),null==o&&(o=null!=(L=null!=(P=null!=(q=this.S.route)?q[F.startsWith(this.S.index.name+"_")?F.replace(this.S.index.name+"_",""):F]:void 0)?P:null!=c?c._route:void 0)?L:(null!=this&&null!=(T=this.S)&&null!=(W=T.index)?W.url:void 0)?this.S.index.url:null!=(b=r.index)?b.url:void 0),Array.isArray(o)&&(o=o[Math.floor(Math.random()*o.length)]),null==this.index&&(this.index=t.index),"string"==typeof i&&-1!==i.indexOf("\n"))return await this.index._send("/_bulk",{body:i,headers:{"Content-Type":"application/x-ndjson"}},void 0,a,l,o),!0;for(_ in z="object"!=typeof i||Array.isArray(i)||null==(null!=i&&null!=(w=i.hits)?w.hits:void 0)?i:i.hits.hits,Array.isArray(z)||(z=[z]),u=0,p=0,g="",z)if(u+=1,"object"==typeof(U=z[_])&&("string"==typeof(M=null!=(x=null!=(O=U._id)?O:null!=(k=U._source)?k._id:void 0)?x:await this.uid())&&(M=M.replace(/\//g,"_")),U._source&&(U=U._source),delete U._id),(y={})[s]={_index:e},y[s]._id="delete"!==s||"string"!=(j=typeof U)&&"number"!==j?M:U,g+=JSON.stringify(y)+"\n","create"===s||"index"===s?g+=JSON.stringify(U)+"\n":"update"===s&&(g+=JSON.stringify({doc:U})+"\n"),u===n||parseInt(_)===z.length-1||g.length>7e7){if(B=await this.index._send("/_bulk",{body:g,headers:{"Content-Type":"application/x-ndjson"}},void 0,a,l,o),(null!=this&&null!=(S=this.S)?S.dev:void 0)&&!0===(null!=this&&null!=(A=this.S)?A.bg:void 0)&&(null!=B?B.errors:void 0)){for(h=[],f=0,m=(I=B.items).length;f<m;f++){d=I[f];try{200!==(D=d[s].status)&&201!==D&&(h.push(d[s]),p+=1)}catch(e){p+=1}}try{C.log(h)}catch(e){}try{C.log(0===h.length?"SOME":h.length,"INDEX ERRORS BULK LOADING",B.items.length)}catch(e){}}g="",u=0}return z.length-p},t.index.translate=function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C,E,R,N,L,P,q,T,W,M,U,z,B,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,pe,he,de;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==e&&(e=null!=this?this.params:void 0),"string"==typeof e){if(""===e||-1!==e.indexOf("\n"))return}else{if("object"!=typeof e||Array.isArray(e))return;for(y=0,v=(L=["settings","aliases","mappings","index","_id"]).length;y<v;y++)if(null!=e[g=L[y]])return;if(N=!1,e.source)try{N=JSON.parse(decodeURIComponent(e.source))}catch(e){}if("{}"!==JSON.stringify(e)&&null==e.q&&null==e.query&&!1===N&&null==e.must&&null==e.should&&null==e.must_not&&null==e.filter&&null==e.aggs&&null==e.aggregations)return}try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if(null==t&&(t={}),("string"==typeof t||Array.isArray(t))&&(t={fields:t}),"random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null!=t.newest&&(t.sort={createdAt:t.newest?"desc":"asc"},delete t.newest),null==(R=null!=($=null!=t?t.query:void 0)?$:{}).query&&(R.query={}),null==(n=R.query).bool&&(n.bool={must:[],filter:[]}),"string"==typeof e)ae={query_string:{query:e}},null!=(null!=t?t.fields:void 0)&&(ae.query_string.fields="string"==typeof t.fields?t.fields.split(","):t.fields,delete t.fields),R.query.bool.filter.push(ae);else if("object"==typeof e)if(null!=e.query)R=e;else for(I in null!=e.source?"string"==typeof e.source&&"object"==typeof N?R=N:"object"==typeof e.source&&(R=e.source):null!=e.q&&("object"==typeof e.q?R.query=e.q:(e.q=decodeURIComponent(e.q),null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(C={})[(E=e.q.split(":"))[0]]=E[1],R.query.bool.must.push({prefix:C})):null!=e.fields?(R.query.bool.filter.push({query_string:{query:e.q,fields:e.fields.split(",")}}),delete e.fields):R.query.bool.filter.push({query_string:{query:e.q}}))),e)null==t[I]&&(t[I]=e[I]);if(null!=(null!=(Y=R.query)&&null!=(H=Y.filtered)&&null!=(Z=H.query)?Z.bool:void 0)&&(R.query.bool=R.query.filtered.query.bool,R.query.bool.filter=R.query.filtered.filter,delete R.query.filtered),null!=R.facets&&(R.aggregations=JSON.parse(JSON.stringify(R.facets).replace(/\.exact/g,".keyword")),delete R.facets),null!=R.query&&null==R.query.bool&&"{}"!==JSON.stringify(R.query)&&(R.query={bool:{must:[],filter:[R.query]}}),null==R.query&&(R.query={bool:{must:[],filter:[]}}),null==(a=R.query).bool&&(a.bool={must:[],filter:[]}),null==(l=R.query.bool).filter&&(l.filter=[]),"string"==typeof t.sort){for(ne=[],_=0,b=(K=t.sort.split(",")).length;_<b;_++)se=K[_],[g,I]=se.split(":"),I?(ne.push({}),ne[ne.length-1][g.trim()]=I.trim()):ne.push(g.trim());t.sort=ne}if(t.random&&(d={function_score:{random_score:{}}},null!=t.seed&&(d.function_score.random_score.seed=seed),d.function_score.query=R.query,R.query=d,delete t.random,delete t.seed),(m=null!=(Q=null!=(ee=null!=(te=t._include)?te:t.include)?ee:t._includes)?Q:t.includes)&&(null==R._source&&(R._source={}),R._source.includes="string"==typeof m?m.replace(/,\s/g,",").split(","):m),p=null!=(P=null!=(q=null!=(T=t._exclude)?T:t.exclude)?q:t._excludes)?P:t.excludes)for(null==R._source&&(R._source={}),R._source.excludes="string"==typeof p?p.replace(/,\s/g,",").split(","):p,A=0,w=(U=null!=(W=null!=(M=R._source)?M.includes:void 0)?W:[]).length;A<w;A++)f=U[A],R._source.excludes=R._source.excludes.filter((function(e){return e!==f}));for(le=0,x=(z=["filter","restrict","must","and","must_not","not","should","or"]).length;le<x;le++)if(null!=t[ue=z[le]])for(S=Array.isArray(t[ue])?t[ue]:[t[ue]],delete t[ue],c="filter"===ue||"restrict"===ue||"must"===ue||"and"===ue?"filter":"must_not"===ue||"not"===ue?"must_not":"should",null==(o=R.query.bool)[c]&&(o[c]=[]),ce=0,O=S.length;ce<O;ce++)"object"==typeof(re=S[ce])?1===(ie=this.keys(re)).length&&"object"!=typeof re[ie[0]]&&(re={term:re}):re={query_string:{query:re}},R.query.bool[c].push(re);if(null!=t.terms){try{t.terms=t.terms.replace(/,\s/g,",").split(",")}catch(e){}for(null==R.aggregations&&(R.aggregations={}),he=0,k=(B=t.terms).length;he<k;he++)oe=B[he],R.aggregations[oe]={terms:{field:oe+(oe.endsWith(".keyword")?"":".keyword"),size:1e3}};delete t.terms}for(de=0,j=(F=["aggs","aggregations"]).length;de<j;de++)if(null!=t[i=F[de]]){for(h in null==R[i]&&(R[i]={}),t[i])R[i][h]=t[i][h];delete t[i]}for(g in t){if(pe=t[g],("from"===g||"size"===g)&&"number"!=typeof pe)try{pe=parseInt(pe),isNaN(pe)&&(pe=void 0)}catch(e){}null!=pe&&"apikey"!==g&&"_"!==g&&"callback"!==g&&"refresh"!==g&&"key"!==g&&"counts"!==g&&"order"!==g&&"index"!==g&&"search"!==g&&"source"!==g&&"q"!==g&&"_alias"!==g&&"include"!==(J=g.replace("_","").replace("s",""))&&"exclude"!==J&&(R[g]=pe)}try{for(r in D={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},R.aggregations)"string"==typeof(null!=(X=R.aggregations[r].terms)?X.order:void 0)&&null!=D[R.aggregations[r].terms.order]&&(R.aggregations[r].terms.order=D[R.aggregations[r].terms.order])}catch(e){}if(null!=(null!=(V=R.query)?V.bool:void 0))for(u in R.query.bool)for(s in R.query.bool[u])"string"==typeof(null!=(G=R.query.bool[u][s].query_string)?G.query:void 0)&&-1!==R.query.bool[u][s].query_string.query.indexOf("/")&&-1===R.query.bool[u][s].query_string.query.indexOf('"')&&(R.query.bool[u][s].query_string.query='"'+R.query.bool[u][s].query_string.query+'"');return null!=R._source&&null!=R.fields&&delete R._source,R},t.index.translate._auth=!1,t.index._send=async function(e,i,s,n,a,l){var o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j;e.includes("?")?([e,k]=e.split("?"),k="?"+k):k="",(e=e.toLowerCase()).startsWith("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,""));try{e.split("/").pop().includes("#")&&(e=e.replace(/#/g,"%23"))}catch(e){}if(null==s&&(s=""===i?"DELETE":null==i||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=i||"_refresh"===(p=e.split("/").pop().split("?")[0])||"_aliases"===p?"POST":"GET":"PUT"),"DELETE"===s&&-1!==e.indexOf("/_all"))return!1;if(!e.startsWith("http")){if(j=e.split("/")[0],e.startsWith("_")||(o=await this.dot(t,j.replace(/_/g,".")),null==a&&(a=null!=(m=null!=(y=this.params._alias)?y:null!=(g=this.S.alias)?g[j.startsWith(this.S.index.name+"_")?j.replace(this.S.index.name+"_",""):j]:void 0)?m:null!=o?o._alias:void 0),"string"==typeof a&&(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),j.endsWith(a)||(e=e.replace(j,j+a))),null==n&&(n=null!=(_=null!=o?o._prefix:void 0)?_:this.S.index.name),!0===n&&(n=this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e))),null==l&&(l=null!=(v=null!=(b=null!=(w=this.S.route)?w[j.startsWith(this.S.index.name+"_")?j.replace(this.S.index.name+"_",""):j]:void 0)?b:null!=o?o._route:void 0)?v:(null!=this&&null!=(x=this.S)&&null!=(h=x.index)?h.url:void 0)?this.S.index.url:null!=(d=r.index)?d.url:void 0),Array.isArray(l)&&(l=l[Math.floor(Math.random()*l.length)]),"string"!=typeof l)return;e=l+"/"+e}if(e.startsWith("http")){if(c=!1,e.includes("/_search")&&"object"==typeof i&&(null!=i.scroll_id||i.scroll)&&(!0===i.scroll&&(i.scroll="2m"),("number"==typeof i.scroll||"string"==typeof i.scroll&&!i.scroll.endsWith("m"))&&(i.scroll+="m"),e+=(-1===e.indexOf("?")?"?":"&")+"scroll="+(null!=(f=i.scroll)?f:"2m"),i.scroll_id?(c=i.scroll_id,e=e.split("://")[0]+"://"+e.split("://")[1].split("/")[0]+"/_search/scroll"+(e.includes("?")?"?"+e.split("?")[1]:""),e+=(-1===e.indexOf("?")?"?":"&")+"scroll_id="+i.scroll_id,i=void 0):(delete i.scroll_id,delete i.scroll)),u=-1!==(e=e+=k).indexOf("/_bulk")||"object"==typeof i&&"object"==typeof i.headers?i:{body:i},-1===e.indexOf("/_search")||"GET"!==s&&"POST"!==s||(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),e.includes("/_doc/")&&e.split("/_doc/")[1].includes("%")&&(e=e.split("/_doc/")[0]+"/_doc/"+encodeURIComponent(e.split("/_doc/")[1])),u.method=s,!(null==(O=await this.fetch(e,u))||"object"==typeof O&&"number"==typeof O.status&&O.status>=400&&O.status<=600)){if(this.S.dev&&"object"==typeof O&&null!=O.hits){try{null!=(null!=i?i.query:void 0)&&(O.q=i)}catch(e){}try{a&&(O._alias=a)}catch(e){}}return(null!=O?O._scroll_id:void 0)&&(O._scroll_id=O._scroll_id.replace(/==$/,"")),c&&c!==(null!=O?O._scroll_id:void 0)&&await this.index._send("/_search/scroll?scroll_id="+c,""),O}}else C.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!i.g[r.kv]&&(i.g[r.kv]={},i.g[r.kv].get=function(e){return t.fetch(r.kv+"/"+e)},i.g[r.kv].getWithMetadata=async function(e){return{value:await t.fetch(r.kv+"/"+e),metadata:{}}},i.g[r.kv].put=function(e,i){return t.fetch(r.kv+"/"+e,{body:i})},i.g[r.kv].delete=function(e){return t.fetch(r.kv+"/"+e,{method:"DELETE"})},i.g[r.kv].list=function(e){return null==e&&(e={}),t.fetch(r.kv+"/list"+(e.prefix?"/"+e.prefix:"")+(e.cursor?"?cursor="+e.cursor:""))}),t.kv=async function(e,t,r,s,n){var a,l,o,u,c,p,h,d,f,m,y,g,_,v;if(null==e&&(e=null!=(h=null!=(d=this.params.kv)?d:this.params.key)?h:this.parts.join("_"),null==t)){if("DELETE"===this.request.method)t="";else if(this.body)t=this.body;else if(this.params.val)t=this.params.val;else{for(t=this.params,a=0,u=(f=["key","kv","refresh","apikey"]).length;a<u;a++)delete t[o=f[a]];for(l=0,c=(m=this.parts).length;l<c;l++)delete t[o=m[l]]}"string"!=typeof t||0!==t.indexOf("[")&&0!==t.indexOf("{")||(t=JSON.parse(t)),"{}"!==(y=JSON.stringify(t))&&"[]"!==y||(t=void 0)}if("object"!=typeof t||"{}"!==(g=JSON.stringify(t))&&"[]"!==g||(t=void 0),"object"==typeof e&&null==t&&(e=null!=(_=(t=e)._id)?_:await this.uid()),null!=e&&this.S.kv&&i.g[this.S.kv]){if(null!=t&&""!==t){if(p={metadata:s},"number"==typeof r&&(1e3*r>Date.now()?p.expiration=r:p.expirationTtl=r),"object"==typeof t&&(!0===r&&(r=await this.kv(e)),"object"==typeof r))for(o in r)null==t[o]&&(t[o]=r[o]);return this.waitUntil(i.g[this.S.kv].put(e,"object"==typeof t?JSON.stringify(t):t,p)),t}if(({value:v,metadata:s}=await i.g[this.S.kv].getWithMetadata(e,n)),null!=v){try{v=JSON.parse(v)}catch(e){}try{s=JSON.parse(s)}catch(e){}return""===t&&this.waitUntil(i.g[this.S.kv].delete(e)),!0===s?{value:v,metadata:s}:v}}},t.kv._auths="system",t.kv._caches=!1,t.kv.list=async function(e,t){var r,s;try{null==e&&(e=null!=(r=null!=(s=this.params.kv)?s:this.params.prefix)?r:this.params.list)}catch(e){}try{null==t&&(t=this.params.cursor)}catch(e){}return await i.g[this.S.kv].list({prefix:e,cursor:t})},t.kv.count=async function(e){var t,r,s,n,a,l,o,u,c;if(r=0,this.S.kv&&null!=i.g[this.S.kv])for(null==e&&(e=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),t=!1,s=void 0;!t;){for(s=(l=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,n=0,a=(c=l.keys).length;n<a;n++)c[n],r+=1;t=l.list_complete}return r},t.kv.prefixes=async function(){var e;return e={},await this.kv._each(void 0,(function(t){var i;return i=t.split("/")[0],null==e[i]&&(e[i]=0),e[i]+=1})),e},t.kv.clear=function(e){var t;if(this.S.dev)return null==e&&(e=null!=(t=this.params.clear)?t:this.params.kv),this.waitUntil(this.kv._each(e,(function(e){return this.waitUntil(i.g[this.S.kv].delete(e))}))),!0},t.kv.delete=async function(e){var t,i,r,s;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==e&&(e=null!=(i=null!=(r=this.params.kv)?r:this.params.delete)?i:this.params.prefix),s=t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));t&&"0"!==t;)this.S.dev&&C.log(e,t),await this.fetch(this.S.kv+"/clear"+(e?"/"+e:"")),await this.sleep(500),t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));return s}},t.kv.delete._bg=!0,t.kv._each=async function(e,t){var r,s,n,a,l,o,u,c;if(this.S.kv&&null!=i.g[this.S.kv]){for("function"==typeof e&&null==t&&(t=e,e=void 0),r=!1,s=void 0,c=[];!r;){for(s=(o=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,n=0,l=(u=o.keys).length;n<l;n++)a=u[n],"function"==typeof t?this.waitUntil(t.call(this,a.name)):""===t?this.waitUntil(i.g[this.S.kv].delete(a.name)):null!=t&&this.waitUntil(this.kv(a.name,t));c.push(r=o.list_complete)}return c}},null==r.log&&(r.log={}),A=[],I=!1,S=!1,t.log=function(e,t){var i,s,n,a,l,o,u,c,p,h;if(i=async()=>{var e,t;for(!1!==I&&clearTimeout(I),I=setTimeout(i,3e4),S=Date.now(),t=new Date(S).toISOString().replace("T"," ").split(".")[0],e=[];e.length<400&&A.length;)e.push(A.shift());if(e.length)return!0===this.S.bg&&C.log("Writing "+e.length+" logs to index",e[0]._id,e[e.length-1]._id,t),await this.index("logs",e)||(await this.index("logs",{}),await this.index("logs",e)),[]},!1!==this.S.log){if(!0!==t&&(t=null==e),!0!==t&&(this._logs.length>3e4||A.length>3e4)&&(t=!0),"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(s=0,l=e.length;s<l;s++)a=e[s],this._logs.push(a);e=void 0}if(null==e){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return A.push(this.body),!1===I&&i(),!0;e="object"==typeof this.body?this.body:this.params,Array.isArray(e)&&(e={logs:e})}null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers,e.request.headers.cookie&&(e.cookie=!0,delete e.request.headers.cookie)}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(u in e.params={},this.params)e.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(e){}try{e.apikey=null!=this.apikey}catch(e){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}if(t){if(!e.logs&&(e.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(n=0,o=(p=this._logs).length;n<o;n++)(a=p[n]).alert&&null==e.alert&&(e.alert=a.alert),a.notify&&null==e.notify&&(e.notify=a.notify),e.logs.push(a);e.createdAt=new Date,null==e.name&&(e.name=r.name),null==e.version&&(e.version=r.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(e._id=this.rid,null!=(null!=(h=this.S.index)?h.url:void 0))!0===this.S.bg?(A.push(e),("object"==typeof this.S.log&&!1===this.S.log.batch||A.length>300||!1===S||Date.now()>S+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(A.push(e),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:e}));else try{this.kv("logs/"+e._id,e)}catch(t){C.log("Logging unable to save to kv or index"),consolg.log(e)}}else this._logs.push(e)}else this.S.dev&&!0===this.S.bg&&C.log("NOT logging",e);return!0},t.logs={_index:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(e){r.mail={}}t.mail=async function(e){var i,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S;if(null!=(p=r.mail)?p.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(h=this.copy(null!=this?this.params:void 0))?h:{}),e.template){for(o in u=await this.template(e.template,null!=(_=null!=(v=e.vars)?v:e.params)?_:e))e[o]=u[o];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(b=null!=(w=null!=(x=null!=(O=e.content)?O:e.msg)?x:e.body)?w:this.body)?b:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}if(delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),l=(e.svc||e.service)&&null!=(null!=(k=this.S.svc[null!=(j=e.svc)?j:e.service])?k.mail:void 0)?this.S.svc[null!=(d=e.svc)?d:e.service].mail:null!=(f=null!=this&&null!=(m=this.S)?m.mail:void 0)?f:r.mail,null==e.from&&(e.from=l.from),null==e.to&&(e.to=l.to),delete e.svc,S="https://api.mailgun.net/v3/"+l.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),e.to){for(i=null!=(y=null!=this?this.fetch:void 0)?y:t.fetch,c={method:"POST",auth:"api:"+l.apikey},n=0,a=(g=["file","files","attachment","attachments"]).length;n<a;n++)null!=e[s=g[n]]&&(c[s]=e[s],delete e[s]);return c.form=e,await i(S,c)}return C.log(e),C.log("NO ADDRESS TO EMAIL TO"),{}},t.mail._auth="system",t.mail.validate=async function(e,t){var i,r,s,n,a;if(null==e&&(e=null!=this&&null!=(s=this.params)?s.email:void 0),"string"==typeof e&&e.length&&(-1===e.indexOf(" ")||e.startsWith('"')&&2===e.split('"@').length)){try{if("string"==typeof t)return null!=(n=(a=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)).did_you_mean)?n:a.is_valid}catch(e){}if(2===(i=e.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(r=i[1].split(".")).length>1&&(2!==r.length||"example"!==r[0]))return!0}return!1},R=[].indexOf,t.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},t.copy._log=!1,t.dot=function(e,i,r,s,n){var a,l,o;return"string"==typeof i?t.dot(e,i.split("."),r,s,n):1!==i.length||null==r&&null==s?0===i.length?e:null==e[i[0]]?null!=r?(e[i[0]]="number"!=typeof i[0]&&isNaN(parseInt(i[0]))?{}:[],t.dot(e[i[0]],i.slice(1),r,s,n)):n&&Array.isArray(e)&&e.length&&(o=e[e.length-1]&&"object"==typeof o&&null!=o[i[0]])?t.dot(o[i[0]],i.slice(1),r,s,n):void 0:n&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))&&e.length&&"object"==typeof e[e.length-1]?(null!=r&&null==(a=e[e.length-1])[l=i[0]]&&(a[l]={}),t.dot(e[e.length-1][i[0]],i.slice(1),r,s,n)):t.dot(e[i[0]],i.slice(1),r,s,n):null!=s?(e instanceof Array?e.splice(i[0],1):delete e[i[0]],!0):(n&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))?(e.length||(e=[{}]),e[e.length-1][i[0]]=r):e[i[0]]=r,!0)},t.dot._log=!1,t.flatten=async function(e,t){var i,r,s,n,a,l,o;if(null==t&&(t=null!=(a=this.params.arrayed)&&a),null==e&&delete(e=this.params).arrayed,l={},i=async function(e,r){var s,n,a,o,u,c,p;for(a in c=[],e){n=!1;try{n=!isNaN(parseInt(a))}catch(e){}u=n&&!t?r:r?r+"."+a:a,"object"!=typeof(p=e[a])?null!=l[u]?(Array.isArray(l[u])||(l[u]=[l[u]]),c.push(l[u].push(p))):c.push(l[u]=p):Array.isArray(p)?"object"==typeof p[0]?c.push(await async function(){var e;for(o in e=[],p)e.push(await i(p[o],u+(t?"."+o:"")));return e}()):(null==l[u]&&(l[u]=[]),Array.isArray(l[u])||(l[u]=[l[u]]),c.push(function(){var e,t,i;for(i=[],e=0,t=p.length;e<t;e++)s=p[e],i.push(l[u].push(s));return i}())):c.push(await i(p,u))}return c},Array.isArray(e)){for(o=[],s=0,n=data.length;s<n;s++)r=data[s],l={},o.push(await i(r));return o}return await i(e),l},t.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&R.call(i,t)<0&&i.push(t);return i},t.pings={_index:!0},t.ping=async function(){var e,t,i;return e=this.copy(this.params),"{}"!==JSON.stringify(e)&&(e.ip=null!=(t=null!=(i=this.headers["x-forwarded-for"])?i:this.headers["cf-connecting-ip"])?t:this.headers["x-real-ip"],e.forwarded=this.headers["x-forwarded-for"],await this.pings(e),!0)},t.scrape=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b,w,x,O,k,j,S,A,I,D,C;if(null==e&&(e=null!=(k=null!=(j=this.params.scrape)?j:this.params.content)?k:this.params.url),null==t&&(t=this.params.doi),f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(C=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&C.length>1&&9<C[1].length&&C[1].length<45&&-1!==C[1].indexOf("/")&&0===C[1].indexOf("10.")&&(f.doi=C[1]),e=await this.fetch(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{for(r=0,S=e.split(" "),n=0,o=S.length;n<o;n++)if(D=S[n],(r+=1)<600&&(-1!==(D=D.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(D=D.split("doi.org")[1]),0===D.indexOf("/")&&(D=D.replace("/","")),0===(D=D.trim()).indexOf("10.")&&-1!==D.indexOf("/"))){f.doi=D;break}}catch(e){}if(!f.doi)try{for(A=(s=await this.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=A.length;l<u;l++)b=A[l],!f.doi&&9<s.matches[b].result[1].length&&s.matches[b].result[1].length<45&&(f.doi=s.matches[b].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(e){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(w=0,c=m.length;w<c;w++)(v=m[w]).length>2&&(f.year=v)}catch(e){}if(!f.keywords)try{-1!==(a=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(a=a.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=a.split(";")):(a=a.replace(/, /g,",").replace(/ ,/g,","),f.keywords=a.split(","))}catch(e){}if(!f.email){y=[];try{for(I=(await this.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,p=I.length;x<p;x++)(g=I[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===y.indexOf(g)&&y.push(g)}catch(e){}for(y.sort((function(e,t){return t.length-e.length})),_="",O=0,h=y.length;O<h;O++)d=y[O],null==f.email&&(f.email=[]),-1===_.indexOf(d)&&f.email.push(d),_+=d}return f},t.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise((t=>setTimeout(t,null!=e?e:1e3)))},t.sleep._auth="root",t.sleep._log=!1,R=[].indexOf,t.template=async function(e,t){var i,r,s,n,a,l,o,u,c,p,h,d,f,m,y,g,_,v,b;if(null==e&&(e=null!=(f=null!=(m=this.params.content)?m:this.params.template)?f:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(y=this.params.url)?y:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{r=await this.templates(e),e=r.content}catch(e){}if(_={},(i=function(t,r=""){var s,n,a,l;for(s in a=[],t)n=r?r+"."+s:s,"object"!=typeof t[s]||Array.isArray(t[s])?-1!==e.toLowerCase().indexOf("{{"+n+"}}")?(l=new RegExp("{{"+n+"}}","gi"),a.push(e=e.replace(l,Array.isArray(t[s])?t[s].join(", "):"string"==typeof t[s]?t[s]:!0===t[s]?"Yes":!1===t[s]?"No":""))):a.push(void 0):a.push(i(t[s],r+(""===r?"":".")+s));return a})(t),u=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(b=["subject","from","to","cc","bcc"],s=0,p=(g=e.toLowerCase().split("{{")).length;s<p;s++)d=g[s].split("{{")[0].split("}}")[0].split(" ")[0],R.call(b,d)<0&&b.push(d);for(n=0,h=b.length;n<h;n++)a=b[n],(l=-1!==e.toLowerCase().indexOf("{{"+a)?a:void 0)&&(o=-1!==e.indexOf("{{"+l.toUpperCase())?l.toUpperCase():l,(v=e.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(v=v.replace(u,"")),(v=v.split("}}")[0].trim())&&(_[l]=v),c=new RegExp("{{"+o+".*?}}","gi"),e=e.replace(c,""))}return-1!==e.indexOf("{{")&&(e=e.replace(u,"")),_.content=e,_},t.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},t.levenshtein=function(e,t,i){var r,s,n,a,l,o,u,c,p,h,d,f,m;for(null==e&&(e=null!=this&&null!=(h=this.params)?h.a:void 0),null==t&&(t=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(l=e.length)<(u=t.length)&&(r=e,e=t,t=r,c=l,l=u,u=c),p=[[]],r=0;r<u+1;)p[0][r]=r,r++;for(n=1;n<l+1;){for(p[n]=[n],a=1;a<u+1;)s=e.charAt(n-1)===t.charAt(a-1)?0:1,p[n][a]=o(p[n-1][a]+1,p[n][a-1]+1,p[n-1][a-1]+s),a++;n++}return{distance:p[p.length-1][p[p.length-1].length-1],length:{a:l,b:u}}},t.extract=async function(e){var t,i,r,s,n,a,l,o,u,c,p;if(null==e&&(e=this.copy(this.params)),e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=await this.fetch(e.url)),e.convert)try{p=await this.convert[e.convert+"2txt"](null!=(o=e.url)?o:e.content)}catch(e){}if(null==p&&(p=e.content),null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(l=p.split(e.start),p=l.length>1?l[1]:l[0]),null!=e.end&&(p=p.split(e.end)[0]),e.lowercase&&(p=p.toLowerCase()),e.ascii&&(p=p.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(p=p.replace(/ /g,"")),c={length:p.length,matched:0,matches:[],matchers:e.matchers,text:p},p&&"number"!=typeof p)for(t=0,r=(u="string"==typeof e.matchers?e.matchers.split(","):e.matchers).length;t<r;t++){"string"==typeof(n=u[t])?(a="",0===n.indexOf("/")?(i=n.lastIndexOf("/"))+1!==n.length&&(a=n.substring(i+1),n=n.substring(1,i)):n=n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):a="",e.lowercase&&(a+="i");try{(s=new RegExp(n,a).exec(p))&&(c.matched+=1,c.matches.push({matched:n.toString(),result:s}))}catch(e){}}return c},t.decode=async function(e){var t,i,r,s,n,a,l,o,u,c,p,h,d;for(null==e&&(e=null!=(a=null!=(l=null!=(o=null!=this&&null!=(u=this.params)?u.decode:void 0)?o:null!=this&&null!=(c=this.params)?c.content:void 0)?l:null!=this&&null!=(p=this.params)?p.text:void 0)?a:null!=this?this.body:void 0),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(x?[0-9A-Fa-f]+);/gi,(function(e,t){var i;return i=t.startsWith("x")?parseInt(t.replace("x",""),16):parseInt(t,10),String.fromCharCode(i)}))},d=(d=await t(e)).replace(/\n/g," "),r=0,s=(h=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;r<s;r++)i=h[r],n=new RegExp(i.bad,"g"),d=d.replace(n,i.good);try{-1!==d.indexOf("%2")&&(d=decodeURIComponent(d))}catch(e){}try{-1!==d.indexOf("%2")&&(d=decodeURIComponent(d))}catch(e){}return d},r.built="Fri Jul 26 2024 19:30:09 GMT+0100",t.convert.doc2txt={_bg:!0},t.convert.docx2txt={_bg:!0},t.convert.pdf2txt={_bg:!0}})()})();