!function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));let r=e=>crypto.getRandomValues(new Uint8Array(e)),n=(e,t)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,n=-~(1.6*r*t/e.length);return()=>{let s="";for(;;){let a=i(n),l=n;for(;l--;)if(s+=e[a[l]&r]||"",s.length===t)return s}}})(e,t,r)},function(e,t,i){"use strict";i.r(t),function(e,t){var r,n,s,a,l=i(1),o=[].indexOf;try{n=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(a in s=JSON.parse(SECRETS_SERVER))n[a]=s[a]}catch(e){}null==n&&(n={}),null==n.name&&(n.name="Paradigm"),null==n.version&&(n.version="5.3.1"),null==n.dev&&(n.dev=!0),"string"==typeof n.bg&&null==n.pass&&(n.pass=!0),null==n.docs&&(n.docs="https://leviathanindustries.com/paradigm"),null==n.headers&&(n.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==n.formats&&(n.formats=["html","csv"]),null==n.svc&&(n.svc={}),null==n.src&&(n.src={});try{addEventListener("fetch",(function(e){return n.pass&&e.passThroughOnException(),e.respondWith(r.call(e))}))}catch(e){}try{addEventListener("scheduled",(function(e){return e.waitUntil(r.call(e,!0))}))}catch(e){}(r=async function(t){var i,s,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G;this.started=Date.now();try{null==(c=n.headers)[A="X-"+n.name]&&(c[A]=(n.version?"v"+n.version:"")+(n.built?" built "+n.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(n)),this.params={},null!=this.request.url&&-1!==this.request.url.indexOf("?"))for(g=0,x=(P=this.request.url.split("?")[1].split("&")).length;g<x;g++)if(b=(E=P[g]).split("="),this.params[b[0]]=1===b.length||("string"==typeof b[1]&&"true"===b[1].toLowerCase()||("string"!=typeof b[1]||"false"!==b[1].toLowerCase())&&(!!E.endsWith("=")||b[1])),"string"!=typeof this.params[b[0]]||0!==this.params[b[0]].replace(/[0-9]/g,"").length||this.params[b[0]].startsWith("0")||(_=parseInt(this.params[b[0]]),isNaN(_)||(this.params[b[0]]=_)),"string"==typeof this.params[b[0]]&&(this.params[b[0]].startsWith("[")||this.params[b[0]].startsWith("{")))try{this.params[b[0]]=JSON.parse(this.params[b[0]])}catch(e){}else if("string"==typeof this.params[b[0]]&&-1!==this.params[b[0]].indexOf("%"))try{this.params[b[0]]=decodeURIComponent(this.params[b[0]])}catch(e){}try{if((this.request.body.startsWith("{")||this.request.body.startsWith("["))&&(this.body=JSON.parse(this.request.body)),"object"==typeof this.body&&!Array.isArray(this.body))for(E in this.body)null==(h=this.params)[E]&&(h[E]=this.body[E])}catch(e){}try{null==this.body&&(this.body=this.request.body)}catch(e){}try{for(this.headers={},q=[...this.request.headers],v=0,O=q.length;v<O;v++)y=q[v],this.headers[y[0]]=y[1]}catch(e){this.headers=this.request.headers}"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(p=this.S).cache&&(p.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),e[this.S.kv]||delete this.S.kv);try{this.cookie=this.headers.cookie}catch(e){}try{this.rid=this.headers["cf-ray"].slice(0,-4)}catch(e){}try{null==this.rid&&(this.rid=this.headers["x-"+this.S.name+"-async"])}catch(e){}try{this.uid=null!=(M=null!=(z=this.headers["x-uid"])?z:this.headers.uid)?M:this.params.uid}catch(e){}try{this.apikey=null!=(J=null!=(B=this.headers["x-apikey"])?B:this.headers.apikey)?J:this.params.apikey}catch(e){}if(this.headers["x-apikey"]&&delete this.headers["x-apikey"],this.headers.apikey&&delete this.headers.apikey,this.params.apikey&&delete this.params.apikey,this.params.uid&&delete this.params.uid,this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),0!==this.request.url.indexOf("http://")&&0!==this.request.url.indexOf("https://")){this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,""),this.parts=this.url.length?this.url.split("/"):[];try{this.base=this.headers.host}catch(e){}}else this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1],this.parts=this.url.split("/"),this.base=this.parts.shift();if("string"==typeof this.headers.accept&&-1!==this.headers.accept.indexOf("/csv")&&o.call(this.S.formats,"csv")>=0&&(this.format="csv"),this.parts.length&&-1!==this.parts[this.parts.length-1].indexOf(".")&&(S=this.parts[this.parts.length-1].split(".").pop(),o.call(this.S.formats,S)>=0&&(this.format=S,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+S,""))),1===this.parts.length&&("docs"===(W=this.parts[0])||"client"===W)&&"string"==typeof this.S.bg&&this.S.pass)throw new Error;for(d in null!=(X=this.S.domains)?X:{})if(-1!==this.base.indexOf(d)){this.domain=d,this.parts=[...this.S.domains[d],...this.parts];break}if(this.S.dev&&!0===this.S.bg&&console.log(this.base,this.domain),this.route=this.parts.join("/"),this.routes=[],this.fn="",(t||"log/_schedule"===this.route)&&(this.scheduled=!0),this._logs=[],""===this.route)return r._response.call(this,"HEAD"===(Y=this.request.method)||"OPTIONS"===Y?"":{name:this.S.name,version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.dev?this.S.built:void 0});if(l=async(e,t,i)=>{var r,n,s,a,l,o;if(null!=t&&("object"!=typeof t||Array.isArray(t)||"function"!==(null!=(o=t.headers)?o.append:void 0)&&("number"!=typeof t.status||t.status<200||t.status>600))){if(i._key&&Array.isArray(t)&&t.length&&null==t[0]._id&&null!=t[0][i._key])for(s=0,a=t.length;s<a;s++)(r=t[s])._id=Array.isArray(r[i._key])?r[i._key][0]:r[i._key];if(n=Array.isArray(t)?"":"/"+(i._key&&t[i._key]?t[i._key]:null!=(l=t._id)?l:this.uid()).replace(/\//g,"_").replace(e+"_","").toLowerCase(),i._kv&&!Array.isArray(t)&&this.kv(e+n,t,i._kv),!i._index||!1!==i._kv&&this.S.kv&&!this.S.bg||(await this.index(e.split("/")[0])||await this.index(e.split("/")[0],"object"!=typeof i._index?{}:{settings:i._index.settings,mappings:i._index.mappings,aliases:i._index.aliases}),this.index(e+n,t)),i._async)return this.kv("async/"+this.rid,i._index||i._kv?e+n:t)}},s=(e,t)=>(!0===e._sheet&&(e._sheet=r.dot(this.S,t),"string"!=typeof e._sheet&&delete e._sheet),e._sheet&&null==e._index&&(e._index=!0),e._index&&(null==e._search&&(e._search=!0),null==e._schedule&&(e._schedule=t)),!0===e._schedule&&"function"!=typeof e&&(e._schedule=t),"function"!=typeof e||-1!==t.indexOf(".")&&0!==t.split(".").pop().indexOf("_")?"object"!=typeof e||e._index||e._kv||e._bg||"function"==typeof e[this.request.method]?async function(){var i,r,n,s,a,o,u,c,h,p,f,m,y,g,v,b,_,w,x,O,k,A;if(A=Date.now(),k=t.replace(/\./g,"_"),p={fn:t,key:k},e._async&&this.params.async&&!arguments.length&&this.fn===t)if(r=await this.kv("async/"+this.params.async,""))if("string"==typeof r&&-1!==r.indexOf("/")&&2===r.split("/").length)e._kv?O=await this.kv(r):e._index&&(O=await this.index(r));else try{O="string"==typeof r?JSON.parse(r):r}catch(e){O=r}else O={_async:this.params.async};else if(e._index||e._kv)if(1===arguments.length)e._index&&await this.index._q(arguments[0])?p.qry=arguments[0]:"string"==typeof arguments[0]?arguments[0].length?p.key=arguments[0]:y="":"object"==typeof arguments[0]&&(y=arguments[0],p.key=e._key?y[e._key]:y._id?y._id:k);else if(2===arguments.length)e._index&&null!=arguments[0]&&await this.index._q(arguments[0])?(p.qry=arguments[0],arguments[1]):e._index&&"string"==typeof arguments[0]&&-1===arguments[0].indexOf("/")&&await this.index._q(arguments[1])?(p.key=arguments[0],p.qry=arguments[1]):"string"==typeof arguments[0]&&(p.key=arguments[0],y=arguments[1],-1===p.key.indexOf("/")&&(p.key=e._key&&y[e._key]?y[e._key]:y._id?y._id:k));else if(this.fn===t){if("PUT"===this.request.method||"POST"===this.request.method&&!await this.index._q(this.params))y=this.body;else if("DELETE"===this.request.method)y="";else if(await this.index._q(this.params))p.qry=this.params;else if(this.parts.indexOf("create")===this.parts.length-1||this.parts.indexOf("save")===this.parts.length-1){for(y=this.copy(this.params),o=0,u=(x=this.parts).length;o<u;o++)delete y[x[o]];"{}"===JSON.stringify(y)&&(y=void 0)}p.key=this.route}if(p.key&&(p.key=k+"/"+p.key.replace(/\//g,"_").replace(k,"").replace(/^_/,"")),null==O&&(e._index||e._kv)&&(!this.refresh||e._sheet&&this.fn!==t||this.fn===t&&y)&&(e._kv&&-1!==p.key.indexOf("/")&&!p.qry&&null!=(O=await this.kv(p.key,y))&&null==y&&(p.cached="kv"),null==O&&e._index&&(null!=y||e._search))){if(O=await this.index(p.key,null!=y?y:p.qry?await this.index.translate(p.qry):void 0),this.fn!==t&&"string"==typeof p.qry&&-1===p.qry.indexOf(" ")&&!y&&1===(null!=O&&null!=(g=O.hits)?g.total:void 0)&&p.qry.indexOf(-1!==O.hits.hits[0]._id))try{O=O.hits.hits[0]._source}catch(e){}null!=O&&null==y&&(p.cached="index")}if(p.cached&&this.fn.startsWith(t)&&(this.cached=p.cached),null==O&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&0===this.S.bg.indexOf("http")){(n={headers:{},body:null!=y?y:arguments.length?arguments[0]:this.params}).headers["x-"+this.S.name+"-async"]=this.rid;try{O=await this.fetch(this.S.bg+"/"+p.key.replace(/_/g,"/")+(this.refresh?"?refresh=true":""),n),p.bg=!0}catch(e){}}if(null!=O||!e._sheet||!this.refresh&&await this.index(k)||(O=await this.src.google.sheets(e._sheet),"function"==typeof e&&(O=await e(O)),await this.index(k,""),this.waitUntil(l(k,this.copy(O),e)),O=O.length),null==O&&("function"==typeof(null!=(v=e[this.request.method])?v:e)?e._async?(p.async=!0,O={_async:this.rid},i=async(e,t)=>{var i,r;if(i=await(null!=(r=t[this.request.method])?r:t).apply(this,arguments))return l(e,this.copy(i),t)},this.waitUntil(i(k,e))):null!=(O=await(null!=(b=e[this.request.method])?b:e).apply(this,arguments))&&(e._kv||e._index)&&this.waitUntil(l(k,this.copy(O),e)):!e._index||p.qry||y||-1!==k.indexOf("/")||await this.index(k)||(O=await this.index(k,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:e._index.mappings,aliases:e._index.aliases}))),e._diff&&"GET"===this.request.method&&null!=O&&!p.cached&&!p.async)try{if(p.args=JSON.stringify(arguments),Array.isArray(e._diff)&&"string"==typeof e._diff[0]){if(e._diff[0].startsWith("-"))for(a=this.copy(O),_=e._diff,f=0,c=_.length;f<c;f++)delete a[(d=_[f]).replace("-","")];else for(a={},w=e._diff,m=0,h=w.length;m<h;m++)a[s=w[m]]=O[s];p.res=JSON.stringify(a)}else p.res=JSON.stringify(O)}catch(e){}if(e._history&&(e._index||e._kv)&&null!=y&&!Array.isArray(y))try{p.rec=JSON.stringify(y)}catch(e){}p.qry&&(p.qry=JSON.stringify(p.qry));try{p.took=Date.now()-A}catch(e){}return this.log(p),O}.bind(this):JSON.parse(JSON.stringify(e)):e.bind(this)),G=[],f=void 0,C=[...this.parts],j=void 0,(i=(e,t,r)=>{var n,l;if(j&&0===this.fn.indexOf(r))for(;C.length&&null==e[C[0]];)this.params[j]=(this.params[j]?this.params[j]+"/":"")+C.shift();for(a in l=[],e)if("function"!=(n=typeof e[a])&&"object"!==n)try{l.push(t[a]=JSON.parse(JSON.stringify(e[a])))}catch(i){l.push(t[a]=e[a])}else t[a]=s(e[a],r+(r?".":"")+a),this.scheduled&&t[a]._schedule&&G.push(t[a]),a.startsWith("_")||(C.length&&C[0]===a&&0===this.fn.indexOf(r)&&(j=C.shift(),this.fn+=(""===this.fn?"":".")+j,"function"==typeof t[a]&&-1===r.indexOf("._")&&(f=t[a])),"function"!=typeof t[a]||t[a]._hidden||-1!==r.indexOf("scripts.")||this.routes.push((r+(r?".":"")+a).replace(/\./g,"/"))),Array.isArray(e[a])||a.startsWith("_")&&"function"!=typeof t[a]?l.push(void 0):l.push(i(e[a],t[a],r+(r?".":"")+a));return l})(r,this,""),j&&C.length&&(this.params[j]=this.params[j]?this.params[j]+"/"+C.join("/"):C.join("/")),this.scheduled){for(F=[],w=0,k=G.length;w<k;w++)"function"==typeof(m=G[w])._schedule?F.push(await m._schedule()):!0===m._schedule?F.push(await m()):"string"==typeof m._schedule&&(I=[],m._sheet&&(I=await this.src.google.sheets(m._sheet),"function"==typeof m&&(I=await m(F))),await this.kv._each(m._schedule,(async function(e){var t;if(-1!==e.indexOf("/")&&e!==m._schedule)return null==(t=await this.kv(e,m._kv?void 0:""))._id&&(t._id=e.split("/").pop()),I.push(t)})),I.length&&this.waitUntil(this.index(m._schedule,I)),F.push({indexed:I.length}));return this._response(F)}if("function"==typeof f&&(this.S.name&&this.S.system&&this.headers["x-"+this.S.name+"-system"]===this.S.system?(this.system=!0,u=!0):("object"==typeof(u=this.auth())&&u._id&&u.email&&(this.user=u),u="function"==typeof f._auth?await f._auth():!0===f._auth&&null!=this.user||(!f._auth||await this.auth.role(f._auth))),u?("string"==typeof f._format&&(V=f._format,o.call(this.S.formats,V)>=0)&&null==this.format&&(this.format=f._format),"HEAD"===(L=this.request.method)||"OPTIONS"===L?F="":!1!==f._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&this.index._q(this.params))&&(F=await this._cache())?(this.cached="cache",(F=new Response(F.body,F)).headers.append("x-"+this.S.name+"-cached","cache"),F.headers.delete("x-"+this.S.name+"-took")):(F=await f(),this.completed=!0)):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),F={status:401},"html"===this.format&&(F.body=await this.auth()))),(null==F||"object"==typeof F&&404===F.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(F=""),$="object"!=typeof F||Array.isArray(F)||"function"!=typeof(null!=(R=F.headers)?R.append:void 0)?await this._response(F):F,(this.scheduled||this.parts.length&&"log"!==(T=this.parts[0])&&"status"!==T&&"HEAD"!==(U=this.request.method)&&"OPTIONS"!==U&&null!=F&&""!==F)&&(!this.completed||!1===f._cache||200!==$.status||"object"==typeof F&&!Array.isArray(F)&&0===(null!=(D=F.hits)?D.total:void 0)||f._sheet&&"number"==typeof F&&this.refresh||this._cache(void 0,$,f._cache),this.log()),this.completed||this.cached||this.unauthorised||this.scheduled||!this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(N=this.request.method)||"OPTIONS"===N)return $;throw new Error})._response=async function(e){var i,r,n,s,a,l,o,u;if(null==(i=this.S).headers&&(i.headers={}),null==e)e=404,u=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(s in e.headers)this.S.headers[s]=e.headers[s];delete e.headers}u=null!=(l=e.status)?l:200,delete e.status,0===(a=this.keys(e)).length?e=u:1===a.length&&(e=e[a[0]])}else u=200;if(null==this.S.headers["Content-Type"]){if(this.format&&("html"===(o=this.format)||"csv"===o)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(r=this.S.headers)["Content-Type"]&&(r["Content-Type"]="application/json; charset=UTF-8")}try{null==(n=this.S.headers)["Content-Length"]&&(n["Content-Length"]=t.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name+"-cached"]=this.cached)}catch(e){}try{return new Response(e,{status:u,headers:this.S.headers})}catch(t){return{status:u,headers:this.S.headers,body:e}}},r.src={},r.svc={},r.scripts={};o=[].indexOf;r.auth=async function(e,t){var i,r,s,a,l,o,u,c,h,p,d,f;try{if(this.S.name&&this.S.system&&this.headers["x-"+n.name+"-system"]===this.S.system)return!0}catch(e){}if("string"==typeof e)return await this.kv("user/"+e);if((null==this.params.access_token||!(f=await this.oauth()))&&(this.params.token&&(r=await this.kv("auth/token/"+this.params.token,""))&&((p=await this.kv("user/email/"+r.toLowerCase()))&&(f=await this.kv("user/"+p)),null==f&&(f=await this.auth._insert(r))),!f&&this.apikey&&(p=await this.kv("user/apikey/"+this.apikey))&&(f=await this.kv("user/"+p)),!f&&(null!=this.params.resume||this.cookie))){if((p=this.id)||null==this.params.email||(p=await this.kv("user/email/"+this.params.email.toLowerCase())),!(h=this.params.resume))try{h=(i=JSON.parse(decodeURIComponent(this.cookie).split((null!=(s=null!=(a=null!=(l=n.auth)&&null!=(o=l.cookie)?o.name:void 0)?a:n.name)?s:"n2")+"=")[1].split(";")[0])).resume,p=i.id}catch(e){}null!=h&&null!=p&&await this.kv("auth/resume/"+p+"/"+h,this.params.resume?"":void 0)&&(f=await this.kv("user/"+p))}return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(u=f.roles)?u[this.params.service]:void 0)&&((d={}).roles=null!=(c=f.roles)?c:{},d.roles[this.params.service]="user",this.kv("user/"+f._id,d,f)),null==this.params.resume&&null==this.params.token||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,Date.now(),789e4))),null==e&&null==t&&null==f&&"html"===this.format?'<input style="min-width:250px;" type="text" name="email" placeholder="Enter your email address to sign in"><input style="display:none;min-width:250px;" type="text" name="token" placeholder="Enter the login token once you receive it">':f},r.auth.token=async function(e,t,i,r,s,a,l){var o,u,c,h,p,d,f,m;return null==e&&(e=null!=(o=this.params.email)?o:""),e=e.toLowerCase(),null==t&&(t=null!=(u=null!=(c=n.auth)?c.from:void 0)?u:"nobody@example.com"),null==i&&(i=null!=(h=null!=(p=n.auth)?p.subject:void 0)?h:"Please complete your login"),m=this.uid(8),null==l&&(l=(null!=(d=null!=(f=this.params.url)?f:this.request.url)?d:"https://example.com").split("?")[0].replace("/token","")+"?token="+m),this.kv("auth/token/"+m,e,900),t&&e?await this.mail.send({from:t,to:e,subject:i,text:null!=r?r:"Your login code is:\r\n\r\n{{TOKEN}}\r\n\r\nor use this link:\r\n\r\n{{URL}}\r\n\r\nnote: this single-use code is only valid for 15 minutes.",html:null!=s?s:'<html><body><p>Your login code is:</p><p><b>{{TOKEN}}</b></p><p>or click on this link</p><p><a href="{{URL}}">{{URL}}</a></p><p>note: this single-use code is only valid for 15 minutes.</p></body></html>',params:{token:m,url:l}}):m},r.auth.role=function(e,t){var i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v;if(null==e&&(e=this.params.role),null==e&&"string"==typeof(null!=(c=this.opts)?c.auth:void 0)&&(e=this.opts.auth),null==t&&(t=this.user),"string"==typeof e&&-1!==e.indexOf("/")&&null==t&&(t=e.split("/").pop(),e=e.replace("/"+t,"")),null==(null!=(v=null!=t&&t!==(null!=(h=this.user)?h._id:void 0)?this.user(t):this.user)?v.roles:void 0))return!1;for("string"==typeof e&&(e=[e]),s=0,l=e.length;s<l;s++){if(r=(r=e[s]).replace("/","."),[n,g]=r.split("."),null==g&&(g=n,n="__global__"),n===v.id)return"owner";if(o.call(null!=(p=v.roles.__global__)?p:[],"root")>=0)return"root";if(o.call(null!=(d=v.roles[n])?d:[],g)>=0)return g;if(null!=v.roles[n]&&0<(m=(i=["root","service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public"]).indexOf(g)))for(a=0,u=(f=i.splice(0,m)).length;a<u;a++)if(y=f[a],o.call(v.roles[n],y)>=0)return y}return!1},r.auth.roles=async function(e,t,i){var r,n,s,a,l,u;return null==e&&(e=null!=(s=this.user)?s:this.params.roles),"string"==typeof e&&(e=await this.kv("user/"+e)),[n,u]=t.split("."),null==u&&(u=n,n="__global__"),null==(a=o.call(null!=(l=e.roles)?l[n]:void 0,u)>=0)||a?null!=i?(e.roles[n].splice(e.roles[n].indexOf(u),1),this.kv("user/"+e._id,e)):void 0:(null==(r=e.roles)[n]&&(r[n]=[]),e.roles.group.push(u),this.kv("user/"+e._id,e))},r.auth.logout=function(e){if(null==e&&(e=this.user),null!=e)return this.kv("auth/resume/"+("string"==typeof e?e:e._id),"")},r.oauth=async function(e,t){var i,r,s,a,l,o,u,c,h,p,d,f,m,y,g,v;if(m={},null!=e?e:e=this.params.access_token)try{v=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(r=n.svc[null!=(a=this.params.service)?a:"z"])&&null!=(l=r.google)&&null!=(o=l.oauth)&&null!=(u=o.client)?u.id:void 0)?i:null!=(c=n.use)&&null!=(h=c.google)&&null!=(p=h.oauth)&&null!=(d=p.client)?d.id:void 0),null!=t&&(null!=(s=v.data)?s.aud:void 0)===t&&(f=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e),(y=await this.kv("user/email/"+f.data.email.toLowerCase()))&&((g=await this.kv("user/"+y))||(g=await this.auth._insert(f.data.email.toLowerCase()))),null==g.google&&(m.google={id:f.data.id}),f.data.name?g.name||(m.name=f.data.name):f.data.given_name&&!g.name&&(m.name=f.data.given_name,f.data.family_name&&(m.name+=" "+f.data.family_name)),!g.avatar&&f.data.picture&&(m.avatar=f.data.picture))}catch(e){}return null!=g&&"{}"!==JSON.stringify(m)&&(g=await this.user.update(g.id,m)),g},r.auth._insert=async function(e,t){var i,r,n,s,a;if("string"!=typeof e||null==t)return"string"==typeof e&&-1!==e.indexOf("@")&&-1!==e.indexOf(".")&&(i=e.toLowerCase()),null==e&&(null!=this&&null!=(n=this.user)?n._id:void 0)&&(e="user/"+this.user._id),-1!==e.indexOf("@")&&(e=await this.kv("user/email/"+e.toLowerCase())),null==await this.kv("user/"+e)&&i?(!1,(s={email:i.trim().toLowerCase(),apikey:this.uid(),profile:{}}).roles={},s.createdAt=Date.now(),s._id=this.uid(),this.kv("user/apikey/"+apikey,s._id),this.kv("user/email/"+email.toLowerCase(),s._id),this.kv("user/"+s._id,s),s):void 0;if(""===t){e.startsWith("user/")&&(e=e.replace("user/","")),a=(null!=(r=this.user)?r._id:void 0)===e?this.user:await this.kv("user/"+e);try{this.auth.logout(e)}catch(e){}try{null!=a.apikey&&this.kv("user/apikey/"+a.apikey,"-")}catch(e){}try{null!=a.email&&this.kv("user/email/"+a.email.toLowerCase(),"-")}catch(e){}return this.kv("user/"+e,"")}},r.auth._update=async function(e,t){var i;if(null==t&&(t=e.auth),e.param&&this.auth(e.param)&&"","{}"!==JSON.stringify(e.params)){for(i in null==t.profile&&(t.profile={}),e.params)t.profile[i]=pr[i];return await this.kv("user/"+t.id,t),!0}return!1};var u;o=[].indexOf;r.convert={},r.convert.json2csv=async function(e,t){var i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O;if(null==e&&(e=null!=(y=this.body)?y:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(g=e.hits)?g.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),p=null!=(v=t.quote)?v:'"',O=null!=(b=t.separator)?b:",",c=null!=(_=t.newline)?_:"\n",e.length){for(r=[],m="",n=0,l=e.length;n<l;n++){if(f=e[n],m.length&&(m+=c),!1!==t.es&&(f._source||f.fields)){for(h in d={_id:"<a onclick=\"this.setAttribute('href', window.location.href.split('.html')[0].split('/').pop() + '/' + this.getAttribute('href') )\" href=\""+f._id+'.html">'+f._id+"</a>"},x=null!=(w=f._source)?w:f.fields)d[h]=x[h];f=d}for(a in t.flatten&&(f=await this.flatten(f)),t.subset&&(f=await this.dot(f,t.subset)),f)null!=f[a]&&o.call(r,a)<0&&r.push(a);for(s=0,u=r.length;s<u;s++){if(i=r[s],m.length&&!m.endsWith(c)&&(m+=O),m+=p,null!=f[i]){try{Array.isArray(f[i])&&1===f[i].length&&Array.isArray(f[i][0])&&(f[i]=f[i][0])}catch(e){}try{Array.isArray(f[i])&&f[i].length&&"string"==typeof f[i][0]&&(f[i]=f[i].join(", "))}catch(e){}try{"object"==typeof f[i]&&(f[i]=JSON.stringify(f[i]))}catch(e){}try{f[i]=f[i].replace(/"/g,p+p)}catch(e){}try{f[i]=f[i].replace(/,,/g,O)}catch(e){}try{f[i]=f[i].replace(/\n/g," ")}catch(e){}try{f[i]=f[i].replace(/\s\s/g," ")}catch(e){}try{m+=f[i]}catch(e){}}m+=p}}return p+r.join(p+O+p)+p+"\n"+m}return""},r.convert.csv2json=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w;if(null==e&&(e=null!=(f=this.body)?f:this.params.csv),this.params.url&&(e=await this.fetch(url)),null==t&&(t=this.params),d=null!=(m=t.quote)?m:'"',_=null!=(y=t.separator)?y:",",p=null!=(g=t.newline)?g:"\n",v=[],"string"==typeof(e=e.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX"))&&e.length&&(c=e.split(p)).length){for(s=0,l=(n=c.shift().split(d+_)).length;s<l;s++)0===(r=n[s]).indexOf(d)&&(r=r.replace(d,""));for(a=0,o=c.length;a<o;a++){for(b={},w=c[a].split(d+_),h=0,u=n.length;h<u;h++)if(i=n[h],w.length&&(b[i]=w.shift(),b[i])){b[i]=b[i].replace(/^"/,"").replace(/"$/,"").replace(/XXX_QUOTER_GOES_HERE_XXX/g,d);try{b[i]=JSON.parse(b[i])}catch(e){}}v.push(b)}}return v},r.convert.csv2html=async function(e){var t,i,r,n,s,a,l,o,u,c,h,p,d,f,m;if(null==e&&(e=null!=(c=this.body)?c:this.params.csv),this.params.url&&(e=await this.fetch(url)),'"',",","\n",d="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>",d+='<table class="paradigm" style="border-collapse: collapse;">',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(l=e.split("\n")).length){for(d+="<thead><tr>",o=0,t=0,r=(h=l.shift().split('","')).length;t<r;t++)d+='<th style="padding:2px; border:1px solid #ccc;">'+h[t].replace(/"/g,"")+"</th>",o+=1;for(d+="</tr></thead><tbody>",i=0,n=l.length;i<n;i++){for(a=l[i],d+="<tr>";-1!==a.indexOf(',"",');)a=a.replace(',"",',',"XXX_EMPTY_XXX",');for(;a.startsWith('"",');)a=a.replace('"",','"XXX_EMPTY_XXX",');for(;a.endsWith(',""');)a=a.slice(0,a.length-3);for(m=0,u=0,s=(p=(a=a.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;u<s;u++)m+=1,d+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(f=(f=p[u]).replace(/^"/,"").replace(/"$/,""))&&(0===f.indexOf("{")||0===f.indexOf("[")?(d+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",d+=await this.convert.json2html(JSON.parse(f.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),d+="</div>"):d+=f.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),d+="</td>";for(;m<o;)d+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',m+=1;d+="</tr>"}d+="</tbody>"}return d+"</table>"},r.convert.json2html=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d;if(null==e&&(e=null!=(u=this.body)?u:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.subset&&!Array.isArray(e))for(o=t.subset.split(".");(l=o.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[l];)e=e[l];if(Array.isArray(e)||(null!=e&&null!=(c=e.hits)?c.hits:void 0)&&!1!==t.es)return null!=o&&(t.subset=o.join(".")),await this.convert.csv2html(await this.convert.json2csv(e,t));if(p="<div>",t.edit){for(p+='<div style="clear:both; margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>status</p></b></div>',p+='<div style="float:left;"><select class="pradmForm" id="status" style="margin-top:15px;margin-bottom:0px;min-width:180px;">',r=0,s=(h=["","Verified","Denied","Progressing","Overdue","Provided","Cancelled","Done"]).length;r<s;r++)d=h[r],p+="<option"+(e.status===d?' selected="selected"':"")+">"+d+"</option>";delete e.status,p+="</select></div>"}if(t.flatten&&(e=await this.flatten(e),p+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(o.length)for(n=0,a=o.length;n<a;n++)e=e[o[n]];p+="<h3>"+t.subset+":</h3>",p+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return(i=e=>{var r,n,s,a,l,o,u;for(r in t.edit&&null==e.comments&&(e.comments=""),o=[],e){try{Array.isArray(e[r])&&1===e[r].length&&Array.isArray(e[r][0])&&(e[r]=e[r][0])}catch(e){}if(null==e[r]||Array.isArray(e[r])&&!e[r].length)o.push(void 0);else{if(p+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+r+"</p></b></div>",p+='<div style="float:left;">',p+=t.edit?'<textarea class="pradmForm" id="'+r+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[r]))if("object"==typeof e[r][0])for(s=0,n=(l=e[r]).length;s<n;s++)a=l[s],i(a);else{try{u=e[r].join(", ")}catch(t){try{u=JSON.stringify(e[r])}catch(t){u=e[r]}}try{p+=(t.edit?"":"<p>")+u+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[r]?i(e[r]):p+=(t.edit?"":"<p>")+e[r]+(t.edit?"":"</p>");p+=t.edit?"</textarea>":"",o.push(p+="</div></div>")}}return o})(e),p+="</div>",t.edit&&(p='<script type="text/javascript" src="/client/pradm.js"><\/script><script type="text/javascript" src="/client/pradmEdit.js"><\/script>'+p,p+='<script type="text/javascript">pradm.edit()<\/script>'),p},r.convert.json2txt=async function(e){var t,i,r;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),r=[],t=async function(e){var i,n,s,a,l;if(Array.isArray(e)){for(a=[],n=0,s=e.length;n<s;n++)i=e[n],a.push(await t(i));return a}if("object"==typeof e){for(i in l=[],e)l.push(await t(e[i]));return l}if(e)return r.push(e)},await t(e),r.join(" ")},r.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},r.convert.hex2bin=function(e){var t,i,n,s,a;for(a=[],t=0,n=(s=Array.isArray(e)?e:[e]).length;t<n;t++)i=s[t],a.push(r.convert._hexMatch[i.toLowerCase()]);return a.join("")},r.convert.bin2hex=function(e){var i,n,s,a,l,o,u,c,h;if(!Array.isArray(e)){for(i=[],h=e.split(""),u="";h.length;)4===(u+=h.shift()).length&&(i.push(u),u="");e=i}for(a in c=[],n={},r.convert._hexMatch)n[r.convert._hexMatch[a]]=a;for(s=0,o=e.length;s<o;s++)l=e[s],c.push("0x"+n[l]);return new t(c).toString()},r.convert.buf2bin=function(e){var i,n;for(t.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),n="",i=0;i<e.length;)n+=r.convert.hex2bin(e[i]),i++;return n},r.convert._mimes={".aac":"audio/aac",".abw":"application/x-abiword",".arc":"application/x-freearc",".avi":"video/x-msvideo",".azw":"application/vnd.amazon.ebook",".bin":"application/octet-stream",".bmp":"image/bmp",".bz":"application/x-bzip",".bz2":"application/x-bzip2",".csh":"application/x-csh",".css":"text/css",".csv":"text/csv",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".eot":"application/vnd.ms-fontobject",".epub":"application/epub+zip",".gz":"application/gzip",".gif":"image/gif",".htm":"text/html",".ico":"image/vnd.microsoft.icon",".ics":"text/calendar",".jar":"application/java-archive",".jpg":"image/jpeg",".js":"text/javascript",".json":"application/json",".jsonld":"application/ld+json",".mid":"audio/midi",".mjs":"text/javascript",".mp3":"audio/mpeg",".mpeg":"video/mpeg",".mpkg":"application/vnd.apple.installer+xml",".odp":"application/vnd.oasis.opendocument.presentation",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odt":"application/vnd.oasis.opendocument.text",".oga":"audio/ogg",".ogv":"video/ogg",".ogx":"application/ogg",".opus":"audio/opus",".otf":"font/otf",".png":"image/png",".pdf":"application/pdf",".php":"application/php",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".py":"text/plain",".rar":"application/vnd.rar",".rb":"text/plain",".rtf":"application/rtf",".sh":"application/x-sh",".svg":"image/svg+xml",".swf":"application/x-shockwave-flash",".tar":"application/x-tar",".tif":"image/tiff",".ts":"video/mp2t",".ttf":"font/ttf",".txt":"text/plain",".vsd":"application/vnd.visio",".wav":"audio/wav",".weba":"audio/webm",".webm":"video/webm",".webp":"image/webp",".woff":"font/woff",".woff2":"font/woff2",".xhtml":"application/xhtml+xml",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xml":"application/xml",".xul":"application/vnd.mozilla.xul+xml",".zip":"application/zip",".3gp":"video/3gpp",".3g2":"video/3gpp2",".7z":"application/x-7z-compressed"},r.convert.mime=function(e){var t,i,n,s,a;return null==e&&(e=null!=(i=null!=(n=null!=(s=this.params.fn)?s:this.params.mime)?n:this.params.filename)?i:this.params.file),"html"===(a=(-1===e.indexOf(".")?e:e.substr(e.lastIndexOf(".")+1)).toLowerCase())&&(a="htm"),"jpeg"===a&&(a="jpg"),"tiff"===a&&(a="tif"),"midi"===a&&(a="mid"),"string"==typeof(t=r.convert._mimes["."+a])&&t},null==n.example&&(n.example={}),n.example.example=3,r.example=function(){var e;e={name:n.name,version:n.version,built:n.built};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}if(n.dev){try{null==e.headers&&(e.headers=this.headers)}catch(e){}try{null==e.parts&&(e.parts=this.parts)}catch(e){}try{null==e.params&&(e.params=this.params)}catch(e){}try{null==e.opts&&(e.opts=this.opts)}catch(e){}}return e},r.example.restricted=function(){return{hello:this.user._id}},r.example.restricted._auth=!0,r.example.deep=async function(){var e;e={example:"deep",deeper:await this.example.deep.deeper()};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},r.example.deep.deeper=async function(){var e;e={hello:"deeper"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}try{e.deepest=await this.example.deep.deeper.deepest()}catch(e){}return e},r.example.deep.deeper.deepest=function(){var e;e={hello:"deepest"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},r.example.inbetween=function(){return console.log(typeof this.params.example),this.params},r.fetch=async function(e,i){var r,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_;if(null==e&&null==i)try{i=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==i&&(e=(i=e).url),null==i&&(i={}),!e&&i.url&&(e=i.url,delete i.url),!0===i.bg&&"string"==typeof this.S.bg&&(i.url=e,e=this.S.bg+"/fetch",delete i.bg),i.username&&i.password&&(i.auth=i.username+":"+i.password,delete i.username,delete i.password),-1!==e.split("//")[1].split("@")[0].indexOf(":")&&(i.auth=e.split("//")[1].split("@")[0],e=e.replace(i.auth+"@","")),i.auth&&(null==i.headers&&(i.headers={}),i.headers.Authorization="Basic "+t.from(i.auth).toString("base64"),delete i.auth),l=0,c=(y=["data","content","json"]).length;l<c;l++)null!=i[a=y[l]]&&(i.body=i[a],delete i[a]);if(null!=i.body&&(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="object"==typeof i.body?"application/json":"text/plain"),"object"!=(g=typeof i.body)&&"boolean"!==g&&"number"!==g||(i.body=JSON.stringify(i.body)),null==i.method&&(i.method="POST")),null!=i.form&&(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="application/x-www-form-urlencoded"),i.body="string"==typeof i.form?i.form:await this.params(i.form),delete i.form,null==i.method&&(i.method="POST")),"string"!=typeof e)return!1;try{if(-1!==e.indexOf("?")){for(d=e.split("?")[0]+"?",v=e.split("?")[1].split("&"),o=0,h=v.length;o<h;o++)m=v[o],d.endsWith("?")||(d+="&"),[u,_]=m.split("="),null==_&&(_=""),d+=u+"="+(-1!==_.indexOf("%")?_:encodeURIComponent(_));e=d}}catch(e){}n.system&&("string"==typeof n.bg&&e.startsWith(n.bg)||"string"==typeof n.kv&&n.kv.startsWith("http")&&e.startsWith(n.kv))&&(null==i.headers&&(i.headers={}),null==(s=i.headers)[p="x-"+n.name+"-system"]&&(s[p]=n.system)),r=async()=>{var t,r,s;i.verbose?(s=!0,delete i.verbose):s=!1;try{-1!==e.indexOf("localhost")&&null==i.agent&&(i.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(r=await fetch(e,i),n.dev&&console.log(r.status+" "+e),s)return r;t=await r.text();try{"string"!=typeof t||0!==t.indexOf("{")&&0!==t.indexOf("[")||(t=JSON.parse(t))}catch(e){}return 404===r.status?void 0:r.status>=400?(n.dev&&(console.log(JSON.stringify(t)),console.log("ERROR "+r.status)),{status:r.status}):t},i.timeout?(f=!0===i.timeout?3e4:i.timeout,delete i.timeout,b=await this._timeout(f,r())):b=await r();try{0!==(b=b.trim()).indexOf("[")&&0!==b.indexOf("{")||(b=JSON.parse(b))}catch(e){}return b},null==n.log&&(n.log={}),r.log=async function(e){var t,i,r,s,a,l,o,u,c,h,p,d;if(!1!==this.S.log){if(d=null==e,"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(t=0,s=e.length;t<s;t++)r=e[t],this._logs.push(r);e=void 0}if(null==e){1===this.parts.length&&"log"===this.parts[0]&&null==(e="object"==typeof this.body?{logs:this.body}:this.params).fn&&(e.fn=this.params.log),null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(o in e.params={},this.params)e.params[o]="string"==typeof this.params[o]?this.params[o]:JSON.stringify(this.params[o])}catch(e){}try{e.apikey=null!=this.headers.apikey||null!=this.headers["x-apikey"]}catch(e){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}else if("object"==typeof e&&e.res&&e.args)try{u=await this.index("log",'args:"'+e.args),e.diff=u.hits.hits[0]._source.res!==e.res}catch(e){}if(!d)return this._logs.push(e);if(null==e.logs&&(e.logs=[]),Array.isArray(null!=this?this._logs:void 0)&&this._logs.length)for(i=0,a=(h=this._logs).length;i<a;i++)(r=h[i]).alert&&null==e.alert&&(e.alert=r.alert),r.notify&&null==e.notify&&(e.notify=r.notify),e.logs.push(r);e.createdAt=new Date,null==e.name&&(e.name=n.name),null==e.version&&(e.version=n.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(l="log/"+(null!=(p=this.rid)?p:await this.uid()),!0!==this.S.bg&&!1!==this.S.kv)return this.kv(l,e);if(!await this.index(l,e))return await this.index("log",{}),this.index(l,e)}else if(this.S.dev&&!0===this.S.bg)return console.log(e)},r.log._schedule="log",r.log.schedule=function(){return this.kv._each("log","")};try{n.mail=JSON.parse(SECRETS_MAIL)}catch(e){n.mail={}}r.mail=async function(e){var t,i,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w,x;if(null!=(o=n.mail)?o.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(u=this.copy(null!=this?this.params:void 0))?u:{}),e.template){for(a in l=await this.template(e.template,null!=(f=null!=(m=e.vars)?m:e.params)?f:e))e[a]=l[a];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(y=null!=(g=null!=(v=null!=(b=e.content)?b:e.msg)?v:e.body)?g:this.body)?y:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}return delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),s=(e.svc||e.service)&&null!=(null!=(_=this.S.svc[null!=(w=e.svc)?w:e.service])?_.mail:void 0)?this.S.svc[null!=(c=e.svc)?c:e.service].mail:null!=(h=null!=this&&null!=(p=this.S)?p.mail:void 0)?h:n.mail,null==e.from&&(e.from=s.from),null==e.to&&(e.to=s.to),delete e.svc,x="https://api.mailgun.net/v3/"+s.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),t=null!=(d=null!=this?this.fetch:void 0)?d:r.fetch,i=await this.form(e),await t(x,{method:"POST",form:i,auth:"api:"+s.apikey})},r.mail.validate=async function(e,t){var i,s,a,l;if(null==t&&(t=null!=(s=n.mail)?s.pubkey:void 0),null==e&&(e=null!=this&&null!=(a=this.params)?a.email:void 0),"string"==typeof e&&"string"==typeof t)return i=null!=(l=null!=this?this.fetch:void 0)?l:r.fetch,await i("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)},null==n.mail&&(n.mail={}),null==(p=n.mail).from&&(p.from="alert@cottagelabs.com"),null==(c=n.mail).to&&(c.to="mark@cottagelabs.com"),null==(u=n.src).google&&(u.google={});try{n.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}o=[].indexOf;r.tdm={},r.tdm.occurrence=function(e,t,i){var r,n,s,a,l,o,u,c,h,p;if(null==e&&(e=null!=(s=null!=this&&null!=(a=this.params)?a.content:void 0)?s:null!=this&&null!=(l=this.params)?l.url:void 0),0===e.indexOf("http")&&(e=this.fetch(e)),null==t&&(t=null!=(o=null!=this&&null!=(u=this.params)?u.sub:void 0)?o:null!=this&&null!=(c=this.params)?c.q:void 0),null==i&&(i=null!=this&&null!=(h=this.params)?h.overlap:void 0),e+="",(t+="").length<=0)return e.length+1;for(r=0,n=0,p=i?1:t.length;(n=e.indexOf(t,n))>=0;)++r,n+=p;return r},r.tdm.levenshtein=function(e,t,i){var r,n,s,a,l,o,u,c,h,p,d,f,m;for(null==e&&(e=null!=this&&null!=(p=this.params)?p.a:void 0),null==t&&(t=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(l=e.length)<(u=t.length)&&(r=e,e=t,t=r,c=l,l=u,u=c),h=[[]],r=0;r<u+1;)h[0][r]=r,r++;for(s=1;s<l+1;){for(h[s]=[s],a=1;a<u+1;)n=e.charAt(s-1)===t.charAt(a-1)?0:1,h[s][a]=o(h[s-1][a]+1,h[s][a-1]+1,h[s-1][a-1]+n),a++;s++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:l,b:u}}},r.tdm.hamming=function(e,t,i){var r,n,s,a,l,o,u,c,h,p,d,f,m,y;if(null==e&&(e=null!=this&&null!=(c=this.params)?c.a:void 0),null==t&&(t=null!=this&&null!=(h=this.params)?h.b:void 0),null==i&&(i=null==(p=null!=this&&null!=(d=this.params)?d.lowercase:void 0)||p),i&&(e=e.toLowerCase(),t=t.toLowerCase()),e.length<t.length?(f=e,a=t):(f=t,a=e),u=a.indexOf(f),y=f.split(""),(m=a.split("")).length>y.length){if(n=m.length-y.length,0<u)for(o=0;o<u;)y.unshift(""),o++,n--;for(r=0;r<n;)y.push(""),r++}for(s in l=0,m)y[s]!==m[s]&&l++;return l},r.tdm.extract=function(e){var t,i,n,s,a,l,o,u,c,h,p,d;e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=r.http.puppeteer(e.url,!0));try{d=e.convert?r.convert.run(null!=(c=e.url)?c:e.content,e.convert,"txt"):e.content}catch(t){d=e.content}if(null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(u=d.split(e.start),d=u.length>1?u[1]:u[0]),null!=e.end&&(d=d.split(e.end)[0]),e.lowercase&&(d=d.toLowerCase()),e.ascii&&(d=d.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(d=d.replace(/ /g,"")),p={length:d.length,matched:0,matches:[],matchers:e.matchers,text:d},d&&"number"!=typeof d)for(t=0,n=(h=e.matchers).length;t<n;t++)for(a=h[t],l="g",e.lowercase&&(l+="i"),0===a.indexOf("/")?(i=a.lastIndexOf("/"))+1!==a.length&&(l=a.substring(i+1),a=a.substring(1,i)):a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),o=new RegExp(a,l);s=o.exec(d);)p.matched+=1,p.matches.push({matched:a,result:s});return p},r.tdm.emails=function(e={}){var t,i,n,s,a,l,u,c,h,p,d,f,m;for(e.matchers=["/([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"],i=[],t=[],n=0,s=(c=r.tdm.extract(e).matches).length;n<s;n++)for(l=0,a=(h=c[n].result).length;l<a;l++)u=h[l],o.call(t,u)<0&&("function"!=typeof(null!=(null!=(p=r.mail)?p.validate:void 0))||r.mail.validate(u,null!=(d=r.settings.service)&&null!=(f=d.openaccessbutton)&&null!=(m=f.mail)?m.pubkey:void 0).is_valid)&&i.push(u),t.push(u);return i},r.tdm.stopwords=function(e,t,i=!0){var r,n,s,a,l,u;if(null==e&&(e=["purl","w3","http","https","ref","html","www","ref","cite","url","title","date","nbsp","doi","fig","figure","supplemental","year","time","january","february","march","april","may","june","july","august","september","october","november","december","jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec","keywords","revised","accepted","file","attribution","org","com","id","wp","main","website","blogs","media","people","years","made","location","its","asterisk","called","xp","er","image","jpeg","jpg","png","php","object","false","true","article","chapter","book","caps","isbn","scale","axis","accessed","email","e-mail","story","first1","first2","last1","last2","general","list","accessdate","view_news","d0","dq","sfnref","onepage","sfn","authorlink"]),i=["apos","as","able","about","above","according","accordingly","across","actually","after","afterwards","again","against","aint","all","allow","allows","almost","alone","along","already","also","although","always","am","among","amongst","an","and","another","any","anybody","anyhow","anyone","anything","anyway","anyways","anywhere","apart","appear","appreciate","appropriate","are","arent","around","as","aside","ask","asking","associated","at","available","away","awfully","be","became","because","become","becomes","becoming","been","before","beforehand","behind","being","believe","below","beside","besides","best","better","between","beyond","both","brief","but","by","cmon","cs","came","can","cant","cannot","cant","cause","causes","certain","certainly","changes","clearly","co","com","come","comes","concerning","consequently","consider","considering","contain","containing","contains","corresponding","could","couldnt","course","currently","definitely","described","despite","did","didnt","different","do","does","doesnt","doing","dont","done","down","downwards","during","each","edu","eg","eight","either","else","elsewhere","enough","entirely","especially","et","etc","even","ever","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","far","few","fifth","first","five","followed","following","follows","for","former","formerly","forth","four","from","further","furthermore","get","gets","getting","given","gives","go","goes","going","gone","got","gotten","greetings","had","hadnt","happens","hardly","has","hasnt","have","havent","having","he","hes","hello","help","hence","her","here","heres","hereafter","hereby","herein","hereupon","hers","herself","hi","him","himself","his","hither","hopefully","how","howbeit","however","i","I","id","ill","im","ive","ie","if","ignored","immediate","in","inasmuch","inc","indeed","indicate","indicated","indicates","inner","insofar","instead","into","inward","is","isnt","it","itd","itll","its","itself","just","keep","keeps","kept","know","knows","known","last","lately","later","latter","latterly","least","less","lest","let","lets","like","liked","likely","little","look","looking","looks","ltd","mainly","many","may","maybe","me","mean","meanwhile","merely","might","more","moreover","most","mostly","much","must","my","myself","name","namely","nd","near","nearly","necessary","need","needs","neither","never","nevertheless","new","next","nine","no","nobody","non","none","noone","nor","normally","not","nothing","now","nowhere","obviously","of","off","often","oh","ok","okay","old","on","once","one","ones","only","onto","or","other","others","otherwise","ought","our","ours","ourselves","out","outside","over","overall","own","particular","particularly","per","perhaps","placed","please","plus","possible","presumably","probably","provides","que","quite","qv","rather","rd","re","really","reasonably","regarding","regardless","regards","relatively","respectively","right","said","same","saw","say","saying","says","second","secondly","see","seeing","seem","seemed","seeming","seems","seen","self","selves","sensible","sent","serious","seriously","seven","several","shall","she","should","shouldnt","since","six","so","some","somebody","somehow","someone","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specified","specify","specifying","still","sub","such","sup","sure","ts","take","taken","tell","tends","th","than","thank","thanks","thanx","that","thats","thats","the","their","theirs","them","themselves","then","thence","there","theres","thereafter","thereby","therefore","therein","theres","thereupon","these","they","theyd","theyll","theyre","theyve","think","third","this","thorough","thoroughly","those","though","three","through","throughout","thru","thus","to","together","too","took","toward","towards","tried","tries","truly","try","trying","twice","two","un","under","unfortunately","unless","unlikely","until","unto","up","upon","us","use","used","useful","uses","using","usually","value","various","very","via","viz","vs","want","wants","was","wasnt","way","we","wed","well","weve","welcome","well","went","were","werent","what","whats","whatever","when","whence","whenever","where","wheres","whereafter","whereas","whereby","wherein","whereupon","wherever","whether","which","while","whither","who","whos","whoever","whole","whom","whose","why","will","willing","wish","with","within","without","wont","wonder","would","would","wouldnt","yes","yet","you","youd","youll","youre","youve","your","yours","yourself","yourselves","zero"])for(n=0,s=i.length;n<s;n++)r=i[n],o.call(e,r)<0&&e.push(r);if(t)for("string"==typeof t&&(t=t.split(",")),u=0,a=t.length;u<a;u++)l=t[u],o.call(e,l)<0&&e.push(l);return e};o=[].indexOf;r.uid=function(e){var t,i,r,n,s,a,o,u,c,h,p;return null==e&&(e="uid"===this.fn&&null!=(t=null!=(i=null!=(r=null!=(n=null!=this&&null!=(s=this.params)?s.len:void 0)?n:null!=this&&null!=(a=this.params)?a.length:void 0)?r:null!=this&&null!=(o=this.params)?o.size:void 0)?i:null!=this&&null!=(u=this.params)?u.uid:void 0)?t:21),"string"==typeof e&&(p=parseInt(e),e=isNaN(p)?void 0:p),Object(l.a)(null!=(c=null!=this&&null!=(h=this.params)?h.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",e)()},r.uid._cache=!1,r.hash=async function(e){var t,i,r,n,s,a,l,o,u,c;try{null==e&&(e=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.body)?o:this.params.q)?l:this.params)}catch(e){}try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(r),a=[],n=0,s=t.length;n<s;n++)i=t[n],a.push(("00"+i.toString(16)).slice(-2));return a.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},r.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise(t=>setTimeout(t,null!=e?e:1e3))},r._timeout=function(e,t){return new Promise((t,i)=>{var r;return r=setTimeout(()=>i(new Error("TIMEOUT")),e),promise.then(value(()=>(clearTimeout(r),t(value)))).catch(reason(()=>(clearTimeout(r),i(reason))))})},r.form=function(e){var t,i,r,n,s,a;for(r in null==e&&(e=this.params),n="",e)for(""!==n&&(n+="&"),t=0,i=(a=Array.isArray(e[r])?e[r]:[e[r]]).length;t<i;t++)null!=(s=a[t])&&(n.endsWith("&")||(n+="&"),n+=r+"="+encodeURIComponent("object"==typeof s?JSON.stringify(s):s));return n},r.decode=async function(e){var t,i,r,n,s,a,l,o,u,c;for(null==e&&(e=null!=(a=null!=(l=null!=(o=this.params.decode)?o:this.params.content)?l:this.params.text)?a:this.body),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(\d+);/gi,(function(e,t){var i;return i=parseInt(t,10),String.fromCharCode(i)}))},c=(c=await t(e)).replace(/\n/g," "),r=0,n=(u=[{bad:"",good:"'"},{bad:"",good:"'"},{bad:"",good:"'"},{bad:"",good:'"'},{bad:"",good:'"'},{bad:"",good:"-"},{bad:"-",good:"-"}]).length;r<n;r++)i=u[r],s=new RegExp(i.bad,"g"),c=c.replace(s,i.good);return-1!==c.indexOf("%2")&&(c=decodeURIComponent(c)),-1!==c.indexOf("%2")&&(c=decodeURIComponent(c)),c},r.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},r.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&o.call(i,t)<0&&i.push(t);return i},r.dot=function(e,t){var i,r,n,s,a;"string"==typeof e&&"object"==typeof t&&(a=e,e=t,t=a),null==e&&null!=(null!=this&&null!=(n=this.params)?n.key:void 0)&&(t=(e=this.copy(this.params)).key),"string"==typeof t&&(t=t.split("."));try{for(s=e,i=0,r=t.length;i<r;i++)s=s[t[i]];return s}catch(e){return}},r.flatten=async function(e){var t,i,r,n,s,a;if(null==e&&(e=this.params),s={},t=async function(e,i){var r,n,a,l,o;for(r in l=[],e)a=i?i+"."+r:r,"string"==typeof(o=e[r])?l.push(s[a]=o):Array.isArray(o)?"object"==typeof o[0]?l.push(await async function(){var e;for(n in e=[],o)e.push(await t(o[n],a+"."+n));return e}()):l.push(s[a]=o.join(", ")):l.push(await t(o,a));return l},Array.isArray(e)){for(a=[],r=0,n=data.length;r<n;r++)i=data[r],s={},a.push(await t(i));return a}return await t(e),s},r.template=async function(e,t){var i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w;if(null==e&&(e=null!=(m=null!=(y=this.params.content)?y:this.params.template)?m:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(g=this.params.url)?g:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{r=await this._templates(e),e=r.content}catch(e){}if(b={},(i=function(t,r=""){var n,s,a,l;for(n in a=[],t)s=r?r+"."+n:n,"object"!=typeof t[n]||Array.isArray(t[n])?-1!==e.toLowerCase().indexOf("{{"+s+"}}")?(l=new RegExp("{{"+s+"}}","gi"),a.push(e=e.replace(l,Array.isArray(t[n])?t[n].join(", "):"string"==typeof t[n]?t[n]:!0===t[n]?"Yes":!1===t[n]?"No":""))):a.push(void 0):a.push(i(t[n],r+(""===r?"":".")+n));return a})(t),c=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(w=["subject","from","to","cc","bcc"],n=0,p=(v=e.toLowerCase().split("{{")).length;n<p;n++)f=v[n].split("{{")[0].split("}}")[0].split(" ")[0],o.call(w,f)<0&&w.push(f);for(s=0,d=w.length;s<d;s++)a=w[s],(l=-1!==e.toLowerCase().indexOf("{{"+a)?a:void 0)&&(u=-1!==e.indexOf("{{"+l.toUpperCase())?l.toUpperCase():l,(_=e.split("{{"+u)[1]).split("}}")[0].indexOf("{{")&&(_=_.replace(c,"")),(_=_.split("}}")[0].trim())&&(b[l]=_),h=new RegExp("{{"+u+".*?}}","gi"),e=e.replace(h,""))}return-1!==e.indexOf("{{")&&(e=e.replace(c,"")),b.content=e,b},r._templates={_index:!0},r.date=function(e){var t,i,r;null==e&&(e=this.params.date);try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(t in e)"number"!=(r=typeof e[t])&&"string"!==r&&(e[t]="01");e=e.join("-")}catch(e){}return-1!==(e=decodeURIComponent(e)).indexOf("T")&&(e=e.split("T")[0]),-1===(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).indexOf("-")&&(e+="-01"),3!==(i=e.split("-")).length&&(i=(e+="-01").split("-")),3!==i.length&&(e=void 0),i[0].length<i[2].length&&(e=i.reverse().join("-")),e}catch(e){return}},r._cache=async function(e,t,i){var r,n,s,a,l,o,u,c,h,p;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:3600),!1!==this.S.cache&&!0!==this.S.bg){try{null==e&&(e=this.request);try{for(p=e.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)s=u[l],-1!==p.indexOf(s+"=")&&(a=new RegExp(s+"=.*?&"),p=p.replace(a,"")),-1!==p.indexOf("&"+s+"=")&&(p=p.split("&"+s+"=")[0]);n=new URL(p)}catch(e){}}catch(e){}if(null!=e)try{return null==n&&(n=new URL(e.url)),r=new Request(n.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t?(h=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),h):(t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,c)))}catch(e){return}}};var c;o=[].indexOf;null==n.index&&(n.index={}),null==(p=n.index).name&&(p.name=null!=(h=n.name)?h:"Paradigm"),"string"!=typeof n.index.name&&(n.index.name=""),n.index.name=n.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof n.bg&&null==(c=n.index).url&&(c.url=n.bg+"/index"),r.index=async function(e,t,i){var n,s,a,l,o,u,c,h,p,d,f,m,y;if("object"==typeof e&&(t=e,e=void 0),null==e&&null==t&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(c=this.parts[1])||"src"===c))return{status:403};if(delete(t="object"==typeof this.body?this.copy(this.body):"string"==typeof this.body?this.body:this.copy(this.params)).route,delete t.index,delete t[this.fn.split(".").pop()],delete t._id,null!=t.script||-1!==JSON.stringify(t).toLowerCase().indexOf("<script"))return}if("object"!=typeof t||Array.isArray(t)||(null==e&&(e=null!=(h=t.route)?h:t.index),delete t.route,delete t.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length)return await this.index._indices();2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e){if(e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof t&&!Array.isArray(t)&&t._id&&(a=t._id.replace(/\//g,"_"),-1===e.indexOf("/")&&-1===e.indexOf(a)&&(e+="/"+t._id),delete t._id),y=(e=e.toLowerCase()).split("/").length,s=null!=(null!=this?this.index:void 0)?this.index:r.index,(null==(null!=this?this.parts:void 0)||"index"!==this.parts[0]||"DELETE"!==this.request.method&&!this.params._delete)&&""!==t){if(1===y){if("string"==typeof t&&(""===t||-1!==t.indexOf("\n"))||Array.isArray(t))return""===t?s._submit(e,t):s._bulk(e,t);if("object"==typeof t){if(s._q(t))return s._submit(e+"/_search",await s.translate(t,i));for(n=null!=(null!=this?this.copy:void 0)?this.copy(t):r.copy(t),o=0,u=(p=["settings","aliases","mappings"]).length;o<u;o++)delete n[p[o]];return"{}"===JSON.stringify(n)?(await s._submit(e)||(l=s._q(t)?{}:{settings:t.settings,aliases:t.aliases,mappings:t.mappings},await s._submit(e,l)),s._submit(e+"/_search")):s._submit(e+"/_doc",t)}return s._submit(e+"/_search")}return 2!==y||null!=t&&("object"!=typeof t||Array.isArray(t))?void 0:null!=t&&"{}"!==JSON.stringify(t)?(e=""===t?e:null!=t.script?e+"/_update?retry_on_conflict=2":e.replace("/","/_doc/"),s._submit(e,t)):("object"==typeof(f=await s._submit(e.replace("/","/_doc/")))&&(f._source||f.fields)&&(null==(m=null!=(d=f._source)?d:f.fields)._id&&(m._id=f._id),f=m),f)}f=await s._submit(e.replace("/","/_doc/"),"")}},r.index._submit=async function(e,t,i,s=!0){var a,l,o,u,c,h,p;if(0===(e=e.toLowerCase()).indexOf("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,"")),null==i&&(i="_pit"===e||""===t?"DELETE":null==t||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=t||"_refresh"===(l=e.split("/").pop().split("?")[0])||"_pit"===l||"_aliases"===l?"POST":"GET":"PUT"),"DELETE"===i&&(!0!==s||-1!==e.indexOf("/_all")))return!1;if(!e.startsWith("http")){if(!this.S.index.name||e.startsWith(this.S.index.name)||e.startsWith("_")||!1!==await this.dot(r,e.split("/")[0].replace(/_/g,".")+"._prefix")&&(e=this.S.index.name+"_"+e),p=(null!=this&&null!=(o=this.S)&&null!=(u=o.index)?u.url:void 0)?this.S.index.url:null!=(c=n.index)?c.url:void 0,Array.isArray(p)&&(p=p[Math.floor(Math.random()*p.length)]),"string"!=typeof p)return;e=p+"/"+e}if(e.startsWith("http")){if(a=-1!==e.indexOf("/_bulk")||"object"==typeof(null!=t?t.headers:void 0)?t:{body:t},-1!==e.indexOf("/_search")&&(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),this.S.dev&&(console.log("INDEX "+e),console.log(i+" "+(null==t?"":JSON.stringify(Array.isArray(t)&&t.length?t[0]:t).substr(0,1e3)))),a.method=i,h=await this.fetch(e,a),this.S.dev)try{console.log("INDEX QUERY FOUND",h.hits.total,h.hits.hits.length)}catch(e){}if(!(null==h||"object"==typeof h&&"number"==typeof h.status&&h.status>=400&&h.status<=600)){try{this.S.dev&&null!=(null!=t?t.query:void 0)&&(h.q=t)}catch(e){}return h}}else console.log("NO INDEX URL AVAILABLE")},r.index._mapping=async function(e){return"string"==typeof e&&(-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),await this.index._submit(e))},r.index.keys=async function(e){var t,i;try{null==e&&(e=this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys","")}catch(e){}return i=[],t=async(r,n="")=>{var s,a,l,u,c,h;if(null==r&&(r="object"==typeof e?e:await this.index._mapping(e)),r.properties=null!=(a=null!=(l=r[e])&&null!=(u=l.mappings)?u.properties:void 0)?a:r.properties,null!=r.properties){for(s in n.length&&(n+="."),h=[],r.properties)c=n+s,o.call(i,c)<0&&i.push(n+s),null!=r.properties[s].properties?h.push(await t(r.properties[s],n+s)):h.push(void 0);return h}},await t(),i},r.index.terms=async function(e,t,i,r=1e3,n=!0,s="count"){var a,l,o,u,c,h,p,d,f,m;try{null==e&&(e=this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),cp(this.copy(this.params)),delete cp.index,null!=cp.size&&(r=cp.size,delete cp.size),null!=cp.counts&&(n=cp.counts,delete cp.counts),null!=cp.order&&(s=cp.order,delete cp.order),null==i&&this.index._q(cp)&&(i=await this.index.translate(cp))}catch(e){}if(!t)return[];for(u="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&u.query.bool.must.push({query_string:{query:i}}),null==u.aggregations&&(u.aggregations={}),"count"===s?s={_count:"desc"}:"reverse_count"===s?s={_count:"asc"}:"term"===s?s={_key:"asc"}:"reverse_term"===s&&(s={_key:"desc"}),u.aggregations[t]={terms:{field:t+(-1===t.indexOf(".keyword")?".keyword":""),size:r,order:s}},f=[],a=0,l=(d=null!=(c=null!=(m=await this.index._submit("/"+e+"/_search",u,"POST"))&&null!=(h=m.aggregations)&&null!=(p=h[t])?p.buckets:void 0)?c:[]).length;a<l;a++)o=d[a],f.push(n?{term:o.key,count:o.doc_count}:o.key);return f},r.index.suggest=async function(e,t,i,r=100,n=!1,s="term"){var a,l,o,u,c,h,p,d,f;for(e.endsWith("suggest")||([e,h]=e.split("/suggest/"),null==t&&(t=e.split("/").pop()),e=e.replace("/"+t,""),h&&null==i&&(i=t+":"+h+"*")),f=[],a=0,u=(p=await this.index.terms(e,t,i,r,n,s)).length;a<u;a++)l=p[a],h&&0!==l.toLowerCase().indexOf(h.toLowerCase())||f.push(l);if(0===f.length&&h&&"string"==typeof i)for(i=i.replace(":",":*"),o=0,c=(d=await this.index.terms(e,t,i,r,n,s)).length;o<c;o++)l=d[o],h&&-1===l.toLowerCase().indexOf(h.toLowerCase())||f.push(l);return f},r.index.count=async function(e,t,i){var r,n,s,a,l,o,u,c,h,p,d;try{null==e&&(e=null!=(a=null!=(l=this.params.index)?l:this.params.route)?a:this.fn.replace(/\./g,"_"))}catch(e){}-1!==e.indexOf("/")&&([e,t]=e.split("/"));try{null==t&&(t=null!=(o=this.params.count)?o:this.params.key)}catch(e){}try{for(r=this.copy(this.params),n=0,s=(u=["index","route","count","key"]).length;n<s;n++)delete r[u[n]];null==i&&this.index._q(r)&&(i=await this.index.translate(r))}catch(e){}return null==i&&(i={query:{bool:{must:[],filter:[]}}}),t?(-1===t.indexOf(".keyword")&&(t+=".keyword"),i.size=0,i.aggs={keyed:{cardinality:{field:t,precision_threshold:4e4}}},null!=(d=await this.index._submit("/"+e+"/_search",i,"POST"))&&null!=(c=d.aggregations)&&null!=(h=c.keyed)?h.value:void 0):null!=(d=await this.index._submit("/"+e+"/_search",i,"POST"))&&null!=(p=d.hits)?p.total:void 0},r.index.min=async function(e,t,i){var r;try{null==e&&(e=this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/min",""),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),delete this.params.index,this.index._q(this.params)&&null==i&&(i=await this.index.translate(this.params))}catch(e){}return(r="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,r.aggs={min:{min:{field:t}}},(await this.index._submit("/"+e+"/_search",r,"POST")).aggregations.min.value},r.index.max=async function(e,t,i){var r;try{null==e&&(e=this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/max",""),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),delete this.params.index,this.index._q(this.params)&&null==i&&(i=await this.index.translate(this.params))}catch(e){}return(r="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,r.aggs={max:{max:{field:t}}},(await this.index._submit("/"+e+"/_search",r,"POST")).aggregations.max.value},r.index.range=async function(e,t,i){var r,n;try{null==e&&(e=this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/range",""),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),delete this.params.index,this.index._q(this.params)&&null==i&&(i=await this.index.translate(this.params))}catch(e){}return(r="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,r.aggs={min:{min:{field:t}},max:{max:{field:t}}},{min:(n=await this.index._submit("/"+e+"/_search",r,"POST")).aggregations.min.value,max:n.aggregations.max.value}},r.index._each=async function(e,t,i,r){var n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b;for(void 0===r&&void 0===i&&"function"==typeof t&&(r=t,t="*"),void 0===r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),null!=i.keep_alive?(o=i.keep_alive,delete i.keep_alive):o="5m",i.action?(n=i.action,delete i.action):n=!1,(p=await this.index.translate(t,i)).from=0,null==p.size&&(p.size=1e3),c=await this.index(e+"/_pit?keep_alive="+o).id,p.pit={id:c,keep_alive:o},null==p.sort&&(p.sort=[{createdAt:"asc"}]),h=0,b=[],v=!1;null!=(null!=g&&null!=(y=g.hits)?y.hits:void 0)&&(!1===v||h<v);){for(g=await this.index(e,p),!1===v&&(v=g.hits.total),l=0,u=(d=g.hits.hits).length;l<u;l++)a=d[l],h+=1,null==(s=(r=r.bind(this))(null!=(f=null!=(m=a._source)?m:a.fields)?f:{_id:a._id}))||"object"!=typeof s&&"string"!=typeof s||b.push(s),p.search_after=a.sort;p.pit.id=g.pit_id}return n&&b.length&&this.index._bulk(e,b,n),this.index._submit("/_pit",{id:c})},r.index._bulk=async function(e,t,i="index",n=5e4){var s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w;if(!1!==await this.dot(r,e.split("/")[0].replace(/_/g,".")+"._prefix")&&(e=this.S.index.name+"_"+e),s=null!=(null!=this?this.index:void 0)?this.index:r.index,"string"==typeof t&&-1!==t.indexOf("\n"))return await s._submit("/_bulk",{body:t,headers:{"Content-Type":"application/x-ndjson"}}),!0;for(f in _="object"!=typeof t||Array.isArray(t)||null==(null!=t&&null!=(m=t.hits)?m.hits:void 0)?t:t.hits.hits,Array.isArray(_)||(_=[_]),a=0,d="",_)if(a+=1,v=void 0,"object"==typeof(b=_[f])&&(null!=b._source&&(b=b._source),b._id?(v=b._id,delete b._id):v=null!=(null!=this?this.uid:void 0)?this.uid():r.uid()),(p={})[i]={_index:e},p[i]._id="delete"===i&&"string"==typeof b?b:v,d+=JSON.stringify(p)+"\n","create"===i||"index"===i?d+=JSON.stringify(b)+"\n":"update"===i&&(d+=JSON.stringify({doc:b})+"\n"),a===n||parseInt(f)===_.length-1||d.length>7e7){if(w=await s._submit("/_bulk",{body:d,headers:{"Content-Type":"application/x-ndjson"}}),(null!=this&&null!=(y=this.S)?y.dev:void 0)&&(null!=w?w.errors:void 0)){for(l=[],u=0,h=(g=w.items).length;u<h;u++)for(c in o=g[u])o[c].status>=300&&l.push(o);console.log("Bulk load errors: "+l.length+", like: "+JSON.stringify(l[0]))}d="",a=0}return _.length},r.index._indices=async function(e=!1){var t,i,r,n,s,a,l,u;for(i in s=e?{}:[],a=await this.index._submit("_stats"),u=e?await this.index._submit("_cat/shards?format=json"):[],a.indices)if(o.call([],i)<0&&!i.startsWith(".")&&!i.startsWith("security-"))if(e)for(s[i]={docs:a.indices[i].primaries.docs.count,size:Math.ceil(a.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},r=0,n=u.length;r<n;r++)(l=u[r]).index===i&&"p"===l.prirep&&(null==(t=s[i]).shards&&(t.shards=0),s[i].shards+=1);else s.push(i);return s},r.index.status=async function(){var e,t,i,r,n,s;(s={status:"green"}).indices=await this.index._indices(!0);try{for("green"!==(r=s.cluster.status)&&"yellow"!==r&&(s.status="red"),e=0,i=(n=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;e<i;e++)t=n[e],delete s.cluster[t]}catch(e){}return s},r.index.status._cache=!1,r.index._q=function(e,t){var i,r,n,s,a,l,o;if("object"!=typeof e||Array.isArray(e)){if("string"==typeof e&&e.length&&-1===e.indexOf("\n")){if("string"==typeof t&&e.toLowerCase().startsWith(t.toLowerCase()))return!1;if(e.startsWith("?")||e.startsWith("q="))return!0;if(e.length<8||(-1!==e.indexOf("/")?e.split("/").pop():e).length>34)return!0;for(n=0,a=(o=[" ",":","*","~","(",")","?"]).length;n<a;n++)if(i=o[n],-1!==e.indexOf(i))return!0}}else{for(r=0,s=(l=["settings","aliases","mappings","index"]).length;r<s;r++)if(e[l[r]])return!1;if(null!=e.q||null!=e.query)return!0}return!1},r.index.translate=function(e,t={}){var i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G,H,K,Q,Z,ee,te,ie,re,ne,se,ae,le,oe,ue,ce,he,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke;null==e&&(e=null!=this?this.params:void 0);try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if("random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null==(G=null!=(H=null!=t?t.query:void 0)?H:{}).query&&(G.query={}),G=(i=function(e){var t,i,r;return null==e.query&&(e.query={bool:{must:[],filter:[]}}),null==e.query.bool&&(r=[],"{}"!==JSON.stringify(e.query)&&r.push(e.query),e.query={bool:{must:r,filter:[]}}),null==(t=e.query.bool).must&&(t.must=[]),null==(i=e.query.bool).filter&&(i.filter=[]),e})(G),"object"==typeof e){for(_=0,S=(se=["apikey","_","callback","refresh","key","counts","index"]).length;_<S;_++)delete e[se[_]];for(k=0,j=(ae=["random","seed"]).length;k<j;k++)t[W=ae[k]]=e[W],delete e[W];if(0===JSON.stringify(e).indexOf("["))for(null==(a=G.query.bool).should&&(a.should=[]),M=0,I=e.length;M<I;M++)if("object"==typeof(N=e[M])&&null!=N)for(x in N)"string"==typeof N[x]?((ve={term:{}}).term[x]=N[x],G.query.bool.should.push(ve)):"number"==(le=typeof N[x])||"boolean"===le?G.query.bool.should.push({query_string:{query:x+":"+N[x]}}):null!=N[x]&&G.query.bool.should.push(N[x]);else"string"==typeof N&&G.query.bool.should.push({query_string:{query:N}});else if(null!=e.query)G=e;else if(null!=e.source)for(B in"string"==typeof e.source&&(G=JSON.parse(e.source)),"object"==typeof e.source&&(G=e.source),null==t&&(t={}),e)"source"!==B&&null==t[B]&&(t[B]=e[B]);else if(null!=e.q)for(B in null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(Y={})[($=e.q.split(":"))[0]]=$[1],G.query.bool.must.push({prefix:Y})):G.query.bool.must.push({query_string:{query:decodeURIComponent(e.q)}}),null==t&&(t={}),e)"q"!==B&&null==t[B]&&(t[B]=e[B]);else{for(me=0,P=(oe=["must","must_not","filter","should"]).length;me<P;me++)null!=e[h=oe[me]]&&(G.query.bool[h]=e[h]);for(Oe in e)"fields"===Oe||"sort"===Oe&&"string"==typeof e[Oe]&&-1!==e[Oe].indexOf(":")||!("from"!==Oe&&"size"!==Oe||"number"!=typeof e[Oe]&&isNaN(parseInt(e[Oe])))?(null==t&&(t={}),t[Oe]=e[Oe]):"must"!==Oe&&"must_not"!==Oe&&"filter"!==Oe&&"should"!==Oe&&("string"==typeof e[Oe]?((ve={term:{}}).term[Oe]=e[Oe],G.query.bool.filter.push(ve)):"number"==(ue=typeof e[Oe])||"boolean"===ue?G.query.bool.filter.push({query_string:{query:Oe+":"+e[Oe]}}):"object"==typeof e[Oe]?((F={})[Oe]=e[Oe],G.query.bool.filter.push(F)):null!=e[Oe]&&G.query.bool.filter.push(e[Oe]))}}else"string"==typeof e&&(0===e.indexOf("?")?G=e:null!=e&&(""===e&&(e="*"),G.query.bool.must.push({query_string:{query:e}})));if(G=i(G),null!=t){if(!0===t.newest?(delete t.newest,t.sort={createdAt:{order:"desc"}}):!1===t.newest&&(delete t.newest,t.sort={createdAt:{order:"asc"}}),delete t._,delete t.apikey,t.fields&&"string"==typeof t.fields&&-1!==t.fields.indexOf(",")&&(t.fields=t.fields.split(",")),t.random&&(m={function_score:{random_score:{}}},null!=t.seed&&(m.function_score.random_score.seed=seed),m.function_score.query=G.query,G.query=m,delete t.random,delete t.seed),(null!=t._include||null!=t.include||null!=t._includes||null!=t.includes||null!=t._exclude||null!=t.exclude||null!=t._excludes||null!=t.excludes)&&(null==G._source&&(G._source={}),null!=(b=t[v=null!=t._include?"_include":null!=t.include?"include":null!=t._includes?"_includes":"includes"])&&("string"==typeof b&&(b=b.split(",")),G._source.includes=b,delete t[v]),null!=(d=t[p=null!=t._exclude?"_exclude":null!=t.exclude?"exclude":null!=t._excludes?"_excludes":"excludes"]))){for("string"==typeof d&&(d=d.split(",")),be=0,q=(ce=null!=b?b:[]).length;be<q;be++)y=ce[be],o.call(d,y)>=0&&delete d[y];G._source.excludes=d,delete t[p]}if(null!=t.and){for(we=0,L=(he=t.and).length;we<L;we++)r=he[we],G.query.bool.filter.push(r);delete t.and}if(null!=t.sort){if("string"==typeof t.sort&&-1!==t.sort.indexOf(","))if(-1!==t.sort.indexOf(":")){for(X=[],xe=0,R=(pe=t.sort.split(",")).length;xe<R;xe++)(z={})[(V=pe[xe]).split(":")[0]]={order:V.split(":")[1]},X.push(z);t.sort=X}else t.sort=t.sort.split(",");"string"==typeof t.sort&&-1!==t.sort.indexOf(":")&&((X={})[t.sort.split(":")[0]]={order:t.sort.split(":")[1]},t.sort=X)}if(null!=t.restrict||null!=t.filter){for(ke=0,T=(Q=null!=(K=t.restrict)?K:t.filter).length;ke<T;ke++)de=Q[ke],G.query.bool.filter.push(de);delete t.restrict}if(null!=t.not||null!=t.must_not){if(ye=null!=t.not?"not":"must_not",Array.isArray(t[ye]))G.query.bool.must_not=t[ye];else for(null==(l=G.query.bool).must_not&&(l.must_not=[]),g=0,U=(Z=t[ye]).length;g<U;g++)J=Z[g],G.query.bool.must_not.push(J);delete t[ye]}if(null!=t.should){if(Array.isArray(t.should))G.query.bool.should=t.should;else for(null==(u=G.query.bool).should&&(u.should=[]),w=0,D=(ee=t.should).length;w<D;w++)fe=ee[w],G.query.bool.should.push(fe);delete t.should}if(null!=t.all&&(G.size=1e6,delete t.all),null!=t.terms){try{t.terms=t.terms.split(",")}catch(e){}for(null==G.aggregations&&(G.aggregations={}),O=0,C=(te=t.terms).length;O<C;O++)ge=te[O],G.aggregations[ge]={terms:{field:ge+(-1===ge.indexOf(".keyword")?".keyword":""),size:1e3}};delete t.terms}for(A=0,E=(ie=["aggs","aggregations"]).length;A<E;A++)if(null!=t[n=ie[A]]){for(f in null==G[n]&&(G[n]={}),t[n])G[n][f]=t[n][f];delete t[n]}for(x in t)_e=t[x],G[x]=_e}if(null!=(null!=(re=G.query)?re.bool:void 0))for(c in G.query.bool)for(s in G.query.bool[c])"string"==typeof(null!=(ne=G.query.bool[c][s].query_string)?ne.query:void 0)&&-1!==G.query.bool[c][s].query_string.query.indexOf("/")&&-1===G.query.bool[c][s].query_string.query.indexOf('"')&&(G.query.bool[c][s].query_string.query='"'+G.query.bool[c][s].query_string.query+'"');return null!=G._source&&null!=G.fields&&delete G._source,G},r.kv=async function(t,i,r,n,s){var a,l,o,u,c,h,p,d,f,m,y,g,v,b;if(null==t&&(t=null!=(p=null!=(d=this.params.kv)?d:this.params.key)?p:this.parts.join("_"),null==i)){if("DELETE"===this.request.method||this.params._delete)i="";else if(null!=this.body)i=this.body;else if(this.params.val)i=this.params.val;else{for(i=this.params,a=0,u=(f=["key","kv","refresh","apikey"]).length;a<u;a++)delete i[o=f[a]];for(l=0,c=(m=this.parts).length;l<c;l++)delete i[o=m[l]]}"string"!=typeof i||0!==i.indexOf("[")&&0!==i.indexOf("{")||(i=JSON.parse(i)),"{}"!==(y=JSON.stringify(i))&&"[]"!==y||(i=void 0)}if("object"!=typeof i||"{}"!==(g=JSON.stringify(i))&&"[]"!==g||(i=""),"object"==typeof t&&null==i&&(t=null!=(v=(i=t)._id)?v:await this.uid()),null!=t&&this.S.kv&&e[this.S.kv]){if(null!=i&&""!==i){if(h={metadata:n},"number"==typeof r&&(1e3*r>Date.now()?h.expiration=r:h.expirationTtl=r),"object"==typeof i&&(!0===r&&(r=await this.kv(t)),"object"==typeof r))for(o in r)null==i[o]&&(i[o]=r[o]);return this.waitUntil(e[this.S.kv].put(t,"object"==typeof i?JSON.stringify(i):i,h)),i}({value:b,metadata:n}=await e[this.S.kv].getWithMetadata(t,s));try{b=JSON.parse(b)}catch(e){}try{n=JSON.parse(n)}catch(e){}return""===i&&this.waitUntil(e[this.S.kv].delete(t)),!0===n?{value:b,metadata:n}:b}},r.kv.list=async function(t,i){var r,n;try{null==t&&(t=null!=(r=null!=(n=this.params.kv)?n:this.params.prefix)?r:this.params.list)}catch(e){}try{null==i&&(i=this.params.cursor)}catch(e){}return await e[this.S.kv].list({prefix:t,cursor:i})},r.kv.count=async function(t){var i,r,n,s,a,l,o,u,c;if(r=0,this.S.kv&&null!=e[this.S.kv])for(null==t&&(t=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),i=!1;!i;){for(n=(l=await e[this.S.kv].list({prefix:t,cursor:n})).cursor,s=0,a=(c=l.keys).length;s<a;s++)c[s],r+=1;i=l.list_complete}return r},r.kv._each=async function(t,i,r){var n,s,a,l,o,u,c,h,p,d;if(p=[],this.S.kv&&null!=e[this.S.kv])for(n=!1,s=0;!n;){for(a=(c=await e[this.S.kv].list({prefix:t,cursor:a})).cursor,l=0,u=(h=c.keys).length;l<u;l++)o=h[l],s+=1,""===i?this.waitUntil(this.kv(o.name,"")):"function"==typeof i?p.push(await i.call(this,o.name)):null!=i?this.waitUntil(this.kv(o.name,i)):(d=await this.kv(o.name))&&(null==d._id&&(d._id=o.name),p.push(d));n=!(!r||s!==r)||c.list_complete}return p},r.src.base={},r.src.base.doi=async function(e){return await this.fetch("https://dev.api.cottagelabs.com/use/base/doi/"+e)},r.src.base.title=async function(e){var t,i;if(e=e.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036F]/g,"").replace(//g,"ss"),(null!=(null!=(i=await this.src.base.get('dctitle:"'+e+'"'))?i.dctitle:void 0)||null!=i.title)&&(null==i.title&&(i.title=i.dctitle),i.title&&(t=i.title.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036F]/g,"").replace(//g,"ss"))&&t.length<=1.2*e.length&&t.length>=.8*e.length&&-1!==e.replace(/ /g,"").indexOf(t.replace(" ","").replace(" ","").replace(" ","").split(" ")[0])))return i},r.src.base.get=async function(e){var t,i;return(null!=(i=await this.src.base.search(e))&&null!=(t=i.docs)?t.length:void 0)?i.docs[0]:void 0},r.src.base.search=async function(e="*",t,i){var r,n;-1===e.indexOf('"')&&-1!==e.indexOf(" ")&&(e=e.replace(/ /g,"+")),n="https://api.base-search.net/cgi-bin/BaseHttpSearchInterface.fcgi?func=PerformSearch&format=json&query="+e,t&&(n+="&offset="+t),i&&(n+="&hits="+i),n+="&sortBy=dcdate+desc";try{return r=await this.fetch(n),(r=JSON.parse(r).response).data=r.docs,delete r.docs,r.total=r.numFound,r}catch(e){}},r.src.core={},r.src.core.doi=function(e){return this.src.core.get('doi:"'+e+'"')},r.src.core.title=function(e){try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return this.src.core.get('title:"'+e+'"')},r.src.core.get=async function(e){var t,i,r,n,s,a;if(null!=(a=await this.src.core.search(e))?a.total:void 0)for(s=a.data[0],i=0,r=(n=a.data).length;i<r;i++)if("true"===(t=n[i]).hasFullText){s=t;break}return s},r.src.core.search=async function(e,t,i=10){var r,n,s,a;if(r=null!=(n=this.S.src.core)?n.apikey:void 0){a="http://core.ac.uk/api-v2/articles/search/"+e+"?urls=true&apiKey="+r,10!==i&&(a+="&pageSize="+i),t&&(a+="&page="+(Math.floor(t/i)+1));try{return{total:(s=await this.fetch(a)).data.totalHits,data:s.data.data}}catch(e){}}};var h,p;o=[].indexOf;n.name,null!=(h=n.mail)&&h.to,r.src.crossref={},r.src.crossref.journals=async function(e){var t,i,r,n;return null==e&&(e=null!=(i=this.params.journals)?i:this.params.issn),n="https://dev.api.cottagelabs.com/use/crossref/journals"+((t=this.index._q(e))?"?q="+e:"/"+e),r=await this.fetch(n),t||null!=(null!=r?r.ISSN:void 0)?r:void 0},r.src.crossref.journals.doi=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.fetch('https://dev.api.cottagelabs.com/use/crossref/works?q=ISSN.exact:"'+e.join('" OR ISSN.exact:"')+'"')).hits.hits[0]._source.DOI}catch(e){return}},r.src.crossref.works=async function(e){var t,i,r,n,s,a;if(null==e&&(e=null!=(i=null!=(r=this.params.works)?r:this.params.doi)?i:this.params.title||this.params.q),"string"==typeof e&&(0!==e.indexOf("10.")?s=await this.src.crossref.works.title(e):(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),a="https://dev.api.cottagelabs.com/use/crossref/works?doi="+e,s=await this.fetch(a))),null!=(null!=s?s.DOI:void 0)){("null"===(t=s).year||"string"==typeof t.published&&-1!==t.published.indexOf("null"))&&("null"===t.year&&delete t.year,delete t.published,delete t.publishedAt),delete t.relation,delete t.reference;try{"string"==typeof t.abstract&&null!=(null!=this&&null!=(n=this.convert)?n.html2txt:void 0)&&(t.abstract=this.convert.html2txt(t.abstract))}catch(e){}return t}},r.src.crossref.works._index={settings:{number_of_shards:9}},r.src.crossref.works._key="DOI",r.src.crossref.works._prefix=!1,r.src.crossref.works.title=async function(e){var t,i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v;if(null==e&&(e=null!=(u=this.params.title)?u:this.params.q),a='title:"'+e+'"',e.split(" ").length>2){for(a+=" OR (",t=0,r=(c=e.split(" ")).length;t<r;t++)v=c[t],a.endsWith("(")||(a+=" AND "),a+='(title:"'+v+'" OR subtitle:"'+v+'")';a+=")"}for(f=await this.fetch("https://dev.api.cottagelabs.com/use/crossref/works?q="+a),s=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),i=0,n=(d=null!=(h=null!=f&&null!=(p=f.hits)?p.hits:void 0)?h:[]).length;i<n;i++)(l=d[i])._source.DOI&&l._source.title&&l._source.title.length&&(y=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(g=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&g.length&&o.call(y,g)<0&&(y+=" "+g),y=y.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==s.indexOf(y)||-1!==y.indexOf(s))&&s.length/y.length>.7&&s.length/y.length<1.3&&("journal-article"===l._source.type||null==m||"journal-article"!==m.type&&"journal-article"===l._source.type)&&(m=l._source));return m},r.src.doaj={},r.src.doaj.journals=async function(e){var t;if(null==e&&(e=null!=(t=this.params.journals)?t:this.params.issn),e)try{return(await this.fetch("https://doaj.org/api/v2/search/journals/"+e)).results[0]}catch(e){}},r.src.doaj.articles=async function(e){var t,i,r,n;n="https://doaj.org/api/v1/search/articles";try{r=this.params.title.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}if(r||"string"==typeof e)e.startsWith("10.")&&(e+="doi:"),n+=null!=(i="/"+r)?i:e;else for(t in n+="?",params)n+=t+"="+params[t]+"&";return(await this.fetch(n)).results},r.src.epmc=async function(e,t,i){var r,n,s,a,l,o;return null==e&&(e=null!=(r=this.params.epmc)?r:this.params.doi),0===e.indexOf("10.")&&-1===e.indexOf(" ")&&e.split("/").length>=2&&(e="DOI:"+e),o="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(o+="&pageSize="+i),null!=t&&(o+="&cursorMark="+t),l={},a=await this.fetch(o),l.total=a.hitCount,l.data=null!=(n=null!=(s=a.resultList)?s.result:void 0)?n:[],l.cursor=a.nextCursorMark,this.params.doi&&1===l.total?l.data[0]:l},r.src.epmc.doi=async function(e){var t;return null==e&&(e=this.params.doi),(t=await this.src.epmc("DOI:"+e)).total?t.data[0]:void 0},r.src.epmc.doi._hidden=!0,r.src.epmc.pmid=async function(e){var t;return null==e&&(e=this.params.pmid),(t=await this.src.epmc("EXT_ID:"+e+" AND SRC:MED")).total?t.data[0]:void 0},r.src.epmc.pmc=async function(e){var t;return(t=await this.src.epmc("PMCID:PMC"+e.toLowerCase().replace("pmc",""))).total?t.data[0]:void 0},r.src.epmc.title=async function(e){var t;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(t=await this.src.epmc('title:"'+e+'"')).total?t.data[0]:void 0},r.src.epmc.licence=async function(e,t,i){var r,n,s,a,l,o;if(null==e&&(e=null!=(l=this.params.licence)?l:this.params.pmcid),e&&!t&&(o=await this.src.epmc("PMC"+e.toLowerCase().replace("pmc",""))),(null!=o?o.total:void 0)>0||t||i){if(null==t&&(t=o.data[0]),!e&&t&&(e=t.pmcid),t.license)return 0===(n={licence:t.license,source:"epmc_api"}).licence.indexOf("cc")&&(n.licence=n.licence.replace(/ /g,"-")),n;if(!i&&e&&(i=await this.src.epmc.xml(e)),404!==i&&"string"==typeof i&&0===i.indexOf("<")&&null!=this.svc.lantern){if(null!=(s=await this.svc.lantern.licence(void 0,void 0,i,"<permissions>","</permissions>")).licence)return s.source="epmc_xml_permissions",s;if(null!=(r=await this.svc.lantern.licence(void 0,void 0,i)).licence)return r.source="epmc_xml_outside_permissions",r;-1!==i.indexOf("<permissions>")&&(a={licence:"non-standard-licence",source:"epmc_xml_permissions"})}return null!=a&&a}return!1},r.src.epmc.xml=function(e){var t;return null==e&&(e=null!=(t=this.params.xml)?t:this.params.pmcid),e&&(e=e.toLowerCase().replace("pmc","")),this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/PMC"+e+"/fullTextXML")},r.src.epmc.aam=async function(e,t,i){var r;return null==e&&(e=null!=(r=this.params.xml)?r:this.params.pmcid),"string"==typeof i&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(null==e&&(e=null!=t?t.pmcid:void 0),e&&"string"==typeof(i=await this.src.epmc.xml(e))&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:{aam:!1,info:""})},r.src.fatcat=async function(e){var t;null==e&&(e=null!=(t=this.params.fatcat)?t:this.params.doi);try{return await this.fetch("https://api.fatcat.wiki/v0/release/lookup?expand=files&hide=abstracts,refs&doi="+e)}catch(e){return}},r.src.google=async function(e,t,i){var r,n,s,a,l,o,u,c,h,p;return null==e&&(e=null!=(r=null!=this&&null!=(n=this.params)?n.q:void 0)?r:null!=this&&null!=(s=this.params)?s.google:void 0),null==t&&(t=null!=(a=this.S.src.google)&&null!=(l=a.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(h=c.search)?h.key:void 0),e&&t&&i?(p="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(p)):{}},r.src.google.sheets=async function(e){var t,i,r,n,s,a,l,o;if(null==e&&(e=null!=(n=null!=this?this.params:void 0)?n:{}),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(s=e.sheet)?s:e.sheets,delete e.sheet,delete e.sheets),o=[],!e.sheetid)return o;for(r in 0===e.sheetid.indexOf("http")?a=e.sheetid:(-1!==e.sheetid.indexOf("/spreadsheets/d/")?e.sheetid=e.sheetid.split("/spreadsheets/d/")[1].split("/")[0]:2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="default"),a="https://spreadsheets.google.com/feeds/list/"+e.sheetid+"/"+e.sheet+"/public/values?alt=json"),(t=await this.fetch(a)).feed.entry){for(i in l={},t.feed.entry[r])try{0===i.indexOf("gsx$")&&null!=t.feed.entry[r][i].$t&&""!==t.feed.entry[r][i].$t&&(l[i.replace("gsx$","")]=t.feed.entry[r][i].$t)}catch(e){}o.push(l)}return t=void 0,o},r.src.google.sheets._bg=!0,r.src.google.chat=function(e,t){var i,r,n,s,a,l;return null==e&&(e=this.params),i={method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:{text:decodeURIComponent(null!=(r=null!=(n=null!=(s=e.text)?s:e.msg)?n:e.body)?r:"")}},null==t&&(t=null!=(a=this.S.src.google)&&null!=(l=a.secrets)?l.chat:void 0),i.body.text&&null!=t?this.fetch(t,i):void 0},r.src.grist=async function(e,t){var i,r,n,s;return null==e&&(e=this.params.grist),0!==e.indexOf("gid:")&&-1===e.indexOf(" ")&&parseInt(e)&&(e="gid:"+e),s="https://www.ebi.ac.uk/europepmc/GristAPI/rest/get/query="+e+"&resultType=core&format=json",null!=t&&(s+="&page="+(Math.floor(t/25)+1)),{total:(n=await this.fetch(s)).data.HitCount,data:null!=(i=null!=(r=n.data.RecordList)?r.Record:void 0)?i:{}}},null==(p=n.src).microsoft&&(p.microsoft={});try{n.src.microsoft.secrets=JSON.parse(SECRETS_MICROSOFT)}catch(e){}r.src.microsoft={},r.src.microsoft.bing=async function(e,t){var i,r,s,a,l,o,u,c,h,p,d;return null==e&&(e=null!=(i=null!=(r=null!=this&&null!=(s=this.params)?s.bing:void 0)?r:null!=this&&null!=(a=this.params)?a.q:void 0)?i:null!=this&&null!=(l=this.params)?l.query:void 0),null==t&&(t=null!=(o=n.src.microsoft)&&null!=(u=o.secrets)&&null!=(c=u.bing)?c.key:void 0),d="https://api.cognitive.microsoft.com/bing/v7.0/search?mkt=en-GB&count=20&q="+e,(null!=(p=await this.fetch(d,{headers:{"Ocp-Apim-Subscription-Key":t}}))&&null!=(h=p.webPages)?h.value:void 0)?{total:p.data.webPages.totalEstimatedMatches,data:p.data.webPages.value}:{total:0,data:[]}},r.src.microsoft.graph=async function(e){var t,i,r,n,s,a,l,o,u,c,h;if(t=async function(e){var t;return e.JournalId&&(t=await this.src.microsoft.graph.journal(e.JournalId))&&(e.journal=t),e},null==e&&(e=null!=(s=null!=(a=null!=(l=this.params.graph)?l:this.params.doi)?a:this.params.title)?s:this.params),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&-1!==e.indexOf("/")&&0===e.indexOf("10.")&&(n=await this.src.microsoft.graph.paper('Doi.exact:"'+e+'"')))return await t(n);if("string"==typeof e&&-1===e.indexOf(" ")&&10===e.length&&(n=await this.src.microsoft.graph.paper(e)))return await t(n);if("string"!=typeof e||-1===e.indexOf(" "))return await this.src.microsoft.graph.paper(e);if(h=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),null!=(u=await this.src.microsoft.graph.paper('PaperTitle:"'+h+'"'))?u.PaperTitle:void 0){if(c=u.PaperTitle.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),"function"==typeof(null!=this&&null!=(o=this.tdm)?o.levenshtein:void 0))return i=(r=await this.tdm.levenshtein(h,c,!1)).length.a>r.length.b?r.length.a:r.length.b,r.distance<2||i/r.distance>10?u:void 0;if(h.length<1.2*c.length&&h.length>.8*c.length)return u}},r.src.microsoft.graph.paper=async function(e){var t,i,r;return r="https://dev.api.cottagelabs.com/use/microsoft/graph/paper/?q="+e,(null!=(i=await this.fetch(r))&&null!=(t=i.hits)?t.total:void 0)?i.hits.hits[0]._source:void 0},r.src.microsoft.graph.journal=async function(e){var t;return t="https://dev.api.cottagelabs.com/use/microsoft/graph/journal/"+e,await this.fetch(t)},r.src.oadoi=function(e){var t,i,r,s;return null==e&&(e=null!=(t=null!=this&&null!=(i=this.params)?i.oadoi:void 0)?t:null!=this&&null!=(r=this.params)?r.doi:void 0),"string"==typeof e&&e.startsWith("10.")?(s="https://api.oadoi.org/v2/"+e+"?email="+n.mail.to,this.fetch(s)):void 0},r.src.oadoi._index=!0,r.src.oadoi._key="doi",r.src.oadoi._prefix=!1,r.src.pubmed={},r.src.pubmed.entrez={},r.src.pubmed.entrez.summary=async function(e,t,i){var r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,w;w="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(_.isArray(i)&&(i=i.join(",")),w+="&id="+i):w+="&query_key="+e+"&WebEnv="+t;try{for(g=await this.fetch(w),h=this.convert.xml2json(g.content),d=[],f=h.eSummaryResult.DocSum,n=0,o=f.length;n<o;n++){for(r={id:(p=f[n]).Id[0]},m=p.Item,a=0,u=m.length;a<u;a++)if("List"===(s=m[a]).$.Type){if(r[s.$.Name]=[],null!=s.Item)for(y=s.Item,l=0,c=y.length;l<c;l++)v=y[l],(b={})[v.$.Name]=v._,r[s.$.Name].push(b)}else r[s.$.Name]=s._;if(d.push(r),null==i||-1===i.indexOf(","))return d[0]}return d}catch(e){return}},r.src.pubmed.entrez.pmid=async function(e){var t,i,r;r="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return t=await this.fetch(r),i=this.convert.xml2json(t.content),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey[0],i.ePostResult.WebEnv[0])}catch(e){return}},r.src.pubmed.search=async function(e,t,i=10,r=!1){var n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w;_="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof r&&(r=r.split(",")),Array.isArray(r))g={total:r.length,data:[]};else{if(g=await this.fetch(_),g={total:(v=this.convert.xml2json(g.content)).eSearchResult.Count[0],data:[]},!0===r)return g.data=v.eSearchResult.IdList[0].Id,g;r=v.eSearchResult.IdList[0].Id}if(t)for(n=0,u=r.length;n<u&&(b=r[n],d=await this.src.pubmed.pmid(b),g.data.push(d),g.data.length!==i);n++);else{for(w=[],a=0,c=r.length;a<c&&(s=r[a],g.data.length!==i);a++)if(w.push(s),40===w.length){for(m=await this.src.pubmed.entrez.summary(void 0,void 0,w),l=0,h=m.length;l<h&&(f=m[l],g.data.push(await this.src.pubmed.format(f)),g.data.length!==i);l++);w=[]}if(w.length)for(y=this.src.pubmed.entrez.summary(void 0,void 0,w),o=0,p=y.length;o<p&&(f=y[o],g.data.push(this.src.pubmed.format(f)),g.data.length!==i);o++);}return g}catch(e){return}},r.src.pubmed.pmid=async function(e){var t,i;try{if(i="https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml",0===(t=await this.fetch(i)).indexOf("<"))return this.src.pubmed.format(await this.decode(t.content.split("<pre>")[1].split("</pre>")[0].replace("\n","")))}catch(e){}try{return this.src.pubmed.format(await this.src.pubmed.entrez.pmid(e))}catch(e){}},r.src.pubmed.aheadofprint=async function(e){try{return-1!==(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).indexOf("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){return!1}},r.src.pubmed.format=function(e,t={}){var i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B;if("string"==typeof e&&0===e.indexOf("<")&&(e=this.convert.xml2json(e)),null!=(null!=(I=e.eSummaryResult)?I.DocSum:void 0)||e.ArticleIds){if(a={},null!=(null!=(q=e.eSummaryResult)?q.DocSum:void 0))for(l=0,p=(L=(e=md.eSummaryResult.DocSum[0]).Item).length;l<p;l++)if("List"===(o=L[l]).$.Type){if(a[o.$.Name]=[],null!=o.Item)for(u=0,d=(R=o.Item).length;u<d;u++)(B={})[(J=R[u]).$.Name]=J._,a[o.$.Name].push(B)}else a[o.$.Name]=o._;else a=e;try{null==t.pmid&&(t.pmid=e.Id[0])}catch(e){}try{null==t.pmid&&(t.pmid=e.id)}catch(e){}try{null==t.title&&(t.title=a.Title)}catch(e){}try{null==t.issn&&(t.issn=a.ISSN)}catch(e){}try{null==t.essn&&(t.essn=a.ESSN)}catch(e){}try{null==t.doi&&(t.doi=a.DOI)}catch(e){}try{null==t.journal&&(t.journal=a.FullJournalName)}catch(e){}try{null==t.journal_short&&(t.journal_short=a.Source)}catch(e){}try{null==t.volume&&(t.volume=a.Volume)}catch(e){}try{null==t.issue&&(t.issue=a.Issue)}catch(e){}try{null==t.page&&(t.page=a.Pages)}catch(e){}try{null==t.year&&(t.year=a[a.PubDate?"PubDate":"EPubDate"].split(" ")[0])}catch(e){}try{A=a[a.PubDate?"PubDate":"EPubDate"].split(" "),null==t.published&&(t.published=A[0]+"-"+(["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(A[1].toLowerCase())+1)+"-"+(3===A.length?A[2]:"01"))}catch(e){}if(null!=a.AuthorList)for(null==t.author&&(t.author=[]),c=0,f=(T=a.AuthorList).length;c<f;c++){i=T[c];try{i.family=i.Author.split(" ")[0],i.given=i.Author.replace(i.family+" ",""),i.name=i.given+" "+i.family,t.author.push(i)}catch(e){}}if(null!=a.ArticleIds&&null==t.pmcid)for(h=0,m=(U=a.ArticleIds).length;h<m;h++)if((r=U[h]).pmc){null==t.pmcid&&(t.pmcid=r.pmc);break}}else if(null!=e.PubmedArticle){x=(e=e.PubmedArticle).MedlineCitation[0];try{null==t.pmid&&(t.pmid=x.PMID[0]._)}catch(e){}try{null==t.title&&(t.title=x.Article[0].ArticleTitle[0])}catch(e){}try{null==t.issn&&(t.issn=x.Article[0].Journal[0].ISSN[0]._)}catch(e){}try{null==t.journal&&(t.journal=x.Article[0].Journal[0].Title[0])}catch(e){}try{null==t.journal_short&&(t.journal_short=x.Article[0].Journal[0].ISOAbbreviation[0])}catch(e){}try{S=x.Article[0].Journal[0].JournalIssue[0].PubDate[0];try{null==t.year&&(t.year=S.Year[0])}catch(e){}try{null==t.published&&(t.published=S.Year[0]+"-"+(S.Month?["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(S.Month[0].toLowerCase())+1:"01")+"-"+(S.Day?S.Day[0]:"01"))}catch(e){}}catch(e){}try{for(null==t.author&&(t.author=[]),D=x.Article[0].AuthorList[0].Author,w=0,y=D.length;w<y;w++){s=D[w],(i={}).family=s.LastName[0],i.given=s.ForeName[0],i.name=i.Author?i.Author:i.given+" "+i.family;try{i.affiliation=s.AffiliationInfo[0].Affiliation[0]}catch(e){}null!=i.affiliation&&(_.isArray(i.affiliation)&&(i.affiliation=i.affiliation[0]),"string"==typeof i.affiliation&&(i.affiliation={name:i.affiliation})),t.author.push(i)}}catch(e){}try{for(N=e.PubmedData[0].ArticleIdList[0].ArticleId,O=0,g=N.length;O<g;O++)if("doi"===(j=N[O]).$.IdType){null==t.doi&&(t.doi=j._);break}}catch(e){}try{for(null==t.reference&&(t.reference=[]),M=e.PubmedData[0].ReferenceList[0].Reference,k=0,v=M.length;k<v;k++){E=M[k].Citation[0],z={},-1!==E.indexOf("doi.org/")&&(z.doi=E.split("doi.org/")[1].trim());try{for(z.author=[],P=E.split(". ")[0].split(", "),C=0,b=P.length;C<b;C++)n=P[C],z.author.push({name:n})}catch(e){}try{z.title=E.split(". ")[1].split("?")[0].trim()}catch(e){}try{z.journal=E.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{z.url="http"+E.split("http")[1].split(" ")[0],-1!==z.url.indexOf("doi.org")&&delete z.url}catch(e){}_.isEmpty(z)||t.reference.push(z)}}catch(e){}}try{null==t.pdf&&(t.pdf=e.pdf)}catch(e){}try{null==t.url&&(t.url=e.url)}catch(e){}try{null==t.open&&(t.open=e.open)}catch(e){}try{null==t.redirect&&(t.redirect=e.redirect)}catch(e){}return t};try{n.svc.sherpa=JSON.parse(SECRETS_SHERPA)}catch(e){}r.src.sherpa={},r.src.sherpa.opendoar={_index:!0,_prefix:!1},r.src.sherpa.opendoar.import=async function(){var e,t,i,r,n,s,a,l;for(this.src.sherpa.opendoar(""),s=[],e=0,r=0;(l=await this.fetch("https://v2.sherpa.ac.uk/cgi/retrieve?api-key="+this.S.svc.sherpa.apikey+"&item-type=repository&format=Json&offset="+r))&&null!=(null!=l?l.items:void 0)&&l.items.length;)for(console.log(r,e,l.items.length),r+=100,t=0,i=(a=l.items).length;t<i;t++)n=a[t],e+=1,s.push(n),2e3===s.length&&(await this.src.sherpa.opendoar(s),s=[]);return s.length&&await this.src.sherpa.opendoar(s),e},r.src.sherpa.opendoar.import._hidden=!0,r.src.wikidata=function(e){var t,i;try{null==e&&(e=null!=(t=null!=(i=this.params.wikidata)?i:this.params.q)?t:this.params)}catch(e){}return"string"==typeof e?0===e.indexOf("Q")?this.fetch("https://dev.api.cottagelabs.com/use/wikidata/"+e):this.fetch("https://dev.api.cottagelabs.com/use/wikidata?q="+e):this.fetch("https://dev.api.cottagelabs.com/use/wikidata",{body:e})},r.src.zenodo={deposition:{},records:{}},r.src.zenodo.records.search=function(e,t){var i;return null==e&&(e=this.params),null==t&&(t=this.params.dev),i="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+size+"&q="+e,this.fetch(i)},r.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},r.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){return}},r.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},r.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},r.src.zenodo.records.format=async function(e){var t,i,r,n,s,a,l,o,u,c,h;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=await this.convert.html2txt(e.metadata.description)}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,n=0,a=c.length;n<a;n++)if("pdf"===(r=c[n]).type){null==o.pdf&&(o.pdf=r.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),h=e.metadata.creators,s=0,l=h.length;s<l;s++){if("string"==typeof(t=h[s])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},r.src.zenodo.deposition.create=async function(e,t,i,r){var n,s,a,l,o,u,c,h;return null==r&&(r=this.params.dev),null==i&&(i=this.params.token),null==i&&(i=this.S.dev||r?null!=(a=this.S.src)&&null!=(l=a.zenodo)?l.sandbox:void 0:null!=(o=this.S.src)&&null!=(u=o.zenodo)?u.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(h="https://"+(this.S.dev||r?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(s={metadata:e}).metadata.upload_type||(s.metadata.upload_type="publication",s.metadata.publication_type="article"),null==(n=s.metadata).creators&&(n.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(c=await this.fetch(h,{method:"POST",body:s}))?c.id:void 0)&&(t.content||t.file)&&(c.uploaded=await this.src.zenodo.deposition.upload(c.id,t.content,t.file,t.name,t.url,i)),t.publish&&(c.published=await this.src.zenodo.deposition.publish(c.id,i)),c):await this.fetch(h,{method:"POST",body:s}))},r.src.zenodo.deposition.upload=async function(e,t,i,r,n,s,a){var l,o,u,c;if(null==e&&(e=null!=(l=this.params.upload)?l:this.params.id),null==t&&(t=this.params.content),null==r&&(r=this.params.name),!t&&!i)try{i=this.request.files[0]}catch(e){}if(n&&!t&&!i)try{t=await this.fetch(n)}catch(e){}return null==s&&(s=this.params.token),null==s&&(s=this.S.dev||a?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==a&&(a=this.params.dev),null!=s&&null!=e&&(n="https://"+(this.S.dev||a?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+s,this.fetch(n,{method:"POST",body:null!=t?t:i},{name:r}))},r.src.zenodo.deposition.publish=function(e,t,i){var r,n,s,a,l;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(n=this.S.src.zenodo)?n.sandbox:void 0:null!=(s=this.S.src)&&null!=(a=s.zenodo)?a.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(l,{method:"POST"}))},r.src.zenodo.deposition.delete=async function(e,t,i){var r,n,s,a;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(n=this.S.src.zenodo)?n.sandbox:void 0:null!=(s=this.S.src.zenodo)?s.token:void 0),null!=t&&null!=e&&(a="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(a,{method:"DELETE"}),!0)},r.status=async function(){var t,i,r,s,a,l,o,u;for(u={name:n.name,version:n.version,built:n.built},t=0,s=(l=["uid","rid","params","base","parts","opts","routes"]).length;t<s;t++){r=l[t];try{null==u[r]&&(u[r]=this[r])}catch(e){}}if(!0===this.S.bg&&(u.bg=!0),u.kv=("string"==typeof this.S.kv&&e[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv,await this.index("")&&(u.index=!0),n.dev){if(!0!==this.S.bg)try{u.request=this.request}catch(e){}for(i=0,a=(o=["headers","cookie","user"]).length;i<a;i++){r=o[i];try{null==u[r]&&(u[r]=this[r])}catch(e){}}}return u};o=[].indexOf;r.svc.lantern=async function(e){var t,i,r,n,s,a,l;if(null==e&&(e=null!=(r=this.params.lantern)?r:this.params.job),e&&e.startsWith("10.")&&(e=void 0),null!=e)return(i=await this.svc.lantern.job(e)).progress=await this.svc.lantern.progress(i),i;if(this.params.doi||this.params.lantern||this.params.pmid||this.params.pmc||this.params.pmcid||this.body){for(t in null==(i={}).email&&(i.email=this.params.email),i._id=this.uid(),this.body?"object"==typeof this.body&&!Array.isArray(this.body)&&this.body.list?(i.processes=this.body.list,null==i.name&&(i.name=this.body.name)):i.processes=this.body:(i.processes=[],(this.params.doi||this.params.lantern)&&i.processes.push({doi:null!=(n=this.params.doi)?n:this.params.lantern}),this.params.pmid&&i.processes.push({pmid:this.params.pmid}),(this.params.pmcid||this.params.pmc)&&i.processes.push({pmcid:null!=(s=this.params.pmcid)?s:this.params.pmc}),null==i.name&&(i.name=this.params.name)),this.svc.lantern.job(i),i.processes)this.svc.lantern.process(i.processes[t],parseInt(t)===i.processes.length-1?i:void 0);return i.email&&(l="Dear "+i.email+"\n\nWe've just started processing a batch of identifiers for you, and you can see the progress of the job here:\n\n",l+="https://compliance.cottagelabs.com#"+i._id,l+="\n\nIf you didn't submit this request yourself, it probably means that another service is running ",l+="it on your behalf, so this is just to keep you informed about what's happening with your account; ",l+="you don't need to do anything else.\n\nYou'll get another email when your job has completed.\n\n",this.mail({from:"Lantern <lantern@cottagelabs.com>",to:i.email,subject:"Wellcome Compliance: job "+(null!=(a=i.name)?a:i._id)+" submitted successfully",text:l})),i}return{name:"Lantern for Wellcome",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built}},r.svc.lantern.job={_index:!0},r.svc.lantern.result={_index:!0},r.svc.lantern.results=async function(e,t){var i,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G,H,K,Q,Z,ee,te,ie,re,ne,se,ae;for(null==e&&(e=null!=(S=null!=(j=this.params.lantern)?j:this.params.results)?S:this.params.job),p=t?0:[],c=0,f=(N=(h=await this.svc.lantern.job(e)).processes).length;c<f;c++)k=N[c],(te=await this.svc.lantern.result(k._id))&&(t?p+=1:p.push(te));if("csv"!==this.format)return p;for(n=["pmcid","pmid","doi","title","journal_title","pure_oa","issn","eissn","publication_date","electronic_publication_date","publisher","publisher_licence","licence","epmc_licence","licence_source","epmc_licence_source","in_epmc","epmc_xml","aam","open_access","ahead_of_print","romeo_colour","preprint_embargo","preprint_self_archiving","postprint_embargo","postprint_self_archiving","publisher_copy_embargo","publisher_copy_self_archiving","authors","in_core","in_base","repositories","repository_urls","repository_oai_ids","repository_fulltext_urls","confidence","compliance_wellcome_standard","compliance_wellcome_deluxe"],l=0,i=[],re=[],d=0,m=h.length;d<m;d++){for(te=h[d],ie={},b=0,y=n.length;b<y;b++)if(s=n[b],O=null!=($=null!=(G=r.svc.lantern._fields[s])?G.short_name:void 0)?$:s,o.call(i,O)<0&&i.push(O),"authors"===s)for(A in ie[O]="",te.authors)ie[O]+="0"===A?"":"\r\n",te.authors[A].fullName&&(ie[O]+=te.authors[A].fullName);else if("repositories"===s||"repository_urls"===s||"repository_fulltext_urls"===s||"repository_oai_ids"===s){if(ie[O]="",null!=te.repositories)for(_=0,g=(H=te.repositories).length;_<g;_++)(se=H[_]).name&&(ie[O]&&(ie[O]+="\r\n"),"repositories"===s?ie[O]+=null!=(K=se.name)?K:"":"repository_urls"===s?ie[O]+=null!=(Q=se.url)?Q:"":"repository_fulltext_urls"===s?ie[O]+=null!=se.fulltexts?se.fulltexts.join():"":"repository_oai_ids"===s&&(ie[O]+=null!=(Z=se.oai)?Z:""))}else"pmcid"===s&&te.pmcid?(0!==te.pmcid.toLowerCase().indexOf("pmc")&&(te.pmcid="PMC"+te.pmcid),ie[O]=te.pmcid):!0===te[s]?ie[O]="TRUE":!1===te[s]?ie[O]="FALSE":null==te[s]||"unknown"===te[s]?ie[O]="Unknown":ie[O]=te[s];if(null!=te.grants){for(ne=0,w=0,v=(ee=te.grants).length;w<v;w++)u=ee[w],ne+=1,ie[(null!=(E=null!=(I=r.svc.lantern._fields.grant)?I.short_name:void 0)?E:"grant").split(" ")[0]+" "+ne]=null!=(C=u.grantId)?C:"",ie[(null!=(q=null!=(L=r.svc.lantern._fields.agency)?L.short_name:void 0)?q:"agency").split(" ")[0]+" "+ne]=null!=(P=u.agency)?P:"",ie[(null!=(T=null!=(U=r.svc.lantern._fields.pi)?U.short_name:void 0)?T:"pi").split(" ")[0]+" "+ne]=null!=(R=u.PI)?R:u.grantId||u.agency?"Unknown":"";ne>l&&(l=ne)}if(ie[ae=null!=(D=null!=(M=r.svc.lantern._fields.provenance)?M.short_name:void 0)?D:"provenance"]="",null!=te.provenance)for(x in te.provenance)ie[ae]+="0"===x?"":"\r\n",ie[ae]+=te.provenance[x];re.push(ie)}for(a=1;a<l+1;)i.push((null!=(z=null!=(J=r.svc.lantern._fields.grant)?J.short_name:void 0)?z:"grant").split(" ")[0]+" "+a),i.push((null!=(B=null!=(W=r.svc.lantern._fields.agency)?W.short_name:void 0)?B:"agency").split(" ")[0]+" "+a),i.push((null!=(X=null!=(Y=r.svc.lantern._fields.pi)?Y.short_name:void 0)?X:"pi").split(" ")[0]+" "+a),a++;return o.call(ignorefields,"provenance")<0&&i.push(null!=(V=null!=(F=r.svc.lantern._fields.provenance)?F.short_name:void 0)?V:"provenance"),this.convert.json2csv(re)},r.svc.lantern.progress=async function(e){var t,i,r,n;return null==e&&(e=null!=(r=null!=(n=this.params.lantern)?n:this.params.progress)?r:this.params.job),t="object"==typeof e?e:await this.svc.lantern(e),i=await this.svc.lantern.results(t,!0),Math.ceil(i/t.processes.length*1e4)/100},r.svc.lantern.licence=async function(e,t,i,r){var n,s,a,l,o,u,c,h,p,d,f;null==e&&(e=this.params.url),null!=e&&(e=e.replace(/(^\s*)|(\s*$)/g,"")),null==t&&(t=null!=(u=this.params.content)?u:this.body);try{null==t&&(t=await this.puppet(e))}catch(e){}if("number"==typeof t&&(t=void 0),null==i&&(i=this.params.start),null==r&&(r=this.params.end),e&&(lic.url=e),"string"==typeof t)for(null!=i&&-1!==t.indexOf(i)&&(t=t.split(i)[1]),null!=r&&(t=t.split(r)[0]),t.length>1e6&&(lic.large=!0,t=t.substring(0,5e5)+t.substring(t.length-5e5,t.length)),n=0,a=(p=null!=(c=null!=(l=await this.svc.lantern.licences("*",1e5))&&null!=(h=l.hits)?h.hits:void 0)?c:[]).length;n<a;n++)if(("*"===(s=p[n]._source).domain||!s.domain||null==e||-1!==s.domain.toLowerCase().indexOf(e.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(o=s.match.toLowerCase().replace(/[^a-z0-9]/g,""),(d=!!(f=-1!==s.match.indexOf("://")&&s.match.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&-1!==t.toLowerCase().indexOf(f))||-1!==t.toLowerCase().replace(/[^a-z0-9]/g,"").indexOf(o))){lic.licence=s.licence,lic.match=s.match,lic.matched=d?f:o;break}return lic},r.svc.lantern.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1},r.svc.lantern.process=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G,H,K,Q,Z,ee,te,ie,re,ne,se,ae,le,oe,ue,ce,he,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,Ae,Se,je;for(i=function(e){var t,i,r,n,s,a,l;try{if(-1!==(e=e.replace(/\//g,"-")).indexOf("-")){if(e.length<11){if(3===(i=e.split("-")).length)return e.indexOf("-")<4?i[2]+"-"+i[1]+"-"+i[0]+"T00:00:00Z":e+"T00:00:00Z";if(2===i.length)return e.indexOf("-")<4?i[1]+i[0]+e+"-01T00:00:00Z":e+"-01T00:00:00Z"}return e}return l=(t=e.replace(/  /g," ").split(" "))[0].toString(),n=t.length>1?t[1]:1,isNaN(parseInt(n))?(s=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],a=n.toLowerCase().substring(0,3),n=-1!==s.indexOf(a)?s.indexOf(a)+1:"01"):n=parseInt(n),1===(n=n.toString()).length&&(n="0"+n),1===(r=t.length>2?t[2].toString():"01").length&&(r="0"+r),l+"-"+n+"-"+r+"T00:00:00Z"}catch(e){return}},null==e&&(e={doi:this.params.doi,pmid:this.params.pmid,pmcid:this.params.pmcid}),w=0,S=(F=["DOI","PMID","PMCID","TITLE"]).length;w<S;w++)e[W=F[w]]&&(e[W.toLowerCase()]=e[W]);for(null==e.doi&&(e.doi=e.DOI),null==e.pmid&&(e.pmid=e.PMID),null==e.pmcid&&(e.pmcid=null!=($=null!=(se=e.PMCID)?se:e.PMC)?$:e.pmc),null==e.title&&(e.title=null!=(pe=null!=(de=e["article title"])?de:e["Article title"])?pe:e["Article Title"]),e.title&&(e.title=e.title.replace(/\s\s+/g," ").trim()),e.pmcid&&(e.pmcid=e.pmcid.replace(/[^0-9]/g,"")),e.pmid&&(e.pmid=e.pmid.replace(/[^0-9]/g,"")),e.doi&&(e.doi=decodeURIComponent(e.doi.replace(/ /g,""))),null==e._id&&(e._id=e.doi?e.doi.replace(/\//g,"_"):null!=(fe=null!=(me=e.pmcid)?me:e.pmid)?fe:await this.uid()),xe={_id:e._id,pmcid:e.pmcid,pmid:e.pmid,doi:e.doi,title:e.title,journal_title:void 0,pure_oa:!1,issn:void 0,eissn:void 0,publication_date:void 0,electronic_publication_date:void 0,publisher:void 0,publisher_licence:void 0,licence:"unknown",epmc_licence:"unknown",licence_source:"unknown",epmc_licence_source:"unknown",in_epmc:!1,epmc_xml:!1,aam:!1,open_access:!1,ahead_of_print:void 0,preprint_embargo:"unknown",preprint_self_archiving:"unknown",postprint_embargo:"unknown",postprint_self_archiving:"unknown",publisher_copy_embargo:"unknown",publisher_copy_self_archiving:"unknown",authors:[],in_core:"unknown",in_base:"unknown",repositories:[],grants:[],confidence:0,provenance:[]},O=0,j=(ye=["pmcid","pmid","doi","title"]).length;O<j;O++)if(e[Ae=ye[O]]){if(_e=await this.src.epmc["pmcid"===Ae?"pmc":Ae](e[Ae])){d=_e,xe.confidence="title"!==Ae||_e.title.toLowerCase()===e[Ae].toLowerCase()?1:.9;break}"title"===Ae&&(_e=await this.src.epmc("title:"+e[Ae]))&&null!=(null!=_e?_e.data:void 0)&&_e.data.length&&(d=_e.data[0],xe.confidence=.7)}if(null!=d?(d.pmcid&&xe.pmcid!==d.pmcid&&(xe.pmcid=d.pmcid,xe.provenance.push("Added PMCID from EUPMC")),d.pmid&&xe.pmid!==d.pmid&&(xe.pmid=d.pmid,xe.provenance.push("Added PMID from EUPMC")),d.doi&&xe.doi!==d.doi&&(xe.doi=d.doi,xe.provenance.push("Added DOI from EUPMC")),d.title&&!xe.title&&(xe.title=d.title,xe.provenance.push("Added article title from EUPMC")),"Y"===d.inEPMC&&(xe.in_epmc=!0,xe.provenance.push("Confirmed fulltext is in EUPMC")),"Y"===d.isOpenAccess?(xe.open_access=!0,xe.provenance.push("Confirmed is open access from EUPMC")):xe.provenance.push("This article is not open access according to EUPMC, but since 6th March 2020 we take this to mean only that the publisher did not indicate to EUPMC that it can be included in their Open Access subset - it may well still be an OA article."),(null!=(ge=d.journalInfo)?ge.journal:void 0)&&(d.journalInfo.journal.title&&(xe.journal_title=d.journalInfo.journal.title,xe.provenance.push("Added journal title from EUPMC")),d.journalInfo.journal.issn&&(xe.issn=d.journalInfo.journal.issn,xe.provenance.push("Added issn from EUPMC")),d.journalInfo.journal.essn&&(xe.eissn=d.journalInfo.journal.essn,!xe.eissn||xe.issn&&-1!==xe.issn.indexOf(xe.eissn)||(xe.issn=(xe.issn?xe.issn+", ":"")+xe.eissn),xe.provenance.push("Added eissn from EUPMC"))),(null!=(ve=d.grantsList)?ve.grant:void 0)&&(xe.grants=d.grantsList.grant,xe.provenance.push("Added grants data from EUPMC")),(null!=(G=d.journalInfo)?G.dateOfPublication:void 0)&&((m=await i(d.journalInfo.dateOfPublication))?(xe.publication_date=m,xe.provenance.push("Added date of publication from EUPMC")):(xe._invalid_date_of_publication=d.journalInfo.dateOfPublication,xe.provenance.push("Could not add invalid date of publication from EUPMC ("+xe._invalid_date_of_publication+")"))),d.electronicPublicationDate&&((c=await i(d.electronicPublicationDate))?(xe.electronic_publication_date=c,xe.provenance.push("Added electronic publication date from EUPMC")):(Oe=d.electronicPublicationDate,xe.provenance.push("Could not add invalid electronic publication date from EUPMC ("+Oe+")"))),xe.pmcid&&(xe.provenance.push("Checking if XML is available from EUPMC (since 6th March 2020 this is always done for any article we have a PMCID for, regardless of other EUPMC API values)."),404===(je=await this.src.epmc.xml(xe.pmcid))?("Not found in EUPMC when trying to fetch full text XML."," (We do this for any item we have a PMCID for since 6th March 2020, even if EUPMC indicates not in their open access category and/or fulltext not in EUPMC.",xe.provenance.push("Not found in EUPMC when trying to fetch full text XML. (We do this for any item we have a PMCID for since 6th March 2020, even if EUPMC indicates not in their open access category and/or fulltext not in EUPMC.")):"string"==typeof je&&0===je.indexOf("<")?(xe.epmc_xml=!0,xe.provenance.push("Confirmed fulltext XML is available from EUPMC")):null!=je&&xe.provenance.push("Encountered an error while retrieving the EUPMC full text XML. One possible reason is EUPMC being temporarily unavailable.")),!1!==(L=await this.src.epmc.licence(xe.pmcid,d,je))?(xe.licence=L.licence,xe.epmc_licence=L.licence,xe.licence_source=L.source,xe.epmc_licence_source=L.source,f="",L.match&&(f+=" If licence statements contain URLs we will try to find those in addition to ",f+="searching for the statement's text. The match in this case was: '"+L.match.replace(/<.*?>/gi,"")+"' ."),xe.provenance.push("Added EPMC licence ("+xe.epmc_licence+") from "+L.source+"."+f)):xe.provenance.push("Could not find licence via EUPMC"),(null!=(H=d.authorList)?H.author:void 0)&&(xe.authors=d.authorList.author,xe.provenance.push("Added author list from EUPMC")),xe.in_epmc&&(!1===(r=await this.src.epmc.aam(xe.pmcid,d)).aam?(xe.aam=!1,xe.provenance.push("Checked author manuscript status in EUPMC, found no evidence of being one")):!0===r.aam?(xe.aam=!0,xe.provenance.push("Checked author manuscript status in EUPMC, found in "+r.info)):-1!==r.info.indexOf("404")?(xe.aam=!1,xe.provenance.push("Unable to locate Author Manuscript information in EUPMC - could not find the article in EUPMC.")):-1!==r.info.indexOf("error")?(xe.aam="unknown",xe.provenance.push("Error accessing EUPMC while trying to locate Author Manuscript information. EUPMC could be temporarily unavailable.")):-1!==r.info.indexOf("blocking")?(xe.aam="unknown",xe.provenance.push("Error accessing EUPMC while trying to locate Author Manuscript information - EUPMC is blocking access.")):xe.aam="unknown")):xe.provenance.push("Unable to locate article in EPMC."),xe.doi||xe.pmid||xe.pmcid||xe.provenance.push("Unable to obtain DOI, PMID or PMCID for this article. Compliance information may be severely limited."),xe.doi){if(null!=(a=await this.src.crossref.works(xe.doi))?(xe.confidence||(xe.confidence=1),xe.publisher=a.publisher,xe.provenance.push("Added publisher name from Crossref"),!xe.issn&&(a.issn||null!=a.ISSN&&a.ISSN.length>0)&&(xe.issn=null!=(K=a.issn)?K:a.ISSN[0],xe.provenance.push("Added ISSN from Crossref")),!xe.journal_title&&(a.journal||null!=a["container-title"]&&a["container-title"].length>0)&&(xe.journal_title=null!=(Q=a.journal)?Q:a["container-title"][0],xe.provenance.push("Added journal title from Crossref")),!xe.authors&&a.author&&(xe.authors=a.author,xe.provenance.push("Added author list from Crossref")),!xe.title&&null!=a.title&&a.title.length>0&&(xe.title=Array.isArray(a.title)?a.title[0]:a.title,xe.provenance.push("Added article title from Crossref"))):xe.provenance.push("Unable to obtain information about this article from Crossref."),null!=(s=await this.src.core.doi(xe.doi))?s.id:void 0){if(xe.in_core=!0,xe.provenance.push("Found DOI in CORE"),!xe.authors&&s.authors&&(xe.authors=s.author,xe.provenance.push("Added authors from CORE")),null!=s.repositories&&s.repositories.length>0){for(R=0,C=(Z=s.repositories).length;R<C;R++){if(V={name:(be=Z[R]).name},null!=be.oai&&(V.oai=be.oai),be.uri)V.url=be.uri;else try{-1!==(_e=await this.src.sherpa.opendoar('repository_metadata.name:"'+be.name+'"')).hits.hits[0]._source.repository_metadata.name.toLowerCase().indexOf(be.name.toLowerCase())?(V.url=repo.repository_metadata.url,xe.provenance.push("Added repo base URL from OpenDOAR")):xe.provenance.push("Searched OpenDOAR but could not find repo and/or URL")}catch(e){xe.provenance.push("Tried but failed to search OpenDOAR for repo base URL")}if(V.fulltexts=[],A=void 0,s.fulltextUrls)for(U=0,E=(ee=s.fulltextUrls).length;U<E;U++)-1===(y=ee[U]).indexOf("core.ac.uk")?(we=await this.resolve(y))&&-1===V.fulltexts.indexOf(we)&&(V.url&&-1!==we.indexOf(V.url.replace("http://","").replace("https://","").split("/")[0])?V.fulltexts.unshift(we):V.fulltexts.push(we)):null==A&&(A=y);0===V.fulltexts.length&&null!=A&&V.fulltexts.push(A),xe.repositories.push(V)}xe.provenance.push("Added repositories that CORE claims article is available from")}!xe.title&&s.title&&(xe.title=s.title,xe.provenance.push("Added title from CORE"))}else xe.in_core=!1,xe.provenance.push("Could not find DOI in CORE");if(null!=(null!=(n=await this.src.base.doi(xe.doi))?n.dclink:void 0)){xe.in_base=!0,xe.provenance.push("Found DOI in BASE");try{if(u=n.dclink.split("://")[1].split("/")[0],-1!==(_e=await this.src.sherpa.opendoar('repository_metadata.name.name:"'+be.name+'"')).hits.hits[0]._source.repository_metadata.url.toLowerCase().indexOf(u.toLowerCase())){ke={fulltexts:[n.dclink],url:_e.hits.hits[0]._source.repository_metadata.url,oai:_e.hits.hits[0]._source.repository_metadata.oai_url};try{ke.name=_e.hits.hits[0]._source.repository_metadata.name[0].name}catch(e){}xe.repositories.push(ke),xe.provenance.push("Added repo base URL from OpenDOAR")}else xe.provenance.push("Searched OpenDOAR but could not find repo and/or URL")}catch(e){xe.provenance.push("Tried but failed to search OpenDOAR for repo base URL")}!xe.title&&n.dctitle&&(xe.title=n.dctitle,xe.provenance.push("Added title from BASE"))}else xe.in_base=!1,xe.provenance.push("Could not find DOI in BASE")}else xe.provenance.push("Not attempting Crossref / CORE / BASE lookups - do not have DOI for article.");if(null!=xe.grants&&xe.grants.length>0){for(v=[],D=0,I=(te=xe.grants).length;D<I;D++)(g=te[D]).grantId?(_=g.grantId,g.agency&&-1!==g.agency.toLowerCase().indexOf("wellcome")&&(_=_.split("/")[0]),(b=await this.src.grist(_)).total&&b.total>0&&b.data.Person?(z="",(B=b.data.Person).Title&&(z+=B.Title+" "),B.GivenName&&(z+=B.GivenName+" "),!B.GivenName&&B.Initials&&(z+=B.Initials+" "),B.FamilyName&&(z+=B.FamilyName),g.PI=z,xe.provenance.push("Found Grant PI for "+_+" via Grist API")):xe.provenance.push("Tried but failed to find Grant PI via Grist API")):g.grantId="unknown",g.agency&&-1!==g.agency.toLowerCase().indexOf("wellcome")?v.unshift(g):v.push(g);xe.grants=v}else xe.provenance.push("Not attempting Grist API grant lookups since no grants data was obtained from EUPMC.");if(xe.pmid&&!xe.in_epmc?(xe.ahead_of_print=await this.src.pubmed.aheadofprint(xe.pmid),!1!==xe.ahead_of_print?xe.provenance.push("Checked ahead of print status on pubmed, date found "+xe.ahead_of_print):xe.provenance.push("Checked ahead of print status on pubmed, no date found")):(T="Not checking ahead of print status on pubmed.",xe.pmid||(T+=" We don't have the article's PMID."),xe.in_epmc&&(T+=" The article is already in EUPMC."),xe.provenance.push(T)),xe.issn){for(M=0,P=(ie=xe.issn.split(",")).length;M<P;M++)if(l=ie[M],null!=(o=await this.src.doaj.journals.issn(l))){xe.pure_oa=!0,xe.provenance.push("Confirmed journal is listed in DOAJ"),null==xe.publisher&&(xe.publisher=null!=(re=o.bibjson)?re.publisher:void 0),null==xe.journal_title&&(xe.journal_title=null!=(ne=o.bibjson)?ne.title:void 0);break}!0!==xe.pure_oa&&xe.provenance.push("Could not find journal in DOAJ")}if(xe.issn)if(null==this.svc.oaworks)xe.provenance.push("Not attempting to add any data from Open Access Button - OAB is not available.");else if(N=await this.svc.oaworks.find({issn:xe.issn,permissions:!0}))if(xe.journal_title||(null!=(null!=(ae=N.metadata)?ae.journal:void 0)?(xe.journal_title=N.metadata.journal,xe.provenance.push("Added journal title Open Access Button")):xe.provenance.push("Tried, but could not add journal title from Open Access Button.")),xe.publisher||(null!=(null!=(le=N.metadata)?le.publisher:void 0)?(xe.publisher=N.metadata.publisher,xe.provenance.push("Added publisher from Open Access Button")):xe.provenance.push("Tried, but could not add publisher from Open Access Button.")),null!=(null!=(oe=N.permissions)?oe.all_permissions:void 0)&&N.permissions.all_permissions.length){for(Y=0,q=(ue=N.permissions.all_permissions).length;Y<q;Y++)null!=(k="submittedVersion"===(J=ue[Y]).version?"preprint":"acceptedVersion"===J.version?"postprint":"publishedVersion"===J.version?"publisher_copy":void 0)&&(xe[k+"_embargo"]=(J.embargo_months?J.embargo_months+" months":"")+(J.embargo_end?" ending "+J.embargo_end:""),xe[k+"_self_archiving"]=J.deposit_statement);xe.provenance.push("Added embargo and archiving data from Open Access Button")}else xe.provenance.push("No embargo and archiving data available from Open Access Button");else xe.provenance.push("Unable to add any data from Open Access Button.");else xe.provenance.push("Not attempting to add any data from Open Access Button - don't have a journal ISSN to use for lookup.");return X=!1,!xe.licence||"cc-by"!==(ce=xe.licence)&&"cc-zero"!==ce?(X=!0,(L=await this.svc.lantern.licence("https://doi.org/"+xe.doi)).licence&&"unknown"!==L.licence?(xe.licence=L.licence,xe.licence_source="publisher_splash_page",xe.publisher_licence=L.licence,f="",L.match&&(f+=" If licence statements contain URLs we will try to find those in addition to searching for the statement's text. The match in this case was: '"+L.match.replace(/<.*?>/gi,"")+"' ."),xe.provenance.push("Added licence ("+xe.publisher_licence+") via article publisher splash page lookup to "+url+"."+f)):(xe.publisher_licence="unknown",xe.provenance.push("Unable to retrieve licence data via article publisher splash page lookup to "+url+"."),L.large&&xe.provenance.push("Retrieved content was very long, so was contracted to 500,000 chars from start and end to process"))):(xe.provenance.push("Not attempting to retrieve licence data via article publisher splash page lookup."),X=!1),X||"unknown"===xe.publisher_licence||(xe.publisher_licence="not applicable"),null==xe.publisher_licence&&(xe.publisher_licence="unknown"),null==xe.epmc_licence||"unknown"===xe.epmc_licence||xe.epmc_licence.startsWith("cc-")||(xe.epmc_licence="non-standard-licence"),null==xe.publisher_licence||"unknown"===xe.publisher_licence||"not applicable"===xe.publisher_licence||xe.publisher_licence.startsWith("cc-")||(xe.publisher_licence="non-standard-licence"),xe.compliance_wellcome_standard=!1,xe.compliance_wellcome_deluxe=!1,p="ccby"===(h=xe.epmc_licence?xe.epmc_licence.toLowerCase().replace(/ /g,"").replace(/-/g,""):"")||"cc0"===h||"cczero"===h,xe.in_epmc&&(xe.aam||p)&&(xe.compliance_wellcome_standard=!0),xe.in_epmc&&xe.aam&&(xe.compliance_wellcome_deluxe=!0),xe.in_epmc&&p&&xe.open_access&&(xe.compliance_wellcome_deluxe=!0),this.svc.lantern.result(xe),t&&(null!=(x="object"==typeof t?t:await this.svc.lantern.job(t))?x.email:void 0)&&(Se="Dear "+x.email+"\n\nWe've just finished processing a batch of identifiers for you, and you can download the final results here:\n\n",Se+="https://compliance.cottagelabs.com#"+x._id+"\n\nIf you didn't submit the original request yourself, it probably means ",Se+="that another service was running it on your behalf, so this is just to keep you informed about what's happening with your account; you don't need to do anything else.",this.mail({from:"Lantern <lantern@cottagelabs.com>",to:x.email,subject:"Wellcome Compliance: job "+(null!=(he=x.name)?he:x._id)+" completed successfully",text:Se})),xe},r.svc.lantern._fields={pmcid:{short_name:"PMCID"},pmid:{short_name:"PMID"},doi:{short_name:"DOI"},title:{short_name:"Article title"},journal_title:{short_name:"Journal title"},pure_oa:{short_name:"Pure Open Access"},issn:{short_name:"ISSN"},eissn:{short_name:"EISSN"},publication_date:{short_name:"Publication Date"},electronic_publication_date:{short_name:"Electronic Publication Date"},publisher:{short_name:"Publisher"},publisher_licence:{short_name:"Publisher Licence"},epmc_licence:{short_name:"EPMC Licence"},epmc_licence_source:{short_name:"EPMC Licence Source"},licence_source:{short_name:"Licence Source"},licence:{short_name:"Licence"},in_epmc:{short_name:"Fulltext in EPMC?"},epmc_xml:{short_name:"XML Fulltext?"},aam:{short_name:"AAM?"},open_access:{short_name:"Open Access"},ahead_of_print:{short_name:"Ahead of Print?"},romeo_colour:{short_name:"Sherpa Romeo Colour"},preprint_embargo:{short_name:"Preprint Embargo"},preprint_self_archiving:{short_name:"Preprint Self-Archiving Policy"},postprint_embargo:{short_name:"Postprint Embargo"},postprint_self_archiving:{short_name:"Postprint Self-Archiving Policy"},publisher_copy_embargo:{short_name:"Publisher's Copy Embargo"},publisher_copy_self_archiving:{short_name:"Publisher's Copy Self-Archiving Policy"},authors:{short_name:"Author(s)"},in_core:{short_name:"In CORE?"},in_base:{short_name:"In BASE?"},repositories:{short_name:"Archived Repositories"},repository_urls:{short_name:"Repository URLs"},repository_oai_ids:{short_name:"Repository OAI IDs"},repository_fulltext_urls:{short_name:"Repository Fulltext URLs"},grant:{short_name:"Grant {X}"},agency:{short_name:"Agency {X}"},pi:{short_name:"PI {X}"},confidence:{short_name:"Correct Article Confidence"},compliance_wellcome_standard:{short_name:"Compliance Wellcome Standard"},compliance_wellcome_deluxe:{short_name:"Compliance Wellcome Deluxe"},provenance:{short_name:"Provenance"}};try{n.svc.oaworks=JSON.parse(SECRETS_OAWORKS)}catch(e){n.svc.oaworks={}}r.svc.oaworks=function(){return"{}"!==JSON.stringify(this.params)?{status:404}:{name:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built}},r.svc.oaworks.templates={_key:"name",_sheet:"16Qm8n3Rmx3QyttFpSGj81_7T6ehfLAtYRSvmDf3pAzg/1"},r.svc.oaworks.deposit=async function(e,t,i){var r,n,s,a,l,o,u,c,h,p,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G,H,K,Q,Z,ee,te,ie,re,ne,se,ae,le,oe,ue,ce,he,pe,de,fe,me,ye,ge,ve;for(null==e&&(e=this.copy(this.params)),null==t&&(t=this.request.files),h={zenodo:{}},m=0,_=(I=["embedded","demo","pilot","live","email","plugin"]).length;m<_;m++)h[v=I[m]]=e[v];if(h.pilot=!0===h.pilot?Date.now():void 0,h.live=!0===h.live?Date.now():void 0,null!=t&&t.length&&(h.name=null!=(P=t[0].filename)?P:t[0].name),"anonymous"!==e.from&&(h.from=e.from),e.confirmed&&(h.confirmed=decodeURIComponent(e.confirmed)),ye=e.config,"string"==typeof e.config&&(ye=JSON.parse(e.config)),!e.config&&e.from&&(ye=await this.fetch("https://"+(this.S.dev||i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from)),(null!=(B=(E=await this.svc.oaworks.permissions(e.metadata)).file)?B.archivable:void 0)&&(null!=h.confirmed&&h.confirmed===E.file.checksum||!h.confirmed)){for((ve={content:t[0].data,name:E.file.name}).publish=!0===(null!=(Z=this.S.svc.oaworks)&&null!=(le=Z.deposit)?le.zenodo:void 0),c=[],g=0,w=(ce=null!=(oe=null!=(ue=e.metadata)?ue.author:void 0)?oe:[]).length;g<w;g++)if(null!=(r=ce[g]).family){s={name:r.family+(r.given?", "+r.given:"")};try{r.ORCID&&(s.orcid=r.ORCID.split("/").pop())}catch(e){}try{"object"==typeof r.affiliation&&null!=r.affiliation.name&&(s.affiliation=r.affiliation.name)}catch(e){}c.push(s)}0===c.length&&(c=[{name:"Unknown"}]),p=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(p=(p+=null!=(he=null!=(pe=E.best_permission)?pe.deposit_statement:void 0)?he:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+d.metadata.doi:"").trim()).lastIndexOf(".")!==p.length-1&&(p+="."),p.length&&(p+=" "),p+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",S={title:null!=(q=e.metadata.title)?q:"Unknown",description:p.trim(),creators:c,version:"preprint"===E.file.version?"Submitted Version":"postprint"===E.file.version?"Accepted Version":"publisher pdf"===E.file.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},null!=e.metadata.doi?!(y=await this.src.zenodo.records.doi(e.metadata.doi))||h.confirmed===E.file.checksum||this.S.dev||i?y?S.related_identifiers=[{relation:"postprint"===S.version||"AAM"===S.version||"preprint"===S.version?"isPreviousVersionOf":"isIdenticalTo",identifier:d.metadata.doi}]:S.doi=e.metadata.doi:h.zenodo.already=y.id:(null!=(L=this.S.svc.oaworks.zenodo)?L.prereserve_doi:void 0)&&(S.prereserve_doi=!0),S.access_right="open",S.license=null!=(R=null!=(T=E.best_permission)?T.licence:void 0)?R:"cc-by",-1!==S.license.indexOf("other")&&-1!==S.license.indexOf("closed")&&(S.license="other-closed"),-1!==S.license.indexOf("other")&&-1!==S.license.indexOf("non")&&-1!==S.license.indexOf("commercial")&&(S.license="other-nc"),0===S.license.toLowerCase().indexOf("cc")&&isNaN(parseInt(S.license.substring(S.license.length-1)))&&(S.license+="-4.0");try{(null!=(U=E.best_permission)?U.embargo_end:void 0)&&moment(E.best_permission.embargo_end,"YYYY-MM-DD").valueOf()>Date.now()&&(S.access_right="embargoed",S.embargo_date=E.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(S.publication_date=e.metadata.published)}catch(e){}if(ye){if(null!=ye.community_ID&&null==ye.community&&(ye.community=ye.community_ID),ye.community)for(null==ye.communities&&(ye.communities=[]),b=0,x=(D="string"==typeof ye.community?ye.community.split(","):ye.community).length;b<x;b++)o=D[b],ye.communities.push({identifier:o});if(null!=ye.community||null!=ye.communities)for(null==ye.communities&&(ye.communities=ye.community),Array.isArray(ye.communities)||(ye.communities=[ye.communities]),S.communities=[],A=0,O=(N=ye.communities).length;A<O;A++)u=N[A],S.communities.push("string"==typeof u?{identifier:u}:u)}if(de=this.S.dev||i||h.demo?null!=(M=this.S.svc.oaworks)&&null!=(z=M.zenodo)?z.sandbox:void 0:null!=(J=this.S.svc.oaworks)&&null!=(W=J.zenodo)?W.token:void 0){if(!h.zenodo.already)if((ge=await this.src.zenodo.deposition.create(S,ve,de)).id)h.zenodo.id=ge.id,h.zenodo.url="https://"+(this.S.dev||i||h.demo?"sandbox.":"")+"zenodo.org/record/"+ge.id,null!=(null!=(X=ge.metadata)&&null!=(Y=X.prereserve_doi)?Y.doi:void 0)&&(h.zenodo.doi=ge.metadata.prereserve_doi.doi),h.zenodo.file=null!=(V=null!=(F=ge.uploaded)&&null!=($=F.links)?$.download:void 0)?V:null!=(G=ge.uploaded)&&null!=(H=G.links)?H.download:void 0;else{h.error="Deposit to Zenodo failed";try{h.error+=": "+JSON.stringify(ge)}catch(e){}}}else h.error="No Zenodo credentials available"}if(null!=(null!=(K=E.file)?K.version:void 0)&&(h.version=E.file.version),h.zenodo.id?((null!=(Q=E.best_permission)?Q.embargo_end:void 0)&&moment(E.best_permission.embargo_end,"YYYY-MM-DD").valueOf()>Date.now()&&(h.embargo=E.best_permission.embargo_end),h.type="zenodo"):null!=h.error&&-1!==h.error.toLowerCase().indexOf("zenodo")?h.type="review":options.from&&(!h.embedded||-1===h.embedded.indexOf("oa.works")&&-1===h.embedded.indexOf("openaccessbutton.org")&&-1===h.embedded.indexOf("shareyourpaper.org"))?h.type=options.redeposit?"redeposit":null!=t&&t.length?"forward":"dark":h.type="review",l=["joe@openaccessbutton.org","natalia.norori@openaccessbutton.org"],me=[],"string"==typeof(null!=ye?ye.owner:void 0)&&-1!==ye.owner.indexOf("@")?me.push(ye.owner):ye.email&&me.push(ye.email),0===me.length&&(me=this.copy(l),l=[]),h.url="string"==typeof options.redeposit?options.redeposit:options.url?options.url:void 0,null!=(null!=(ee=(f=this.copy(h)).metadata)?ee.author:void 0)){for(n=[],C=0,k=(te=f.metadata.author).length;C<k;C++)(a=te[C]).family&&n.push((a.given?a.given+" ":"")+a.family);f.metadata.author=n}return f.adminlink=f.embedded?f.embedded:"https://shareyourpaper.org"+(null!=(null!=(ie=f.metadata)?ie.doi:void 0)?"/"+f.metadata.doi:""),f.adminlink+=-1===f.adminlink.indexOf("?")?"?":"&",null!=(null!=E&&null!=(re=E.file)?re.checksum:void 0)&&(f.confirmed=encodeURIComponent(E.file.checksum),f.adminlink+="confirmed="+f.confirmed+"&"),f.adminlink+="email="+f.email,fe=(fe=await this.svc.oaworks.templates(h.type+"_deposit.html")).content,!1!==(null!=(ne=E.file)?ne.archivable:void 0)&&(j={from:"deposits@openaccessbutton.org",to:me,template:fe,vars:f,subject:null!=(se=sub.subject)?se:h.type+" deposit",html:sub.content},l.length&&(j.bcc=l),Array.isArray(t)&&t.length&&(j.attachments=[{filename:null!=(ae=t[0].filename)?ae:t[0].name,content:t[0].data}]),this.waitUntil(this.mail(j))),h},r.svc.oaworks.deposit._index=!0;o=[].indexOf;r.svc.oaworks.metadata=async function(e){var t;return null!=(t=await this.svc.oaworks.find(e))?t.metadata:void 0},r.svc.oaworks.find=async function(e,t={},i){var r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k;O={},n=async e=>{var i,r;for(r in i=await this.svc.oaworks.citation(e))"url"===r||"paywall"===r?null==O[r]&&(O[r]=i[r]):null==t[r]&&(t[r]=i[r]);return!0},"string"==typeof e&&(e={doi:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(f=e.dom)?f:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(0===e.find.indexOf("10.")&&-1!==e.find.indexOf("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),-1!==e.url.indexOf("/10.")&&-1!==(u="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).indexOf("/")&&u.split("/")[0].length>6&&u.length>8&&((c=u.split("/")).length>2&&(u=c.join("/")),null==t.doi&&(t.doi=u)),0===e.url.replace("doi:","").replace("doi.org/","").trim().indexOf("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):0===e.url.toLowerCase().indexOf("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&-1===e.url.indexOf(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null==t.title&&0!==e.url.indexOf("http")&&(-1!==e.url.indexOf("{")||(null!=(y=e.url.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(g=e.url.match(/\(/gi))?g:[]).length>2?e.citation=e.url:t.title=e.url),0===e.url.indexOf("http")&&-1!==e.url.indexOf(".")||delete e.url),"string"==typeof e.title&&(-1!==e.title.indexOf("{")||(null!=(v=e.title.replace("...","").match(/\./gi))?v:[]).length>3||(null!=(b=e.title.match(/\(/gi))?b:[]).length>2)&&(e.citation=e.title,delete e.title),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(_=e.pmcid)?_:e.pmc),e.citation&&await n(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}if("string"==typeof t.doi&&0===t.doi.indexOf("10.")||delete t.doi,t.title||!i||"string"!=typeof e.url||-1===e.url.indexOf("alma.exlibrisgroup.com")&&-1===e.url.indexOf("/exlibristest")||delete e.url,null!=e.demo&&(O.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&0===t.doi.indexOf("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(w=e.from)||"eZwJ83xp3oZDaec86"===w)&&null==O.demo&&(O.demo=!0),O.demo&&null==O.test&&(O.test=!0),a=async()=>{var r,s,a,l,o,u,c;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(c=await this.svc.oaworks.scrape(null!=i?i:e.url),await n(c)),t.doi||((t.pmid||t.pmcid)&&(l=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(u=t.pmcid)?u:t.pmid),await n(l)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(a=await this.src.crossref.works.title(t.title))?a.type:void 0)&&(null!=a?a.DOI:void 0)&&await n(a),t.doi||(null!=(o=await this.src.microsoft.graph(t.title))?o.PaperTitle:void 0)&&await n(o),t.doi||null!=l||(l=await this.src.epmc.title(t.title),await n(l)))),t.doi&&(async()=>{var e,i,r,n,s,a,l,o,u;if(null!=(null!=(i=await this.src.fatcat(t.doi))?i.files:void 0))for(n=0,a=(u=i.files).length;n<a;n++)if(-1!==(e=u[n]).mimetype.toLowerCase().indexOf("pdf")&&"active"===e.state)for(s=0,l=(o=e.urls).length;s<l;s++)if((r=o[s]).url&&"webarchive"===r.rel){O.url=r.url;break}return!0},s=async()=>{var e;return(null!=(e=await this.src.oadoi(t.doi))?e.doi:void 0)&&(null!=e?e.doi.toLowerCase():void 0)===t.doi.toLowerCase()&&await n(e),!0},r=async()=>((null!=(a=await this.src.crossref.works(t.doi))?a.type:void 0)?await n(a):(O.doi_not_in_crossref=t.doi,"string"==typeof e.url&&-1!==e.url.indexOf("doi.org/"+t.doi)&&delete e.url,delete t.doi),!0),await Promise.all([s(),r()])),!0},await a(),!t.doi&&!i&&!e.url&&("undefined"==typeof epmc||null===epmc)&&t.title&&t.title.length>8&&t.title.split(" ").length>1)try{d=unidecode(t.title.toLowerCase()).replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),null!=(null!=(o=await this.src.microsoft.bing.search(d))?o.data:void 0)&&o.data.length&&(l=unidecode(o.data[0].name.toLowerCase()).replace("(pdf)","").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),0!==d.replace(/ /g,"").indexOf(l.replace(/ /g,""))||await this.svc.oaworks.blacklist(o.data[0].url)||(e.url=o.data[0].url.replace(/"/g,""),"string"==typeof e.url&&-1!==e.url.indexOf("pubmed.ncbi")&&(t.pmid=e.url.replace(/\/$/,"").split("/").pop()),"string"==typeof e.url&&-1!==e.url.indexOf("/10.")&&null==t.doi&&(t.doi="10."+e.url.split("/10.")[1]))),(t.doi||t.pmid||e.url)&&await a()}catch(e){}for(r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==O.ill&&(O.ill={subscription:await this.svc.oaworks.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},s=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==O.permissions&&(O.permissions=await this.svc.oaworks.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),s()]),h=0,p=(x=["title","journal","year","doi"]).length;h<p;h++)e[k=x[h]]&&e[k]!==t[k]&&(t[k]=e[k]);return O.metadata=t,O},r.svc.oaworks.citation=function(e){var t,i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G,H,K,Q,Z,ee,te,ie,re,ne,se,ae,le,oe,ue,ce,he,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,Ae,Se,je,Ce,Ee,Ie,Pe,qe,Le,Re,Te,Ue,De,Ne,Me,ze,Je,Be,We,Xe,Ye;Ne={};try{null==e&&(e=null!=(R=this.params.citation)?R:this.params)}catch(e){}if("string"==typeof e&&(0===e.indexOf("{")||0===e.indexOf("[")))try{e=JSON.parse(e)}catch(e){}if("object"==typeof e){Ne.doi=null!=(T=e.DOI)?T:e.doi,e.pmid&&(Ne.pmid=e.pmid),e.pmcid&&(Ne.pmcid=e.pmcid);try{Ne.type=null!=(V=e.type)?V:e.genre}catch(e){}null==Ne.issn&&(Ne.issn=null!=(re=null!=(fe=null!=(Ae=e.ISSN)?Ae:e.issn)?fe:null!=(Re=e.journalInfo)&&null!=(Te=Re.journal)?Te.issn:void 0)?re:null!=(Ue=e.journal)?Ue.issn:void 0),null!=(null!=(De=e.journalInfo)&&null!=(U=De.journal)?U.eissn:void 0)&&(null==Ne.issn&&(Ne.issn=[]),"string"==typeof Ne.issn&&(Ne.issn=[Ne.issn]),Ne.issn.push(e.journalInfo.journal.eissn)),e.journal_issns&&null==Ne.issn&&(Ne.issn=e.journal_issns.split(","));try{Array.isArray(e.title)&&null==Ne.title&&(Ne.title=e.title[0])}catch(e){}try{null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(Ne.title+=": "+e.subtitle[0])}catch(e){}null==Ne.title&&(Ne.title=null!=(D=e.dctitle)?D:null!=(N=e.bibjson)?N.title:void 0),404!==(M=e.title)&&"404"!==M&&null==Ne.title&&(Ne.title=e.title),"string"==typeof Ne.title&&(Ne.title=Ne.title.replace(/\s\s+/g," ").trim());try{null==Ne.journal&&(Ne.journal=e["container-title"][0])}catch(e){}try{Ne.shortname=e["short-container-title"][0]}catch(e){}try{Ne.shortname=null!=(z=e.journalInfo.journal.isoabbreviation)?z:e.journalInfo.journal.medlineAbbreviation}catch(e){}null==Ne.journal&&(Ne.journal=null!=(J=null!=(B=e.journal_name)?B:null!=(W=e.journalInfo)&&null!=(X=W.journal)?X.title:void 0)?J:null!=(Y=e.journal)?Y.title:void 0),e.journal&&(Ne.journal=e.journal.split("(")[0].trim());try{for(c=0,m=(F=["title","journal"]).length;c<m;c++)Ne[d=F[c]]=Ne[d].charAt(0).toUpperCase()+Ne[d].slice(1)}catch(e){}null==Ne.publisher&&(Ne.publisher=e.publisher),Ne.publisher&&(Ne.publisher=Ne.publisher.trim());try{null!=e.issue&&null==Ne.issue&&(Ne.issue=e.issue)}catch(e){}try{(null!=($=e.journalInfo)?$.issue:void 0)&&null==Ne.issue&&(Ne.issue=e.journalInfo.issue)}catch(e){}try{null!=e.volume&&null==Ne.volume&&(Ne.volume=e.volume)}catch(e){}try{(null!=(G=e.journalInfo)?G.volume:void 0)&&null==Ne.volume&&(Ne.volume=e.journalInfo.volume)}catch(e){}try{null!=e.page&&null==Ne.page&&(Ne.page=e.page.toString())}catch(e){}e.pageInfo&&(Ne.page=e.pageInfo.toString()),(e.abstract||e.abstractText)&&(Ne.abstract=null!=(H=e.abstract)?H:e.abstractText);try{Ne.abstract&&(Ne.abstract=this.convert.html2txt(Ne.abstract).replace(/\n/g," ").replace("Abstract ",""))}catch(e){}for(h=0,y=(K=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited","indexed"]).length;h<y;h++)if(E=K[h],!Ne.published||Ne.DOI){if(ze=null!=(Q=null!=(Z=e[E])?Z:null!=(ee=e["journal-issue"])?ee[E.replace("journal-issue.","")]:void 0)?Q:null!=(te=e.journalInfo)?te[E.replace("journalInfo.","")]:void 0){"number"==typeof ze&&(ze=ze.toString());try{"string"!=typeof ze&&(ze=ze["date-time"].toString())}catch(e){}if("string"!=typeof ze)try{for(p in ze["date-parts"][0])"number"!=(ie=typeof ze["date-parts"][0][p])&&"string"!==ie&&(ze["date-parts"][0][p]="01");ze=ze["date-parts"][0].join("-")}catch(e){}"string"==typeof ze&&(Ne.published=-1!==ze.indexOf("T")?ze.split("T")[0]:ze,Ne.published=Ne.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),-1===Ne.published.indexOf("-")&&(Ne.published+="-01"),3!==Ne.published.split("-").length&&(Ne.published+="-01"),null==Ne.year&&(Ne.year=Ne.published.split("-")[0]),3!==Ne.published.split("-").length&&delete Ne.published,4!==Ne.year.length&&delete Ne.year)}if(Ne.published)break}e.year&&null==Ne.year&&(Ne.year=e.year);try{null==Ne.year&&(Ne.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(null==Ne.author&&(null!=e.author||null!=e.z_authors||(null!=(ne=e.authorList)?ne.author:void 0))){null==Ne.author&&(Ne.author=[]);try{for(le=null!=(se=null!=(ae=e.author)?ae:e.z_authors)?se:e.authorList.author,j=0,g=le.length;j<g;j++)if("string"==typeof(t=le[j]))Ne.author.push({name:t});else{if((n={}).given=null!=(oe=t.given)?oe:t.firstName,n.family=null!=(ue=t.family)?ue:t.lastName,n.name=(n.given?n.given+" ":"")+(null!=(ce=n.family)?ce:""),null!=t.affiliation)try{for(he=n.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:n.authorAffiliationDetailsList.authorAffiliation,C=0,v=he.length;C<v;C++)"string"==typeof(i=he[C])?(null==n.affiliation&&(n.affiliation=[]),n.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==n.affiliation&&(n.affiliation=[]),n.affiliation.push({name:(null!=(pe=i.name)?pe:i.affiliation).replace(/\s\s+/g," ").trim()}))}catch(e){}Ne.author.push(n)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(Ne.subject=e.subject)}catch(e){}try{null!=(null!=(de=e.keywordList)?de.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(Ne.keyword=e.keywordList.keyword)}catch(e){}try{for(be=[...null!=(me=null!=(ye=e.meshHeadingList)?ye.meshHeading:void 0)?me:[],...null!=(ge=null!=(ve=e.chemicalList)?ve.chemical:void 0)?ge:[]],q=0,b=be.length;q<b;q++)A=be[q],null==Ne.keyword&&(Ne.keyword=[]),"string"==typeof(S="string"==typeof A?A:null!=(_e=A.name)?_e:A.descriptorName)&&S&&o.call(Ne.keyword,S)<0&&Ne.keyword.push(S)}catch(e){}"string"==typeof e.license&&(Ne.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(Ne.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(we=e.best_oa_location)?we.license:void 0)&&null!==(null!=(xe=e.best_oa_location)?xe.license:void 0)&&null==Ne.licence&&(Ne.licence=e.best_oa_location.license)}catch(e){}if(!Ne.licence){if(Array.isArray(e.assertion))for(L=0,_=(Oe=e.assertion).length;L<_;L++)"OPEN ACCESS"===(t=Oe[L]).label&&t.URL&&-1!==t.URL.indexOf("creativecommons")&&null==Ne.licence&&(Ne.licence=t.URL);if(Array.isArray(e.license))for(Je=0,w=(Se=null!=(ke=e.license)?ke:[]).length;Je<w;Je++)!(f=Se[Je]).URL||-1===f.URL.indexOf("creativecommons")||Ne.licence&&-1!==Ne.licence.indexOf("creativecommons")||null==Ne.licence&&(Ne.licence=f.URL)}if("string"==typeof Ne.licence&&-1!==Ne.licence.indexOf("/licenses/")&&(Ne.licence="cc-"+Ne.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Ne.url&&(Ne.url=null!=(je=null!=(Ce=e.best_oa_location)?Ce.url_for_pdf:void 0)?je:null!=(Ee=e.best_oa_location)?Ee.url:void 0),!Ne.url&&null!=(null!=(Ie=e.fullTextUrlList)?Ie.fullTextUrl:void 0))for(We=0,x=(Pe=e.fullTextUrlList.fullTextUrl).length;We<x;We++)"oa"!==(qe=(a=Pe[We]).availabilityCode.toLowerCase())&&"f"!==qe||Ne.url&&("pdf"!==a.documentStyle||-1!==Ne.url.indexOf("pdf"))||(Ne.url=a.url)}else if("string"==typeof e)try{-1!==(e=e.replace(/citation\:/gi,"").trim()).indexOf("title")&&(e=e.split("title")[1].trim()),-1!==(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).indexOf("doi:")&&(Ne.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),-1!==e.indexOf("doi.org/")&&(Ne.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),Ne.doi||-1===e.indexOf("http")||(Ne.url="http"+e.split("http")[1].split(" ")[0].trim());try{-1===e.indexOf("|")&&-1===e.indexOf("}")||(Ne.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?Ne.title=e.split('"')[1].trim():e.split("'").length>2&&null==Ne.title&&(Ne.title=e.split("'")[1].trim())}catch(e){}try{for(P=e.replace(/,\./g," ").split(" "),Xe=0,O=P.length;Xe<O;Xe++)I=P[Xe],Ne.year||4===(I=I.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Be=parseInt(I))||isNaN(Be)||(Ne.year=Be))}catch(e){}try{!Ne.title&&Ne.year&&e.indexOf(Ne.year)<e.length/4&&(Ne.title=e.split(Ne.year)[1].trim(),(-1===Ne.title.indexOf("(")||Ne.title.indexOf(")")<Ne.title.indexOf("("))&&(Ne.title=Ne.title.replace(")","")),Ne.title.indexOf(".")<3&&(Ne.title=Ne.title.replace(".","")),Ne.title.indexOf(",")<3&&(Ne.title=Ne.title.replace(",","")),Ne.title=Ne.title.trim(),-1!==Ne.title.indexOf(".")?Ne.title=Ne.title.split(".")[0]:-1!==Ne.title.indexOf(",")&&(Ne.title=Ne.title.split(",")[0]))}catch(e){}if(Ne.title){try{if(s=e.split(Ne.title)[0],Ne.year&&-1!==s.indexOf(Ne.year)&&(s=s.split(Ne.year)[0]),Ne.url&&s.indexOf(Ne.url)>0&&(s=s.split(Ne.url)[0]),Ne.url&&0===s.indexOf(Ne.url)&&(s=s.replace(Ne.url)),Ne.doi&&0===s.indexOf(Ne.doi)&&(s=s.replace(Ne.doi)),s.indexOf(".")<3&&(s=s.replace(".","")),s.indexOf(",")<3&&(s=s.replace(",","")),s.lastIndexOf("(")>s.length-3&&(s=s.substring(0,s.lastIndexOf("("))),s.lastIndexOf(")")>s.length-3&&(s=s.substring(0,s.lastIndexOf(")"))),s.lastIndexOf(",")>s.length-3&&(s=s.substring(0,s.lastIndexOf(","))),s.lastIndexOf(".")>s.length-3&&(s=s.substring(0,s.lastIndexOf("."))),(s=s.trim()).length>6)if(-1!==s.indexOf(","))for(Ne.author=[],Le=s.split(","),Ye=0,k=Le.length;Ye<k;Ye++)r=Le[Ye],Ne.author.push({name:r});else Ne.author=[{name:s}]}catch(e){}try{Me=e.split(Ne.title)[1],Ne.url&&-1!==Me.indexOf(Ne.url)&&(Me=Me.replace(Ne.url)),Ne.doi&&-1!==Me.indexOf(Ne.doi)&&(Me=Me.replace(Ne.doi)),Me.indexOf(".")<3&&(Me=Me.replace(".","")),Me.indexOf(",")<3&&(Me=Me.replace(",","")),(Me=Me.trim()).length>6&&(Ne.journal=Me,-1!==Me.indexOf(",")&&(Ne.journal=Ne.journal.split(",")[0].replace(/in /gi,"").trim()),Ne.journal.indexOf(".")<3&&(Ne.journal=Ne.journal.replace(".","")),Ne.journal.indexOf(",")<3&&(Ne.journal=Ne.journal.replace(",","")),Ne.journal=Ne.journal.trim())}catch(e){}}try{if(Ne.journal&&(Me=e.split(Ne.journal)[1],Ne.url&&-1!==Me.indexOf(Ne.url)&&(Me=Me.replace(Ne.url)),Ne.doi&&-1!==Me.indexOf(Ne.doi)&&(Me=Me.replace(Ne.doi)),Me.indexOf(".")<3&&(Me=Me.replace(".","")),Me.indexOf(",")<3&&(Me=Me.replace(",","")),(Me=Me.trim()).length>4)){if(-1!==Me.indexOf("retrieved")&&(Me=Me.split("retrieved")[0]),-1!==Me.indexOf("Retrieved")&&(Me=Me.split("Retrieved")[0]),Ne.volume=Me,-1!==Ne.volume.indexOf("(")){Ne.volume=Ne.volume.split("(")[0],Ne.volume=Ne.volume.trim();try{Ne.issue=Me.split("(")[1].split(")")[0],Ne.issue=Ne.issue.trim()}catch(e){}}if(-1!==Ne.volume.indexOf(",")){Ne.volume=Ne.volume.split(",")[0],Ne.volume=Ne.volume.trim();try{Ne.issue=Me.split(",")[1],Ne.issue=Ne.issue.trim()}catch(e){}}if(Ne.volume)try{isNaN(parseInt(Ne.volume))&&delete Ne.volume}catch(e){}if(Ne.issue){-1!==Ne.issue.indexOf(",")&&(Ne.issue=Ne.issue.split(",")[0].trim());try{isNaN(parseInt(Ne.issue))&&delete Ne.issue}catch(e){}}if(Ne.volume&&Ne.issue)try{-1!==(Me=e.split(Ne.journal)[1]).indexOf("retriev")&&(Me=Me.split("retriev")[0]),-1!==Me.indexOf("Retriev")&&(Me=Me.split("Retriev")[0]),Ne.url&&-1!==Me.indexOf(Ne.url)&&(Me=Me.split(Ne.url)[0]),Ne.doi&&-1!==Me.indexOf(Ne.doi)&&(Me=Me.split(Ne.doi)[0]),(Me=(Me=Me.substring(Me.indexOf(Ne.volume)+(Ne.volume+"").length)).substring(Me.indexOf(Ne.issue)+(Ne.issue+"").length)).indexOf(".")<2&&(Me=Me.replace(".","")),Me.indexOf(",")<2&&(Me=Me.replace(",","")),Me.indexOf(")")<2&&(Me=Me.replace(")","")),Me=Me.trim(),isNaN(parseInt(Me.substring(0,1)))||(Ne.pages=Me.split(" ")[0].split(".")[0].trim(),Ne.pages.length>5&&(Ne.pages=Ne.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(Ne.author||-1===e.indexOf("et al")||(u=e.split("et al")[0].trim(),0===e.indexOf(u)&&(Ne.author=[{name:u+"et al"}])),Ne.title&&!Ne.volume)try{-1!==(l=e.split(Ne.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).indexOf("vol")&&(Ne.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),Ne.issue||-1===l.indexOf("iss")||(Ne.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),Ne.pages||-1===l.indexOf("page")||(Ne.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return Ne},r.svc.oaworks.availability=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&-1!==e.availability.indexOf("/")?e.doi=e.availability:-1!==e.availability.indexOf(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(s=null!=(a=null!=(g=null!=(_=null!=(w=null!=(x=null!=(O=null!=(k=e.doi)?k:e.pmid)?O:e.pmc)?x:e.pmcid)?w:e.title)?_:e.url)?g:e.id)?a:e.citation)?s:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.svc.oaworks.find(e)),null!=i.v2){null==(r=i.data).match&&(r.match=null!=(A=null!=(S=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(h=i.v2.metadata)?h.doi:void 0)?u:null!=(p=i.v2.metadata)?p.title:void 0)?o:null!=(d=i.v2.metadata)?d.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?S:null!=(m=i.v2.metadata)?m.pmcid:void 0)?A:null!=(y=i.v2.metadata)?y.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(n=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(C=await this.fetch("https://"+(this.S.dev?"dev.":"")+"api.cottagelabs.com/service/oab/requests?q="+n+" AND type:article&sort=createdAt:desc"))&&null!=(v=C.hits)?v.total:void 0)&&((E={type:"article",_id:(j=C.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(b=j.user)?b.id:void 0)!==e.uid),i.data.requests.push(E))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},r.svc.oaworks.availability._hidden=!0;o=[].indexOf;r.svc.oaworks.ill=async function(e){var t,i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x;null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.svc.oaworks.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),n=e.config;try{n=JSON.parse(n)}catch(e){}for(p in("string"==typeof n||!n&&e.from)&&(null!=(n=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:n)))&&"{}"!==JSON.stringify(n)||(n=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(y=e.from)?y:n)))),x={name:"librarian",details:""},d=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(h in e[p])"email"!==h&&(e[h]=e[p][h],o.call(d,h)<0&&d.push(h));delete e.metadata}else o.call(d,p)<0&&d.push(p);for(a=0,u=d.length;a<u;a++)if(e[f=d[a]]&&(x[f]=e[f],"author"===f)){for("<p>Authors:<br>",s=!0,r=[],l=0,c=(g=e[f]).length;l<c;l++)(t=g[l]).family&&(s?s=!1:", ",i=t.family+(t.given?" "+t.given:""),r.push(i));x[f]=r}return null!=e.author&&delete e.author,x.illid=e._id=await this.uid(),n.search&&n.search.length&&(e.issn||e.journal)&&(-1!==n.search.indexOf("worldcat")?(_=n.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",_+=null!=e.issn?"in%3A":"ti%3A",_+="&si0qs="+(null!=(v=e.issn)?v:e.journal),_+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(_=n.search,_+=e.issn?e.issn:e.journal),x.worldcatsearchurl=_),w=(w=await this.svc.oaworks.templates("instantill_create.html")).content,e.forwarded||e.resolved||!n.email&&!e.email||this.mail({svc:"oaworks",vars:x,template:w,to:null!=(b=n.email)?b:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id}),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:x,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:"mark@cottagelabs.com"})),e},r.svc.oaworks.ill._index=!0,r.svc.oaworks.ill.collect=async function(e){var t,i,r;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},r.svc.oaworks.ill.openurl=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d;for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.svc.oaworks.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),n={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=n[r]);for(a in p="",e.ill_added_params&&(p+=e.ill_added_params.replace("?","")+"&"),p+=e.sid+"=InstantILL&",t){if(d="","author"===a)for(s=0,l=(h=Array.isArray(t.author)?t.author:[t.author]).length;s<l;s++)i=h[s],d.length&&(d+=", "),d+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==a&&"pmid"!==a&&"pmc"!==a&&"pmcid"!==a&&"url"!==a&&"journal"!==a&&"title"!==a&&"year"!==a&&"issn"!==a&&"volume"!==a&&"issue"!==a&&"page"!==a&&"crossref_type"!==a&&"publisher"!==a&&"published"!==a&&"notes"!==a||(d=t[a]);d&&(p+=(e[a]?e[a]:a)+"="+encodeURIComponent(d)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(p=p.replace("usermetadata=true","")).indexOf(o+"=")?p+="&"+o+"=The user provided some metadata.":p=p.replace(o+"=",o+"=The user provided some metadata. ")),p.replace("/&&/g","&")},r.svc.oaworks.ill.subscription=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g;if(null==e&&(e=null!=(l=this.params.config)?l:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(h in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s=await this.svc.oaworks.ill.openurl(e,t),e.ill_added_params&&(s=s.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(d=e.subscription[h])?(f=d.type,d=d.url):f=null!=(u=e.subscription_type[h])?u:"unknown",d=d.trim()){"serialssolutions"===f||-1!==d.indexOf("serialssolutions")?(-1!==(y=d.split(".search")[0]).indexOf("//")&&(y=y.split("//")[1]),d="http://"+y+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===d.indexOf("sfx.")||-1!==d.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===d.indexOf(".exlibris")||-1!==d.indexOf("response_type")||(d=d.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):d+=(-1===d.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=d+(-1===d.indexOf("?")?"?":"&")+s).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==d.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==d.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),a="",p="",i=!1,c.lookups.push(g);try{p=-1!==(a=-1!==g.indexOf(".xml.serialssolutions")||-1!==g.indexOf("sfx.response_type=simplexml")||-1!==g.indexOf("response_type=xml")?await this.fetch(g):await this.puppet(g)).indexOf("<body")?a.toLowerCase().split("<body")[1].split("</body")[0]:a,c.contents.push(p)}catch(e){e,i=!0}if("sfx"===f||-1!==g.indexOf("sfx.")){if(i&&c.error.push("sfx"),-1!==p.indexOf("getFullTxt")&&-1!==p.indexOf("<target_url>"))try{if(c.url=p.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url){if(-1===c.url.indexOf("getitnow"))return c.found="sfx",c;c.url=void 0,c.findings.sfx=void 0}}catch(e){}else if(-1!==p.indexOf('<a title="navigate to target in new window')&&-1!==p.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="sfx",c;c.url=void 0,c.findings.sfx=void 0}}else if("eds"===f||-1!==g.indexOf("ebscohost.")){if(i&&c.error.push("eds"),-1!==p.indexOf("view this ")&&-1!==a.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+a.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="eds",c;c.url=void 0}}else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==p.indexOf('<ssopenurl:url type="article">')){if((r=p.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim()).length&&(c.url=r,c.findings.serials=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="serials",c;c.url=void 0,c.findings.serials=void 0}}else if(-1===p.indexOf("ss_noresults"))try{if(m=g.split("?")[0]+"?ShowSupressedLinks"+a.split("?ShowSupressedLinks")[1].split('">')[0],-1!==(n=await this.puppet(m)).indexOf("ArticleCL")&&-1!==n.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+n.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0],c.findings.serials=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="serials",c;c.url=void 0,c.findings.serials=void 0}}catch(e){i&&c.error.push("serialssolutions")}}else if(("exlibris"===f||-1!==g.indexOf(".exlibris"))&&(i&&c.error.push("exlibris"),-1!==p.indexOf("full_text_indicator")&&0===p.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==p.indexOf("resolution_url")))return c.url=p.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris",c}return c},r.svc.oaworks.journal=async function(e){var t;try{(null==e&&this.params.journal||this.params.issn)&&(e='"'+(null!=(t=this.params.journal)?t:this.params.issn)+'"')}catch(e){}try{return(await this.fetch("https://dev.api.cottagelabs.com/service/jct/journal?q="+e)).hits.hits[0]._source}catch(e){return}},r.svc.oaworks.oapublisher=async function(e){var t,i;try{null==e&&(e=this.params.publisher)}catch(e){}return i=await this.fetch('https://dev.api.cottagelabs.com/service/jct/journal?q=publisher:"'+e+'" AND NOT discontinued:true'),t=await this.fetch('https://dev.api.cottagelabs.com/service/jct/journal?q=publisher:"'+e+'" AND NOT discontinued:true AND isdoaj:true'),i.hits.total===t.hits.total};o=[].indexOf;r.svc.oaworks.permissions=async function(e,t,i){var r,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B,W,X,Y,V,F,$,G,H,K,Q,Z,ee,te,ie,re,ne,se,ae,le,oe,ue,ce,he,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,Ae,Se,je,Ce,Ee,Ie,Pe,qe,Le,Re,Te,Ue,De,Ne,Me;if(z=!1,h=!1,m=!1,s=async function(t){var i,r,s,a,l,o,u,c,p,d,f,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q;if(m&&t.embargo_months&&(e.published||e.year)&&(r=new Date(Date.parse(null!=(g=e.published)?g:e.year+"-01-01")),r=new Date(r.setMonth(r.getMonth()+t.embargo_months)),t.embargo_end=r.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name="publisher"===t.copyright_owner?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:"journal"===(v=t.copyright_owner)||"affiliation"===v?null!=(k=e.journal)?k:"":m&&t.copyright_owner&&-1!==t.copyright_owner.toLowerCase().indexOf("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(A=e.author[0].name)?A:e.author[0].family)+(e.author.length>1?" et al":""):"",("publisher"===(S=t.copyright_name)||"journal"===S)&&(h||e.doi||(null!=(j=t.provenance)?j.example:void 0))&&(!1===h&&(h=await this.src.crossref.works(null!=(C=e.doi)?C:t.provenance.example)),null!=(null!=h?h.assertion:void 0)&&h.assertion.length))for(l=0,u=(E=h.assertion).length;l<u;l++)if("copyright"===(i=E[l]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace(" ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(m&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,m&&null!=t.deposit_statement&&-1!==t.deposit_statement.indexOf("<<")){for(a="",o=0,c=(I=t.deposit_statement.split("<<")).length;o<c;o++)if(y=I[o],""===a&&-1===y.indexOf(">>"))a+=y;else{if(null!=(q={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(s=y.split(">>"))[0].toLowerCase()]&&(f=q[f]),"author"===f)try{a+=(null!=(P=e.author[0].name)?P:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else a+=null!=(b=null!=(_=e[f])?_:t[f])?b:"";try{a+=s[1]}catch(e){}}t.deposit_statement=a}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(n.dev?"dev.api.cottagelabs.com/svc/oaworks/permissions/":"api.openaccessbutton.org/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(w=t.issuer)?w.has_policy:void 0)||"not publisher"!==(x=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==x||(z=t.issuer.has_policy),d=0,p=(O=["_id","permission_required","createdAt","updatedAt","created_date","updated_date"]).length;d<p;d++)delete t[O[d]];try{delete t.issuer.updatedAt}catch(e){}return t},a=e=>{var t,i,r,n,s,a,l;return l=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(l+=1e3),null!=e.requirements?l-=10:l+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,null!=e.licences&&e.licences.length&&(l-=5),l+="journal"===(null!=(i=e.issuer)?i.type:void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type:void 0)?4:"university"===(null!=(n=e.issuer)?n.type:void 0)?3:(s=null!=(a=e.issuer)?a.type:void 0,o.call("article",s)>=0?2:0),e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(l-=25),l},"string"==typeof e&&(e=0===e.indexOf("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),null!=(null!=e?e.permissions:void 0)&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):0===e.permissions.indexOf("10.")&&-1!==e.permissions.indexOf("/")?e.doi=e.permissions:-1!==e.permissions.indexOf("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:-1===e.permissions.indexOf(" ")&&-1===e.permissions.indexOf(",")&&e.permissions.replace(/[0-9]/g,"").length!==e.permissions.length?e.ror=e.permissions:e.publisher=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&-1!==e.ror.indexOf(",")&&(e.ror=e.ror.split(",")),e.journal&&-1===e.journal.indexOf(" ")&&-1!==e.journal.indexOf("-")&&(e.issn=e.journal,delete e.journal),v=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&-1!==e.issn.indexOf(",")&&(e.issn=e.issn.split(",")),"{}"===JSON.stringify(e)||e.issn&&-1===JSON.stringify(e.issn).indexOf("-")||e.doi&&("string"!=typeof e.doi||0!==e.doi.indexOf("10.")||-1===e.doi.indexOf("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(r=async()=>{var t,i,r,n;if(i=this.copy(e),"{}"!==JSON.stringify(i)){for(t in r=[],n=await this.svc.oaworks.metadata(e.doi))r.push(null!=e[t]?e[t]:e[t]=n[t]);return r}},!1===i||!e.doi||e.publisher&&e.issn||await r(),!e.published&&e.year&&(e.published=e.year+"-01-01"),m=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!v.length)for(y=0,x=(G=e.issn).length;y<x;y++)g=G[y],o.call(v,g)<0&&v.push(g);v.length&&e.publisher&&e.doi||(l=await this.svc.oaworks.journal('issn.exact:"'+v.join('" OR issn.exact:"')+'"'))&&null==e.doi&&(e.doi=l.doi);try{null==e.doi&&(e.doi=await this.src.crossref.journals.doi(v))}catch(e){}if(!m&&e.doi){await r();try{if(null==e.publisher&&(e.publisher=l.publisher),null!=l?l.issn:void 0)for(H="string"==typeof l.issn?[l.issn]:l.issn,b=0,O=H.length;b<O;b++)c=H[b],o.call(v,c)<0&&v.push(c)}catch(e){}}}if(m&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&-1!==e.publisher.indexOf("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(ye=e.page)?ye:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ge=e.year)?ge:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(W={best_permission:void 0,all_permissions:[]},ke=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(je=await this.svc.oaworks.permission('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(ve=je.hits)?ve.total:void 0)&&(Ce=await this.src.wikidata('snaks.property.exact:"P6782" AND snaks.property.exact:"P17" AND (snaks.value.exact:"'+e.ror.join(" OR snaks.value.exact:")+'")')))for(Pe=!1,U=0,S=(we=null!=(be=null!=(_e=Ce.hits)?_e.hits:void 0)?be:[]).length;U<S&&(Oe=we[U],!Pe);U++)for(D=0,j=(xe=Oe._source.snaks).length;D<j&&(Ie=xe[D],!Pe);D++)if("P17"===Ie.property&&(p=await this.src.wikidata(Ie.qid)))for(N=0,C=(K=p.snaks).length;N<C;N++)if("P297"===(Ee=K[N]).property){Pe=!0,je=await this.svc.oaworks.permission('issuer.id:"'+Ee.value+'"');break}for(V=0,E=(ee=null!=(Q=null!=je&&null!=(Z=je.hits)?Z.hits:void 0)?Q:[]).length;V<E;V++)Se=ee[V],(Le=await s(Se._source)).score=await a(Le),ke.push(Le)}if((v.length||e.publisher)&&(F=v.length?'issuer.id:"'+v.join('" OR issuer.id:"')+'"':"",e.publisher&&(""!==F&&(F+=" OR "),F+='issuer.id:"'+e.publisher+'"'),null!=(null!=(Y=await this.svc.oaworks.permission(F))&&null!=(te=Y.hits)?te.hits:void 0)&&Y.hits.hits.length))for($=0,I=(ie=Y.hits.hits).length;$<I;$++)J=ie[$],(Ae=await s(J._source)).score=await a(Ae),W.all_permissions.push(Ae);if(0!==W.all_permissions.length||!e.publisher||e.doi||v.length||(null==(l=await this.svc.oaworks.journal('publisher:"'+e.publisher+'"'))&&((f=await this.svc.oaworks.journal('publisher:"'+e.publisher.split(" ").join('" AND publisher:"')+'"')).publisher===e.publisher?l=f:(R=(T=await this.tdm.levenshtein(f.publisher,e.publisher)).length.a>T.length.b?T.length.a:T.length.b,(T.distance<5||R/T.distance>10)&&(l=f))),(null!=l?l.publisher:void 0)&&(X=await this.svc.oaworks.oapublisher(l.publisher))),"object"==typeof l&&(l.indoaj||X)){u={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,licence_terms:"",licences:[],locations:["institutional repository"],embargo_months:void 0,issuer:{type:"journal",has_policy:"yes",id:l.issn},meta:{creator:["joe+doaj@openaccessbutton.org"],contributors:["joe+doaj@openaccessbutton.org"],monitoring:"Automatic"}};try{u.licence=null!=(re=l.doaj.bibjson.license[0].type)?re:l.license[0].type}catch(e){}l.indoaj?(u.embargo_months=0,u.provenance={oa_evidence:"In DOAJ"}):X&&(u.meta.creator=["joe+oapublisher@openaccessbutton.org"],u.meta.contributors=["joe+oapublisher@openaccessbutton.org"],u.provenance={oa_evidence:"OA publisher"}),"string"==typeof u.licence?(u.licence=u.licence.toLowerCase().trim(),0===u.licence.indexOf("cc")?u.licence=u.licence.replace(/ /g,"-"):-1!==u.licence.indexOf("creative")?u.licence=-1!==u.licence.indexOf("0")||-1!==u.licence.indexOf("zero")?"cc0":-1!==u.licence.indexOf("share")?"ccbysa":-1!==u.licence.indexOf("derivative")?"ccbynd":"ccby":delete u.licence):delete u.licence,u.licence&&(u.licences=[{type:u.licence,terms:""}]),u.score=await a(u),W.all_permissions.push(u)}if(e.doi&&(M=await this.src.oadoi(e.doi))&&m&&(null!=M&&null!=(ne=M.best_oa_location)?ne.license:void 0)&&-1!==M.best_oa_location.license.indexOf("cc")&&("string"==typeof(d={can_archive:!0,version:M.best_oa_location.version,versions:[],licence:M.best_oa_location.license,licence_terms:"",licences:[],locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:["support@unpaywall.org"],contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:M.best_oa_location.updated},provenance:{oa_evidence:M.best_oa_location.evidence}}).licence&&(d.licences=[{type:d.licence,terms:""}]),d.version&&(d.versions="submittedVersion"===(se=d.version)||"preprint"===se?["submittedVersion"]:"acceptedVersion"===(ae=d.version)||"postprint"===ae?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),d.score=await a(d),W.all_permissions.push(d)),W.all_permissions.length){for(W.all_permissions.sort((e,t)=>e.score<t.score?1:-1),qe=0,P=(le=W.all_permissions).length;qe<P;qe++){if(!(null!=(oe=(Ne=le[qe]).provenance)?oe.enforcement_from:void 0)){W.best_permission=this.copy(Ne);break}if(!e.published||Date.parse(e.published)>Date.parse(Ne.provenance.enforcement_from.split("/").reverse().join("-"))){W.best_permission=this.copy(Ne);break}}if(ke.length)for(ke.sort((e,t)=>e.score<t.score?1:-1),Re=0,q=ke.length;Re<q;Re++)if(Oe=ke[Re],W.all_permissions.push(Oe),null==(null!=(ue=W.best_permission)?ue.author_affiliation_requirement:void 0)&&null!=W.best_permission&&(!(null!=(ce=Oe.provenance)?ce.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(Oe.provenance.enforcement_from.split("/").reverse().join("-")))){for(B=this.copy(W.best_permission),Te=0,L=(he=["licences","versions","locations"]).length;Te<L;Te++)for(De=0,k=(pe=Oe[_=he[Te]]).length;De<k;De++)Ue=pe[De],null==B[_]&&(B[_]=[]),o.call(B[_],Ue)<0&&B[_].push(Ue);for(Me=0,A=(fe=null!=(de=B.licences)?de:[]).length;Me<A;Me++)w=fe[Me],(null==B.licence||w.type.length<B.licence.length)&&(B.licence=w.type);B.version=o.call(B.versions,"publishedVersion")>=0||o.call(B.versions,"publisher pdf")>=0?"publishedVersion":o.call(B.versions,"acceptedVersion")>=0||o.call(B.versions,"postprint")>=0?"acceptedVersion":"submittedVersion",B.embargo_end&&Oe.embargo_end&&Date.parse(Oe.embargo_end)<Date.parse(B.embargo_end)&&(B.embargo_end=Oe.embargo_end),B.embargo_months&&null!=Oe.embargo_months&&Oe.embargo_months<B.embargo_months&&(B.embargo_months=Oe.embargo_months),!0===Oe.can_archive&&(B.can_archive=!0),null==B.requirements&&(B.requirements={}),B.requirements.author_affiliation_requirement=null==e.ror?Oe.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],B.issuer.affiliation=Oe.issuer,null==B.meta&&(B.meta={}),B.meta.affiliation=Oe.meta,null==B.provenance&&(B.provenance={}),B.provenance.affiliation=Oe.provenance,B.score=parseInt(B.score)+parseInt(Oe.score),W.best_permission=B,W.all_permissions.push(B)}}return z?{body:"string"!=typeof z?z:null!=(me={"not publisher":"Please find another DOI for this article as this is provided as this doesnt allow us to find required information like who published it"}[z.toLowerCase()])?me:z,status:501}:W},r.svc.oaworks.permission=async function(e=[]){var t,i,r,n,s,a,l,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C,E,I,P,q,L,R,T,U,D,N,M,z,J,B;for("object"!=typeof e||Array.isArray(e)||(e=[e]),u={versionsarchivable:"versions",permissionsrequestcontactemail:"permissions_contact",archivinglocationsallowed:"locations",license:"licence",licencesallowed:"licences","post-printembargo":"embargo_months",depositstatementrequired:"deposit_statement",copyrightowner:"copyright_owner",publicnotes:"notes",authoraffiliationrolerequirement:"requirements.role",authoraffiliationrequirement:"requirements.affiliation",authoraffiliationdepartmentrequirement:"requirements.departmental_affiliation",iffundedby:"requirements.funder",fundingproportionrequired:"requirements.funding_proportion",subjectcoverage:"requirements.subject",has_policy:"issuer.has_policy",permissiontype:"issuer.type",parentpolicy:"issuer.parent_policy",contributedby:"meta.contributors",recordlastupdated:"meta.updated",reviewers:"meta.reviewer",addedby:"meta.creator",monitoringtype:"meta.monitoring",policyfulltext:"provenance.archiving_policy",policylandingpage:"provenance.archiving_policy_splash",publishingagreement:"provenance.sample_publishing_agreement",publishingagreementsplash:"provenance.sample_publishing_splash",rights:"provenance.author_rights",embargolist:"provenance.embargo_list",policyfaq:"provenance.faq",miscsource:"provenance.misc_source",enforcementdate:"provenance.enforcement_from",example:"provenance.example"},P=[],s=0,d=e.length;s<d;s++){q=e[s],S={can_archive:!1,version:void 0,versions:void 0,licence:void 0,licence_terms:void 0,licences:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,permission_required:void 0,permissions_contact:void 0,copyright_owner:void 0,copyright_name:void 0,copyright_year:void 0,notes:void 0,requirements:void 0,issuer:{},meta:{},provenance:void 0};try{if(q.recordlastupdated=q.recordlastupdated.trim(),-1!==q.recordlastupdated.indexOf(",")){for(x=!1,L=q.recordlastupdated.split(","),a=0,f=L.length;a<f;a++)n=L[a],(!1===x||Date.parse(n.trim().split("/").reverse().join("-"))>Date.parse(x.split("/").reverse().join("-")))&&(x=n.trim());!1!==x&&(q.recordlastupdated=x)}S.meta.updated=q.recordlastupdated}catch(e){}if(null!=S.meta.updated&&(S.meta.updatedAt=Date.parse(S.meta.updated.split("/").reverse().join("-"))),S.issuer.id=-1!==q.id.indexOf(",")?q.id.split(","):q.id,"string"!=typeof S.issuer.id){for(r=[],b=0,m=(R=S.issuer.id).length;b<m;b++){if(O=(O=R[b]).trim(),"journal"===S.issuer.type&&-1!==O.indexOf("-")&&-1===O.indexOf(" ")&&(O=O.toUpperCase(),t=await this.svc.oaworks.journal('issn.exact:"'+O+'"')))for(_=0,y=(T=t.issn).length;_<y;_++)i=T[_],o.call(r,i)<0&&r.push(i);o.call(r,O)<0&&r.push(O)}S.issuer.id=r}else S.issuer.id.startsWith("10.")&&-1!==S.issuer.id.indexOf("/")&&-1===S.issuer.id.indexOf(" ")&&(console.log(S.issuer.id),S.DOI=S.issuer.id);for(l in S.permission_required=null!=q.has_policy&&-1!==q.has_policy.toLowerCase().indexOf("permission required"),q)if(u[l]&&null!=q[l]&&0!==q[l].length){if(k=u[l],j=void 0,"post-printembargo"===l)try{"number"!=typeof(c=parseInt(q[l].trim()))||isNaN(c&&0!==c)||(j=c),null!=j&&(S.embargo_end="")}catch(e){}else if("journal"===l||"versionsarchivable"===l||"archivinglocationsallowed"===l||"licencesallowed"===l||"policyfulltext"===l||"contributedby"===l||"addedby"===l||"reviewers"===l||"iffundedby"===l)for(j=[],C=0,g=(U=I=q[l].trim().split(",")).length;C<g;C++)if(B=(J=U[C]).trim(),"licencesallowed"===l){if("unclear"!==B.toLowerCase()){p={type:B.toLowerCase()};try{p.terms=q.licenceterms.split(",")[I.indexOf(J)].trim()}catch(e){}j.push(p)}}else"versionsarchivable"===l&&("preprint"===(B=B.toLowerCase())&&(B="submittedVersion"),"postprint"===B&&(B="acceptedVersion"),"publisher pdf"===B&&(B="publishedVersion")),B.length&&o.call(j,B)<0&&j.push("archivinglocationsallowed"===l?B.toLowerCase():B);else"recordlastupdated"!==l&&(j=q[l].trim());"string"!=typeof j||"yes"!==(D=j.toLowerCase())&&"no"!==D&&"haspolicy"!==l&&"permissiontype"!==l&&"copyrightowner"!==l||(j=j.toLowerCase()),"copyrightowner"!==l&&"license"!==l||"unclear"!==j||(j=""),null!=j&&(-1!==k.indexOf(".")?(null==S[w=(A=k.split("."))[0]]&&(S[w]={}),S[A[0]][[A[1]]]=j):S[k]=j)}if(null==S.licences&&(S.licences=[]),!S.licence)for(E=0,v=(N=S.licences).length;E<v;E++)h=N[E],(null==S.licence||h.type.length<S.licence.length)&&(S.licence=h.type,S.licence_terms=h.terms);null==S.versions&&(S.versions=[]),S.versions.length&&(S.can_archive=!0,S.version=o.call(S.versions,"acceptedVersion")>=0||o.call(S.versions,"postprint")>=0?"acceptedVersion":o.call(S.versions,"publishedVersion")>=0||o.call(S.versions,"publisher pdf")>=0?"publishedVersion":"submittedVersion"),null==S.copyright_owner&&(S.copyright_owner=null!=(M=null!=(z=S.issuer)?z.type:void 0)?M:""),null==S.copyright_name&&(S.copyright_name=""),null==S.copyright_year&&(S.copyright_year=""),"{}"!==!JSON.stringify(S)&&P.push(S)}return 1===P.length?P[0]:P},r.svc.oaworks.permission._sheet="1qBb0RV1XgO3xOQMdHJBAf3HCJlUgsXqDVauWAtxde4A",r.svc.oaworks.permission._prefix=!1,r.svc.rscvd=function(){return"RSCVD API (prototype)"},r.svc.rscvd._index=!0,r.svc.rscvd.retrieve=async function(){var e,t,i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g;if(e=this.apikey,m=null!=(c=this.params.size)?c:"20000",e){for(u=[],t=0,s=(h=(d=await this.fetch("https://api.cottagelabs.com/log?apikey="+e+"&sort=createdAt:asc&q=endpoint:collect&size="+m)).hits.hits).length;t<s;t++)if("string"==typeof(y=h[t]._source.url)&&y.startsWith("/api/service/oab/ill/collect/")&&([f,l]=y.replace("/api/service/oab/ill/collect/","").split("?"),"string"==typeof f&&"string"==typeof l)){for(o={sid:f},i=0,a=(p=l.split("&")).length;i<a;i++){n=p[i],[r,g]=n.split("="),o[r]=decodeURIComponent(decodeURIComponent(g));try{"date"!==r&&"needed-by"!==r||(o[r]=await this.date(o[r]))}catch(e){}}u.push(o)}return await this.svc.rscvd(""),this.waitUntil(this.svc.rscvd(u)),d.hits.total+", "+u.length}},r.svc.oaworks.scrape=async function(e,t){var i,r,n,s,a,l,o,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,A,S,j,C;if(f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(C=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&C.length>1&&9<C[1].length&&C[1].length<45&&-1!==C[1].indexOf("/")&&0===C[1].indexOf("10.")&&(f.doi=C[1]),e=await this.puppet(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)for(r=0,s=0,o=(k=e.split(" ")).length;s<o;s++)if(j=k[s],(r+=1)<600&&(-1!==(j=j.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(j=j.split("doi.org")[1]),0===j.indexOf("/")&&(j=j.replace("/","")),0===(j=j.trim()).indexOf("10.")&&-1!==j.indexOf("/"))){f.doi=j;break}if(!f.doi)try{for(A=(n=await this.tdm.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=A.length;l<u;l++)_=A[l],!f.doi&&9<n.matches[_].result[1].length&&n.matches[_].result[1].length<45&&(f.doi=n.matches[_].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),f.title||(-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))),f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(w=0,c=m.length;w<c;w++)(b=m[w]).length>2&&(f.year=b)}catch(e){}if(!f.keywords)try{-1!==(a=(await this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(a=a.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=a.split(";")):(a=a.replace(/, /g,",").replace(/ ,/g,","),f.keywords=a.split(","))}catch(e){}if(!f.email){y=[];try{for(S=(await this.tdm.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,h=S.length;x<h;x++)(g=S[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===y.indexOf(g)&&y.push(g)}catch(e){}for(y.sort((function(e,t){return t.length-e.length})),v="",f.email=[],O=0,p=y.length;O<p;O++)d=y[O],-1===v.indexOf(d)&&f.email.push(d),v+=d}return f},n.built="Mon Apr 26 2021 09:45:17 GMT+0100",n.system="8370eb3851a6bb9255ba15cc6810434b540ea72f599efb5191afdca13c9fb5f3",r.puppet={_bg:!0},r.scripts.testoab={_bg:!0}}.call(this,i(0),i(3).Buffer)},function(e,t,i){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var r=i(4),n=i(5),s=i(6);function a(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(e,t){if(a()<t)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=o.prototype:(null===e&&(e=new o(t)),e.length=t),e}function o(e,t,i){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return u(this,e,t,i)}function u(e,t,i,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,r){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,i):new Uint8Array(t,i,r);o.TYPED_ARRAY_SUPPORT?(e=t).__proto__=o.prototype:e=p(e,t);return e}(e,t,i,r):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!o.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var r=0|f(t,i),n=(e=l(e,r)).write(t,i);n!==r&&(e=e.slice(0,n));return e}(e,t,i):function(e,t){if(o.isBuffer(t)){var i=0|d(t.length);return 0===(e=l(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?l(e,0):p(e,t);if("Buffer"===t.type&&s(t.data))return p(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(c(t),e=l(e,t<0?0:0|d(t)),!o.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function p(e,t){var i=t.length<0?0:0|d(t.length);e=l(e,i);for(var r=0;r<i;r+=1)e[r]=255&t[r];return e}function d(e){if(e>=a())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a().toString(16)+" bytes");return 0|e}function f(e,t){if(o.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return z(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return J(e).length;default:if(r)return z(e).length;t=(""+t).toLowerCase(),r=!0}}function m(e,t,i){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,i);case"utf8":case"utf-8":return S(this,t,i);case"ascii":return j(this,t,i);case"latin1":case"binary":return C(this,t,i);case"base64":return A(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function y(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function g(e,t,i,r,n){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=n?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(n)return-1;i=e.length-1}else if(i<0){if(!n)return-1;i=0}if("string"==typeof t&&(t=o.from(t,r)),o.isBuffer(t))return 0===t.length?-1:v(e,t,i,r,n);if("number"==typeof t)return t&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):v(e,[t],i,r,n);throw new TypeError("val must be string, number or Buffer")}function v(e,t,i,r,n){var s,a=1,l=e.length,o=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;a=2,l/=2,o/=2,i/=2}function u(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(n){var c=-1;for(s=i;s<l;s++)if(u(e,s)===u(t,-1===c?0:s-c)){if(-1===c&&(c=s),s-c+1===o)return c*a}else-1!==c&&(s-=s-c),c=-1}else for(i+o>l&&(i=l-o),s=i;s>=0;s--){for(var h=!0,p=0;p<o;p++)if(u(e,s+p)!==u(t,p)){h=!1;break}if(h)return s}return-1}function b(e,t,i,r){i=Number(i)||0;var n=e.length-i;r?(r=Number(r))>n&&(r=n):r=n;var s=t.length;if(s%2!=0)throw new TypeError("Invalid hex string");r>s/2&&(r=s/2);for(var a=0;a<r;++a){var l=parseInt(t.substr(2*a,2),16);if(isNaN(l))return a;e[i+a]=l}return a}function _(e,t,i,r){return B(z(t,e.length-i),e,i,r)}function w(e,t,i,r){return B(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function x(e,t,i,r){return w(e,t,i,r)}function O(e,t,i,r){return B(J(t),e,i,r)}function k(e,t,i,r){return B(function(e,t){for(var i,r,n,s=[],a=0;a<e.length&&!((t-=2)<0);++a)i=e.charCodeAt(a),r=i>>8,n=i%256,s.push(n),s.push(r);return s}(t,e.length-i),e,i,r)}function A(e,t,i){return 0===t&&i===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,i))}function S(e,t,i){i=Math.min(e.length,i);for(var r=[],n=t;n<i;){var s,a,l,o,u=e[n],c=null,h=u>239?4:u>223?3:u>191?2:1;if(n+h<=i)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(s=e[n+1]))&&(o=(31&u)<<6|63&s)>127&&(c=o);break;case 3:s=e[n+1],a=e[n+2],128==(192&s)&&128==(192&a)&&(o=(15&u)<<12|(63&s)<<6|63&a)>2047&&(o<55296||o>57343)&&(c=o);break;case 4:s=e[n+1],a=e[n+2],l=e[n+3],128==(192&s)&&128==(192&a)&&128==(192&l)&&(o=(15&u)<<18|(63&s)<<12|(63&a)<<6|63&l)>65535&&o<1114112&&(c=o)}null===c?(c=65533,h=1):c>65535&&(c-=65536,r.push(c>>>10&1023|55296),c=56320|1023&c),r.push(c),n+=h}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=4096));return i}(r)}t.Buffer=o,t.SlowBuffer=function(e){+e!=e&&(e=0);return o.alloc(+e)},t.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=a(),o.poolSize=8192,o._augment=function(e){return e.__proto__=o.prototype,e},o.from=function(e,t,i){return u(null,e,t,i)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(e,t,i){return function(e,t,i,r){return c(t),t<=0?l(e,t):void 0!==i?"string"==typeof r?l(e,t).fill(i,r):l(e,t).fill(i):l(e,t)}(null,e,t,i)},o.allocUnsafe=function(e){return h(null,e)},o.allocUnsafeSlow=function(e){return h(null,e)},o.isBuffer=function(e){return!(null==e||!e._isBuffer)},o.compare=function(e,t){if(!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,r=t.length,n=0,s=Math.min(i,r);n<s;++n)if(e[n]!==t[n]){i=e[n],r=t[n];break}return i<r?-1:r<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!s(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var r=o.allocUnsafe(t),n=0;for(i=0;i<e.length;++i){var a=e[i];if(!o.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(r,n),n+=a.length}return r},o.byteLength=f,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)y(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)y(this,t,t+3),y(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)y(this,t,t+7),y(this,t+1,t+6),y(this,t+2,t+5),y(this,t+3,t+4);return this},o.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?S(this,0,e):m.apply(this,arguments)},o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},o.prototype.compare=function(e,t,i,r,n){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===n&&(n=this.length),t<0||i>e.length||r<0||n>this.length)throw new RangeError("out of range index");if(r>=n&&t>=i)return 0;if(r>=n)return-1;if(t>=i)return 1;if(this===e)return 0;for(var s=(n>>>=0)-(r>>>=0),a=(i>>>=0)-(t>>>=0),l=Math.min(s,a),u=this.slice(r,n),c=e.slice(t,i),h=0;h<l;++h)if(u[h]!==c[h]){s=u[h],a=c[h];break}return s<a?-1:a<s?1:0},o.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},o.prototype.indexOf=function(e,t,i){return g(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return g(this,e,t,i,!1)},o.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}var n=this.length-t;if((void 0===i||i>n)&&(i=n),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var s=!1;;)switch(r){case"hex":return b(this,e,t,i);case"utf8":case"utf-8":return _(this,e,t,i);case"ascii":return w(this,e,t,i);case"latin1":case"binary":return x(this,e,t,i);case"base64":return O(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,e,t,i);default:if(s)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),s=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function j(e,t,i){var r="";i=Math.min(e.length,i);for(var n=t;n<i;++n)r+=String.fromCharCode(127&e[n]);return r}function C(e,t,i){var r="";i=Math.min(e.length,i);for(var n=t;n<i;++n)r+=String.fromCharCode(e[n]);return r}function E(e,t,i){var r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);for(var n="",s=t;s<i;++s)n+=M(e[s]);return n}function I(e,t,i){for(var r=e.slice(t,i),n="",s=0;s<r.length;s+=2)n+=String.fromCharCode(r[s]+256*r[s+1]);return n}function P(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function q(e,t,i,r,n,s){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<s)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function L(e,t,i,r){t<0&&(t=65535+t+1);for(var n=0,s=Math.min(e.length-i,2);n<s;++n)e[i+n]=(t&255<<8*(r?n:1-n))>>>8*(r?n:1-n)}function R(e,t,i,r){t<0&&(t=4294967295+t+1);for(var n=0,s=Math.min(e.length-i,4);n<s;++n)e[i+n]=t>>>8*(r?n:3-n)&255}function T(e,t,i,r,n,s){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function U(e,t,i,r,s){return s||T(e,0,i,4),n.write(e,t,i,r,23,4),i+4}function D(e,t,i,r,s){return s||T(e,0,i,8),n.write(e,t,i,r,52,8),i+8}o.prototype.slice=function(e,t){var i,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),o.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=o.prototype;else{var n=t-e;i=new o(n,void 0);for(var s=0;s<n;++s)i[s]=this[s+e]}return i},o.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var r=this[e],n=1,s=0;++s<t&&(n*=256);)r+=this[e+s]*n;return r},o.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var r=this[e+--t],n=1;t>0&&(n*=256);)r+=this[e+--t]*n;return r},o.prototype.readUInt8=function(e,t){return t||P(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return t||P(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return t||P(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return t||P(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return t||P(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var r=this[e],n=1,s=0;++s<t&&(n*=256);)r+=this[e+s]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*t)),r},o.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var r=t,n=1,s=this[e+--r];r>0&&(n*=256);)s+=this[e+--r]*n;return s>=(n*=128)&&(s-=Math.pow(2,8*t)),s},o.prototype.readInt8=function(e,t){return t||P(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){t||P(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(e,t){t||P(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(e,t){return t||P(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return t||P(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return t||P(e,4,this.length),n.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return t||P(e,4,this.length),n.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return t||P(e,8,this.length),n.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return t||P(e,8,this.length),n.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,i,r){(e=+e,t|=0,i|=0,r)||q(this,e,t,i,Math.pow(2,8*i)-1,0);var n=1,s=0;for(this[t]=255&e;++s<i&&(n*=256);)this[t+s]=e/n&255;return t+i},o.prototype.writeUIntBE=function(e,t,i,r){(e=+e,t|=0,i|=0,r)||q(this,e,t,i,Math.pow(2,8*i)-1,0);var n=i-1,s=1;for(this[t+n]=255&e;--n>=0&&(s*=256);)this[t+n]=e/s&255;return t+i},o.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,1,255,0),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):L(this,e,t,!0),t+2},o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):L(this,e,t,!1),t+2},o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):R(this,e,t,!0),t+4},o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):R(this,e,t,!1),t+4},o.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t|=0,!r){var n=Math.pow(2,8*i-1);q(this,e,t,i,n-1,-n)}var s=0,a=1,l=0;for(this[t]=255&e;++s<i&&(a*=256);)e<0&&0===l&&0!==this[t+s-1]&&(l=1),this[t+s]=(e/a>>0)-l&255;return t+i},o.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t|=0,!r){var n=Math.pow(2,8*i-1);q(this,e,t,i,n-1,-n)}var s=i-1,a=1,l=0;for(this[t+s]=255&e;--s>=0&&(a*=256);)e<0&&0===l&&0!==this[t+s+1]&&(l=1),this[t+s]=(e/a>>0)-l&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,1,127,-128),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):L(this,e,t,!0),t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):L(this,e,t,!1),t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):R(this,e,t,!0),t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||q(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):R(this,e,t,!1),t+4},o.prototype.writeFloatLE=function(e,t,i){return U(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return U(this,e,t,!1,i)},o.prototype.writeDoubleLE=function(e,t,i){return D(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return D(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,r){if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);var n,s=r-i;if(this===e&&i<t&&t<r)for(n=s-1;n>=0;--n)e[n+t]=this[n+i];else if(s<1e3||!o.TYPED_ARRAY_SUPPORT)for(n=0;n<s;++n)e[n+t]=this[n+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+s),t);return s},o.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),1===e.length){var n=e.charCodeAt(0);n<256&&(e=n)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!o.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{var a=o.isBuffer(e)?e:z(new o(e,r).toString()),l=a.length;for(s=0;s<i-t;++s)this[s+t]=a[s%l]}return this};var N=/[^+\/0-9A-Za-z-_]/g;function M(e){return e<16?"0"+e.toString(16):e.toString(16)}function z(e,t){var i;t=t||1/0;for(var r=e.length,n=null,s=[],a=0;a<r;++a){if((i=e.charCodeAt(a))>55295&&i<57344){if(!n){if(i>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(a+1===r){(t-=3)>-1&&s.push(239,191,189);continue}n=i;continue}if(i<56320){(t-=3)>-1&&s.push(239,191,189),n=i;continue}i=65536+(n-55296<<10|i-56320)}else n&&(t-=3)>-1&&s.push(239,191,189);if(n=null,i<128){if((t-=1)<0)break;s.push(i)}else if(i<2048){if((t-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function J(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(N,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function B(e,t,i,r){for(var n=0;n<r&&!(n+i>=t.length||n>=e.length);++n)t[n+i]=e[n];return n}}).call(this,i(0))},function(e,t,i){"use strict";t.byteLength=function(e){var t=u(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,r=u(e),a=r[0],l=r[1],o=new s(function(e,t,i){return 3*(t+i)/4-i}(0,a,l)),c=0,h=l>0?a-4:a;for(i=0;i<h;i+=4)t=n[e.charCodeAt(i)]<<18|n[e.charCodeAt(i+1)]<<12|n[e.charCodeAt(i+2)]<<6|n[e.charCodeAt(i+3)],o[c++]=t>>16&255,o[c++]=t>>8&255,o[c++]=255&t;2===l&&(t=n[e.charCodeAt(i)]<<2|n[e.charCodeAt(i+1)]>>4,o[c++]=255&t);1===l&&(t=n[e.charCodeAt(i)]<<10|n[e.charCodeAt(i+1)]<<4|n[e.charCodeAt(i+2)]>>2,o[c++]=t>>8&255,o[c++]=255&t);return o},t.fromByteArray=function(e){for(var t,i=e.length,n=i%3,s=[],a=0,l=i-n;a<l;a+=16383)s.push(c(e,a,a+16383>l?l:a+16383));1===n?(t=e[i-1],s.push(r[t>>2]+r[t<<4&63]+"==")):2===n&&(t=(e[i-2]<<8)+e[i-1],s.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return s.join("")};for(var r=[],n=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,o=a.length;l<o;++l)r[l]=a[l],n[a.charCodeAt(l)]=l;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function c(e,t,i){for(var n,s,a=[],l=t;l<i;l+=3)n=(e[l]<<16&16711680)+(e[l+1]<<8&65280)+(255&e[l+2]),a.push(r[(s=n)>>18&63]+r[s>>12&63]+r[s>>6&63]+r[63&s]);return a.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},function(e,t){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read=function(e,t,i,r,n){var s,a,l=8*n-r-1,o=(1<<l)-1,u=o>>1,c=-7,h=i?n-1:0,p=i?-1:1,d=e[t+h];for(h+=p,s=d&(1<<-c)-1,d>>=-c,c+=l;c>0;s=256*s+e[t+h],h+=p,c-=8);for(a=s&(1<<-c)-1,s>>=-c,c+=r;c>0;a=256*a+e[t+h],h+=p,c-=8);if(0===s)s=1-u;else{if(s===o)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,r),s-=u}return(d?-1:1)*a*Math.pow(2,s-r)},t.write=function(e,t,i,r,n,s){var a,l,o,u=8*s-n-1,c=(1<<u)-1,h=c>>1,p=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,a=c):(a=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-a))<1&&(a--,o*=2),(t+=a+h>=1?p/o:p*Math.pow(2,1-h))*o>=2&&(a++,o/=2),a+h>=c?(l=0,a=c):a+h>=1?(l=(t*o-1)*Math.pow(2,n),a+=h):(l=t*Math.pow(2,h-1)*Math.pow(2,n),a=0));n>=8;e[i+d]=255&l,d+=f,l/=256,n-=8);for(a=a<<n|l,u+=n;u>0;e[i+d]=255&a,d+=f,a/=256,u-=8);e[i+d-f]|=128*m}},function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}}]);