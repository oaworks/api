!function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));let s=e=>crypto.getRandomValues(new Uint8Array(e)),r=(e,t)=>((e,t,i)=>{let s=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*s*t/e.length);return()=>{let a="";for(;;){let l=i(r),n=r;for(;n--;)if(a+=e[l[n]&s]||"",a.length===t)return a}}})(e,t,s)},function(e,t,i){"use strict";i.r(t),function(e,t,s){var r,a,l,n,o,u,c=i(1),h=[].indexOf;try{a=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(u in l=JSON.parse(SECRETS_SERVER))a[u]=l[u]}catch(e){}null==a&&(a={}),null==a.name&&(a.name="OA.Works"),null==a.kv&&(a.kv="oaworks"),null==a.version&&(a.version="6.1.0"),a.pass=["docs","client",".well-known"],null==a.dev&&(a.dev=!0);try{e.env.name.includes("async")&&(a.async=!0)}catch(e){}null==a.headers&&(a.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==a.formats&&(a.formats=["html","csv","json"]),null==a.svc&&(a.svc={}),null==a.src&&(a.src={});try{addEventListener("fetch",(function(e){return!1!==a.pass&&e.passThroughOnException(),e.respondWith(r.call(e))}))}catch(e){}o={},n={},(r=async function(){var i,s,l,o,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe;this.started=Date.now();try{null==(l=a.headers)[C="x-"+a.name.toLowerCase()]&&(l[C]=(a.version?"v"+a.version:"")+(a.built?" built "+a.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(a)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(o=this.S).cache&&(o.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),t[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(T="",b=0,A=(W=this.request.url.split("?")[1].split("&")).length;b<A;b++)if((k=(M=W[b]).split("="))[0].length){if(1===k.length&&T&&(k[0].startsWith(" ")||k[0].includes("%")))this.params[T]+="&"+decodeURIComponent(k[0]);else{if(this.params[k[0]]=1===k.length||("string"==typeof k[1]&&"true"===k[1].toLowerCase()||("string"!=typeof k[1]||"false"!==k[1].toLowerCase())&&(!!M.endsWith("=")||k[1])),"string"!=typeof this.params[k[0]]||0!==this.params[k[0]].replace(/[0-9]/g,"").length||"0"!==this.params[k[0]]&&this.params[k[0]].startsWith("0")||(O=parseInt(this.params[k[0]]),isNaN(O)||(this.params[k[0]]=O)),"string"==typeof this.params[k[0]]&&this.params[k[0]].includes("%"))try{this.params[k[0]]=decodeURIComponent(this.params[k[0]])}catch(e){}if("string"==typeof this.params[k[0]]&&(this.params[k[0]].startsWith("[")||this.params[k[0]].startsWith("{")))try{this.params[k[0]]=JSON.parse(this.params[k[0]])}catch(e){}}T=k[0]}this.headers={};try{for(U=[...this.request.headers],x=0,I=U.length;x<I;x++)v=U[x],this.headers[v[0].toLowerCase()]=v[1]}catch(e){try{for(w in this.request.headers)this.headers[w.toLowerCase()]=this.request.headers[w]}catch(e){}}if(null==(c=this.headers).ip&&(c.ip=null!=(Z=this.headers["x-real-ip"])?Z:this.headers["x-forwarded-for"]),m=null!=(se=this.headers["content-type"])?se:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(m.includes("/json"))this.body=await this.request.json();else if(m.includes("form")){for(y in d={},(await this.request.formData()).entries())y[0]&&(null!=d[y[0]]?(Array.isArray(d[y[0]])||(d[y[0]]=[d[y[0]]]),d[y[0]].push(y[1])):d[y[0]]=y[1]);null!=d&&"{}"!==JSON.stringify(d)&&(this.body=d)}if(null==this.body&&("POST"===(re=this.request.method)||"PUT"===re||"DELETE"===re)){try{d=await this.request.text()}catch(e){}d&&(this.body=d)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(e){}if("object"==typeof this.body&&!Array.isArray(this.body))for(M in this.body)M&&null==(p=this.params)[M]&&(p[M]=this.body[M]);try{this.cookie=null!=(ae=this.headers.Cookie)?ae:this.headers.cookie}catch(e){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(e){}null==this.rid&&(this.rid=r.uid());try{this.apikey=null!=(le=null!=(ne=this.headers["x-apikey"])?ne:this.headers.apikey)?le:this.params.apikey}catch(e){}for(S=0,j=(oe=["x-apikey","apikey"]).length;S<j;S++)pe=oe[S],null!=this.headers[pe]&&delete this.headers[pe],null!=this.params[pe]&&delete this.params[pe];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(g=decodeURIComponent(this.url))}catch(e){}this.parts=(null!=g?g:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(g=decodeURIComponent(this.url))}catch(e){}this.parts=this.url.length?(null!=g?g:this.url).split("/"):[];try{this.base=this.headers.host}catch(e){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(N=this.parts[this.parts.length-1].split(".").pop().toLowerCase(),h.call(this.S.formats,N)>=0&&(this.format=N,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+N,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(ue=this.parts[0],h.call(this.S.pass,ue)>=0))throw new Error;if(de="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[de]===this.S.system&&(delete this.headers[de],this.system=!0),this._logs=[],this.nolog=!1,this.params._nolog&&(this.nolog=this.S.nolog&&this.params._nolog===this.S.nolog,delete this.params._nolog),this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(z=this.request.method)||"OPTIONS"===z?r._response.call(this,""):r._response.call(this,{name:null!=(J=this.S.name)?J:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=(B=null!=(F=this.user)?F.email:void 0)?B:void 0});for(_=void 0,q=[...this.parts],P=void 0,E=[],(i=(t,s,a,l,o)=>{var c,p,d,f,m,g,y,v,w,b,x,k,O,S,A,I,j;if(P&&this.fn.startsWith(a))for(;q.length&&null==t[q[0]];)this.params[P]=(this.params[P]?this.params[P]+"/":"")+q.shift(),h.call(E,P)<0&&E.push(P);for(u in A=[],t)if("function"!=(O=typeof t[u])&&"object"!==O)A.push(s[u]=t[u]);else if(null!=t[u]){if(x=a+(a?".":"")+u,"object"!=typeof t[u]||t[u]._index||t[u]._indexed||t[u]._sheet||t[u]._kv||t[u]._bg){if(null==(d=t[u])._auth&&(d._auth=null!=(f=t[u])._auths?f._auths:f._auths=l),Array.isArray(t[u]._auths)&&0===t[u]._auths.length&&(t[u]._auths=x.split(".")),Array.isArray(t[u]._auth)&&0===t[u]._auth.length&&(t[u]._auth=x.split(".")),null==(m=t[u])._cache&&(m._cache=null!=(g=t[u])._caches?g._caches:g._caches=o),x.startsWith("auth")&&null==(y=t[u])._cache&&(y._cache=!1),t[u]._sheet&&null==(v=t[u])._index&&(v._index=!0),t[u]._index)for(k=0,b=(S=["keys","terms","suggest","count","percent","min","max","range","sum","average","mapping","_for","_each","_bulk","_refresh"]).length;k<b;k++)w=S[k],null==(c=t[u])[w]&&(c[w]={_indexed:w,_auth:w.startsWith("_")?"system":t[u]._auth});for(j in"function"!=typeof t[u]||t[u]._index||t[u]._indexed||t[u]._kv||t[u]._bg||x.includes(".")&&!a.startsWith("index")&&!x.split(".").pop().startsWith("_")?s[u]=r._wrapper(t[u],x).bind(this):s[u]=t[u].bind(this),t[u])j.startsWith("_")&&(s[u][j]=t[u][j])}else s[u]=JSON.parse(JSON.stringify(t[u]));null==(p=s[u])._name&&(p._name=x),s[u]._schedule&&!n[x]&&!0===this.S.bg&&!1!==this.S.cron&&(console.log("Adding schedule",s[u]._schedule,x),n[x]={schedule:s[u]._schedule,fn:s[u]},I=t=>async()=>{var i,s;if(!0!==this.S.dev&&1!==e.env.pm_id)return console.log("NOT running scheduled task because not on dev and process pid is not 1",t,this.datetime());if("string"==typeof this.S.async)return console.log("NOT running scheduled task because not on the available async process",t,this.datetime());console.log("scheduled task",t,this.datetime()),n[t].last=await this.datetime(),delete n[t].error;try{i=n[t].fn._sheet?await this._loadsheet(n[t].fn,n[t].fn._name.replace(/\./g,"_")):await n[t].fn(n[t].fn._args);try{n[t].result=JSON.stringify(i).substr(0,200)}catch(e){}return n[t].success=!0,console.log("scheduled task result",i)}catch(e){s=e,n[t].success=!1;try{return n[t].error=JSON.stringify(s)}catch(e){}}},cron.schedule(s[u]._schedule,I(x))),u.startsWith("_")||(q.length&&q[0]===u&&this.fn.startsWith(a)&&(P=q.shift(),this.fn+=(""===this.fn?"":".")+P,"function"!=typeof s[u]||a.includes("._")||(_=s[u])),"function"==typeof s[u]&&1===x.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(x.replace(/\./g,"/"))),Array.isArray(t[u])||u.startsWith("_")&&"function"!=typeof s[u]?A.push(void 0):A.push(i(t[u],s[u],x,null!=l?l:t[u]._auths,null!=o?o:t[u]._caches))}else A.push(void 0);return A})(r,this,""),P&&q.length&&(this.params[P]=this.params[P]?this.params[P]+"/"+q.join("/"):q.join("/")),L=0,D=E.length;L<D;L++)f=E[L],"true"===this.params[f].toLowerCase()&&(this.params[f]=!0),"false"===this.params[f].toLowerCase()&&(this.params[f]=!1),"string"!=typeof this.params[f]||0!==this.params[f].replace(/[0-9]/g,"").length||this.params[f].startsWith("0")||(R=parseInt(this.params[f]),isNaN(R)||(this.params[f]=R));if(this.S.dev&&!0===this.S.bg&&console.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(Y=typeof _)||"function"===Y)&&_._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("object"!=(V=typeof _)&&"function"!==V||!_._async||"string"!=typeof this.S.async?"function"==typeof _&&("object"==typeof(s="auth"===this.fn?void 0:await this.auth())&&s._id&&s.email&&(this.user=s),(s="function"==typeof _._auth?await _._auth():!0===_._auth&&null!=this.user||(!_._auth||await this.auth.role(_._auth)))||this.system?"HEAD"===(X=this.request.method)||"OPTIONS"===X?ce="":!1!==_._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(ce=await this.cache())?(this.cached="cache",(ce=new Response(ce.body,ce)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),ce.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(ce=await _(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(ce={status:401}).body=await this.auth(!1))):(console.log("Fetching from async process",this.S.async,this.request.url),ce=await this.fetch(this.S.async+this.request.url,{method:this.request.method,headers:this.headers,body:this.request.body})),(null==ce||"object"==typeof ce&&404===ce.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(ce=""),he="object"!=typeof ce||Array.isArray(ce)||"function"!=typeof(null!=($=ce.headers)?$.append:void 0)?await this._response(ce,_):ce,this.parts.length&&"log"!==(G=this.parts[0])&&"status"!==G&&(!this.system||"kv"!==(H=this.parts[0])&&"index"!==H)&&"HEAD"!==(Q=this.request.method)&&"OPTIONS"!==Q&&null!=ce&&""!==ce&&(!this.completed||!1===_._cache||200!==he.status||"object"==typeof ce&&!Array.isArray(ce)&&0===(null!=(K=ce.hits)?K.total:void 0)||"number"==typeof ce&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(fe=_._cache)||"object"!=typeof ce||Array.isArray(ce)||null==(null!=(ee=ce.hits)?ee.hits:void 0)||(fe=60),this.cache(void 0,he,fe)),("object"!=(te=typeof _)&&"function"!==te||!1!==_._log)&&this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(ie=this.request.method)||"OPTIONS"===ie)return he;throw new Error})._response=async function(e,t){var i,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A;if(null==(a=this.S).headers&&(a.headers={}),null==e)e=404,S=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(o in e.headers)this.S.headers[o]=e.headers[o];delete e.headers}S=null!=(v=e.status)?v:200,delete e.status,0===(f=this.keys(e)).length?e=S:1===f.length&&(e=e[f[0]])}else S=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&(w=this.format,h.call(this.S.formats,w)>=0)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}if("string"==typeof e&&"html"===this.format&&!(e=e.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(k='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',k+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',e.includes("<title")?([_,A]=e.split("<title"),[A,r]=A.split("</title>"),k+="<title"+A+"</title>\n",e=_+r):e.includes('id="title"')&&(k+="<title>"+e.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),p=0,m=(b=["<meta ","<link "]).length;p<m;p++)if(u=b[p],e.includes(u))for(d=0,g=(x=e.split(u)).length;d<g;d++)O=u+x[d].split(">")[0],e=e.replace(O,""),k+=O+"\n";e.includes("<head>")&&([y,c]=e.split("<head>"),[c,i]=c.split("</head>"),k+=c,e=y+i),k.includes("icon")||(k+='<link rel="icon" href="data:,">'),k+="\n</head>\n",k+=e.includes("<body")?e:"\n<body>\n"+e+"\n</body>\n",e=k+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(l=this.S.headers)["Content-Type"]&&(l["Content-Type"]="application/json; charset=UTF-8")}try{null==(n=this.S.headers)["Content-Length"]&&(n["Content-Length"]=s.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(e){}try{return new Response(e,{status:S,headers:this.S.headers})}catch(t){return{status:S,headers:this.S.headers,body:e}}},r._loadsheet=async function(e,t){var i,s,r,a,l,n;if(e._sheet.startsWith("http")&&e._sheet.includes("csv")?l=await this.convert.csv2json(e._sheet):e._sheet.startsWith("http")&&e._sheet.includes("json")?(l=await this.fetch(e._sheet))&&!Array.isArray(l)&&(l=[l]):l=await this.src.google.sheets(e._sheet),Array.isArray(l)&&l.length){if("function"==typeof e._format&&(l=await e._format.apply(this,[l])),e._key)for(i=0,s=l.length;i<s;i++)null==(n=l[i])._id&&(n._id=(null!=(r=n[e._key])?r:this.uid()).replace(/\//g,"_").toLowerCase());return await this.index(t,""),await this.index(t,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(a=e._index.mappings)?a:e._index.mapping,aliases:e._index.aliases}),await this.index(t,l),l.length}return 0},r._wrapper=function(e,t){return async function(){var i,s,r,a,l,n,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he;if(ue=Date.now(),oe=t.replace(/\./g,"_"),S={fn:t},e._limit)for(A=await this.kv("limit/"+t);A;)null==S.limited&&(S.limited=0),S.limited+=A,await this.sleep(A-ue),A=await this.kv("limit/"+t);if("string"==(W=typeof this.params._async)||"number"===W)if(ne=await this.kv("async/"+this.params._async,"")){if("string"==typeof ne&&ne.includes("/")&&!ne.includes(" ")&&!ne.includes(":")&&!ne.startsWith("10.")&&2===ne.split("/").length){try{e._kv&&(ne=await this.kv(ne))}catch(e){}try{null==ne&&e._index&&(ne=await this.index(ne))}catch(e){}}try{"string"==typeof ne&&(ne.startsWith("{")||ne.startsWith("["))&&(ne=JSON.parse(ne))}catch(e){}}else ne={_async:this.params._async};else if(this.fn===t&&e._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)ne={status:302},e._sheet.startsWith("http")?ne.body=e._sheet:"json"===this.format?ne.body="https://sheets.googleapis.com/v4/spreadsheets/"+e._sheet.split("/")[0]+"/values/"+(null!=(U=null!=(Z=e._sheetid)?Z:e._sheet.split("/")[1])?U:"Sheet1")+"?alt=json":ne.body="https://docs.google.com/spreadsheets/d/"+e._sheet.split("/")[0],ne.headers={Location:ne.body};else if(e._indexed)(r=[...arguments]).unshift(oe.replace("_"+e._indexed,"")),ne=await this.index[e._indexed](...r);else if((e._index||e._kv)&&(!e._sheet||this.fn!==t||!this.refresh)){if(this.fn===t?(this.fn.replace(/\./g,"/")!==this.route&&(S.key=this.route.split(t.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!S.key&&e._index&&(q=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\*~\?=%"]/g,"").length&&(S.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(S.key=arguments[0].toString()),e._index&&!S.key&&(q=await this.index.translate(arguments[0],arguments[1])),M=null!=q?void 0:S.key?arguments[1]:e._index?arguments[0]:void 0),"object"==typeof M)if(Array.isArray(M)){if(M.length)for(g=0,w=M.length;g<w;g++)null==(n=M[g])._id&&(n._id=(null!=(ie=n[e._key])?ie:this.uid()).replace(/\//g,"_").toLowerCase())}else null==M._id&&(M._id=(null!=(ee=null!=(te=S.key)?te:M[e._key])?ee:this.uid()).replace(/\//g,"_").toLowerCase()),null==S.key&&(S.key=M._id.replace(/\//g,"_").toLowerCase());if((null!=M||!this.refresh||"function"!=typeof e)&&(e._kv&&S.key&&null!=(ne=await this.kv(oe+"/"+S.key,M))&&null==M&&(S.cached="kv"),e._index)){if("all"===this.params.size){if(!0!==this.S.bg){if("string"==typeof this.S.bg)throw new Error;ne={status:404}}if(I=this.params.email,this.params.orgkey&&(P=this.params.orgkey,delete this.params.orgkey),L=null!=(se=this.params.funders)?se:this.params.flatten,delete q.orgkey,delete q.funders,delete q.flatten,delete q.email,delete this.params.size,delete q.size,(he=await this.index.count(oe,q))>2e5||!(null!=(re=this.S.static)?re.folder:void 0))ne={status:401};else{m=(this.fn?this.fn.replace(/\./g,"_"):"")+"_"+this.uid(),c=this.S.static.url+"/export/"+m+".csv",he>1e5&&await this.mail({to:null!=(ae=null!=(le=this.S.log)?le.notify:void 0)?ae:"mark@oa.works",text:"Someone is creating a large csv of size "+he+"\n\n"+c+("joe@oa.works"===I?"":"\n\nbut they are not the user who is allowed, so it should get capped")}),C=this.S.static.folder+"/export";try{(d=(await fs.readdir(C)).length)>900&&d%20==0&&this.mail({to:null!=(z=null!=(J=this.S.log)?J.notify:void 0)?z:"mark@oa.works",text:"Warning, export file count is "+d+" they will be deleted at 1000"})}catch(e){await fs.mkdir(C),d=0}try{if(d>999){for(B=await fs.readdir(C),y=0,b=B.length;y<b;y++)f=B[y],await fs.unlink(C+"/"+f);this.mail({to:null!=(F=null!=(Y=this.S.log)?Y.notify:void 0)?F:"mark@oa.works",text:"Export files had reached 1000 so have been deleted "})}}catch(e){}if(d>1e3)ne={status:401};else{if(C+="/"+m+".csv",await fs.appendFile(C,""),null!=this.params.includes&&(this.params.include=this.params.includes,delete this.params.includes),null!=this.params.excludes&&(this.params.exclude=this.params.excludes,delete this.params.excludes),null!=this.params.include)_="string"==typeof this.params.include?this.params.include.split(","):this.params.include,P&&("string"!=typeof this.params.include||this.params.include.includes("orgs")?Array.isArray(this.params.include)&&h.call(this.params.include,"orgs")<0&&this.params.include.push("orgs"):this.params.include+=",orgs",h.call(q._source.includes,"orgs")<0&&q._source.includes.push("orgs"));else for(_=[],v=0,x=(V=await this.index.keys(oe)).length;v<x;v++)ce=V[v].split(".")[0],h.call(_,ce)<0&&"_id"!==ce&&_.push(ce);if(null!=this.params.exclude){for(j=0,k=(X="string"==typeof this.params.exclude?this.params.exclude.split(","):this.params.exclude).length;j<k;j++)p=X[j],-1===(N=_.indexOf(p))||P&&"orgs"===p||(_=_.splice(N,1));P&&-1!==(D=q._source.excludes.indexOf("orgs"))&&(q._source.excludes=q._source.excludes.splice(D,1))}I&&await this.mail({to:I,subject:"Your export has started (ref: "+m+".csv)",text:'Your export has started. You can download the file any time, it will keep growing until it is complete, when you will get another notification.<br><br><a href="'+c+'">Download csv</a><br><br>Thanks'}),s=async(e,t,i,s,r,a,l,n)=>{var o,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se;for(_=!0,null!=n&&($=await this.encrypt(n),P=await this.report.orgs.orgkeys('key.keyword:"'+$+'"',1)),l&&(s=["DOI","funder.name","funder.award","authorships.institutions.display_name","authorships.institutions.ror"]),R=0,S=s.length;R<S;R++)x=s[R],await fs.appendFile(i,(_?'"':',"')+x+'"'),_=!1;for await(m of this.index._for(e,t,{scroll:"5m",max:1e5}))if(await fs.appendFile(i,"\n"),l){if(L="",c="",b="",V="",null!=m.funder)for(_=!0,G=0,A=(T=m.funder).length;G<A;G++)L+=(_?"":";")+(null!=(E=(v=T[G]).name)?E:""),null!=v.award&&v.award.length&&(v.award=v.award.join(" ")),null==v.award&&(v.award=""),Array.isArray(v.award)&&(v.award.length?v.award=v.award.join(" "):v.award=""),v.award=v.award.replace(/;/g,""),c+=(_?"":";")+v.award,_=!1;if(null!=m.authorships)for(_=!0,Z=0,I=(q=m.authorships).length;Z<I;Z++)if(_||(b+=";",V+=";"),_=!1,null!=(o=q[Z]).institutions)for(y=!0,Q=0,j=(M=o.institutions).length;Q<j;Q++)b+=(y?"":",")+(null!=(W=(w=M[Q]).display_name)?W:""),V+=(y?"":",")+(null!=(U=w.ror)?U:""),y=!1;await fs.appendFile(i,'"'+m.DOI+'","'+L+'","'+c+'","'+b+'","'+V+'"')}else for(_=!0,ee=0,D=s.length;ee<D;ee++){if((u=s[ee]).includes("."))try{p=await this.flatten(m)}catch(e){p=void 0}else p=m;if(Array.isArray(p)){if(p.length&&"object"==typeof p[0]){for(H=[],te=0,C=p.length;te<C;te++)null!=(null!=(f=p[te])?f[u]:void 0)&&H.push(f[u]);p=H}(N={})[u]=p,p=N}if(null==p||null==p[u])K="";else if("object"==typeof p[u]){if(Array.isArray(p[u])){for(d="",ie=0,k=(z=p[u]).length;ie<k;ie++)"object"==typeof(g=z[ie])&&(g=JSON.stringify(g)),d.includes(g)||(d+=(d?";":"")+g);p[u]=d}K=JSON.stringify(p[u])}else K=p[u];if("string"==typeof K&&(K=K.replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")),("email"===u||"supplements.email"===u)&&!K.includes("@")&&"string"==typeof(null!=P?P.org:void 0)&&P.org.length){for(Y=[],se=0,O=(B=null!=(J=m.orgs)?J:[]).length;se<O;se++)X=B[se],Y.push(X.toLowerCase());F=P.org.toLowerCase(),h.call(Y,F)>=0&&(K=await this.decrypt(K))}await fs.appendFile(i,(_?'"':',"')+K+'"'),_=!1}if(r)return await this.mail({to:r,subject:"Your export is complete (ref: "+i.split("/").pop()+")",text:'Your export is complete. We recommend you download and store files elsewhere as soon as possible as we may delete this file at any time.<br><br><a href="'+a+'">Download csv</a>\n\nThanks'})},this.waitUntil(s(oe,q,C,_,I,c,L,P)),delete this.format,ne=c}}}else ne=await this.index(oe+(S.key?"/"+S.key:""),null!=M?M:q);if(null!=ne||S.key&&null!=M||(await this.index(oe,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=($=e._index.mappings)?$:e._index.mapping,aliases:e._index.aliases}),""!==M&&(ne=await this.index(oe+(S.key?"/"+S.key:""),null!=M?M:S.key?void 0:q))),null==ne&&null==M&&S.key&&"string"==typeof arguments[0]&&(q=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(E=await this.index(oe,q))&&null!=(G=E.hits)?G.total:void 0))for(T=0,O=(H=await this.keys(E.hits.hits[0]._source)).length;T<O;T++)if(u=H[T],"string"==typeof E.hits.hits[0]._source[u]&&arguments[0]===E.hits.hits[0]._source[u]||Array.isArray(E.hits.hits[0]._source[u])&&(Q=arguments[0],h.call(E.hits.hits[0]._source[u],Q)>=0)){null==(ne=E.hits.hits[0]._source)._id&&(ne._id=E.hits.hits[0]._id);break}1===(null!=q?q.size:void 0)&&"object"==typeof ne&&null!=(null!=(K=ne.hits)?K.hits:void 0)&&(ne.hits.hits.length?(null==(a=ne.hits.hits[0]._source)._id&&(a._id=ne.hits.hits[0]._id),ne=ne.hits.hits[0]._source):ne=void 0)}null!=q&&(S.qry=JSON.stringify(q)),null==ne||null!=M||S.cached||(S.cached="index"),S.cached&&this.fn===t&&(this.cached=S.cached)}return null==ne&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(l={headers:{},body:M,params:this.copy(this.params)},this.refresh&&(l.params.refresh=!0),l.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,ne=await this.fetch(this.S.bg+"/"+oe.replace(/\_/g,"/"),l),S.bg=!0),null==ne&&e._sheet&&""!==M&&(this.refresh&&this.fn===t||!await this.index(oe))&&(ne=await this._loadsheet(e,oe),(arguments.length||"{}"!==JSON.stringify(this.params))&&(ne=void 0)),null!=ne||e._index&&""===M||"function"!=typeof e||(i=async(e,t,i,s,r)=>{var a,l,u,c,h,p,d,f;if(t._limit&&(a=!0===t._limit?86400:t._limit,await this.kv("limit/"+r,ue+a,a)),c=await t.apply(this,i),delete o[r],"object"==typeof c&&(t._kv||t._index)&&null==c.took&&null==c.hits){if(t._key&&Array.isArray(c)&&c.length&&null==c[0]._id&&null!=c[0][t._key])for(d=0,u=c.length;d<u;d++)null==(n=c[d])._id&&(n._id=n[t._key].replace(/\//g,"_").toLowerCase());l=Array.isArray(c)?"":"/"+(null!=(h=null!=(p=c[t._key])?p:c._id)?h:this.uid()).replace(/\//g,"_").toLowerCase(),t._kv&&!Array.isArray(c)&&this.kv(e+l,ne,t._kv),t._index&&this.waitUntil(this.index(e+l,c))}return!0===t._limit&&await this.kv("limit/"+r,""),t._async&&(this.kv("async/"+this.rid,null==l||Array.isArray(c)?Array.isArray(c)?c.length:c:e+l,172800),this.fn===r&&!1!==t._notify&&(f=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(c)+"\n\n"+this.base+"/"+e+"?_async="+this.rid,s&&this.mail({to:s,text:f}))),c},e._async&&this.fn===t?(S.async=!0,e._unique&&(R=o[t])?ne={_async:R}:(e._unique&&(o[this.fn]=this.rid),ne={_async:this.rid},this.waitUntil(i(oe,e,arguments,this.params.notify,t)))):ne=await i(oe,e,arguments)),!1!==e._log&&(S.took=Date.now()-ue,this.log(S)),ne}},r.svc={},r.src={},r.status=async function(){var i,s,r,l,o,c,h,p,d;p={name:a.name,version:a.version,built:a.built};try{p.pmid=e.env.pm_id}catch(e){}for(i=0,r=(o=["rid","params","base","parts","opts","routes"]).length;i<r;i++){u=o[i];try{null==p[u]&&(p[u]=this[u])}catch(e){}}if(!0===this.S.bg)try{for(d in p.schedule={},n)for(u in p.schedule[d]={},n[d])"fn"!==u&&(p.schedule[d][u]=n[d][u])}catch(e){}!0===this.S.bg&&(p.bg=!0),p.kv=("string"==typeof this.S.kv&&t[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{p.index=await this.index.status()}catch(e){}if(a.dev){if(p.bg=this.S.bg,!0!==this.S.bg)try{p.request=this.request}catch(e){}for(s=0,l=(c=["headers","cookie","user","body"]).length;s<l;s++){u=c[s];try{null==p[u]&&(p[u]=this[u])}catch(e){}}}else{try{p.index=p.index.status}catch(e){}p.kv&&(p.kv=!0),p.user=null!=(h=this.user)?h.email:void 0}return p};h=[].indexOf;r.auth=async function(e){var t,i,s,r,l,n,o,u,c,h,p,d,f;if("string"==typeof e)return this.users._get(e);if(e||null==this.user||"auth"!==this.fn&&!1!==e){if(!1!==e&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(r=this.params.token)?r:this.params.auth),"")))&&((f=await this.users._get(null!=(l=null!=s?s.email:void 0)?l:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(d=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(d))),!f&&(this.params.resume||this.cookie))){if(!(h=this.params.resume))try{h=(t=JSON.parse(decodeURIComponent(this.cookie).split((null!=(n=null!=(o=a.auth)&&null!=(u=o.cookie)?u.name:void 0)?n:"oaworksLogin")+"=")[1].split(";")[0])).resume,d=t._id}catch(e){}null==d&&(d=this.headers["x-id"]),this.params.email&&!d&&(d=this.hashhex(this.params.email.trim().toLowerCase())),h&&d&&await this.kv("auth/resume/"+d+"/"+h)&&null!=(f=await this.users._get(d))&&(f.resume=h)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),e||"html"!==this.format?f:(p="<body>",p+='<script type="text/javascript" src="/client/oaworksLogin.min.js?v='+this.S.version+'"><\/script>\n',p+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(p+='<input autofocus id="OALoginEmail" class="OALoginEmail" type="text" name="email" placeholder="email">',p+='<input id="OALoginToken" class="OALoginToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',p+='<p class="OALoginWelcome" style="display:none;">Welcome back</p>',p+='<p class="OALoginLogout" style="display:none;"><a id="OALoginLogout" href="#">logout</a></p>'):p+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',p+"</body>")},r.auth.token=function(e,t,i,s,r,l,n){var o,u,c;if(null==e&&(e=this.params.email),e)return e=e.trim().toLowerCase(),null==t&&(t=null!=(o=null!=(u=a.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&console.log(e,c),null==n&&(n=this.params.url),n?(n+="#"+c,null==i&&(i="Complete your login to "+(n.includes("//")?n.split("//")[1]:n).split("/")[0])):(n=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,e,1200),this.waitUntil(this.mail({from:t,to:e,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+n+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=r?r:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+n+'">'+n+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:n}})),{email:e}},r.auth.role=async function(e,t){var i,s,r,a,l,n,o,u,c,p,d,f,m,g;if(null==e&&(e=this.params.role),t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,"system"===e&&this.system)return"system";if((null!=t?t.email:void 0)&&(u=t.email,h.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],u)>=0))return"root";if(e.startsWith("@")&&null!=(null!=t?t.email:void 0)&&t.email.endsWith(e))return e;if(null!=(null!=t?t.roles:void 0))for(a=0,n=(c="string"==typeof e?e.split(","):e||[]).length;a<n;a++){if(s=c[a],[r,g]=s.replace("/",".").split("."),r===t._id)return"owner";if(g){if(h.call(null!=(p=t.roles[r])?p:[],g)>=0)return g;if(null!=t.roles[r]&&-1<(f=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(g)))for(l=0,o=(d=i.splice(0,f)).length;l<o;l++)if(m=d[l],h.call(t.roles[r],m)>=0)return m}}return!1},r.auth.add=async function(e,t,i,s){var r,a,l,n,o,u,c;return t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,!(!e&&this.user._id!==t._id&&!await this.auth.role("system"))&&(null==e&&(e=null!=(l=null!=(n=this.params.add)?n:this.params.remove)?l:this.params.deny),!!e&&([a,c]=e.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==a&&"root"!==c&&(s?(t.roles[a]=["deny"],this.users._update(t)):c?(null!=(o=t.roles)?o[a]:void 0)&&h.call(t.roles[a],c)>=0?null!=i&&(t.roles[a].splice(t.roles[a].indexOf(c),1),t.roles[a].length||delete t.roles[a],this.users._update(t)):("request"!==c||h.call(null!=(u=t.roles[a])?u:[],"deny")<0)&&(null==(r=t.roles)[a]&&(r[a]=[]),h.call(t.roles[a],"request")>=0&&(t.roles[a]=t.roles[a].splice(t.roles[a].indexOf("request"),1)),t.roles.group.push(c),this.users._update(t)):null!=t.roles[a]?null!=i&&(delete t.roles[a],this.users._update(t)):(t.roles[a]=["user"],this.users._update(t)),t)))},r.auth.remove=function(e,t){return this.auth.add(e,t,!0)},r.auth.deny=function(e,t){return this.auth.add(e,t,void 0,!0)},r.auth.request=function(e,t){return null==e&&(e=this.params.request),e=e.split("/")[0]+"/request",this.auth.add(e,t)},r.auth.logout=async function(e){return null==e&&(e=this.user),!!e&&(await this.kv._each("auth/resume/"+("string"==typeof e?e.includes("@")?this.hashhex(e.trim().toLowerCase()):e:e._id),""),!0)},r.auth._oauth=async function(e,t){var i,s,r,l,n,o,u,c,h,p,d,f,m,g;if({},e)try{if(g=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(s=this.S.svc[null!=(n=this.params.service)?n:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(h=a.use)&&null!=(p=h.google)&&null!=(d=p.oauth)&&null!=(f=d.client)?f.id:void 0),null!=t&&(null!=(r=g.data)?r.aud:void 0)===t)return{email:(m=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e)).data.email.toLowerCase(),google:{id:m.data.id},name:null!=(l=m.data.name)?l:m.data.given_name+(m.data.family_name?" "+m.data.family_name:""),avatar:m.data.picture}}catch(e){}},r.users={_index:!0,_auth:"system"},r.users._get=async function(e,t){var i,s,r;if(t)1===(null!=(s=await this.index("users",'apikey:"'+t+'"'))&&null!=(i=s.hits)?i.total:void 0)&&null==(r=s.hits.hits[0]._source)._id&&(r._id=s.hits.hits[0]._id);else if("string"==typeof e){if(e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),!0!==this.S.bg)try{r=await this.kv("users/"+e)}catch(e){}if(null==r){try{r=await this.index("users/"+e)}catch(e){}if(null!=r&&!0!==this.S.bg){try{await this.kv("users/"+e,r)}catch(e){}try{await this.kv("auth/apikey/"+r.apikey,e)}catch(e){}}}}return r},r.users._create=async function(e){var t;if("string"==typeof e&&(e={email:e}),"string"!=typeof e.email||!e.email.includes("@"))return!1;t={_id:this.hashhex(e.email.trim().toLowerCase()),email:e.email,apikey:this.uid()},delete e.email;try{t.profile=e}catch(e){}try{t.creation=this.base+"/"+this.route}catch(e){}t.roles={},t.createdAt=new Date;try{await this.kv("users/"+t._id,t)}catch(e){}try{await this.kv("auth/apikey/"+t.apikey,t._id)}catch(e){}try{this.waitUntil(this.index("users/"+t._id,t))}catch(e){}return t},r.users._update=async function(e,t){if("object"==typeof e&&t._id&&null==t&&(e=(t=e)._id),"string"==typeof e&&"object"==typeof t&&"{}"!==JSON.stringify(t)){e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),t.updatedAt=new Date;try{await this.kv("users/"+e,t)}catch(e){}try{this.waitUntil(this.index("users/"+e,t))}catch(e){}return!0}return!1},r.users._delete=async function(e){var t,i;if(i="object"==typeof e?e:(null!=(t=this.user)?t._id:void 0)===e?this.user:await this.users._get(e)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(e){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(e){}try{await this.kv("users/"+i._id,"")}catch(e){}try{return await this.index("users/"+i._id,"")}catch(e){}}},r.deal={_index:!0,_prefix:!1},r.deal.institution={_index:!0,_prefix:!1},r.deal.load=async function(){var e,t,i,s,r,a,l,n,o,u,c,h,p;for(t={},s=0,a=(c=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;s<a;s++){for(u=c[s],r=0,l=(h=["Institution","Publisher","Collection","Year(s)","Length of Agreement","Package Price","2015 Carnegie Basic Classification","FTE","Source","URL","Share URL Publicly?","Notes"]).length;r<l;r++)u[(p=h[r]).toLowerCase().replace(/ /g,"").replace("?","").replace("(","").replace(")","")]=u[p],delete u[p];try{if(u.value=parseInt(u.packageprice.replace(/[^0-9]/g,"")),"string"==typeof u.fte)try{u.fte=parseInt(u.fte)}catch(e){delete u.fte}"string"==typeof u.notes&&u.notes.toLowerCase().includes("canadian")?(u.gbpvalue=Math.floor(.57*u.value),u.usdvalue=Math.floor(.75*u.value)):u.packageprice.includes("$")?(u.gbpvalue=Math.floor(.77*u.value),u.usdvalue=Math.floor(u.value)):(u.gbpvalue=Math.floor(u.value),u.usdvalue=Math.floor(1.3*u.value))}catch(e){}null==u.usdvalue&&(u.usdvalue="");try{"2103"===u.years&&(u.years="2013")}catch(e){}try{"yes"!==u.shareurlpublicly.toLowerCase()&&delete u.url}catch(e){}try{delete u.shareurlpublicly}catch(e){}try{""===u.collection&&(u.collection="Unclassified")}catch(e){}try{u.carnegiebasicclassification=u["2015carnegiebasicclassification"],delete u["2015carnegiebasicclassification"]}catch(e){}try{null==t[n=u.institution]&&(t[n]={institution:u.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),o=JSON.parse(JSON.stringify(u));try{delete o.institution}catch(e){}try{t[u.institution].value+=u.value,t[u.institution].gbpvalue+=u.gbpvalue,t[u.institution].usdvalue+=u.usdvalue}catch(e){}t[u.institution].deals.push(o)}catch(e){}}for(e in i=[],t)i.push(t[e]);return await this.deal(""),await this.deal.institution(""),await this.deal(c),await this.deal.institution(i),{retrieved:c.length,institutions:i.length}};h=[].indexOf;r.deposits={_index:!0},r.deposit=async function(e,t,i){var s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe,me,ge,ye,_e,ve,we,be,xe,ke,Oe,Se;for(null==e&&(e=this.copy(this.params)),(null!=(D=e.metadata)?D.doi:void 0)&&!e.doi&&(e.doi=e.metadata.doi),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),null==i&&(i=this.S.dev),(p={createdAt:Date.now()}).created_date=await this.datetime(p.createdAt),f=0,_=(C=["embedded","demo","pilot","live","email","plugin"]).length;f<_;f++)p[y=C[f]]=e[y];if(!0===p.pilot&&(p.pilot=Date.now()),!0===p.live&&(p.live=Date.now()),p.name=null!=(z=null!=t?t.filename:void 0)?z:null!=t?t.name:void 0,"anonymous"!==e.from&&(p.from=e.from),e.confirmed&&(p.confirmed=decodeURIComponent(e.confirmed)),p.doi=null!=(Q=e.doi)?Q:null!=(ue=e.metadata)?ue.doi:void 0,null==e.metadata&&e.doi&&(e.metadata=await this.metadata(e.doi)),p.metadata=e.metadata,xe=e.config,"string"==typeof e.config&&(xe=JSON.parse(e.config)),!e.config&&e.from&&(xe=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from)),p.permissions=null!=(fe=e.permissions)?fe:await this.permissions(null!=(me=e.metadata)?me:e.doi),e.redeposit||(null==t&&e.email&&null!=e.metadata?p.type="dark":(p.archivable=await this.archivable(t,void 0,p.confirmed,e.metadata,p.permissions,i),null!=(null!=(ge=p.archivable)?ge.metadata:void 0)&&delete p.archivable.metadata)),(null!=(ye=p.archivable)?ye.archivable:void 0)&&(!p.confirmed||p.confirmed===p.archivable.checksum)){for((Oe={content:t.data,name:p.archivable.name}).publish=!0,c=[],g=0,v=(N=null!=(_e=null!=(L=e.metadata)?L.author:void 0)?_e:[]).length;g<v;g++)if(null!=(s=N[g]).family){a={name:s.family+(s.given?", "+s.given:"")};try{s.ORCID&&(a.orcid=s.ORCID.split("/").pop())}catch(e){}try{"object"==typeof s.affiliation&&null!=s.affiliation.name&&(a.affiliation=s.affiliation.name)}catch(e){}c.push(a)}0===c.length&&(c=[{name:"Unknown"}]),d=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(d=(d+=null!=(P=null!=(R=p.permissions.best_permission)?R.deposit_statement:void 0)?P:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+e.metadata.doi:"").trim()).lastIndexOf(".")!==d.length-1&&(d+="."),d.length&&(d+=" "),d+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",O={title:null!=(T=e.metadata.title)?T:"Unknown",description:d.trim(),creators:c,version:"submittedVersion"===p.archivable.version?"Submitted Version":"acceptedVersion"===p.archivable.version?"Accepted Version":"publishedVersion"===p.archivable.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},e.doi&&((null!=(Se=await this.src.zenodo.records.search('"'+e.doi+'"',i))&&null!=(E=Se.hits)?E.total:void 0)&&(m=Se.hits.hits[0]),m&&p.confirmed!==p.archivable.checksum&&!i?p.zenodo={already:m.id}:O.related_identifiers=[{relation:"postprint"===O.version||"AAM"===O.version||"preprint"===O.version?"isPreviousVersionOf":"isIdenticalTo",identifier:e.doi}]),O.prereserve_doi=!0,O.access_right="open",O.license=null!=(q=null!=(M=p.permissions.best_permission)?M.licence:void 0)?q:"cc-by",O.license.includes("other")&&O.license.includes("closed")&&(O.license="other-closed"),O.license.includes("other")&&O.license.includes("non")&&O.license.includes("commercial")&&(O.license="other-nc"),O.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(O.license.substring(O.license.length-1)))&&(O.license+="-4.0");try{(null!=(W=p.permissions.best_permission)?W.embargo_end:void 0)&&await this.epoch(p.permissions.best_permission.embargo_end)>Date.now()&&(O.access_right="embargoed",O.embargo_date=p.permissions.best_permission.embargo_end,p.embargo=p.permissions.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(O.publication_date=e.metadata.published)}catch(e){}if(null!=xe){if(p.config=xe,null!=xe.community_ID&&null==xe.community&&(xe.community=xe.community_ID),xe.community)for(null==xe.communities&&(xe.communities=[]),k=0,w=(U="string"==typeof xe.community?xe.community.split(","):xe.community).length;k<w;k++)o=U[k],xe.communities.push({identifier:o});if(null!=xe.community||null!=xe.communities)for(null==xe.communities&&(xe.communities=xe.community),Array.isArray(xe.communities)||(xe.communities=[xe.communities]),O.communities=[],A=0,b=(J=xe.communities).length;A<b;A++)u=J[A],O.communities.push("string"==typeof u?{identifier:u}:u);O.communities&&O.communities.length&&(p.community=O.communities[0].identifier)}if(ve=i||p.demo?null!=(B=this.S.src.zenodo)?B.sandbox:void 0:null!=(F=this.S.src.zenodo)?F.token:void 0){if(!(null!=(Y=p.zenodo)?Y.already:void 0))if((ke=await this.src.zenodo.deposition.create(O,Oe,ve,i)).id)p.zenodo={id:ke.id,url:"https://"+(i||p.demo?"sandbox.":"")+"zenodo.org/record/"+ke.id,doi:null!=(null!=(V=ke.metadata)&&null!=(X=V.prereserve_doi)?X.doi:void 0)?ke.metadata.prereserve_doi.doi:void 0,file:null!=($=null!=(G=ke.uploaded)&&null!=(H=G.links)?H.download:void 0)?$:null!=(Z=ke.uploaded)&&null!=(K=Z.links)?K.download:void 0},null==p.doi&&(p.doi=p.zenodo.doi),p.type="zenodo";else{p.error="Deposit to Zenodo failed";try{p.error+=": "+JSON.stringify(ke)}catch(e){}p.type="review"}}else p.error="No Zenodo credentials available",p.type="review"}if((null!=(ee=p.archivable)?ee.timeout:void 0)&&(p.error="Archivable timeout",p.type="review"),p.version=null!=(te=p.archivable)?te.version:void 0,p.type||!e.from||p.embedded&&(p.embedded.includes("oa.works")||p.embedded.includes("openaccessbutton.org")||p.embedded.includes("shareyourpaper.org"))||(p.type=e.redeposit?"redeposit":t?"forward":"dark"),p.doi&&(null==p.type&&(p.type="review"),p.url="string"==typeof e.redeposit?e.redeposit:e.url?e.url:void 0,await this.deposits(p),("review"!==p.type||null!=t)&&!1!==(null!=(ie=p.archivable)?ie.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(se=exists.zenodo)?se.already:void 0)||i))){for(n=["joe@oa.works","shared@oa.works"],i&&n.push("mark@oa.works"),be=[],"string"==typeof(null!=xe?xe.owner:void 0)&&xe.owner.includes("@")&&!p.error?be.push(xe.owner):(null!=xe?xe.email:void 0)&&be.push(xe.email),0===be.length&&(be=this.copy(n),n=[]),r=[],I=0,x=(le=null!=(re=null!=(ae=p.metadata)?ae.author:void 0)?re:[]).length;I<x;I++)(l=le[I]).family&&r.push((l.given?l.given+" ":"")+l.family);p.metadata.author=r,p.adminlink=p.embedded?p.embedded:"https://shareyourpaper.org"+(p.metadata.doi?"/"+p.metadata.doi:""),p.adminlink+=p.adminlink.includes("?")?"&":"?",null!=(null!=(ne=p.archivable)?ne.checksum:void 0)&&(p.confirmed=encodeURIComponent(p.archivable.checksum),p.adminlink+="confirmed="+p.confirmed+"&"),oe=p.email,h.call(p.adminlink,oe)<0&&(p.adminlink+="email="+p.email),we=await this.templates(p.type+"_deposit"),j=await this.template(we.content,p),delete p.adminlink,delete p.confirmed,S={from:"deposits@oa.works",to:be,subject:null!=(ce=j.subject)?ce:p.type+" deposit",html:j.content},n&&n.length&&(S.bcc=n),t&&(S.attachment={file:t.data,filename:null!=(he=null!=(pe=null!=(de=p.archivable)?de.name:void 0)?pe:t.name)?he:t.filename}),await this.mail(S)}if(p.embargo)try{p.embargo_UI=new Date(p.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(e){}return p},r.deposit._bg=!0,r.archivable=async function(e,t,i,s,r,a){var l,n;for(null==a&&(a=this.S.dev),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),l={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},(async()=>{var n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z;if(("string"==typeof s||null==s&&(this.params.doi||this.params.title))&&(s=await this.metadata(null!=(L=null!=s?s:this.params.doi)?L:this.params.title)),null==s&&(s={}),"string"==typeof e&&(e={data:e}),null==e&&null!=t&&(e=await this.fetch(t)),null!=e){null==e.name&&(e.name=e.filename);try{l.name=e.name}catch(e){}try{l.format=null!=e.name&&e.name.includes(".")?e.name.split(".").pop():"html"}catch(e){}if(l.format=l.format.toLowerCase(),e.data){if(null==p&&null!=l.format&&null!=this.convert[l.format+"2txt"])try{p=await this.convert[l.format+"2txt"](e.data)}catch(e){}try{null==p&&(p=e.data)}catch(e){}try{p=p.toString()}catch(e){}}}if(null!=p||i){A=((S=(d=p.length<2e4?p:p.substring(0,6e3)+p.substring(p.length-6e3,p.length)).toLowerCase()).length<6e3?S:S.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==l.name&&(l.name=s.title);try{l.checksum=crypto.createHash("md5").update(p,"utf8").digest("base64")}catch(e){}l.same_paper_evidence={};try{l.same_paper_evidence.words_count=p.split(" ").length}catch(e){}try{l.same_paper_evidence.words_more_than_threshold=l.same_paper_evidence.words_count>500}catch(e){}try{l.same_paper_evidence.doi_match=!(!s.doi||!A.includes(s.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}try{l.same_paper_evidence.title_match=!(!s.title||!A.includes(s.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}if(null!=s.author)try{for(c=0,l.same_paper_evidence.author_match=!1,"string"==typeof s.author&&(s.author={name:s.author}),Array.isArray(s.author)||(s.author=[s.author]),U=s.author,y=0,x=U.length;y<x&&(n=U[y],!0!==l.same_paper_evidence.author_match);y++)try{if(u=(null!=(z=null!=(J=null!=(B=null!=(F=n.last)?F:n.lastname)?B:n.family)?J:n.surname)?z:n.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),o=(null!=(Y=null!=(V=null!=(X=n.first)?X:n.firstname)?V:n.given)?Y:n.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),_=A.indexOf(u),u.length>2&&o.length>0&&-1!==_&&A.substring(_-20,_+u.length+20).includes(o)&&(c+=1,s.author.length<3&&1===c||s.author.length>2&&c>1)){l.same_paper_evidence.author_match=!0;break}}catch(e){}}catch(e){}if(null!=l.format)for(w=0,k=(P=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;w<k;w++)if(m=P[w],l.format.includes(m)){l.same_paper_evidence.document_format=!0;break}l.same_paper=!!(l.same_paper_evidence.words_more_than_threshold&&(l.same_paper_evidence.doi_match||l.same_paper_evidence.title_match||l.same_paper_evidence.author_match)&&l.same_paper_evidence.document_format),l.same_paper_evidence.words_count<150&&"pdf"===l.format&&(l.same_paper_evidence.words_count=0,l.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),l.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(R=await this.src.google.sheets(a?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),j=0,O=R.length;j<O;j++){b=R[j],l.version_evidence.strings_checked+=1,Z=b["what to search"],$=b["where to search"],g=b["how to search"],v=b["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&(H=Z.split("<<")[1].split(">>")[0],null!=s[H.toLowerCase()]&&(Z=Z.replace("<<"+H+">>",s[H.toLowerCase()]))),D=!1,"string"===g?D=!!("file"===$&&d.includes(Z)||"file"!==$&&(null!=s.title&&s.title.includes(Z)||null!=l.name&&l.name.includes(Z))):(C=new RegExp(Z,"gium"),D="file"===$&&null!==S.match(C)||"file"!==$&&(null!=s.title&&null!==s.title.match(C)||null!=l.name&&null!==l.name.match(C))),D){if("string"==typeof(G=b.value))try{G=parseInt(G)}catch(e){}"number"!=typeof G&&(G=1),!v||"publisher pdf"!==(T=v.toLowerCase())&&"publishedversion"!==T?l.version_evidence.score-=G:l.version_evidence.score+=G,l.version_evidence.strings_matched.push({indicates:v,found:g+" "+Z,in:$,score_value:G})}}catch(e){f=e,null==(h=l.version_evidence).strings_errored&&(h.strings_errored=[]),l.version_evidence.strings_errored.push({tried:g+" "+Z,in:$,error:f.toString()})}}}catch(e){}l.version_evidence.score>0&&(l.version="publishedVersion"),l.version_evidence.score<0&&(l.version="acceptedVersion"),"unknown"===l.version&&l.version_evidence.strings_checked>0&&(l.version="acceptedVersion");try{null!=(null!=(I=await this.licence(void 0,S))?I.licence:void 0)&&(l.licence=I.licence,l.licence_evidence=I)}catch(e){}l.archivable=!1,i?(l.archivable=!0,i===l.checksum?(l.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",l.admin_confirms=!0):(l.archivable_reason="The depositor says that this file is a version that can be archived",l.depositor_says=!0)):l.same_paper?("pdf"!==l.format&&(l.archivable=!0,l.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!l.archivable&&null!=l.licence&&l.licence.toLowerCase().startsWith("cc")&&(l.archivable=!0,l.archivable_reason="It appears this file contains a "+l.licence+" licence statement. Under this licence the article can be archived"),l.archivable||(l.version?(null!=s&&"{}"!==JSON.stringify(s)&&null==r&&(r=await this.permissions(s)),l.version===(null!=r&&null!=(E=r.best_permission)?E.version:void 0)?(l.archivable=!0,l.archivable_reason="We believe this is a "+l.version.split("V")[0]+" version and our permission system says that version can be shared"):null==l.archivable_reason&&(l.archivable_reason="We believe this file is a "+l.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):l.archivable_reason="We cannot confirm if it is an archivable version or not")):null==l.archivable_reason&&(l.archivable_reason=l.same_paper_evidence.words_more_than_threshold?l.same_paper_evidence.document_format?s.doi||s.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+l.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==e&&null==t||(l.error=null!=(N=e.error)?N:"Could not extract any content");return l.archivable&&null==l.licence&&((null!=r&&null!=(q=r.best_permission)?q.licence:void 0)?l.licence=r.best_permission.licence:(null!=(M=null!=r&&null!=(W=r.best_permission)?W.deposit_statement:void 0)?M:"").toLowerCase().startsWith("cc")&&(l.licence=r.best_permission.deposit_statement)),l.metadata=s})(),setTimeout(()=>l.timeout=!0,null!=(n=this.params.timeout)?n:6e4);null==l.archivable&&!l.timeout;)await this.sleep(500);return l},r.archivable._bg=!0;h=[].indexOf;r.metadata=async function(e){var t;return null!=(t=await this.find(e))?t.metadata:void 0},r.find=async function(e,t={},i){var s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k;x={},r=async e=>{var i,s;for(s in i=await this.citation(e))"url"===s||"paywall"===s?null==x[s]&&(x[s]=i[s]):null==t[s]&&(t[s]=i[s]);return!0},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(d=e.dom)?d:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(e.find.startsWith("10.")&&e.find.includes("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(f=e.q)?f:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(n="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&n.split("/")[0].length>6&&n.length>8&&((o=n.split("/")).length>2&&(n=o.join("/")),null==t.doi&&(t.doi=n)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(m=e.url.replace("...","").match(/\./gi))?m:[]).length>3||(null!=(g=e.url.match(/\(/gi))?g:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(y=e.title.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(_=e.title.match(/\(/gi))?_:[]).length>2)&&(e.citation=e.title,delete e.title),e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(v=e.pmcid)?v:e.pmc),e.citation&&await r(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}for("string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(x.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(w=e.from)||"eZwJ83xp3oZDaec86"===w)&&null==x.demo&&(x.demo=!0),x.demo&&null==x.test&&(x.test=!0),u=!1,p=!1,l=async()=>{var s,a,l,n,o;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(o=await this.scrape(null!=i?i:e.url),await r(o)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(n=t.pmcid)?n:t.pmid),await r(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(l=await this.src.crossref.works.title(t.title))?l.type:void 0)&&(null!=l?l.DOI:void 0)&&await r(l),t.doi||!1!==(p=await this.src.microsoft.graph(t.title))&&(null!=p?p.PaperTitle:void 0)&&await r(p),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await r(u))),t.doi&&(a=async()=>{var e;return null==(e=await this.src.oadoi(t.doi))&&(x.doi_not_in_oadoi=t.doi),(null!=e?e.doi:void 0)&&(null!=t?t.doi:void 0)&&e.doi.toLowerCase()===t.doi.toLowerCase()&&await r(e),!0},s=async()=>{if(null==(l=await this.src.crossref.works(t.doi))&&(l=await this.src.crossref.works.doi(t.doi)),null!=l?l.type:void 0){try{l.published=await this.src.crossref.works.published(l);try{l.year=l.published.split("-")[0]}catch(e){}try{l.year=parseInt(l.year)}catch(e){}try{l.publishedAt=await this.epoch(l.published)}catch(e){}}catch(e){}await r(l)}else x.doi_not_in_crossref=t.doi;return!0},await Promise.all([a(),s()])),!0},await l(),s=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==x.ill&&(x.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},a=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==x.permissions&&(x.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([s(),a()]),c=0,h=(b=["title","journal","year","doi"]).length;c<h;c++)e[k=b[c]]&&e[k]!==t[k]&&(t[k]=e[k]);return x.metadata=t,x},r.citation=function(e){var t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe,me,ge,ye,_e,ve,we,be,xe,ke,Oe,Se,Ae,Ie,je,De,Ce,Le,Ne,Pe,Re,Te,Ee,qe,Me,We,Ue,ze,Je,Be,Fe,Ye;Me={};try{null==e&&(e=null!=(R=this.params.citation)?R:this.params)}catch(e){}if("string"==typeof e&&(e.startsWith("{")||e.startsWith("[")))try{e=JSON.parse(e)}catch(e){}if("object"==typeof e){Me.doi=null!=(T=e.DOI)?T:e.doi,e.pmid&&(Me.pmid=e.pmid),e.pmcid&&(Me.pmcid=e.pmcid);try{Me.type=null!=(V=e.type)?V:e.genre}catch(e){}null==Me.issn&&(Me.issn=null!=(se=null!=(fe=null!=(Se=e.ISSN)?Se:e.issn)?fe:null!=(Re=e.journalInfo)&&null!=(Te=Re.journal)?Te.issn:void 0)?se:null!=(Ee=e.journal)?Ee.issn:void 0),null!=(null!=(qe=e.journalInfo)&&null!=(E=qe.journal)?E.eissn:void 0)&&(null==Me.issn&&(Me.issn=[]),"string"==typeof Me.issn&&(Me.issn=[Me.issn]),Me.issn.push(e.journalInfo.journal.eissn)),e.journal_issns&&null==Me.issn&&(Me.issn=e.journal_issns.split(","));try{Array.isArray(e.title)&&null==Me.title&&(Me.title=e.title[0])}catch(e){}try{null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(Me.title+=": "+e.subtitle[0])}catch(e){}null==Me.title&&(Me.title=null!=(q=e.dctitle)?q:null!=(M=e.bibjson)?M.title:void 0),404!==(W=e.title)&&"404"!==W&&null==Me.title&&(Me.title=e.title),"string"==typeof Me.title&&(Me.title=Me.title.replace(/\s\s+/g," ").trim());try{null==Me.journal&&(Me.journal=e["container-title"][0])}catch(e){}try{Me.shortname=e["short-container-title"][0]}catch(e){}try{Me.shortname=null!=(U=e.journalInfo.journal.isoabbreviation)?U:e.journalInfo.journal.medlineAbbreviation}catch(e){}Me.shortname&&!Me.journal_short&&(Me.journal_short=Me.shortname),null==Me.journal&&(Me.journal=null!=(z=null!=(J=e.journal_name)?J:null!=(B=e.journalInfo)&&null!=(F=B.journal)?F.title:void 0)?z:null!=(Y=e.journal)?Y.title:void 0),e.journal&&(Me.journal=e.journal.split("(")[0].trim());try{for(u=0,m=(X=["title","journal"]).length;u<m;u++)Me[d=X[u]]=Me[d].charAt(0).toUpperCase()+Me[d].slice(1)}catch(e){}null==Me.publisher&&(Me.publisher=e.publisher),Me.publisher&&(Me.publisher=Me.publisher.trim());try{null!=e.issue&&null==Me.issue&&(Me.issue=e.issue)}catch(e){}try{(null!=($=e.journalInfo)?$.issue:void 0)&&null==Me.issue&&(Me.issue=e.journalInfo.issue)}catch(e){}try{null!=e.volume&&null==Me.volume&&(Me.volume=e.volume)}catch(e){}try{(null!=(G=e.journalInfo)?G.volume:void 0)&&null==Me.volume&&(Me.volume=e.journalInfo.volume)}catch(e){}try{null!=e.page&&null==Me.page&&(Me.page=e.page.toString())}catch(e){}for(e.pageInfo&&(Me.page=e.pageInfo.toString()),(e.abstract||e.abstractText)&&(Me.abstract=null!=(H=e.abstract)?H:e.abstractText),c=0,g=(Z=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;c<g;c++)if(D=Z[c],"string"!=typeof Me.published){if(Ue=null!=(Q=null!=(K=e[D])?K:null!=(ee=e["journal-issue"])?ee[D.replace("journal-issue.","")]:void 0)?Q:null!=(te=e.journalInfo)?te[D.replace("journalInfo.","")]:void 0){"number"==typeof Ue&&(Ue=Ue.toString());try{"string"!=typeof Ue&&(Ue=Ue["date-time"].toString())}catch(e){}if("string"!=typeof Ue)try{for(p in Ue["date-parts"][0])"number"!=(ie=typeof Ue["date-parts"][0][p])&&"string"!==ie&&(Ue["date-parts"][0][p]="01");Ue=Ue["date-parts"][0].join("-")}catch(e){}"string"==typeof Ue&&(Me.published=Ue.includes("T")?Ue.split("T")[0]:Ue,Me.published=Me.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Me.published.includes("-")||(Me.published+="-01"),3!==Me.published.split("-").length&&(Me.published+="-01"),null==Me.year&&(Me.year=Me.published.split("-")[0]),3!==Me.published.split("-").length&&delete Me.published,4!==Me.year.toString().length&&delete Me.year)}if(Me.published)break}e.year&&null==Me.year&&(Me.year=e.year);try{null==Me.year&&(Me.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(null==Me.author&&(null!=e.author||null!=e.z_authors||(null!=(re=e.authorList)?re.author:void 0))){null==Me.author&&(Me.author=[]);try{for(ne=null!=(ae=null!=(le=e.author)?le:e.z_authors)?ae:e.authorList.author,I=0,y=ne.length;I<y;I++)if("string"==typeof(t=ne[I]))Me.author.push({name:t});else{if((r={}).given=null!=(oe=t.given)?oe:t.firstName,r.family=null!=(ue=t.family)?ue:t.lastName,r.name=(r.given?r.given+" ":"")+(null!=(ce=r.family)?ce:""),null!=t.affiliation)try{for(he=r.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:r.authorAffiliationDetailsList.authorAffiliation,j=0,_=he.length;j<_;j++)"string"==typeof(i=he[j])?(null==r.affiliation&&(r.affiliation=[]),r.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==r.affiliation&&(r.affiliation=[]),r.affiliation.push({name:(null!=(pe=i.name)?pe:i.affiliation).replace(/\s\s+/g," ").trim()}))}catch(e){}Me.author.push(r)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(Me.subject=e.subject)}catch(e){}try{null!=(null!=(de=e.keywordList)?de.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(Me.keyword=e.keywordList.keyword)}catch(e){}try{for(ve=[...null!=(me=null!=(ge=e.meshHeadingList)?ge.meshHeading:void 0)?me:[],...null!=(ye=null!=(_e=e.chemicalList)?_e.chemical:void 0)?ye:[]],N=0,v=ve.length;N<v;N++)S=ve[N],null==Me.keyword&&(Me.keyword=[]),"string"==typeof(A="string"==typeof S?S:null!=(we=S.name)?we:S.descriptorName)&&A&&h.call(Me.keyword,A)<0&&Me.keyword.push(A)}catch(e){}"string"==typeof e.license&&(Me.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(Me.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(be=e.best_oa_location)?be.license:void 0)&&null!==(null!=(xe=e.best_oa_location)?xe.license:void 0)&&null==Me.licence&&(Me.licence=e.best_oa_location.license)}catch(e){}if(!Me.licence){if(Array.isArray(e.assertion))for(P=0,w=(ke=e.assertion).length;P<w;P++)"OPEN ACCESS"===(t=ke[P]).label&&t.URL&&t.URL.includes("creativecommons")&&null==Me.licence&&(Me.licence=t.URL);if(Array.isArray(e.license))for(ze=0,b=(Ae=null!=(Oe=e.license)?Oe:[]).length;ze<b;ze++)!(f=Ae[ze]).URL||!f.URL.includes("creativecommons")||Me.licence&&Me.licence.includes("creativecommons")||null==Me.licence&&(Me.licence=f.URL)}if("string"==typeof Me.licence&&Me.licence.includes("/licenses/")&&(Me.licence="cc-"+Me.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Me.url&&(Me.url=null!=(Ie=null!=(je=e.best_oa_location)?je.url_for_pdf:void 0)?Ie:null!=(De=e.best_oa_location)?De.url:void 0),!Me.url&&null!=(null!=(Ce=e.fullTextUrlList)?Ce.fullTextUrl:void 0))for(Be=0,x=(Le=e.fullTextUrlList.fullTextUrl).length;Be<x;Be++)"oa"!==(Ne=(l=Le[Be]).availabilityCode.toLowerCase())&&"f"!==Ne||Me.url&&("pdf"!==l.documentStyle||Me.url.includes("pdf"))||(Me.url=l.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Me.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(Me.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Me.doi&&e.includes("http")&&(Me.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(Me.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?Me.title=e.split('"')[1].trim():e.split("'").length>2&&null==Me.title&&(Me.title=e.split("'")[1].trim())}catch(e){}try{for(L=e.replace(/,\./g," ").split(" "),Fe=0,k=L.length;Fe<k;Fe++)C=L[Fe],Me.year||4===(C=C.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Je=parseInt(C))||isNaN(Je)||(Me.year=Je))}catch(e){}try{!Me.title&&Me.year&&e.indexOf(Me.year)<e.length/4&&(Me.title=e.split(Me.year)[1].trim(),(!Me.title.includes("(")||Me.title.indexOf(")")<Me.title.indexOf("("))&&(Me.title=Me.title.replace(")","")),Me.title.indexOf(".")<3&&(Me.title=Me.title.replace(".","")),Me.title.indexOf(",")<3&&(Me.title=Me.title.replace(",","")),Me.title=Me.title.trim(),Me.title.includes(".")?Me.title=Me.title.split(".")[0]:Me.title.includes(",")&&(Me.title=Me.title.split(",")[0]))}catch(e){}if(Me.title){try{if(a=e.split(Me.title)[0],Me.year&&a.includes(Me.year)&&(a=a.split(Me.year)[0]),Me.url&&a.indexOf(Me.url)>0&&(a=a.split(Me.url)[0]),Me.url&&a.startsWith(Me.url)&&(a=a.replace(Me.url)),Me.doi&&a.startsWith(Me.doi)&&(a=a.replace(Me.doi)),a.indexOf(".")<3&&(a=a.replace(".","")),a.indexOf(",")<3&&(a=a.replace(",","")),a.lastIndexOf("(")>a.length-3&&(a=a.substring(0,a.lastIndexOf("("))),a.lastIndexOf(")")>a.length-3&&(a=a.substring(0,a.lastIndexOf(")"))),a.lastIndexOf(",")>a.length-3&&(a=a.substring(0,a.lastIndexOf(","))),a.lastIndexOf(".")>a.length-3&&(a=a.substring(0,a.lastIndexOf("."))),(a=a.trim()).length>6)if(a.includes(","))for(Me.author=[],Pe=a.split(","),Ye=0,O=Pe.length;Ye<O;Ye++)s=Pe[Ye],Me.author.push({name:s});else Me.author=[{name:a}]}catch(e){}try{We=e.split(Me.title)[1],Me.url&&We.includes(Me.url)&&(We=We.replace(Me.url)),Me.doi&&We.includes(Me.doi)&&(We=We.replace(Me.doi)),We.indexOf(".")<3&&(We=We.replace(".","")),We.indexOf(",")<3&&(We=We.replace(",","")),(We=We.trim()).length>6&&(Me.journal=We,We.includes(",")&&(Me.journal=Me.journal.split(",")[0].replace(/in /gi,"").trim()),Me.journal.indexOf(".")<3&&(Me.journal=Me.journal.replace(".","")),Me.journal.indexOf(",")<3&&(Me.journal=Me.journal.replace(",","")),Me.journal=Me.journal.trim())}catch(e){}}try{if(Me.journal&&(We=e.split(Me.journal)[1],Me.url&&We.includes(Me.url)&&(We=We.replace(Me.url)),Me.doi&&We.includes(Me.doi)&&(We=We.replace(Me.doi)),We.indexOf(".")<3&&(We=We.replace(".","")),We.indexOf(",")<3&&(We=We.replace(",","")),(We=We.trim()).length>4)){if(We.includes("retrieved")&&(We=We.split("retrieved")[0]),We.includes("Retrieved")&&(We=We.split("Retrieved")[0]),Me.volume=We,Me.volume.includes("(")){Me.volume=Me.volume.split("(")[0],Me.volume=Me.volume.trim();try{Me.issue=We.split("(")[1].split(")")[0],Me.issue=Me.issue.trim()}catch(e){}}if(Me.volume.includes(",")){Me.volume=Me.volume.split(",")[0],Me.volume=Me.volume.trim();try{Me.issue=We.split(",")[1],Me.issue=Me.issue.trim()}catch(e){}}if(Me.volume)try{isNaN(parseInt(Me.volume))&&delete Me.volume}catch(e){}if(Me.issue){Me.issue.includes(",")&&(Me.issue=Me.issue.split(",")[0].trim());try{isNaN(parseInt(Me.issue))&&delete Me.issue}catch(e){}}if(Me.volume&&Me.issue)try{(We=e.split(Me.journal)[1]).includes("retriev")&&(We=We.split("retriev")[0]),We.includes("Retriev")&&(We=We.split("Retriev")[0]),Me.url&&We.includes(Me.url)&&(We=We.split(Me.url)[0]),Me.doi&&We.includes(Me.doi)&&(We=We.split(Me.doi)[0]),(We=(We=We.substring(We.indexOf(Me.volume)+(Me.volume+"").length)).substring(We.indexOf(Me.issue)+(Me.issue+"").length)).indexOf(".")<2&&(We=We.replace(".","")),We.indexOf(",")<2&&(We=We.replace(",","")),We.indexOf(")")<2&&(We=We.replace(")","")),We=We.trim(),isNaN(parseInt(We.substring(0,1)))||(Me.pages=We.split(" ")[0].split(".")[0].trim(),Me.pages.length>5&&(Me.pages=Me.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!Me.author&&e.includes("et al")&&(o=e.split("et al")[0].trim(),e.startsWith(o)&&(Me.author=[{name:o+"et al"}])),Me.title&&!Me.volume)try{(n=e.split(Me.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Me.volume=n.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Me.issue&&n.includes("iss")&&(Me.issue=n.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Me.pages&&n.includes("page")&&(Me.pages=n.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof Me.year&&(Me.year=Me.year.toString()),Me},r.availability=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&e.availability.includes("/")?e.doi=e.availability:e.availability.includes(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(a=null!=(l=null!=(y=null!=(w=null!=(b=null!=(x=null!=(k=null!=(O=e.doi)?O:e.pmid)?k:e.pmc)?x:e.pmcid)?b:e.title)?w:e.url)?y:e.id)?l:e.citation)?a:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.find(e)),null!=i.v2){null==(s=i.data).match&&(s.match=null!=(S=null!=(A=null!=(n=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(h=i.v2.metadata)?h.doi:void 0)?u:null!=(p=i.v2.metadata)?p.title:void 0)?o:null!=(d=i.v2.metadata)?d.pmid:void 0)?n:null!=(f=i.v2.metadata)?f.pmc:void 0)?A:null!=(m=i.v2.metadata)?m.pmcid:void 0)?S:null!=(g=i.v2.metadata)?g.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(r=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(j=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+r+" AND type:article&sort=createdAt:desc"))&&null!=(_=j.hits)?_.total:void 0)&&((D={type:"article",_id:(I=j.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(v=I.user)?v.id:void 0)!==e.uid),i.data.requests.push(D))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i};h=[].indexOf;r.ill=async function(e){var t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x;null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),r=e.config;try{r=JSON.parse(r)}catch(e){}for(p in("string"==typeof r||!r&&e.from)&&(null!=(r=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:r)))&&"{}"!==JSON.stringify(r)||(r=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(g=e.from)?g:r)))),null==r&&(r={}),x={name:"librarian",details:""},d=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(c in e[p])"email"!==c&&(e[c]=e[p][c],h.call(d,c)<0&&d.push(c));delete e.metadata}else h.call(d,p)<0&&d.push(p);for(l=0,o=d.length;l<o;l++)if(e[f=d[l]]&&(x[f]=e[f],"author"===f)){for("<p>Authors:<br>",a=!0,s=[],n=0,u=(y=e[f]).length;n<u;n++)(t=y[n]).family&&(a?a=!1:", ",i=t.family+(t.given?" "+t.given:""),s.push(i));x[f]=s}return null!=e.author&&delete e.author,x.illid=e._id=await this.uid(),r.search&&r.search.length&&(e.issn||e.journal)&&(-1!==r.search.indexOf("worldcat")?(w=r.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",w+=null!=e.issn?"in%3A":"ti%3A",w+="&si0qs="+(null!=(_=e.issn)?_:e.journal),w+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(w=r.search,w+=e.issn?e.issn:e.journal),x.worldcatsearchurl=w),b=(b=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!r.email&&!e.email||this.mail({svc:"oaworks",vars:x,template:b,to:null!=(v=r.email)?v:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id}),b=b.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:x,template:b,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:"mark@cottagelabs.com"})),e},r.ill._index=!0,r.ill.collect=async function(e){var t,i,s;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),s="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(s+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(s)),this.waitUntil(this.svc.rscvd(e)),!0},r.ill.openurl=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d;for(s in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),r={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[s]||(e[s]=r[s]);for(l in p="",e.ill_added_params&&(p+=e.ill_added_params.replace("?","")+"&"),p+=e.sid+"=InstantILL&",t){if(d="","author"===l)for(a=0,n=(h=Array.isArray(t.author)?t.author:[t.author]).length;a<n;a++)i=h[a],d.length&&(d+=", "),d+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==l&&"pmid"!==l&&"pmc"!==l&&"pmcid"!==l&&"url"!==l&&"journal"!==l&&"title"!==l&&"year"!==l&&"issn"!==l&&"volume"!==l&&"issue"!==l&&"page"!==l&&"crossref_type"!==l&&"publisher"!==l&&"published"!==l&&"notes"!==l||(d=t[l]);d&&(p+=(e[l]?e[l]:l)+"="+encodeURIComponent(d)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(p=p.replace("usermetadata=true","")).indexOf(o+"=")?p+="&"+o+"=The user provided some metadata.":p=p.replace(o+"=",o+"=The user provided some metadata. ")),p.replace("/&&/g","&")},r.ill.subscription=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(n=this.params.config)?n:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(h in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),a=await this.ill.openurl(e,t),e.ill_added_params&&(a=a.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(d=e.subscription[h])?(f=d.type,d=d.url):f=null!=(u=e.subscription_type[h])?u:"unknown",d=d.trim()){"serialssolutions"===f||-1!==d.indexOf("serialssolutions")?(-1!==(g=d.split(".search")[0]).indexOf("//")&&(g=g.split("//")[1]),d="http://"+g+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===d.indexOf("sfx.")||-1!==d.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===d.indexOf(".exlibris")||-1!==d.indexOf("response_type")||(d=d.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):d+=(-1===d.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(y=d+(-1===d.indexOf("?")?"?":"&")+a).indexOf("snc.idm.oclc.org/login?url=")&&(y=y.split("snc.idm.oclc.org/login?url=")[1]),y=y.replace("cache=true",""),("sfx"===f||-1!==d.indexOf("sfx.")&&-1!==y.indexOf("=10."))&&(y=y.replace("=10.","=doi:10.")),("exlibris"===f||-1!==d.indexOf(".exlibris")&&-1!==y.indexOf("doi=10."))&&(y=y.replace("doi=10.","ID=doi:10.")),l="",p="",i=!1,c.lookups.push(y);try{p=-1!==(l=-1!==y.indexOf(".xml.serialssolutions")||-1!==y.indexOf("sfx.response_type=simplexml")||-1!==y.indexOf("response_type=xml")?await this.fetch(y):await this.puppet(y)).indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,c.contents.push(p)}catch(e){e,i=!0}if("sfx"===f||-1!==y.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==p.indexOf("getFullTxt")&&-1!==p.indexOf("<target_url>"))try{c.url=p.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(e){}else-1!==p.indexOf('<a title="navigate to target in new window')&&-1!==p.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=y,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==y.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==p.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(c.url=y.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==y.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==p.indexOf('<ssopenurl:url type="article">'))(s=p.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=s,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===p.indexOf("ss_noresults"))try{m=y.split("?")[0]+"?ShowSupressedLinks"+l.split("?ShowSupressedLinks")[1].split('">')[0],-1!==(r=await this.puppet(m)).indexOf("ArticleCL")&&-1!==r.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+r.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(e){i&&c.error.push("serialssolutions")}}else"exlibris"!==f&&-1===y.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==p.indexOf("full_text_indicator")&&0===p.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==p.indexOf("resolution_url")&&(c.url=p.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},r.licence=async function(e,t,i,s){var r,a,l,n,o,u,c,h,p,d,f,m,g;if(null==e&&(e=this.params.url),null==t&&(t=null!=(c=this.params.content)?c:this.body),e||t||!this.params.licence&&!this.params.doi||(e="https://doi.org/"+(null!=(h=this.params.licence)?h:this.params.doi)),e&&(e=e.replace(/(^\s*)|(\s*$)/g,""),!t)){console.log(e);try{t=await this.puppet(e)}catch(e){}}if("number"==typeof t&&(t=void 0),null==i&&(i=this.params.start),null==s&&(s=this.params.end),n={},e&&(n.url=e),"string"==typeof t)for(null!=i&&t.includes(i)&&(t=t.split(i)[1]),s&&(t=t.split(s)[0]),t.length>1e5&&(n.large=!0,t=t.substring(0,5e4)+t.substring(t.length-5e4,t.length)),r=0,l=(f=null!=(p=null!=(o=await this.licences("*",1e4))&&null!=(d=o.hits)?d.hits:void 0)?p:[]).length;r<l;r++)if((!(a=f[r]._source).matchesondomains||"*"===a.matchesondomains||null==e||a.matchesondomains.toLowerCase().includes(e.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=a.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(m=!!(g=!!a.matchtext.includes("://")&&a.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&t.toLowerCase().includes(g))||t.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){n.licence=a.licencetype,n.match=a.matchtext,n.matched=m?g:u;break}return n},r.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1};h=[].indexOf;r.permissions=async function(e,t,i,s,r,l){var n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe,me,ge,ye,_e,ve,we,be,xe,ke,Oe,Se,Ae,Ie,je,De,Ce,Le,Ne,Pe,Re,Te,Ee,qe,Me,We,Ue,ze;if(z=!1,y=!1,n=async function(t){var i,s,l,n,o,u,c,h,p,d,f,m,g,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P;if(y&&t.embargo_months&&(e.published||e.year)&&(s=new Date(Date.parse(null!=(g=e.published)?g:e.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+t.embargo_months)),t.embargo_end=s.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(_=t.copyright_owner.toLowerCase())&&"affiliation"!==_?y&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(A=e.author[0].name)?A:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(S=e.journal)?S:"",("publisher"===(I=t.copyright_name.toLowerCase())||"journal"===I)&&(r||e.doi||(null!=(j=t.provenance)?j.example:void 0)))for(null==r&&(r=await this.src.crossref.works(null!=(D=e.doi)?D:t.provenance.example)),o=0,h=(L=null!=(C=null!=r?r.assertion:void 0)?C:[]).length;o<h;o++)if("copyright"===(i=L[o]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace(" ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(y&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,y&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(n="",u=0,p=(N=t.deposit_statement.split("<<")).length;u<p;u++)if(m=N[u],""!==n||m.includes(">>")){if(null!=(P={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(l=m.split(">>"))[0].toLowerCase()]&&(f=P[f]),"author"===f)try{n+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else n+=null!=(w=null!=(b=e[f])?b:t[f])?w:"";try{n+=l[1]}catch(e){}}else n+=m;t.deposit_statement=n}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(a.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(k=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==k||(z=t.issuer.has_policy),c=0,d=(O=["_id","hide"]).length;c<d;c++)delete t[O[c]];return t},u=e=>{var t,i,s,r,a,l;return l=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(l+=1e3),null!=e.requirements?l-=10:l+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,e.licence&&(l-=5),l+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?4:"university"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?3:"article"===(null!=(a=e.issuer)?a.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(l-=25),l},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),b=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&e.issn.includes(",")&&(e.issn=e.issn.split(",")),delete e.best,"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(null==l&&(l=this.params.best),l&&e.doi&&!e.ror.length&&(p=await this.permissions.best(e.doi))&&(!0===l||p.updated>l))return delete p.updated,delete p.DOI,{best_permission:p};if(o=async()=>{var t,i,s,a,l;if(i=this.copy(e),"{}"!==JSON.stringify(i)){for(t in a=[],l=null!=(s=null!=r?r:await this.metadata(e.doi))?s:{})a.push(null!=e[t]?e[t]:e[t]=l[t]);return a}},!1===i||!e.doi||e.publisher&&e.issn||await o(),!e.published&&e.year&&(e.published=e.year+"-01-01"),y=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!b.length)for(_=0,S=(H=e.issn).length;_<S;_++)w=H[_],h.call(b,w)<0&&b.push(w);try{null==e.doi&&(e.doi=await this.permissions.journals.example(b))}catch(e){}!y&&e.doi&&await o()}if(y&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(le=e.page)?le:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(me=e.year)?me:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(F={best_permission:void 0,all_permissions:[]},Le=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(Re=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(Se=Re.hits)?Se.total:void 0))try{(null!=(Ae=(Te=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')).hits)?Ae.total:void 0)&&(Te=Te.hits.hits[0]._source),Te.country.country_code&&(Re=await this.permissions.affiliations('issuer.id:"'+Te.country.country_code+'"'))}catch(e){}for(x=0,A=(De=null!=(Ie=null!=Re&&null!=(je=Re.hits)?je.hits:void 0)?Ie:[]).length;x<A;x++)Pe=De[x],(Me=await n(Pe._source)).score=await u(Me),Le.push(Me)}if(v=void 0,b){for await(G of this.index._for("src_doaj_journals",'bibjson.pissn:"'+b.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+b.join('" OR bibjson.eissn:"')+'"'))v||(v=G),Z=G.bibjson.pissn,h.call(b,Z)<0&&b.push(G.bibjson.pissn),Q=G.bibjson.eissn,h.call(b,Q)<0&&b.push(G.bibjson.eissn);if(null==v){for await(G of(W=[],this.index._for("src_openalex_venues",'issn:"'+b.join('" OR issn:"')+'"')))for(O=0,j=(K=G.issn).length;O<j;O++)g=K[O],h.call(W,g)<0&&W.push(g);b=W}if(b.length)for(q=0,D=(ie=null!=(ee=null!=(Y=await this.permissions.journals('issuer.id:"'+b.join('" OR issuer.id:"')+'"'))&&null!=(te=Y.hits)?te.hits:void 0)?ee:[]).length;q<D;q++)J=ie[q],(Ne=await n(J._source)).score=await u(Ne),F.all_permissions.push(Ne)}if(e.publisher)for(X='issuer.id:"'+e.publisher+'"',M=0,C=(ae=null!=(se=null!=(Y=await this.permissions.publishers(X))&&null!=(re=Y.hits)?re.hits:void 0)?se:[]).length;M<C;M++)J=ae[M],(Ne=await n(J._source)).score=await u(Ne),F.all_permissions.push(Ne);if(c={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},b&&(null!=v?v:v=await this.src.doaj.journals('bibjson.eissn.keyword:"'+b.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+b.join('" OR bibjson.pissn.keyword:"')+'"',1))){for(U=0,L=(ue=null!=(ne=null!=(oe=v.bibjson)?oe.license:void 0)?ne:[]).length;U<L;U++)f=ue[U],(!c.licence||c.licence.length>f.type)&&(c.licence=f.type),null==c.licences&&(c.licences=[]),c.licences.push({type:f.type});if(null==c.licence&&(d=await this.src.crossref.journals('ISSN.keyword:"'+b.join('" OR ISSN.keyword:"')+'"',1)))for(V=0,N=(he=null!=(ce=d.license)?ce:[]).length;V<N;V++)E=he[V],(!c.licence||c.licence.length>E.type)&&(c.licence=E.type);"string"==typeof c.licence?(c.licence=c.licence.toLowerCase().trim(),c.licence.startsWith("cc")?c.licence=c.licence.replace(/ /g,"-"):c.licence.includes("creative")?c.licence=c.licence.includes("0")||c.licence.includes("zero")?"cc0":c.licence.includes("share")?"ccbysa":c.licence.includes("derivative")?"ccbynd":"ccby":delete c.licence):delete c.licence,c.issuer.id=v.bibjson.eissn&&v.bibjson.pissn?[v.bibjson.pissn,v.bibjson.eissn]:v.bibjson.pissn?[v.bibjson.pissn]:[v.bibjson.eissn],c.embargo_months=0,c.provenance={oa_evidence:"In DOAJ"},c.score=await u(c),F.all_permissions.push(c)}else!b&&e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(c.issuer.id=e.publisher,c.meta.creator=["joe+oapublisher@oa.works"],c.meta.contributors=["joe+oapublisher@oa.works"],c.provenance={oa_evidence:"OA publisher"},c.score=await u(c),F.all_permissions.push(c));if(e.doi&&(null==s&&(s=await this.src.oadoi(e.doi)),y&&(null!=s&&null!=(pe=s.best_oa_location)?pe.license:void 0)&&s.best_oa_location.license.includes("cc")&&((m={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(m.versions="submittedVersion"===m.version?["submittedVersion"]:"acceptedVersion"===m.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),m.score=await u(m),F.all_permissions.push(m))),F.all_permissions.length){for(F.all_permissions.sort((e,t)=>e.score<t.score?1:-1),$=0,P=(de=F.all_permissions).length;$<P;$++)null==(ze=de[$]).licences&&(ze.licences=[],ze.licence&&ze.licences.push({type:ze.licence})),y&&(null!=(fe=ze.issuer)?fe.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(ze.issuer.journal_oa_type_from)&&delete ze.issuer.journal_oa_type,delete ze.issuer.journal_oa_type_from,!b&&"journal"!==(null!=(ge=ze.issuer)?ge.type:void 0)||ze.issuer.journal_oa_type||(ze.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=b?b:ze.issuer.id,v,s,r)),(null!=(ye=ze.provenance)?ye.enforcement_from:void 0)?(!e.published||Date.parse(e.published)>Date.parse(ze.provenance.enforcement_from.split("/").reverse().join("-")))&&null==F.best_permission&&(F.best_permission=this.copy(ze)):null==F.best_permission&&(F.best_permission=this.copy(ze));if(Le.length)for(Le.sort((e,t)=>e.score<t.score?1:-1),Ee=0,R=Le.length;Ee<R;Ee++)if(Ce=Le[Ee],y&&(null!=(_e=Ce.issuer)?_e.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Ce.issuer.journal_oa_type_from)&&delete Ce.issuer.journal_oa_type,delete Ce.issuer.journal_oa_type_from,!b&&"journal"!==(null!=(ve=Ce.issuer)?ve.type:void 0)||Ce.issuer.journal_oa_type||(Ce.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=b?b:Ce.issuer.id,v,s,r)),F.all_permissions.push(Ce),null==(null!=(we=F.best_permission)?we.author_affiliation_requirement:void 0)&&null!=F.best_permission&&(!(null!=(be=Ce.provenance)?be.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(Ce.provenance.enforcement_from.split("/").reverse().join("-")))){for(B=this.copy(F.best_permission),qe=0,T=(xe=["versions","locations"]).length;qe<T;qe++)for(We=0,I=(ke=Ce[k=xe[qe]]).length;We<I;We++)Ue=ke[We],null==B[k]&&(B[k]=[]),h.call(B[k],Ue)<0&&B[k].push(Ue);B.version=h.call(B.versions,"publishedVersion")>=0?"publishedVersion":h.call(B.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",B.embargo_end&&Ce.embargo_end&&Date.parse(Ce.embargo_end)<Date.parse(B.embargo_end)&&(B.embargo_end=Ce.embargo_end),B.embargo_months&&null!=Ce.embargo_months&&Ce.embargo_months<B.embargo_months&&(B.embargo_months=Ce.embargo_months),!0===Ce.can_archive&&(B.can_archive=!0),null==B.requirements&&(B.requirements={}),B.requirements.author_affiliation_requirement=null==e.ror?Ce.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],B.issuer.affiliation=Ce.issuer,null==B.meta&&(B.meta={}),B.meta.affiliation=Ce.meta,null==B.provenance&&(B.provenance={}),B.provenance.affiliation=Ce.provenance,B.score=parseInt(B.score)+parseInt(Ce.score),F.best_permission=B,F.all_permissions.push(B)}}return z?{body:"string"!=typeof z?z:null!=(Oe={"not publisher":"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it"}[z.toLowerCase()])?Oe:z,status:501}:(e.doi&&!Le.length&&F.best_permission&&((p=await this.copy(F.best_permission)).updated=await this.epoch(),p.DOI=e.doi,this.waitUntil(this.permissions.best(p))),!0!==this.params.metadata&&!0!==i||(F.metadata=e),F)},r.permissions.best={_index:!0,_key:"DOI"},r.permissions.journals={_sheet:"1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",_prefix:!1,_format:async function(e=[]){var t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w;for(m=[],r=0,u=(y="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<u;r++){for(l in f={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},g=y[r])if("string"==typeof g[l]&&(g[l]=g[l].trim()),"id"===l)if(f.issuer.id="string"==typeof g.id&&g.id.includes(",")?g.id.split(","):g.id,"string"==typeof f.issuer.id&&f.issuer.id.startsWith("10.")&&f.issuer.id.includes("/")&&!f.issuer.id.includes(" "))f.DOI=f.issuer.id;else{for(s=[],a=0,c=(_="string"==typeof f.issuer.id?[f.issuer.id]:f.issuer.id).length;a<c;a++){if(d=(d=_[a]).trim(),"journal"===f.issuer.type&&d.includes("-")&&!d.includes(" ")&&(d=d.toUpperCase(),t=await this.journal('ISSN:"'+d+'"',1)))for(o=0,p=(v=t.issn).length;o<p;o++)i=v[o],h.call(s,i)<0&&s.push(i);h.call(s,d)<0&&s.push(d)}f.issuer.id=s}else"embargo_months"===l?(n="number"==typeof g[l]?g[l]:"string"==typeof g[l]?parseInt(g[l].trim()):void 0)&&"number"==typeof n&&(f.embargo_months=n,f.embargo_end=""):l&&null!=g[l]&&""!==(w=g[l])&&"none"!==w&&"unclear"!==w&&("versions"===l&&g.versions.length&&(f.can_archive=!0,f.version=g.versions.includes("ublish")?"publishedVersion":g.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==l&&"locations"!==l&&"meta.contributors"!==l&&"meta.creator"!==l&&"meta.reviewer"!==l&&"provenance.archiving_policy"!==l&&"requirements.funder"!==l&&"journal"!==l||(g[l]=g[l].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(f,"license"===l?"licence":l,g[l]));f.copyright_owner&&"journal"!==f.copyright_owner.toLowerCase()||!f.issuer.type||(f.copyright_owner=f.issuer.type),"{}"===JSON.stringify(f.requirements)&&delete f.requirements,m.push(f)}return 1===m.length?m[0]:m}},r.permissions.publishers={_sheet:"11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",_prefix:!1,_format:r.permissions.journals._format},r.permissions.affiliations={_sheet:"15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",_prefix:!1,_format:r.permissions.journals._format},r.permissions.journals.example=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.crossref.works('ISSN:"'+e.join('" OR ISSN:"')+'"',1)).DOI}catch(e){}},r.permissions.journals.transformative={_index:!0,_prefix:!1},r.permissions.journals.transformative.load=async function(){var e,t,i,s,r;for(e=[],t=0,i=(r=(await this.fetch("https://api.journalcheckertool.org/tj?q=*&include=title,issn&size=10000")).hits.hits).length;t<i;t++)s=r[t],e.push(s._source);return e.length&&(await this.permissions.journals.transformative(""),await this.permissions.journals.transformative(e)),e.length},r.permissions.journals.transformative.load._bg=!0,r.permissions.journals.transformative.load._async=!0,r.permissions.journals.transformative.load._auth="root",r.permissions.journals.oa=async function(e,t){var i,s,r,a,l,n;try{null==e&&(e=null!=(s=null!=(r=null!=(a=this.params.journals)?a:this.params.journal)?r:this.params.issn)?s:this.params.oa)}catch(e){}return n={},e&&(n.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'"'),n.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'" AND is_oa:true'),n.articles===n.open&&(n.oa=!0),await this.src.doaj.journals('bibjson.pissn:"'+e+'" OR bibjson.eissn:"'+e+'"',1)&&(n.open=n.articles,n.doaj=!0,n.oa=!0),(i=await this.permissions.journals.example(e))&&(null==t&&(t=await this.src.oadoi(i,1)),null!=t?(delete n.oa,n.open=n.articles,n.oadoi=!0,n.oa=(null!=t&&null!=(l=t.best_oa_location)?l.license:void 0)&&t.best_oa_location.license.includes("cc")):n.oa=!1)),n},r.permissions.journals.oa.type=async function(e,t,i,s){var r,a,l,n,o,u,c,h,p;return null==e&&(e=null!=(a=null!=(l=null!=(n=null!=(o=null!=(u=null!=(c=null!=i?i.journal_issns:void 0)?c:null!=s?s.ISSN:void 0)?u:this.params.journals)?o:this.params.journal)?n:this.params.type)?l:this.params.issn)?a:this.params.issns),"string"==typeof e&&(e=e.split(",")),"string"==typeof e&&e.startsWith("10.")&&(null==i&&(i=await this.src.oadoi(e)),null==s&&(s=await this.src.crossref.works(e)),e=void 0),r="unknown",null!=(null!=s?s.type:void 0)&&"journal-article"!==s.type?r="not applicable":(null!=s?s.type:void 0)&&"journal-article"!==s.type||(r="gold"===(null!=i?i.oa_status:void 0)||(null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",null==t&&e&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?r=!1===(null!=(h=t.bibjson)&&null!=(p=h.apc)?p.has_apc:void 0)?"diamond":"gold":e&&(e&&await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?r="transformative":"closed"===r&&await this.src.oadoi.hybrid(e)&&(r="hybrid"))),r},r.permissions.publishers.oa=async function(e){var t,i,s,r;return r={publisher:(null!=(s=null!=e?e:this.params.publisher)?s:this.params.oa).replace(/&/g,"")},await this.src.crossref.journals('publisher:"'+r.publisher+'"',1)||((t=await this.src.crossref.journals('publisher:"'+r.publisher.split(" ").join('" AND publisher:"')+'"',1))?t.publisher.toLowerCase()!==r.publisher.toLowerCase()&&((i=await this.levenshtein(t.publisher,r.publisher)).distance<5||(i.length.a>i.length.b?i.length.a:i.length.b)/i.distance>10)&&(r.publisher=t.publisher):r.journals=0),null==r.journals&&(r.journals=await this.src.crossref.journals.count('publisher:"'+r.publisher+'" AND NOT discontinued:true')),r.open=await this.src.doaj.journals.count('publisher:"'+r.publisher+'" AND NOT bibjson.discontinued_date:* AND NOT .bibjson.is_replaced_by:*'),r.percent=r.journals?Math.ceil(r.open/r.journals*100):r.open?100:0,r.oa=!r.journals&&r.open||r.journals&&r.journals===r.open,r};h=[].indexOf;try{a.report=JSON.parse(SECRETS_REPORT)}catch(e){}null==a.report&&(a.report={}),r.report=function(){return"OA.Works report"},r.report.fixemails=async function(){var e,t,i,s;for await(s of(t=0,this.index._for((this.S.dev?"paradigm_b_":"paradigm_")+"report_works","email:* OR supplements.email:*",{scroll:"30m"}))){for(i in e=!1,"string"==typeof s.email&&s.email.includes("@")&&(s.email=await this.encrypt(s.email),e=!0),s.supplements)null!=s.supplements[i].email&&(Array.isArray(s.supplements[i].email)&&(s.supplements[i].email=s.supplements[i].email[0]),"string"==typeof s.supplements[i].email&&s.supplements[i].email.includes("@")&&(s.supplements[i].email=await this.encrypt(s.supplements[i].email),e=!0));e&&(await this.report.works(s),t+=1)}return t},r.report.fixemails._auth="@oa.works",r.report.fixtypes=async function(){var e,t,i,s,r,a,l,n,o;for await(o of(e=0,i=0,n=0,this.index._for((this.S.dev?"paradigm_b_":"paradigm_")+"report_works","NOT title:*",{scroll:"30m"})))o.DOI.startsWith("10.")&&(n+=1,t=await this.src.crossref.works(o.DOI),r=await this.src.openalex.works('ids.doi.keyword:"https://doi.org/'+o.DOI+'"',1),s=await this.report.works._process(t,r),await this.report.works(s)),console.log("fixing report works types titles",n);for await(l of this.index._for((this.S.dev?"paradigm_b_":"paradigm_")+"report_works",'(NOT type.keyword:"journal-article" AND NOT type.keyword:"posted-content")',{scroll:"30m"}))e+=1,l.DOI.startsWith("10.")&&(null==(t=await this.src.crossref.works(l.DOI))&&(r=await this.src.openalex.works('ids.doi.keyword:"https://doi.org/'+l.DOI+'"',1)),null==t&&null==r||(null!=t?t.type:void 0)===l.type&&(null!=r?r.type:void 0)===l.type||(i+=1,l.type=null!=(a=null!=t?t.type:void 0)?a:r.type,await this.report.works(l))),console.log("fixing report works types",e,i);return this.mail({to:["mark@oa.works"],subject:"OA report works types fixed "+i,text:e+" checked and fixed "+i+" and reprocessed "+n}),i},r.report.fixtypes._async=!0,r.report.fixtypes._bg=!0,r.report.fixtypes._auth="root",r.report.dev2live=async function(e){var t,i,s,r,a;for await(r of(e?(s="paradigm_report_works",a="paradigm_b_report_works"):(s="paradigm_b_report_works",a="paradigm_report_works"),await this.index._send(a,"",void 0,!1),i=0,t=[],this.index._for(s)))i+=1,!r.DOI||r.DOI.includes(" pmcid:")||r.DOI.includes("\n")||r.DOI.includes("?ref")||t.push(r),3e4===t.length&&(console.log("report works",e?"live2dev":"dev2live",s,a,i),await this.index._bulk(a,t,void 0,void 0,!1),t=[]);return t.length&&(await this.index._bulk(a,t,void 0,void 0,!1),t=[]),i},r.report.dev2live._async=!0,r.report.dev2live._bg=!0,r.report.dev2live._auth="root",r.report.live2dev=function(){return this.report.dev2live(!0)},r.report.live2dev._async=!0,r.report.live2dev._bg=!0,r.report.live2dev._auth="root",r.report.oapolicy={_sheet:a.report.oapolicy_sheet,_format:function(e=[]){var t,i,s,r,a,l,n,o;for(l=[],0,s=0,r=(o="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<r;s++){for(i in a={},n=o[s]){if("string"==typeof n[i])if(n[i]=n[i].trim(),"true"===n[i].toLowerCase())n[i]=!0;else if("false"===n[i].toLowerCase())n[i]=!1;else if(n[i].startsWith("[")&&n[i].endsWith("]")||n[i].startsWith("{")&&n[i].endsWith("}"))try{n[i]=JSON.parse(n[i])}catch(e){t=e,console.log("cant parse "+i,n[i],t),1}else n[i].includes(";")&&(n[i]=n[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(null!=n[i]&&""!==n[i])if(i.includes("."))try{this.dot(a,i,n[i])}catch(e){}else a[i]=n[i]}"{}"!==JSON.stringify(a)&&l.push(a)}return 1===l.length?l[0]:l}},r.report.orgs={_sheet:a.report.orgs_sheet,_format:async function(e=[]){var t,i,s,r,a,l,n,o,u,c,h,p;for(o=[],0,s=0,a=(c="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<a;s++){for(i in n={},u=c[s]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(e){t=e,console.log("cant parse "+i,u[i],t),1}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(n,i,u[i])}catch(e){}else n[i]=u[i]}if(Array.isArray(n.sheets))for(r=0,l=(h=n.sheets).length;r<l;r++)(p=h[r]).url=await this.encrypt(p.url);else delete n.sheets;"{}"!==JSON.stringify(n)&&o.push(n)}return 1===o.length?o[0]:o}},r.report.orgs.supplement=async function(e,t,i,s,r,a,l,n){var o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe,me,ge,ye,_e,ve,we,be,xe,ke,Oe,Se,Ae,Ie,je,De,Ce,Le,Ne,Pe,Re,Te,Ee,qe,Me,We,Ue,ze,Je,Be,Fe,Ye,Ve,Xe,$e,Ge,He,Ze;if(null==e&&(e=this.params.sheet),null==t&&(t=this.params.org),null==i&&(i=this.params.max),null==r&&(r=this.params.reload),null==a&&(a=this.params.reprocess),Pe=null!=(he=this.params.repmc)&&he,"string"==typeof s&&null==(s=await this.report.works(s))&&(s=await this.src.crossref.works(s)),se=!1,null==s&&this.params.supplement&&this.params.supplement.startsWith("10.")&&(se=this.params.supplement.toLowerCase(),s=await this.src.crossref.works(se)),Be=[],b=[],B=0,_=0,v={},m={},ee={},null==s||se){for await(K of this.index._for("report_orgs","sheets.url:*"))if(!t||K.name===t)for(null==ee[X=K.name]&&(ee[X]={}),console.log("supplementing for",K.name),A=0,D=(xe=K.sheets).length;A<D;A++)if(qe=xe[A],null==(u=ee[K.name])[$=qe.name]&&(u[$]=0),!e||qe.name===e){console.log("supplementing from sheet",qe.name),Ve=await this.decrypt(qe.url),Be.push(K.name+" "+qe.name+" "+Ve),O=[],Te=[],Fe=0,await this.sleep(2e3);try{Te=await this.src.google.sheets({sheetid:Ve,sheet:"Export",headers:!1})}catch(e){b.push(K.name+" "+qe.name+" "+Ve)}for(;(!Array.isArray(Te)||!Te.length)&&Fe<3;){await this.sleep(5e3),Fe+=1;try{Te=await this.src.google.sheets({sheetid:Ve,sheet:"Export",headers:!1})}catch(e){}}if(Array.isArray(Te)&&Te.length)for(j=0,C=(Se=Te.shift()).length;j<C;j++)k=Se[j],O.push(k.toLowerCase().trim().replace(/ /g,"_").replace("?",""));else Te=[];for(console.log(Te.length,"rows from sheet with headers",JSON.stringify(O)),Y=0,ce=0,F=0,R=Te.length;F<R;F++){if(Re=Te[F],ee[K.name][qe.name]+=1,ce+=1,console.log("processing row",ce,"for",K.name,qe.name),(Y+=1)===i){console.log("stopping supplementing for",qe.name,"due to max limit");break}for(S in Ee={supplements:[{orgs:[K.name],sheets:[qe.name],ror:K.ror,paid:K.paid}],orgs:[K.name],paid:K.paid?[K.name]:[]},O)if("doi"===(x=O[S])||"DOI"===x)Ee[x]=Re[S];else if("apc_cost"===x)try{Ee.supplements[0].apc_cost=parseInt(Re[S])}catch(e){}else x.includes(".")?await this.dot(Ee.supplements[0],x,Re[S]?"true"===(Ae=Re[S].trim().toLowerCase())||"yes"===Ae||"false"!==(Ie=Re[S].trim().toLowerCase())&&"no"!==Ie&&("grant_id"===(je=x.toLowerCase())||"ror"===je?Re[S].replace(/\//g,",").replace(/ /g,"").split(","):"string"==typeof Re[S]&&Re[S].includes(";")?Re[S].split(";"):Re[S]):void 0):(Ee.supplements[0][x]=Re[S]?"true"===(De=Re[S].trim().toLowerCase())||"yes"===De||"false"!==(Ce=Re[S].trim().toLowerCase())&&"no"!==Ce&&("grant_id"===(Le=x.toLowerCase())||"ror"===Le?Re[S].replace(/\//g,",").replace(/ /g,"").split(","):Re[S]):void 0,"string"==typeof Ee.supplements[0][x]&&Ee.supplements[0][x].includes(";")&&(Ee.supplements[0][x]=Ee.supplements[0][x].split(";")));if(null==Ee.DOI&&(Ee.DOI=Ee.doi),Ee.DOI&&Ee.DOI.startsWith("http"))try{Ee.DOI="10."+Ee.DOI.split("/10.")[1]}catch(e){}if(Ee.DOI&&(Ee.DOI=Ee.DOI.toLowerCase().split("\\")[0].trim().replace(/^\//,"").split("?")[0].split(" pmcid")[0].split("\n")[0]),Ee.DOI&&(!se||se===Ee.DOI)){if(_+=1,null!=v[Ee.DOI]){for(I in v[Ee.DOI])null==Ee[I]&&(Ee[I]=v[Ee.DOI][I]);for(V=0,T=(pe=v[Ee.DOI].supplements).length;V<T;V++)We=pe[V],(!t||h.call(We.orgs,t)<0)&&(!e||h.call(We.sheets,e)<0)&&Ee.supplements.push(We);for(H=0,E=(de=v[Ee.DOI].paid).length;H<E;H++)re=de[H],h.call(Ee.paid,re)<0&&Ee.paid.push(re);for(ie=0,q=(fe=v[Ee.DOI].orgs).length;ie<q;ie++)Z=fe[ie],h.call(Ee.orgs,Z)<0&&Ee.orgs.push(Z)}v[Ee.DOI]=Ee,null==m[G=Ee.DOI]&&(m[G]=0),m[Ee.DOI]+=1}}}}else v[s.DOI]=s;for(y in c=[],v){if(B+=1,console.log(B),Ee=v[y],!0!==r&&(null==s||se)&&(Ge=await this.report.works(Ee.DOI))&&(null!=(null!=(me=Ge.hits)?me.hits:void 0)&&(Ge=1===Ge.hits.hits.length?Ge.hits.hits[0]._source:void 0),null!=Ge)){for(I in Ge)"hits"!==I&&"_shards"!==I&&"took"!==I&&"timed_out"!==I&&"q"!==I&&"is_paratext"!==I&&"is_retracted"!==I&&null==Ee[I]&&(Ee[I]=Ge[I]);if(Ge.supplements&&(t||e))for(ne=0,M=(ge=Ge.supplements).length;ne<M;ne++)We=ge[ne],(!t||h.call(We.orgs,t)<0)&&(!e||h.call(We.sheets,e)<0)&&Ee.supplements.push(We);if(Ge.paid&&(t||e))for(oe=0,W=(ye=Ge.paid).length;oe<W;oe++)"string"==typeof(re=ye[oe])&&h.call(Ee.paid,re)<0&&Ee.paid.push(re);if(Ge.orgs&&(t||e))for(Ye=0,U=(_e=Ge.orgs).length;Ye<U;Ye++)"string"==typeof(Z=_e[Ye])&&h.call(Ee.orgs,Z)<0&&Ee.orgs.push(Z)}if((!(null!=Ge?Ge.title:void 0)||null==(null!=Ge?Ge.authorships:void 0)||null!=l||null!=n||!0===a)&&(g=null!=l?l:await this.src.crossref.works(Ee.DOI),null==(Q=null!=n?n:await this.src.openalex.works('ids.doi:"https://doi.org/'+Ee.DOI+'"',1))&&(Q=await this.src.openalex.works.doi(Ee.DOI)),(null!=g||null!=Q)&&(ae=await this.report.works._process(g,Q))))if(ae.is_paratext||ae.is_retracted)Ee=void 0;else for(I in ae)"is_paratext"!==I&&"is_retracted"!==I&&null==Ee[I]&&(Ee[I]=ae[I]);if(null!=(null!=Ee?Ee.authorships:void 0)&&!Ee.author_email_name){for(o=Ee.email,Xe=0,z=(ve=Ee.supplements).length;Xe<z;Xe++)(ze=ve[Xe]).email&&!o&&(o=ze.email);if(o)if("string"!=typeof o&&(o=o[0]),null==Ee.email&&(Ee.email=o),1===Ee.authorships.length)Ee.author_email_name="Dr. "+(null!=(we=Ee.authorships[0].author)?we.display_name:void 0);else{for(Ne=o.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),p="",d="",f=1e6,$e=0,L=(be=Ee.authorships).length;$e<L;$e++)(ue=null!=(ke=be[$e].author)?ke.display_name:void 0)&&((Me=(await this.levenshtein(Ne,ue.toLowerCase().replace(/[^a-z]/g,""))).distance/ue.length)<f&&(f=Me,d=ue),f>.2&&(Ne.endsWith(ue.split(" ").pop().toLowerCase())||ue.split(" ")[0].length>4&&Ne.includes(ue.split(" ")[0].toLowerCase()))&&(f=.1,d=ue),!p&&Ne.startsWith((ue.split(" ")[0].slice(0,1)+ue.split(" ").pop().slice(0,1)).toLowerCase())&&(p=ue));d&&f<.7&&(Ee.author_email_name="Dr. "+d.split(" ").pop()),!Ee.author_email_name&&p&&(Ee.author_email_name="Dr. "+p)}}if(null==(null!=Ee?Ee.paid:void 0)||!Ee.paid.length||!1===this.params.pmc||Ee.pmc_checked&&!0!==r&&!0!==Pe||(se&&console.log("checking for pmc",Ee.PMCID,Ee.DOI),Ee.pmc_checked=!0,!Ee.PMCID&&(le=await this.src.pubmed.doi(Ee.DOI))&&(null!=le&&null!=(Oe=le.identifier)?Oe.pmc:void 0)&&(Ee.PMCID="PMC"+le.identifier.pmc.toLowerCase().replace("pmc","")),w=void 0,!Ee.PMCID&&(w=await this.src.epmc.doi(Ee.DOI))&&w.pmcid&&(Ee.PMCID=w.pmcid),Ee.PMCID&&Ee.repository_url_in_pmc&&!Ee.epmc_licence&&(J=await this.src.epmc.licence(Ee.PMCID,w),Ee.epmc_licence=null!=J?J.licence:void 0),Ee.pmc_has_data_availability_statement=Ee.PMCID&&await this.src.pubmed.availability(Ee.PMCID)),null!=Ee){for(We in Ee.updated=await this.epoch(),Ee.supplements)null!=Ee.supplements[We].email&&(Array.isArray(Ee.supplements[We].email)&&(Ee.supplements[We].email=Ee.supplements[We].email[0]),"string"==typeof Ee.supplements[We].email&&Ee.supplements[We].email.includes("@")&&(Ee.supplements[We].email=await this.encrypt(Ee.supplements[We].email)),null==Ee.email&&(Ee.email=Ee.supplements[We].email));"string"==typeof Ee.email&&Ee.email.includes("@")&&(Ee.email=await this.encrypt(Ee.email)),c.push(Ee)}1e4===c.length&&(await this.report.works(c),console.log("report orgs supplemented",B),c=[])}if(c.length&&(await this.report.works(c),c=[]),null==s){for(Je="https://bg."+(this.S.dev?"beta":"api")+".oa.works/report/works?q=supplements.orgs:*\n\n",Je+="Sheets tried:\n\n",He=0,N=Be.length;He<N;He++)Je+=Be[He]+"\n";for(Be.length||(Je+="None\n"),Je+="\n\nSheets failed:\n\n",Ze=0,P=b.length;Ze<P;Ze++)Je+=b[Ze]+"\n";for(te in b.length||(Je+="None\n"),Je+="\n\nSheet counts:\n\n",ee)for(Ue in Je+=te+"\n",ee[te])Je+=Ue+" "+ee[te][Ue]+" DOIs\n";Je+="\n\n"+_+" DOIs were found in the sheets\n\n",this.mail({to:["mark@oa.works","joe@oa.works"],subject:"OA report supplements loaded "+B,text:Je})}return B},r.report.orgs.supplement._async=!0,r.report.orgs.orgkeys={_index:!0,_auth:"@oa.works"},r.report.orgs.key=async function(e){var t,i;if(null==e&&(e=this.params.org),null!=e){if(e=e.toLowerCase(),null==(i=await this.report.orgs.orgkeys('org.keyword:"'+e+'"',1))||this.refresh){if(null!=i){i.lastRefreshedAt=await this.epoch();try{i.lastRefreshedBy=this.user.email}catch(e){}}else{i={org:e,createdAt:await this.epoch()};try{i.createdBy=this.user.email}catch(e){}}return t=await this.uid(),i.key=await this.encrypt(t),await this.report.orgs.orgkeys(i),t}i.lastRetrievedAt=await this.epoch();try{i.lastRetrievedBy=this.user.email}catch(e){}return await this.report.orgs.orgkeys(i),this.decrypt(i.key)}},r.report.orgs.key._auth="@oa.works",r.report.emails={_sheet:a.report.emails_sheet,_key:"doi",_auth:"@oa.works"},r.report.email=async function(e){var t,i,s,r,a,l,n,o,u,c;if((e||this.params.orgkey)&&(null==e&&(e=null!=(a=this.params.email)?a:this.params.doi),null!=e&&(null!=(r=await this.report.works(e))?r.email:void 0))){if(r.email.includes("@"))return r.email;if(c=await this.encrypt(this.params.orgkey),"string"==typeof(null!=(s=await this.report.orgs.orgkeys('key.keyword:"'+c+'"',1))?s.org:void 0)&&s.org.length){for(o=[],t=0,i=(l=r.orgs).length;t<i;t++)u=l[t],o.push(u.toLowerCase());if(n=s.org,h.call(o,n)>=0)return this.decrypt(r.email)}}},r.report.works={_index:!0,_key:"DOI"},r.report.works._process=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se;if(null!=(null!=e?e.DOI:void 0)){for(j={DOI:e.DOI.toLowerCase(),subject:e.subject,subtitle:e.subtitle,volume:e.volume,published_year:e.year,issue:e.issue,publisher:e.publisher,published_date:e.published,funder:e.funder},r=0,n=(C=null!=(D=e.assertion)?D:[]).length;r<n;r++)(i=(null!=(U=C[r].label)?U:"").toLowerCase()).includes("accepted")&&!i.split(" ").length>2&&null==j.accepted_date&&(j.accepted_date=e.assertion.value),i.includes("received")&&null==j.submitted_date&&(j.submitted_date=e.assertion.value);for(a=0,o=(Z=null!=(H=j.funder)?H:[]).length;a<o;a++)delete Z[a]["doi-asserted-by"];for(e.title&&e.title.length&&(j.title=e.title[0]),e["container-title"]&&e["container-title"].length&&(j.journal=e["container-title"][0]),y=0,u=(K=null!=(Q=e.license)?Q:[]).length;y<u;y++)"am"!==(ee=(l=K[y])["content-version"])&&"vor"!==ee&&"tdm"!==ee&&"unspecified"!==ee||(j["crossref_license_url_"+l["content-version"]]=l.URL);j.crossref_is_oa=null!=e.is_oa&&e.is_oa}else{if(null==t)return;j={openalex:t.id.split("/").pop(),title:t.title},null!=(null!=(te=t.ids)?te.doi:void 0)&&(j.DOI=t.ids.doi.split("doi.org/").pop().toLowerCase()),null!=(null!=(ie=t.ids)?ie.pmid:void 0)&&(j.pmid=t.ids.pmid.split("/").pop())}for(_=0,c=(N=null!=(L=null!=(w=await this.src.oadoi(j.DOI))?w.oa_locations:void 0)?L:[]).length;_<c;_++)if("publisher"===(g=N[_]).host_type&&(null==j.publisher_license&&(j.publisher_license=g.license),null==j.publisher_url_for_pdf&&(j.publisher_url_for_pdf=g.url_for_pdf),null==j.publisher_version&&(j.publisher_version=g.version)),"repository"===g.host_type&&(g.url&&g.url.toLowerCase().includes("pmc")&&(j.PMCID||(O=g.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0]).length&&O.replace(/[^0-9]/g,"").length===O.length&&!isNaN(parseInt(O))&&(j.PMCID="PMC"+O),g.license&&!j.epmc_licence&&(j.epmc_licence=g.license)),!j.repository_url||!j.repository_url.includes("pmc")))for(v=0,h=(P=["license","url_for_pdf","url","version"]).length;v<h;v++)g[b=P[v]]&&(j["repository_"+b]=g[b]);if(j.repository_url&&j.repository_url.toLowerCase().includes("pmc")&&(null==j.PMCID&&(j.PMCID="PMC"+j.repository_url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0]),j.repository_url_in_pmc=!0),null!=w&&(j.best_oa_location_url=null!=(R=w.best_oa_location)?R.url:void 0,j.best_oa_location_url_for_pdf=null!=(T=w.best_oa_location)?T.url_for_pdf:void 0,j.oa_status=w.oa_status,j.has_repository_copy=w.has_repository_copy,j.has_oa_locations_embargoed=!(null==w.oa_locations_embargoed||!w.oa_locations_embargoed.length),j.title=w.title,null==j.journal&&(j.journal=w.journal_name),null==j.publisher&&(j.publisher=w.publisher),w.published_date&&(j.published_date=w.published_date),w.year&&(j.published_year=w.year)),S=await this.copy(j),k=await this.permissions(S,void 0,void 0,w,e),j.can_archive=null!=k&&null!=(E=k.best_permission)?E.can_archive:void 0,j.version=null!=k&&null!=(q=k.best_permission)?q.version:void 0,j.journal_oa_type=await this.permissions.journals.oa.type(void 0,void 0,w,e),null==j.can_archive&&((null!=(M=null!=w&&null!=(W=w.best_oa_location)?W.license:void 0)?M:"").includes("cc")||(null!=w?w.journal_is_in_doaj:void 0))&&(j.can_archive=!0),j.oadoi_is_oa=null!=w?w.is_oa:void 0,j.is_oa=j.oadoi_is_oa||j.crossref_is_oa||"gold"===j.journal_oa_type,j.DOI&&(null!=(null!=(s=await this.report.emails(j.DOI))?s.Email:void 0)&&(j.email=s.Email),null!=(null!=s?s.email_cw_batch_count:void 0)&&(j.email_cw_batch_count=s.email_cw_batch_count),"string"==typeof j.email&&j.email.includes("@")&&(j.email=await this.encrypt(j.email))),null==t&&(t=await this.src.openalex.works('ids.doi:"https://doi.org/'+j.DOI+'"',1)),null!=t){for(x=0,p=(z=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;x<p;x++)j[b=z[x]]=t[b];for(t.title&&(j.title=t.title),t.publication_date&&!(null!=w?w.published_date:void 0)&&(j.published_date=t.publication_date),t.publication_year&&!(null!=w?w.year:void 0)&&(j.published_year=t.publication_year),j.issn=null!=(J=t.host_venue)?J.issn:void 0,A=0,d=(F=null!=(B=j.concepts)?B:[]).length;A<d;A++)delete F[A].wikidata;for(I=0,f=(V=null!=(Y=j.authorships)?Y:[]).length;I<f;I++)for(se=0,m=($=null!=(X=V[I].institutions)?X:[]).length;se<m;se++)delete $[se].type;!j.PMCID&&(null!=(G=t.ids)?G.pmcid:void 0)&&(j.PMCID="PMC"+t.ids.pmcid.split("/").pop().toLowerCase().replace("pmc",""))}return j.updated=await this.epoch(),j},r.report.works.load=async function(e,t,i,s,r,a,l,n){var o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I;if(O=await this.epoch(),null==e&&(e=null!=(w=this.params.load)?w:this.params.timestamp),null==t&&(t=this.params.crossref),null==i&&(i=this.params.openalex),null==s&&(s=!1),null==n&&(n=this.params.after),!0===n&&(n=await this.epoch()-6048e5),_=null==(b=this.params.overwrite)||b,this.params.clear&&await this.report.works(""),u=[],this.params.year?"string"==typeof(I=this.params.year)&&I.includes(",")&&(I="("+I.replace(/ /g,"").split(",").join(" OR ")+")"):I="2022",A=u.length,u.length&&(await this.report.works(u),u=[]),null==r&&(r="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+I),I&&!r.includes(":"+I)&&(r="("+r+") AND year.keyword:"+I),e&&!r.includes(":>"+e)&&(r="("+r+") AND srcday:>"+e),console.log(r),h=await this.src.crossref.works.count(r),console.log(h,"records available for update from crossref"),g=0,!1!==t)for await(c of(console.log("Starting OA report works loading from crossref"),this.index._for("src_crossref_works",r,{scroll:"30m",max:this.params.max,include:["DOI","subject","title","subtitle","volume","issue","year","publisher","published","funder","license","is_oa"]}))){if(g+=1,!0===_&&!n||!await this.report.works(n?'DOI.keyword:"'+c.DOI+'" AND updated:<'+n:c.DOI)){if(A+=1,null!=(v=await this.report.works._process(c))&&!v.is_retracted&&!v.is_paratext){if(delete v.is_retracted,delete v.is_paratext,(await this.date()).includes(I)&&e&&null!=(null!=(d=await this.report.works(c.DOI))?d.supplements:void 0))for(f=0,m=(x=["supplements","orgs","author_email_name","pmc_checked","paid","PMCID","epmc_licence","pmc_has_data_availability_statement"]).length;f<m;f++)null==v[p=x[f]]&&(v[p]=d[p]);u.push(v)}1e4===u.length&&(await this.report.works(u),console.log("OA report works loading",A,Math.ceil((await this.epoch()-O)/6e4)),u=[])}!e&&(A&&A%20==0||g&&g%20==0)&&console.log("report works load xref",A,g)}if(!1===l||!1===t||e||this.mail({to:["mark@oa.works","joe@oa.works"],subject:"OA report works finished crossref load "+A+" in "+S+" minutes"+(e?" for "+await this.date(e):"")+", "+h+" crosref, ",text:"https://bg."+(this.S.dev?"beta":"api")+".oa.works/report/works"}),null==a&&(a="authorships.institutions.display_name:* AND publication_year:"+I),I&&!a.includes(":"+I)&&(a="("+a+") AND publication_year:"+I),e&&!a.includes(":>"+e)&&(a="("+a+") AND updated_date:>"+e),console.log(a),o=await this.src.openalex.works.count(a),console.log(o,"records available for update from openalex"),!1!==i)for await(y of(console.log("Starting OA report works loading from openalex"),this.index._for("src_openalex_works",a,{scroll:"30m",max:this.params.max})))(null!=(k=y.ids)?k.doi:void 0)||(A+=1,e||A%20!=0||console.log("report works load oalx",A),null==(v=await this.report.works._process(void 0,y))||v.is_retracted||v.is_paratext||(delete v.is_retracted,delete v.is_paratext,u.push(v)),1e4===u.length&&(await this.report.works(u),console.log("OA report works loading from openalex",A,Math.ceil((await this.epoch()-O)/6e4)),u=[]));return u.length&&await this.report.works(u),!1!==s&&this.report.orgs.supplement(),S=Math.ceil((await this.epoch()-O)/6e4),console.log("OA report done loading after "+S+" minutes"),!1!==l&&this.mail({to:["mark@oa.works","joe@oa.works"],subject:"OA report works loaded "+A+" in "+S+" minutes"+(e?" for "+await this.date(e):"")+", "+h+" crosref, "+o+" openalex",text:"https://bg."+(this.S.dev?"beta":"api")+".oa.works/report/works"}),A},r.report.works.load._bg=!0,r.report.works.load._async=!0,r.report.works.load._auth="@oa.works",r.report.works.changes=async function(e,t){var i,s,r,a,l,n,o,u,c,h;if(null==e&&(e=null!=(l=null!=(n=this.params.changes)?n:this.params.timestamp)?l:Date.now()-9e7),null==t&&(t=this.params.org),!1!==this.params.paid){for await(s of this.index._for("report_orgs","paid:true AND (source.crossref:* OR source.openalex:*)"))if(h=0,i=0,(!t||t===s.name)&&(await this.report.works.load(e,!!s.source.crossref&&void 0,!!s.source.openalex&&void 0,void 0,s.source.crossref?decodeURIComponent(decodeURIComponent(s.source.crossref)):void 0,s.source.openalex?decodeURIComponent(decodeURIComponent(s.source.openalex)):void 0),s.source.supplements))for await(a of this.index._for("report_works",decodeURIComponent(decodeURIComponent(s.source.supplements))))!a.DOI||a.DOI.includes(" pmcid:")||a.DOI.includes("\n")||a.DOI.includes("?ref")||(1===(null!=(c=await this.src.crossref.works('DOI:"'+a.DOI+'" AND srcday:>'+e))&&null!=(o=c.hits)?o.total:void 0)&&(h+=1,console.log("xref",s.name,h),await this.report.orgs.supplement(void 0,void 0,void 0,a,void 0,void 0,c.hits.hits[0]._source)),1===(null!=(r=await this.src.openalex.works('ids.doi:"https://doi.org/'+a.DOI+'" AND updated_date:>'+e))&&null!=(u=r.hits)?u.total:void 0)&&(i+=1,console.log("oalx",s.name,i),await this.report.orgs.supplement(void 0,void 0,void 0,a,void 0,void 0,void 0,r.hits.hits[0]._source)))}else this.report.works.load(e);return!0},r.report.works.changes._bg=!0,r.report.works.changes._async=!0,r.report.works.changes._auth="@oa.works";h=[].indexOf;r.report.supplements={_index:!0,_prefix:!1,_key:"DOI"},r.report.check=async function(e,t){var i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe,me,ge,ye,_e,ve,we,be,xe,ke,Oe,Se,Ae,Ie,je,De,Ce,Le,Ne,Pe,Re,Te,Ee,qe,Me,We,Ue,ze,Je,Be,Fe,Ye,Ve,Xe,$e,Ge,He,Ze,Qe,Ke,et,tt,it,st,rt,at,lt,nt,ot;if(null==t&&(t=null!=(de=null!=(fe=this.params.check)?fe:this.params.reload)?de:this.params.sheet),Ke=await this.epoch(),it=await this.datetime(!1).replace(/[-T\: ]/g,"_"),console.log("OA check running",it,t),t||await this.report.supplements(""),i=async e=>{var t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J;e.published=await this.src.crossref.works.published(e);try{e.year=e.published.split("-")[0]}catch(e){}try{e.year=parseInt(e.year)}catch(e){}try{r={DOI:e.DOI.toLowerCase(),title:null!=(P=e.title)?P[0]:void 0,journal:null!=(R=e["container-title"])?R[0]:void 0,ISSN:e.ISSN,publisher:e.publisher,crossref_published:e.published,crossref_year:e.year,citations:e["reference-count"],crossref_is_oa:e.is_oa,crossref_subject:e.subject};try{r.title=r.title.replace(/\n/g,"").replace(/\s\s+/g," ")}catch(e){}for(r.funder_grant_ids=[],r.funder_name=[],E=null!=(T=e.funder)?T:[],n=0,p=E.length;n<p;n++)if("10.13039/100000865"===(a=E[n]).DOI||a.name&&a.name.toLowerCase().includes("gates"))for("bank of canada"===a.name.toLowerCase()&&(a.name="Bill and Melinda Gates Foundation"),q=a.name,h.call(r.funder_name,q)<0&&r.funder_name.push(a.name),W=null!=(M=a.award)?M:[],o=0,d=W.length;o<d;o++)for(U=W[o].split(","),u=0,f=U.length;u<f;u++)l=(l=U[u]).trim(),h.call(r.funder_grant_ids,l)<0&&r.funder_grant_ids.push(l);for(r.author_names=[],r.author_affiliation=[],O=null!=(k=e.author)?k:[],v=0,m=O.length;v<m;v++)for((s=null!=(S=(t=O[v]).name)?S:(t.given?t.given+" ":"")+(null!=(A=t.family)?A:""))&&r.author_names.push(s),j=null!=(I=t.affiliation)?I:[],b=0,g=j.length;b<g;b++)(i=j[b]).name&&i.name.toLowerCase().includes("gates")&&(D=i.name,h.call(r.author_affiliation,D)<0)&&r.author_affiliation.push(i.name);try{for(C=e.license,x=0,y=C.length;x<y;x++)"am"!==(L=(c=C[x])["content-version"])&&"vor"!==L&&"tdm"!==L&&"unspecified"!==L||(null==r[w="crossref_license_url_"+c["content-version"]]&&(r[w]=[]),r["crossref_license_url_"+c["content-version"]].push(c.URL))}catch(e){}for(r.crossref=e,z=0,_=(N=["assertion","reference","relation"]).length;z<_;z++)J=N[z],delete r.crossref[J];return r}catch(t){console.log("from crossref parse error",JSON.stringify(e))}},pe={},!t){for await(he of(te="/home/cloo/static/report/OAreport_"+it+".csv",(ae="funder.award:OPP* OR funder.award:INV*").includes("journal-article")||(ae='type:"journal-article" AND ('+ae+")"),V=[/Melinda\sGates\sFoundation/g,/BMGF/g,/Gates\sCambridge\sTrust/g,/IID\s?\d{5}/gi,/OPPG[HD]\s?\d{4}/g,/OPP\s?1\s?\d{6}/g,/OPP\s?[45]\s?\d{4}/g,/INV\\d{6}/g],this.index._for("src_crossref_works",ae)))if(he.DOI=he.DOI.toLowerCase(),(v=await this.extract({content:JSON.stringify(he),matchers:V})).matched)for(pe[he.DOI]=await i(he),pe[he.DOI].matches=[],O=0,L=(Te=v.matches).length;O<L;O++)((H=Te[O]).matched||H.result)&&pe[he.DOI].matches.push({matcher:H.matched,matched:H.result.join(",")});for await(he of('"10.13039/100000865" OR "gates foundation" OR "gates cambridge trust"',w=["funder.DOI","funder.name","author.affiliation.name"],this.index._for("src_crossref_works",'"10.13039/100000865" OR "gates foundation" OR "gates cambridge trust"',{fields:w})))if("journal-article"===he.type)if(X=[],(A=JSON.stringify(he)).includes("10.13039/100000865")&&X.push({field:"funder.DOI",matched:"10.13039/100000865"}),A.includes("gates foundation")&&X.push({field:"funder.name",matched:"gates foundation"}),A.includes("gates cambridge trust")&&X.push({field:"funder.name",matched:"gates cambridge trust"}),he.DOI=he.DOI.toLowerCase(),pe[he.DOI]){for(S=0,N=X.length;S<N;S++)G=X[S],pe[he.DOI].matches.push(G);null==(r=pe[he.DOI]).duplicate&&(r.duplicate=0),pe[he.DOI].duplicate+=1}else pe[he.DOI]=await i(he),pe[he.DOI].matches=X}if(Ze={finance:"1nhykkqxYQ4DNPAj-WnXHcYnSd4dmt_Hf0xEVDZxaPLY",oasupport:"180562eXtmMANfIlioclUrQDaUSWkTOz7igOymfnv2pg",staff:"1EZI0iNAXnJ-qbIJFGmtplHWP03NVT7hhf0ICazI0YXw",grants:"1lDNHAwH-8x89fgLK-JLs9bBv2cdHsJRnb1Pj86QYWZI",names:"1ZowZub-nwOHJrzP7IbhbdoydOAmBRxLysejw38Xt32Y",emails:"1U3YXF1DLhGvP4PgqxNQuHOSR99RWuwVeMmdTAmSM45U",lens:"1XulUi2Bk3QNsJLekx0PpNb6REhrwQi6Q9M1x_KIUH_0",chronos:"1SxIFu4SoROqinOXAZMepOE0d1oxAZgC8LR_nTRi4vpU",oacheck:"1hRZGE-LfHdloHOEVVbt_ULjvwU76gECfa8MrthF9EV8",asap:"14Cs80bpyKym6R1kKqIrI1R5MMELms7ArPQzF67YOOgM",gates_funded_pmc:"1tE6it4EcW83-ZUCotdFMnj6LsyKfQCPdkBcrr36PkVM",oaworks_das:"1GoZ2s0x6VEqsiTnL4BOhVFEz1wKjGn7n-_dDVZWbvMI"},t)if(Qe=Ze[t])(Ze={})[t]=Qe;else for(Qe in Ze)if(Ze[Qe]===t){(Ze={})[Qe]=t;break}for(Ge in Ze){if(k=[],null!=(Xe=await this.src.google.sheets({sheetid:Ze[Ge],sheet:"Export",headers:!1})))for(C=0,T=(We=Xe.shift()).length;C<T;C++)x=We[C],k.push(x.toLowerCase().trim().replace(/ /g,"_").replace("?",""));else Xe=[];for(Z=0,E=Xe.length;Z<E;Z++){for(b in Ve=Xe[Z],he={},k)he[k[b].toLowerCase()]=Ve[b]?"true"===(Ue=Ve[b].trim().toLowerCase())||"yes"===Ue||"false"!==(ze=Ve[b].trim().toLowerCase())&&"no"!==ze&&("grant_id"===(Je=k[b].toLowerCase())||"ror"===Je?Ve[b].replace(/\//g,",").replace(/ /g,"").split(","):Ve[b]):void 0;if(he.doi&&"string"==typeof he.doi)if((ce=he.doi.split(",")[0].toLowerCase().replace(/\.$/,"").replace(/\s/,"").split(" ")[0].split("?")[0].trim()).startsWith("10.")&&ce.includes("/")&&ce.length>6){if(t)for(I in pe[ce]=await this.report.supplements(ce),null==pe[ce]&&(null==pe[ce]&&(pe[ce]=await this.src.crossref.works(ce)),null==pe[ce]&&(pe[ce]=await this.src.crossref.works.doi(ce)),null!=pe[ce]?pe[ce]=await i(pe[ce]):pe[ce]={}),he)pe[ce][I]=he[I];else null!=pe[ce]?(null==(a=pe[ce]).duplicate&&(a.duplicate=0),pe[ce].duplicate+=1):(m=await this.src.crossref.works(ce))||(m=await this.src.crossref.works.doi(ce))?pe[ce]=await i(m):pe[ce]={DOI:ce,in_crossref:!1};try{for(null==(l=pe[ce]).sheets&&(l.sheets=[]),h.call(pe[ce].sheets,Ge)<0&&pe[ce].sheets.push(Ge),null==(n=pe[ce]).ror&&(n.ror=[]),me=null!=(Be=he.ror)?Be:["0456r8d26"],Q=0,q=me.length;Q<q;Q++)$e=me[Q],h.call(pe[ce].ror,$e)<0&&pe[ce].ror.push($e);for(le in he)if("apc_cost"===le){try{ne=parseInt(he[le])}catch(e){ne=0}null==(o=pe[ce])[le]&&(o[le]=0),pe[ce][le]+=ne}else null!=pe[ce][le]?(pe[ce][le]?Array.isArray(pe[ce][le])||(pe[ce][le]=[pe[ce][le]]):pe[ce][le]=[],null!=he[le]&&("string"!=typeof he[le]||he[le].trim().length)&&(ge=he[le],h.call(pe[ce][le],ge)<0)&&pe[ce][le].push(he[le])):null!=he[le]&&""!==he[le]&&(pe[ce][le]=he[le])}catch(e){console.log("sheet fields merge error",ce)}}else console.log("bad doi",ce)}}if(y=await this.keys(pe).length,console.log(y),!t)for(s={title:"Paper title",journal:"Journal Title",publisher:"Publisher name",published:"Published date",year:"Published year"},ie=0,M=(D=this.params.keys?this.params.keys.split(","):["DOI","PMCID","in_oadoi","in_crossref","doi_resolves","compliant","can_archive","journal_oa_type","crossref_is_oa","oadoi_is_oa","is_oa","oadoi_oa_status","best_oa_location_url","best_oa_location_url_for_pdf","has_repository_copy","repository_license","repository_url_for_pdf","repository_url","repository_url_in_pmc","repository_version","publisher_license","publisher_url_for_pdf","publisher_version","has_oa_locations_embargoed","epmc_licence","epmc_licence_source","pmc_has_data_availability_statement","title","journal","ISSN","publisher","published","crossref_published","oadoi_published","year","crossref_year","oadoi_year","author_affiliation","funder_name","funder_grant_ids","crossref_license_url_am","crossref_license_url_vor","crossref_license_url_tdm","crossref_license_url_unspecified","crossref_subject","grant_id","invoice_date","invoice_number","mturk_has_data_availability_statement","mturk_data_availability_statement","tdm_is_oa","mturk_is_oa","staff_is_oa","apc_cost","oawork_finance_internal_id","type","to","status","sent","last_contact","last_heard_from","completed","follow_up_due","follow_ups_sent","clicked","author_name","email","author_email_name","citations","sheets","matches_targets","matches_found"]).length;ie<M;ie++)j=D[ie],await fs.appendFile(te,("DOI"!==j?',"':'"')+(null!=(ye=s[j])?ye:j)+'"');for(g in u=[],f=0,$=null!=(_e=this.params.max)?_e:0,pe){if($&&f>$)break;if(f+=1,null==(Ye=pe[g]))console.log(g);else{if(K=await this.src.oadoi(Ye.DOI)){for(Ye.oadoi=K,Ye.journal_oa_type=await this.permissions.journals.oa.type(void 0,void 0,K,Ye.crossref),et=0,W=(we=null!=(ve=K.oa_locations)?ve:[]).length;et<W;et++)if("publisher"===(F=we[et]).host_type&&(null==Ye.publisher_license&&(Ye.publisher_license=F.license),null==Ye.publisher_url_for_pdf&&(Ye.publisher_url_for_pdf=F.url_for_pdf),null==Ye.publisher_version&&(Ye.publisher_version=F.version)),"repository"===F.host_type){if(F.url&&F.url.toLowerCase().includes("pmc")){if(!Ye.PMCID&&!Ye.pmcid)try{(se=F.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0]).length&&se.replace(/[^0-9]/g,"").length===se.length&&!isNaN(parseInt(se))&&(Ye.PMCID="PMC"+se)}catch(e){}F.license&&!Ye.epmc_licence&&(Ye.epmc_licence=F.license,Ye.epmc_licence_source="oadoi EPMC repository oa_location")}if(!Ye.repository_url||!Ye.repository_url.includes("pmc"))for(st=0,U=(be=["license","url_for_pdf","url","version"]).length;st<U;st++)F[ee=be[st]]&&(Ye["repository_"+ee]=F[ee])}Ye.repository_url&&Ye.repository_url.toLowerCase().includes("pmc")&&(Ye.repository_url_in_pmc=!0),Ye.best_oa_location_url=null!=(xe=K.best_oa_location)?xe.url:void 0,Ye.best_oa_location_url_for_pdf=null!=(ke=K.best_oa_location)?ke.url_for_pdf:void 0,Ye.oadoi_is_oa=K.is_oa,Ye.is_oa=Ye.oadoi_is_oa||Ye.crossref_is_oa,Ye.oadoi_oa_status=K.oa_status,Ye.has_repository_copy=K.has_repository_copy,Ye.has_oa_locations_embargoed=!(null==K.oa_locations_embargoed||!K.oa_locations_embargoed.length),null==Ye.title&&(Ye.title=K.title),null==Ye.journal&&(Ye.journal=K.journal_name),K.journal_issns&&null==Ye.ISSN&&(Ye.ISSN=K.journal_issns.split(",")),null==Ye.publisher&&(Ye.publisher=K.publisher),Ye.oadoi_published=K.published_date,Ye.oadoi_year=K.year}else Ye.in_oadoi=!1;if(null==Ye.year&&(Ye.year=null!=(Oe=Ye.oadoi_year)?Oe:Ye.crossref_year),null==Ye.published&&(Ye.published=null!=(Se=Ye.oadoi_published)?Se:Ye.crossref_published),(null!=(Ae=null!=K&&null!=(Ie=K.best_oa_location)?Ie.license:void 0)?Ae:"").includes("cc")||(null!=K?K.journal_is_in_doaj:void 0)?Ye.can_archive=!0:((ue=this.copy(null!=(je=Ye.crossref)?je:{})).doi=ue.DOI,Ye.permissions=await this.permissions(ue,void 0,void 0,K,"{}"===JSON.stringify(ue)?void 0:ue),Ye.can_archive=null!=(De=Ye.permissions)&&null!=(Ce=De.best_permission)?Ce.can_archive:void 0),Ye.compliant=await this.report.compliant(Ye),_=void 0,re=void 0,Ye.PMCID||(!Ye.pmcid||Array.isArray(Ye.pmcid)&&!Ye.pmcid.length?((null!=(re=await this.src.pubmed.doi(Ye.DOI))&&null!=(Le=re.identifier)?Le.pmc:void 0)&&(Ye.PMCID=re.identifier.pmc,Ye.PMCID="PMC"+Ye.PMCID.toLowerCase().replace("pmc","")),Ye.PMCID&&!Ye.repository_url_in_pmc||!(_=await this.src.epmc.doi(Ye.DOI))||(Ye.PMCID=_.pmcid)):(Ye.PMCID="PMC"+Ye.pmcid.toString().toLowerCase().replace("pmc",""),Array.isArray(Ye.PMCID)&&(Ye.PMCID=Ye.PMCID[0]))),Ye.PMCID&&Ye.repository_url_in_pmc&&!Ye.epmc_licence&&(B=await this.src.epmc.licence(Ye.PMCID,_),Ye.epmc_licence=null!=B?B.licence:void 0,Ye.epmc_licence_source=null!=B?B.source:void 0),Ye.pmc_has_data_availability_statement=Ye.PMCID&&await this.src.pubmed.availability(Ye.PMCID),Ye.author_names&&Ye.email)if(1===Ye.author_names.length)Ye.author_email_name="Dr. "+Ye.author_names[0].split(" ").pop();else{for(Fe=("string"==typeof Ye.email?Ye.email:Ye.email[0]).split("@")[0].toLowerCase().replace(/[^a-z]/g,""),c="",p="",d=1e6,rt=0,z=(Ne=Ye.author_names).length;rt<z;rt++)oe=Ne[rt],(He=(await this.levenshtein(Fe,oe.toLowerCase().replace(/[^a-z]/g,""))).distance/oe.length)<d&&(d=He,p=oe),d>.2&&(Fe.endsWith(oe.split(" ").pop().toLowerCase())||oe.split(" ")[0].length>4&&Fe.includes(oe.split(" ")[0].toLowerCase()))&&(d=.1,p=oe),!c&&Fe.startsWith((oe.split(" ")[0].slice(0,1)+oe.split(" ").pop().slice(0,1)).toLowerCase())&&(c=oe);d<.7&&(Ye.author_email_name="Dr. "+p.split(" ").pop()),!Ye.author_email_name&&c&&(Ye.author_email_name="Dr. "+c)}if(u.push(Ye),!t)for(await fs.appendFile(te,"\n"),lt=0,J=D.length;lt<J;lt++){if(at=null==Ye[I=D[lt]]?"":Array.isArray(Ye[I])?Ye[I].join(","):"object"==typeof Ye[I]?JSON.stringify(Ye[I]):Ye[I],"matches_targets"===I)for(nt=0,P=(Re=null!=(Pe=Ye.matches)?Pe:[]).length;nt<P;nt++)((Y=Re[nt]).field||Y.matcher)&&(at+=(at?",":"")+(null!=(Ee=Y.field)?Ee:Y.matcher));else if("matches_found"===I)for(ot=0,R=(Me=null!=(qe=Ye.matches)?qe:[]).length;ot<R;ot++)at+=(at?",":"")+(Y=Me[ot]).matched;await fs.appendFile(te,("DOI"!==I?',"':'"')+at.toString().replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")+'"')}f%100==0&&console.log("Gates OA checking",f,y),5e3===u.length&&(await this.report.supplements(u),u=[])}}return u.length&&(await this.report.supplements(u),u=[]),tt=Math.ceil((await this.epoch()-Ke)/6e4),console.log("OA check done after "+tt+" minutes",t),t||this.mail({to:["joe@oa.works","sarah@oa.works"],subject:"Gates OA check done "+f+" in "+tt+" minutes",text:"https://static.oa.works/report/"+(null!=te?te:"").split("/report/").pop()}),f},r.report.check._bg=!0,r.report.check._async=!0,r.report.check._notify=!1,r.report.compliant=function(e,t){var i,s,r,a,l,n,o,u;return u=(null!=(i=null!=(s=e.oadoi)&&null!=(r=s.best_oa_location)?r.license:void 0)?i:"").toLowerCase().replace(/-/g,""),"Cold Spring Harbor Laboratory"===(a=e.publisher)||"Research Square"===a||"Data in Brief"===e.journal||e.DOI.startsWith("10.2139/ssrn")||e.DOI.startsWith("10.21203/rs")||e.DOI.startsWith("10.31234/osf.io/")?"n/a":e.journal_oa_type&&"closed"!==(l=e.journal_oa_type)&&"green"!==l&&(u.includes("ccby")||u.includes("cc0")||u.includes("pd")||u.includes("public")&&u.includes("domain"))?e.repository_url_in_pmc?"yes":"expected":null!=e.journal_oa_type&&u&&(null!=(n=e.oadoi)&&null!=(o=n.best_oa_location)?o.url:void 0)?"no":"unknown"};h=[].indexOf;r.report.orgs.supplements={_index:!0,_auth:"@oa.works"},r.report.orgs.supplements.load=async function(e,t,i){var s,r,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X;for(null==i&&(i=this.params.clear),i&&await this.report.orgs.supplements(""),null==e&&(e=this.params.org),null==t&&(t=this.params.sheet),S=[],V=0,s=[],l=[],p=0,g=(j="object"!=typeof(I=await this.src.google.sheets(a.report.orgs_sheet))||Array.isArray(I)?I:[I]).length;p<g;p++){for(n in x={},A=j[p]){if("string"==typeof A[n])if(A[n]=A[n].trim(),"true"===A[n].toLowerCase())A[n]=!0;else if("false"===A[n].toLowerCase())A[n]=!1;else if(A[n].startsWith("[")&&A[n].endsWith("]")||A[n].startsWith("{")&&A[n].endsWith("}"))try{A[n]=JSON.parse(A[n])}catch(e){}else A[n].includes(";")&&(A[n]=A[n].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(n.includes("."))try{this.dot(x,n,A[n])}catch(e){}else x[n]=A[n]}if(Array.isArray(x.sheets))for(m=0,y=(D=x.sheets).length;m<y;m++){if(B=D[m],!(e&&x.name!==e||t&&B.name!==t)){console.log(x.name,B.name,B.url),k=[],u=[];try{z=await this.src.google.sheets({sheetid:B.url,sheet:"Export",headers:!1})}catch(e){}for(X=0;(!Array.isArray(z)||!z.length)&&X<3;){await this.sleep(2e3),X+=1;try{z=await this.src.google.sheets({sheetid:B.url,sheet:"Export",headers:!1})}catch(e){}}if(Array.isArray(z)&&z.length){for(Y=[],w=0,_=(N=z.shift()).length;w<_;w++)o=N[w],u.push(o.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(x.supplements=0,b=0,v=z.length;b<v;b++){for(c in U=z[b],J={org:x.name,sheet:B.name,ror:x.ror,paid:x.paid},u)if("doi"===(n=u[c])||"DOI"===n)J[n]=U[c];else if("apc_cost"===n)try{J.apc_cost=parseInt(U[c])}catch(e){}else n.includes(".")?await this.dot(J,n,U[c]?"true"===(P=U[c].trim().toLowerCase())||"yes"===P||"false"!==(R=U[c].trim().toLowerCase())&&"no"!==R&&("grant_id"===(T=n.toLowerCase())||"ror"===T?U[c].replace(/\//g,",").replace(/ /g,"").split(","):"string"==typeof U[c]&&U[c].includes(";")?U[c].split(";"):U[c]):void 0):(J[n]=U[c]?"true"===(E=U[c].trim().toLowerCase())||"yes"===E||"false"!==(q=U[c].trim().toLowerCase())&&"no"!==q&&("grant_id"===(M=n.toLowerCase())||"ror"===M?U[c].replace(/\//g,",").replace(/ /g,"").split(","):U[c]):void 0,"string"==typeof J[n]&&J[n].includes(";")&&(J[n]=J[n].split(";")));null==J.DOI&&(J.DOI=J.doi);try{J.DOI&&J.DOI.startsWith("http")&&(J.DOI="10."+J.DOI.split("/10.")[1])}catch(e){}try{J.DOI.startsWith("doi ")&&(J.DOI=J.DOI.toLowerCase().replace("doi ",""))}catch(e){}if(J.DOI&&(J.DOI=J.DOI.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/ /g,"").replace(/^\//,"").split("?")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"")),J.DOI&&J.DOI.startsWith("10.")){if("string"==typeof J.email&&J.email.includes("@")&&(J.email=await this.encrypt(J.email)),J._id=J.osdid=(x.name.replace(/[^a-zA-Z0-9-_ ]/g,"")+"_"+B.name+"_"+J.DOI).replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),k.push(J.osdid),W=J.DOI,h.call(l,W)<0){if(!(r=null==(O=i?void 0:await this.report.orgs.supplements({_id:J.osdid}))))for(d in f=await this.copy(J),O){if((!Array.isArray(J[d])||Array.isArray(O[d])&&J[d].length===O[d].length)&&("object"!=typeof J[d]||"object"==typeof O[d]&&JSON.stringify(J[d])===JSON.stringify(O[d]))&&J[d]===O[d]||(r=!0),r)break;delete f[d]}(r||"{}"!==JSON.stringify(f))&&l.push(J.DOI)}Y.push(J),x.supplements+=1,V+=1}}console.log(x.name,B.name,Y.length),await this.report.orgs.supplements(Y)}for await(F of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'org.keyword:"'+x.name+'" AND sheet.keyword:"'+B.name+'"',{scroll:"5m",include:["osdid","DOI"],sort:{"osdid.keyword":"asc"}}))C=F.osdid,h.call(k,C)<0&&(await this.report.orgs.supplements(F.osdid,""),s.push(F.osdid),L=F.DOI,h.call(l,L)<0&&l.push(F.DOI))}B.url=await this.encrypt(B.url)}else delete x.sheets;"{}"!==JSON.stringify(x)&&S.push(x)}return await this.sleep(6e4),console.log("report orgs supplements load",V,l.length,s.length),V},r.report.orgs.supplements.load._auth="@oa.works",r.report.articles={_index:!0,_prefix:!1},r.report.articles.process=async function(e,t,i){var s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de,fe,me,ge,ye,_e,ve,we,be,xe,ke,Oe,Se,Ae,Ie,je,De;if(Se=await this.epoch(),null==i&&(i=this.refresh),null!=e&&!0!==i&&(!(null!=(c=await this.report.articles("string"==typeof e?e:e.DOI))?c.updated:void 0)||i&&c&&c.updated<i)&&(c=void 0),null==e&&(e=this.params.process),null==c&&"string"==typeof e&&e.startsWith("10.")&&(De=await this.src.crossref.works({_id:e}))&&(e=De),"object"!=typeof e||e.DOI||(e=void 0),null==e||(null!=c?c.openalex:void 0)||(null==t&&(t=await this.src.openalex.works({_id:"object"==typeof e?e.DOI:e})),(null!=t?t.id:void 0)||(t=void 0)),"object"==typeof e&&e.DOI){for(U={DOI:e.DOI.toLowerCase(),subject:e.subject,subtitle:e.subtitle,volume:e.volume,published_year:e.year,issue:e.issue,publisher:e.publisher,published_date:e.published,funder:e.funder,issn:e.ISSN},p=0,g=(J=null!=(z=e.assertion)?z:[]).length;p<g;p++)(s=(null!=(K=J[p].label)?K:"").toLowerCase()).includes("accepted")&&!s.split(" ").length>2&&null==U.accepted_date&&(U.accepted_date=e.assertion.value),s.includes("received")&&null==U.submitted_date&&(U.submitted_date=e.assertion.value);for(f=0,y=(ye=null!=(ue=U.funder)?ue:[]).length;f<y;f++)delete ye[f]["doi-asserted-by"];for(e.title&&e.title.length&&(U.title=e.title[0]),e["container-title"]&&e["container-title"].length&&(U.journal=e["container-title"][0]),j=0,_=(ve=null!=(_e=e.license)?_e:[]).length;j<_;j++)"am"!==(we=(m=ve[j])["content-version"])&&"vor"!==we&&"tdm"!==we&&"unspecified"!==we||(U["crossref_license_url_"+m["content-version"]]=m.URL);U.crossref_is_oa=null!=e.is_oa&&e.is_oa}if(null!=t){for(null==U&&(U={}),t.id&&(U.openalex=t.id.split("/").pop()),U.DOI||null==(null!=(be=t.ids)?be.doi:void 0)||(U.DOI=t.ids.doi.split("doi.org/").pop().toLowerCase()),(null!=(xe=t.ids)?xe.pmid:void 0)&&(U.PMID=t.ids.pmid.split("/").pop()),!U.PMCID&&(null!=(B=t.ids)?B.pmcid:void 0)&&(U.PMCID="PMC"+t.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),t.title&&(U.title=t.title),D=0,v=(F=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;D<v;D++)U[N=F[D]]=t[N];for(t.publication_date&&(U.published_date=t.publication_date),t.publication_year&&(U.published_year=t.publication_year),(null!=(Y=t.host_venue)?Y.issn:void 0)&&(U.issn=t.host_venue.issn),C=0,w=(X=null!=(V=U.concepts)?V:[]).length;C<w;C++){delete(n=X[C]).wikidata;try{n.score=Math.floor(100*n.score)}catch(e){}}for(P=0,b=(G=null!=($=U.authorships)?$:[]).length;P<b;P++)for(q=0,x=(Z=null!=(H=G[P].institutions)?H:[]).length;q<x;q++)delete Z[q].type}if(null==U&&(U={},"string"==typeof e&&(U.DOI=e.toLowerCase()),null!=c))for(d in c)U[d]=c[d];if(!U.is_paratext&&!U.is_retracted){if(delete U.is_paratext,delete U.is_retracted,!(null!=c?c.oadoi:void 0)&&U.DOI){for(U.oadoi=!0,M=0,k=(ee=null!=(Q=null!=(L=await this.src.oadoi(U.DOI))?L.oa_locations:void 0)?Q:[]).length;M<k;M++)if("publisher"===(I=ee[M]).host_type&&(null==U.publisher_license&&(U.publisher_license=I.license),null==U.publisher_url_for_pdf&&(U.publisher_url_for_pdf=I.url_for_pdf),null==U.publisher_version&&(U.publisher_version=I.version)),"repository"===I.host_type&&(I.url&&I.url.toLowerCase().includes("pmc")&&(U.PMCID||(T=I.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0]).length&&T.replace(/[^0-9]/g,"").length===T.length&&!isNaN(parseInt(T))&&(U.PMCID="PMC"+T),I.license&&!U.epmc_licence&&(U.epmc_licence=I.license)),!U.repository_url||!U.repository_url.includes("pmc")))for(Ie=0,O=(te=["license","url_for_pdf","url","version"]).length;Ie<O;Ie++)I[N=te[Ie]]&&(U["repository_"+N]=I[N]);U.repository_url&&U.repository_url.toLowerCase().includes("pmc")&&(null==U.PMCID&&(U.PMCID="PMC"+U.repository_url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0]),U.repository_url_in_pmc=!0),null!=L&&(U.best_oa_location_url=null!=(ie=L.best_oa_location)?ie.url:void 0,U.best_oa_location_url_for_pdf=null!=(se=L.best_oa_location)?se.url_for_pdf:void 0,U.oa_status=L.oa_status,U.has_repository_copy=L.has_repository_copy,U.has_oa_locations_embargoed=!(null==L.oa_locations_embargoed||!L.oa_locations_embargoed.length),U.title=L.title,U.issn||"string"!=typeof L.journal_issns||(U.issn=L.journal_issns.split(",")),null==U.journal&&(U.journal=L.journal_name),null==U.publisher&&(U.publisher=L.publisher),L.published_date&&(U.published_date=L.published_date),L.year&&(U.published_year=L.year),null!=L.is_oa&&(U.oadoi_is_oa=L.is_oa))}for await(Ae of(U.supplements=[],U.orgs=[],this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+U.DOI+'"',{sort:{"osdid.keyword":"asc"}})))re=Ae.org,h.call(U.orgs,re)<0&&U.orgs.push(Ae.org),Ae.paid&&(U.paid=!0),!U.email&&Ae.email&&(U.email=Ae.email),U.supplements.push(Ae);if(null!=U.authorships&&U.email&&!U.author_email_name&&(null==(null!=c?c.authorships:void 0)||!(null!=c?c.email:void 0)))if(o=U.email.includes("@")?U.email:await this.decrypt(U.email),1===U.authorships.length)U.author_email_name="Dr. "+(null!=(ae=U.authorships[0].author)?ae.display_name:void 0);else{for(ke=o.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),r="",a="",l=1e6,je=0,S=(le=U.authorships).length;je<S;je++)(W=null!=(ne=le[je].author)?ne.display_name:void 0)&&((Oe=(await this.levenshtein(ke,W.toLowerCase().replace(/[^a-z]/g,""))).distance/W.length)<l&&(l=Oe,a=W),l>.2&&(ke.endsWith(W.split(" ").pop().toLowerCase())||W.split(" ")[0].length>4&&ke.includes(W.split(" ")[0].toLowerCase()))&&(l=.1,a=W),!r&&ke.startsWith((W.split(" ")[0].slice(0,1)+W.split(" ").pop().slice(0,1)).toLowerCase())&&(r=W));a&&l<.7&&(U.author_email_name="Dr. "+a.split(" ").pop()),!U.author_email_name&&r&&(U.author_email_name="Dr. "+r)}return"string"==typeof U.email&&U.email.includes("@")&&(U.email=await this.encrypt(U.email)),null!=c&&(null!=(oe=c.orgs)?oe:[]).length===U.orgs.length&&U.paid===c.paid&&c.journal_oa_type||(U.orgs.length&&(U.DOI||(null!=(ce=U.issn)?ce:[]).length)&&(R=await this.permissions(await this.copy(U),void 0,void 0,L,e,Se-12096e5),U.can_archive=null!=R&&null!=(he=R.best_permission)?he.can_archive:void 0,null==U.can_archive&&((null!=(pe=null!=L&&null!=(de=L.best_oa_location)?de.license:void 0)?pe:"").includes("cc")||(null!=L?L.journal_is_in_doaj:void 0))&&(U.can_archive=!0),U.version=null!=R&&null!=(fe=R.best_permission)?fe.version:void 0,U.journal_oa_type=await this.permissions.journals.oa.type(void 0,void 0,L,e)),!U.DOI||U.PMCID&&U.PMID||(E=U.PMID?await this.src.pubmed(U.PMID):await this.src.pubmed.doi(U.DOI))&&((null!=E&&null!=(me=E.identifier)?me.pmc:void 0)&&(U.PMCID="PMC"+E.identifier.pmc.toLowerCase().replace("pmc","")),!U.PMID&&(null!=E&&null!=(ge=E.identifier)?ge.pubmed:void 0)&&(U.PMID=E.identifier.pubmed)),U.DOI&&!U.PMCID&&(u=await this.src.epmc.doi(U.DOI))&&u.pmcid&&(U.PMCID=u.pmcid),U.orgs.length&&U.PMCID&&U.repository_url_in_pmc&&!U.epmc_licence&&(A=await this.src.epmc.licence(U.PMCID,u),U.epmc_licence=null!=A?A.licence:void 0),U.pmc_has_data_availability_statement=U.PMCID&&await this.src.pubmed.availability(U.PMCID)),U.is_oa=U.oadoi_is_oa||U.crossref_is_oa||"gold"===U.journal_oa_type,null==U._id&&(U._id=U.DOI?U.DOI.toLowerCase().replace(/\//g,"_"):U.openalex),U.supplemented=await this.epoch(),null==U.updated&&(U.updated=U.supplemented),U.took=U.supplemented-Se,this.params.process===U.DOI&&(await this.report.articles(U),console.log(U)),U}},r.report.articles.load=async function(e,t,i,s,r){var a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x;if(w=await this.epoch(),null==s&&(s=null!=(g=this.params.load)?g:(await this.date()).split("-")[0]),null==t&&(t=this.params.org),null==i&&(i=this.params.load),"string"==typeof i&&(i=[i]),null==r&&(r=this.refresh),r&&await this.report.articles(""),o=[],2e3,u=0,x=0,a=async(t,i)=>{var s;if(u+=1,null!=(s=await this.report.articles.process(t,i,null!=e?e:r))&&(o.push(s),x+=1),o.length%200==0&&console.log("report load building batch",o.length),2e3===o.length)return await this.report.articles(o),o=[],console.log("report articles load",x,u,await this.epoch()-w)},"supplements"===this.params.load){for await(b of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",e?"updated:<"+e:void 0,{scroll:"5m",include:["DOI"]})))y=b.DOI,h.call(i,y)<0&&i.push(b.DOI);console.log("report articles supplements to load",i.length)}if(Array.isArray(i))for(d=0,f=i.length;d<f;d++)p=i[d],await a(p);else{for await(m of(l=async t=>{var i,r;for await(i of(null==t&&(t="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+s),e&&(t="("+t+") AND srcday:>"+e),console.log("report works load crossref by query",t),r=[],this.index._for("src_crossref_works",t,{scroll:"10m",include:["DOI","subject","title","subtitle","volume","issue","year","publisher","published","funder","license","is_oa","ISSN"]})))r.push(await a(i));return r},n=async t=>{var i,r;for await(i of(null==t&&(t="NOT ol.ids.doi:* AND authorships.institutions.display_name:* AND publication_year:"+s),e&&(t="("+t+") AND updated_date:>"+e),console.log("report works load openalex by query",t),r=[],this.index._for("src_openalex_works",t,{scroll:"10m"})))r.push(await a(void 0,i));return r},await Promise.all([l(),n()]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs",t?'name:"'+t+'"':"paid:true",{scroll:"10m"})))(null!=(_=m.source)?_.crossref:void 0)&&l(m.source.crossref),(null!=(v=m.source)?v.openalex:void 0)&&n(m.source.openalex);if(e)for await(c of this.index._for("report_articles","orgs:* AND updated:<"+e,{scroll:"10m"}))await this.src.crossref.works('DOI:"'+c.DOI+'" AND srcday:>'+e)&&await a(c)}return o.length&&await this.report.articles(o),console.log("report articles loaded",x,await this.epoch()-w),x},r.report.articles.load._async=!0,r.report.articles.compare=async function(){var e,t,i,s,r;for await(s of(t={processed:0,counts:{},article:[],cleaned:[],supplements:[],duplicates:[]},this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs:* AND DOI:*",{scroll:"10m",include:["DOI"]})))t.processed+=1,t.processed%200==0&&console.log("report articles comparing",t.processed),await this.report.articles(s.DOI)||(r=s.DOI,h.call(t.article,r)>=0?t.duplicates.push(s.DOI):"string"==typeof(e=s.DOI.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/ /g,"").replace(/^\//,"").split("?")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,""))&&e.length&&await this.report.articles(e)?t.cleaned.push(s.DOI):await this.report.orgs.supplements.count('DOI:"'+s.DOI+'"')?t.article.push(s.DOI):t.supplements.push(s.DOI));return t.counts={article:t.article.length,cleaned:t.cleaned.length,supplements:t.supplements.length,duplicates:t.duplicates.length},i=this.S.static.folder+"/report_articles_works_compare.json",await fs.writeFile(i,JSON.stringify(t,"",2)),this.mail({to:"mark@oa.works",subject:"OA report articles works compared ",text:i}),t};h=[].indexOf;null==r.svc&&(r.svc={}),r.svc.rscvd={_index:!0},r.svc.rscvd.form=async function(){var e,t,i,s,r,a,l,n;if(this.keys(this.params).length>1){delete(t=this.copy(this.params)).form,t.status="Awaiting verification";try{(l=await this.svc.rscvd.requestees('email:"'+t.email+'"'))&&((null!=l?l.verified:void 0)||"Approved"===(null!=l?l.verification:void 0)?(t.status="Verified",t.verified=!0):((null!=l?l.denied:void 0)||"Denied"===(null!=l?l.verification:void 0))&&(t.status="Denied",t.verified=!1))}catch(e){}if("Awaiting verification"===t.status)try{(null!=(e=await this.svc.rscvd('email:"'+t.email+'" AND verified:*'))&&null!=(i=e.hits)?i.hits:void 0)&&!0===e.hits.hits[0]._source.verified?(t.status="Verified",t.verified=!0):!1===e.hits.hits[0]._source.verified&&(t.status="Denied",t.verified=!1)}catch(e){}null==t.type&&(t.type="paper");try{t.createdAt=new Date}catch(e){}try{t.neededAt=await this.epoch(t["needed-by"])}catch(e){}t._id=await this.svc.rscvd(t);try{n="Hi "+t.name+",<br><br>We got your request:<br><br>Title: "+(null!=(s=null!=(r=t.atitle)?r:t.title)?s:"Unknown")+"\nReference (if provided): "+(null!=(a=t.reference)?a:"")+"<br><br>",n+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+t._id+'">cancel your request</a>, it only takes a second.<br><br>',n+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',n+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:t.email,subject:"RSCVD Request Receipt",text:n})}catch(e){}return t}},r.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},r.svc.rscvd.resolves=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d;for(null==e&&(e=this.params.resolves),null==t&&(t=this.params.resolver),e?l="object"==typeof e?e:await this.svc.rscvd(e):n=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+t+'" AND NOT unresolved:"'+t+'"'),p={},i=0,s=(c=null!=l?[l]:null!=(o=null!=n&&null!=(u=n.hits)?u.hits:void 0)?o:[]).length;i<s;i++)null!=(a=c[i])._source&&null==(l=a._source)._id&&(l._id=a._id),(r=this.copy(l)).title&&(r.journal=r.title),r.atitle&&(r.title=r.atitle),(null!=(d=await this.ill.subscription({subscription:t},r))?d.url:void 0)?(null==l.resolved&&(l.resolved=[]),l.resolved.push(t),null==l.resolves&&(l.resolves=[]),l.resolves.push({resolver:t,url:d.url,user:null!=(h=this.user)?h._id:void 0}),p[a._id]=!0):(null==l.unresolved&&(l.unresolved=[]),l.unresolved.push(t),p[a._id]=!1),this.svc.rscvd(l);return e&&p[e]?p[e]:p},r.svc.rscvd.cancel=async function(){var e;if(this.params.cancel)return(e=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(e),e},r.svc.rscvd.verify=async function(e,t=!0){var i,s;if(null==e&&(e=this.params.verify),e)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:e,createdAt:Date.now()}),t?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+e+'"',{action:"index"},(function(e){return e.status&&"Awaiting verification"!==e.status||(e.verified=t,t?(e.status="Verified",e.verified_by=this.user.email):(e.status="Denied",e.denied_by=this.user.email)),e})),!0},r.svc.rscvd.verify._auth=!0,r.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},r.svc.rscvd.deny._auth=!0,r.svc.rscvd.status=async function(){var e,t,i;if(this.params.status){[t,i]=this.params.status.split("/"),(e=await this.svc.rscvd(t)).status=i;try{"Done"===e.status?e.done_by=this.user.email:"In Progress"===e.status&&(e.progressed_by=this.user.email)}catch(e){}return this.svc.rscvd(e),e}},r.svc.rscvd.status._auth=!0,r.svc.rscvd.poll=async function(e,t){var i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N;if(this.nolog=!0,null==e&&(e=null!=(w=this.params.poll)?w:Date.now()-18e4),"string"==typeof(t=null!=(b=this.params.which)?b:["new","verify","deny","cancel","status","overdue"])&&(t=t.split(",")),h.call(t,"overdue")>=0&&this.svc.rscvd.overdue(),D={new:[],verify:[],deny:[],cancel:[],status:{}},h.call(t,"new")>=0)for(l=0,c=(O=null!=(x=null!=(v=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+e,500))&&null!=(k=v.hits)?k.hits:void 0)?x:[]).length;l<c;l++)null==(i=(y=O[l])._source)._id&&(i._id=y._id),D.new.push(y._source);if(h.call(t,"verify")>=0)for(n=0,p=(S=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;n<p;n++)N=S[n]._source.parts.pop(),h.call(D.verify,N)<0&&D.verify.push(N);if(h.call(t,"deny")>=0)for(o=0,d=(A=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<d;o++)a=A[o]._source.parts.pop(),h.call(D.deny,a)<0&&D.deny.push(a);if(h.call(t,"cancel")>=0)for(u=0,f=(I=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<f;u++)r=I[u]._source.parts.pop(),h.call(D.cancel,r)<0&&D.cancel.push(r);if(h.call(t,"status")>=0)for(g=0,m=(j=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;g<m;g++)L=(C=j[g])._source.parts.pop(),null==(s=D.status)[_=C._source.parts.pop()]&&(s[_]=L);return D},r.svc.rscvd.overdue=async function(){var e,t,i,s,r,a,l,n,o,u,c;if(t=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(s=0,a=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;s<a;s++)null==(e=(n=c[s])._source)._id&&(e._id=n._id),u.push(n._source);for(r=0,l=u.length;r<l;r++)(o=u[r]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),t+=1;return t};h=[].indexOf;r.src.crossref=function(){return"Crossref API wrapper"},r.src.crossref.works={_index:{settings:{number_of_shards:9}}},r.src.crossref.works._key="DOI",r.src.crossref.works._prefix=!1,r.src.crossref.works.doi=async function(e,t){var i,s,r,a,l,n,o;if(null==e&&(e=this.params.doi),null==t&&(t=null!=(s=this.params.save)&&s),"string"==typeof e&&e.startsWith("10.")&&(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),null!=(null!=(o=await this.fetch("https://api.crossref.org/works/"+e,{headers:{"User-Agent":(null!=(r=this.S.name)?r:"OA.Works")+"; mailto:"+(null!=(a=null!=(l=this.S.mail)?l.to:void 0)?a:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}))&&null!=(n=o.message)?n.DOI:void 0)))return i=await this.src.crossref.works._format(o.message),t&&await this.src.crossref.works(i),i},r.src.crossref.works.title=async function(e){var t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_;if(null==e&&(e=null!=(o=this.params.title)?o:this.params.q),l='title:"'+e+'"',e.split(" ").length>2){for(l+=" OR (",t=0,i=(u=e.split(" ")).length;t<i;t++)_=u[t],l.endsWith("(")||(l+=" AND "),l+='(title:"'+_+'" OR subtitle:"'+_+'")';l+=")"}for(f=await this.src.crossref.works(l),r=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),a=0,s=(d=null!=(c=null!=f&&null!=(p=f.hits)?p.hits:void 0)?c:[]).length;a<s;a++)(n=d[a])._source.DOI&&n._source.title&&n._source.title.length&&(g=("string"==typeof n._source.title?n._source.title:n._source.title[0]).toLowerCase(),n._source.subtitle&&n._source.subtitle.length&&"string"==typeof(y=("string"==typeof n._source.subtitle?n._source.subtitle:n._source.subtitle[0]).toLowerCase())&&y.length&&h.call(g,y)<0&&(g+=" "+y),g=g.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==r.indexOf(g)||-1!==g.indexOf(r))&&r.length/g.length>.7&&r.length/g.length<1.3&&("journal-article"===n._source.type||null==m||"journal-article"!==m.type&&"journal-article"===n._source.type)&&(m=n._source));return m},r.src.crossref.works._format=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d,f,m,g;for(e.abstract&&(e.abstract=e.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==e._id&&(e._id=e.DOI.replace(/\//g,"_")),s=0,a=(h=null!=(c=e.assertion)?c:[]).length;s<a;s++)"OPEN ACCESS"===(t=h[s]).label&&(t.URL&&-1!==t.URL.indexOf("creativecommons")&&(null==e.license&&(e.license=[]),e.license.push({URL:t.URL})),e.is_oa=!0);for(o=0,l=(d=null!=(p=e.license)?p:[]).length;o<l;o++)if((r=d[o]).URL&&-1!==r.URL.indexOf("creativecommons")&&(!e.licence||-1===e.licence.indexOf("creativecommons"))){e.licence=r.URL;try{e.licence="cc-"+e.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(e){}e.is_oa=!0}try{e.reference&&e.reference.length>100&&(e.reference_original_length=e.reference.length,e.reference=e.reference.slice(0,100))}catch(e){}try{e.relation&&e.relation.length>100&&(e.relation_original_length=e.relation.length,e.relation=e.relation.slice(0,100))}catch(e){}for(u=0,n=(m=null!=(f=e.author)?f:[]).length;u<n;u++)(i=m[u]).name=(i.given?i.given+" ":"")+(null!=(g=i.family)?g:"");if(e.published=await this.src.crossref.works.published(e)){try{e.year=e.published.split("-")[0]}catch(e){}try{parseInt(e.year)}catch(e){}try{e.publishedAt=await this.epoch(e.published)}catch(e){}}return e},r.src.crossref.works.published=async function(e){var t,i,s,r,a,l,n,o,u;if(null==e&&(e=this.params.published),"string"==typeof e&&(e=await this.src.crossref.works(e)),null!=e){for(a=void 0,r=void 0,t=0,i=(n=["published","published-print","published-online","issued","deposited"]).length;t<i;t++)"object"==typeof e[s=n[t]]&&(l=void 0,"string"==typeof e[s]["date-time"]&&3===e[s]["date-time"].split("T")[0].split("-").length?l=e[s]["date-time"].split("T")[0]:Array.isArray(e[s]["date-parts"])&&e[s]["date-parts"].length&&Array.isArray(e[s]["date-parts"][0])&&("string"!=(o=typeof(u=e[s]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(l=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),l&&(!r||a>await this.epoch(l))&&(r=l,a=await this.epoch(r)));return r}},r.src.crossref.works.search=async function(e,t,i,s,r,a,l,n){var o,u,c,h,p,d,f,m,g,y,_,v,w;if(null==e&&(e=null!=(p=this.params.q)?p:this.params.search),null==t&&(t=this.params.from),null==i&&(i=this.params.size),null==s&&(s=this.params.filter),null==r&&(r=this.params.start),null==a&&(a=this.params.end),null==l&&(l=this.params.sort),null==n&&(n=null!=(d=this.params.order)?d:"asc"),r&&(o=null!=(f=null!=s?s:l)?f:"indexed","string"==typeof r&&-1!==r.indexOf("-")||(r=await this.date(r)),s=(s?s+",":"")+"from-"+o.replace("lished","").replace("xed","x").replace("ited","it")+"-date:"+r),a&&(null==o&&(o=null!=(m=null!=s?s:l)?m:"created"),"string"==typeof a&&-1!==a.indexOf("-")||(a=await this.date(a)),s=(s?s+",":"")+"until-"+o.replace("lished","").replace("xed","x").replace("ited","it")+"-date:"+a),w="https://api.crossref.org/works?",null!=l&&(w+="sort="+l+"&order="+n+"&"),"object"==typeof e)for(c in e)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(w+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(e[c])+"&");else e&&"all"!==e&&(h=(h=e.replace(/\w+?\:/g,"")).replace(/ /g,"+"),w+="query="+encodeURIComponent(h)+"&");if(null!=t){if("*"!==t&&"string"==typeof t&&!t.replace(/[0-9]/g,"").length)try{u=parseInt(t),isNaN(u)||(t=u)}catch(e){}w+="number"!=typeof t?"cursor="+encodeURIComponent(t)+"&":"offset="+t+"&"}null!=i&&(w+="rows="+i+"&"),null!=s&&""!==s&&(w+="filter="+encodeURIComponent(s)+"&"),w=w.replace("?&","?").replace(/&$/,"");try{return{total:(v=await this.fetch(w,{headers:{"User-Agent":(null!=(g=this.S.name)?g:"OA.Works")+"; mailto:"+(null!=(y=null!=(_=this.S.mail)?_.to:void 0)?y:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}})).message["total-results"],cursor:v.message["next-cursor"],data:v.message.items,facets:v.message.facets}}catch(e){}},r.src.crossref.journals={_index:!0,_prefix:!1},r.src.crossref.journals.load=async function(){var e,t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j;for(await this.src.crossref.journals(""),t=0,A=0,e=[],i="*";i&&(0===t||t<A);){for(I="https://api.crossref.org/journals?cursor="+i+"&rows=1000",O=await this.fetch(I,{headers:{"User-Agent":(null!=(p=this.S.name)?p:"OA.Works")+"; mailto:"+(null!=(d=null!=(g=this.S.mail)?g.to:void 0)?d:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}),0===A&&(A=O.message["total-results"]),i=O.message["next-cursor"],r=0,a=(y=O.message.items).length;r<a;r++){for(null==(c=y[r]).ISSN&&(c.ISSN=[]),c.issn=[],o=0,l=(_=c.ISSN).length;o<l;o++)"string"==typeof(s=_[o])&&s.length&&h.call(c.issn,s)<0&&c.issn.push(s);if(c.dois=null!=(v=c.counts)?v["total-dois"]:void 0,null!=(null!=(w=c.breakdowns)?w["dois-by-issued-year"]:void 0)){for(c.years=[],u=0,n=(b=c.breakdowns["dois-by-issued-year"]).length;u<n;u++)2===(j=b[u]).length&&(x=j[0],h.call(c.years,x)<0)&&c.years.push(j[0]);c.years.sort()}null!=c.years&&c.years.length&&c.dois?(S=(new Date).getFullYear(),h.call(c.years,S)<0&&(k=S-1,h.call(c.years,k)<0)&&(f=S-2,h.call(c.years,f)<0)&&(m=S-3,h.call(c.years,m)<0)&&(c.discontinued=!0)):c.discontinued=!0,e.push(c)}t+=1e3,e.length>=1e4&&(await this.src.crossref.journals(e),e=[])}return e.length&&(await this.src.crossref.journals(e),e=[]),console.log(t),t},r.src.crossref.journals.load._bg=!0,r.src.crossref.journals.load._async=!0,r.src.crossref.journals.load._auth="root",r.src.crossref.load=async function(){var e,t,i,s,r,a,l,n,o,u,c,p,d;i=null!=(c=this.params.howmany)?c:-1,s=this.S.directory+"/crossref/data/",a=this.S.directory+"/crossref/last",t=0;try{this.refresh||(t=parseInt((await fs.readFile(a)).toString()))}catch(e){}for(d=0,e=[];t>=0&&-1!==t&&t<26810;){if(h.call([],t)<0){if(d===i)break;for await(n of(console.log("Crossref load starting file",t),o="",readline.createInterface({input:fs.createReadStream(s+t+".json.gz").pipe(zlib.createGunzip())})))o+=n;for(r=0,l=(p=JSON.parse(o).items).length;r<l&&(u=p[r],d!==i);r++)d+=1,(u=await this.src.crossref.works._format(u)).srcfile=t,e.push(u),1e4===e.length&&(console.log("Crossref load "+t,d),await this.src.crossref.works(e),await fs.writeFile(a,t),e=[])}t+=1}return e.length&&await this.src.crossref.works(e),console.log(d),d},r.src.crossref.load._bg=!0,r.src.crossref.load._async=!0,r.src.crossref.load._auth="root",r.src.crossref.changes=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d,f;if(1e4,null==e&&(e=this.params.changes),!e)try{e=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday}catch(e){}for(null==e&&(e=16071264e5),r=Date.now(),u=0,s=0,t=[];e<r;){for(console.log("Crossref changes",e,s),i="*",s+=1,f=!1,l=0;!1===f||l<f;)if(await this.sleep(500),null!=(d=await this.src.crossref.works.search(void 0,i,1e3,void 0,e,e))?d.data:void 0){for(n=0,o=(h=d.data).length;n<o;n++)c=h[n],(a=await this.src.crossref.works._format(c)).srcday=e,t.push(a),u+=1;t.length>=1e4&&(console.log("Crossref bulk load",e,s,f,l,u),await this.src.crossref.works(t),t=[]),!1===f&&(f=null!=(p=d.total)?p:0,console.log(e,f)),l+=1e3,i=d.cursor}else console.log("crossref error"),await this.sleep(2e3);e+=864e5}return t.length&&await this.src.crossref.works(t),console.log(u,s),u},r.src.crossref.changes._bg=!0,r.src.crossref.changes._async=!0,r.src.crossref.changes._auth="root",r.src.crossref.changes._notify=!1,r.src.doaj={},r.src.doaj.journals={_index:!0,_prefix:!1},r.src.doaj.journals.load=async function(){var e,t,i,s,r,a,l,n;for(i="/tmp/doaj_"+await this.uid(),await fs.mkdir(i),i+="/",await fs.writeFile(i+"doaj.tar",await this.fetch("https://doaj.org/public-data-dump/journal",{buffer:!0})),tar.extract({file:i+"doaj.tar",cwd:i,sync:!0}),e=!1,s=0,a=(l=await fs.readdir(i)).length;s<a;s++)(t=l[s]).includes("doaj_journal_data")&&(e=t);return n=0,e&&(n=(r=JSON.parse(await fs.readFile(i+e+"/journal_batch_1.json"))).length,await this.src.doaj.journals(""),await this.src.doaj.journals(r),await fs.unlink(i+e+"/journal_batch_1.json")),await fs.rmdir(i+e),await fs.unlink(i+"doaj.tar"),await fs.rmdir(i),n},r.src.doaj.journals.load._bg=!0,r.src.doaj.journals.load._async=!0,r.src.doaj.journals.load._auth="root",r.src.epmc={_index:!0,_prefix:!1,_key:"id"},r.src.epmc.notinepmc={_index:!0,_prefix:!1,_key:"id",_hide:!0},r.src.epmc.search=async function(e,t,i){var s,r,a,l,n,o,u,c;return null==e&&(e=null!=(s=null!=(r=null!=(a=this.params.search)?a:this.params.epmc)?r:this.params.doi)?s:""),e.startsWith("10.")&&!e.includes(" ")&&e.split("/").length>=2&&(e="DOI:"+e),"string"!=typeof e||e.startsWith("PMCID:")||!e.toLowerCase().startsWith("pmc")||e.includes(" ")||(e="PMCID:PMC"+e.toLowerCase().replace("pmc","")),"number"==typeof e&&(e="PMCID:PMC"+e),c="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(c+="&pageSize="+i),null!=t&&(c+="&cursorMark="+t),u={},await this.sleep(150),console.log(c),o=await this.fetch(c),u.total=o.hitCount,u.data=null!=(l=null!=(n=o.resultList)?n.result:void 0)?l:[],u.cursor=o.nextCursorMark,u.data.length&&this.waitUntil(this.src.epmc(u.data)),u},r.src.epmc.doi=async function(e,t){var i,s,r;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.doi),null!=(i=await this.src.epmc('doi:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!t&&await this.src.epmc.notinepmc(e));else{if((r=await this.src.epmc.search("DOI:"+e)).total)return r.data[0].doi||(r.data[0].doi=e,this.waitUntil(this.src.epmc(r.data[0]))),r.data[0];await this.src.epmc.notinepmc({id:e.replace(/\//g,"_"),doi:e})}},r.src.epmc.pmid=async function(e,t){var i,s,r;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.pmid),null!=(i=await this.src.epmc('pmid:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!t&&await this.src.epmc.notinepmc(e));else{if((r=await this.src.epmc.search("EXT_ID:"+e+" AND SRC:MED")).total)return r.data[0];await this.src.epmc.notinepmc({id:e,pmid:e})}},r.src.epmc.pmc=async function(e,t){var i,s,r,a;if(e||null==t&&(t=this.refresh),null==e&&(e=null!=(s=this.params.pmc)?s:this.params.pmcid),e="PMC"+e.toLowerCase().replace("pmc",""),null!=(i=await this.src.epmc('pmcid:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&await this.src.epmc.notinepmc(e));else{if((a=await this.src.epmc.search("PMCID:"+e)).total)return a.data[0];await this.src.epmc.notinepmc({id:e,pmcid:e})}},r.src.epmc.title=async function(e){var t,i,s;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(null!=(t=await this.src.epmc('title:"'+e+'"'))&&null!=(i=t.hits)?i.total:void 0)?t.hits.hits[0]._source:(s=await this.src.epmc.search('title:"'+e+'"')).total?s.data[0]:void 0},r.src.epmc.licence=async function(e,t,i,s){var r,a,l;if(e||null==s&&(s=this.refresh),null==e&&(e=null!=(a=null!=(l=this.params.licence)?l:this.params.pmcid)?a:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),e&&null==t&&(t=await this.src.epmc.pmc(e)),t||i){if(null!=(null!=t?t.calculated_licence:void 0)&&!s)return"not found"===t.calculated_licence.licence?void 0:t.calculated_licence;if(null==e&&(e=null!=t?t.pmcid:void 0),(null!=t?t.license:void 0)&&"string"==typeof t.license?(r={licence:t.license,source:"epmc_api"}).licence.startsWith("cc")&&(r.licence=r.licence.replace(/ /g,"-")):(!i&&e&&(i=await this.src.epmc.xml(e,t)),null!=this.licence&&i&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(r=await this.licence(void 0,i,"<permissions>","</permissions>"))?r.licence:void 0)&&(r.source="epmc_xml_permissions"),null==(null!=r?r.licence:void 0)&&null!=(null!=(r=await this.licence(void 0,i))?r.licence:void 0)&&(r.source="epmc_xml_outside_permissions")),null==(null!=r?r.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(r={licence:"non-standard-licence",source:"epmc_xml_permissions"})),null!=(null!=r?r.licence:void 0))return t.calculated_licence=r,await this.src.epmc(t.id,t),r;t.calculated_licence={licence:"not found"},await this.src.epmc(t.id,t)}},r.src.epmc.xml=async function(e,t){var i,s,r,a;if(null==e&&(e=null!=(s=null!=(r=this.params.xml)?r:this.params.pmcid)?s:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),e)try{return(i=await fs.readFile("/home/cloo/static/epmc/fulltext/"+e+".xml")).toString()}catch(s){if(null==t&&(t=await this.src.epmc.pmc(e)),!(null!=t?t.no_ft:void 0)){if(await this.sleep(150),a="https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",console.log(a),"string"==typeof(i=await this.fetch(a))&&i.length){try{await fs.writeFile("/home/cloo/static/epmc/fulltext/"+e+".xml",i)}catch(e){}return i}null!=t&&(t.no_ft=!0,await this.src.epmc(t.id,t))}}},r.src.epmc.aam=async function(e,t,i){var s,r,a,l;if(null==e&&(e=null!=(r=null!=(a=this.params.aam)?a:this.params.pmcid)?r:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{e&&!t&&(t=await this.src.epmc.pmc(e))}catch(e){}return null==e&&(e=null!=t?t.pmcid:void 0),e?"string"==typeof(i=await this.src.epmc.xml(e,t))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),l="https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc",""),console.log(l),(s=await this.puppet(l))?"string"==typeof s?("Author Manuscript; Accepted for publication in peer reviewed journal","Author manuscript; available in PMC","logo-nihpa.gif","logo-wtpa2.gif",s.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||s.includes("Author manuscript; available in PMC")||s.includes("logo-nihpa.gif")||s.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}):null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},null==(p=a.src).google&&(p.google={});try{a.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}r.src.google=async function(e,t,i){var s,r,a,l,n,o,u,c,h,p;return null==e&&(e=null!=(s=null!=this&&null!=(r=this.params)?r.q:void 0)?s:null!=this&&null!=(a=this.params)?a.google:void 0),null==t&&(t=null!=(l=this.S.src.google)&&null!=(n=l.secrets)&&null!=(o=n.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(h=c.search)?h.key:void 0),e&&t&&i?(p="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(p)):{}},r.src.google.sheets=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b;if(null==e&&(e=this.copy(this.params)),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(c=e.sheet)?c:e.sheets,delete e.sheet,delete e.sheets),!e.sheetid)return[];if(e.sheetid.startsWith("http")&&e.sheetid.includes("sheets.googleapis.com/v4/")?v=e.sheetid:(e.sheetid.includes("/spreadsheets/")?(y=e.sheetid.replace("/spreadsheets/d/","/spreadsheets/").split("/spreadsheets/")[1].split("/")[0],!e.sheet&&e.sheetid.includes("/values/")&&(e.sheet=e.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),e.sheetid=y):2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="Sheet1"),v="https://sheets.googleapis.com/v4/spreadsheets/"+e.sheetid+"/values/"+e.sheet+"?alt=json&key="+(null!=(h=null!=(p=this.S.src.google)&&null!=(d=p.secrets)?d.serverkey:void 0)?h:null!=(f=this.S.src.google)&&null!=(m=f.secrets)?m.apikey:void 0)),t=await this.fetch(v,{headers:{"Cache-Control":"no-cache"}}),!1===e.values)return t;if(!1===e.headers)return t.values;if(Array.isArray(e.headers))r=e.headers;else if(r=[],null!=t.values)for(a=0,o=(_=t.values.shift()).length;a<o;a++){s=_[a];try{s=s.trim()}catch(e){}r.push(s)}for(b=[],l=0,u=(g=t.values).length;l<u;l++){for(i in n=g[l],w={},r)try{w[r[i]]=n[i]}catch(e){}"{}"!==JSON.stringify(w)&&b.push(w)}return b},r.src.google.sheets._bg=!0;h=[].indexOf;null==(p=a.src).microsoft&&(p.microsoft={});try{a.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(e){}r.src.microsoft={},r.src.microsoft.bing=async function(e,t,i,s,r){var l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x;return null==e&&(e=null!=(l=null!=(n=null!=this&&null!=(d=this.params)?d.bing:void 0)?n:null!=this&&null!=(f=this.params)?f.q:void 0)?l:null!=this&&null!=(m=this.params)?m.query:void 0),null==t&&(t=null!=(g=null!=this&&null!=(y=this.params)?y.key:void 0)?g:null!=(_=a.src.microsoft.bing)?_.key:void 0),null==i&&(i=null!=(v=null!=this&&null!=(w=this.params)?w.market:void 0)?v:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==r&&(r=null!=(c=null!=this&&null!=(h=this.params)?h.cache:void 0)?c:259200),null!=e&&null!=t&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+e,null!=(b=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":t},cache:r}))&&null!=(p=b.webPages)?p.value:void 0)?{total:b.webPages.totalEstimatedMatches,data:b.webPages.value}:{total:0,data:[]}},r.src.microsoft.bing._auth="@oa.works",r.src.microsoft.graph={_prefix:!1,_index:{settings:{number_of_shards:9}}},r.src.microsoft.graph.journal={_prefix:!1,_index:!0},r.src.microsoft.graph.author={_prefix:!1,_index:{settings:{number_of_shards:9}}},r.src.microsoft.graph.affiliation={_prefix:!1,_index:!0},r.src.microsoft.graph.urls={_prefix:!1,_index:{settings:{number_of_shards:6}}},r.src.microsoft.graph.abstract={_prefix:!1,_index:{settings:{number_of_shards:6}}},r.src.microsoft.graph.relation={_prefix:!1,_index:{settings:{number_of_shards:12}}},r.src.microsoft.graph.paper=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b;if(b={1:"html",2:"text",3:"pdf",4:"doc",5:"ppt",6:"xls",8:"rtf",12:"xml",13:"rss",20:"swf",27:"ics",31:"pub",33:"ods",34:"odp",35:"odt",36:"zip",40:"mp3"},this.params.title&&!e)return this.src.microsoft.graph.paper.title();for(s=0,l=(m=null!=(d=null!=(_="object"==typeof(e=null!=(h=null!=(p=this.params.q)?p:this.params.paper)?h:this.params)&&e.PaperId&&e.Rank?e:await this.src.microsoft.graph(e))&&null!=(f=_.hits)?f.hits:void 0)?d:_?[_]:[]).length;s<l;s++){c=m[s];try{for(g=(await this.src.microsoft.graph.urls('PaperId:"'+c._source.PaperId+'"')).hits.hits,r=0,n=g.length;r<n;r++){w=g[r],null==(t=c._source).url&&(t.url=[]),u={url:w._source.SourceUrl,language:w._source.LanguageCode};try{u.type=b[w._source.SourceType.toString()]}catch(e){}c._source.url.push(u)}}catch(e){}try{for(y=(await this.src.microsoft.graph.relation('PaperId:"'+c._source.PaperId+'"',100)).hits.hits,a=0,o=y.length;a<o;a++)(v=y[a])._source.AuthorId&&(null==(i=c._source).author&&(i.author=[]),c._source.author.push({name:v._source.OriginalAuthor,sequence:v._source.AuthorSequenceNumber,id:v._source.AuthorId,affiliation:{name:v._source.OriginalAffiliation,id:v._source.AffiliationId}}))}catch(e){}}return _},r.src.microsoft.graph.title=async function(e){var t,i,s,r,a,l,n,o;if(null==e&&(e=null!=(s=this.params.title)?s:this.params.q),"string"==typeof e&&(o=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(null!=(l=await this.src.microsoft.graph('PaperTitle:"'+o+'"',1))&&null!=(r=l.hits)?r.hits:void 0)&&(l=null!=(a=l.hits.hits[0])?a._source:void 0),(null!=l?l.PaperTitle:void 0)&&(n=l.PaperTitle.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),t=(i=await this.levenshtein(o,n,!1)).length.a>i.length.b?i.length.a:i.length.b,i.distance<2||t/i.distance>10)))return this.src.microsoft.graph.paper(l)},r.src.microsoft.load=async function(e){var t,i,s,r,a,l,n,o,u,c,p,d,f,m,g,y;for(l=null!=(g=this.params.howmany)?g:-1,c={paper:["PaperId","Rank","Doi","DocType","PaperTitle","OriginalTitle","BookTitle","Year","Date","OnlineDate","Publisher","JournalId","ConferenceSeriesId","ConferenceInstanceId","Volume","Issue","FirstPage","LastPage","ReferenceCount","CitationCount","EstimatedCitation","OriginalVenue","FamilyId","FamilyRank","CreatedDate"]},null==e&&(e=this.params.load?this.params.load.split(","):this.params.kinds?this.params.kinds.split(","):this.keys(c)),o=this.S.directory+"/mag/2021-04-26/",p=this.S.directory+"/mag/last",y=0,i=0,r=!this.params.parallel,a={},f=0,m={},{1:"html",2:"text",3:"pdf",4:"doc",5:"ppt",6:"xls",8:"rtf",12:"xml",13:"rss",20:"swf",27:"ics",31:"pub",33:"ods",34:"odp",35:"odt",36:"zip",40:"mp3"},t=async e=>{var t,s,r,n,u,h,d,g,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q;console.log("MAG loading",e),n="abstract"===e?2e4:"relation"===e?75e3:"urls"===e?1e5:5e4,s=[],k=p+"_"+e,O=0;try{this.refresh||(A=parseInt((await fs.readFile(k)).toString().split(" ")[0]))}catch(e){}if("DONE"!==A){for await(C of(A||("paper"===e?await this.src.microsoft.graph(""):await this.src.microsoft.graph[e]("")),d=("urls"===e?o.replace("2021-04-26/",""):o)+("relation"===e?"PaperAuthorAffiliations.txt":("urls"===e?"Paper":"")+e.substr(0,1).toUpperCase()+e.substr(1)+("urls"===e?"":"s")+".txt"),readline.createInterface({input:fs.createReadStream(d)}))){if(O+=1,y===l)break;E=C.split("\t");try{A&&!(O/1e5).toString().includes(".")&&console.log(e,"waiting",O,A)}catch(e){}if(!A||O===A||parseInt(E[0])===A){if(A=void 0,y+=1,b=0,L={},"relation"!==e&&"urls"!==e){L._id=E[0];try{L._id=L._id.trim()}catch(e){}L._id||delete L._id}if(L._id||"relation"===e||"urls"===e){if("abstract"===e)try{for(L.PaperId=parseInt(E[0]),h=JSON.parse(E[1]),t=[];t.length<h.IndexLength;)t.push("");for(P=h.InvertedIndex,u=0,I=P.length;u<I;u++)for(w=P[u],R=h.InvertedIndex[w],g=0,j=R.length;g<j;g++)t[R[g]]=w;L.Abstract=t.join(" ").replace(/\n/g," ")}catch(e){}else for(S=0,D=(T=c[e]).length;S<D;S++){x=T[S],q=E[b];try{q.trim()}catch(e){}if(q&&"NormalizedName"!==x&&(L[x]=q),"Rank"===x||"AuthorSequenceNumber"===x||"Year"===x||"EstimatedCitation"===x||"FamilyRank"===x||"SourceType"===x||x.endsWith("Count")||x.endsWith("Id"))try{N=parseInt(L[x]),isNaN(N)||(L[x]=N)}catch(e){}b+=1}if("paper"===e&&L.JournalId)try{v=L.JournalId.toString(),(_=m[v])?L.journal={title:_.DisplayName,ISSN:_.Issn.split(","),url:_.Webpage,id:L.JournalId}:(_=await this.src.microsoft.graph.journal(v))&&(m[v]=_,f+=1,console.log(f),L.journal={title:_.DisplayName,ISSN:_.Issn.split(","),url:_.Webpage})}catch(e){}}"{}"!==JSON.stringify(L)?s.push(L):i+=1}s.length===n&&(console.log(e,y,O,i),"paper"===e?await this.src.microsoft.graph(s):(r=await this.src.microsoft.graph[e](s),console.log("batch returned",r)),await fs.writeFile(k,O+" "+E[0]),s=[])}s.length&&("paper"===e?await this.src.microsoft.graph(s):await this.src.microsoft.graph[e](s)),await fs.writeFile(k,"DONE")}return a[w]=!0},n=0,d=e.length;n<d;n++)u=e[n],this.params.parallel?"paper"!==u&&(a[u]=!1,t(u)):await t(u);for(;!r;){for(s in r=!0,a)!1===a[s]&&(r=!1);r&&h.call(e,"paper")>=0&&await t("paper"),await this.sleep(1e3)}return console.log(y,i),y},r.src.microsoft.load._bg=!0,r.src.microsoft.load._async=!0,r.src.microsoft.load._auth="root",null==(p=a.src).oadoi&&(p.oadoi={});try{a.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(e){}r.src.oadoi={_index:{settings:{number_of_shards:9}}},r.src.oadoi._key="doi",r.src.oadoi._prefix=!1,r.src.oadoi.search=async function(e){var t,i,s,r,l,n;if(null==e&&(e=null!=(t=null!=(i=null!=(s=this.params)?s.oadoi:void 0)?i:null!=(r=this.params)?r.doi:void 0)?t:null!=(l=this.params)?l.search:void 0),"string"==typeof e&&e.startsWith("10."))return await this.sleep(900),n="https://api.oadoi.org/v2/"+e+"?email="+a.mail.to,this.fetch(n)},r.src.oadoi.hybrid=async function(e){var t,i,s,r,a,l;if(null==e&&(e=null!=(r=null!=(a=this.params.hybrid)?a:this.params.issn)?r:this.params.issns),"object"!=typeof e||Array.isArray(e)||(e=null!=(l=e.journal_issns)?l:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return(s="journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(s="("+s+")"),t=await this.src.oadoi.count(s+' AND oa_status:"closed"'),i=await this.src.oadoi.count(s+' AND oa_status:"hybrid"'),!!(t&&i/t>.001)},r.src.oadoi.load=async function(){var e,t,i,s,r,a,l,n,o;t=null!=(n=this.params.howmany)?n:-1,i=this.S.directory+"/oadoi/snapshot.jsonl",s=this.S.directory+"/oadoi/last";try{this.refresh||(r=(await fs.readFile(s)).toString())}catch(e){}for await(a of(r||await this.src.oadoi(""),o=0,e=[],readline.createInterface({input:fs.createReadStream(i).pipe(zlib.createGunzip())}))){if(o===t)break;try{l=JSON.parse(a.trim().replace(/\,$/,"")),r&&r!==l.doi||(r=void 0,o+=1,l._id=l.doi.replace(/\//g,"_"),e.push(l),3e4===e.length&&(console.log("OADOI bulk loading",e.length,o),await this.src.oadoi(e),e=[],await fs.writeFile(s,l.doi)))}catch(e){}}return e.length&&await this.src.oadoi(e),console.log(o),o},r.src.oadoi.load._bg=!0,r.src.oadoi.load._async=!0,r.src.oadoi.load._auth="root",r.src.oadoi.changes=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y;if(3e4,g=this.S.directory+"/oadoi/upto",this.S.directory+"/oadoi/errors",null==e&&(e=this.params.changes),!e)try{e=parseInt((await fs.readFile(g)).toString())}catch(e){}if(!e)try{a=await this.src.oadoi("*",{size:1,sort:{updated:{order:"desc"}}}),e=new Date(a.updated).valueOf()}catch(e){}if(e){for(i=0,s=0,m=!1,r=0,n=(d=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;r<n;r++){if(h=d[r],c=new Date(h.last_modified).valueOf(),console.log(h.last_modified,c,e,null!=a?a.updated:void 0),"jsonl"===h.filetype&&(!e||c>e)){for await(u of(console.log("OADOI importing changes for",h.last_modified),s+=1,t=[],l=0,o=this.S.directory+"/oadoi/"+h.date+".jsonl.gz",f=await fetch(h.url),y=fs.createWriteStream(o),await new Promise((e,t)=>(f.body.pipe(y),f.body.on("error",t),y.on("finish",e))),readline.createInterface({input:fs.createReadStream(o).pipe(zlib.createGunzip())})))m=c,l+=1,(p=JSON.parse(u.trim().replace(/\,$/,"")))._id=p.doi.replace(/\//g,"_"),t.push(p),i+=1,t.length>=3e4&&(console.log("OADOI bulk loading changes",s,t.length,l),await this.src.oadoi(t),t=[]);t.length&&await this.src.oadoi(t),fs.unlink(o)}if(m)try{await fs.writeFile(g,m)}catch(e){}}return console.log(s,i),i}console.log("Timestamp day to work since is required - run load first to auto-generate")},r.src.oadoi.changes._bg=!0,r.src.oadoi.changes._async=!0,r.src.oadoi.changes._auth="root",r.src.oadoi.changes._notify=!1,r.src.oadoi.local=async function(){var e,t,i,s,r;if(5e4,t=0,this.params.local&&10===this.params.local.length&&3===this.params.local.split("-").length&&!this.params.local.includes("/")){for await(s of(i=this.S.directory+"/oadoi/"+this.params.local+".jsonl",e=[],readline.createInterface({input:fs.createReadStream(i)})))t+=1,(r=JSON.parse(s.trim().replace(/\,$/,"")))._id=r.doi.replace(/\//g,"_"),e.push(r),e.length>=5e4&&(await this.src.oadoi(e),e=[]);e.length&&await this.src.oadoi(e)}return console.log(t),t},r.src.oadoi.local._bg=!0,r.src.oadoi.local._auth="root";h=[].indexOf;r.src.openalex=function(){return!0},r.src.openalex.authors={_index:{settings:{number_of_shards:9}},_prefix:!1},r.src.openalex.works={_index:{settings:{number_of_shards:9}},_prefix:!1},r.src.openalex.institutions={_index:!0,_prefix:!1},r.src.openalex.concepts={_index:!0,_prefix:!1},r.src.openalex.venues={_index:!0,_prefix:!1},r.src.openalex.works.doi=async function(e){var t,i,s,r,a,l;if(null==e&&(e=this.params.doi),!(i=await this.src.openalex.works('ids.doi:"https://doi.org/'+e+'"',1))&&(i=await this.fetch("https://api.openalex.org/works/https://doi.org/"+e))){if(null!=i.abstract_inverted_index){for(l in t=[],i.abstract_inverted_index)for(s=0,r=(a=i.abstract_inverted_index[l]).length;s<r;s++)t[a[s]]=l;t.length&&(i.abstract=t.join(" ")),delete i.abstract_inverted_index}this.waitUntil(this.src.openalex.works(e.toLowerCase(),i))}return i},r.src.openalex.load=async function(e,t,i,s,r){var a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E;if(null==e&&(e=null!=(S=this.params.load)?S:this.params.openalex),"works"!==e&&"venues"!==e&&"authors"!==e&&"institutions"!==e&&"concepts"!==e)return!1;if(null==i&&(i=null!=(A=this.params.clear)&&A),null==s&&(s=null!=(I=this.params.sync)&&I),!0===i&&(await this.src.openalex[e](""),await this.sleep(3e5)),c=null!=(j=this.params.howmany)?j:-1,3e4,T=0,f=this.S.directory+"/openalex/openalex-snapshot/data/"+e,"string"==typeof t)t=[t];else if(!0===t){console.log("Checking for Openalex changes in",e),t=[];try{k=JSON.parse((await fs.readFile(f+"/manifest")).toString()),r=await this.epoch(k.entries[k.entries.length-1].url.split("=")[1].split("/")[0])}catch(e){r=0}for(s?(R=await this._child("aws",["s3","sync","s3://openalex",this.S.directory+"/openalex/openalex-snapshot","--no-sign-request"]),console.log("Openalex sync returned",R)):(await fs.writeFile(f+"/manifest",await this.fetch("https://openalex.s3.amazonaws.com/data/"+e+"/manifest",{buffer:!0})),console.log("Openalex manifest updated")),u=!1,p=0,v=(D=(k=JSON.parse((await fs.readFile(f+"/manifest")).toString())).entries).length;p<v;p++)n=D[p].url.split("=")[1].split("/")[0],u||await this.epoch(n)>r&&(u=!0),u&&h.call(t,n)<0&&t.push(n);t.length&&console.log("Found changes",t)}if(!s&&t&&t.length)for(m=0,w=t.length;m<w;m++){l=t[m],console.log("Openalex syncing files",e,l);try{await fs.stat(f+"/updated_date="+l)}catch(t){await this._child("aws",["s3","sync","s3://openalex/data/"+e+"/updated_date="+l,f+"/updated_date="+l,"--no-sign-request"])}}for(o=0,O=0,P=0,3,y=[],g=0,b=(C=await fs.readdir(f)).length;g<b;g++)if(!(E=C[g]).startsWith("manifest")&&(!t||0===t.length||(L=E.split("=")[1],h.call(t,L)>=0))){for(a=async t=>{var i,s,r,a,l,n,o,u,p,d,m,g,_,v,w,b,x,k,S;for await(u of(s=[],readline.createInterface({input:fs.createReadStream(f+"/"+E+"/"+t).pipe(zlib.createGunzip())}))){if(T===c)break;if(m=JSON.parse(u.trim().replace(/\,$/,"")),T+=1,"venues"===e||"institutions"===e||"concepts"===e||"authors"===e){if(m._id=m.id.split("/").pop(),"authors"===e&&null!=m.x_concepts)for(a=0,l=(b=m.x_concepts).length;a<l;a++)null!=(S=b[a]).score&&(S.score=Math.floor(S.score))}else if("works"===e){try{for(x=m.concepts,p=0,n=x.length;p<n;p++)null!=(S=x[p]).score&&(S.score=Math.floor(S.score))}catch(e){}try{m._id=null!=(g=null!=(_=m.doi)?_:m.DOI)?g:null!=(v=m.ids)?v.doi:void 0,m._id.includes("http")&&m._id.includes("/10.")&&(m._id="10."+m._id.split("/10.").pop()),m._id&&m._id.startsWith("10.")||(m._id=m.id.split("/").pop())}catch(e){m._id=m.id.split("/").pop()}try{for(k in i=[],m.abstract_inverted_index)for(w=m.abstract_inverted_index[k],d=0,o=w.length;d<o;d++)i[w[d]]=k;i.length&&(m.abstract=i.join(" "))}catch(e){}try{delete m.abstract_inverted_index}catch(e){}}try{for(r in await this.flatten(m))h.call(y,r)<0&&(y.push(r),console.log("openalex seeing new key",y.length,r))}catch(e){}s.push(m),s.length>=3e4&&(console.log("Openalex "+e+" bulk loading",E,t,s.length,T),await this.src.openalex[e](s),s=[])}return s.length&&await this.src.openalex[e](s),console.log("removing",f+"/"+E+"/"+t),await fs.unlink(f+"/"+E+"/"+t),O+=1,P-=1,!0},_=0,x=(N=await fs.readdir(f+"/"+E)).length;_<x;_++){for(d=N[_],console.log("Openalex load running",P),o+=1;3===P;)await this.sleep(5e3),console.log("Openalex load running",P);P+=1,a(d)}for(;0!==P;)await this.sleep(5e3);await fs.rmdir(f+"/"+E)}return console.log(o,O,T),{expected:o,processed:O,total:T}},r.src.openalex.load._bg=!0,r.src.openalex.load._async=!0,r.src.openalex.load._auth="root",r.src.openalex.changes=async function(e,t){var i,s,r,a,l,n,o;if(null==e&&(e=null!=(r=this.params.changes)?r:this.params.openalex),null==t&&(t=this.params.last),o=["works","venues","authors","institutions","concepts"],e){if(h.call(o,e)<0)return!1}else e=o;for(l=0,i=0,s=(a=Array.isArray(e)?e:[e]).length;i<s;i++)n=a[i],l+=await this.src.openalex.load(n,!0,void 0,void 0,t);return l},r.src.openalex.changes._bg=!0,r.src.openalex.changes._async=!0,r.src.openalex.changes._auth="root",r.src.openalex.latest=async function(e){var t,i,s,r,a,l,n,o,u,c,p;if(null==e&&(e=null!=(o=this.params.latest)?o:this.params.openalex),p=["works","venues","authors","institutions","concepts"],h.call(p,e)<0)return!1;for(a=this.S.directory+"/openalex/openalex-snapshot/data/"+e,(c={last:void 0,changes:[],count:0,manifest:{previous:JSON.parse((await fs.readFile(a+"/manifest")).toString()),latest:await this.fetch("https://openalex.s3.amazonaws.com/data/"+e+"/manifest")}}).last=c.manifest.previous.entries[c.manifest.previous.entries.length-1].url.split("=")[1].split("/")[0],l=await this.epoch(c.last),s=!1,r=0,n=(u=c.manifest.latest.entries).length;r<n;r++)t=(i=u[r]).url.split("=")[1].split("/")[0],s||await this.epoch(t)>l&&(s=!0),s&&(h.call(c.changes,t)<0&&c.changes.push(t),c.count+=i.meta.record_count);return c};h=[].indexOf;r.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},r.src.pubmed.doi=async function(e){var t;if(null==e&&(e=this.params.doi),e&&(t=await this.src.pubmed('identifier.doi:"'+e+'"',1)))return t},r.src.pubmed.pmc=async function(e){var t;if(null==e&&(e=this.params.pmc),e&&(t=await this.src.pubmed('identifier.pmc:"PMC'+e.toString().toLowerCase().replace("pmc","")+'"',1)))return t},r.src.pubmed.entrez={},r.src.pubmed.entrez.summary=async function(e,t,i){var s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w;w="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),w+="&id="+i):w+="&query_key="+e+"&WebEnv="+t;try{for(y=await this.fetch(w),h=await this.convert.xml2json(y),d=[],f=h.eSummaryResult.DocSum,r=0,o=f.length;r<o;r++){for(s={id:(p=f[r]).Id[0]},m=p.Item,l=0,u=m.length;l<u;l++)if("List"===(a=m[l]).$.Type){if(s[a.$.Name]=[],null!=a.Item)for(g=a.Item,n=0,c=g.length;n<c;n++)_=g[n],(v={})[_.$.Name]=_._,s[a.$.Name].push(v)}else s[a.$.Name]=a._;if(d.push(s),null==i||-1===i.indexOf(","))return d[0]}return d}catch(e){}},r.src.pubmed.entrez.pmid=async function(e){var t,i,s;null==e&&(e=this.params.pmid),s="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return t=await this.fetch(s),i=await this.convert.xml2json(t),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey[0],i.ePostResult.WebEnv[0])}catch(e){}},r.src.pubmed.search=async function(e,t,i=10,s=!1){var r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x;null==e&&(e=null!=(m=this.params.search)?m:this.params.q),b="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof s&&(s=s.split(",")),Array.isArray(s))_={total:s.length,data:[]};else{if(_=await this.fetch(b),_={total:(v=await this.convert.xml2json(_)).eSearchResult.Count[0],data:[]},!0===s)return _.data=v.eSearchResult.IdList[0].Id,_;s=v.eSearchResult.IdList[0].Id}if(t)for(r=0,o=s.length;r<o&&(w=s[r],d=await this.src.pubmed.pmid(w),_.data.push(d),_.data.length!==i);r++);else{for(x=[],l=0,u=s.length;l<u&&(a=s[l],_.data.length!==i);l++)if(x.push(a),40===x.length){for(g=await this.src.pubmed.entrez.summary(void 0,void 0,x),n=0,c=g.length;n<c&&(f=g[n],_.data.push(await this.src.pubmed.format(f)),_.data.length!==i);n++);x=[]}if(x.length)for(y=await this.src.pubmed.entrez.summary(void 0,void 0,x),p=0,h=y.length;p<h&&(f=y[p],_.data.push(await this.src.pubmed.format(f)),_.data.length!==i);p++);}return _}catch(e){}},r.src.pubmed.pmid=async function(e){var t,i;null==e&&(e=this.params.pmid);try{if(i="https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml",(t=await this.fetch(i)).startsWith("<"))return this.src.pubmed.format(await this.decode(t.split("<pre>")[1].split("</pre>")[0].replace("\n","")))}catch(e){}try{return this.src.pubmed.format(await this.src.pubmed.entrez.pmid(e))}catch(e){}},r.src.pubmed.aheadofprint=async function(e){null==e&&(e=this.params.pmid);try{return-1!==(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).indexOf("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){}},r.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},r.src.pubmed.availability=async function(e){var t,i,s,r,a;return null==e&&(e=null!=(t=null!=(i=null!=(s=null!=(r=null!=(a=this.params.pubmed)?a:this.params.availability)?r:this.params.pmc)?s:this.params.pmcid)?i:this.params.PMC)?t:this.params.PMCID),e="pmc"+(e+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(e)},r.src.pubmed.format=async function(e,t={}){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J;if("string"==typeof e&&0===e.indexOf("<")&&(e=await this.convert.xml2json(e)),null!=(null!=(D=e.eSummaryResult)?D.DocSum:void 0)||e.ArticleIds){if(l={},null!=(null!=(N=e.eSummaryResult)?N.DocSum:void 0))for(n=0,h=(P=(e=md.eSummaryResult.DocSum[0]).Item).length;n<h;n++)if("List"===(o=P[n]).$.Type){if(l[o.$.Name]=[],null!=o.Item)for(u=0,p=(R=o.Item).length;u<p;u++)(J={})[(z=R[u]).$.Name]=z._,l[o.$.Name].push(J)}else l[o.$.Name]=o._;else l=e;try{null==t.pmid&&(t.pmid=e.Id[0])}catch(e){}try{null==t.pmid&&(t.pmid=e.id)}catch(e){}try{null==t.title&&(t.title=l.Title)}catch(e){}try{null==t.issn&&(t.issn=l.ISSN)}catch(e){}try{null==t.essn&&(t.essn=l.ESSN)}catch(e){}try{null==t.doi&&(t.doi=l.DOI)}catch(e){}try{null==t.journal&&(t.journal=l.FullJournalName)}catch(e){}try{null==t.journal_short&&(t.journal_short=l.Source)}catch(e){}try{null==t.volume&&(t.volume=l.Volume)}catch(e){}try{null==t.issue&&(t.issue=l.Issue)}catch(e){}try{null==t.page&&(t.page=l.Pages)}catch(e){}try{null==t.year&&(t.year=l[l.PubDate?"PubDate":"EPubDate"].split(" ")[0])}catch(e){}try{k=l[l.PubDate?"PubDate":"EPubDate"].split(" "),null==t.published&&(t.published=k[0]+"-"+(["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(k[1].toLowerCase())+1)+"-"+(3===k.length?k[2]:"01"))}catch(e){}if(null!=l.AuthorList)for(null==t.author&&(t.author=[]),c=0,d=(T=l.AuthorList).length;c<d;c++){i=T[c];try{i.family=i.Author.split(" ")[0],i.given=i.Author.replace(i.family+" ",""),i.name=i.given+" "+i.family,t.author.push(i)}catch(e){}}if(null!=l.ArticleIds&&null==t.pmcid)for(v=0,f=(E=l.ArticleIds).length;v<f;v++)if((s=E[v]).pmc){null==t.pmcid&&(t.pmcid=s.pmc);break}}else if(null!=e.PubmedArticle){w=(e=e.PubmedArticle).MedlineCitation[0];try{null==t.pmid&&(t.pmid=w.PMID[0]._)}catch(e){}try{null==t.title&&(t.title=w.Article[0].ArticleTitle[0])}catch(e){}try{null==t.issn&&(t.issn=w.Article[0].Journal[0].ISSN[0]._)}catch(e){}try{null==t.journal&&(t.journal=w.Article[0].Journal[0].Title[0])}catch(e){}try{null==t.journal_short&&(t.journal_short=w.Article[0].Journal[0].ISOAbbreviation[0])}catch(e){}try{O=w.Article[0].Journal[0].JournalIssue[0].PubDate[0];try{null==t.year&&(t.year=O.Year[0])}catch(e){}try{null==t.published&&(t.published=O.Year[0]+"-"+(O.Month?["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(O.Month[0].toLowerCase())+1:"01")+"-"+(O.Day?O.Day[0]:"01"))}catch(e){}}catch(e){}try{for(null==t.author&&(t.author=[]),q=w.Article[0].AuthorList[0].Author,b=0,m=q.length;b<m;b++){a=q[b],(i={}).family=a.LastName[0],i.given=a.ForeName[0],i.name=(i.given?i.given+" ":"")+(null!=(M=i.family)?M:"");try{i.affiliation=a.AffiliationInfo[0].Affiliation[0]}catch(e){}null!=i.affiliation&&(Array.isArray(i.affiliation)&&(i.affiliation=i.affiliation[0]),"string"==typeof i.affiliation&&(i.affiliation={name:i.affiliation})),t.author.push(i)}}catch(e){}try{for(W=e.PubmedData[0].ArticleIdList[0].ArticleId,x=0,g=W.length;x<g;x++)if("doi"===(S=W[x]).$.IdType){null==t.doi&&(t.doi=S._);break}}catch(e){}try{for(null==t.reference&&(t.reference=[]),C=e.PubmedData[0].ReferenceList[0].Reference,A=0,y=C.length;A<y;A++){j=C[A].Citation[0],U={},-1!==j.indexOf("doi.org/")&&(U.doi=j.split("doi.org/")[1].trim());try{for(U.author=[],L=j.split(". ")[0].split(", "),I=0,_=L.length;I<_;I++)r=L[I],U.author.push({name:r})}catch(e){}try{U.title=j.split(". ")[1].split("?")[0].trim()}catch(e){}try{U.journal=j.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{U.url="http"+j.split("http")[1].split(" ")[0],-1!==U.url.indexOf("doi.org")&&delete U.url}catch(e){}"{}"!==JSON.stringify(U)&&t.reference.push(U)}}catch(e){}}try{null==t.pdf&&(t.pdf=e.pdf)}catch(e){}try{null==t.url&&(t.url=e.url)}catch(e){}return t},r.src.pubmed.load=async function(e){var t,i,s,r,a,l,n,o,u,c,p;for(-1,1,a=null!=(o=this.params.howmany)?o:-1,this.refresh&&!e&&await this.src.pubmed(""),i=e?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",r=[],l=0,n=(u=(await this.fetch(i)).split('href="')).length;l<n;l++)(s=u[l].split('"')[0]).startsWith("pubmed")&&s.endsWith(".gz")&&(this.refresh&&!e||!await this.src.pubmed.count('srcfile:"'+i+s+'"'))&&r.push(i+s);for(c=0,p=0,t=async t=>{var i,s,l,n,o,u,d,f,m,g,y,_,v,w,b;for await(m of(console.log("Pubmed loading"+(e?" changes":""),t,r.length,c),n=[],_={},y=!1,u=!1,readline.createInterface({input:(await fetch(t)).body.pipe(zlib.createGunzip())})))if("</PubmedArticle>"===(m=m.trim().replace("&amp;","&"))){if(p+=1,!1!==y&&y.year&&(_.year=parseInt(y.year),y.month&&y.month.length>2&&(y.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(y.month.toLowerCase().substr(0,3))),"number"==typeof y.month&&(y.month=y.month.toString()),y.month&&1===y.month.length&&(y.month="0"+y.month),"number"==typeof y.day&&(y.day=y.day.toString()),y.day&&1===y.day.length&&(y.day="0"+y.day),_.published=y.year+"-"+(null!=(v=y.month)?v:"01")+"-"+(null!=(w=y.day)?w:"01"),_.publishedAt=await this.epoch(_.published)),_.srcfile=t,_._id=_.PMID,n.push(_),_={},y=!1,u=!1,p===a)break}else{for(d in f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(m.includes(d)||m.includes(d.replace(">"," ")))&&null==_[g=f[d]]&&(_[g]=m.split(">")[1].split("</")[0]);m.includes("<MedlinePgn>")&&(_.pages=m.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ")),(m.includes("<ISSN>")||m.includes("<ISSN ")||m.includes("<ISSNLinking>"))&&(null==_.ISSN&&(_.ISSN=[]),b=m.split(">")[1].split("</")[0],h.call(_.ISSN,b)<0&&_.ISSN.push(b)),m.includes("<Keyword>")&&(null==_.keyword&&(_.keyword=[]),b=m.split(">")[1].split("</")[0],h.call(_.keyword,b)<0&&_.keyword.push(b)),m.includes("<GeneSymbol>")&&(null==_.gene&&(_.gene=[]),b=m.split(">")[1].split("</")[0],h.call(_.gene,b)<0&&_.gene.push(b)),(m.includes("<PublicationType>")||m.includes("<PublicationType "))&&(null==_.type&&(_.type=[]),b=m.split(">")[1].split("</")[0],h.call(_.type,b)<0&&_.type.push(b)),m.includes("<Chemical>")&&(null==_.chemical&&(_.chemical=[]),_.chemical.push({})),(m.includes("<NameOfSubstance>")||m.includes("<NameOfSubstance "))&&(_.chemical[_.chemical.length-1].name=m.split(">")[1].split("</")[0],_.chemical[_.chemical.length-1].nameID=m.split('UI="')[1].split('"')[0]),m.includes("<RegistryNumber>")&&(_.chemical[_.chemical.length-1].registry=m.split(">")[1].split("</")[0]),(m.includes("<DataBank>")||m.includes("<DataBank "))&&(null==_.databank&&(_.databank=[]),_.databank.push({})),m.includes("<DataBankName>")&&(_.databank[_.databank.length-1].name=m.split(">")[1].split("</")[0]),m.includes("<AccessionNumber>")&&(null==(i=_.databank[_.databank.length-1]).accession&&(i.accession=[]),_.databank[_.databank.length-1].accession.push(m.split(">")[1].split("</")[0])),(m.includes("<Grant>")||m.includes("<Grant "))&&(null==_.grant&&(_.grant=[]),_.grant.push({})),m.includes("<GrantID>")&&(_.grant[_.grant.length-1].id=m.split(">")[1].split("</")[0]),m.includes("<Acronym>")&&(_.grant[_.grant.length-1].acronym=m.split(">")[1].split("</")[0]),m.includes("<Agency>")&&(_.grant[_.grant.length-1].agency=m.split(">")[1].split("</")[0]),m.includes("<Country>")&&(_.grant&&!_.grant[_.grant.length-1].country||_.country?_.grant[_.grant.length-1].country=m.split(">")[1].split("</")[0]:_.country=m.split(">")[1].split("</")[0]),(m.includes("<MeshHeading>")||m.includes("<MeshHeading "))&&(null==_.mesh&&(_.mesh=[]),_.mesh.push({})),(m.includes("<DescriptorName>")||m.includes("<DescriptorName "))&&(_.mesh[_.mesh.length-1].description=m.split(">")[1].split("</")[0],_.mesh[_.mesh.length-1].descriptionID=m.split('UI="')[1].split('"')[0]),(m.includes("<QualifierName>")||m.includes("<QualifierName "))&&(null==(s=_.mesh[_.mesh.length-1]).qualifier&&(s.qualifier=[]),_.mesh[_.mesh.length-1].qualifier.push({name:m.split(">")[1].split("</")[0],id:m.split('UI="')[1].split('"')[0]})),(m.includes("<Investigator>")||m.includes("<Investigator "))&&(null==_.author&&(_.author=[]),_.author.push({}),u=!0),(m.includes("<Author>")||m.includes("<Author "))&&(null==_.author&&(_.author=[]),_.author.push({}),u=!1);try{m.includes("<LastName>")&&(_.author[_.author.length-1].lastname=m.split(">")[1].split("</")[0],u&&(_.author[_.author.length-1].investigator=!0)),m.includes("<ForeName>")&&(_.author[_.author.length-1].firstname=m.split(">")[1].split("</")[0]),m.includes("<Affiliation>")&&(_.author[_.author.length-1].affiliation=m.split(">")[1].split("</")[0]),m.includes("<Identifier>")&&(_.author[_.author.length-1].identifier=m.split(">")[1].split("</")[0])}catch(e){}if(m.includes("<Note>")||m.includes("<Note ")||m.includes("<GeneralNote>")||m.includes("<GeneralNote "))try{null==_.notes&&(_.notes=[]),_.notes.push(m.split(">")[1].split("</")[0])}catch(e){}(m.includes("<DeleteCitation>")||m.includes("<DeleteCitation "))&&(_.deletedFromMedline=!0),(m.includes("<ArticleId>")||m.includes("<ArticleId "))&&(null==_.identifier&&(_.identifier={}),o=m.split('IdType="')[1].split('"')[0],null==(l=_.identifier)[o]&&(l[o]=m.split(">")[1].split("</")[0])),(m.includes("<ArticleDate>")||m.includes("ArticleDate ")||m.includes("<PubDate>")||m.includes("<PubDate "))&&(y={}),!1!==y&&(m.includes("<Year>")||m.includes("<Month>")||m.includes("<Day>"))&&(y[m.split(">")[0].replace("<","").toLowerCase()]=m.split(">")[1].split("</")[0])}return n.length&&(await this.src.pubmed(n),n=[],console.log(t,p)),c-=1};r.length&&!(a>0&&p>=a);)await this.sleep(1e3),c<1&&(c+=1,t(r.shift()));return console.log(p),p},r.src.pubmed.load._bg=!0,r.src.pubmed.load._async=!0,r.src.pubmed.load._auth="root",r.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},r.src.pubmed.changes._bg=!0,r.src.pubmed.changes._async=!0,r.src.pubmed.changes._auth="root",r.src.pubmed.changes._notify=!1,r.src.ror=async function(e){if(null==e&&(e=this.params.ror),"string"==typeof e&&!e.includes(" ")&&(e=e.split("/").pop()).length<11)return this.src.ror._format(await this.fetch("https://api.ror.org/organizations/"+e))},r.src.ror._index=!0,r.src.ror._prefix=!1,r.src.ror.query=function(e){var t;if(null==e&&(e=null!=(t=this.params.query)?t:this.params.q),"string"==typeof e)return this.fetch('https://api.ror.org/organizations?query="'+e+'"')},r.src.ror.grid=async function(e){var t,i,s,r;if(null==e&&(e=this.params.grid),"string"==typeof e&&e.startsWith("grid.")){if((null!=(s=await this.src.ror('external_ids.GRID.all:"'+e+'"'))?s.id:void 0)||1===(null!=s&&null!=(t=s.hits)?t.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(e))&&null!=(i=s.items)?i[0]:void 0)return r=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(r)),r}},r.src.ror.title=async function(e){var t,i,s,r,a;if(null==e&&(e=null!=(t=this.params.title)?t:this.params.q),"string"==typeof e){if(this.refresh||(r=await this.src.ror('title:"'+e+'"')),(null!=r?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(e))&&null!=(s=r.items)?s[0]:void 0)return a=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(a)),a}},r.src.ror._format=function(e){try{e._id=e.id.split("/").pop()}catch(e){}return e},r.src.ror.dumps=function(){return this.fetch("https://zenodo.org/api/records/?communities=ror-data&sort=mostrecent")},r.src.ror.load=async function(){var e,t,i,s,r,a,l,n,o,u,c,h;h=0,e=[];try{s=await this.src.ror.dumps(),l=await this.epoch(s.hits.hits[0].files[0].created)}catch(e){}if(null!=(null!=(a=await this.src.ror("src:*",{sort:{createdAt:"desc"},size:1}))?a.hits:void 0)&&(a=a.hits.hits[0]._source),console.log(l,null!=a?a.createdAt:void 0,null!=a?a.src:void 0),null!=a&&a.createdAt<l)for await(n of(r=s.hits.hits[0].files[0].links.self,console.log(r),t=await this.epoch(),c=!1,i=!1,o="",await this.src.ror(""),readline.createInterface({input:(await fetch(r)).body.pipe(zlib.createGunzip())})))try{c||5!==n.length||"{"!==n.replace(/\s\s\s\s/,"")?i||5!==n.replace(",","").length||"}"!==n.replace(/\s\s\s\s/,"").replace(",","")?"["!==n&&"]"!==n&&(o+=n):(i=!0,o+="}"):(c=!0,o="{"),!0===c&&!0===i&&(c=!1,i=!1,(u=await this.src.ror._format(JSON.parse(o))).src=r,u.createdAt=t,o="",h+=1,e.push(u),2e4===e.length&&(console.log("ROR bulk loading",e.length,h),await this.src.ror(e),e=[]))}catch(e){}return e.length&&await this.src.ror(e),console.log(h),h},r.src.ror.load._bg=!0,r.src.ror.load._async=!0,r.src.ror.load._auth="root",null==(p=a.src).zenodo&&(p.zenodo={});try{a.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(e){}r.src.zenodo={deposition:{},records:{}},r.src.zenodo.records.search=function(e,t){var i,s,r;return null==e&&(e=this.params),null==t&&(t=this.params.dev),s=null!=(i=this.params.size)?i:10,r="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+s+"&q="+encodeURIComponent(e),this.fetch(r)},r.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},r.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){}},r.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},r.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},r.src.zenodo.records.format=function(e){var t,i,s,r,a,l,n,o,u,c,h;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=e.metadata.description}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,r=0,l=c.length;r<l;r++)if("pdf"===(s=c[r]).type){null==o.pdf&&(o.pdf=s.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),h=e.metadata.creators,a=0,n=h.length;a<n;a++){if("string"==typeof(t=h[a])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},r.src.zenodo.deposition.create=async function(e,t,i,s){var r,a,l,n,o,u,c,h,p;return null==s&&(s=null!=(l=this.params.dev)?l:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=s?null!=(n=this.S.src)&&null!=(o=n.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(p="https://"+(s?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(a={metadata:e}).metadata.upload_type||(a.metadata.upload_type="publication",a.metadata.publication_type="article"),null==(r=a.metadata).creators&&(r.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(h=await this.fetch(p,{method:"POST",body:a}))?h.id:void 0)&&(t.content||t.file)&&(h.uploaded=await this.src.zenodo.deposition.upload(h.id,t.content,t.file,t.name,t.url,i,s)),t.publish&&(h.published=await this.src.zenodo.deposition.publish(h.id,i,s)),h):await this.fetch(p,{method:"POST",body:a}))},r.src.zenodo.deposition.upload=async function(e,t,i,s,r,a,l){var n,o,u,c;if(null==e&&(e=null!=(n=this.params.upload)?n:this.params.id),null==t&&(t=this.params.content),null==s&&(s=this.params.filename),!t&&!i)try{i=this.request.files[0]}catch(e){}if(r&&!t&&!i)try{t=await this.fetch(r,{buffer:!0})}catch(e){}return null==a&&(a=this.params.token),null==a&&(a=this.S.dev||l?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==l&&(l=this.params.dev),null!=a&&null!=e&&(r="https://"+(this.S.dev||l?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+a,this.fetch(r,{file:null!=t?t:i,filename:s}))},r.src.zenodo.deposition.publish=function(e,t,i){var s,r,a,l,n;return null==e&&(e=null!=(s=this.params.publish)?s:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(r=this.S.src.zenodo)?r.sandbox:void 0:null!=(a=this.S.src)&&null!=(l=a.zenodo)?l.token:void 0),null!=t&&null!=e&&(n="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(n,{method:"POST"}))},r.src.zenodo.deposition.delete=async function(e,t,i){var s,r,a,l;return null==e&&(e=null!=(s=this.params.publish)?s:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(r=this.S.src.zenodo)?r.sandbox:void 0:null!=(a=this.S.src.zenodo)?a.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(l,{method:"DELETE"}),!0)},r.blacklist=async function(e){var t,i,s,r,a,l,n,o;if(null==e&&(e=this.params.url),"number"==typeof e&&(e=e.toString()),null!=e&&(e.length<4||-1===e.indexOf(".")))return!1;for(i=[],r=0,l=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;r<l;r++)s=o[r],i.push(s.url.toLowerCase());if(e){if(!e.startsWith("http")&&e.includes(" "))return!1;for(a=0,n=i.length;a<n;a++)if(t=i[a],e.includes(t.toLowerCase()))return!0;return!1}return i},r.bug=function(){var e,t,i,s,r,a,l,n,o,u,c;if(this.params.contact)return"";for(e in c=["help@oa.works"],u="",this.params)u+=e+": "+JSON.stringify(this.params[e],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(s=this.params)?s.form:void 0)?o+=" Wrong article":"bug"===(null!=(r=this.params)?r.form:void 0)?o+=" Bug":"general"===(null!=(a=this.params)?a.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(l=null!=(n=this.params)?n.form:void 0)&&"uninstall"!==l||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:t=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:t}},r.cache=async function(e,t,i){var s,r,a,l,n,o,u,c,h,p;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==e&&(e=this.request);try{for(p=e.url.toString(),n=0,o=(u=["refresh"]).length;n<o;n++)a=u[n],-1!==p.indexOf(a+"=")&&(l=new RegExp(a+"=.*?&"),p=p.replace(l,"")),-1!==p.indexOf("&"+a+"=")&&(p=p.split("&"+a+"=")[0]);r=new URL(p)}catch(e){}}catch(e){}if(null!=e)try{if(null==r&&(r=new URL(e.url)),s=new Request(r.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t)return h=await caches.default.match(s),""===t&&this.waitUntil(caches.default.delete(s)),h;t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(s,c))}catch(e){}}},r.cache._auth="system";h=[].indexOf;null==r.convert&&(r.convert={}),r.convert.json2csv=async function(e,t){var i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b,x,k,O;if(null==e&&(e=null!=(g=this.body)?g:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(y=e.hits)?y.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),p=null!=(_=t.quote)?_:'"',O=null!=(v=t.separator)?v:",",u=null!=(w=t.newline)?w:"\n",e.length){for(s=null!=(b=t.keys)?b:[],m="",r=0,n=e.length;r<n;r++){if(f=e[r],m.length&&(m+=u),!1!==t.es&&(f._source||f.fields)){for(c in d={},k=null!=(x=f._source)?x:f.fields)null==d[c]&&(d[c]=k[c]);f=d}if(t.flatten&&(f=await this.flatten(f)),t.subset&&(f=await this.dot(f,t.subset)),!t.keys)for(l in f)null!=f[l]&&h.call(s,l)<0&&s.push(l);for(a=0,o=s.length;a<o;a++){if(i=s[a],m.length&&!m.endsWith(u)&&(m+=O),m+=p,null!=f[i]){try{Array.isArray(f[i])&&1===f[i].length&&Array.isArray(f[i][0])&&(f[i]=f[i][0])}catch(e){}try{Array.isArray(f[i])&&f[i].length&&"object"!=typeof f[i][0]&&(f[i]=f[i].join(","))}catch(e){}try{"object"==typeof f[i]&&(f[i]=JSON.stringify(f[i]))}catch(e){}try{'"'===p&&-1!==f[i].indexOf(p)&&(f[i]=f[i].replace(/"/g,p+p))}catch(e){}try{f[i]=f[i].replace(/\n/g," ")}catch(e){}try{f[i]=f[i].replace(/\s\s/g," ")}catch(e){}try{m+=f[i]}catch(e){}}m+=p}}return p+s.join(p+O+p)+p+"\n"+m}return""},r.convert.csv2json=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b;if(null==t&&(t=this.params),null==e&&(e=null!=(d=this.body)?d:this.params.csv),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(f=t.url)?f:e)),_=[],"string"==typeof e&&e.length&&(p=null!=(m=t.quote)?m:'"',w=null!=(g=t.separator)?g:",",c=null!=(y=t.newline)?y:"\n",(u=e.split(c)).length))for(s=u.shift().split(p+w),h="",r=0,l=u.length;r<l;r++)if((b=(h+=(h?c:"")+(o=u[r])).split(p+w)).length===s.length&&(!p||o.endsWith(p))){for(h="",v={},a=0,n=s.length;a<n;a++)if((i=s[a]).startsWith(p)&&(i=i.replace(p,"")),i.endsWith(p)&&(i=i.substring(0,i.length-1)),b.length&&(v[i]=b.shift(),v[i])){v[i].startsWith(p)&&(v[i]=v[i].replace(p,"")),!b.length&&v[i].endsWith(p)&&(v[i]=v[i].substring(0,v[i].length-1));try{v[i]=JSON.parse(v[i])}catch(e){}}_.push(v)}return _},r.convert.csv2html=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y;if(null==e&&(e=null!=(h=this.body)?h:this.params.csv),null==t&&(t=this.params),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(p=t.url)?p:e)),'"',",","\n",m="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",m+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(o=e.split("\n")).length){for(m+="<thead><tr>",u=0,i=0,r=(d=o.shift().split('","')).length;i<r;i++)m+='<th style="padding:2px; border:1px solid #ccc;">'+d[i].replace(/"/g,"")+"</th>",u+=1;for(m+="</tr></thead>\n<tbody>\n",s=0,a=o.length;s<a;s++){for(n=o[s],m+="<tr>";-1!==n.indexOf(',"",');)n=n.replace(',"",',',"XXX_EMPTY_XXX",');for(;n.startsWith('"",');)n=n.replace('"",','"XXX_EMPTY_XXX",');for(;n.endsWith(',""');)n=n.slice(0,n.length-3);for(y=0,c=0,l=(f=(n=n.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<l;c++)y+=1,m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(g=(g=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===g.indexOf("{")||0===g.indexOf("[")?(m+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",m+=await this.convert.json2html(JSON.parse(g.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),m+="</div>"):m+=g.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),m+="</td>";for(;y<u;)m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',y+=1;m+="</tr>\n"}m+="</tbody>\n"}return m+"</table>"},r.convert.json2html=async function(e,t){var i,s,r,a,l,n,o,u,c,p,d;if(null==e&&(e=null!=(u=this.body)?u:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.new)for(null==t.edit&&(t.edit=!0),e={},s=0,a=(c=await this.index.keys(this.route.replace(/\//g,"_"))).length;s<a;s++)e[c[s]]="";if(t.subset&&!Array.isArray(e))for(o=t.subset.split(".");(n=o.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[n];)e=e[n];if(Array.isArray(e)||null!=(null!=e&&null!=(p=e.hits)?p.hits:void 0)&&!1!==t.es)return null!=o&&(t.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(e,t));if(d="<div>",t.flatten&&(e=await this.flatten(e),d+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(o.length)for(r=0,l=o.length;r<l;r++)e=e[o[r]];d+="<h3>"+t.subset+":</h3>",d+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return(i=e=>{var s,r,a,l,n,o,u,c,p,f,m;if(t.edit&&null==e.comments&&(e.comments=""),t.keys)for(l=0,r=(c=t.keys).length;l<r;l++)null==e[u=c[l]]&&(e[u]="");for(s in f=[],e){try{Array.isArray(e[s])&&1===e[s].length&&Array.isArray(e[s][0])&&(e[s]=e[s][0])}catch(e){}if(null==e[s]||Array.isArray(e[s])&&!e[s].length||t.keys&&!(h.call(t.keys,s)>=0))f.push(void 0);else{if(d+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+s+"</p></b></div>",d+='<div style="float:left;">',d+=t.edit?'<textarea class="PForm" id="'+s+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[s]))if("object"==typeof e[s][0])for(n=0,a=(p=e[s]).length;n<a;n++)o=p[n],i(o);else{try{m=e[s].join(", ")}catch(t){try{m=JSON.stringify(e[s])}catch(t){m=e[s]}}try{d+=(t.edit?"":"<p>")+m+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[s]?i(e[s]):d+=(t.edit?"":"<p>")+e[s]+(t.edit?"":"</p>");d+=t.edit?"</textarea>":"",f.push(d+="</div></div>")}}return f})(e),d+="</div>"},r.convert.json2txt=async function(e){var t,i,s;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),s=[],t=async function(e){var i,r,a,l,n;if(Array.isArray(e)){for(l=[],r=0,a=e.length;r<a;r++)i=e[r],l.push(await t(i));return l}if("object"==typeof e){for(i in n=[],e)n.push(await t(e[i]));return n}if(e)return s.push(e)},await t(e),s.join(" ")},r.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},r.convert.hex2bin=function(e){var t,i,s,a,l;for(l=[],t=0,s=(a=Array.isArray(e)?e:[e]).length;t<s;t++)i=a[t],l.push(r.convert._hexMatch[i.toLowerCase()]);return l.join("")},r.convert.bin2hex=function(e){var t,i,a,l,n,o,u,c,h;if(!Array.isArray(e)){for(t=[],h=e.split(""),u="";h.length;)4===(u+=h.shift()).length&&(t.push(u),u="");e=t}for(l in c=[],i={},r.convert._hexMatch)i[r.convert._hexMatch[l]]=l;for(a=0,o=e.length;a<o;a++)n=e[a],c.push("0x"+i[n]);return new s(c).toString()},r.convert.buf2bin=async function(e){var t,i;for(s.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),i="",t=0;t<e.length;)i+=await r.convert.hex2bin(e[t]),t++;return i},r.convert.stream2txt=function(e){var t;return t=[],new Promise((i,r)=>(e.on("data",e=>t.push(s.from(e))),e.on("error",e=>r(e)),e.on("end",()=>i(s.concat(t).toString("utf8")))))},r.convert.xml2json=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d,f,m,g;if(null==e&&(e=null!=(p=this.params.xml2json)?p:this.params.url),f={},"string"==typeof e)for(e.startsWith("http")&&(e=await this.fetch(e)),i="",u="",m=!1,s=!1;t=e[0];)if(e=e.slice(1),"\ufeff"!==t&&"\t"!==t&&"\r"!==t&&"\n"!==t&&(" "!==t||i.length&&!i.endsWith(">"))&&("<"===i&&"/"!==t&&"?"!==t&&"!"!==t&&(m=!0),((i+=t).endsWith("</")&&i.split("</").length-1===i.split(">").length||i.endsWith("/>")&&!i.split("/>")[0].includes(">"))&&(s=!0),">"===t)){if(console.log(u),s){if(s=!1,""!==(i=i.split("</")[0])){if(h=await this.dot(f,u,void 0,void 0,!0))Array.isArray(h)?(h.length||(h=[{}]),null!=h[h.length-1].$?(Array.isArray(h[h.length-1].$)||(h[h.length-1].$=[h[h.length-1].$]),h[h.length-1].$.push(i)):h[h.length-1].$=i):h.$=i,i=h;else{i={$:i};try{(c=await this.dot(f,u.slice(0,u.lastIndexOf(".")),void 0,void 0,!0))&&(i._=c[u.split(".").pop()]._)}catch(e){}}"object"==typeof i&&null==i._&&null!=i.$&&(i=i.$),await this.dot(f,u,i,void 0,!0)}u=u.includes(".")?u.slice(0,u.lastIndexOf(".")):""}else if(m){for(m=!1,n={},r=0,l=(d=i.replace("<","").replace(">","").split(" ")).length;r<l;r++)(o=d[r]).includes("=")?o.length&&([a,g]=o.split("="),n[a.trim().replace(/"/g,"")]=g.trim().replace(/"/g,"")):u+=(u&&!u.endsWith(".")?".":"")+o;(h=await this.dot(f,u,void 0,void 0,!0))?(Array.isArray(h)||(h=[h]),h.push("{}"!==JSON.stringify(n)?{_:n}:{}),await this.dot(f,u,h,void 0,!0)):"{}"!==JSON.stringify(n)&&await this.dot(f,u+"._",n,void 0,!0)}i=""}return f},r.date=function(e,t,i=!0,s=!0){var r,a,l,n,o;if(null==e&&(e=null!=(l=this.params.date)?l:Date.now()),null==t&&(t=this.params.time),"number"==typeof e||"string"==typeof e&&-1===e.indexOf(" ")&&-1===e.indexOf("/")&&-1===e.indexOf("-")&&e.length>8&&-1===e.indexOf("T"))try{return o=(o=new Date(parseInt(e))).toISOString(),t?i?s||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(e){}try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(r in e)"number"!=(n=typeof e[r])&&"string"!==n&&(e[r]="01");e=e.join("-")}catch(e){}return-1!==(e=decodeURIComponent(e)).indexOf("T")&&(e=e.split("T")[0]),-1===(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).indexOf("-")&&(e+="-01"),3!==(a=e.split("-")).length&&(a=(e+="-01").split("-")),3!==a.length&&(e=void 0),a[0].length<a[2].length&&(e=a.reverse().join("-")),e}catch(e){}},r.date._cache=!1,r.datetime=function(e,t){var i,s;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(s=null!=e?e:this.params.secs)?s:this.params.s,null!=t?t:this.params.ms)},r.datetime._cache=!1,r.epoch=function(e){var t,i,s,r,a;if(null==e&&(e=this.params.epoch),"number"==typeof e&&(e=e.toString()),!e)return Date.now();if(!(e.startsWith("+")||e.startsWith("-")||2===e.split("+").length&&e.split("+")[0].length>4||2===e.split("-").length&&e.split("-")[0].length>4)){if(e.length>8&&!e.includes("-")&&!isNaN(parseInt(e)))return this.date(e,null==(s=this.params.time)||s);for(4===e.length&&(e+="-01"),e.split("-").length<3&&(e+="-01"),-1===e.indexOf("T")&&(e+="T"),-1===e.indexOf(":")&&(e+="00:00"),e.split(":").length<3&&(e+=":00"),-1===e.indexOf(".")&&(e+="."),[r,i]=e.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return-1===i.indexOf("Z")&&(i+="Z"),new Date(r+"."+i).valueOf()}return(e.startsWith("+")||e.startsWith("-"))&&(e=Date.now()+e),e.includes("+")?([e,t]=e.replace("/","").split("+"),(parseInt(e)+parseInt(t)).toString()):e.includes("-")?([e,a]=e.replace("/","").split("-"),(parseInt(e)-parseInt(a)).toString()):void 0},r.epoch._cache=!1,r.uid=function(e){var t,i,s,r,a,l,n,o,u,h,p;return null==e&&(e="uid"===this.fn&&null!=(t=null!=(i=null!=(s=null!=(r=null!=this&&null!=(a=this.params)?a.len:void 0)?r:null!=this&&null!=(l=this.params)?l.length:void 0)?s:null!=this&&null!=(n=this.params)?n.size:void 0)?i:null!=this&&null!=(o=this.params)?o.uid:void 0)?t:21),"string"==typeof e&&(p=parseInt(e),e=isNaN(p)?void 0:p),Object(c.a)(null!=(u=null!=this&&null!=(h=this.params)?h.alphabet:void 0)?u:"0123456789abcdefghijklmnopqrstuvwxyz",e)()},r.uid._cache=!1,r.encrypt=async function(e){var t,i,r,a,l,n;null==e&&(e=null!=(i=null!=(r=null!=(a=null!=(l=this.params.encrypt)?l:this.params.content)?a:this.params.q)?r:this.params)?i:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createCipheriv("aes-256-ctr",this.S.encrypt.salt,null!=(n=this.params.iv)?n:this.S.encrypt.iv),s.concat([t.update(e),t.final()]).toString("hex")},r.encrypt._cache=!1,r.encrypt._bg=!0,r.decrypt=async function(e){var t,i,r,a,l,n,o;null==e&&(e=null!=(r=null!=(a=null!=(l=null!=(n=this.params.decrypt)?n:this.params.content)?l:this.params.q)?a:this.params)?r:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"object"==typeof e?(i=e.iv,e=e.content):i=null!=(o=this.params.iv)?o:this.S.encrypt.iv,"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createDecipheriv("aes-256-ctr",this.S.encrypt.salt,i),s.concat([t.update(s.from(e,"hex")),t.final()]).toString()},r.decrypt._cache=!1,r.decrypt._bg=!0,r.decrypt._auth="@oa.works",r.hash=async function(e){var t,i,s,r,a,l,n,o,u,c;null==e&&(e=null!=(n=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?n:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(s),l=[],r=0,a=t.length;r<a;r++)i=t[r],l.push(("00"+i.toString(16)).slice(-2));return l.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},r.hashcode=function(e){var t,i,s,r,a,l;for(null==e&&(e=null!=(s=null!=(r=null!=(a=null!=(l=this.params.hashcode)?l:this.params.content)?a:this.params.q)?r:this.params)?s:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),t=0,i=0;i<e.length;)t=(t<<5)-t+e.charCodeAt(i),t&=t,i++;return t},r.hashhex=function(e){var t;return null==e&&(e=this.params.hashhex),(t=this.hashcode(e))<0&&(t=4294967295+t+1),t.toString(16)},r.shorthash=function(e,t){var i,s,r,a,l,n,o,u;for(null==e&&(e=null!=(r=null!=(a=null!=(l=null!=(n=this.params.shorthash)?n:this.params.content)?l:this.params.q)?a:this.params)?r:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),s=this.hashcode(e),t?(u=t.substring(0,1),t=t.replace(u,"")):(t="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=t.length,o=s<0?u:"",s=Math.abs(s);s>=i;)o+=t[s%i],s=Math.floor(s/i);return o+(s>0?t[s]:"")},r.fetch=async function(e,t){var i,r,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y;if(null==e&&null==t)try{t=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==t&&(e=(t=e).url),null==t&&(t={}),"number"==typeof t&&(t={cache:t}),"number"==typeof t.cache&&(null==t.cf&&(t.cf={cacheEverything:!0}),t.cf.cacheTtl=t.cache,delete t.cache),!e&&t.url&&(e=t.url,delete t.url),!0===t.bg&&"string"==typeof a.bg&&(t.url=e,e=a.bg+"/fetch",delete t.bg),t.username&&t.password&&(t.auth=t.username+":"+t.password,delete t.username,delete t.password),e.split("?")[0].includes("@")&&e.includes(":")&&e.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(t.auth=e.split("//")[1].split("@")[0],e=e.replace(t.auth+"@","")),t.auth&&(null==t.headers&&(t.headers={}),t.headers.Authorization="Basic "+s.from(t.auth).toString("base64"),delete t.auth),p=0,g=(L=["data","content","json"]).length;p<g;p++)null!=t[n=L[p]]&&(t.body=t[n],delete t[n]);if(null==t.attachment&&(t.attachment=t.attachments),null==t.file&&(t.file=t.attachment),null!=t.file){for(null==t.headers&&(t.headers={}),null!=t.body&&null==t.form&&(t.form=t.body),t.body=new FormData,Array.isArray(t.file)||(c="object"==typeof t.file&&null!=t.file.file?[{file:t.file.file,filename:null!=(N=null!=(E=t.file.filename)?E:t.file.name)?N:t.filename}]:[{file:t.file,filename:t.filename}],t.file=c),d=0,y=(q=t.file).length;d<y;d++)null==(null!=(h=q[d])?h.file:void 0)&&null==(null!=h?h.data:void 0)||t.body.append(null!=t.attachment?"attachment":"file",null!=(M=h.file)?M:h.data,null!=(W=null!=(U=null!=(z=h.filename)?z:h.name)?U:t.filename)?W:"file");delete t.filename,null==t.method&&(t.method="POST")}else null!=t.body&&(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="object"==typeof t.body?"application/json":"text/plain"),"object"!=(J=typeof t.body)&&"boolean"!==J&&"number"!==J||(t.body=JSON.stringify(t.body)),null==t.method&&(t.method="POST"));if(null!=t.form){if(null!=t.file){if("object"==typeof t.form)for(u in t.form)for(m=0,_=(B=Array.isArray(t.form[u])?t.form[u]:[t.form[u]]).length;m<_;m++)r=B[m],t.body.append(u,"object"==typeof r?JSON.stringify(r):r)}else{if(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof t.form){for(S in A="",t.form)for(""!==A&&(A+="&"),b=0,v=(P=Array.isArray(t.form[S])?t.form[S]:[t.form[S]]).length;b<v;b++)null!=(I=P[b])&&(A.endsWith("&")||(A+="&"),A+=S+"="+encodeURIComponent("object"==typeof I?JSON.stringify(I):I));t.form=A}t.body=t.form}delete t.form,null==t.method&&(t.method="POST")}if(delete t.file,delete t.attachment,delete t.attachments,"string"!=typeof e);else{if(!e.startsWith("http:")&&e.includes("localhost"))try{null==t.agent&&(t.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(e.includes("?")){for(O=(D=e.split("?")).shift()+"?",x=0,w=(R=D.join("?").split("&")).length;x<w;x++)C=R[x],O.endsWith("?")||(O+="&"),[f,Y]=C.split("="),null==Y&&(Y=""),f&&(O+=encodeURIComponent(f)+(Y?"="+(Y.includes("%")?Y:encodeURIComponent(Y)):""));e=O}if(t.params&&"{}"!==JSON.stringify(t.params)){for(f in e.includes("?")||(e+="?"),T=t.params)Y=T[f],e.endsWith("&")||e.endsWith("?")||(e+="&"),f&&(e+=encodeURIComponent(f)+"="+encodeURIComponent("object"==typeof Y?JSON.stringify(Y):Y));delete t.params}a.system&&("string"==typeof a.bg&&e.startsWith(a.bg)||"string"==typeof a.async&&e.startsWith(a.async)||"string"==typeof a.kv&&a.kv.startsWith("http")&&e.startsWith(a.kv))&&(null==t.headers&&(t.headers={}),null==(l=t.headers)[k="x-"+a.name.toLowerCase()+"-system"]&&(l[k]=a.system),t.headers.Authorization||t.headers.authorization||t.headers["x-apikey"]||!this.user||(t.headers["x-apikey"]=this.user.apikey)),i=async()=>{var i,s,r,l;if(t.stream)return delete t.stream,fetch(e,t);i=!1,t.buffer&&(i=!0,delete t.buffer),l=await fetch(e,t);try{(!e.includes("localhost")||200!==(r=l.status)&&404!==r)&&a.dev&&!0===a.bg&&console.log(l.status+" "+e),t.verbose&&(l.status>300&&console.log(l.body),console.log(l.status+" "+e))}catch(e){console.log("Error logging to console for fetch"),console.log(l)}if(i)s=await l.buffer();else{s=await l.text();try{"string"==typeof s&&(s.startsWith("{")||s.startsWith("["))&&(s=JSON.parse(s))}catch(e){}}return 404!==l.status?l.status>=400?(a.dev&&!0===a.bg&&console.log(t,JSON.stringify(s),"FETCH ERROR",l.status),{status:l.status}):s:void 0};try{t.timeout&&null!=(null!=this?this._timeout:void 0)?(j=!0===t.timeout?3e4:t.timeout,delete t.timeout,F=await this._timeout(j,i())):F=await i();try{((F=F.trim()).startsWith("[")||F.startsWith("{"))&&(F=JSON.parse(F))}catch(e){}return F}catch(t){o=t,a.dev&&!0===a.bg&&console.log("ERROR TRYING TO CALL FETCH",e,o,JSON.stringify(o));try{this.log(o)}catch(e){}}}},r.fetch._auth="system",r._timeout=function(e,t){return new Promise((t,i)=>{var s;return s=setTimeout(()=>i(new Error("TIMEOUT")),e),promise.then(value(()=>(clearTimeout(s),t(value)))).catch(reason(()=>(clearTimeout(s),i(reason))))})};var p,d,f,m,g,y;h=[].indexOf;null==a.index&&(a.index={}),null==(p=a.index).name&&(p.name=null!=(f=a.name)?f:"Paradigm"),"string"!=typeof a.index.name&&(a.index.name=""),a.index.name=a.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof a.bg&&null==(d=a.index).url&&(d.url=a.bg+"/index"),r.index=async function(e,t,i,s){var a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b;if("object"==typeof e&&(t=e,e=void 0),null==e&&null==t&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(h=this.parts[1])||"src"===h))return{status:403};if("object"==typeof this.body?t=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(t=this.body):t=this.copy(this.params),delete t.route,delete t.index,delete t[this.fn.split(".").pop()],delete t._id,null!=t.script||-1!==JSON.stringify(t).toLowerCase().indexOf("<script"))return}if("object"!=typeof t||Array.isArray(t)||(null==e&&(e=null!=(p=t.route)?p:t.index),delete t.route,delete t.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(n in y=[],(await this.index._send("_stats")).indices)n.startsWith(".")||n.startsWith("security-")||y.push(n);return y}2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e)if(e.includes("?")?([e,b]=e.split("?"),b="?"+b):b="",e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof t&&!Array.isArray(t)&&t._id&&(l=(t=null!=(null!=this?this.copy:void 0)?this.copy(t):r.copy(t))._id.replace(/\//g,"_").toLowerCase(),-1===e.indexOf("/")&&-1===e.indexOf(l)&&(e+="/"+l),delete t._id,"{}"===JSON.stringify(t)&&(t=void 0)),w=(e=e.toLowerCase()).split("/").length,null==this.index&&(this.index=r.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===e.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===t)_=await this.index._send(e.replace("/","/_doc/")+b,"");else if(1===w){if("string"==typeof t&&(""===t||-1!==t.indexOf("\n"))||Array.isArray(t))return""===t?this.index._send(e+b,t):this.index._bulk(e+b,t);if("object"!=(d=typeof t)&&"string"!==d)return this.index._send(e+"/_search"+b);if("{}"!==JSON.stringify(t)&&(c=await this.index.translate(t,i)))return this.index._send(e+"/_search"+b,c);if("object"==typeof t){for(a=null!=(null!=this?this.copy:void 0)?this.copy(t):r.copy(t),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete a[f[o]];return"{}"===JSON.stringify(a)?(await this.index._send(e+b)||await this.index._send(e+b,{settings:t.settings,aliases:t.aliases,mappings:null!=(m=t.mappings)?m:t.mapping}),this.index._send(e+"/_search"+b)):"created"===(null!=(_=await this.index._send(e+"/_doc"+b,t))?_.result:void 0)&&_._id?_._id:_}}else if(2===w&&(null==t||"object"==typeof t&&!Array.isArray(t)))return e.startsWith("_")||e.includes("/_")||(e=e.replace("/","/_doc/")),null!=t&&"{}"!==JSON.stringify(t)?("object"==typeof t&&null!=t.script&&(e+="_update",b+=(b.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(_=await this.index._send(e+b,t))?_.result:void 0)&&_._id?_._id:_):("object"==typeof(_=await this.index._send(e+b))&&(_._source||_.fields)&&(null==(v=null!=(g=_._source)?g:_.fields)._id&&(v._id=_._id),_=v),_)},r.index._auths="system",r.index._caches=!1,r.index.status=async function(){var e,t,i,s,r,a,l,n,o,u,c,h,p,d,f;c={status:"green",docs:0,size:0,shards:0,failed:0};try{for(i in(f=await this.index._send("_nodes/stats/indices/search")).nodes)null==c.scrolls&&(c.scrolls=0),c.scrolls+=f.nodes[i].indices.search.open_contexts}catch(e){}for(i in c.indices={},h=await this.index._send("_stats"),d=await this.index._send("_cat/shards?format=json"),h.indices)if(!i.startsWith(".")&&!i.startsWith("security-")){for(c.indices[i]={docs:h.indices[i].primaries.docs.count,size:Math.ceil(h.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},s=0,l=d.length;s<l;s++)(p=d[s]).index===i&&"p"===p.prirep&&(null==(e=c.indices[i]).shards&&(e.shards=0),c.indices[i].shards+=1,null==(t=c.indices[i]).failed&&(t.failed=0),"UNASSIGNED"===p.state&&(c.indices[i].failed+=1));c.docs+=c.indices[i].docs;try{c.size+=parseInt(c.indices[i].size.replace("mb",""))}catch(e){}c.shards+=c.indices[i].shards,c.failed+=c.indices[i].failed}c.size=Math.ceil(c.size/1e3+"gb");try{for("green"!==(o=c.cluster.status)&&"yellow"!==o&&(c.status="red"),a=0,n=(u=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;a<n;a++)r=u[a],delete c.cluster[r]}catch(e){}return c},r.index.keys=async function(e,t){var i,s,r,a,l,n;return null==e&&(e=null!=(a=null!=(l=this.params.index)?l:this.params.keys)?a:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys",""),null==t&&(t=null!=(n=this.params.type)?n:this.params.types),"string"==typeof t&&(t=[t]),s=!0===t?{}:[],r="object"==typeof e?e:await this.index.mapping(e),i=async(e,r="")=>{var a,l,n,o;for(a in r&&(r+="."),o=[],e)null!=e[a].properties?o.push(await i(e[a].properties,r+a)):!t||!0===t||(l=e[a].type,h.call(t,l)>=0)?!0===t?o.push(s[r+a]=e[a].type):(n=r+a,h.call(s,n)<0?o.push(s.push(r+a)):o.push(void 0)):o.push(void 0);return o},"object"==typeof r&&await i(r),s},r.index.terms=async function(e,t,i,s=100,r=!0,a="count"){var l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x;if(null==e&&(e=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),!t||!i){if(null==t&&(t=null!=(m=this.params.terms)?m:this.params.key),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),!t)return[];for(l=this.copy(this.params),n=0,u=(g=["index","route","terms","key"]).length;n<u;n++)delete l[g[n]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(l)),d="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&d.query.bool.must.push({query_string:{query:i}}),null==d.aggregations&&(d.aggregations={}),null==d.size&&(d.size=0),null!=this.params.size&&(s=this.params.size),null!=this.params.counts&&(r=this.params.counts),null!=this.params.order&&(a=this.params.order),h={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof a&&null!=h[a]&&(a=h[a]),d.aggregations[t]={terms:{field:t+(t.endsWith(".keyword")?"":".keyword"),size:s,order:a}},b=[],o=0,c=(w=null!=(y=null!=(x=await this.index._send("/"+e+"/_search",d,"POST"))&&null!=(_=x.aggregations)&&null!=(v=_[t])?v.buckets:void 0)?y:[]).length;o<c;o++)p=w[o],b.push(r?{term:p.key,count:p.doc_count}:p.key);return b},r.index.suggest=async function(e,t,i,s=100,r){var a,l,n,o,u,c,p,d,f,m,g,y,_;if(t&&i||(null==t&&(t=null!=(d=this.params.suggest)?d:this.params.key),"string"==typeof t&&t.includes("/")&&([t,i]=t.split("/"))),!t)return this.index.keys(e,"text");if(null==e&&(e=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),e=e.replace("index/","").split("/suggest")[0],null==r&&(r=this.params.include),"string"==typeof r&&(r=r.replace(/,\s/g,",").split(",")),Array.isArray(r)&&h.call(r,t)<0&&r.push(t),"string"==typeof i&&(c=(i=i.trim()).toLowerCase(),(_={should:[{match:{}},{prefix:{}},{query_string:{query:t+":"+i.split(" ").join(" AND "+t+":")+"*"}}]}).should[0].match[t]={query:i,boost:3},_.should[1].prefix[t]={value:i,boost:2}),g=[],y=[],r){for await(p of this.index._for(e,null!=_?_:i,{sort:t+".keyword",until:s,include:!0===r?[t]:r}))if(n=await this.dot(p,t)){for(;Array.isArray(n)&&(a=n.shift());)a.toLowerCase().includes(c)&&(n=a);o=n.toLowerCase(),h.call(y,o)<0&&(!c||o.includes(c))&&g.push(p),y.push(o)}}else for(l=0,u=(m=await this.index.terms(e,t,null!=_?_:i,s,!1,"term")).length;l<u;l++)o=(n=m[l]).toLowerCase(),h.call(y,o)<0&&(!c||o.includes(c))&&g.push(n),y.push(o);return g},r.index.count=async function(e,t,i){var s,r,a,l,n,o,u,c,h,p,d;for(null==i&&(i=null!=(n=this.params.count)?n:this.params.key),null==e&&(e=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),s=this.copy(this.params),r=0,a=(u=["index","route","count","key"]).length;r<a;r++)delete s[u[r]];return null==t&&(l=await this.index.translate(s))&&(t=l),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(d=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(c=d.aggregations)&&null!=(h=c.keyed)?h.value:void 0):null!=(d=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(p=d.hits)?p.total:void 0},r.index.percent=async function(e,t,i){var s,r,a,l,n,o,u,c,h,p,d,f,m;for(null==i&&(i=null!=(o=this.params.count)?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),r=this.copy(this.params),a=0,l=(c=["index","route","count","key"]).length;a<l;a++)delete r[c[a]];return null==t&&(n=await this.index.translate(r))&&(t=n),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),m=await this.index.count(e,"*"),s=0,i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},s=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(h=f.aggregations)&&null!=(p=h.keyed)?p.value:void 0):s=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(d=f.hits)?d.total:void 0,Math.ceil(s/m*1e4)/100},r.index.min=async function(e,t,i,s="min"){var r,a,l,n,o,u,c,h;for(null==t&&(t=null!=(o=this.params[s])?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(e=e.replace("index/","").replace("/"+s,"")).indexOf("/")&&([e,t]=e.split("/")),r=this.copy(this.params),a=0,l=(c=["index","route","min","max","key","sum","average"]).length;a<l;a++)delete r[c[a]];return null==i&&(i=await this.index.translate(r)),(n="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,"sum"===s?n.aggs={sum:{sum:{field:t}}}:"average"===s?n.aggs={average:{avg:{field:t}}}:(n.aggs={},"min"!==s&&"range"!==s||(n.aggs.min={min:{field:t}}),"max"!==s&&"range"!==s||(n.aggs.max={max:{field:t}})),h=await this.index._send("/"+e+"/_search",n,"POST"),"range"===s?{min:h.aggregations.min.value,max:h.aggregations.max.value}:h.aggregations[s].value},r.index.max=function(e,t,i){return this.index.min(e,t,i,"max")},r.index.range=function(e,t,i){return this.index.min(e,t,i,"range")},r.index.sum=function(e,t,i){return this.index.min(e,t,i,"sum")},r.index.average=function(e,t,i){return this.index.min(e,t,i,"average")},r.index.mapping=async function(e){var t;return-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),(t=await this.index._send(e))[(await this.keys(t))[0]].mappings.properties},r.index._for=async function*(e,t,i,s){var r,a,l,n,o,u,c,h,p,d,f,m,g;for("number"==typeof i&&(i={until:i}),(null!=i?i.scroll:void 0)?("number"!=typeof(g=i.scroll)&&g.endsWith("m")||(g+="m"),delete i.scroll):g="2m",((null!=i?i.until:void 0)||(null!=i?i.max:void 0))&&(a=null!=(u=i.until)?u:i.max,delete i.until,delete i.max),null==t&&(t="*"),null==(n=await this.index.translate(t,i)).from&&(n.from=0),null==n.size&&(n.size=500),null==n.sort&&(n.sort=["_doc"]),(null!=(f=await this.index._send(e+"/_search?scroll="+g,n,void 0,s))?f._scroll_id:void 0)&&(l=f._scroll_id.replace(/==$/,"")),(null!=f&&null!=(c=f.hits)?c.total:void 0)&&(null==a||a>f.hits.total)&&(a=f.hits.total),r=0;;){if((null!=f&&null!=(h=f.hits)?h.hits:void 0)&&0!==f.hits.hits.length||!(null!=f?f._scroll_id:void 0)||(null!=(f=await this.index._send("/_search/scroll?scroll="+g+"&scroll_id="+f._scroll_id,void 0,void 0,s))?f._scroll_id:void 0)!==l&&(await this.index._send("/_search/scroll?scroll_id="+l,"",void 0,s),l=null!=f?f._scroll_id:void 0),r===a||null==(null!=f&&null!=(p=f.hits)?p.hits:void 0)||!f.hits.hits.length){l&&await this.index._send("/_search/scroll?scroll_id="+l,"",void 0,s);break}r+=1,null==(m=null!=(d=(o=f.hits.hits.shift())._source)?d:o.fields)._id&&(m._id=o._id),yield m}},r.index._each=async function(e,t,i,r,a){var l,n,o,u,c,h,p,d,f,m,g;for await(p of(null==r&&null==i&&"function"==typeof t&&(r=t,t="*"),null==r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),"string"==typeof i&&(l=i,i=void 0),(null!=i?i.action:void 0)&&(l=i.action,delete i.action),(m=null!=(d=i.size)?d:"object"==typeof t&&null!=t.size?t.size:1e3)>50&&((h=await this.index.translate(t,i)).size=1,null!=(null!=(n=await this.index._send(e,h,void 0,a))&&null!=(f=n.hits)?f.total:void 0)&&0!==n.hits.total&&(u=Math.floor(1e9/(s.byteLength(JSON.stringify(n.hits.hits[0]))*n._shards.total)))<m&&(m=u),h.size=m),c=0,g=[],this.index._for(e,null!=h?h:t,i,a)))c+=1,null==(o=await r.call(this,p))||"object"!=typeof o&&"string"!=typeof o||g.push(o),l&&g.length>m&&(await this.index._bulk(e,g,l,void 0,a),g=[]);if(l&&g.length&&this.index._bulk(e,g,l,void 0,a),this.S.dev&&!0===this.S.bg)return console.log("_each processed "+c)},r.index._bulk=async function(e,t,i="index",s=5e4,a){var l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I;if(!0===i&&(i="index"),null==a&&(a=await this.dot(r,e.split("/")[0].replace(/_/g,".")+"._prefix")),!1!==a&&(e=("string"==typeof a?a:this.S.index.name)+"_"+e),null==this.index&&(this.index=r.index),"string"==typeof t&&-1!==t.indexOf("\n"))return await this.index._send("/_bulk",{body:t,headers:{"Content-Type":"application/x-ndjson"}},void 0,a),!0;for(f in A="object"!=typeof t||Array.isArray(t)||null==(null!=t&&null!=(m=t.hits)?m.hits:void 0)?t:t.hits.hits,Array.isArray(A)||(A=[A]),l=0,n=0,d="",A)if(l+=1,"object"==typeof(S=A[f])&&("string"==typeof(O=null!=(g=null!=(y=S._id)?y:null!=(_=S._source)?_._id:void 0)?g:await this.uid())&&(O=O.replace(/\//g,"_")),S._source&&(S=S._source),delete S._id),(p={})[i]={_index:e},p[i]._id="delete"!==i||"string"!=(v=typeof S)&&"number"!==v?O:S,d+=JSON.stringify(p)+"\n","create"===i||"index"===i?d+=JSON.stringify(S)+"\n":"update"===i&&(d+=JSON.stringify({doc:S})+"\n"),l===s||parseInt(f)===A.length-1||d.length>7e7){if(I=await this.index._send("/_bulk",{body:d,headers:{"Content-Type":"application/x-ndjson"}},void 0,a),(null!=this&&null!=(w=this.S)?w.dev:void 0)&&!0===(null!=this&&null!=(b=this.S)?b.bg:void 0)&&(null!=I?I.errors:void 0)){for(o=[],c=0,h=(x=I.items).length;c<h;c++){u=x[c];try{200!==(k=u[i].status)&&201!==k&&(o.push(u[i]),n+=1)}catch(e){n+=1}}try{console.log(o)}catch(e){}try{console.log(0===o.length?"SOME":o.length,"INDEX ERRORS BULK LOADING",I.items.length)}catch(e){}}d="",l=0}return A.length-n},r.index.translate=function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C,L,N,P,R,T,E,q,M,W,U,z,J,B,F,Y,V,X,$,G,H,Z,Q,K,ee,te,ie,se,re,ae,le,ne,oe,ue,ce,he,pe,de;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==e&&(e=null!=this?this.params:void 0),"string"==typeof e){if(""===e||-1!==e.indexOf("\n"))return}else{if("object"!=typeof e||Array.isArray(e))return;for(g=0,v=(R=["settings","aliases","mappings","index","_id"]).length;g<v;g++)if(null!=e[y=R[g]])return;if(P=!1,e.source)try{P=JSON.parse(decodeURIComponent(e.source))}catch(e){}if("{}"!==JSON.stringify(e)&&null==e.q&&null==e.query&&!1===P&&null==e.must&&null==e.should&&null==e.must_not&&null==e.filter&&null==e.aggs&&null==e.aggregations)return}try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if(null==t&&(t={}),("string"==typeof t||Array.isArray(t))&&(t={fields:t}),"random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null!=t.newest&&(t.sort={createdAt:t.newest?"desc":"asc"},delete t.newest),null==(N=null!=(Y=null!=t?t.query:void 0)?Y:{}).query&&(N.query={}),null==(a=N.query).bool&&(a.bool={must:[],filter:[]}),"string"==typeof e)le={query_string:{query:e}},null!=(null!=t?t.fields:void 0)&&(le.query_string.fields="string"==typeof t.fields?t.fields.split(","):t.fields,delete t.fields),N.query.bool.filter.push(le);else if("object"==typeof e)if(null!=e.query)N=e;else for(j in null!=e.source?"string"==typeof e.source&&"object"==typeof P?N=P:"object"==typeof e.source&&(N=e.source):null!=e.q&&("object"==typeof e.q?N.query=e.q:(e.q=decodeURIComponent(e.q),null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(C={})[(L=e.q.split(":"))[0]]=L[1],N.query.bool.must.push({prefix:C})):null!=e.fields?(N.query.bool.filter.push({query_string:{query:e.q,fields:e.fields.split(",")}}),delete e.fields):N.query.bool.filter.push({query_string:{query:e.q}}))),e)null==t[j]&&(t[j]=e[j]);if(null!=(null!=(G=N.query)&&null!=(H=G.filtered)&&null!=(Z=H.query)?Z.bool:void 0)&&(N.query.bool=N.query.filtered.query.bool,N.query.bool.filter=N.query.filtered.filter,delete N.query.filtered),null!=N.facets&&(N.aggregations=JSON.parse(JSON.stringify(N.facets).replace(/\.exact/g,".keyword")),delete N.facets),null!=N.query&&null==N.query.bool&&"{}"!==JSON.stringify(N.query)&&(N.query={bool:{must:[],filter:[N.query]}}),null==N.query&&(N.query={bool:{must:[],filter:[]}}),null==(l=N.query).bool&&(l.bool={must:[],filter:[]}),null==(n=N.query.bool).filter&&(n.filter=[]),"string"==typeof t.sort){for(ae=[],_=0,w=(Q=t.sort.split(",")).length;_<w;_++)re=Q[_],[y,j]=re.split(":"),j?(ae.push({}),ae[ae.length-1][y.trim()]=j.trim()):ae.push(y.trim());t.sort=ae}if(t.random&&(d={function_score:{random_score:{}}},null!=t.seed&&(d.function_score.random_score.seed=seed),d.function_score.query=N.query,N.query=d,delete t.random,delete t.seed),(m=null!=(K=null!=(ee=null!=(te=t._include)?te:t.include)?ee:t._includes)?K:t.includes)&&(null==N._source&&(N._source={}),N._source.includes="string"==typeof m?m.replace(/,\s/g,",").split(","):m),h=null!=(T=null!=(E=null!=(q=t._exclude)?q:t.exclude)?E:t._excludes)?T:t.excludes)for(null==N._source&&(N._source={}),N._source.excludes="string"==typeof h?h.replace(/,\s/g,",").split(","):h,I=0,b=(U=null!=(M=null!=(W=N._source)?W.includes:void 0)?M:[]).length;I<b;I++)f=U[I],N._source.excludes=N._source.excludes.filter((function(e){return e!==f}));for(ne=0,x=(z=["filter","restrict","must","and","must_not","not","should","or"]).length;ne<x;ne++)if(null!=t[ue=z[ne]])for(A=Array.isArray(t[ue])?t[ue]:[t[ue]],delete t[ue],c="filter"===ue||"restrict"===ue||"must"===ue||"and"===ue?"filter":"must_not"===ue||"not"===ue?"must_not":"should",null==(o=N.query.bool)[c]&&(o[c]=[]),ce=0,k=A.length;ce<k;ce++)"object"==typeof(se=A[ce])?1===(ie=this.keys(se)).length&&"object"!=typeof se[ie[0]]&&(se={term:se}):se={query_string:{query:se}},N.query.bool[c].push(se);if(null!=t.terms){try{t.terms=t.terms.replace(/,\s/g,",").split(",")}catch(e){}for(null==N.aggregations&&(N.aggregations={}),pe=0,O=(J=t.terms).length;pe<O;pe++)oe=J[pe],N.aggregations[oe]={terms:{field:oe+(oe.endsWith(".keyword")?"":".keyword"),size:1e3}};delete t.terms}for(de=0,S=(B=["aggs","aggregations"]).length;de<S;de++)if(null!=t[i=B[de]]){for(p in null==N[i]&&(N[i]={}),t[i])N[i][p]=t[i][p];delete t[i]}for(y in t){if(he=t[y],("from"===y||"size"===y)&&"number"!=typeof he)try{he=parseInt(he),isNaN(he)&&(he=void 0)}catch(e){}null!=he&&"apikey"!==y&&"_"!==y&&"callback"!==y&&"refresh"!==y&&"key"!==y&&"counts"!==y&&"index"!==y&&"search"!==y&&"source"!==y&&"q"!==y&&"include"!==(F=y.replace("_","").replace("s",""))&&"exclude"!==F&&(N[y]=he)}try{for(s in D={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},N.aggregations)"string"==typeof(null!=(V=N.aggregations[s].terms)?V.order:void 0)&&null!=D[N.aggregations[s].terms.order]&&(N.aggregations[s].terms.order=D[N.aggregations[s].terms.order])}catch(e){}if(null!=(null!=(X=N.query)?X.bool:void 0))for(u in N.query.bool)for(r in N.query.bool[u])"string"==typeof(null!=($=N.query.bool[u][r].query_string)?$.query:void 0)&&-1!==N.query.bool[u][r].query_string.query.indexOf("/")&&-1===N.query.bool[u][r].query_string.query.indexOf('"')&&(N.query.bool[u][r].query_string.query='"'+N.query.bool[u][r].query_string.query+'"');return null!=N._source&&null!=N.fields&&delete N._source,N},r.index.translate._auth=!1,r.index._send=async function(e,t,i,s){var l,n,o,u,c,h,p,d,f,m;if(e.includes("?")?([e,f]=e.split("?"),f="?"+f):f="",(e=e.toLowerCase()).startsWith("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,"")),null==i&&(i=""===t?"DELETE":null==t||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=t||"_refresh"===(o=e.split("/").pop().split("?")[0])||"_aliases"===o?"POST":"GET":"PUT"),"DELETE"===i&&-1!==e.indexOf("/_all"))return!1;if(!e.startsWith("http")){if(!this.S.index.name||e.startsWith(this.S.index.name)||e.startsWith("_")||(null==s&&(s=await this.dot(r,e.split("/")[0].replace(/_/g,".")+"._prefix")),!1!==s&&(e=("string"==typeof s?s:this.S.index.name)+"_"+e)),m=(null!=this&&null!=(u=this.S)&&null!=(c=u.index)?c.url:void 0)?this.S.index.url:null!=(h=a.index)?h.url:void 0,Array.isArray(m)&&(m=m[Math.floor(Math.random()*m.length)]),"string"!=typeof m)return;e=m+"/"+e}if(e.startsWith("http")){if(n=!1,e.includes("/_search")&&"object"==typeof t&&(null!=t.scroll_id||t.scroll)&&(!0===t.scroll&&(t.scroll="2m"),("number"==typeof t.scroll||"string"==typeof t.scroll&&!t.scroll.endsWith("m"))&&(t.scroll+="m"),e+=(-1===e.indexOf("?")?"?":"&")+"scroll="+(null!=(p=t.scroll)?p:"2m"),t.scroll_id?(n=t.scroll_id,e=e.split("://")[0]+"://"+e.split("://")[1].split("/")[0]+"/_search/scroll"+(e.includes("?")?"?"+e.split("?")[1]:""),e+=(-1===e.indexOf("?")?"?":"&")+"scroll_id="+t.scroll_id,t=void 0):(delete t.scroll_id,delete t.scroll)),l=-1!==(e=e+=f).indexOf("/_bulk")||"object"==typeof t&&"object"==typeof t.headers?t:{body:t},-1===e.indexOf("/_search")||"GET"!==i&&"POST"!==i||(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),l.method=i,!(null==(d=await this.fetch(e,l))||"object"==typeof d&&"number"==typeof d.status&&d.status>=400&&d.status<=600)){try{this.S.dev&&null!=(null!=t?t.query:void 0)&&(d.q=t)}catch(e){}return(null!=d?d._scroll_id:void 0)&&(d._scroll_id=d._scroll_id.replace(/==$/,"")),n&&n!==(null!=d?d._scroll_id:void 0)&&await this.index._send("/_search/scroll?scroll_id="+n,""),d}}else console.log("NO INDEX URL AVAILABLE")},"string"==typeof a.kv&&a.kv.startsWith("http")&&!t[a.kv]&&(t[a.kv]={},t[a.kv].get=function(e){return r.fetch(a.kv+"/"+e)},t[a.kv].getWithMetadata=async function(e){return{value:await r.fetch(a.kv+"/"+e),metadata:{}}},t[a.kv].put=function(e,t){return r.fetch(a.kv+"/"+e,{body:t})},t[a.kv].delete=function(e){return r.fetch(a.kv+"/"+e,{method:"DELETE"})},t[a.kv].list=function(e){return null==e&&(e={}),r.fetch(a.kv+"/list"+(e.prefix?"/"+e.prefix:"")+(e.cursor?"?cursor="+e.cursor:""))}),r.kv=async function(e,i,s,r,a){var l,n,o,u,c,h,p,d,f,m,g,y,_,v;if(null==e&&(e=null!=(p=null!=(d=this.params.kv)?d:this.params.key)?p:this.parts.join("_"),null==i)){if("DELETE"===this.request.method)i="";else if(this.body)i=this.body;else if(this.params.val)i=this.params.val;else{for(i=this.params,l=0,u=(f=["key","kv","refresh","apikey"]).length;l<u;l++)delete i[o=f[l]];for(n=0,c=(m=this.parts).length;n<c;n++)delete i[o=m[n]]}"string"!=typeof i||0!==i.indexOf("[")&&0!==i.indexOf("{")||(i=JSON.parse(i)),"{}"!==(g=JSON.stringify(i))&&"[]"!==g||(i=void 0)}if("object"!=typeof i||"{}"!==(y=JSON.stringify(i))&&"[]"!==y||(i=void 0),"object"==typeof e&&null==i&&(e=null!=(_=(i=e)._id)?_:await this.uid()),null!=e&&this.S.kv&&t[this.S.kv]){if(null!=i&&""!==i){if(h={metadata:r},"number"==typeof s&&(1e3*s>Date.now()?h.expiration=s:h.expirationTtl=s),"object"==typeof i&&(!0===s&&(s=await this.kv(e)),"object"==typeof s))for(o in s)null==i[o]&&(i[o]=s[o]);return this.waitUntil(t[this.S.kv].put(e,"object"==typeof i?JSON.stringify(i):i,h)),i}if(({value:v,metadata:r}=await t[this.S.kv].getWithMetadata(e,a)),null!=v){try{v=JSON.parse(v)}catch(e){}try{r=JSON.parse(r)}catch(e){}return""===i&&this.waitUntil(t[this.S.kv].delete(e)),!0===r?{value:v,metadata:r}:v}}},r.kv._auths="system",r.kv._caches=!1,r.kv.list=async function(e,i){var s,r;try{null==e&&(e=null!=(s=null!=(r=this.params.kv)?r:this.params.prefix)?s:this.params.list)}catch(e){}try{null==i&&(i=this.params.cursor)}catch(e){}return await t[this.S.kv].list({prefix:e,cursor:i})},r.kv.count=async function(e){var i,s,r,a,l,n,o,u,c;if(s=0,this.S.kv&&null!=t[this.S.kv])for(null==e&&(e=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),i=!1,r=void 0;!i;){for(r=(n=await t[this.S.kv].list({prefix:e,cursor:r})).cursor,a=0,l=(c=n.keys).length;a<l;a++)c[a],s+=1;i=n.list_complete}return s},r.kv.prefixes=async function(){var e;return e={},await this.kv._each(void 0,(function(t){var i;return i=t.split("/")[0],null==e[i]&&(e[i]=0),e[i]+=1})),e},r.kv.clear=function(e){var i;if(this.S.dev)return null==e&&(e=null!=(i=this.params.clear)?i:this.params.kv),this.waitUntil(this.kv._each(e,(function(e){return this.waitUntil(t[this.S.kv].delete(e))}))),!0},r.kv.delete=async function(e){var t,i,s,r;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==e&&(e=null!=(i=null!=(s=this.params.kv)?s:this.params.delete)?i:this.params.prefix),r=t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));t&&"0"!==t;)this.S.dev&&console.log(e,t),await this.fetch(this.S.kv+"/clear"+(e?"/"+e:"")),await this.sleep(500),t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));return r}},r.kv.delete._bg=!0,r.kv._each=async function(e,i){var s,r,a,l,n,o,u,c;if(0,this.S.kv&&null!=t[this.S.kv]){for("function"==typeof e&&null==i&&(i=e,e=void 0),s=!1,r=void 0,c=[];!s;){for(r=(o=await t[this.S.kv].list({prefix:e,cursor:r})).cursor,a=0,n=(u=o.keys).length;a<n;a++)l=u[a],1,"function"==typeof i?this.waitUntil(i.call(this,l.name)):""===i?this.waitUntil(t[this.S.kv].delete(l.name)):null!=i&&this.waitUntil(this.kv(l.name,i));c.push(s=o.list_complete)}return c}},null==a.log&&(a.log={}),g=[],y=!1,m=!1,r.log=function(e,t){var i,s,r,l,n,o,u,c,h,p;if(i=async()=>{var e,t;for(!1!==y&&clearTimeout(y),y=setTimeout(i,3e4),m=Date.now(),t=new Date(m).toISOString().replace("T"," ").split(".")[0],e=[];e.length<400&&g.length;)e.push(g.shift());return e.length?(!0===this.S.bg&&console.log("Writing "+e.length+" logs to index",e[0]._id,e[e.length-1]._id,t),await this.index("logs",e)||(await this.index("logs",{}),await this.index("logs",e)),[]):!0===this.S.bg?console.log("Checked log batch but none to save",t):void 0},!1!==this.S.log&&!0!==this.nolog){if(!0!==t&&(t=null==e),"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(s=0,n=e.length;s<n;s++)l=e[s],this._logs.push(l);e=void 0}if(null==e){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return g.push(this.body),!1===y&&i(),!0;e="object"==typeof this.body?this.body:this.params,Array.isArray(e)&&(e={logs:e})}null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers,e.request.headers.cookie&&(e.cookie=!0,delete e.request.headers.cookie)}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(u in e.params={},this.params)e.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(e){}try{e.apikey=null!=this.apikey}catch(e){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}if(t){if(!e.logs&&(e.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(r=0,o=(h=this._logs).length;r<o;r++)(l=h[r]).alert&&null==e.alert&&(e.alert=l.alert),l.notify&&null==e.notify&&(e.notify=l.notify),e.logs.push(l);e.createdAt=new Date,null==e.name&&(e.name=a.name),null==e.version&&(e.version=a.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(e._id=this.rid,null!=(null!=(p=this.S.index)?p.url:void 0))!0===this.S.bg?(g.push(e),("object"==typeof this.S.log&&!1===this.S.log.batch||g.length>300||!1===m||Date.now()>m+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(g.push(e),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:e}));else try{this.kv("logs/"+e._id,e)}catch(t){console.log("Logging unable to save to kv or index"),consolg.log(e)}}else this._logs.push(e)}else this.S.dev&&!0===this.S.bg&&console.log("NOT logging",e);return!0},r.logs={_index:!0,_auth:"system"};try{a.mail=JSON.parse(SECRETS_MAIL)}catch(e){a.mail={}}r.mail=async function(e){var t,i,s,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A;if(null!=(h=a.mail)?h.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(p=this.copy(null!=this?this.params:void 0))?p:{}),e.template){for(o in u=await this.template(e.template,null!=(_=null!=(v=e.vars)?v:e.params)?_:e))e[o]=u[o];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(w=null!=(b=null!=(x=null!=(k=e.content)?k:e.msg)?x:e.body)?b:this.body)?w:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}if(delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),n=(e.svc||e.service)&&null!=(null!=(O=this.S.svc[null!=(S=e.svc)?S:e.service])?O.mail:void 0)?this.S.svc[null!=(d=e.svc)?d:e.service].mail:null!=(f=null!=this&&null!=(m=this.S)?m.mail:void 0)?f:a.mail,null==e.from&&(e.from=n.from),null==e.to&&(e.to=n.to),delete e.svc,A="https://api.mailgun.net/v3/"+n.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),e.to){for(t=null!=(g=null!=this?this.fetch:void 0)?g:r.fetch,c={method:"POST",auth:"api:"+n.apikey},s=0,l=(y=["file","files","attachment","attachments"]).length;s<l;s++)null!=e[i=y[s]]&&(c[i]=e[i],delete e[i]);return c.form=e,await t(A,c)}return console.log(e),console.log("NO ADDRESS TO EMAIL TO"),{}},r.mail._auth="system",r.mail.validate=async function(e,t){var i,s,r,a,l;if(null==e&&(e=null!=this&&null!=(r=this.params)?r.email:void 0),"string"==typeof e&&e.length&&(-1===e.indexOf(" ")||e.startsWith('"')&&2===e.split('"@').length)){try{if("string"==typeof t)return null!=(a=(l=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)).did_you_mean)?a:l.is_valid}catch(e){}if(2===(i=e.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(s=i[1].split(".")).length>1&&(2!==s.length||"example"!==s[0]))return!0}return!1};h=[].indexOf;r.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},r.dot=function(e,t,i,s,a){var l,n,o;return"string"==typeof t?r.dot(e,t.split("."),i,s,a):1!==t.length||null==i&&null==s?0===t.length?e:null==e[t[0]]?null!=i?(e[t[0]]="number"!=typeof t[0]&&isNaN(parseInt(t[0]))?{}:[],r.dot(e[t[0]],t.slice(1),i,s,a)):a&&Array.isArray(e)&&e.length&&(o=e[e.length-1]&&"object"==typeof o&&null!=o[t[0]])?r.dot(o[t[0]],t.slice(1),i,s,a):void 0:a&&Array.isArray(e)&&"number"!=typeof t[0]&&isNaN(parseInt(t[0]))&&e.length&&"object"==typeof e[e.length-1]?(null!=i&&null==(l=e[e.length-1])[n=t[0]]&&(l[n]={}),r.dot(e[e.length-1][t[0]],t.slice(1),i,s,a)):r.dot(e[t[0]],t.slice(1),i,s,a):null!=s?(e instanceof Array?e.splice(t[0],1):delete e[t[0]],!0):(a&&Array.isArray(e)&&"number"!=typeof t[0]&&isNaN(parseInt(t[0]))?(e.length||(e=[{}]),e[e.length-1][t[0]]=i):e[t[0]]=i,!0)},r.flatten=async function(e,t){var i,s,r,a,l,n,o;if(null==t&&(t=null!=(l=this.params.arrayed)&&l),null==e&&delete(e=this.params).arrayed,n={},i=async function(e,s){var r,a,l,o,u,c,h;for(l in c=[],e){a=!1;try{a=!isNaN(parseInt(l))}catch(e){}u=a&&!t?s:s?s+"."+l:l,"object"!=typeof(h=e[l])?null!=n[u]?(Array.isArray(n[u])||(n[u]=[n[u]]),c.push(n[u].push(h))):c.push(n[u]=h):Array.isArray(h)?"object"==typeof h[0]?c.push(await async function(){var e;for(o in e=[],h)e.push(await i(h[o],u+(t?"."+o:"")));return e}()):(null==n[u]&&(n[u]=[]),Array.isArray(n[u])||(n[u]=[n[u]]),c.push(function(){var e,t,i;for(i=[],e=0,t=h.length;e<t;e++)r=h[e],i.push(n[u].push(r));return i}())):c.push(await i(h,u))}return c},Array.isArray(e)){for(o=[],r=0,a=data.length;r<a;r++)s=data[r],n={},o.push(await i(s));return o}return await i(e),n},r.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&h.call(i,t)<0&&i.push(t);return i},r.pings={_index:!0},r.ping=async function(){var e,t,i;return e=this.copy(this.params),"{}"!==JSON.stringify(e)&&(e.ip=null!=(t=null!=(i=this.headers["x-forwarded-for"])?i:this.headers["cf-connecting-ip"])?t:this.headers["x-real-ip"],e.forwarded=this.headers["x-forwarded-for"],await this.pings(e),!0)},r.scrape=async function(e,t){var i,s,r,a,l,n,o,u,c,h,p,d,f,m,g,y,_,v,w,b,x,k,O,S,A,I,j,D,C;if(null==e&&(e=null!=(O=null!=(S=this.params.scrape)?S:this.params.content)?O:this.params.url),null==t&&(t=this.params.doi),f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(C=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&C.length>1&&9<C[1].length&&C[1].length<45&&-1!==C[1].indexOf("/")&&0===C[1].indexOf("10.")&&(f.doi=C[1]),e=await this.puppet(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{for(s=0,A=e.split(" "),a=0,o=A.length;a<o;a++)if(D=A[a],(s+=1)<600&&(-1!==(D=D.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(D=D.split("doi.org")[1]),0===D.indexOf("/")&&(D=D.replace("/","")),0===(D=D.trim()).indexOf("10.")&&-1!==D.indexOf("/"))){f.doi=D;break}}catch(e){}if(!f.doi)try{for(I=(r=await this.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,n=0,u=I.length;n<u;n++)w=I[n],!f.doi&&9<r.matches[w].result[1].length&&r.matches[w].result[1].length<45&&(f.doi=r.matches[w].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(e){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(b=0,c=m.length;b<c;b++)(v=m[b]).length>2&&(f.year=v)}catch(e){}if(!f.keywords)try{-1!==(l=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(l=l.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=l.split(";")):(l=l.replace(/, /g,",").replace(/ ,/g,","),f.keywords=l.split(","))}catch(e){}if(!f.email){g=[];try{for(j=(await this.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,h=j.length;x<h;x++)(y=j[x].result[1].replace("mailto:","")).endsWith(".")&&(y=y.substring(0,y.length-1)),-1===g.indexOf(y)&&g.push(y)}catch(e){}for(g.sort((function(e,t){return t.length-e.length})),_="",k=0,p=g.length;k<p;k++)d=g[k],null==f.email&&(f.email=[]),-1===_.indexOf(d)&&f.email.push(d),_+=d}return f},r.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise(t=>setTimeout(t,null!=e?e:1e3))},r.sleep._auth="root";h=[].indexOf;r.template=async function(e,t){var i,s,r,a,l,n,o,u,c,p,d,f,m,g,y,_,v,w,b;if(null==e&&(e=null!=(m=null!=(g=this.params.content)?g:this.params.template)?m:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(y=this.params.url)?y:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{s=await this.templates(e),e=s.content}catch(e){}if(v={},(i=function(t,s=""){var r,a,l,n;for(r in l=[],t)a=s?s+"."+r:r,"object"!=typeof t[r]||Array.isArray(t[r])?-1!==e.toLowerCase().indexOf("{{"+a+"}}")?(n=new RegExp("{{"+a+"}}","gi"),l.push(e=e.replace(n,Array.isArray(t[r])?t[r].join(", "):"string"==typeof t[r]?t[r]:!0===t[r]?"Yes":!1===t[r]?"No":""))):l.push(void 0):l.push(i(t[r],s+(""===s?"":".")+r));return l})(t),u=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(b=["subject","from","to","cc","bcc"],r=0,p=(_=e.toLowerCase().split("{{")).length;r<p;r++)f=_[r].split("{{")[0].split("}}")[0].split(" ")[0],h.call(b,f)<0&&b.push(f);for(a=0,d=b.length;a<d;a++)l=b[a],(n=-1!==e.toLowerCase().indexOf("{{"+l)?l:void 0)&&(o=-1!==e.indexOf("{{"+n.toUpperCase())?n.toUpperCase():n,(w=e.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(w=w.replace(u,"")),(w=w.split("}}")[0].trim())&&(v[n]=w),c=new RegExp("{{"+o+".*?}}","gi"),e=e.replace(c,""))}return-1!==e.indexOf("{{")&&(e=e.replace(u,"")),v.content=e,v},r.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},r.levenshtein=function(e,t,i){var s,r,a,l,n,o,u,c,h,p,d,f,m;for(null==e&&(e=null!=this&&null!=(p=this.params)?p.a:void 0),null==t&&(t=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(n=e.length)<(u=t.length)&&(s=e,e=t,t=s,c=n,n=u,u=c),h=[[]],s=0;s<u+1;)h[0][s]=s,s++;for(a=1;a<n+1;){for(h[a]=[a],l=1;l<u+1;)r=e.charAt(a-1)===t.charAt(l-1)?0:1,h[a][l]=o(h[a-1][l]+1,h[a][l-1]+1,h[a-1][l-1]+r),l++;a++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:n,b:u}}},r.extract=async function(e){var t,i,s,r,a,l,n,o,u,c,h;if(null==e&&(e=this.copy(this.params)),e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=await this.puppet(e.url)),e.convert)try{h=await this.convert[e.convert+"2txt"](null!=(o=e.url)?o:e.content)}catch(e){}if(null==h&&(h=e.content),null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(n=h.split(e.start),h=n.length>1?n[1]:n[0]),null!=e.end&&(h=h.split(e.end)[0]),e.lowercase&&(h=h.toLowerCase()),e.ascii&&(h=h.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(h=h.replace(/ /g,"")),c={length:h.length,matched:0,matches:[],matchers:e.matchers,text:h},h&&"number"!=typeof h)for(t=0,s=(u="string"==typeof e.matchers?e.matchers.split(","):e.matchers).length;t<s;t++){"string"==typeof(a=u[t])?(l="",0===a.indexOf("/")?(i=a.lastIndexOf("/"))+1!==a.length&&(l=a.substring(i+1),a=a.substring(1,i)):a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):l="",e.lowercase&&(l+="i");try{(r=new RegExp(a,l).exec(h))&&(c.matched+=1,c.matches.push({matched:a.toString(),result:r}))}catch(e){}}return c},r.decode=async function(e){var t,i,s,r,a,l,n,o,u,c,h,p,d;for(null==e&&(e=null!=(l=null!=(n=null!=(o=null!=this&&null!=(u=this.params)?u.decode:void 0)?o:null!=this&&null!=(c=this.params)?c.content:void 0)?n:null!=this&&null!=(h=this.params)?h.text:void 0)?l:null!=this?this.body:void 0),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(\d+);/gi,(function(e,t){var i;return i=parseInt(t,10),String.fromCharCode(i)}))},d=(d=await t(e)).replace(/\n/g," "),s=0,r=(p=[{bad:"",good:"'"},{bad:"",good:"'"},{bad:"",good:"'"},{bad:"",good:'"'},{bad:"",good:'"'},{bad:"",good:"-"},{bad:"-",good:"-"}]).length;s<r;s++)i=p[s],a=new RegExp(i.bad,"g"),d=d.replace(a,i.good);return-1!==d.indexOf("%2")&&(d=decodeURIComponent(d)),-1!==d.indexOf("%2")&&(d=decodeURIComponent(d)),d},a.built="Sun Mar 05 2023 09:33:48 GMT+0000",r.convert.doc2txt={_bg:!0},r.convert.docx2txt={_bg:!0},r.convert.pdf2txt={_bg:!0},r.puppet={_bg:!0},r.puppet._auth="system",r.puppet._hide=!0}.call(this,i(3),i(0),i(4).Buffer)},function(e,t){var i,s,r=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function l(){throw new Error("clearTimeout has not been defined")}function n(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:a}catch(e){i=a}try{s="function"==typeof clearTimeout?clearTimeout:l}catch(e){s=l}}();var o,u=[],c=!1,h=-1;function p(){c&&o&&(c=!1,o.length?u=o.concat(u):h=-1,u.length&&d())}function d(){if(!c){var e=n(p);c=!0;for(var t=u.length;t;){for(o=u,u=[];++h<t;)o&&o[h].run();h=-1,t=u.length}o=null,c=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===l||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];u.push(new f(e,t)),1!==u.length||c||n(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,i){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var s=i(5),r=i(6),a=i(7);function l(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function n(e,t){if(l()<t)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=o.prototype:(null===e&&(e=new o(t)),e.length=t),e}function o(e,t,i){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return u(this,e,t,i)}function u(e,t,i,s){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,s){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(s||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===s?new Uint8Array(t):void 0===s?new Uint8Array(t,i):new Uint8Array(t,i,s);o.TYPED_ARRAY_SUPPORT?(e=t).__proto__=o.prototype:e=p(e,t);return e}(e,t,i,s):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!o.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var s=0|f(t,i),r=(e=n(e,s)).write(t,i);r!==s&&(e=e.slice(0,r));return e}(e,t,i):function(e,t){if(o.isBuffer(t)){var i=0|d(t.length);return 0===(e=n(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(s=t.length)!=s?n(e,0):p(e,t);if("Buffer"===t.type&&a(t.data))return p(e,t.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(c(t),e=n(e,t<0?0:0|d(t)),!o.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function p(e,t){var i=t.length<0?0:0|d(t.length);e=n(e,i);for(var s=0;s<i;s+=1)e[s]=255&t[s];return e}function d(e){if(e>=l())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l().toString(16)+" bytes");return 0|e}function f(e,t){if(o.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return U(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return z(e).length;default:if(s)return U(e).length;t=(""+t).toLowerCase(),s=!0}}function m(e,t,i){var s=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return D(this,t,i);case"utf8":case"utf-8":return A(this,t,i);case"ascii":return I(this,t,i);case"latin1":case"binary":return j(this,t,i);case"base64":return S(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,i);default:if(s)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),s=!0}}function g(e,t,i){var s=e[t];e[t]=e[i],e[i]=s}function y(e,t,i,s,r){if(0===e.length)return-1;if("string"==typeof i?(s=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=r?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(r)return-1;i=e.length-1}else if(i<0){if(!r)return-1;i=0}if("string"==typeof t&&(t=o.from(t,s)),o.isBuffer(t))return 0===t.length?-1:_(e,t,i,s,r);if("number"==typeof t)return t&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):_(e,[t],i,s,r);throw new TypeError("val must be string, number or Buffer")}function _(e,t,i,s,r){var a,l=1,n=e.length,o=t.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(e.length<2||t.length<2)return-1;l=2,n/=2,o/=2,i/=2}function u(e,t){return 1===l?e[t]:e.readUInt16BE(t*l)}if(r){var c=-1;for(a=i;a<n;a++)if(u(e,a)===u(t,-1===c?0:a-c)){if(-1===c&&(c=a),a-c+1===o)return c*l}else-1!==c&&(a-=a-c),c=-1}else for(i+o>n&&(i=n-o),a=i;a>=0;a--){for(var h=!0,p=0;p<o;p++)if(u(e,a+p)!==u(t,p)){h=!1;break}if(h)return a}return-1}function v(e,t,i,s){i=Number(i)||0;var r=e.length-i;s?(s=Number(s))>r&&(s=r):s=r;var a=t.length;if(a%2!=0)throw new TypeError("Invalid hex string");s>a/2&&(s=a/2);for(var l=0;l<s;++l){var n=parseInt(t.substr(2*l,2),16);if(isNaN(n))return l;e[i+l]=n}return l}function w(e,t,i,s){return J(U(t,e.length-i),e,i,s)}function b(e,t,i,s){return J(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,s)}function x(e,t,i,s){return b(e,t,i,s)}function k(e,t,i,s){return J(z(t),e,i,s)}function O(e,t,i,s){return J(function(e,t){for(var i,s,r,a=[],l=0;l<e.length&&!((t-=2)<0);++l)i=e.charCodeAt(l),s=i>>8,r=i%256,a.push(r),a.push(s);return a}(t,e.length-i),e,i,s)}function S(e,t,i){return 0===t&&i===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,i))}function A(e,t,i){i=Math.min(e.length,i);for(var s=[],r=t;r<i;){var a,l,n,o,u=e[r],c=null,h=u>239?4:u>223?3:u>191?2:1;if(r+h<=i)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(a=e[r+1]))&&(o=(31&u)<<6|63&a)>127&&(c=o);break;case 3:a=e[r+1],l=e[r+2],128==(192&a)&&128==(192&l)&&(o=(15&u)<<12|(63&a)<<6|63&l)>2047&&(o<55296||o>57343)&&(c=o);break;case 4:a=e[r+1],l=e[r+2],n=e[r+3],128==(192&a)&&128==(192&l)&&128==(192&n)&&(o=(15&u)<<18|(63&a)<<12|(63&l)<<6|63&n)>65535&&o<1114112&&(c=o)}null===c?(c=65533,h=1):c>65535&&(c-=65536,s.push(c>>>10&1023|55296),c=56320|1023&c),s.push(c),r+=h}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var i="",s=0;for(;s<t;)i+=String.fromCharCode.apply(String,e.slice(s,s+=4096));return i}(s)}t.Buffer=o,t.SlowBuffer=function(e){+e!=e&&(e=0);return o.alloc(+e)},t.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=l(),o.poolSize=8192,o._augment=function(e){return e.__proto__=o.prototype,e},o.from=function(e,t,i){return u(null,e,t,i)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(e,t,i){return function(e,t,i,s){return c(t),t<=0?n(e,t):void 0!==i?"string"==typeof s?n(e,t).fill(i,s):n(e,t).fill(i):n(e,t)}(null,e,t,i)},o.allocUnsafe=function(e){return h(null,e)},o.allocUnsafeSlow=function(e){return h(null,e)},o.isBuffer=function(e){return!(null==e||!e._isBuffer)},o.compare=function(e,t){if(!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,s=t.length,r=0,a=Math.min(i,s);r<a;++r)if(e[r]!==t[r]){i=e[r],s=t[r];break}return i<s?-1:s<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var s=o.allocUnsafe(t),r=0;for(i=0;i<e.length;++i){var l=e[i];if(!o.isBuffer(l))throw new TypeError('"list" argument must be an Array of Buffers');l.copy(s,r),r+=l.length}return s},o.byteLength=f,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},o.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?A(this,0,e):m.apply(this,arguments)},o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},o.prototype.compare=function(e,t,i,s,r){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===s&&(s=0),void 0===r&&(r=this.length),t<0||i>e.length||s<0||r>this.length)throw new RangeError("out of range index");if(s>=r&&t>=i)return 0;if(s>=r)return-1;if(t>=i)return 1;if(this===e)return 0;for(var a=(r>>>=0)-(s>>>=0),l=(i>>>=0)-(t>>>=0),n=Math.min(a,l),u=this.slice(s,r),c=e.slice(t,i),h=0;h<n;++h)if(u[h]!==c[h]){a=u[h],l=c[h];break}return a<l?-1:l<a?1:0},o.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},o.prototype.indexOf=function(e,t,i){return y(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return y(this,e,t,i,!1)},o.prototype.write=function(e,t,i,s){if(void 0===t)s="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)s=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===s&&(s="utf8")):(s=i,i=void 0)}var r=this.length-t;if((void 0===i||i>r)&&(i=r),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var a=!1;;)switch(s){case"hex":return v(this,e,t,i);case"utf8":case"utf-8":return w(this,e,t,i);case"ascii":return b(this,e,t,i);case"latin1":case"binary":return x(this,e,t,i);case"base64":return k(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return O(this,e,t,i);default:if(a)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),a=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function I(e,t,i){var s="";i=Math.min(e.length,i);for(var r=t;r<i;++r)s+=String.fromCharCode(127&e[r]);return s}function j(e,t,i){var s="";i=Math.min(e.length,i);for(var r=t;r<i;++r)s+=String.fromCharCode(e[r]);return s}function D(e,t,i){var s=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>s)&&(i=s);for(var r="",a=t;a<i;++a)r+=W(e[a]);return r}function C(e,t,i){for(var s=e.slice(t,i),r="",a=0;a<s.length;a+=2)r+=String.fromCharCode(s[a]+256*s[a+1]);return r}function L(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function N(e,t,i,s,r,a){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<a)throw new RangeError('"value" argument is out of bounds');if(i+s>e.length)throw new RangeError("Index out of range")}function P(e,t,i,s){t<0&&(t=65535+t+1);for(var r=0,a=Math.min(e.length-i,2);r<a;++r)e[i+r]=(t&255<<8*(s?r:1-r))>>>8*(s?r:1-r)}function R(e,t,i,s){t<0&&(t=4294967295+t+1);for(var r=0,a=Math.min(e.length-i,4);r<a;++r)e[i+r]=t>>>8*(s?r:3-r)&255}function T(e,t,i,s,r,a){if(i+s>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function E(e,t,i,s,a){return a||T(e,0,i,4),r.write(e,t,i,s,23,4),i+4}function q(e,t,i,s,a){return a||T(e,0,i,8),r.write(e,t,i,s,52,8),i+8}o.prototype.slice=function(e,t){var i,s=this.length;if((e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e),o.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=o.prototype;else{var r=t-e;i=new o(r,void 0);for(var a=0;a<r;++a)i[a]=this[a+e]}return i},o.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||L(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s},o.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||L(e,t,this.length);for(var s=this[e+--t],r=1;t>0&&(r*=256);)s+=this[e+--t]*r;return s},o.prototype.readUInt8=function(e,t){return t||L(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return t||L(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return t||L(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return t||L(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return t||L(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||L(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s>=(r*=128)&&(s-=Math.pow(2,8*t)),s},o.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||L(e,t,this.length);for(var s=t,r=1,a=this[e+--s];s>0&&(r*=256);)a+=this[e+--s]*r;return a>=(r*=128)&&(a-=Math.pow(2,8*t)),a},o.prototype.readInt8=function(e,t){return t||L(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){t||L(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(e,t){t||L(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(e,t){return t||L(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return t||L(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return t||L(e,4,this.length),r.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return t||L(e,4,this.length),r.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return t||L(e,8,this.length),r.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return t||L(e,8,this.length),r.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,i,s){(e=+e,t|=0,i|=0,s)||N(this,e,t,i,Math.pow(2,8*i)-1,0);var r=1,a=0;for(this[t]=255&e;++a<i&&(r*=256);)this[t+a]=e/r&255;return t+i},o.prototype.writeUIntBE=function(e,t,i,s){(e=+e,t|=0,i|=0,s)||N(this,e,t,i,Math.pow(2,8*i)-1,0);var r=i-1,a=1;for(this[t+r]=255&e;--r>=0&&(a*=256);)this[t+r]=e/a&255;return t+i},o.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,1,255,0),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):P(this,e,t,!0),t+2},o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):P(this,e,t,!1),t+2},o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):R(this,e,t,!0),t+4},o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):R(this,e,t,!1),t+4},o.prototype.writeIntLE=function(e,t,i,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*i-1);N(this,e,t,i,r-1,-r)}var a=0,l=1,n=0;for(this[t]=255&e;++a<i&&(l*=256);)e<0&&0===n&&0!==this[t+a-1]&&(n=1),this[t+a]=(e/l>>0)-n&255;return t+i},o.prototype.writeIntBE=function(e,t,i,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*i-1);N(this,e,t,i,r-1,-r)}var a=i-1,l=1,n=0;for(this[t+a]=255&e;--a>=0&&(l*=256);)e<0&&0===n&&0!==this[t+a+1]&&(n=1),this[t+a]=(e/l>>0)-n&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,1,127,-128),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):P(this,e,t,!0),t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):P(this,e,t,!1),t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):R(this,e,t,!0),t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):R(this,e,t,!1),t+4},o.prototype.writeFloatLE=function(e,t,i){return E(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return E(this,e,t,!1,i)},o.prototype.writeDoubleLE=function(e,t,i){return q(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return q(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,s){if(i||(i=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<i&&(s=i),s===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-i&&(s=e.length-t+i);var r,a=s-i;if(this===e&&i<t&&t<s)for(r=a-1;r>=0;--r)e[r+t]=this[r+i];else if(a<1e3||!o.TYPED_ARRAY_SUPPORT)for(r=0;r<a;++r)e[r+t]=this[r+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+a),t);return a},o.prototype.fill=function(e,t,i,s){if("string"==typeof e){if("string"==typeof t?(s=t,t=0,i=this.length):"string"==typeof i&&(s=i,i=this.length),1===e.length){var r=e.charCodeAt(0);r<256&&(e=r)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!o.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var a;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(a=t;a<i;++a)this[a]=e;else{var l=o.isBuffer(e)?e:U(new o(e,s).toString()),n=l.length;for(a=0;a<i-t;++a)this[a+t]=l[a%n]}return this};var M=/[^+\/0-9A-Za-z-_]/g;function W(e){return e<16?"0"+e.toString(16):e.toString(16)}function U(e,t){var i;t=t||1/0;for(var s=e.length,r=null,a=[],l=0;l<s;++l){if((i=e.charCodeAt(l))>55295&&i<57344){if(!r){if(i>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(l+1===s){(t-=3)>-1&&a.push(239,191,189);continue}r=i;continue}if(i<56320){(t-=3)>-1&&a.push(239,191,189),r=i;continue}i=65536+(r-55296<<10|i-56320)}else r&&(t-=3)>-1&&a.push(239,191,189);if(r=null,i<128){if((t-=1)<0)break;a.push(i)}else if(i<2048){if((t-=2)<0)break;a.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;a.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return a}function z(e){return s.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(M,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,i,s){for(var r=0;r<s&&!(r+i>=t.length||r>=e.length);++r)t[r+i]=e[r];return r}}).call(this,i(0))},function(e,t,i){"use strict";t.byteLength=function(e){var t=u(e),i=t[0],s=t[1];return 3*(i+s)/4-s},t.toByteArray=function(e){var t,i,s=u(e),l=s[0],n=s[1],o=new a(function(e,t,i){return 3*(t+i)/4-i}(0,l,n)),c=0,h=n>0?l-4:l;for(i=0;i<h;i+=4)t=r[e.charCodeAt(i)]<<18|r[e.charCodeAt(i+1)]<<12|r[e.charCodeAt(i+2)]<<6|r[e.charCodeAt(i+3)],o[c++]=t>>16&255,o[c++]=t>>8&255,o[c++]=255&t;2===n&&(t=r[e.charCodeAt(i)]<<2|r[e.charCodeAt(i+1)]>>4,o[c++]=255&t);1===n&&(t=r[e.charCodeAt(i)]<<10|r[e.charCodeAt(i+1)]<<4|r[e.charCodeAt(i+2)]>>2,o[c++]=t>>8&255,o[c++]=255&t);return o},t.fromByteArray=function(e){for(var t,i=e.length,r=i%3,a=[],l=0,n=i-r;l<n;l+=16383)a.push(c(e,l,l+16383>n?n:l+16383));1===r?(t=e[i-1],a.push(s[t>>2]+s[t<<4&63]+"==")):2===r&&(t=(e[i-2]<<8)+e[i-1],a.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"="));return a.join("")};for(var s=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0,o=l.length;n<o;++n)s[n]=l[n],r[l.charCodeAt(n)]=n;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function c(e,t,i){for(var r,a,l=[],n=t;n<i;n+=3)r=(e[n]<<16&16711680)+(e[n+1]<<8&65280)+(255&e[n+2]),l.push(s[(a=r)>>18&63]+s[a>>12&63]+s[a>>6&63]+s[63&a]);return l.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(e,t){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read=function(e,t,i,s,r){var a,l,n=8*r-s-1,o=(1<<n)-1,u=o>>1,c=-7,h=i?r-1:0,p=i?-1:1,d=e[t+h];for(h+=p,a=d&(1<<-c)-1,d>>=-c,c+=n;c>0;a=256*a+e[t+h],h+=p,c-=8);for(l=a&(1<<-c)-1,a>>=-c,c+=s;c>0;l=256*l+e[t+h],h+=p,c-=8);if(0===a)a=1-u;else{if(a===o)return l?NaN:1/0*(d?-1:1);l+=Math.pow(2,s),a-=u}return(d?-1:1)*l*Math.pow(2,a-s)},t.write=function(e,t,i,s,r,a){var l,n,o,u=8*a-r-1,c=(1<<u)-1,h=c>>1,p=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,d=s?0:a-1,f=s?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(n=isNaN(t)?1:0,l=c):(l=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-l))<1&&(l--,o*=2),(t+=l+h>=1?p/o:p*Math.pow(2,1-h))*o>=2&&(l++,o/=2),l+h>=c?(n=0,l=c):l+h>=1?(n=(t*o-1)*Math.pow(2,r),l+=h):(n=t*Math.pow(2,h-1)*Math.pow(2,r),l=0));r>=8;e[i+d]=255&n,d+=f,n/=256,r-=8);for(l=l<<r|n,u+=r;u>0;e[i+d]=255&l,d+=f,l/=256,u-=8);e[i+d-f]|=128*m}},function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}}]);