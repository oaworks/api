/*! For license information please see worker.min.js.LICENSE.txt */
(()=>{var e={282:(e,t,i)=>{"use strict";var r=i(155),s=i(108);function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}var l,a,o=i(136).codes,u=o.ERR_AMBIGUOUS_ARGUMENT,c=o.ERR_INVALID_ARG_TYPE,p=o.ERR_INVALID_ARG_VALUE,d=o.ERR_INVALID_RETURN_VALUE,h=o.ERR_MISSING_ARGS,f=i(961),m=i(539).inspect,y=i(539).types,g=y.isPromise,_=y.isRegExp,v=Object.assign?Object.assign:i(91).assign,b=Object.is?Object.is:i(609);function w(){var e=i(158);l=e.isDeepEqual,a=e.isDeepStrictEqual}new Map;var x=!1,O=e.exports=I,k={};function j(e){if(e.message instanceof Error)throw e.message;throw new f(e)}function S(e,t,i,r){if(!i){var s=!1;if(0===t)s=!0,r="No value argument passed to `assert.ok()`";else if(r instanceof Error)throw r;var n=new f({actual:i,expected:!0,message:r,operator:"==",stackStartFn:e});throw n.generatedMessage=s,n}}function I(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];S.apply(void 0,[I,t.length].concat(t))}O.fail=function e(t,i,n,l,a){var o,u=arguments.length;if(0===u?o="Failed":1===u?(n=t,t=void 0):(!1===x&&(x=!0,(r.emitWarning?r.emitWarning:s.warn.bind(s))("assert.fail() with more than one argument is deprecated. Please use assert.strictEqual() instead or only pass a message.","DeprecationWarning","DEP0094")),2===u&&(l="!=")),n instanceof Error)throw n;var c={actual:t,expected:i,operator:void 0===l?"fail":l,stackStartFn:a||e};void 0!==n&&(c.message=n);var p=new f(c);throw o&&(p.message=o,p.generatedMessage=!0),p},O.AssertionError=f,O.ok=I,O.equal=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");t!=i&&j({actual:t,expected:i,message:r,operator:"==",stackStartFn:e})},O.notEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");t==i&&j({actual:t,expected:i,message:r,operator:"!=",stackStartFn:e})},O.deepEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===l&&w(),l(t,i)||j({actual:t,expected:i,message:r,operator:"deepEqual",stackStartFn:e})},O.notDeepEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===l&&w(),l(t,i)&&j({actual:t,expected:i,message:r,operator:"notDeepEqual",stackStartFn:e})},O.deepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===l&&w(),a(t,i)||j({actual:t,expected:i,message:r,operator:"deepStrictEqual",stackStartFn:e})},O.notDeepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");void 0===l&&w(),a(t,i)&&j({actual:t,expected:i,message:r,operator:"notDeepStrictEqual",stackStartFn:e})},O.strictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");b(t,i)||j({actual:t,expected:i,message:r,operator:"strictEqual",stackStartFn:e})},O.notStrictEqual=function e(t,i,r){if(arguments.length<2)throw new h("actual","expected");b(t,i)&&j({actual:t,expected:i,message:r,operator:"notStrictEqual",stackStartFn:e})};var A=function e(t,i,r){var s=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i.forEach((function(e){e in t&&(void 0!==r&&"string"==typeof r[e]&&_(t[e])&&t[e].test(r[e])?s[e]=r[e]:s[e]=t[e])}))};function D(e,t,i,r){if("function"!=typeof t){if(_(t))return t.test(e);if(2===arguments.length)throw new c("expected",["Function","RegExp"],t);if("object"!==n(e)||null===e){var s=new f({actual:e,expected:t,message:i,operator:"deepStrictEqual",stackStartFn:r});throw s.operator=r.name,s}var o=Object.keys(t);if(t instanceof Error)o.push("name","message");else if(0===o.length)throw new p("error",t,"may not be an empty object");return void 0===l&&w(),o.forEach((function(s){"string"==typeof e[s]&&_(t[s])&&t[s].test(e[s])||function(e,t,i,r,s,n){if(!(i in e)||!a(e[i],t[i])){if(!r){var l=new A(e,s),o=new A(t,s,e),u=new f({actual:l,expected:o,operator:"deepStrictEqual",stackStartFn:n});throw u.actual=e,u.expected=t,u.operator=n.name,u}j({actual:e,expected:t,message:r,operator:n.name,stackStartFn:n})}}(e,t,s,i,o,r)})),!0}return void 0!==t.prototype&&e instanceof t||!Error.isPrototypeOf(t)&&!0===t.call({},e)}function C(e){if("function"!=typeof e)throw new c("fn","Function",e);try{e()}catch(e){return e}return k}function L(e){return g(e)||null!==e&&"object"===n(e)&&"function"==typeof e.then&&"function"==typeof e.catch}function N(e){return Promise.resolve().then((function(){var t;if("function"==typeof e){if(!L(t=e()))throw new d("instance of Promise","promiseFn",t)}else{if(!L(e))throw new c("promiseFn",["Function","Promise"],e);t=e}return Promise.resolve().then((function(){return t})).then((function(){return k})).catch((function(e){return e}))}))}function E(e,t,i,r){if("string"==typeof i){if(4===arguments.length)throw new c("error",["Object","Error","Function","RegExp"],i);if("object"===n(t)&&null!==t){if(t.message===i)throw new u("error/message",'The error message "'.concat(t.message,'" is identical to the message.'))}else if(t===i)throw new u("error/message",'The error "'.concat(t,'" is identical to the message.'));r=i,i=void 0}else if(null!=i&&"object"!==n(i)&&"function"!=typeof i)throw new c("error",["Object","Error","Function","RegExp"],i);if(t===k){var s="";i&&i.name&&(s+=" (".concat(i.name,")")),s+=r?": ".concat(r):".";var l="rejects"===e.name?"rejection":"exception";j({actual:void 0,expected:i,operator:e.name,message:"Missing expected ".concat(l).concat(s),stackStartFn:e})}if(i&&!D(t,i,r,e))throw t}function P(e,t,i,r){if(t!==k){if("string"==typeof i&&(r=i,i=void 0),!i||D(t,i)){var s=r?": ".concat(r):".",n="doesNotReject"===e.name?"rejection":"exception";j({actual:t,expected:i,operator:e.name,message:"Got unwanted ".concat(n).concat(s,"\n")+'Actual message: "'.concat(t&&t.message,'"'),stackStartFn:e})}throw t}}function R(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];S.apply(void 0,[R,t.length].concat(t))}O.throws=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];E.apply(void 0,[e,C(t)].concat(r))},O.rejects=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(t).then((function(t){return E.apply(void 0,[e,t].concat(r))}))},O.doesNotThrow=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];P.apply(void 0,[e,C(t)].concat(r))},O.doesNotReject=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(t).then((function(t){return P.apply(void 0,[e,t].concat(r))}))},O.ifError=function e(t){if(null!=t){var i="ifError got unwanted exception: ";"object"===n(t)&&"string"==typeof t.message?0===t.message.length&&t.constructor?i+=t.constructor.name:i+=t.message:i+=m(t);var r=new f({actual:t,expected:null,operator:"ifError",message:i,stackStartFn:e}),s=t.stack;if("string"==typeof s){var l=s.split("\n");l.shift();for(var a=r.stack.split("\n"),o=0;o<l.length;o++){var u=a.indexOf(l[o]);if(-1!==u){a=a.slice(0,u);break}}r.stack="".concat(a.join("\n"),"\n").concat(l.join("\n"))}throw r}},O.strict=v(R,O,{equal:O.strictEqual,deepEqual:O.deepStrictEqual,notEqual:O.notStrictEqual,notDeepEqual:O.notDeepStrictEqual}),O.strict.strict=O.strict},961:(e,t,i)=>{"use strict";var r=i(155);function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return!t||"object"!==d(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,p(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},o(e)}function u(e,t,i){return u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var r=[null];r.push.apply(r,t);var s=new(Function.bind.apply(e,r));return i&&c(s,i.prototype),s},u.apply(null,arguments)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}var h=i(539).inspect,f=i(136).codes.ERR_INVALID_ARG_TYPE;function m(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t}var y="",g="",_="",v="",b={deepStrictEqual:"Expected values to be strictly deep-equal:",strictEqual:"Expected values to be strictly equal:",strictEqualObject:'Expected "actual" to be reference-equal to "expected":',deepEqual:"Expected values to be loosely deep-equal:",equal:"Expected values to be loosely equal:",notDeepStrictEqual:'Expected "actual" not to be strictly deep-equal to:',notStrictEqual:'Expected "actual" to be strictly unequal to:',notStrictEqualObject:'Expected "actual" not to be reference-equal to "expected":',notDeepEqual:'Expected "actual" not to be loosely deep-equal to:',notEqual:'Expected "actual" to be loosely unequal to:',notIdentical:"Values identical but not reference-equal:"};function w(e){var t=Object.keys(e),i=Object.create(Object.getPrototypeOf(e));return t.forEach((function(t){i[t]=e[t]})),Object.defineProperty(i,"message",{value:e.message}),i}function x(e){return h(e,{compact:!1,customInspect:!1,depth:1e3,maxArrayLength:1/0,showHidden:!1,breakLength:1/0,showProxy:!1,sorted:!0,getters:!0})}var O=function(e){function t(e){var i;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),"object"!==d(e)||null===e)throw new f("options","Object",e);var s=e.message,n=e.operator,o=e.stackStartFn,u=e.actual,c=e.expected,h=Error.stackTraceLimit;if(Error.stackTraceLimit=0,null!=s)i=l(this,p(t).call(this,String(s)));else if(r.stderr&&r.stderr.isTTY&&(r.stderr&&r.stderr.getColorDepth&&1!==r.stderr.getColorDepth()?(y="[34m",g="[32m",v="[39m",_="[31m"):(y="",g="",v="",_="")),"object"===d(u)&&null!==u&&"object"===d(c)&&null!==c&&"stack"in u&&u instanceof Error&&"stack"in c&&c instanceof Error&&(u=w(u),c=w(c)),"deepStrictEqual"===n||"strictEqual"===n)i=l(this,p(t).call(this,function(e,t,i){var s="",n="",l=0,a="",o=!1,u=x(e),c=u.split("\n"),p=x(t).split("\n"),h=0,f="";if("strictEqual"===i&&"object"===d(e)&&"object"===d(t)&&null!==e&&null!==t&&(i="strictEqualObject"),1===c.length&&1===p.length&&c[0]!==p[0]){var w=c[0].length+p[0].length;if(w<=10){if(!("object"===d(e)&&null!==e||"object"===d(t)&&null!==t||0===e&&0===t))return"".concat(b[i],"\n\n")+"".concat(c[0]," !== ").concat(p[0],"\n")}else if("strictEqualObject"!==i&&w<(r.stderr&&r.stderr.isTTY?r.stderr.columns:80)){for(;c[0][h]===p[0][h];)h++;h>2&&(f="\n  ".concat(function(e,t){if(t=Math.floor(t),0==e.length||0==t)return"";var i=e.length*t;for(t=Math.floor(Math.log(t)/Math.log(2));t;)e+=e,t--;return e+e.substring(0,i-e.length)}(" ",h),"^"),h=0)}}for(var O=c[c.length-1],k=p[p.length-1];O===k&&(h++<2?a="\n  ".concat(O).concat(a):s=O,c.pop(),p.pop(),0!==c.length&&0!==p.length);)O=c[c.length-1],k=p[p.length-1];var j=Math.max(c.length,p.length);if(0===j){var S=u.split("\n");if(S.length>30)for(S[26]="".concat(y,"...").concat(v);S.length>27;)S.pop();return"".concat(b.notIdentical,"\n\n").concat(S.join("\n"),"\n")}h>3&&(a="\n".concat(y,"...").concat(v).concat(a),o=!0),""!==s&&(a="\n  ".concat(s).concat(a),s="");var I=0,A=b[i]+"\n".concat(g,"+ actual").concat(v," ").concat(_,"- expected").concat(v),D=" ".concat(y,"...").concat(v," Lines skipped");for(h=0;h<j;h++){var C=h-l;if(c.length<h+1)C>1&&h>2&&(C>4?(n+="\n".concat(y,"...").concat(v),o=!0):C>3&&(n+="\n  ".concat(p[h-2]),I++),n+="\n  ".concat(p[h-1]),I++),l=h,s+="\n".concat(_,"-").concat(v," ").concat(p[h]),I++;else if(p.length<h+1)C>1&&h>2&&(C>4?(n+="\n".concat(y,"...").concat(v),o=!0):C>3&&(n+="\n  ".concat(c[h-2]),I++),n+="\n  ".concat(c[h-1]),I++),l=h,n+="\n".concat(g,"+").concat(v," ").concat(c[h]),I++;else{var L=p[h],N=c[h],E=N!==L&&(!m(N,",")||N.slice(0,-1)!==L);E&&m(L,",")&&L.slice(0,-1)===N&&(E=!1,N+=","),E?(C>1&&h>2&&(C>4?(n+="\n".concat(y,"...").concat(v),o=!0):C>3&&(n+="\n  ".concat(c[h-2]),I++),n+="\n  ".concat(c[h-1]),I++),l=h,n+="\n".concat(g,"+").concat(v," ").concat(N),s+="\n".concat(_,"-").concat(v," ").concat(L),I+=2):(n+=s,s="",1!==C&&0!==h||(n+="\n  ".concat(N),I++))}if(I>20&&h<j-2)return"".concat(A).concat(D,"\n").concat(n,"\n").concat(y,"...").concat(v).concat(s,"\n")+"".concat(y,"...").concat(v)}return"".concat(A).concat(o?D:"","\n").concat(n).concat(s).concat(a).concat(f)}(u,c,n)));else if("notDeepStrictEqual"===n||"notStrictEqual"===n){var O=b[n],k=x(u).split("\n");if("notStrictEqual"===n&&"object"===d(u)&&null!==u&&(O=b.notStrictEqualObject),k.length>30)for(k[26]="".concat(y,"...").concat(v);k.length>27;)k.pop();i=1===k.length?l(this,p(t).call(this,"".concat(O," ").concat(k[0]))):l(this,p(t).call(this,"".concat(O,"\n\n").concat(k.join("\n"),"\n")))}else{var j=x(u),S="",I=b[n];"notDeepEqual"===n||"notEqual"===n?(j="".concat(b[n],"\n\n").concat(j)).length>1024&&(j="".concat(j.slice(0,1021),"...")):(S="".concat(x(c)),j.length>512&&(j="".concat(j.slice(0,509),"...")),S.length>512&&(S="".concat(S.slice(0,509),"...")),"deepEqual"===n||"equal"===n?j="".concat(I,"\n\n").concat(j,"\n\nshould equal\n\n"):S=" ".concat(n," ").concat(S)),i=l(this,p(t).call(this,"".concat(j).concat(S)))}return Error.stackTraceLimit=h,i.generatedMessage=!s,Object.defineProperty(a(i),"name",{value:"AssertionError [ERR_ASSERTION]",enumerable:!1,writable:!0,configurable:!0}),i.code="ERR_ASSERTION",i.actual=u,i.expected=c,i.operator=n,Error.captureStackTrace&&Error.captureStackTrace(a(i),o),i.stack,i.name="AssertionError",l(i)}var i,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),i=t,o=[{key:"toString",value:function(){return"".concat(this.name," [").concat(this.code,"]: ").concat(this.message)}},{key:h.custom,value:function(e,t){return h(this,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),r.forEach((function(t){s(e,t,i[t])}))}return e}({},t,{customInspect:!1,depth:0}))}}],o&&n(i.prototype,o),t}(o(Error));e.exports=O},136:(e,t,i)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function n(e,t){return n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,t)}var l,a,o={};function u(e,t,i){i||(i=Error);var l=function(i){function l(i,n,a){var o,u,c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),u=this,c=s(l).call(this,function(e,i,r){return"string"==typeof t?t:t(e,i,r)}(i,n,a)),o=!c||"object"!==r(c)&&"function"!=typeof c?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(u):c,o.code=e,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}(l,i),l}(i);o[e]=l}function c(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map((function(e){return String(e)})),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:2===i?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}u("ERR_AMBIGUOUS_ARGUMENT",'The "%s" argument is ambiguous. %s',TypeError),u("ERR_INVALID_ARG_TYPE",(function(e,t,s){var n,a,o,u,p;if(void 0===l&&(l=i(282)),l("string"==typeof e,"'name' must be a string"),"string"==typeof t&&(a="not ",t.substr(0,4)===a)?(n="must not be",t=t.replace(/^not /,"")):n="must be",function(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-9,i)===t}(e," argument"))o="The ".concat(e," ").concat(n," ").concat(c(t,"type"));else{var d=("number"!=typeof p&&(p=0),p+1>(u=e).length||-1===u.indexOf(".",p)?"argument":"property");o='The "'.concat(e,'" ').concat(d," ").concat(n," ").concat(c(t,"type"))}return o+". Received type ".concat(r(s))}),TypeError),u("ERR_INVALID_ARG_VALUE",(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"is invalid";void 0===a&&(a=i(539));var s=a.inspect(t);return s.length>128&&(s="".concat(s.slice(0,128),"...")),"The argument '".concat(e,"' ").concat(r,". Received ").concat(s)}),TypeError,RangeError),u("ERR_INVALID_RETURN_VALUE",(function(e,t,i){var s;return s=i&&i.constructor&&i.constructor.name?"instance of ".concat(i.constructor.name):"type ".concat(r(i)),"Expected ".concat(e,' to be returned from the "').concat(t,'"')+" function but got ".concat(s,".")}),TypeError),u("ERR_MISSING_ARGS",(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];void 0===l&&(l=i(282)),l(t.length>0,"At least one arg needs to be specified");var s="The ",n=t.length;switch(t=t.map((function(e){return'"'.concat(e,'"')})),n){case 1:s+="".concat(t[0]," argument");break;case 2:s+="".concat(t[0]," and ").concat(t[1]," arguments");break;default:s+=t.slice(0,n-1).join(", "),s+=", and ".concat(t[n-1]," arguments")}return"".concat(s," must be specified")}),TypeError),e.exports.codes=o},158:(e,t,i)=>{"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=[],r=!0,s=!1,n=void 0;try{for(var l,a=e[Symbol.iterator]();!(r=(l=a.next()).done)&&(i.push(l.value),!t||i.length!==t);r=!0);}catch(e){s=!0,n=e}finally{try{r||null==a.return||a.return()}finally{if(s)throw n}}return i}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}var n=void 0!==/a/g.flags,l=function(e){var t=[];return e.forEach((function(e){return t.push(e)})),t},a=function(e){var t=[];return e.forEach((function(e,i){return t.push([i,e])})),t},o=Object.is?Object.is:i(609),u=Object.getOwnPropertySymbols?Object.getOwnPropertySymbols:function(){return[]},c=Number.isNaN?Number.isNaN:i(360);function p(e){return e.call.bind(e)}var d=p(Object.prototype.hasOwnProperty),h=p(Object.prototype.propertyIsEnumerable),f=p(Object.prototype.toString),m=i(539).types,y=m.isAnyArrayBuffer,g=m.isArrayBufferView,_=m.isDate,v=m.isMap,b=m.isRegExp,w=m.isSet,x=m.isNativeError,O=m.isBoxedPrimitive,k=m.isNumberObject,j=m.isStringObject,S=m.isBooleanObject,I=m.isBigIntObject,A=m.isSymbolObject,D=m.isFloat32Array,C=m.isFloat64Array;function L(e){if(0===e.length||e.length>10)return!0;for(var t=0;t<e.length;t++){var i=e.charCodeAt(t);if(i<48||i>57)return!0}return 10===e.length&&e>=Math.pow(2,32)}function N(e){return Object.keys(e).filter(L).concat(u(e).filter(Object.prototype.propertyIsEnumerable.bind(e)))}function E(e,t){if(e===t)return 0;for(var i=e.length,r=t.length,s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0}var P=0,R=1,T=2,q=3;function W(e,t,i,r){if(e===t)return 0!==e||!i||o(e,t);if(i){if("object"!==s(e))return"number"==typeof e&&c(e)&&c(t);if("object"!==s(t)||null===e||null===t)return!1;if(Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1}else{if(null===e||"object"!==s(e))return(null===t||"object"!==s(t))&&e==t;if(null===t||"object"!==s(t))return!1}var l,a,u,p,d=f(e);if(d!==f(t))return!1;if(Array.isArray(e)){if(e.length!==t.length)return!1;var h=N(e),m=N(t);return h.length===m.length&&M(e,t,i,r,R,h)}if("[object Object]"===d&&(!v(e)&&v(t)||!w(e)&&w(t)))return!1;if(_(e)){if(!_(t)||Date.prototype.getTime.call(e)!==Date.prototype.getTime.call(t))return!1}else if(b(e)){if(!b(t)||(u=e,p=t,!(n?u.source===p.source&&u.flags===p.flags:RegExp.prototype.toString.call(u)===RegExp.prototype.toString.call(p))))return!1}else if(x(e)||e instanceof Error){if(e.message!==t.message||e.name!==t.name)return!1}else{if(g(e)){if(i||!D(e)&&!C(e)){if(!function(e,t){return e.byteLength===t.byteLength&&0===E(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new Uint8Array(t.buffer,t.byteOffset,t.byteLength))}(e,t))return!1}else if(!function(e,t){if(e.byteLength!==t.byteLength)return!1;for(var i=0;i<e.byteLength;i++)if(e[i]!==t[i])return!1;return!0}(e,t))return!1;var L=N(e),W=N(t);return L.length===W.length&&M(e,t,i,r,P,L)}if(w(e))return!(!w(t)||e.size!==t.size)&&M(e,t,i,r,T);if(v(e))return!(!v(t)||e.size!==t.size)&&M(e,t,i,r,q);if(y(e)){if(a=t,(l=e).byteLength!==a.byteLength||0!==E(new Uint8Array(l),new Uint8Array(a)))return!1}else if(O(e)&&!function(e,t){return k(e)?k(t)&&o(Number.prototype.valueOf.call(e),Number.prototype.valueOf.call(t)):j(e)?j(t)&&String.prototype.valueOf.call(e)===String.prototype.valueOf.call(t):S(e)?S(t)&&Boolean.prototype.valueOf.call(e)===Boolean.prototype.valueOf.call(t):I(e)?I(t)&&BigInt.prototype.valueOf.call(e)===BigInt.prototype.valueOf.call(t):A(t)&&Symbol.prototype.valueOf.call(e)===Symbol.prototype.valueOf.call(t)}(e,t))return!1}return M(e,t,i,r,P)}function U(e,t){return t.filter((function(t){return h(e,t)}))}function M(e,t,i,n,o,c){if(5===arguments.length){c=Object.keys(e);var p=Object.keys(t);if(c.length!==p.length)return!1}for(var f=0;f<c.length;f++)if(!d(t,c[f]))return!1;if(i&&5===arguments.length){var m=u(e);if(0!==m.length){var y=0;for(f=0;f<m.length;f++){var g=m[f];if(h(e,g)){if(!h(t,g))return!1;c.push(g),y++}else if(h(t,g))return!1}var _=u(t);if(m.length!==_.length&&U(t,_).length!==y)return!1}else{var v=u(t);if(0!==v.length&&0!==U(t,v).length)return!1}}if(0===c.length&&(o===P||o===R&&0===e.length||0===e.size))return!0;if(void 0===n)n={val1:new Map,val2:new Map,position:0};else{var b=n.val1.get(e);if(void 0!==b){var w=n.val2.get(t);if(void 0!==w)return b===w}n.position++}n.val1.set(e,n.position),n.val2.set(t,n.position);var x=function(e,t,i,n,o,u){var c=0;if(u===T){if(!function(e,t,i,r){for(var n=null,a=l(e),o=0;o<a.length;o++){var u=a[o];if("object"===s(u)&&null!==u)null===n&&(n=new Set),n.add(u);else if(!t.has(u)){if(i)return!1;if(!B(e,t,u))return!1;null===n&&(n=new Set),n.add(u)}}if(null!==n){for(var c=l(t),p=0;p<c.length;p++){var d=c[p];if("object"===s(d)&&null!==d){if(!z(n,d,i,r))return!1}else if(!i&&!e.has(d)&&!z(n,d,i,r))return!1}return 0===n.size}return!0}(e,t,i,o))return!1}else if(u===q){if(!function(e,t,i,n){for(var l=null,o=a(e),u=0;u<o.length;u++){var c=r(o[u],2),p=c[0],d=c[1];if("object"===s(p)&&null!==p)null===l&&(l=new Set),l.add(p);else{var h=t.get(p);if(void 0===h&&!t.has(p)||!W(d,h,i,n)){if(i)return!1;if(!J(e,t,p,d,n))return!1;null===l&&(l=new Set),l.add(p)}}}if(null!==l){for(var f=a(t),m=0;m<f.length;m++){var y=r(f[m],2),g=(p=y[0],y[1]);if("object"===s(p)&&null!==p){if(!$(l,e,p,g,i,n))return!1}else if(!(i||e.has(p)&&W(e.get(p),g,!1,n)||$(l,e,p,g,!1,n)))return!1}return 0===l.size}return!0}(e,t,i,o))return!1}else if(u===R)for(;c<e.length;c++){if(!d(e,c)){if(d(t,c))return!1;for(var p=Object.keys(e);c<p.length;c++){var h=p[c];if(!d(t,h)||!W(e[h],t[h],i,o))return!1}return p.length===Object.keys(t).length}if(!d(t,c)||!W(e[c],t[c],i,o))return!1}for(c=0;c<n.length;c++){var f=n[c];if(!W(e[f],t[f],i,o))return!1}return!0}(e,t,i,c,n,o);return n.val1.delete(e),n.val2.delete(t),x}function z(e,t,i,r){for(var s=l(e),n=0;n<s.length;n++){var a=s[n];if(W(t,a,i,r))return e.delete(a),!0}return!1}function F(e){switch(s(e)){case"undefined":return null;case"object":return;case"symbol":return!1;case"string":e=+e;case"number":if(c(e))return!1}return!0}function B(e,t,i){var r=F(i);return null!=r?r:t.has(r)&&!e.has(r)}function J(e,t,i,r,s){var n=F(i);if(null!=n)return n;var l=t.get(n);return!(void 0===l&&!t.has(n)||!W(r,l,!1,s))&&!e.has(n)&&W(r,l,!1,s)}function $(e,t,i,r,s,n){for(var a=l(e),o=0;o<a.length;o++){var u=a[o];if(W(i,u,s,n)&&W(r,t.get(u),s,n))return e.delete(u),!0}return!1}e.exports={isDeepEqual:function(e,t){return W(e,t,!1)},isDeepStrictEqual:function(e,t){return W(e,t,!0)}}},742:(e,t)=>{"use strict";t.byteLength=function(e){var t=a(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,n=a(e),l=n[0],o=n[1],u=new s(function(e,t,i){return 3*(t+i)/4-i}(0,l,o)),c=0,p=o>0?l-4:l;for(i=0;i<p;i+=4)t=r[e.charCodeAt(i)]<<18|r[e.charCodeAt(i+1)]<<12|r[e.charCodeAt(i+2)]<<6|r[e.charCodeAt(i+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;return 2===o&&(t=r[e.charCodeAt(i)]<<2|r[e.charCodeAt(i+1)]>>4,u[c++]=255&t),1===o&&(t=r[e.charCodeAt(i)]<<10|r[e.charCodeAt(i+1)]<<4|r[e.charCodeAt(i+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,s=r%3,n=[],l=16383,a=0,u=r-s;a<u;a+=l)n.push(o(e,a,a+l>u?u:a+l));return 1===s?(t=e[r-1],n.push(i[t>>2]+i[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],n.push(i[t>>10]+i[t>>4&63]+i[t<<2&63]+"=")),n.join("")};for(var i=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0;l<64;++l)i[l]=n[l],r[n.charCodeAt(l)]=l;function a(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function o(e,t,r){for(var s,n,l=[],a=t;a<r;a+=3)s=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),l.push(i[(n=s)>>18&63]+i[n>>12&63]+i[n>>6&63]+i[63&n]);return l.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},764:(e,t,i)=>{"use strict";var r=i(108);const s=i(742),n=i(645),l="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.lW=u,t.h2=50;const a=2147483647;function o(e){if(e>a)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,u.prototype),t}function u(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return d(e)}return c(e,t,i)}function c(e,t,i){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!u.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const i=0|y(e,t);let r=o(i);const s=r.write(e,t);return s!==i&&(r=r.slice(0,s)),r}(e,t);if(ArrayBuffer.isView(e))return function(e){if(Y(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return h(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Y(e,ArrayBuffer)||e&&Y(e.buffer,ArrayBuffer))return f(e,t,i);if("undefined"!=typeof SharedArrayBuffer&&(Y(e,SharedArrayBuffer)||e&&Y(e.buffer,SharedArrayBuffer)))return f(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return u.from(r,t,i);const s=function(e){if(u.isBuffer(e)){const t=0|m(e.length),i=o(t);return 0===i.length||e.copy(i,0,0,t),i}return void 0!==e.length?"number"!=typeof e.length||Z(e.length)?o(0):h(e):"Buffer"===e.type&&Array.isArray(e.data)?h(e.data):void 0}(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return u.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function p(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e){return p(e),o(e<0?0:0|m(e))}function h(e){const t=e.length<0?0:0|m(e.length),i=o(t);for(let r=0;r<t;r+=1)i[r]=255&e[r];return i}function f(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i),Object.setPrototypeOf(r,u.prototype),r}function m(e){if(e>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return 0|e}function y(e,t){if(u.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Y(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const i=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===i)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return V(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return G(e).length;default:if(s)return r?-1:V(e).length;t=(""+t).toLowerCase(),s=!0}}function g(e,t,i){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return L(this,t,i);case"utf8":case"utf-8":return I(this,t,i);case"ascii":return D(this,t,i);case"latin1":case"binary":return C(this,t,i);case"base64":return S(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function _(e,t,i){const r=e[t];e[t]=e[i],e[i]=r}function v(e,t,i,r,s){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Z(i=+i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=u.from(t,r)),u.isBuffer(t))return 0===t.length?-1:b(e,t,i,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):b(e,[t],i,r,s);throw new TypeError("val must be string, number or Buffer")}function b(e,t,i,r,s){let n,l=1,a=e.length,o=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;l=2,a/=2,o/=2,i/=2}function u(e,t){return 1===l?e[t]:e.readUInt16BE(t*l)}if(s){let r=-1;for(n=i;n<a;n++)if(u(e,n)===u(t,-1===r?0:n-r)){if(-1===r&&(r=n),n-r+1===o)return r*l}else-1!==r&&(n-=n-r),r=-1}else for(i+o>a&&(i=a-o),n=i;n>=0;n--){let i=!0;for(let r=0;r<o;r++)if(u(e,n+r)!==u(t,r)){i=!1;break}if(i)return n}return-1}function w(e,t,i,r){i=Number(i)||0;const s=e.length-i;r?(r=Number(r))>s&&(r=s):r=s;const n=t.length;let l;for(r>n/2&&(r=n/2),l=0;l<r;++l){const r=parseInt(t.substr(2*l,2),16);if(Z(r))return l;e[i+l]=r}return l}function x(e,t,i,r){return H(V(t,e.length-i),e,i,r)}function O(e,t,i,r){return H(function(e){const t=[];for(let i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function k(e,t,i,r){return H(G(t),e,i,r)}function j(e,t,i,r){return H(function(e,t){let i,r,s;const n=[];for(let l=0;l<e.length&&!((t-=2)<0);++l)i=e.charCodeAt(l),r=i>>8,s=i%256,n.push(s),n.push(r);return n}(t,e.length-i),e,i,r)}function S(e,t,i){return 0===t&&i===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,i))}function I(e,t,i){i=Math.min(e.length,i);const r=[];let s=t;for(;s<i;){const t=e[s];let n=null,l=t>239?4:t>223?3:t>191?2:1;if(s+l<=i){let i,r,a,o;switch(l){case 1:t<128&&(n=t);break;case 2:i=e[s+1],128==(192&i)&&(o=(31&t)<<6|63&i,o>127&&(n=o));break;case 3:i=e[s+1],r=e[s+2],128==(192&i)&&128==(192&r)&&(o=(15&t)<<12|(63&i)<<6|63&r,o>2047&&(o<55296||o>57343)&&(n=o));break;case 4:i=e[s+1],r=e[s+2],a=e[s+3],128==(192&i)&&128==(192&r)&&128==(192&a)&&(o=(15&t)<<18|(63&i)<<12|(63&r)<<6|63&a,o>65535&&o<1114112&&(n=o))}}null===n?(n=65533,l=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=l}return function(e){const t=e.length;if(t<=A)return String.fromCharCode.apply(String,e);let i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=A));return i}(r)}u.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),u.TYPED_ARRAY_SUPPORT||void 0===r||"function"!=typeof r.error||r.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}}),u.poolSize=8192,u.from=function(e,t,i){return c(e,t,i)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array),u.alloc=function(e,t,i){return function(e,t,i){return p(e),e<=0?o(e):void 0!==t?"string"==typeof i?o(e).fill(t,i):o(e).fill(t):o(e)}(e,t,i)},u.allocUnsafe=function(e){return d(e)},u.allocUnsafeSlow=function(e){return d(e)},u.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==u.prototype},u.compare=function(e,t){if(Y(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),Y(t,Uint8Array)&&(t=u.from(t,t.offset,t.byteLength)),!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let i=e.length,r=t.length;for(let s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);let i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;const r=u.allocUnsafe(t);let s=0;for(i=0;i<e.length;++i){let t=e[i];if(Y(t,Uint8Array))s+t.length>r.length?(u.isBuffer(t)||(t=u.from(t)),t.copy(r,s)):Uint8Array.prototype.set.call(r,t,s);else{if(!u.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,s)}s+=t.length}return r},u.byteLength=y,u.prototype._isBuffer=!0,u.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)_(this,t,t+1);return this},u.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},u.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},u.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?I(this,0,e):g.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){let e="";const i=t.h2;return e=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(e+=" ... "),"<Buffer "+e+">"},l&&(u.prototype[l]=u.prototype.inspect),u.prototype.compare=function(e,t,i,r,s){if(Y(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),!u.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||i>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=i)return 0;if(r>=s)return-1;if(t>=i)return 1;if(this===e)return 0;let n=(s>>>=0)-(r>>>=0),l=(i>>>=0)-(t>>>=0);const a=Math.min(n,l),o=this.slice(r,s),c=e.slice(t,i);for(let e=0;e<a;++e)if(o[e]!==c[e]){n=o[e],l=c[e];break}return n<l?-1:l<n?1:0},u.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},u.prototype.indexOf=function(e,t,i){return v(this,e,t,i,!0)},u.prototype.lastIndexOf=function(e,t,i){return v(this,e,t,i,!1)},u.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}const s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let n=!1;for(;;)switch(r){case"hex":return w(this,e,t,i);case"utf8":case"utf-8":return x(this,e,t,i);case"ascii":case"latin1":case"binary":return O(this,e,t,i);case"base64":return k(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,e,t,i);default:if(n)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),n=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const A=4096;function D(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(127&e[s]);return r}function C(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(e[s]);return r}function L(e,t,i){const r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);let s="";for(let r=t;r<i;++r)s+=K[e[r]];return s}function N(e,t,i){const r=e.slice(t,i);let s="";for(let e=0;e<r.length-1;e+=2)s+=String.fromCharCode(r[e]+256*r[e+1]);return s}function E(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,i,r,s,n){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function R(e,t,i,r,s){B(t,r,s,e,i,7);let n=Number(t&BigInt(4294967295));e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n;let l=Number(t>>BigInt(32)&BigInt(4294967295));return e[i++]=l,l>>=8,e[i++]=l,l>>=8,e[i++]=l,l>>=8,e[i++]=l,i}function T(e,t,i,r,s){B(t,r,s,e,i,7);let n=Number(t&BigInt(4294967295));e[i+7]=n,n>>=8,e[i+6]=n,n>>=8,e[i+5]=n,n>>=8,e[i+4]=n;let l=Number(t>>BigInt(32)&BigInt(4294967295));return e[i+3]=l,l>>=8,e[i+2]=l,l>>=8,e[i+1]=l,l>>=8,e[i]=l,i+8}function q(e,t,i,r,s,n){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function W(e,t,i,r,s){return t=+t,i>>>=0,s||q(e,0,i,4),n.write(e,t,i,r,23,4),i+4}function U(e,t,i,r,s){return t=+t,i>>>=0,s||q(e,0,i,8),n.write(e,t,i,r,52,8),i+8}u.prototype.slice=function(e,t){const i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,u.prototype),r},u.prototype.readUintLE=u.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||E(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return r},u.prototype.readUintBE=u.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||E(e,t,this.length);let r=this[e+--t],s=1;for(;t>0&&(s*=256);)r+=this[e+--t]*s;return r},u.prototype.readUint8=u.prototype.readUInt8=function(e,t){return e>>>=0,t||E(e,1,this.length),this[e]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(e,t){return e>>>=0,t||E(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(e,t){return e>>>=0,t||E(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(e,t){return e>>>=0,t||E(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(e,t){return e>>>=0,t||E(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readBigUInt64LE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,s=this[++e]+256*this[++e]+65536*this[++e]+i*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))})),u.prototype.readBigUInt64BE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],s=this[++e]*2**24+65536*this[++e]+256*this[++e]+i;return(BigInt(r)<<BigInt(32))+BigInt(s)})),u.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||E(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},u.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||E(e,t,this.length);let r=t,s=1,n=this[e+--r];for(;r>0&&(s*=256);)n+=this[e+--r]*s;return s*=128,n>=s&&(n-=Math.pow(2,8*t)),n},u.prototype.readInt8=function(e,t){return e>>>=0,t||E(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){e>>>=0,t||E(e,2,this.length);const i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt16BE=function(e,t){e>>>=0,t||E(e,2,this.length);const i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt32LE=function(e,t){return e>>>=0,t||E(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return e>>>=0,t||E(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readBigInt64LE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(i<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),u.prototype.readBigInt64BE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+i)})),u.prototype.readFloatLE=function(e,t){return e>>>=0,t||E(e,4,this.length),n.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return e>>>=0,t||E(e,4,this.length),n.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return e>>>=0,t||E(e,8,this.length),n.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return e>>>=0,t||E(e,8,this.length),n.read(this,e,!1,52,8)},u.prototype.writeUintLE=u.prototype.writeUIntLE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||P(this,e,t,i,Math.pow(2,8*i)-1,0);let s=1,n=0;for(this[t]=255&e;++n<i&&(s*=256);)this[t+n]=e/s&255;return t+i},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||P(this,e,t,i,Math.pow(2,8*i)-1,0);let s=i-1,n=1;for(this[t+s]=255&e;--s>=0&&(n*=256);)this[t+s]=e/n&255;return t+i},u.prototype.writeUint8=u.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,255,0),this[t]=255&e,t+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigUInt64LE=Q((function(e,t=0){return R(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeBigUInt64BE=Q((function(e,t=0){return T(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);P(this,e,t,i,r-1,-r)}let s=0,n=1,l=0;for(this[t]=255&e;++s<i&&(n*=256);)e<0&&0===l&&0!==this[t+s-1]&&(l=1),this[t+s]=(e/n>>0)-l&255;return t+i},u.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);P(this,e,t,i,r-1,-r)}let s=i-1,n=1,l=0;for(this[t+s]=255&e;--s>=0&&(n*=256);)e<0&&0===l&&0!==this[t+s+1]&&(l=1),this[t+s]=(e/n>>0)-l&255;return t+i},u.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},u.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigInt64LE=Q((function(e,t=0){return R(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeBigInt64BE=Q((function(e,t=0){return T(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeFloatLE=function(e,t,i){return W(this,e,t,!0,i)},u.prototype.writeFloatBE=function(e,t,i){return W(this,e,t,!1,i)},u.prototype.writeDoubleLE=function(e,t,i){return U(this,e,t,!0,i)},u.prototype.writeDoubleBE=function(e,t,i){return U(this,e,t,!1,i)},u.prototype.copy=function(e,t,i,r){if(!u.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);const s=r-i;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,i,r):Uint8Array.prototype.set.call(e,this.subarray(i,r),t),s},u.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;let s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{const n=u.isBuffer(e)?e:u.from(e,r),l=n.length;if(0===l)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<i-t;++s)this[s+t]=n[s%l]}return this};const M={};function z(e,t,i){M[e]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function F(e){let t="",i=e.length;const r="-"===e[0]?1:0;for(;i>=r+4;i-=3)t=`_${e.slice(i-3,i)}${t}`;return`${e.slice(0,i)}${t}`}function B(e,t,i,r,s,n){if(e>i||e<t){const r="bigint"==typeof t?"n":"";let s;throw s=n>3?0===t||t===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(n+1)}${r}`:`>= -(2${r} ** ${8*(n+1)-1}${r}) and < 2 ** ${8*(n+1)-1}${r}`:`>= ${t}${r} and <= ${i}${r}`,new M.ERR_OUT_OF_RANGE("value",s,e)}!function(e,t,i){J(t,"offset"),void 0!==e[t]&&void 0!==e[t+i]||$(t,e.length-(i+1))}(r,s,n)}function J(e,t){if("number"!=typeof e)throw new M.ERR_INVALID_ARG_TYPE(t,"number",e)}function $(e,t,i){if(Math.floor(e)!==e)throw J(e,i),new M.ERR_OUT_OF_RANGE(i||"offset","an integer",e);if(t<0)throw new M.ERR_BUFFER_OUT_OF_BOUNDS;throw new M.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${t}`,e)}z("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),z("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),z("ERR_OUT_OF_RANGE",(function(e,t,i){let r=`The value of "${e}" is out of range.`,s=i;return Number.isInteger(i)&&Math.abs(i)>2**32?s=F(String(i)):"bigint"==typeof i&&(s=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(s=F(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r}),RangeError);const X=/[^+/0-9A-Za-z-_]/g;function V(e,t){let i;t=t||1/0;const r=e.length;let s=null;const n=[];for(let l=0;l<r;++l){if(i=e.charCodeAt(l),i>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(l+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&n.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;n.push(i)}else if(i<2048){if((t-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function G(e){return s.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(X,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function H(e,t,i,r){let s;for(s=0;s<r&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}function Y(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Z(e){return e!=e}const K=function(){const e="0123456789abcdef",t=new Array(256);for(let i=0;i<16;++i){const r=16*i;for(let s=0;s<16;++s)t[r+s]=e[i]+e[s]}return t}();function Q(e){return"undefined"==typeof BigInt?ee:e}function ee(){throw new Error("BigInt not supported")}},924:(e,t,i)=>{"use strict";var r=i(210),s=i(559),n=s(r("String.prototype.indexOf"));e.exports=function(e,t){var i=r(e,!!t);return"function"==typeof i&&n(e,".prototype.")>-1?s(i):i}},559:(e,t,i)=>{"use strict";var r=i(612),s=i(210),n=s("%Function.prototype.apply%"),l=s("%Function.prototype.call%"),a=s("%Reflect.apply%",!0)||r.call(l,n),o=s("%Object.getOwnPropertyDescriptor%",!0),u=s("%Object.defineProperty%",!0),c=s("%Math.max%");if(u)try{u({},"a",{value:1})}catch(e){u=null}e.exports=function(e){var t=a(r,l,arguments);return o&&u&&o(t,"length").configurable&&u(t,"length",{value:1+c(0,e.length-(arguments.length-1))}),t};var p=function(){return a(r,n,arguments)};u?u(e.exports,"apply",{value:p}):e.exports.apply=p},108:(e,t,i)=>{var r=i(539),s=i(282);function n(){return(new Date).getTime()}var l,a=Array.prototype.slice,o={};l=void 0!==i.g&&i.g.console?i.g.console:"undefined"!=typeof window&&window.console?window.console:{};for(var u=[[function(){},"log"],[function(){l.log.apply(l,arguments)},"info"],[function(){l.log.apply(l,arguments)},"warn"],[function(){l.warn.apply(l,arguments)},"error"],[function(e){o[e]=n()},"time"],[function(e){var t=o[e];if(!t)throw new Error("No such label: "+e);delete o[e];var i=n()-t;l.log(e+": "+i+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=r.format.apply(null,arguments),l.error(e.stack)},"trace"],[function(e){l.log(r.inspect(e)+"\n")},"dir"],[function(e){if(!e){var t=a.call(arguments,1);s.ok(!1,r.format.apply(null,t))}},"assert"]],c=0;c<u.length;c++){var p=u[c],d=p[0],h=p[1];l[h]||(l[h]=d)}e.exports=l},289:(e,t,i)=>{"use strict";var r=i(215),s="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),n=Object.prototype.toString,l=Array.prototype.concat,a=Object.defineProperty,o=i(44)(),u=a&&o,c=function(e,t,i,r){if(t in e)if(!0===r){if(e[t]===i)return}else if("function"!=typeof(s=r)||"[object Function]"!==n.call(s)||!r())return;var s;u?a(e,t,{configurable:!0,enumerable:!1,value:i,writable:!0}):e[t]=i},p=function(e,t){var i=arguments.length>2?arguments[2]:{},n=r(t);s&&(n=l.call(n,Object.getOwnPropertySymbols(t)));for(var a=0;a<n.length;a+=1)c(e,n[a],t[n[a]],i[n[a]])};p.supportsDescriptors=!!u,e.exports=p},91:e=>{"use strict";function t(e,t){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var i=Object(e),r=1;r<arguments.length;r++){var s=arguments[r];if(null!=s)for(var n=Object.keys(Object(s)),l=0,a=n.length;l<a;l++){var o=n[l],u=Object.getOwnPropertyDescriptor(s,o);void 0!==u&&u.enumerable&&(i[o]=s[o])}}return i}e.exports={assign:t,polyfill:function(){Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:t})}}},29:(e,t,i)=>{"use strict";var r=i(320),s=Object.prototype.toString,n=Object.prototype.hasOwnProperty;e.exports=function(e,t,i){if(!r(t))throw new TypeError("iterator must be a function");var l;arguments.length>=3&&(l=i),"[object Array]"===s.call(e)?function(e,t,i){for(var r=0,s=e.length;r<s;r++)n.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,l):"string"==typeof e?function(e,t,i){for(var r=0,s=e.length;r<s;r++)null==i?t(e.charAt(r),r,e):t.call(i,e.charAt(r),r,e)}(e,t,l):function(e,t,i){for(var r in e)n.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,l)}},648:e=>{"use strict";var t=Array.prototype.slice,i=Object.prototype.toString;e.exports=function(e){var r=this;if("function"!=typeof r||"[object Function]"!==i.call(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var s,n=t.call(arguments,1),l=Math.max(0,r.length-n.length),a=[],o=0;o<l;o++)a.push("$"+o);if(s=Function("binder","return function ("+a.join(",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var i=r.apply(this,n.concat(t.call(arguments)));return Object(i)===i?i:this}return r.apply(e,n.concat(t.call(arguments)))})),r.prototype){var u=function(){};u.prototype=r.prototype,s.prototype=new u,u.prototype=null}return s}},612:(e,t,i)=>{"use strict";var r=i(648);e.exports=Function.prototype.bind||r},210:(e,t,i)=>{"use strict";var r,s=SyntaxError,n=Function,l=TypeError,a=function(e){try{return n('"use strict"; return ('+e+").constructor;")()}catch(e){}},o=Object.getOwnPropertyDescriptor;if(o)try{o({},"")}catch(e){o=null}var u=function(){throw new l},c=o?function(){try{return u}catch(e){try{return o(arguments,"callee").get}catch(e){return u}}}():u,p=i(405)(),d=i(185)(),h=Object.getPrototypeOf||(d?function(e){return e.__proto__}:null),f={},m="undefined"!=typeof Uint8Array&&h?h(Uint8Array):r,y={"%AggregateError%":"undefined"==typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":p&&h?h([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":f,"%AsyncGenerator%":f,"%AsyncGeneratorFunction%":f,"%AsyncIteratorPrototype%":f,"%Atomics%":"undefined"==typeof Atomics?r:Atomics,"%BigInt%":"undefined"==typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":n,"%GeneratorFunction%":f,"%Int8Array%":"undefined"==typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":p&&h?h(h([][Symbol.iterator]())):r,"%JSON%":"object"==typeof JSON?JSON:r,"%Map%":"undefined"==typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&p&&h?h((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?r:Promise,"%Proxy%":"undefined"==typeof Proxy?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&p&&h?h((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":p&&h?h(""[Symbol.iterator]()):r,"%Symbol%":p?Symbol:r,"%SyntaxError%":s,"%ThrowTypeError%":c,"%TypedArray%":m,"%TypeError%":l,"%Uint8Array%":"undefined"==typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?r:WeakSet};if(h)try{null.error}catch(e){var g=h(h(e));y["%Error.prototype%"]=g}var _=function e(t){var i;if("%AsyncFunction%"===t)i=a("async function () {}");else if("%GeneratorFunction%"===t)i=a("function* () {}");else if("%AsyncGeneratorFunction%"===t)i=a("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(i=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var s=e("%AsyncGenerator%");s&&h&&(i=h(s.prototype))}return y[t]=i,i},v={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},b=i(612),w=i(642),x=b.call(Function.call,Array.prototype.concat),O=b.call(Function.apply,Array.prototype.splice),k=b.call(Function.call,String.prototype.replace),j=b.call(Function.call,String.prototype.slice),S=b.call(Function.call,RegExp.prototype.exec),I=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,A=/\\(\\)?/g,D=function(e,t){var i,r=e;if(w(v,r)&&(r="%"+(i=v[r])[0]+"%"),w(y,r)){var n=y[r];if(n===f&&(n=_(r)),void 0===n&&!t)throw new l("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:i,name:r,value:n}}throw new s("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new l("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new l('"allowMissing" argument must be a boolean');if(null===S(/^%?[^%]*%?$/,e))throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(e){var t=j(e,0,1),i=j(e,-1);if("%"===t&&"%"!==i)throw new s("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==t)throw new s("invalid intrinsic syntax, expected opening `%`");var r=[];return k(e,I,(function(e,t,i,s){r[r.length]=i?k(s,A,"$1"):t||e})),r}(e),r=i.length>0?i[0]:"",n=D("%"+r+"%",t),a=n.name,u=n.value,c=!1,p=n.alias;p&&(r=p[0],O(i,x([0,1],p)));for(var d=1,h=!0;d<i.length;d+=1){var f=i[d],m=j(f,0,1),g=j(f,-1);if(('"'===m||"'"===m||"`"===m||'"'===g||"'"===g||"`"===g)&&m!==g)throw new s("property names with quotes must have matching quotes");if("constructor"!==f&&h||(c=!0),w(y,a="%"+(r+="."+f)+"%"))u=y[a];else if(null!=u){if(!(f in u)){if(!t)throw new l("base intrinsic for "+e+" exists, but the property is not available.");return}if(o&&d+1>=i.length){var _=o(u,f);u=(h=!!_)&&"get"in _&&!("originalValue"in _.get)?_.get:u[f]}else h=w(u,f),u=u[f];h&&!c&&(y[a]=u)}}return u}},296:(e,t,i)=>{"use strict";var r=i(210)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(e){r=null}e.exports=r},44:(e,t,i)=>{"use strict";var r=i(210)("%Object.defineProperty%",!0),s=function(){if(r)try{return r({},"a",{value:1}),!0}catch(e){return!1}return!1};s.hasArrayLengthDefineBug=function(){if(!s())return null;try{return 1!==r([],"length",{value:1}).length}catch(e){return!0}},e.exports=s},185:e=>{"use strict";var t={foo:{}},i=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!({__proto__:null}instanceof i)}},405:(e,t,i)=>{"use strict";var r="undefined"!=typeof Symbol&&Symbol,s=i(419);e.exports=function(){return"function"==typeof r&&"function"==typeof Symbol&&"symbol"==typeof r("foo")&&"symbol"==typeof Symbol("bar")&&s()}},419:e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(e,t);if(42!==s.value||!0!==s.enumerable)return!1}return!0}},410:(e,t,i)=>{"use strict";var r=i(419);e.exports=function(){return r()&&!!Symbol.toStringTag}},642:(e,t,i)=>{"use strict";var r=i(612);e.exports=r.call(Function.call,Object.prototype.hasOwnProperty)},645:(e,t)=>{t.read=function(e,t,i,r,s){var n,l,a=8*s-r-1,o=(1<<a)-1,u=o>>1,c=-7,p=i?s-1:0,d=i?-1:1,h=e[t+p];for(p+=d,n=h&(1<<-c)-1,h>>=-c,c+=a;c>0;n=256*n+e[t+p],p+=d,c-=8);for(l=n&(1<<-c)-1,n>>=-c,c+=r;c>0;l=256*l+e[t+p],p+=d,c-=8);if(0===n)n=1-u;else{if(n===o)return l?NaN:1/0*(h?-1:1);l+=Math.pow(2,r),n-=u}return(h?-1:1)*l*Math.pow(2,n-r)},t.write=function(e,t,i,r,s,n){var l,a,o,u=8*n-s-1,c=(1<<u)-1,p=c>>1,d=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:n-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,l=c):(l=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-l))<1&&(l--,o*=2),(t+=l+p>=1?d/o:d*Math.pow(2,1-p))*o>=2&&(l++,o/=2),l+p>=c?(a=0,l=c):l+p>=1?(a=(t*o-1)*Math.pow(2,s),l+=p):(a=t*Math.pow(2,p-1)*Math.pow(2,s),l=0));s>=8;e[i+h]=255&a,h+=f,a/=256,s-=8);for(l=l<<s|a,u+=s;u>0;e[i+h]=255&l,h+=f,l/=256,u-=8);e[i+h-f]|=128*m}},717:e=>{"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},584:(e,t,i)=>{"use strict";var r=i(410)(),s=i(924)("Object.prototype.toString"),n=function(e){return!(r&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===s(e)},l=function(e){return!!n(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==s(e)&&"[object Function]"===s(e.callee)},a=function(){return n(arguments)}();n.isLegacyArguments=l,e.exports=a?n:l},320:e=>{"use strict";var t,i,r=Function.prototype.toString,s="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof s&&"function"==typeof Object.defineProperty)try{t=Object.defineProperty({},"length",{get:function(){throw i}}),i={},s((function(){throw 42}),null,t)}catch(e){e!==i&&(s=null)}else s=null;var n=/^\s*class\b/,l=function(e){try{var t=r.call(e);return n.test(t)}catch(e){return!1}},a=function(e){try{return!l(e)&&(r.call(e),!0)}catch(e){return!1}},o=Object.prototype.toString,u="function"==typeof Symbol&&!!Symbol.toStringTag,c=!(0 in[,]),p=function(){return!1};if("object"==typeof document){var d=document.all;o.call(d)===o.call(document.all)&&(p=function(e){if((c||!e)&&(void 0===e||"object"==typeof e))try{var t=o.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}e.exports=s?function(e){if(p(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{s(e,null,t)}catch(e){if(e!==i)return!1}return!l(e)&&a(e)}:function(e){if(p(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(u)return a(e);if(l(e))return!1;var t=o.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&a(e)}},662:(e,t,i)=>{"use strict";var r,s=Object.prototype.toString,n=Function.prototype.toString,l=/^\s*(?:function)?\*/,a=i(410)(),o=Object.getPrototypeOf;e.exports=function(e){if("function"!=typeof e)return!1;if(l.test(n.call(e)))return!0;if(!a)return"[object GeneratorFunction]"===s.call(e);if(!o)return!1;if(void 0===r){var t=function(){if(!a)return!1;try{return Function("return function*() {}")()}catch(e){}}();r=!!t&&o(t)}return o(e)===r}},611:e=>{"use strict";e.exports=function(e){return e!=e}},360:(e,t,i)=>{"use strict";var r=i(559),s=i(289),n=i(611),l=i(415),a=i(194),o=r(l(),Number);s(o,{getPolyfill:l,implementation:n,shim:a}),e.exports=o},415:(e,t,i)=>{"use strict";var r=i(611);e.exports=function(){return Number.isNaN&&Number.isNaN(NaN)&&!Number.isNaN("a")?Number.isNaN:r}},194:(e,t,i)=>{"use strict";var r=i(289),s=i(415);e.exports=function(){var e=s();return r(Number,{isNaN:e},{isNaN:function(){return Number.isNaN!==e}}),e}},692:(e,t,i)=>{"use strict";var r=i(430);e.exports=function(e){return!!r(e)}},244:e=>{"use strict";var t=function(e){return e!=e};e.exports=function(e,i){return 0===e&&0===i?1/e==1/i:e===i||!(!t(e)||!t(i))}},609:(e,t,i)=>{"use strict";var r=i(289),s=i(559),n=i(244),l=i(624),a=i(281),o=s(l(),Object);r(o,{getPolyfill:l,implementation:n,shim:a}),e.exports=o},624:(e,t,i)=>{"use strict";var r=i(244);e.exports=function(){return"function"==typeof Object.is?Object.is:r}},281:(e,t,i)=>{"use strict";var r=i(624),s=i(289);e.exports=function(){var e=r();return s(Object,{is:e},{is:function(){return Object.is!==e}}),e}},987:(e,t,i)=>{"use strict";var r;if(!Object.keys){var s=Object.prototype.hasOwnProperty,n=Object.prototype.toString,l=i(414),a=Object.prototype.propertyIsEnumerable,o=!a.call({toString:null},"toString"),u=a.call((function(){}),"prototype"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],p=function(e){var t=e.constructor;return t&&t.prototype===e},d={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},h=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!d["$"+e]&&s.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{p(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();r=function(e){var t=null!==e&&"object"==typeof e,i="[object Function]"===n.call(e),r=l(e),a=t&&"[object String]"===n.call(e),d=[];if(!t&&!i&&!r)throw new TypeError("Object.keys called on a non-object");var f=u&&i;if(a&&e.length>0&&!s.call(e,0))for(var m=0;m<e.length;++m)d.push(String(m));if(r&&e.length>0)for(var y=0;y<e.length;++y)d.push(String(y));else for(var g in e)f&&"prototype"===g||!s.call(e,g)||d.push(String(g));if(o)for(var _=function(e){if("undefined"==typeof window||!h)return p(e);try{return p(e)}catch(e){return!1}}(e),v=0;v<c.length;++v)_&&"constructor"===c[v]||!s.call(e,c[v])||d.push(c[v]);return d}}e.exports=r},215:(e,t,i)=>{"use strict";var r=Array.prototype.slice,s=i(414),n=Object.keys,l=n?function(e){return n(e)}:i(987),a=Object.keys;l.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return s(e)?a(r.call(e)):a(e)})}else Object.keys=l;return Object.keys||l},e.exports=l},414:e=>{"use strict";var t=Object.prototype.toString;e.exports=function(e){var i=t.call(e),r="[object Arguments]"===i;return r||(r="[object Array]"!==i&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===t.call(e.callee)),r}},155:e=>{var t,i,r=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function l(e){if(t===setTimeout)return setTimeout(e,0);if((t===s||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(i){try{return t.call(null,e,0)}catch(i){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:s}catch(e){t=s}try{i="function"==typeof clearTimeout?clearTimeout:n}catch(e){i=n}}();var a,o=[],u=!1,c=-1;function p(){u&&a&&(u=!1,a.length?o=a.concat(o):c=-1,o.length&&d())}function d(){if(!u){var e=l(p);u=!0;for(var t=o.length;t;){for(a=o,o=[];++c<t;)a&&a[c].run();c=-1,t=o.length}a=null,u=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===n||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function f(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];o.push(new h(e,t)),1!==o.length||u||l(d)},h.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},384:e=>{e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},955:(e,t,i)=>{"use strict";var r=i(584),s=i(662),n=i(430),l=i(692);function a(e){return e.call.bind(e)}var o="undefined"!=typeof BigInt,u="undefined"!=typeof Symbol,c=a(Object.prototype.toString),p=a(Number.prototype.valueOf),d=a(String.prototype.valueOf),h=a(Boolean.prototype.valueOf);if(o)var f=a(BigInt.prototype.valueOf);if(u)var m=a(Symbol.prototype.valueOf);function y(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function g(e){return"[object Map]"===c(e)}function _(e){return"[object Set]"===c(e)}function v(e){return"[object WeakMap]"===c(e)}function b(e){return"[object WeakSet]"===c(e)}function w(e){return"[object ArrayBuffer]"===c(e)}function x(e){return"undefined"!=typeof ArrayBuffer&&(w.working?w(e):e instanceof ArrayBuffer)}function O(e){return"[object DataView]"===c(e)}function k(e){return"undefined"!=typeof DataView&&(O.working?O(e):e instanceof DataView)}t.isArgumentsObject=r,t.isGeneratorFunction=s,t.isTypedArray=l,t.isPromise=function(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch},t.isArrayBufferView=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):l(e)||k(e)},t.isUint8Array=function(e){return"Uint8Array"===n(e)},t.isUint8ClampedArray=function(e){return"Uint8ClampedArray"===n(e)},t.isUint16Array=function(e){return"Uint16Array"===n(e)},t.isUint32Array=function(e){return"Uint32Array"===n(e)},t.isInt8Array=function(e){return"Int8Array"===n(e)},t.isInt16Array=function(e){return"Int16Array"===n(e)},t.isInt32Array=function(e){return"Int32Array"===n(e)},t.isFloat32Array=function(e){return"Float32Array"===n(e)},t.isFloat64Array=function(e){return"Float64Array"===n(e)},t.isBigInt64Array=function(e){return"BigInt64Array"===n(e)},t.isBigUint64Array=function(e){return"BigUint64Array"===n(e)},g.working="undefined"!=typeof Map&&g(new Map),t.isMap=function(e){return"undefined"!=typeof Map&&(g.working?g(e):e instanceof Map)},_.working="undefined"!=typeof Set&&_(new Set),t.isSet=function(e){return"undefined"!=typeof Set&&(_.working?_(e):e instanceof Set)},v.working="undefined"!=typeof WeakMap&&v(new WeakMap),t.isWeakMap=function(e){return"undefined"!=typeof WeakMap&&(v.working?v(e):e instanceof WeakMap)},b.working="undefined"!=typeof WeakSet&&b(new WeakSet),t.isWeakSet=function(e){return b(e)},w.working="undefined"!=typeof ArrayBuffer&&w(new ArrayBuffer),t.isArrayBuffer=x,O.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&O(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=k;var j="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function S(e){return"[object SharedArrayBuffer]"===c(e)}function I(e){return void 0!==j&&(void 0===S.working&&(S.working=S(new j)),S.working?S(e):e instanceof j)}function A(e){return y(e,p)}function D(e){return y(e,d)}function C(e){return y(e,h)}function L(e){return o&&y(e,f)}function N(e){return u&&y(e,m)}t.isSharedArrayBuffer=I,t.isAsyncFunction=function(e){return"[object AsyncFunction]"===c(e)},t.isMapIterator=function(e){return"[object Map Iterator]"===c(e)},t.isSetIterator=function(e){return"[object Set Iterator]"===c(e)},t.isGeneratorObject=function(e){return"[object Generator]"===c(e)},t.isWebAssemblyCompiledModule=function(e){return"[object WebAssembly.Module]"===c(e)},t.isNumberObject=A,t.isStringObject=D,t.isBooleanObject=C,t.isBigIntObject=L,t.isSymbolObject=N,t.isBoxedPrimitive=function(e){return A(e)||D(e)||C(e)||L(e)||N(e)},t.isAnyArrayBuffer=function(e){return"undefined"!=typeof Uint8Array&&(x(e)||I(e))},["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},539:(e,t,i)=>{var r=i(155),s=i(108),n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++)i[t[r]]=Object.getOwnPropertyDescriptor(e,t[r]);return i},l=/%[sdj%]/g;t.format=function(e){if(!b(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(c(arguments[i]));return t.join(" ")}i=1;for(var r=arguments,s=r.length,n=String(e).replace(l,(function(e){if("%%"===e)return"%";if(i>=s)return e;switch(e){case"%s":return String(r[i++]);case"%d":return Number(r[i++]);case"%j":try{return JSON.stringify(r[i++])}catch(e){return"[Circular]"}default:return e}})),a=r[i];i<s;a=r[++i])_(a)||!O(a)?n+=" "+a:n+=" "+c(a);return n},t.deprecate=function(e,i){if(void 0!==r&&!0===r.noDeprecation)return e;if(void 0===r)return function(){return t.deprecate(e,i).apply(this,arguments)};var n=!1;return function(){if(!n){if(r.throwDeprecation)throw new Error(i);r.traceDeprecation?s.trace(i):s.error(i),n=!0}return e.apply(this,arguments)}};var a={},o=/^$/;if(r.env.NODE_DEBUG){var u=r.env.NODE_DEBUG;u=u.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+u+"$","i")}function c(e,i){var r={seen:[],stylize:d};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),g(i)?r.showHidden=i:i&&t._extend(r,i),w(r.showHidden)&&(r.showHidden=!1),w(r.depth)&&(r.depth=2),w(r.colors)&&(r.colors=!1),w(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=p),h(r,e,r.depth)}function p(e,t){var i=c.styles[t];return i?"["+c.colors[i][0]+"m"+e+"["+c.colors[i][1]+"m":e}function d(e,t){return e}function h(e,i,r){if(e.customInspect&&i&&S(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(r,e);return b(s)||(s=h(e,s,r)),s}var n=function(e,t){if(w(t))return e.stylize("undefined","undefined");if(b(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return v(t)?e.stylize(""+t,"number"):g(t)?e.stylize(""+t,"boolean"):_(t)?e.stylize("null","null"):void 0}(e,i);if(n)return n;var l=Object.keys(i),a=function(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}(l);if(e.showHidden&&(l=Object.getOwnPropertyNames(i)),j(i)&&(l.indexOf("message")>=0||l.indexOf("description")>=0))return f(i);if(0===l.length){if(S(i)){var o=i.name?": "+i.name:"";return e.stylize("[Function"+o+"]","special")}if(x(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(k(i))return e.stylize(Date.prototype.toString.call(i),"date");if(j(i))return f(i)}var u,c="",p=!1,d=["{","}"];return y(i)&&(p=!0,d=["[","]"]),S(i)&&(c=" [Function"+(i.name?": "+i.name:"")+"]"),x(i)&&(c=" "+RegExp.prototype.toString.call(i)),k(i)&&(c=" "+Date.prototype.toUTCString.call(i)),j(i)&&(c=" "+f(i)),0!==l.length||p&&0!=i.length?r<0?x(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),u=p?function(e,t,i,r,s){for(var n=[],l=0,a=t.length;l<a;++l)C(t,String(l))?n.push(m(e,t,i,r,String(l),!0)):n.push("");return s.forEach((function(s){s.match(/^\d+$/)||n.push(m(e,t,i,r,s,!0))})),n}(e,i,r,a,l):l.map((function(t){return m(e,i,r,a,t,p)})),e.seen.pop(),function(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]}(u,c,d)):d[0]+c+d[1]}function f(e){return"["+Error.prototype.toString.call(e)+"]"}function m(e,t,i,r,s,n){var l,a,o;if((o=Object.getOwnPropertyDescriptor(t,s)||{value:t[s]}).get?a=o.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):o.set&&(a=e.stylize("[Setter]","special")),C(r,s)||(l="["+s+"]"),a||(e.seen.indexOf(o.value)<0?(a=_(i)?h(e,o.value,null):h(e,o.value,i-1)).indexOf("\n")>-1&&(a=n?a.split("\n").map((function(e){return"  "+e})).join("\n").slice(2):"\n"+a.split("\n").map((function(e){return"   "+e})).join("\n")):a=e.stylize("[Circular]","special")),w(l)){if(n&&s.match(/^\d+$/))return a;(l=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(l=l.slice(1,-1),l=e.stylize(l,"name")):(l=l.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),l=e.stylize(l,"string"))}return l+": "+a}function y(e){return Array.isArray(e)}function g(e){return"boolean"==typeof e}function _(e){return null===e}function v(e){return"number"==typeof e}function b(e){return"string"==typeof e}function w(e){return void 0===e}function x(e){return O(e)&&"[object RegExp]"===I(e)}function O(e){return"object"==typeof e&&null!==e}function k(e){return O(e)&&"[object Date]"===I(e)}function j(e){return O(e)&&("[object Error]"===I(e)||e instanceof Error)}function S(e){return"function"==typeof e}function I(e){return Object.prototype.toString.call(e)}function A(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(e=e.toUpperCase(),!a[e])if(o.test(e)){var i=r.pid;a[e]=function(){var r=t.format.apply(t,arguments);s.error("%s %d: %s",e,i,r)}}else a[e]=function(){};return a[e]},t.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=i(955),t.isArray=y,t.isBoolean=g,t.isNull=_,t.isNullOrUndefined=function(e){return null==e},t.isNumber=v,t.isString=b,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=w,t.isRegExp=x,t.types.isRegExp=x,t.isObject=O,t.isDate=k,t.types.isDate=k,t.isError=j,t.types.isNativeError=j,t.isFunction=S,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=i(384);var D=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function C(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){var e,i;s.log("%s - %s",(i=[A((e=new Date).getHours()),A(e.getMinutes()),A(e.getSeconds())].join(":"),[e.getDate(),D[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=i(717),t._extend=function(e,t){if(!t||!O(t))return e;for(var i=Object.keys(t),r=i.length;r--;)e[i[r]]=t[i[r]];return e};var L="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function N(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(L&&e[L]){var t;if("function"!=typeof(t=e[L]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,L,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,r=new Promise((function(e,r){t=e,i=r})),s=[],n=0;n<arguments.length;n++)s.push(arguments[n]);s.push((function(e,r){e?i(e):t(r)}));try{e.apply(this,s)}catch(e){i(e)}return r}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),L&&Object.defineProperty(t,L,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},t.promisify.custom=L,t.callbackify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);var s=t.pop();if("function"!=typeof s)throw new TypeError("The last argument must be of type Function");var n=this,l=function(){return s.apply(n,arguments)};e.apply(this,t).then((function(e){r.nextTick(l.bind(null,null,e))}),(function(e){r.nextTick(N.bind(null,e,l))}))}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,n(e)),t}},430:(e,t,i)=>{"use strict";var r=i(29),s=i(83),n=i(559),l=i(924),a=i(296),o=l("Object.prototype.toString"),u=i(410)(),c="undefined"==typeof globalThis?i.g:globalThis,p=s(),d=l("String.prototype.slice"),h=Object.getPrototypeOf,f=l("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},m={__proto__:null};r(p,u&&a&&h?function(e){var t=new c[e];if(Symbol.toStringTag in t){var i=h(t),r=a(i,Symbol.toStringTag);if(!r){var s=h(i);r=a(s,Symbol.toStringTag)}m["$"+e]=n(r.get)}}:function(e){var t=new c[e];m["$"+e]=n(t.slice)}),e.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!u){var t=d(o(e),8,-1);return f(p,t)>-1?t:"Object"===t&&function(e){var t=!1;return r(m,(function(i,r){if(!t)try{i(e),t=d(r,1)}catch(e){}})),t}(e)}return a?function(e){var t=!1;return r(m,(function(i,r){if(!t)try{"$"+i(e)===r&&(t=d(r,1))}catch(e){}})),t}(e):null}},83:(e,t,i)=>{"use strict";var r=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],s="undefined"==typeof globalThis?i.g:globalThis;e.exports=function(){for(var e=[],t=0;t<r.length;t++)"function"==typeof s[r[t]]&&(e[e.length]=r[t]);return e}}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,i),n.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{"use strict";let e=e=>crypto.getRandomValues(new Uint8Array(e));var t,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,v,b,w,x,O,k,j,S,I,A=i(155),D=i(108),C=i(764).lW,L=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(a in s=JSON.parse(SECRETS_SERVER))r[a]=s[a]}catch(e){}null==r&&(r={}),null==r.name&&(r.name="OA.Works"),null==r.kv&&(r.kv="oaworks"),null==r.version&&(r.version="6.1.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0);try{A.env.name&&A.env.name.endsWith("_async")&&(r.async=!0)}catch(e){}try{A.env.name&&A.env.name.endsWith("_loop")&&(r.async_loop=!0)}catch(e){}try{A.env.name&&A.env.name.endsWith("_schedule")&&(r.async_schedule=!0)}catch(e){}null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.formats&&(r.formats=["html","csv","json"]),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(e){return!1!==r.pass&&e.passThroughOnException(),e.respondWith(t.call(e))}))}catch(e){}l={},n={},t=async function(){var e,s,l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke;this.started=Date.now();try{null==(o=r.headers)[N="x-"+r.name.toLowerCase()]&&(o[N]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(u=this.S).cache&&(u.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),i.g[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(q="",b=0,j=(z=this.request.url.split("?")[1].split("&")).length;b<j;b++)if((x=(M=z[b]).split("="))[0].length){if(1===x.length&&q&&(x[0].startsWith(" ")||x[0].includes("%")))this.params[q]+="&"+decodeURIComponent(x[0]);else{if(this.params[x[0]]=1===x.length||"string"==typeof x[1]&&"true"===x[1].toLowerCase()||("string"!=typeof x[1]||"false"!==x[1].toLowerCase())&&(!!M.endsWith("=")||x[1]),"string"!=typeof this.params[x[0]]||0!==this.params[x[0]].replace(/[0-9]/g,"").length||"0"!==this.params[x[0]]&&this.params[x[0]].startsWith("0")||(O=parseInt(this.params[x[0]]),isNaN(O)||(this.params[x[0]]=O)),"string"==typeof this.params[x[0]]&&this.params[x[0]].includes("%"))try{this.params[x[0]]=decodeURIComponent(this.params[x[0]])}catch(e){}if("string"==typeof this.params[x[0]]&&(this.params[x[0]].startsWith("[")||this.params[x[0]].startsWith("{")))try{this.params[x[0]]=JSON.parse(this.params[x[0]])}catch(e){}}q=x[0]}this.headers={};try{for(F=[...this.request.headers],w=0,S=F.length;w<S;w++)_=F[w],this.headers[_[0].toLowerCase()]=_[1]}catch(e){try{for(v in this.request.headers)this.headers[v.toLowerCase()]=this.request.headers[v]}catch(e){}}if(null==(c=this.headers).ip&&(c.ip=null!=(Q=this.headers["x-real-ip"])?Q:this.headers["x-forwarded-for"]),f=null!=(ce=this.headers["content-type"])?ce:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(f.includes("/json"))this.body=await this.request.json();else if(f.includes("form")){for(y in d={},(await this.request.formData()).entries())y[0]&&(null!=d[y[0]]?(Array.isArray(d[y[0]])||(d[y[0]]=[d[y[0]]]),d[y[0]].push(y[1])):d[y[0]]=y[1]);null!=d&&"{}"!==JSON.stringify(d)&&(this.body=d)}if(null==this.body&&("POST"===(fe=this.request.method)||"PUT"===fe||"DELETE"===fe)){try{d=await this.request.text()}catch(e){}d&&(this.body=d)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(e){}if("object"==typeof this.body&&!Array.isArray(this.body))for(M in this.body)M&&null==(p=this.params)[M]&&(p[M]=this.body[M]);try{this.cookie=null!=(me=this.headers.Cookie)?me:this.headers.cookie}catch(e){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(e){}null==this.rid&&(this.rid=t.uid());try{this.apikey=null!=(ye=null!=(ge=this.headers["x-apikey"])?ge:this.headers.apikey)?ye:this.params.apikey}catch(e){}for(k=0,I=(_e=["x-apikey","apikey"]).length;k<I;k++)xe=_e[k],null!=this.headers[xe]&&delete this.headers[xe],null!=this.params[xe]&&delete this.params[xe];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(e){}this.parts=(null!=m?m:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(e){}this.parts=this.url.length?(null!=m?m:this.url).split("/"):[];try{this.base=this.headers.host}catch(e){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(P=this.parts[this.parts.length-1].split(".").pop().toLowerCase(),L.call(this.S.formats,P)>=0&&(this.format=P,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+P,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(ve=this.parts[0],L.call(this.S.pass,ve)>=0))throw new Error;if(Oe="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[Oe]===this.S.system&&(delete this.headers[Oe],this.system=!0),this._logs=[],this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(B=this.request.method)||"OPTIONS"===B?t._response.call(this,""):t._response.call(this,{name:null!=(J=this.S.name)?J:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=($=null!=(X=this.user)?X.email:void 0)?$:void 0});for(g=void 0,U=[...this.parts],R=void 0,W=[],e=async(i,r,s,l,o)=>{var u,c,p,d,h,f,m,y,_,v,b,w,x,O,k,j,S,I;if(R&&this.fn.startsWith(s))for(;U.length&&null==i[U[0]];)this.params[R]=(this.params[R]?this.params[R]+"/":"")+U.shift(),L.call(W,R)<0&&W.push(R);for(a in j=[],i)if("function"!=(x=typeof i[a])&&"object"!==x)j.push(r[a]=i[a]);else if(null!=i[a]){if(b=s+(s?".":"")+a,"object"!=typeof i[a]||i[a]._index||i[a]._indexed||i[a]._sheet||i[a]._kv||i[a]._bg){if(null==(p=i[a])._auth&&(p._auth=null!=(d=i[a])._auths?d._auths:d._auths=l),Array.isArray(i[a]._auths)&&0===i[a]._auths.length&&(i[a]._auths=b.split(".")),Array.isArray(i[a]._auth)&&0===i[a]._auth.length&&(i[a]._auth=b.split(".")),null==(h=i[a])._cache&&(h._cache=null!=(f=i[a])._caches?f._caches:f._caches=o),b.startsWith("auth")&&null==(m=i[a])._cache&&(m._cache=!1),i[a]._sheet&&null==(y=i[a])._index&&(y._index=!0),i[a]._index)for(w=0,v=(O=["keys","terms","suggest","count","percent","min","max","range","sum","average","mapping","_for","_each","_bulk","_refresh"]).length;w<v;w++)_=O[w],null==(u=i[a])[_]&&(u[_]={_indexed:_,_auth:_.startsWith("_")?"system":i[a]._auth});for(I in"function"!=typeof i[a]||i[a]._index||i[a]._indexed||i[a]._kv||i[a]._bg||b.includes(".")&&!s.startsWith("index")&&!b.split(".").pop().startsWith("_")?r[a]=t._wrapper(i[a],b).bind(this):r[a]=i[a].bind(this),i[a])I.startsWith("_")&&(r[a][I]=i[a][I])}else r[a]=JSON.parse(JSON.stringify(i[a]));null==(c=r[a])._name&&(c._name=b),r[a]._schedule&&!n[b]&&!0===this.S.bg&&!1!==this.S.cron&&(D.log("Adding schedule",r[a]._schedule,b),n[b]={schedule:r[a]._schedule,fn:r[a]},S=e=>async()=>{var t,i,r,s,l,a,o,u,c;if(s=n[e].fn,t=null!=(l=this.S.async_runner)?l[null!=(a=s._runner)?a:e]:void 0,!(!0===this.S.dev||this.S.async||this.S.async_loop||this.S.async_schedule||null==A.env.pm_id||1===(o=A.env.pm_id)||"1"===o))return D.log("NOT running scheduled task because not on dev and process pid is not 1",e,this.datetime());if("string"!=typeof t&&!this.S.async_schedule&&"string"==typeof this.S.async)return D.log("NOT running scheduled task because not on the available async process",e,this.datetime());if(!("string"==typeof t||"string"!=typeof this.S.async_schedule||"loop"===s._schedule&&this.S.async_loop))return D.log("NOT running scheduled task because not on the available async scheduled process",e,this.datetime());if("string"!=typeof t&&"string"==typeof this.S.async_loop&&"loop"===s._schedule)return D.log("NOT running scheduled looped task because not on the available loop process",e,this.datetime());if("string"==typeof t&&A.env.name&&!A.env.name.endsWith((null!=(u=s._runner)?u:e).replace(/\./g,"_").replace("__","_")))return D.log("NOT running scheduled task because not on the specified process runner",null!=(c=s._runner)?c:e,this.datetime());D.log("scheduled task",e,this.datetime()),n[e].last=await this.datetime(),delete n[e].error;try{i=s._sheet?await this._loadsheet(n[e].fn,s._name.replace(/\./g,"_")):await n[e].fn(s._args);try{n[e].result=JSON.stringify(i).substr(0,200)}catch(e){}if(n[e].success=!0,D.log("scheduled task result",i),"loop"===s._schedule)return D.log("Schedule looping",e),(await S(e))()}catch(t){r=t,n[e].success=!1;try{return n[e].error=JSON.stringify(r)}catch(e){}}},"loop"===(k=r[a]._schedule)||"startup"===k?(D.log("Starting scheduled",r[a]._schedule,b),(await S(b))()):cron.schedule(r[a]._schedule,S(b))),a.startsWith("_")||(U.length&&U[0]===a&&this.fn.startsWith(s)&&(R=U.shift(),this.fn+=(""===this.fn?"":".")+R,"function"!=typeof r[a]||s.includes("._")||(g=r[a])),"function"==typeof r[a]&&1===b.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(b.replace(/\./g,"/"))),Array.isArray(i[a])||a.startsWith("_")&&"function"!=typeof r[a]||"fn"===a?j.push(void 0):j.push(e(i[a],r[a],b,null!=l?l:i[a]._auths,null!=o?o:i[a]._caches))}else j.push(void 0);return j},e(t,this,""),R&&U.length&&(this.params[R]=this.params[R]?this.params[R]+"/"+U.join("/"):U.join("/")),E=0,C=W.length;E<C;E++)h=W[E],"true"===this.params[h].toLowerCase()&&(this.params[h]=!0),"false"===this.params[h].toLowerCase()&&(this.params[h]=!1),"string"!=typeof this.params[h]||0!==this.params[h].replace(/[0-9]/g,"").length||this.params[h].startsWith("0")||(T=parseInt(this.params[h]),isNaN(T)||(this.params[h]=T));if(this.S.dev&&!0===this.S.bg&&D.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(V=typeof g)||"function"===V)&&g._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("object"!=(G=typeof g)&&"function"!==G||!(g._async||"all"===this.params.size&&g._index&&!(null!=(H=A.env.name)?H:"").endsWith("_makecsv"))||"string"!=typeof this.S.async||"string"==typeof(null!=(Y=this.S.async_runner)?Y[null!=(Z=g._runner)?Z:this.fn]:void 0)&&A.env.name&&A.env.name.endsWith((null!=(K=g._runner)?K:this.fn).replace(/\./g,"_"))?"function"==typeof g&&("object"==typeof(l="auth"===this.fn?void 0:await this.auth())&&l._id&&l.email&&(this.user=l),(l="function"==typeof g._auth?await g._auth():!0===g._auth&&null!=this.user||!g._auth||await this.auth.role(g._auth))||this.system?"HEAD"===(se=this.request.method)||"OPTIONS"===se?be="":!1!==g._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(be=await this.cache())?(this.cached="cache",(be=new Response(be.body,be)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),be.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(be=await g(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(be={status:401}).body=await this.auth(!1))):(s="all"===this.params.size&&g._index&&(null!=(ee=this.S.async_runner)?ee._makecsv:void 0)?this.S.async_runner._makecsv:null!=(te=null!=(ie=this.S.async_runner)?ie[null!=(re=g._runner)?re:this.fn]:void 0)?te:this.S.async,D.log("Fetching from async process",s,this.request.url),be=await this.fetch(s+this.request.url,{method:this.request.method,headers:this.headers,body:this.request.body}),delete this.format),(null==be||"object"==typeof be&&404===be.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(be=""),we="object"!=typeof be||Array.isArray(be)||"function"!=typeof(null!=(ne=be.headers)?ne.append:void 0)?await this._response(be,g):be,this.parts.length&&"log"!==(le=this.parts[0])&&"status"!==le&&(!this.system||"kv"!==(ae=this.parts[0])&&"index"!==ae)&&"HEAD"!==(oe=this.request.method)&&"OPTIONS"!==oe&&null!=be&&""!==be&&(!this.completed||!1===g._cache||200!==we.status||"object"==typeof be&&!Array.isArray(be)&&0===(null!=(ue=be.hits)?ue.total:void 0)||"number"==typeof be&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(ke=g._cache)||"object"!=typeof be||Array.isArray(be)||null==(null!=(pe=be.hits)?pe.hits:void 0)||(ke=60),this.cache(void 0,we,ke)),"object"!=(de=typeof g)&&"function"!==de||!1===g._log||this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(he=this.request.method)||"OPTIONS"===he)return we;throw new Error},t._response=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k;if(null==(s=this.S).headers&&(s.headers={}),null==e)e=404,O=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(a in e.headers)this.S.headers[a]=e.headers[a];delete e.headers}O=null!=(g=e.status)?g:200,delete e.status,0===(d=this.keys(e)).length?e=O:1===d.length&&(e=e[d[0]])}else O=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&(_=this.format,L.call(this.S.formats,_)>=0)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}if("string"==typeof e&&"html"===this.format&&!(e=e.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(w='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',w+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',e.includes("<title")?([y,k]=e.split("<title"),[k,r]=k.split("</title>"),w+="<title"+k+"</title>\n",e=y+r):e.includes('id="title"')&&(w+="<title>"+e.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),c=0,h=(v=["<meta ","<link "]).length;c<h;c++)if(o=v[c],e.includes(o))for(p=0,f=(b=e.split(o)).length;p<f;p++)x=o+b[p].split(">")[0],e=e.replace(x,""),w+=x+"\n";e.includes("<head>")&&([m,u]=e.split("<head>"),[u,i]=u.split("</head>"),w+=u,e=m+i),w.includes("icon")||(w+='<link rel="icon" href="data:,">'),w+="\n</head>\n",w+=e.includes("<body")?e:"\n<body>\n"+e+"\n</body>\n",e=w+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(n=this.S.headers)["Content-Type"]&&(n["Content-Type"]="application/json; charset=UTF-8")}try{null==(l=this.S.headers)["Content-Length"]&&(l["Content-Length"]=C.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(e){}try{return!0===this.S.bg?{status:O,headers:this.S.headers,body:e}:new Response(e,{status:O,headers:this.S.headers})}catch(t){return{status:O,headers:this.S.headers,body:e}}},t._loadsheet=async function(e,t){var i,r,s,n,l,a;if(e._sheet.startsWith("http")&&e._sheet.includes("csv")?l=await this.convert.csv2json(e._sheet):e._sheet.startsWith("http")&&e._sheet.includes("json")?(l=await this.fetch(e._sheet))&&!Array.isArray(l)&&(l=[l]):l=await this.src.google.sheets(e._sheet),Array.isArray(l)&&l.length){if("function"==typeof e._format&&(l=await e._format.apply(this,[l])),e._key)for(i=0,r=l.length;i<r;i++)null==(a=l[i])._id&&(a._id=(null!=(s=a[e._key])?s:this.uid()).replace(/\//g,"_").toLowerCase());return await this.index(t,""),await this.index(t,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(n=e._index.mappings)?n:e._index.mapping,aliases:e._index.aliases}),await this.index(t,l),l.length}return 0},t._wrapper=function(e,t){return async function(){var i,s,n,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe;if(de=Date.now(),pe=t.replace(/\./g,"_"),S={fn:t},e._limit)for(I=await this.kv("limit/"+t);I;)null==S.limited&&(S.limited=0),S.limited+=I,await this.sleep(I-de),I=await this.kv("limit/"+t);if("string"==(z=typeof this.params._async)||"number"===z)if(ce=await this.kv("async/"+this.params._async,"")){if("string"==typeof ce&&ce.includes("/")&&!ce.includes(" ")&&!ce.includes(":")&&!ce.startsWith("10.")&&2===ce.split("/").length){try{e._kv&&(ce=await this.kv(ce))}catch(e){}try{null==ce&&e._index&&(ce=await this.index(ce))}catch(e){}}try{"string"==typeof ce&&(ce.startsWith("{")||ce.startsWith("["))&&(ce=JSON.parse(ce))}catch(e){}}else ce={_async:this.params._async};else if(this.fn===t&&e._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)ce={status:302},e._sheet.startsWith("http")?ce.body=e._sheet:"json"===this.format?ce.body="https://sheets.googleapis.com/v4/spreadsheets/"+e._sheet.split("/")[0]+"/values/"+(null!=(F=null!=(Q=e._sheetid)?Q:e._sheet.split("/")[1])?F:"Sheet1")+"?alt=json":ce.body="https://docs.google.com/spreadsheets/d/"+e._sheet.split("/")[0],ce.headers={Location:ce.body};else if(e._indexed)(o=[...arguments]).unshift(pe.replace("_"+e._indexed,"")),ce=await this.index[e._indexed](...o);else if((e._index||e._kv)&&(!e._sheet||this.fn!==t||!this.refresh)){if(this.fn===t?(this.fn.replace(/\./g,"/")!==this.route&&(S.key=this.route.split(t.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!S.key&&e._index&&(U=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\*~\?="]/g,"").length&&(S.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(S.key=arguments[0].toString()),e._index&&!S.key&&(U=await this.index.translate(arguments[0],arguments[1])),M=null!=U?void 0:S.key?arguments[1]:e._index?arguments[0]:void 0),"object"==typeof M)if(Array.isArray(M)){if(M.length)for(g=0,w=M.length;g<w;g++)null==(p=M[g])._id&&(p._id=(null!=(ne=p[e._key])?ne:this.uid()).replace(/\//g,"_").toLowerCase())}else null==M._id&&(M._id=(null!=(re=null!=(se=S.key)?se:M[e._key])?re:this.uid()).replace(/\//g,"_").toLowerCase()),null==S.key&&(S.key=M._id.replace(/\//g,"_").toLowerCase());if((null!=M||!this.refresh||"function"!=typeof e)&&(e._kv&&S.key&&null!=(ce=await this.kv(pe+"/"+S.key,M))&&null==M&&(S.cached="kv"),e._index)){if("all"===this.params.size){if(!0!==this.S.bg){if("string"==typeof this.S.bg)throw new Error;ce={status:404}}if(A=null!=(le=null!=(ae=this.params.email)?ae:this.params.notify)?le:null!=(oe=this.user)?oe.email:void 0,this.params.orgkey&&(R=this.params.orgkey,delete this.params.orgkey),E=null!=(ue=this.params.funders)?ue:this.params.flatten,n=null!=(B=this.params.authorships)?B:this.params.flatten,delete U.orgkey,delete U.funders,delete U.authorships,delete U.flatten,delete U.email,delete this.params.size,delete U.size,(fe=await this.index.count(pe,U))>3e6||!(null!=(J=this.S.static)?J.folder:void 0))ce={status:401};else{y=(this.fn?this.fn.replace(/\./g,"_"):"")+"_"+this.uid(),d=this.S.static.url+"/export/"+y+".csv",fe>1e5&&await this.mail({to:null!=($=r.log)?$.notify:void 0,subject:(this.S.dev?"Dev":"Live")+" oa.report creating large csv of size "+fe,text:"Someone is creating a large csv of size "+fe+"\n\n"+d}),N=this.S.static.folder+"/export";try{(f=(await fs.readdir(N)).length)>970&&f%20==0&&this.mail({to:null!=(X=r.log)?X.logs:void 0,subject:(this.S.dev?"Dev":"Live")+" oa.report export file count "+f+"/1000",text:"Info, export file count is "+f+" they will be deleted at 1000"})}catch(e){await fs.mkdir(N),f=0}try{if(f>999){for(V=await fs.readdir(N),_=0,x=V.length;_<x;_++)m=V[_],await fs.unlink(N+"/"+m);this.mail({to:null!=(G=r.log)?G.logs:void 0,subject:(this.S.dev?"Dev":"Live")+" oa.report export file count limit reached, files deleted",text:"Export files had reached 1000 so have been deleted "})}}catch(e){}if(f>1e3)ce={status:401};else{if(N+="/"+y+".csv",await fs.appendFile(N,""),null!=this.params.includes&&(this.params.include=this.params.includes,delete this.params.includes),null!=this.params.excludes&&(this.params.exclude=this.params.excludes,delete this.params.excludes),null!=this.params.include)v="string"==typeof this.params.include?this.params.include.split(","):this.params.include,R&&("string"!=typeof this.params.include||this.params.include.includes("orgs")?Array.isArray(this.params.include)&&L.call(this.params.include,"orgs")<0&&this.params.include.push("orgs"):this.params.include+=",orgs",L.call(U._source.includes,"orgs")<0&&U._source.includes.push("orgs"));else for(v=[],b=0,O=(H=await this.index.keys(pe)).length;b<O;b++)he=H[b].split(".")[0],L.call(v,he)<0&&"_id"!==he&&v.push(he);if(null!=this.params.exclude){for(D=0,k=(Y="string"==typeof this.params.exclude?this.params.exclude.split(","):this.params.exclude).length;D<k;D++)h=Y[D],-1===(P=v.indexOf(h))||R&&"orgs"===h||(v=v.splice(P,1));R&&-1!==(C=U._source.excludes.indexOf("orgs"))&&(U._source.excludes=U._source.excludes.splice(C,1))}A&&await this.mail({to:A,subject:"Your export has started (ref: "+y+".csv)",text:'Your export has started. You can download the file any time, it will keep growing until it is complete, when you will get another notification.<br><br><a href="'+d+'">Download CSV</a><br><br>Thanks'}),s=async(e,t,i,r,s,n,l,o,u)=>{var c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se;if(x=!0,null!=u&&(me=await this.encrypt(u),V=await this.report.orgs.orgkeys('key.keyword:"'+me+'"',1)),l||o){if(r=["DOI"],l)for(G=0,W=(H=["funder.name","funder.award"]).length;G<W;G++)b=H[G],r.push(b);if(o)for(ye=0,U=(Y=["authorships.institutions.display_name","authorships.institutions.ror","authorships.author.orcid","authorships.author.raw_affiliation_string"]).length;ye<U;ye++)b=Y[ye],r.push(b)}for(ve=0,M=r.length;ve<M;ve++)D=r[ve],await fs.appendFile(i,(x?'"':',"')+D.replace("supplements.","")+'"'),x=!1;for(_e=1e5,be=0,z=(Z=["@oa.works","pcastromartin@","wbschmal@","mailparser.io"]).length;be<z;be++)c=Z[be],s&&s.includes(c)&&(_e=3e6);for await(g of this.index._for(e,t,{scroll:"30m",max:_e}))if(await fs.appendFile(i,"\n"),l||o){if(J="",h="",S="",he="",X="",p="",null!=g.funder&&l)for(x=!0,Oe=0,F=(K=g.funder).length;Oe<F;Oe++)J+=(x?"":";")+(null!=(Q=(O=K[Oe]).name)?Q:"").replace(/"/g,""),null!=O.award&&O.award.length&&(O.award=O.award.join(" ")),null==O.award&&(O.award=""),Array.isArray(O.award)&&(O.award.length?O.award=O.award.join(" "):O.award=""),O.award=O.award.replace(/;/g,""),h+=(x?"":";")+O.award,x=!1;if(null!=g.authorships&&o)for(x=!0,ke=0,B=(ee=g.authorships).length;ke<B;ke++){if(x||(S+=";",he+=";"),x=!1,null!=(d=ee[ke]).institutions)for(w=!0,je=0,N=(te=d.institutions).length;je<N;je++)S+=(w?"":",")+(null!=(ie=(j=te[je]).display_name)?ie:"").replace(/"/g,""),he+=(w?"":",")+(null!=(re=j.ror)?re:""),w=!1;(null!=(se=d.author)?se.orcid:void 0)&&(X+=(X?",":"")+d.author.orcid),d.raw_affiliation_string&&(p+=(p?",":"")+d.raw_affiliation_string.replace(/"/g,""))}await fs.appendFile(i,'"'+g.DOI+(l?'","'+J+'","'+h:"")+(o?'","'+S+'","'+he+'","'+X+'","'+p:"")+'"')}else for(x=!0,Se=0,E=r.length;Se<E;Se++){if((a=r[Se]).includes("."))try{f=await this.flatten(g)}catch(e){f=void 0}else f=g;if(Array.isArray(f)){if(f.length&&"object"==typeof f[0]){for(ge=[],k=0,P=f.length;k<P;k++)null!=(null!=(y=f[k])?y[a]:void 0)&&ge.push(y[a]);f=ge}($={})[a]=f,f=$}if(null==f||null==f[a])we="";else if("object"==typeof f[a]){if(Array.isArray(f[a])){for(m="",I=0,R=(ne=f[a]).length;I<R;I++)"object"==typeof(_=ne[I])&&("sheets"===a&&_.url&&("string"==typeof(null!=V?V.org:void 0)&&V.org.length&&V.org===g.name.toLowerCase()||"string"==typeof(null!=(le=this.user)?le.email:void 0)&&this.user.email.endsWith("@oa.works"))&&(_.url=await this.decrypt(_.url)),_=JSON.stringify(_)),m.includes(_)||(m+=(m?";":"")+_);f[a]=m}we=JSON.stringify(f[a])}else we=f[a];if("string"==typeof we&&(we=we.replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")),"sheets.url"===a&&("string"==typeof(null!=V?V.org:void 0)&&V.org.length&&V.org===g.name.toLowerCase()||"string"==typeof(null!=(ae=this.user)?ae.email:void 0)&&this.user.email.endsWith("@oa.works"))){for(v=[],A=0,T=(oe=Array.isArray(we)?we:we.split(",")).length;A<T;A++)xe=oe[A],v.push(await this.decrypt(xe));we=JSON.stringify(v)}else if(("email"===a||"supplements.email"===a)&&!we.includes("@")&&"string"==typeof(null!=V?V.org:void 0)&&V.org.length){for(de=[],C=0,q=(ce=null!=(ue=g.orgs)?ue:[]).length;C<q;C++)fe=ce[C],de.push(fe.toLowerCase());pe=V.org.toLowerCase(),L.call(de,pe)>=0&&(we=await this.decrypt(we))}await fs.appendFile(i,(x?'"':',"')+we+'"'),x=!1}if(s)return await this.mail({to:s,subject:"Your export is complete (ref: "+i.split("/").pop()+")",text:'Your export is complete. We recommend you download and store files elsewhere as soon as possible as we may delete this file at any time.<br><br><a href="'+n+'">Download CSV</a><br><br>Thanks'})},this.waitUntil(s(pe,U,N,v,A,d,E,n,R)),delete this.format,ce=d}}}else ce=await this.index(pe+(S.key?"/"+S.key:""),null!=M?M:U);if(null!=ce||S.key&&null!=M||(await this.index(pe,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(Z=e._index.mappings)?Z:e._index.mapping,aliases:e._index.aliases}),""!==M&&(ce=await this.index(pe+(S.key?"/"+S.key:""),null!=M?M:S.key?void 0:U))),null==ce&&null==M&&S.key&&"string"==typeof arguments[0]&&(U=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(W=await this.index(pe,U))&&null!=(K=W.hits)?K.total:void 0))for(q=0,j=(ee=await this.keys(W.hits.hits[0]._source)).length;q<j;q++)if(a=ee[q],"string"==typeof W.hits.hits[0]._source[a]&&arguments[0]===W.hits.hits[0]._source[a]||Array.isArray(W.hits.hits[0]._source[a])&&(te=arguments[0],L.call(W.hits.hits[0]._source[a],te)>=0)){null==(ce=W.hits.hits[0]._source)._id&&(ce._id=W.hits.hits[0]._id);break}1===(null!=U?U.size:void 0)&&"object"==typeof ce&&null!=(null!=(ie=ce.hits)?ie.hits:void 0)&&(ce.hits.hits.length?(null==(u=ce.hits.hits[0]._source)._id&&(u._id=ce.hits.hits[0]._id),ce=ce.hits.hits[0]._source):ce=void 0)}null!=U&&(S.qry=JSON.stringify(U)),null==ce||null!=M||S.cached||(S.cached="index"),S.cached&&this.fn===t&&(this.cached=S.cached)}return null==ce&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(c={headers:{},body:M,params:this.copy(this.params)},this.refresh&&(c.params.refresh=!0),c.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,ce=await this.fetch(this.S.bg+"/"+pe.replace(/\_/g,"/"),c),S.bg=!0),null==ce&&e._sheet&&""!==M&&(this.refresh&&this.fn===t||!await this.index(pe))&&(ce=await this._loadsheet(e,pe),(arguments.length||"{}"!==JSON.stringify(this.params))&&(ce=void 0)),null!=ce||e._index&&""===M||"function"!=typeof e||(i=async(e,t,i,r,s)=>{var n,a,o,u,c,d,h,f;if(t._limit&&(n=!0===t._limit?86400:t._limit,await this.kv("limit/"+s,de+n,n)),u=await t.apply(this,i),delete l[s],"object"==typeof u&&(t._kv||t._index)&&null==u.took&&null==u.hits){if(t._key&&Array.isArray(u)&&u.length&&null==u[0]._id&&null!=u[0][t._key])for(h=0,o=u.length;h<o;h++)null==(p=u[h])._id&&(p._id=p[t._key].replace(/\//g,"_").toLowerCase());a=Array.isArray(u)?"":"/"+(null!=(c=null!=(d=u[t._key])?d:u._id)?c:this.uid()).replace(/\//g,"_").toLowerCase(),t._kv&&!Array.isArray(u)&&this.kv(e+a,ce,t._kv),t._index&&this.waitUntil(this.index(e+a,u))}return!0===t._limit&&await this.kv("limit/"+s,""),t._async&&"loop"!==t._schedule&&(this.kv("async/"+this.rid,null==a||Array.isArray(u)?Array.isArray(u)?u.length:u:e+a,172800),this.fn===s&&!1!==t._notify&&(f=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(u)+"\n\n"+this.base+"/"+e+"?_async="+this.rid,r&&this.mail({to:r,text:f}))),u},e._async&&this.fn===t?(S.async=!0,e._unique&&(T=l[t])?ce={_async:T}:(e._unique&&(l[this.fn]=this.rid),ce={_async:this.rid},this.waitUntil(i(pe,e,arguments,this.params.notify,t)))):ce=await i(pe,e,arguments)),ce}},t.svc={},t.src={},t.status=async function(){var e,t,s,l,o,u,c,p,d;p={name:r.name,version:r.version,built:r.built};try{p.pmid=A.env.pm_id}catch(e){}try{p.pmname=A.env.name}catch(e){}for(e=0,s=(o=["rid","params","base","parts","opts","routes"]).length;e<s;e++){a=o[e];try{null==p[a]&&(p[a]=this[a])}catch(e){}}if(!0===this.S.bg)try{for(d in p.schedule={},n)for(a in p.schedule[d]={},n[d])"fn"!==a&&(p.schedule[d][a]=n[d][a])}catch(e){}!0===this.S.bg&&(p.bg=!0),p.kv=("string"==typeof this.S.kv&&i.g[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{p.index=await this.index.status()}catch(e){}if(r.dev){if(p.bg=this.S.bg,!0!==this.S.bg)try{p.request=this.request}catch(e){}for(t=0,l=(u=["headers","cookie","user","body"]).length;t<l;t++){a=u[t];try{null==p[a]&&(p[a]=this[a])}catch(e){}}}else{try{p.index=p.index.status}catch(e){}p.kv&&(p.kv=!0),p.user=null!=(c=this.user)?c.email:void 0}return p},L=[].indexOf,t.auth=async function(e){var t,i,s,n,l,a,o,u,c,p,d,h,f;if("string"==typeof e)return this.users._get(e);if(e||null==this.user||"auth"!==this.fn&&!1!==e){if(!1!==e&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(n=this.params.token)?n:this.params.auth),"")))&&((f=await this.users._get(null!=(l=null!=s?s.email:void 0)?l:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(h=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(h))),!f&&(this.params.resume||this.cookie))){if(!(p=this.params.resume))try{p=(t=JSON.parse(decodeURIComponent(this.cookie).split((null!=(a=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?a:"oaworksLogin")+"=")[1].split(";")[0])).resume,h=t._id}catch(e){}null==h&&(h=this.headers["x-id"]),this.params.email&&!h&&(h=this.hashhex(this.params.email.trim().toLowerCase())),p&&h&&await this.kv("auth/resume/"+h+"/"+p)&&null!=(f=await this.users._get(h))&&(f.resume=p)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),e||"html"!==this.format?f:(d="<body>",d+='<script type="text/javascript" src="/client/oaworksLogin.min.js?v='+this.S.version+'"><\/script>\n',d+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(d+='<input autofocus id="OALoginEmail" class="OALoginEmail" type="text" name="email" placeholder="email">',d+='<input id="OALoginToken" class="OALoginToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',d+='<p class="OALoginWelcome" style="display:none;">Welcome back</p>',d+='<p class="OALoginLogout" style="display:none;"><a id="OALoginLogout" href="#">logout</a></p>'):d+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',d+"</body>")},t.auth.token=function(e,t,i,s,n,l,a){var o,u,c;if(null==e&&(e=this.params.email),e)return e=e.trim().toLowerCase(),null==t&&(t=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&D.log(e,c),null==a&&(a=this.params.url),a?(a+="#"+c,null==i&&(i="Complete your login to "+(a.includes("//")?a.split("//")[1]:a).split("/")[0])):(a=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,e,1200),this.waitUntil(this.mail({from:t,to:e,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+a+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=n?n:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+a+'">'+a+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:a}})),{email:e}},t.auth.role=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m;if(null==e&&(e=this.params.role),t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,"system"===e&&this.system)return"system";if((null!=t?t.email:void 0)&&(u=t.email,L.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],u)>=0))return"root";if(e.startsWith("@")&&null!=(null!=t?t.email:void 0)&&t.email.endsWith(e))return e;if(null!=(null!=t?t.roles:void 0))for(n=0,a=(c="string"==typeof e?e.split(","):e||[]).length;n<a;n++){if(r=c[n],[s,m]=r.replace("/",".").split("."),s===t._id)return"owner";if(m){if(L.call(null!=(p=t.roles[s])?p:[],m)>=0)return m;if(null!=t.roles[s]&&-1<(h=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(m)))for(l=0,o=(d=i.splice(0,h)).length;l<o;l++)if(f=d[l],L.call(t.roles[s],f)>=0)return f}}return!1},t.auth.add=async function(e,t,i,r){var s,n,l,a,o,u,c;return t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,!(!e&&this.user._id!==t._id&&!await this.auth.role("system"))&&(null==e&&(e=null!=(l=null!=(a=this.params.add)?a:this.params.remove)?l:this.params.deny),!!e&&([n,c]=e.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==n&&"root"!==c&&(r?(t.roles[n]=["deny"],this.users._update(t)):c?(null!=(o=t.roles)?o[n]:void 0)&&L.call(t.roles[n],c)>=0?null!=i&&(t.roles[n].splice(t.roles[n].indexOf(c),1),t.roles[n].length||delete t.roles[n],this.users._update(t)):("request"!==c||L.call(null!=(u=t.roles[n])?u:[],"deny")<0)&&(null==(s=t.roles)[n]&&(s[n]=[]),L.call(t.roles[n],"request")>=0&&(t.roles[n]=t.roles[n].splice(t.roles[n].indexOf("request"),1)),t.roles.group.push(c),this.users._update(t)):null!=t.roles[n]?null!=i&&(delete t.roles[n],this.users._update(t)):(t.roles[n]=["user"],this.users._update(t)),t)))},t.auth.remove=function(e,t){return this.auth.add(e,t,!0)},t.auth.deny=function(e,t){return this.auth.add(e,t,void 0,!0)},t.auth.request=function(e,t){return null==e&&(e=this.params.request),e=e.split("/")[0]+"/request",this.auth.add(e,t)},t.auth.logout=async function(e){return null==e&&(e=this.user),!!e&&(await this.kv._each("auth/resume/"+("string"==typeof e?e.includes("@")?this.hashhex(e.trim().toLowerCase()):e:e._id),""),!0)},t.auth._oauth=async function(e,t){var i,s,n,l,a,o,u,c,p,d,h,f,m,y;if(e)try{if(y=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(s=this.S.svc[null!=(a=this.params.service)?a:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(p=r.use)&&null!=(d=p.google)&&null!=(h=d.oauth)&&null!=(f=h.client)?f.id:void 0),null!=t&&(null!=(n=y.data)?n.aud:void 0)===t)return{email:(m=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e)).data.email.toLowerCase(),google:{id:m.data.id},name:null!=(l=m.data.name)?l:m.data.given_name+(m.data.family_name?" "+m.data.family_name:""),avatar:m.data.picture}}catch(e){}},t.users={_index:!0,_auth:"system"},t.users._get=async function(e,t){var i,r,s;if(t)1===(null!=(r=await this.index("users",'apikey:"'+t+'"'))&&null!=(i=r.hits)?i.total:void 0)&&null==(s=r.hits.hits[0]._source)._id&&(s._id=r.hits.hits[0]._id);else if("string"==typeof e){if(e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),!0!==this.S.bg)try{s=await this.kv("users/"+e)}catch(e){}if(null==s){try{s=await this.index("users/"+e)}catch(e){}if(null!=s&&!0!==this.S.bg){try{await this.kv("users/"+e,s)}catch(e){}try{await this.kv("auth/apikey/"+s.apikey,e)}catch(e){}}}}return s},t.users._create=async function(e){var t;if("string"==typeof e&&(e={email:e}),"string"!=typeof e.email||!e.email.includes("@"))return!1;t={_id:this.hashhex(e.email.trim().toLowerCase()),email:e.email,apikey:this.uid()},delete e.email;try{t.profile=e}catch(e){}try{t.creation=this.base+"/"+this.route}catch(e){}t.roles={},t.createdAt=new Date;try{await this.kv("users/"+t._id,t)}catch(e){}try{await this.kv("auth/apikey/"+t.apikey,t._id)}catch(e){}try{this.waitUntil(this.index("users/"+t._id,t))}catch(e){}return t},t.users._update=async function(e,t){if("object"==typeof e&&t._id&&null==t&&(e=(t=e)._id),"string"==typeof e&&"object"==typeof t&&"{}"!==JSON.stringify(t)){e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),t.updatedAt=new Date;try{await this.kv("users/"+e,t)}catch(e){}try{this.waitUntil(this.index("users/"+e,t))}catch(e){}return!0}return!1},t.users._delete=async function(e){var t,i;if(i="object"==typeof e?e:(null!=(t=this.user)?t._id:void 0)===e?this.user:await this.users._get(e)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(e){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(e){}try{await this.kv("users/"+i._id,"")}catch(e){}try{return await this.index("users/"+i._id,"")}catch(e){}}},t.deal={_index:!0,_prefix:!1},t.deal.institution={_index:!0,_prefix:!1},t.deal.load=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d;for(t={},r=0,n=(c=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;r<n;r++){for(u=c[r],s=0,l=(p=["Institution","Publisher","Collection","Year(s)","Length of Agreement","Package Price","2015 Carnegie Basic Classification","FTE","Source","URL","Share URL Publicly?","Notes"]).length;s<l;s++)u[(d=p[s]).toLowerCase().replace(/ /g,"").replace("?","").replace("(","").replace(")","")]=u[d],delete u[d];try{if(u.value=parseInt(u.packageprice.replace(/[^0-9]/g,"")),"string"==typeof u.fte)try{u.fte=parseInt(u.fte)}catch(e){delete u.fte}"string"==typeof u.notes&&u.notes.toLowerCase().includes("canadian")?(u.gbpvalue=Math.floor(.57*u.value),u.usdvalue=Math.floor(.75*u.value)):u.packageprice.includes("$")?(u.gbpvalue=Math.floor(.77*u.value),u.usdvalue=Math.floor(u.value)):(u.gbpvalue=Math.floor(u.value),u.usdvalue=Math.floor(1.3*u.value))}catch(e){}null==u.usdvalue&&(u.usdvalue="");try{"2103"===u.years&&(u.years="2013")}catch(e){}try{"yes"!==u.shareurlpublicly.toLowerCase()&&delete u.url}catch(e){}try{delete u.shareurlpublicly}catch(e){}try{""===u.collection&&(u.collection="Unclassified")}catch(e){}try{u.carnegiebasicclassification=u["2015carnegiebasicclassification"],delete u["2015carnegiebasicclassification"]}catch(e){}try{null==t[a=u.institution]&&(t[a]={institution:u.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),o=JSON.parse(JSON.stringify(u));try{delete o.institution}catch(e){}try{t[u.institution].value+=u.value,t[u.institution].gbpvalue+=u.gbpvalue,t[u.institution].usdvalue+=u.usdvalue}catch(e){}t[u.institution].deals.push(o)}catch(e){}}for(e in i=[],t)i.push(t[e]);return await this.deal(""),await this.deal.institution(""),await this.deal(c),await this.deal.institution(i),{retrieved:c.length,institutions:i.length}},L=[].indexOf,t.deposits={_index:!0,_auth:"@oa.works"},t.undep=function(){return this.deposits("")},t.deposit=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae;for(null==e&&(e=this.copy(this.params)),(null!=(A=e.metadata)?A.doi:void 0)&&!e.doi&&(e.doi=e.metadata.doi),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),null==i&&(i=this.S.dev),(p={createdAt:Date.now()}).created_date=await this.datetime(p.createdAt),h=0,g=(D=["embedded","demo","pilot","live","email","plugin"]).length;h<g;h++)p[y=D[h]]=e[y];!0===p.pilot&&(p.pilot=Date.now()),!0===p.live&&(p.live=Date.now()),p.name=null!=(z=null!=t?t.filename:void 0)?z:null!=t?t.name:void 0,"anonymous"!==e.from&&(p.from=e.from),e.confirmed&&(p.confirmed=decodeURIComponent(e.confirmed)),p.doi=null!=(K=e.doi)?K:null!=(ue=e.metadata)?ue.doi:void 0;try{null==e.metadata&&e.doi&&(e.metadata=await this.metadata(e.doi))}catch(e){}try{null==e.metadata&&e.doi&&(e.metadata=await this.metadata_internal(e.doi))}catch(e){}if(p.metadata=e.metadata,je=e.config,"string"==typeof e.config&&(je=JSON.parse(e.config)),!e.config&&e.from&&(je=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from),(null!=(ge=this.S.log)?ge.logs:void 0)&&"mark+instantilldemo@cottagelabs.com"===je.owner&&(je.owner=this.S.log.logs),(null!=(_e=this.S.log)?_e.logs:void 0)&&"mark+instantilldemo@cottagelabs.com"===je.email&&(je.email=this.S.log.logs)),p.permissions=null!=(ve=e.permissions)?ve:await this.permissions(null!=(be=e.metadata)?be:e.doi),e.redeposit||(null==t&&e.email&&null!=e.metadata?p.type="dark":(p.archivable=await this.archivable(t,void 0,p.confirmed,e.metadata,p.permissions,i),null!=(null!=(we=p.archivable)?we.metadata:void 0)&&delete p.archivable.metadata)),(null!=(C=p.archivable)?C.archivable:void 0)&&(!p.confirmed||p.confirmed===p.archivable.checksum)){for((Ie={content:t.data,name:p.archivable.name}).publish=!0,c=[],m=0,_=(P=null!=(N=null!=(E=e.metadata)?E.author:void 0)?N:[]).length;m<_;m++)if(null!=(r=P[m]).family){n={name:r.family+(r.given?", "+r.given:"")};try{r.ORCID&&(n.orcid=r.ORCID.split("/").pop())}catch(e){}try{"object"==typeof r.affiliation&&null!=r.affiliation.name&&(n.affiliation=r.affiliation.name)}catch(e){}c.push(n)}0===c.length&&(c=[{name:"Unknown"}]),d=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(d=(d+=null!=(R=null!=(T=p.permissions.best_permission)?T.deposit_statement:void 0)?R:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+e.metadata.doi:"").trim()).lastIndexOf(".")!==d.length-1&&(d+="."),d.length&&(d+=" "),d+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",x={title:null!=(q=e.metadata.title)?q:"Unknown",description:d.trim(),creators:c,version:"submittedVersion"===p.archivable.version?"Submitted Version":"acceptedVersion"===p.archivable.version?"Accepted Version":"publishedVersion"===p.archivable.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},e.doi&&((null!=(Ae=await this.src.zenodo.records.search('"'+e.doi+'"',i))&&null!=(W=Ae.hits)?W.total:void 0)&&(f=Ae.hits.hits[0]),f&&p.confirmed!==p.archivable.checksum&&!i?p.zenodo={already:f.id}:x.related_identifiers=[{relation:"postprint"===x.version||"AAM"===x.version||"preprint"===x.version?"isPreviousVersionOf":"isIdenticalTo",identifier:e.doi}]),x.prereserve_doi=!0,x.access_right="open",x.license=null!=(U=null!=(M=p.permissions.best_permission)?M.licence:void 0)?U:"cc-by",x.license.includes("other")&&x.license.includes("closed")&&(x.license="other-closed"),x.license.includes("other")&&x.license.includes("non")&&x.license.includes("commercial")&&(x.license="other-nc"),x.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(x.license.substring(x.license.length-1)))&&(x.license+="-4.0");try{(null!=(F=p.permissions.best_permission)?F.embargo_end:void 0)&&await this.epoch(p.permissions.best_permission.embargo_end)>Date.now()&&(x.access_right="embargoed",x.embargo_date=p.permissions.best_permission.embargo_end,p.embargo=p.permissions.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(x.publication_date=e.metadata.published)}catch(e){}if(null!=je){if(p.config=je,null!=je.community_ID&&null==je.community&&(je.community=je.community_ID),je.community)for(null==je.communities&&(je.communities=[]),k=0,v=(B="string"==typeof je.community?je.community.split(","):je.community).length;k<v;k++)o=B[k],je.communities.push({identifier:o});if(null!=je.community||null!=je.communities)for(null==je.communities&&(je.communities=je.community),Array.isArray(je.communities)||(je.communities=[je.communities]),x.communities=[],j=0,b=(J=je.communities).length;j<b;j++)u=J[j],x.communities.push("string"==typeof u?{identifier:u}:u);x.communities&&x.communities.length&&(p.community=x.communities[0].identifier)}if(xe=i||p.demo?null!=($=this.S.src.zenodo)?$.sandbox:void 0:null!=(X=this.S.src.zenodo)?X.token:void 0){if(!(null!=(V=p.zenodo)?V.already:void 0))if((Se=await this.src.zenodo.deposition.create(x,Ie,xe,i)).id)p.zenodo={id:Se.id,url:"https://"+(i||p.demo?"sandbox.":"")+"zenodo.org/record/"+Se.id,doi:null!=(null!=(G=Se.metadata)&&null!=(H=G.prereserve_doi)?H.doi:void 0)?Se.metadata.prereserve_doi.doi:void 0,file:null!=(Y=null!=(Z=Se.uploaded)&&null!=(Q=Z.links)?Q.download:void 0)?Y:null!=(ee=Se.uploaded)&&null!=(te=ee.links)?te.download:void 0},null==p.doi&&(p.doi=p.zenodo.doi),p.type="zenodo";else{p.error="Deposit to Zenodo failed";try{p.error+=": "+JSON.stringify(Se)}catch(e){}p.type="review"}}else p.error="No Zenodo credentials available",p.type="review"}if((null!=(ie=p.archivable)?ie.timeout:void 0)&&(p.error="Archivable timeout",p.type="review"),p.version=null!=(re=p.archivable)?re.version:void 0,p.type||!e.from||p.embedded&&(p.embedded.includes("oa.works")||p.embedded.includes("openaccessbutton.org")||p.embedded.includes("shareyourpaper.org"))||(p.type=e.redeposit?"redeposit":t?"forward":"dark"),p.doi&&(null==p.type&&(p.type="review"),p.url="string"==typeof e.redeposit?e.redeposit:e.url?e.url:void 0,await this.deposits(p),("review"!==p.type||null!=t)&&!1!==(null!=(se=p.archivable)?se.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(ne=exists.zenodo)?ne.already:void 0)||i))){for(a=[null!=(le=this.S.log)?le.logs:void 0,"shared@oa.works"],ke=[],"string"==typeof(null!=je?je.owner:void 0)&&je.owner.includes("@")&&!p.error?ke.push(je.owner):(null!=je?je.email:void 0)&&ke.push(je.email),0===ke.length&&(ke=await this.copy(a),a=[]),s=[],S=0,w=(ce=null!=(ae=null!=(oe=p.metadata)?oe.author:void 0)?ae:[]).length;S<w;S++)(l=ce[S]).family&&s.push((l.given?l.given+" ":"")+l.family);p.metadata.author=s,p.adminlink=p.embedded?p.embedded:"https://shareyourpaper.org"+(p.metadata.doi?"/"+p.metadata.doi:""),p.adminlink+=p.adminlink.includes("?")?"&":"?",null!=(null!=(pe=p.archivable)?pe.checksum:void 0)&&(p.confirmed=encodeURIComponent(p.archivable.checksum),p.adminlink+="confirmed="+p.confirmed+"&"),de=p.email,L.call(p.adminlink,de)<0&&(p.adminlink+="email="+p.email),Oe=await this.templates(p.type+"_deposit"),I=await this.template(Oe.content,p),delete p.adminlink,delete p.confirmed,O={from:"deposits@oa.works",to:ke,subject:null!=(he=I.subject)?he:p.type+" deposit",html:I.content},a&&a.length&&(O.bcc=a),t&&(O.attachment={file:t.data,filename:null!=(fe=null!=(me=null!=(ye=p.archivable)?ye.name:void 0)?me:t.name)?fe:t.filename}),await this.mail(O)}if(p.embargo)try{p.embargo_UI=new Date(p.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(e){}return p},t.deposit._bg=!0,t.archivable=async function(e,t,i,r,s,n){var l,a,o;for(null==n&&(n=this.S.dev),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),a={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},l=async()=>{var l,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,L,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z;if(("string"==typeof r||null==r&&(this.params.doi||this.params.title))&&(r=await _internal(null!=(L=null!=r?r:this.params.doi)?L:this.params.title)),null==r&&(r={}),"string"==typeof e&&(e={data:e}),null==e&&null!=t&&(e=await this.fetch(t)),null!=e){null==e.name&&(e.name=e.filename);try{a.name=e.name}catch(e){}try{a.format=null!=e.name&&e.name.includes(".")?e.name.split(".").pop():"html"}catch(e){}if(a.format=a.format.toLowerCase(),e.data){if(null==d&&null!=a.format&&null!=this.convert[a.format+"2txt"])try{d=await this.convert[a.format+"2txt"](e.data)}catch(e){}try{null==d&&(d=e.data)}catch(e){}try{d=d.toString()}catch(e){}}}if(null!=d||i){S=((j=(h=d.length<2e4?d:d.substring(0,6e3)+d.substring(d.length-6e3,d.length)).toLowerCase()).length<6e3?j:j.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==a.name&&(a.name=r.title);try{a.checksum=crypto.createHash("md5").update(d,"utf8").digest("base64")}catch(e){}a.same_paper_evidence={};try{a.same_paper_evidence.words_count=d.split(" ").length}catch(e){}try{a.same_paper_evidence.words_more_than_threshold=a.same_paper_evidence.words_count>500}catch(e){}try{a.same_paper_evidence.doi_match=!(!r.doi||!S.includes(r.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}try{a.same_paper_evidence.title_match=!(!r.title||!S.includes(r.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}if(null!=r.author)try{for(c=0,a.same_paper_evidence.author_match=!1,"string"==typeof r.author&&(r.author={name:r.author}),Array.isArray(r.author)||(r.author=[r.author]),M=r.author,g=0,x=M.length;g<x&&(l=M[g],!0!==a.same_paper_evidence.author_match);g++)try{if(u=(null!=(z=null!=(F=null!=(B=null!=(J=l.last)?J:l.lastname)?B:l.family)?F:l.surname)?z:l.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),o=(null!=($=null!=(X=null!=(V=l.first)?V:l.firstname)?X:l.given)?$:l.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),_=S.indexOf(u),u.length>2&&o.length>0&&-1!==_&&S.substring(_-20,_+u.length+20).includes(o)&&(c+=1,r.author.length<3&&1===c||r.author.length>2&&c>1)){a.same_paper_evidence.author_match=!0;break}}catch(e){}}catch(e){}if(null!=a.format)for(b=0,O=(E=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;b<O;b++)if(m=E[b],a.format.includes(m)){a.same_paper_evidence.document_format=!0;break}a.same_paper=!!(a.same_paper_evidence.words_more_than_threshold&&(a.same_paper_evidence.doi_match||a.same_paper_evidence.title_match||a.same_paper_evidence.author_match)&&a.same_paper_evidence.document_format),a.same_paper_evidence.words_count<150&&"pdf"===a.format&&(a.same_paper_evidence.words_count=0,a.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),a.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(P=await this.src.google.sheets(n?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),D=0,k=P.length;D<k;D++){w=P[D],a.version_evidence.strings_checked+=1,Z=w["what to search"],G=w["where to search"],y=w["how to search"],v=w["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&(Y=Z.split("<<")[1].split(">>")[0],null!=r[Y.toLowerCase()]&&(Z=Z.replace("<<"+Y+">>",r[Y.toLowerCase()]))),A=!1,"string"===y?A=!!("file"===G&&h.includes(Z)||"file"!==G&&(null!=r.title&&r.title.includes(Z)||null!=a.name&&a.name.includes(Z))):(C=new RegExp(Z,"gium"),A="file"===G&&null!==j.match(C)||"file"!==G&&(null!=r.title&&null!==r.title.match(C)||null!=a.name&&null!==a.name.match(C))),A){if("string"==typeof(H=w.value))try{H=parseInt(H)}catch(e){}"number"!=typeof H&&(H=1),!v||"publisher pdf"!==(R=v.toLowerCase())&&"publishedversion"!==R?a.version_evidence.score-=H:a.version_evidence.score+=H,a.version_evidence.strings_matched.push({indicates:v,found:y+" "+Z,in:G,score_value:H})}}catch(e){f=e,null==(p=a.version_evidence).strings_errored&&(p.strings_errored=[]),a.version_evidence.strings_errored.push({tried:y+" "+Z,in:G,error:f.toString()})}}}catch(e){}a.version_evidence.score>0&&(a.version="publishedVersion"),a.version_evidence.score<0&&(a.version="acceptedVersion"),"unknown"===a.version&&a.version_evidence.strings_checked>0&&(a.version="acceptedVersion");try{null!=(null!=(I=await this.licence(void 0,j))?I.licence:void 0)&&(a.licence=I.licence,a.licence_evidence=I)}catch(e){}a.archivable=!1,i?(a.archivable=!0,i===a.checksum?(a.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",a.admin_confirms=!0):(a.archivable_reason="The depositor says that this file is a version that can be archived",a.depositor_says=!0)):a.same_paper?("pdf"!==a.format&&(a.archivable=!0,a.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!a.archivable&&null!=a.licence&&a.licence.toLowerCase().startsWith("cc")&&(a.archivable=!0,a.archivable_reason="It appears this file contains a "+a.licence+" licence statement. Under this licence the article can be archived"),a.archivable||(a.version?(null!=r&&"{}"!==JSON.stringify(r)&&null==s&&(s=await this.permissions(r)),a.version===(null!=s&&null!=(T=s.best_permission)?T.version:void 0)?(a.archivable=!0,a.archivable_reason="We believe this is a "+a.version.split("V")[0]+" version and our permission system says that version can be shared"):null==a.archivable_reason&&(a.archivable_reason="We believe this file is a "+a.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):a.archivable_reason="We cannot confirm if it is an archivable version or not")):null==a.archivable_reason&&(a.archivable_reason=a.same_paper_evidence.words_more_than_threshold?a.same_paper_evidence.document_format?r.doi||r.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+a.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==e&&null==t||(a.error=null!=(N=e.error)?N:"Could not extract any content");return a.archivable&&null==a.licence&&((null!=s&&null!=(q=s.best_permission)?q.licence:void 0)?a.licence=s.best_permission.licence:(null!=(W=null!=s&&null!=(U=s.best_permission)?U.deposit_statement:void 0)?W:"").toLowerCase().startsWith("cc")&&(a.licence=s.best_permission.deposit_statement)),a.metadata=r},l(),setTimeout((()=>a.timeout=!0),null!=(o=this.params.timeout)?o:6e4);null==a.archivable&&!a.timeout;)await this.sleep(500);return a},t.archivable._bg=!0,t.deposited=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_;for await(r of(c="type:* AND NOT error:*",(_=this.params.uid)&&(c+=" AND from.keyword:"+_),this.params.submitted&&(c+=" AND zenodo.url:*"),this.params.fromdate&&(c+=" AND createdAt:>="+this.params.fromdate),g=[],await this.deposits._for(c,{sort:"createdAt:asc"})))if((!_||r.from===_)&&(!this.params.submitted||(null!=(d=r.zenodo)?d.file:void 0))){if(p={type:r.type,createdAt:r.createdAt},r.metadata)for(n=0,a=(h=["doi","title","author","journal","issn","publisher","published"]).length;n<a;n++)p[u=h[n]]=r.metadata[u];for(p.permission=r.best_permission,i=!1,l=0,o=g.length;l<o;l++)if((t=g[l]).doi&&p.doi&&t.doi===p.doi&&t.file&&p.file&&t.file===p.file){i=!0;break}if(!i){if(p.url=null!=(f=r.zenodo)?f.url:void 0,p.file=null!=(m=r.zenodo)?m.file:void 0,"csv"===this.format){for(e in null!=(y=p.author)?y:[])p.author[e]=p.author[e].name?p.author[e].name:p.author[e].given&&p.author[e].family?p.author[e].given+" "+p.author[e].family:"";for(s in p)null!=p[s]&&"object"==typeof p[s]&&(p[s]=await this.flatten(p[s]))}g.push(p)}}return g},L=[].indexOf,t.metadata=async function(e){var t;return this.S.shutdown&&"metadata"===this.fn?(D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"}):null!=(t=await this.find(e))?t.metadata:void 0},t.metadata._log=!1,t.find=async function(e,t={},i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;if(this.S.shutdown&&"find"===this.fn)return D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"};S={},s=async e=>{var i,r,s;for(r in s=[],i=await this.citation(e))"url"===r||"paywall"===r?s.push(null!=S[r]?S[r]:S[r]=i[r]):s.push(null!=t[r]?t[r]:t[r]=i[r]);return s},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}if(null==e&&(e={}),null==i&&(i=null!=(f=e.dom)?f:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(e.find.startsWith("10.")&&e.find.includes("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(a="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&a.split("/")[0].length>6&&a.length>8&&((o=a.split("/")).length>2&&(a=o.join("/")),null==t.doi&&(t.doi=a)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(_=e.url.replace("...","").match(/\./gi))?_:[]).length>3||(null!=(v=e.url.match(/\(/gi))?v:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(b=e.title.replace("...","").match(/\./gi))?b:[]).length>3||(null!=(w=e.title.match(/\(/gi))?w:[]).length>2)){e.citation=e.title;try{e.title.includes("10.")&&e.title.includes("/")&&(e.doi="10."+e.title.split("10.")[1].split(" ")[0].trim())}catch(e){}(e.doi.length<8||!e.doi.includes("/"))&&delete e.doi,delete e.title}e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(x=e.pmcid)?x:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}"string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(S.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(O=e.from)||"eZwJ83xp3oZDaec86"===O)&&null==S.demo&&(S.demo=!0),S.demo&&null==S.test&&(S.test=!0),u=!1,null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await s(await this.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(k=t.pmcid)?k:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(d=await this.src.openalex.works.title(t.title))?d.type:void 0)&&(null!=d?d.doi:void 0)&&await s(d),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(d=await this.src.openalex.works.doi(t.doi))&&await s(d),t.doi&&!(null!=d?d.type_crossref:void 0)&&(S.doi_not_in_openalex=!0),t.doi&&(l=await this.src.crossref.works.doi(t.doi))&&l.publisher&&(t.publisher=l.publisher),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==S.ill&&(S.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==S.permissions&&(S.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]);try{if(t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&!(null!=(j=S.permissions)?j.all_permissions:void 0)&&t.publisher_lineage.length>1)for(h=0;h<t.publisher_lineage.length&&(t.publisher_lineage[h]===t.publisher||(t.publisher=t.publisher_lineage[h],S.permissions=await this.permissions(t,null!=(y=e.config)?y.ror:void 0,!1),!S.permissions.all_permissions));)h++}catch(e){}for(c=0,p=(g=["title","journal","year","doi"]).length;c<p;c++)e[I=g[c]]&&e[I]!==t[I]&&(t[I]=e[I]);return S.metadata=t,S},t.citation=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et,tt,it,rt,st,nt,lt,at,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Lt,Nt,Et,Pt,Rt,Tt,qt,Wt,Ut,Mt;if(this.S.shutdown&&"citation"===this.fn)return D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"};try{null==e&&(e=null!=(z=this.params.citation)?z:this.params)}catch(e){}if("string"==typeof e){try{(e.startsWith("{")||e.startsWith("["))&&(e=JSON.parse(e))}catch(e){}e.startsWith("10.")&&(e=await this.src.openalex.works.doi(e))}if(Ct={},"object"==typeof e){for(c=0,g=(F=["doi","pmid","pmcid"]).length;c<g;c++)Ct[p=F[c]]=null!=(Q=null!=(ce=e[p])?ce:e[p.toUpperCase()])?Q:null!=(we=e.ids)?we[p]:void 0,"number"==typeof Ct[p]&&(Ct[p]=Ct[p].toString()),("pmid"===p||"pmcid"===p)&&Ct[p]&&Ct[p].includes("/")&&(Ct[p]=Ct[p].split("/").pop()),"doi"===p&&Ct[p]&&Ct[p].includes(".org/")&&(Ct[p]=Ct[p].split(".org/").pop()),Ct[p]&&"pmcid"===p&&!Ct[p].startsWith("PMC")&&(Ct[p]="PMC"+Ct[p]);Ct.doi&&!Ct.DOI&&(Ct.DOI=Ct.doi);try{Ct.type=null!=(Ne=null!=(Be=e.type_crossref)?Be:e.type)?Ne:e.genre}catch(e){}Ct.issn=null!=(et=null!=(pt=null!=(xt=null!=(B=null!=(J=e.ISSN)?J:e.issn)?B:null!=($=e.journalInfo)&&null!=(X=$.journal)?X.issn:void 0)?xt:null!=(V=e.journal)?V.issn:void 0)?pt:null!=(G=e.primary_location)&&null!=(H=G.source)?H.issn:void 0)?et:[],null!=(null!=(Y=e.journalInfo)&&null!=(Z=Y.journal)?Z.eissn:void 0)&&(K=e.journalInfo.journal.eissn,L.call(Ct.issn,K)<0)&&Ct.issn.push(e.journalInfo.journal.eissn),!Ct.issn&&e.journal_issns&&(Ct.issn=e.journal_issns.split(",")),Ct.title=e.title,Array.isArray(Ct.title)&&(Ct.title=Ct.title[0]),Ct.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(Ct.title+=": "+e.subtitle[0]),null==Ct.title&&(Ct.title=null!=(ee=e.dctitle)?ee:null!=(te=e.bibjson)?te.title:void 0),404!==(ie=Ct.title)&&"404"!==ie||delete Ct.title,"string"==typeof Ct.title&&(Ct.title=Ct.title.replace(/\s\s+/g," ").trim()),Ct.journal=e["container-title"]?e["container-title"][0]:null!=(re=e.primary_location)&&null!=(se=re.source)?se.display_name:void 0;try{Ct.shortname=e["short-container-title"][0]}catch(e){}try{Ct.shortname=null!=(ne=e.journalInfo.journal.isoabbreviation)?ne:e.journalInfo.journal.medlineAbbreviation}catch(e){}null==Ct.journal&&(Ct.journal=null!=(le=null!=(ae=e.journal_name)?ae:null!=(oe=e.journalInfo)&&null!=(ue=oe.journal)?ue.title:void 0)?le:null!=(pe=e.journal)?pe.title:void 0),e.journal&&(Ct.journal=e.journal.split("(")[0].trim()),null==Ct.shortname&&(Ct.shortname=Ct.journal),Ct.shortname&&!Ct.journal_short&&(Ct.journal_short=Ct.shortname);try{for(d=0,_=(de=["title","journal"]).length;d<_;d++)null==Ct[f=de[d]]&&(Ct[f]=Ct[f].charAt(0).toUpperCase()+Ct[f].slice(1))}catch(e){}Ct.publisher=null!=(he=null!=(fe=e.publisher)?fe:null!=(me=e.primary_location)&&null!=(ye=me.source)?ye.publisher:void 0)?he:null!=(ge=e.primary_location)&&null!=(_e=ge.source)?_e.host_organization_name:void 0,Ct.publisher&&(Ct.publisher=Ct.publisher.trim());try{Ct.publisher_lineage=e.primary_location.source.host_organization_lineage_names}catch(e){}for(Ct.published=e.publication_date,Ct.issue=null!=(ve=null!=(be=e.issue)?be:null!=(xe=e.journalInfo)?xe.issue:void 0)?ve:null!=(Oe=e.biblio)?Oe.issue:void 0,Ct.volume=null!=(ke=null!=(je=e.volume)?je:null!=(Se=e.journalInfo)?Se.volume:void 0)?ke:null!=(Ie=e.biblio)?Ie.volume:void 0,(e.page||e.pages||e.pageInfo)&&(Ct.pages=(null!=(Ae=null!=(De=e.page)?De:e.pages)?Ae:e.pageInfo).toString()),((null!=(Ce=e.biblio)?Ce.first_page:void 0)||(null!=(Le=e.biblio)?Le.last_page:void 0))&&(Ct.pages=e.biblio.first_page===e.biblio.last_page?e.biblio.first_page:(null!=(Ee=e.biblio.first_page)?Ee:"")+(e.biblio.first_page&&e.biblio.last_page?"-":"")+(null!=(Pe=e.biblio.last_page)?Pe:"")),Ct.abstract=null!=(Re=e.abstract)?Re:e.abstractText,P=0,x=(Te=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;P<x;P++)if(T=Te[P],"string"!=typeof Ct.published){if(Nt=null!=(qe=null!=(We=e[T])?We:null!=(Ue=e["journal-issue"])?Ue[T.replace("journal-issue.","")]:void 0)?qe:null!=(Me=e.journalInfo)?Me[T.replace("journalInfo.","")]:void 0){"number"==typeof Nt&&(Nt=Nt.toString());try{"string"!=typeof Nt&&(Nt=Nt["date-time"].toString())}catch(e){}if("string"!=typeof Nt)try{for(h in Nt["date-parts"][0])"number"!=(ze=typeof Nt["date-parts"][0][h])&&"string"!==ze&&(Nt["date-parts"][0][h]="01");Nt=Nt["date-parts"][0].join("-")}catch(e){}"string"==typeof Nt&&(Ct.published=Nt.includes("T")?Nt.split("T")[0]:Nt,Ct.published=Ct.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Ct.published.includes("-")||(Ct.published+="-01"),3!==Ct.published.split("-").length&&(Ct.published+="-01"),null==Ct.year&&(Ct.year=Ct.published.split("-")[0]),3!==Ct.published.split("-").length&&delete Ct.published,4!==Ct.year.toString().length&&delete Ct.year)}if(Ct.published)break}e.year&&null==Ct.year&&(Ct.year=e.year);try{null==Ct.year&&(Ct.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!Ct.year&&Ct.published&&Ct.published.includes("-")&&(Ct.year=Ct.published.split("-")[0]),null==Ct.author&&(n=null!=(Fe=null!=(Je=null!=($e=e.author)?$e:e.z_authors)?Je:null!=(Xe=e.authorList)?Xe.author:void 0)?Fe:e.authorships)){null==Ct.author&&(Ct.author=[]);try{for(R=0,O=n.length;R<O;R++)if("string"==typeof(t=n[R]))Ct.author.push({name:t});else{if(s={},"object"==typeof t.author){t.author.display_name.split(" ").length>1&&(s.given=t.author.display_name.split(" ")[0]),s.family=t.author.display_name.split(" ").pop();try{t.author.display_name.split(" ").length>2&&(s.given=t.author.display_name.replace(" "+s.family,""))}catch(e){}for(s.name=t.author.display_name,Ge=null!=(Ve=t.raw_affiliation_strings)?Ve:[],U=0,k=Ge.length;U<k;U++)i=Ge[U],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i})}else for(s.given=null!=(He=t.given)?He:t.firstName,s.family=null!=(Ye=t.family)?Ye:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(Ze=s.family)?Ze:""),Qe=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=(Ke=t.authorAffiliationDetailsList.authorAffiliation)?Ke:[],M=0,j=Qe.length;M<j;M++)"string"==typeof(i=Qe[M])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(tt=i.name)?tt:i.affiliation).replace(/\s\s+/g," ").trim()}));try{s.affiliation=s.affiliation.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}Ct.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(Ct.subject=e.subject)}catch(e){}try{null!=(null!=(it=e.keywordList)?it.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(Ct.keyword=e.keywordList.keyword)}catch(e){}if(!Ct.keyword&&e.keywords)for(Ct.keyword=[],Et=0,S=(rt=e.keywords).length;Et<S;Et++)((m=rt[Et]).keyword||m.display_name)&&Ct.keyword.push(null!=(st=m.keyword)?st:m.display_name);try{for(ut=[...null!=(nt=null!=(lt=e.meshHeadingList)?lt.meshHeading:void 0)?nt:[],...null!=(at=null!=(ot=e.chemicalList)?ot.chemical:void 0)?at:[]],Rt=0,I=ut.length;Rt<I;Rt++)N=ut[Rt],null==Ct.keyword&&(Ct.keyword=[]),"string"==typeof(E="string"==typeof N?N:null!=(ct=N.name)?ct:N.descriptorName)&&E&&L.call(Ct.keyword,E)<0&&Ct.keyword.push(E)}catch(e){}"string"==typeof e.license&&(Ct.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(Ct.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(dt=e.best_oa_location)?dt.license:void 0)&&null==Ct.licence&&(Ct.licence=e.best_oa_location.license)}catch(e){}try{(null!=(ht=e.primary_location)?ht.license:void 0)&&null==Ct.licence&&(Ct.licence=e.primary_location.license)}catch(e){}if(!Ct.licence){for(Tt=0,A=(mt=null!=(ft=e.assertion)?ft:[]).length;Tt<A;Tt++)"OPEN ACCESS"===(t=mt[Tt]).label&&t.URL&&t.URL.includes("creativecommons")&&null==Ct.licence&&(Ct.licence=t.URL);for(qt=0,C=(gt=null!=(yt=e.license)?yt:[]).length;qt<C;qt++)!(y=gt[qt]).URL||!y.URL.includes("creativecommons")||Ct.licence&&Ct.licence.includes("creativecommons")||null==Ct.licence&&(Ct.licence=y.URL)}if("string"==typeof Ct.licence&&Ct.licence.includes("/licenses/")&&(Ct.licence="cc-"+Ct.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Ct.url&&(Ct.url=null!=(_t=null!=(vt=null!=(bt=null!=(wt=e.best_oa_location)?wt.pdf_url:void 0)?bt:null!=(Ot=e.best_oa_location)?Ot.url_for_pdf:void 0)?vt:null!=(kt=e.best_oa_location)?kt.url:void 0)?_t:null!=(jt=e.best_oa_location)?jt.landing_page_url:void 0),!Ct.url&&null!=(null!=(St=e.fullTextUrlList)?St.fullTextUrl:void 0))for(Wt=0,v=(It=e.fullTextUrlList.fullTextUrl).length;Wt<v;Wt++)"oa"!==(At=(a=It[Wt]).availabilityCode.toLowerCase())&&"f"!==At||Ct.url&&("pdf"!==a.documentStyle||Ct.url.includes("pdf"))||(Ct.url=a.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Ct.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(Ct.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Ct.doi&&e.includes("http")&&(Ct.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(Ct.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?Ct.title=e.split('"')[1].trim():e.split("'").length>2&&null==Ct.title&&(Ct.title=e.split("'")[1].trim())}catch(e){}try{for(W=e.replace(/,\./g," ").split(" "),Ut=0,b=W.length;Ut<b;Ut++)q=W[Ut],Ct.year||4===(q=q.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Pt=parseInt(q))||isNaN(Pt)||(Ct.year=Pt))}catch(e){}try{!Ct.title&&Ct.year&&e.indexOf(Ct.year)<e.length/4&&(Ct.title=e.split(Ct.year)[1].trim(),(!Ct.title.includes("(")||Ct.title.indexOf(")")<Ct.title.indexOf("("))&&(Ct.title=Ct.title.replace(")","")),Ct.title.indexOf(".")<3&&(Ct.title=Ct.title.replace(".","")),Ct.title.indexOf(",")<3&&(Ct.title=Ct.title.replace(",","")),Ct.title=Ct.title.trim(),Ct.title.includes(".")?Ct.title=Ct.title.split(".")[0]:Ct.title.includes(",")&&(Ct.title=Ct.title.split(",")[0]))}catch(e){}if(Ct.title){try{if(l=e.split(Ct.title)[0],Ct.year&&l.includes(Ct.year)&&(l=l.split(Ct.year)[0]),Ct.url&&l.indexOf(Ct.url)>0&&(l=l.split(Ct.url)[0]),Ct.url&&l.startsWith(Ct.url)&&(l=l.replace(Ct.url)),Ct.doi&&l.startsWith(Ct.doi)&&(l=l.replace(Ct.doi)),l.indexOf(".")<3&&(l=l.replace(".","")),l.indexOf(",")<3&&(l=l.replace(",","")),l.lastIndexOf("(")>l.length-3&&(l=l.substring(0,l.lastIndexOf("("))),l.lastIndexOf(")")>l.length-3&&(l=l.substring(0,l.lastIndexOf(")"))),l.lastIndexOf(",")>l.length-3&&(l=l.substring(0,l.lastIndexOf(","))),l.lastIndexOf(".")>l.length-3&&(l=l.substring(0,l.lastIndexOf("."))),(l=l.trim()).length>6)if(l.includes(","))for(Ct.author=[],Dt=l.split(","),Mt=0,w=Dt.length;Mt<w;Mt++)r=Dt[Mt],Ct.author.push({name:r});else Ct.author=[{name:l}]}catch(e){}try{Lt=e.split(Ct.title)[1],Ct.url&&Lt.includes(Ct.url)&&(Lt=Lt.replace(Ct.url)),Ct.doi&&Lt.includes(Ct.doi)&&(Lt=Lt.replace(Ct.doi)),Lt.indexOf(".")<3&&(Lt=Lt.replace(".","")),Lt.indexOf(",")<3&&(Lt=Lt.replace(",","")),(Lt=Lt.trim()).length>6&&(Ct.journal=Lt,Lt.includes(",")&&(Ct.journal=Ct.journal.split(",")[0].replace(/in /gi,"").trim()),Ct.journal.indexOf(".")<3&&(Ct.journal=Ct.journal.replace(".","")),Ct.journal.indexOf(",")<3&&(Ct.journal=Ct.journal.replace(",","")),Ct.journal=Ct.journal.trim())}catch(e){}}try{if(Ct.journal&&(Lt=e.split(Ct.journal)[1],Ct.url&&Lt.includes(Ct.url)&&(Lt=Lt.replace(Ct.url)),Ct.doi&&Lt.includes(Ct.doi)&&(Lt=Lt.replace(Ct.doi)),Lt.indexOf(".")<3&&(Lt=Lt.replace(".","")),Lt.indexOf(",")<3&&(Lt=Lt.replace(",","")),(Lt=Lt.trim()).length>4)){if(Lt.includes("retrieved")&&(Lt=Lt.split("retrieved")[0]),Lt.includes("Retrieved")&&(Lt=Lt.split("Retrieved")[0]),Ct.volume=Lt,Ct.volume.includes("(")){Ct.volume=Ct.volume.split("(")[0],Ct.volume=Ct.volume.trim();try{Ct.issue=Lt.split("(")[1].split(")")[0],Ct.issue=Ct.issue.trim()}catch(e){}}if(Ct.volume.includes(",")){Ct.volume=Ct.volume.split(",")[0],Ct.volume=Ct.volume.trim();try{Ct.issue=Lt.split(",")[1],Ct.issue=Ct.issue.trim()}catch(e){}}if(Ct.volume)try{isNaN(parseInt(Ct.volume))&&delete Ct.volume}catch(e){}if(Ct.issue){Ct.issue.includes(",")&&(Ct.issue=Ct.issue.split(",")[0].trim());try{isNaN(parseInt(Ct.issue))&&delete Ct.issue}catch(e){}}if(Ct.volume&&Ct.issue)try{(Lt=e.split(Ct.journal)[1]).includes("retriev")&&(Lt=Lt.split("retriev")[0]),Lt.includes("Retriev")&&(Lt=Lt.split("Retriev")[0]),Ct.url&&Lt.includes(Ct.url)&&(Lt=Lt.split(Ct.url)[0]),Ct.doi&&Lt.includes(Ct.doi)&&(Lt=Lt.split(Ct.doi)[0]),(Lt=(Lt=Lt.substring(Lt.indexOf(Ct.volume)+(Ct.volume+"").length)).substring(Lt.indexOf(Ct.issue)+(Ct.issue+"").length)).indexOf(".")<2&&(Lt=Lt.replace(".","")),Lt.indexOf(",")<2&&(Lt=Lt.replace(",","")),Lt.indexOf(")")<2&&(Lt=Lt.replace(")","")),Lt=Lt.trim(),isNaN(parseInt(Lt.substring(0,1)))||(Ct.pages=Lt.split(" ")[0].split(".")[0].trim(),Ct.pages.length>5&&(Ct.pages=Ct.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!Ct.author&&e.includes("et al")&&(u=e.split("et al")[0].trim(),e.startsWith(u)&&(Ct.author=[{name:u+"et al"}])),Ct.title&&!Ct.volume)try{(o=e.split(Ct.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Ct.volume=o.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Ct.issue&&o.includes("iss")&&(Ct.issue=o.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Ct.pages&&o.includes("page")&&(Ct.pages=o.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof Ct.year&&(Ct.year=Ct.year.toString()),Ct},L=[].indexOf,t.metadata_grace=async function(e){var t;return null!=(t=await this.find_grace(e))?t.metadata:void 0},t.metadata_grace._log=!1,t.find_grace=async function(e,t={},i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;S={},s=async e=>{var i,r,s;for(r in s=[],i=await this.citation_grace(e))"url"===r||"paywall"===r?s.push(null!=S[r]?S[r]:S[r]=i[r]):s.push(null!=t[r]?t[r]:t[r]=i[r]);return s},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}if(null==e&&(e={}),null==i&&(i=null!=(f=e.dom)?f:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find_grace=e.metadata),e.metadata_grace&&(e.find_grace=e.metadata_grace,delete e.metadata_grace),e.find_grace&&(e.find_grace.startsWith("10.")&&e.find_grace.includes("/")?e.doi=e.find_grace:e.url=e.find_grace,delete e.find_grace),null==e.url&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(a="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&a.split("/")[0].length>6&&a.length>8&&((o=a.split("/")).length>2&&(a=o.join("/")),null==t.doi&&(t.doi=a)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(_=e.url.replace("...","").match(/\./gi))?_:[]).length>3||(null!=(v=e.url.match(/\(/gi))?v:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(b=e.title.replace("...","").match(/\./gi))?b:[]).length>3||(null!=(w=e.title.match(/\(/gi))?w:[]).length>2)){e.citation=e.title;try{e.title.includes("10.")&&e.title.includes("/")&&(e.doi="10."+e.title.split("10.")[1].split(" ")[0].trim())}catch(e){}(e.doi.length<8||!e.doi.includes("/"))&&delete e.doi,delete e.title}e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(x=e.pmcid)?x:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}"string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(S.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(O=e.from)||"eZwJ83xp3oZDaec86"===O)&&null==S.demo&&(S.demo=!0),S.demo&&null==S.test&&(S.test=!0),u=!1,null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await s(await this.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(k=t.pmcid)?k:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(d=await this.src.openalex.works.title(t.title))?d.type:void 0)&&(null!=d?d.doi:void 0)&&await s(d),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(d=await this.src.openalex.works.doi(t.doi))&&await s(d),t.doi&&!(null!=d?d.type_crossref:void 0)&&(S.doi_not_in_openalex=!0),t.doi&&(l=await this.src.crossref.works.doi(t.doi))&&l.publisher&&(t.publisher=l.publisher),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==S.ill&&(S.ill={subscription:await this.ill_grace.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==S.permissions&&(S.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]);try{if(t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&!(null!=(j=S.permissions)?j.all_permissions:void 0)&&t.publisher_lineage.length>1)for(h=0;h<t.publisher_lineage.length&&(t.publisher_lineage[h]===t.publisher||(t.publisher=t.publisher_lineage[h],S.permissions=await this.permissions(t,null!=(y=e.config)?y.ror:void 0,!1),!S.permissions.all_permissions));)h++}catch(e){}for(c=0,p=(g=["title","journal","year","doi"]).length;c<p;c++)e[I=g[c]]&&e[I]!==t[I]&&(t[I]=e[I]);return S.metadata=t,S},t.citation_grace=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et,tt,it,rt,st,nt,lt,at,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Lt,Nt,Et,Pt,Rt,Tt,qt,Wt,Ut;try{null==e&&(e=null!=(M=this.params.citation_grace)?M:this.params)}catch(e){}if("string"==typeof e){try{(e.startsWith("{")||e.startsWith("["))&&(e=JSON.parse(e))}catch(e){}e.startsWith("10.")&&(e=await this.src.openalex.works.doi(e))}if(Dt={},"object"==typeof e){for(c=0,g=(z=["doi","pmid","pmcid"]).length;c<g;c++)Dt[p=z[c]]=null!=(K=null!=(ue=e[p])?ue:e[p.toUpperCase()])?K:null!=(be=e.ids)?be[p]:void 0,"number"==typeof Dt[p]&&(Dt[p]=Dt[p].toString()),("pmid"===p||"pmcid"===p)&&Dt[p]&&Dt[p].includes("/")&&(Dt[p]=Dt[p].split("/").pop()),"doi"===p&&Dt[p]&&Dt[p].includes(".org/")&&(Dt[p]=Dt[p].split(".org/").pop()),Dt[p]&&"pmcid"===p&&!Dt[p].startsWith("PMC")&&(Dt[p]="PMC"+Dt[p]);Dt.doi&&!Dt.DOI&&(Dt.DOI=Dt.doi);try{Dt.type=null!=(Le=null!=(Fe=e.type_crossref)?Fe:e.type)?Le:e.genre}catch(e){}Dt.issn=null!=(Qe=null!=(ct=null!=(wt=null!=(F=null!=(B=e.ISSN)?B:e.issn)?F:null!=(J=e.journalInfo)&&null!=($=J.journal)?$.issn:void 0)?wt:null!=(X=e.journal)?X.issn:void 0)?ct:null!=(V=e.primary_location)&&null!=(G=V.source)?G.issn:void 0)?Qe:[],null!=(null!=(H=e.journalInfo)&&null!=(Y=H.journal)?Y.eissn:void 0)&&(Z=e.journalInfo.journal.eissn,L.call(Dt.issn,Z)<0)&&Dt.issn.push(e.journalInfo.journal.eissn),!Dt.issn&&e.journal_issns&&(Dt.issn=e.journal_issns.split(",")),Dt.title=e.title,Array.isArray(Dt.title)&&(Dt.title=Dt.title[0]),Dt.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(Dt.title+=": "+e.subtitle[0]),null==Dt.title&&(Dt.title=null!=(Q=e.dctitle)?Q:null!=(ee=e.bibjson)?ee.title:void 0),404!==(te=Dt.title)&&"404"!==te||delete Dt.title,"string"==typeof Dt.title&&(Dt.title=Dt.title.replace(/\s\s+/g," ").trim()),Dt.journal=e["container-title"]?e["container-title"][0]:null!=(ie=e.primary_location)&&null!=(re=ie.source)?re.display_name:void 0;try{Dt.shortname=e["short-container-title"][0]}catch(e){}try{Dt.shortname=null!=(se=e.journalInfo.journal.isoabbreviation)?se:e.journalInfo.journal.medlineAbbreviation}catch(e){}null==Dt.journal&&(Dt.journal=null!=(ne=null!=(le=e.journal_name)?le:null!=(ae=e.journalInfo)&&null!=(oe=ae.journal)?oe.title:void 0)?ne:null!=(ce=e.journal)?ce.title:void 0),e.journal&&(Dt.journal=e.journal.split("(")[0].trim()),null==Dt.shortname&&(Dt.shortname=Dt.journal),Dt.shortname&&!Dt.journal_short&&(Dt.journal_short=Dt.shortname);try{for(d=0,_=(pe=["title","journal"]).length;d<_;d++)null==Dt[f=pe[d]]&&(Dt[f]=Dt[f].charAt(0).toUpperCase()+Dt[f].slice(1))}catch(e){}Dt.publisher=null!=(de=null!=(he=e.publisher)?he:null!=(fe=e.primary_location)&&null!=(me=fe.source)?me.publisher:void 0)?de:null!=(ye=e.primary_location)&&null!=(ge=ye.source)?ge.host_organization_name:void 0,Dt.publisher&&(Dt.publisher=Dt.publisher.trim());try{Dt.publisher_lineage=e.primary_location.source.host_organization_lineage_names}catch(e){}for(Dt.published=e.publication_date,Dt.issue=null!=(_e=null!=(ve=e.issue)?ve:null!=(we=e.journalInfo)?we.issue:void 0)?_e:null!=(xe=e.biblio)?xe.issue:void 0,Dt.volume=null!=(Oe=null!=(ke=e.volume)?ke:null!=(je=e.journalInfo)?je.volume:void 0)?Oe:null!=(Se=e.biblio)?Se.volume:void 0,(e.page||e.pages||e.pageInfo)&&(Dt.pages=(null!=(Ie=null!=(Ae=e.page)?Ae:e.pages)?Ie:e.pageInfo).toString()),((null!=(De=e.biblio)?De.first_page:void 0)||(null!=(Ce=e.biblio)?Ce.last_page:void 0))&&(Dt.pages=e.biblio.first_page===e.biblio.last_page?e.biblio.first_page:(null!=(Ne=e.biblio.first_page)?Ne:"")+(e.biblio.first_page&&e.biblio.last_page?"-":"")+(null!=(Ee=e.biblio.last_page)?Ee:"")),Dt.abstract=null!=(Pe=e.abstract)?Pe:e.abstractText,E=0,x=(Re=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;E<x;E++)if(R=Re[E],"string"!=typeof Dt.published){if(Lt=null!=(Te=null!=(qe=e[R])?qe:null!=(We=e["journal-issue"])?We[R.replace("journal-issue.","")]:void 0)?Te:null!=(Ue=e.journalInfo)?Ue[R.replace("journalInfo.","")]:void 0){"number"==typeof Lt&&(Lt=Lt.toString());try{"string"!=typeof Lt&&(Lt=Lt["date-time"].toString())}catch(e){}if("string"!=typeof Lt)try{for(h in Lt["date-parts"][0])"number"!=(Me=typeof Lt["date-parts"][0][h])&&"string"!==Me&&(Lt["date-parts"][0][h]="01");Lt=Lt["date-parts"][0].join("-")}catch(e){}"string"==typeof Lt&&(Dt.published=Lt.includes("T")?Lt.split("T")[0]:Lt,Dt.published=Dt.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Dt.published.includes("-")||(Dt.published+="-01"),3!==Dt.published.split("-").length&&(Dt.published+="-01"),null==Dt.year&&(Dt.year=Dt.published.split("-")[0]),3!==Dt.published.split("-").length&&delete Dt.published,4!==Dt.year.toString().length&&delete Dt.year)}if(Dt.published)break}e.year&&null==Dt.year&&(Dt.year=e.year);try{null==Dt.year&&(Dt.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!Dt.year&&Dt.published&&Dt.published.includes("-")&&(Dt.year=Dt.published.split("-")[0]),null==Dt.author&&(n=null!=(ze=null!=(Be=null!=(Je=e.author)?Je:e.z_authors)?Be:null!=($e=e.authorList)?$e.author:void 0)?ze:e.authorships)){null==Dt.author&&(Dt.author=[]);try{for(P=0,O=n.length;P<O;P++)if("string"==typeof(t=n[P]))Dt.author.push({name:t});else{if(s={},"object"==typeof t.author){t.author.display_name.split(" ").length>1&&(s.given=t.author.display_name.split(" ")[0]),s.family=t.author.display_name.split(" ").pop();try{t.author.display_name.split(" ").length>2&&(s.given=t.author.display_name.replace(" "+s.family,""))}catch(e){}for(s.name=t.author.display_name,Ve=null!=(Xe=t.raw_affiliation_strings)?Xe:[],W=0,k=Ve.length;W<k;W++)i=Ve[W],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i})}else for(s.given=null!=(Ge=t.given)?Ge:t.firstName,s.family=null!=(He=t.family)?He:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(Ye=s.family)?Ye:""),Ke=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=(Ze=t.authorAffiliationDetailsList.authorAffiliation)?Ze:[],U=0,j=Ke.length;U<j;U++)"string"==typeof(i=Ke[U])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(et=i.name)?et:i.affiliation).replace(/\s\s+/g," ").trim()}));try{s.affiliation=s.affiliation.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}Dt.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(Dt.subject=e.subject)}catch(e){}try{null!=(null!=(tt=e.keywordList)?tt.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(Dt.keyword=e.keywordList.keyword)}catch(e){}if(!Dt.keyword&&e.keywords)for(Dt.keyword=[],Nt=0,S=(it=e.keywords).length;Nt<S;Nt++)((m=it[Nt]).keyword||m.display_name)&&Dt.keyword.push(null!=(rt=m.keyword)?rt:m.display_name);try{for(ot=[...null!=(st=null!=(nt=e.meshHeadingList)?nt.meshHeading:void 0)?st:[],...null!=(lt=null!=(at=e.chemicalList)?at.chemical:void 0)?lt:[]],Pt=0,I=ot.length;Pt<I;Pt++)C=ot[Pt],null==Dt.keyword&&(Dt.keyword=[]),"string"==typeof(N="string"==typeof C?C:null!=(ut=C.name)?ut:C.descriptorName)&&N&&L.call(Dt.keyword,N)<0&&Dt.keyword.push(N)}catch(e){}"string"==typeof e.license&&(Dt.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(Dt.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(pt=e.best_oa_location)?pt.license:void 0)&&null==Dt.licence&&(Dt.licence=e.best_oa_location.license)}catch(e){}try{(null!=(dt=e.primary_location)?dt.license:void 0)&&null==Dt.licence&&(Dt.licence=e.primary_location.license)}catch(e){}if(!Dt.licence){for(Rt=0,A=(ft=null!=(ht=e.assertion)?ht:[]).length;Rt<A;Rt++)"OPEN ACCESS"===(t=ft[Rt]).label&&t.URL&&t.URL.includes("creativecommons")&&null==Dt.licence&&(Dt.licence=t.URL);for(Tt=0,D=(yt=null!=(mt=e.license)?mt:[]).length;Tt<D;Tt++)!(y=yt[Tt]).URL||!y.URL.includes("creativecommons")||Dt.licence&&Dt.licence.includes("creativecommons")||null==Dt.licence&&(Dt.licence=y.URL)}if("string"==typeof Dt.licence&&Dt.licence.includes("/licenses/")&&(Dt.licence="cc-"+Dt.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Dt.url&&(Dt.url=null!=(gt=null!=(_t=null!=(vt=null!=(bt=e.best_oa_location)?bt.pdf_url:void 0)?vt:null!=(xt=e.best_oa_location)?xt.url_for_pdf:void 0)?_t:null!=(Ot=e.best_oa_location)?Ot.url:void 0)?gt:null!=(kt=e.best_oa_location)?kt.landing_page_url:void 0),!Dt.url&&null!=(null!=(jt=e.fullTextUrlList)?jt.fullTextUrl:void 0))for(qt=0,v=(St=e.fullTextUrlList.fullTextUrl).length;qt<v;qt++)"oa"!==(It=(a=St[qt]).availabilityCode.toLowerCase())&&"f"!==It||Dt.url&&("pdf"!==a.documentStyle||Dt.url.includes("pdf"))||(Dt.url=a.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Dt.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(Dt.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Dt.doi&&e.includes("http")&&(Dt.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(Dt.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?Dt.title=e.split('"')[1].trim():e.split("'").length>2&&null==Dt.title&&(Dt.title=e.split("'")[1].trim())}catch(e){}try{for(q=e.replace(/,\./g," ").split(" "),Wt=0,b=q.length;Wt<b;Wt++)T=q[Wt],Dt.year||4===(T=T.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Et=parseInt(T))||isNaN(Et)||(Dt.year=Et))}catch(e){}try{!Dt.title&&Dt.year&&e.indexOf(Dt.year)<e.length/4&&(Dt.title=e.split(Dt.year)[1].trim(),(!Dt.title.includes("(")||Dt.title.indexOf(")")<Dt.title.indexOf("("))&&(Dt.title=Dt.title.replace(")","")),Dt.title.indexOf(".")<3&&(Dt.title=Dt.title.replace(".","")),Dt.title.indexOf(",")<3&&(Dt.title=Dt.title.replace(",","")),Dt.title=Dt.title.trim(),Dt.title.includes(".")?Dt.title=Dt.title.split(".")[0]:Dt.title.includes(",")&&(Dt.title=Dt.title.split(",")[0]))}catch(e){}if(Dt.title){try{if(l=e.split(Dt.title)[0],Dt.year&&l.includes(Dt.year)&&(l=l.split(Dt.year)[0]),Dt.url&&l.indexOf(Dt.url)>0&&(l=l.split(Dt.url)[0]),Dt.url&&l.startsWith(Dt.url)&&(l=l.replace(Dt.url)),Dt.doi&&l.startsWith(Dt.doi)&&(l=l.replace(Dt.doi)),l.indexOf(".")<3&&(l=l.replace(".","")),l.indexOf(",")<3&&(l=l.replace(",","")),l.lastIndexOf("(")>l.length-3&&(l=l.substring(0,l.lastIndexOf("("))),l.lastIndexOf(")")>l.length-3&&(l=l.substring(0,l.lastIndexOf(")"))),l.lastIndexOf(",")>l.length-3&&(l=l.substring(0,l.lastIndexOf(","))),l.lastIndexOf(".")>l.length-3&&(l=l.substring(0,l.lastIndexOf("."))),(l=l.trim()).length>6)if(l.includes(","))for(Dt.author=[],At=l.split(","),Ut=0,w=At.length;Ut<w;Ut++)r=At[Ut],Dt.author.push({name:r});else Dt.author=[{name:l}]}catch(e){}try{Ct=e.split(Dt.title)[1],Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.replace(Dt.url)),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.replace(Dt.doi)),Ct.indexOf(".")<3&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<3&&(Ct=Ct.replace(",","")),(Ct=Ct.trim()).length>6&&(Dt.journal=Ct,Ct.includes(",")&&(Dt.journal=Dt.journal.split(",")[0].replace(/in /gi,"").trim()),Dt.journal.indexOf(".")<3&&(Dt.journal=Dt.journal.replace(".","")),Dt.journal.indexOf(",")<3&&(Dt.journal=Dt.journal.replace(",","")),Dt.journal=Dt.journal.trim())}catch(e){}}try{if(Dt.journal&&(Ct=e.split(Dt.journal)[1],Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.replace(Dt.url)),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.replace(Dt.doi)),Ct.indexOf(".")<3&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<3&&(Ct=Ct.replace(",","")),(Ct=Ct.trim()).length>4)){if(Ct.includes("retrieved")&&(Ct=Ct.split("retrieved")[0]),Ct.includes("Retrieved")&&(Ct=Ct.split("Retrieved")[0]),Dt.volume=Ct,Dt.volume.includes("(")){Dt.volume=Dt.volume.split("(")[0],Dt.volume=Dt.volume.trim();try{Dt.issue=Ct.split("(")[1].split(")")[0],Dt.issue=Dt.issue.trim()}catch(e){}}if(Dt.volume.includes(",")){Dt.volume=Dt.volume.split(",")[0],Dt.volume=Dt.volume.trim();try{Dt.issue=Ct.split(",")[1],Dt.issue=Dt.issue.trim()}catch(e){}}if(Dt.volume)try{isNaN(parseInt(Dt.volume))&&delete Dt.volume}catch(e){}if(Dt.issue){Dt.issue.includes(",")&&(Dt.issue=Dt.issue.split(",")[0].trim());try{isNaN(parseInt(Dt.issue))&&delete Dt.issue}catch(e){}}if(Dt.volume&&Dt.issue)try{(Ct=e.split(Dt.journal)[1]).includes("retriev")&&(Ct=Ct.split("retriev")[0]),Ct.includes("Retriev")&&(Ct=Ct.split("Retriev")[0]),Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.split(Dt.url)[0]),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.split(Dt.doi)[0]),(Ct=(Ct=Ct.substring(Ct.indexOf(Dt.volume)+(Dt.volume+"").length)).substring(Ct.indexOf(Dt.issue)+(Dt.issue+"").length)).indexOf(".")<2&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<2&&(Ct=Ct.replace(",","")),Ct.indexOf(")")<2&&(Ct=Ct.replace(")","")),Ct=Ct.trim(),isNaN(parseInt(Ct.substring(0,1)))||(Dt.pages=Ct.split(" ")[0].split(".")[0].trim(),Dt.pages.length>5&&(Dt.pages=Dt.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!Dt.author&&e.includes("et al")&&(u=e.split("et al")[0].trim(),e.startsWith(u)&&(Dt.author=[{name:u+"et al"}])),Dt.title&&!Dt.volume)try{(o=e.split(Dt.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Dt.volume=o.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Dt.issue&&o.includes("iss")&&(Dt.issue=o.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Dt.pages&&o.includes("page")&&(Dt.pages=o.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof Dt.year&&(Dt.year=Dt.year.toString()),Dt},L=[].indexOf,t.metadata_internal=async function(e){var t;return null!=(t=await this.find_internal(e))?t.metadata:void 0},t.metadata_internal._log=!1,t.find_internal=async function(e,t={},i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;S={},s=async e=>{var i,r,s;for(r in s=[],i=await this.citation_internal(e))"url"===r||"paywall"===r?s.push(null!=S[r]?S[r]:S[r]=i[r]):s.push(null!=t[r]?t[r]:t[r]=i[r]);return s},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}if(null==e&&(e={}),null==i&&(i=null!=(f=e.dom)?f:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find_internal=e.metadata),e.metadata_internal&&(e.find_internal=e.metadata_internal,delete e.metadata_internal),e.find_internal&&(e.find_internal.startsWith("10.")&&e.find_internal.includes("/")?e.doi=e.find_internal:e.url=e.find_internal,delete e.find_internal),null==e.url&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(a="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&a.split("/")[0].length>6&&a.length>8&&((o=a.split("/")).length>2&&(a=o.join("/")),null==t.doi&&(t.doi=a)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(_=e.url.replace("...","").match(/\./gi))?_:[]).length>3||(null!=(v=e.url.match(/\(/gi))?v:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(b=e.title.replace("...","").match(/\./gi))?b:[]).length>3||(null!=(w=e.title.match(/\(/gi))?w:[]).length>2)){e.citation=e.title;try{e.title.includes("10.")&&e.title.includes("/")&&(e.doi="10."+e.title.split("10.")[1].split(" ")[0].trim())}catch(e){}(e.doi.length<8||!e.doi.includes("/"))&&delete e.doi,delete e.title}e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(x=e.pmcid)?x:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}"string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(S.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(O=e.from)||"eZwJ83xp3oZDaec86"===O)&&null==S.demo&&(S.demo=!0),S.demo&&null==S.test&&(S.test=!0),u=!1,null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await s(await this.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(k=t.pmcid)?k:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(d=await this.src.openalex.works.title(t.title))?d.type:void 0)&&(null!=d?d.doi:void 0)&&await s(d),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(d=await this.src.openalex.works.doi(t.doi))&&await s(d),t.doi&&!(null!=d?d.type_crossref:void 0)&&(S.doi_not_in_openalex=!0),t.doi&&(l=await this.src.crossref.works.doi(t.doi))&&l.publisher&&(t.publisher=l.publisher),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==S.ill&&(S.ill={subscription:await this.ill_internal.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==S.permissions&&(S.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]);try{if(t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&!(null!=(j=S.permissions)?j.all_permissions:void 0)&&t.publisher_lineage.length>1)for(h=0;h<t.publisher_lineage.length&&(t.publisher_lineage[h]===t.publisher||(t.publisher=t.publisher_lineage[h],S.permissions=await this.permissions(t,null!=(y=e.config)?y.ror:void 0,!1),!S.permissions.all_permissions));)h++}catch(e){}for(c=0,p=(g=["title","journal","year","doi"]).length;c<p;c++)e[I=g[c]]&&e[I]!==t[I]&&(t[I]=e[I]);return S.metadata=t,S},t.citation_internal=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et,tt,it,rt,st,nt,lt,at,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Lt,Nt,Et,Pt,Rt,Tt,qt,Wt,Ut;try{null==e&&(e=null!=(M=this.params.citation_internal)?M:this.params)}catch(e){}if("string"==typeof e){try{(e.startsWith("{")||e.startsWith("["))&&(e=JSON.parse(e))}catch(e){}e.startsWith("10.")&&(e=await this.src.openalex.works.doi(e))}if(Dt={},"object"==typeof e){for(c=0,g=(z=["doi","pmid","pmcid"]).length;c<g;c++)Dt[p=z[c]]=null!=(K=null!=(ue=e[p])?ue:e[p.toUpperCase()])?K:null!=(be=e.ids)?be[p]:void 0,"number"==typeof Dt[p]&&(Dt[p]=Dt[p].toString()),("pmid"===p||"pmcid"===p)&&Dt[p]&&Dt[p].includes("/")&&(Dt[p]=Dt[p].split("/").pop()),"doi"===p&&Dt[p]&&Dt[p].includes(".org/")&&(Dt[p]=Dt[p].split(".org/").pop()),Dt[p]&&"pmcid"===p&&!Dt[p].startsWith("PMC")&&(Dt[p]="PMC"+Dt[p]);Dt.doi&&!Dt.DOI&&(Dt.DOI=Dt.doi);try{Dt.type=null!=(Le=null!=(Fe=e.type_crossref)?Fe:e.type)?Le:e.genre}catch(e){}Dt.issn=null!=(Qe=null!=(ct=null!=(wt=null!=(F=null!=(B=e.ISSN)?B:e.issn)?F:null!=(J=e.journalInfo)&&null!=($=J.journal)?$.issn:void 0)?wt:null!=(X=e.journal)?X.issn:void 0)?ct:null!=(V=e.primary_location)&&null!=(G=V.source)?G.issn:void 0)?Qe:[],null!=(null!=(H=e.journalInfo)&&null!=(Y=H.journal)?Y.eissn:void 0)&&(Z=e.journalInfo.journal.eissn,L.call(Dt.issn,Z)<0)&&Dt.issn.push(e.journalInfo.journal.eissn),!Dt.issn&&e.journal_issns&&(Dt.issn=e.journal_issns.split(",")),Dt.title=e.title,Array.isArray(Dt.title)&&(Dt.title=Dt.title[0]),Dt.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(Dt.title+=": "+e.subtitle[0]),null==Dt.title&&(Dt.title=null!=(Q=e.dctitle)?Q:null!=(ee=e.bibjson)?ee.title:void 0),404!==(te=Dt.title)&&"404"!==te||delete Dt.title,"string"==typeof Dt.title&&(Dt.title=Dt.title.replace(/\s\s+/g," ").trim()),Dt.journal=e["container-title"]?e["container-title"][0]:null!=(ie=e.primary_location)&&null!=(re=ie.source)?re.display_name:void 0;try{Dt.shortname=e["short-container-title"][0]}catch(e){}try{Dt.shortname=null!=(se=e.journalInfo.journal.isoabbreviation)?se:e.journalInfo.journal.medlineAbbreviation}catch(e){}null==Dt.journal&&(Dt.journal=null!=(ne=null!=(le=e.journal_name)?le:null!=(ae=e.journalInfo)&&null!=(oe=ae.journal)?oe.title:void 0)?ne:null!=(ce=e.journal)?ce.title:void 0),e.journal&&(Dt.journal=e.journal.split("(")[0].trim()),null==Dt.shortname&&(Dt.shortname=Dt.journal),Dt.shortname&&!Dt.journal_short&&(Dt.journal_short=Dt.shortname);try{for(d=0,_=(pe=["title","journal"]).length;d<_;d++)null==Dt[f=pe[d]]&&(Dt[f]=Dt[f].charAt(0).toUpperCase()+Dt[f].slice(1))}catch(e){}Dt.publisher=null!=(de=null!=(he=e.publisher)?he:null!=(fe=e.primary_location)&&null!=(me=fe.source)?me.publisher:void 0)?de:null!=(ye=e.primary_location)&&null!=(ge=ye.source)?ge.host_organization_name:void 0,Dt.publisher&&(Dt.publisher=Dt.publisher.trim());try{Dt.publisher_lineage=e.primary_location.source.host_organization_lineage_names}catch(e){}for(Dt.published=e.publication_date,Dt.issue=null!=(_e=null!=(ve=e.issue)?ve:null!=(we=e.journalInfo)?we.issue:void 0)?_e:null!=(xe=e.biblio)?xe.issue:void 0,Dt.volume=null!=(Oe=null!=(ke=e.volume)?ke:null!=(je=e.journalInfo)?je.volume:void 0)?Oe:null!=(Se=e.biblio)?Se.volume:void 0,(e.page||e.pages||e.pageInfo)&&(Dt.pages=(null!=(Ie=null!=(Ae=e.page)?Ae:e.pages)?Ie:e.pageInfo).toString()),((null!=(De=e.biblio)?De.first_page:void 0)||(null!=(Ce=e.biblio)?Ce.last_page:void 0))&&(Dt.pages=e.biblio.first_page===e.biblio.last_page?e.biblio.first_page:(null!=(Ne=e.biblio.first_page)?Ne:"")+(e.biblio.first_page&&e.biblio.last_page?"-":"")+(null!=(Ee=e.biblio.last_page)?Ee:"")),Dt.abstract=null!=(Pe=e.abstract)?Pe:e.abstractText,E=0,x=(Re=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;E<x;E++)if(R=Re[E],"string"!=typeof Dt.published){if(Lt=null!=(Te=null!=(qe=e[R])?qe:null!=(We=e["journal-issue"])?We[R.replace("journal-issue.","")]:void 0)?Te:null!=(Ue=e.journalInfo)?Ue[R.replace("journalInfo.","")]:void 0){"number"==typeof Lt&&(Lt=Lt.toString());try{"string"!=typeof Lt&&(Lt=Lt["date-time"].toString())}catch(e){}if("string"!=typeof Lt)try{for(h in Lt["date-parts"][0])"number"!=(Me=typeof Lt["date-parts"][0][h])&&"string"!==Me&&(Lt["date-parts"][0][h]="01");Lt=Lt["date-parts"][0].join("-")}catch(e){}"string"==typeof Lt&&(Dt.published=Lt.includes("T")?Lt.split("T")[0]:Lt,Dt.published=Dt.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Dt.published.includes("-")||(Dt.published+="-01"),3!==Dt.published.split("-").length&&(Dt.published+="-01"),null==Dt.year&&(Dt.year=Dt.published.split("-")[0]),3!==Dt.published.split("-").length&&delete Dt.published,4!==Dt.year.toString().length&&delete Dt.year)}if(Dt.published)break}e.year&&null==Dt.year&&(Dt.year=e.year);try{null==Dt.year&&(Dt.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!Dt.year&&Dt.published&&Dt.published.includes("-")&&(Dt.year=Dt.published.split("-")[0]),null==Dt.author&&(n=null!=(ze=null!=(Be=null!=(Je=e.author)?Je:e.z_authors)?Be:null!=($e=e.authorList)?$e.author:void 0)?ze:e.authorships)){null==Dt.author&&(Dt.author=[]);try{for(P=0,O=n.length;P<O;P++)if("string"==typeof(t=n[P]))Dt.author.push({name:t});else{if(s={},"object"==typeof t.author){t.author.display_name.split(" ").length>1&&(s.given=t.author.display_name.split(" ")[0]),s.family=t.author.display_name.split(" ").pop();try{t.author.display_name.split(" ").length>2&&(s.given=t.author.display_name.replace(" "+s.family,""))}catch(e){}for(s.name=t.author.display_name,Ve=null!=(Xe=t.raw_affiliation_strings)?Xe:[],W=0,k=Ve.length;W<k;W++)i=Ve[W],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i})}else for(s.given=null!=(Ge=t.given)?Ge:t.firstName,s.family=null!=(He=t.family)?He:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(Ye=s.family)?Ye:""),Ke=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=(Ze=t.authorAffiliationDetailsList.authorAffiliation)?Ze:[],U=0,j=Ke.length;U<j;U++)"string"==typeof(i=Ke[U])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(et=i.name)?et:i.affiliation).replace(/\s\s+/g," ").trim()}));try{s.affiliation=s.affiliation.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}Dt.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(Dt.subject=e.subject)}catch(e){}try{null!=(null!=(tt=e.keywordList)?tt.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(Dt.keyword=e.keywordList.keyword)}catch(e){}if(!Dt.keyword&&e.keywords)for(Dt.keyword=[],Nt=0,S=(it=e.keywords).length;Nt<S;Nt++)((m=it[Nt]).keyword||m.display_name)&&Dt.keyword.push(null!=(rt=m.keyword)?rt:m.display_name);try{for(ot=[...null!=(st=null!=(nt=e.meshHeadingList)?nt.meshHeading:void 0)?st:[],...null!=(lt=null!=(at=e.chemicalList)?at.chemical:void 0)?lt:[]],Pt=0,I=ot.length;Pt<I;Pt++)C=ot[Pt],null==Dt.keyword&&(Dt.keyword=[]),"string"==typeof(N="string"==typeof C?C:null!=(ut=C.name)?ut:C.descriptorName)&&N&&L.call(Dt.keyword,N)<0&&Dt.keyword.push(N)}catch(e){}"string"==typeof e.license&&(Dt.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(Dt.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(pt=e.best_oa_location)?pt.license:void 0)&&null==Dt.licence&&(Dt.licence=e.best_oa_location.license)}catch(e){}try{(null!=(dt=e.primary_location)?dt.license:void 0)&&null==Dt.licence&&(Dt.licence=e.primary_location.license)}catch(e){}if(!Dt.licence){for(Rt=0,A=(ft=null!=(ht=e.assertion)?ht:[]).length;Rt<A;Rt++)"OPEN ACCESS"===(t=ft[Rt]).label&&t.URL&&t.URL.includes("creativecommons")&&null==Dt.licence&&(Dt.licence=t.URL);for(Tt=0,D=(yt=null!=(mt=e.license)?mt:[]).length;Tt<D;Tt++)!(y=yt[Tt]).URL||!y.URL.includes("creativecommons")||Dt.licence&&Dt.licence.includes("creativecommons")||null==Dt.licence&&(Dt.licence=y.URL)}if("string"==typeof Dt.licence&&Dt.licence.includes("/licenses/")&&(Dt.licence="cc-"+Dt.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Dt.url&&(Dt.url=null!=(gt=null!=(_t=null!=(vt=null!=(bt=e.best_oa_location)?bt.pdf_url:void 0)?vt:null!=(xt=e.best_oa_location)?xt.url_for_pdf:void 0)?_t:null!=(Ot=e.best_oa_location)?Ot.url:void 0)?gt:null!=(kt=e.best_oa_location)?kt.landing_page_url:void 0),!Dt.url&&null!=(null!=(jt=e.fullTextUrlList)?jt.fullTextUrl:void 0))for(qt=0,v=(St=e.fullTextUrlList.fullTextUrl).length;qt<v;qt++)"oa"!==(It=(a=St[qt]).availabilityCode.toLowerCase())&&"f"!==It||Dt.url&&("pdf"!==a.documentStyle||Dt.url.includes("pdf"))||(Dt.url=a.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Dt.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(Dt.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Dt.doi&&e.includes("http")&&(Dt.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(Dt.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?Dt.title=e.split('"')[1].trim():e.split("'").length>2&&null==Dt.title&&(Dt.title=e.split("'")[1].trim())}catch(e){}try{for(q=e.replace(/,\./g," ").split(" "),Wt=0,b=q.length;Wt<b;Wt++)T=q[Wt],Dt.year||4===(T=T.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Et=parseInt(T))||isNaN(Et)||(Dt.year=Et))}catch(e){}try{!Dt.title&&Dt.year&&e.indexOf(Dt.year)<e.length/4&&(Dt.title=e.split(Dt.year)[1].trim(),(!Dt.title.includes("(")||Dt.title.indexOf(")")<Dt.title.indexOf("("))&&(Dt.title=Dt.title.replace(")","")),Dt.title.indexOf(".")<3&&(Dt.title=Dt.title.replace(".","")),Dt.title.indexOf(",")<3&&(Dt.title=Dt.title.replace(",","")),Dt.title=Dt.title.trim(),Dt.title.includes(".")?Dt.title=Dt.title.split(".")[0]:Dt.title.includes(",")&&(Dt.title=Dt.title.split(",")[0]))}catch(e){}if(Dt.title){try{if(l=e.split(Dt.title)[0],Dt.year&&l.includes(Dt.year)&&(l=l.split(Dt.year)[0]),Dt.url&&l.indexOf(Dt.url)>0&&(l=l.split(Dt.url)[0]),Dt.url&&l.startsWith(Dt.url)&&(l=l.replace(Dt.url)),Dt.doi&&l.startsWith(Dt.doi)&&(l=l.replace(Dt.doi)),l.indexOf(".")<3&&(l=l.replace(".","")),l.indexOf(",")<3&&(l=l.replace(",","")),l.lastIndexOf("(")>l.length-3&&(l=l.substring(0,l.lastIndexOf("("))),l.lastIndexOf(")")>l.length-3&&(l=l.substring(0,l.lastIndexOf(")"))),l.lastIndexOf(",")>l.length-3&&(l=l.substring(0,l.lastIndexOf(","))),l.lastIndexOf(".")>l.length-3&&(l=l.substring(0,l.lastIndexOf("."))),(l=l.trim()).length>6)if(l.includes(","))for(Dt.author=[],At=l.split(","),Ut=0,w=At.length;Ut<w;Ut++)r=At[Ut],Dt.author.push({name:r});else Dt.author=[{name:l}]}catch(e){}try{Ct=e.split(Dt.title)[1],Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.replace(Dt.url)),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.replace(Dt.doi)),Ct.indexOf(".")<3&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<3&&(Ct=Ct.replace(",","")),(Ct=Ct.trim()).length>6&&(Dt.journal=Ct,Ct.includes(",")&&(Dt.journal=Dt.journal.split(",")[0].replace(/in /gi,"").trim()),Dt.journal.indexOf(".")<3&&(Dt.journal=Dt.journal.replace(".","")),Dt.journal.indexOf(",")<3&&(Dt.journal=Dt.journal.replace(",","")),Dt.journal=Dt.journal.trim())}catch(e){}}try{if(Dt.journal&&(Ct=e.split(Dt.journal)[1],Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.replace(Dt.url)),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.replace(Dt.doi)),Ct.indexOf(".")<3&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<3&&(Ct=Ct.replace(",","")),(Ct=Ct.trim()).length>4)){if(Ct.includes("retrieved")&&(Ct=Ct.split("retrieved")[0]),Ct.includes("Retrieved")&&(Ct=Ct.split("Retrieved")[0]),Dt.volume=Ct,Dt.volume.includes("(")){Dt.volume=Dt.volume.split("(")[0],Dt.volume=Dt.volume.trim();try{Dt.issue=Ct.split("(")[1].split(")")[0],Dt.issue=Dt.issue.trim()}catch(e){}}if(Dt.volume.includes(",")){Dt.volume=Dt.volume.split(",")[0],Dt.volume=Dt.volume.trim();try{Dt.issue=Ct.split(",")[1],Dt.issue=Dt.issue.trim()}catch(e){}}if(Dt.volume)try{isNaN(parseInt(Dt.volume))&&delete Dt.volume}catch(e){}if(Dt.issue){Dt.issue.includes(",")&&(Dt.issue=Dt.issue.split(",")[0].trim());try{isNaN(parseInt(Dt.issue))&&delete Dt.issue}catch(e){}}if(Dt.volume&&Dt.issue)try{(Ct=e.split(Dt.journal)[1]).includes("retriev")&&(Ct=Ct.split("retriev")[0]),Ct.includes("Retriev")&&(Ct=Ct.split("Retriev")[0]),Dt.url&&Ct.includes(Dt.url)&&(Ct=Ct.split(Dt.url)[0]),Dt.doi&&Ct.includes(Dt.doi)&&(Ct=Ct.split(Dt.doi)[0]),(Ct=(Ct=Ct.substring(Ct.indexOf(Dt.volume)+(Dt.volume+"").length)).substring(Ct.indexOf(Dt.issue)+(Dt.issue+"").length)).indexOf(".")<2&&(Ct=Ct.replace(".","")),Ct.indexOf(",")<2&&(Ct=Ct.replace(",","")),Ct.indexOf(")")<2&&(Ct=Ct.replace(")","")),Ct=Ct.trim(),isNaN(parseInt(Ct.substring(0,1)))||(Dt.pages=Ct.split(" ")[0].split(".")[0].trim(),Dt.pages.length>5&&(Dt.pages=Dt.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!Dt.author&&e.includes("et al")&&(u=e.split("et al")[0].trim(),e.startsWith(u)&&(Dt.author=[{name:u+"et al"}])),Dt.title&&!Dt.volume)try{(o=e.split(Dt.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Dt.volume=o.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Dt.issue&&o.includes("iss")&&(Dt.issue=o.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Dt.pages&&o.includes("page")&&(Dt.pages=o.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof Dt.year&&(Dt.year=Dt.year.toString()),Dt},L=[].indexOf,t.find_diffs=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;for((x={count:[],ignoring:(null!=(c=this.params.ignore)?c:"journal_short,shortname,subject,keyword,DOI").split(","),dois:["10.1073/pnas.1905762116","10.1111/j.1600-051x.1988.tb01596.x","10.1186/s12888-019-2120-9","10.1021/acsanm.8b00798","10.1001/archinte.1963.03860030092007","10.1001/jamainternmed.2019.6770","10.1090/s0002-9939-2014-12202-7","10.1045.joes-fake-doi","10.3726/978-3-653-04227-6","10.1016/b978-1-78242-121-4.00003-4","10.1036/1097-8542.198450","10.1063/1.4905616","10.1080/03071843809419849","10.1134/s1068162014030066","10.15650/hebruniocollannu.89.2018.0221","10.1111/j.1474-919x.1995.tb08455.x","10.2164/jandrol.111.014894","10.1111/j.1600-051x.1988.tb01596.x","10.1103/physreve.83.066702","10.1016/j.foot.2017.04.003","10.1134/S1019331619060042"]}).find={},r=0,l=(p=x.dois).length;r<l;r++){i=p[r],x.find[i]={},u=await this.find_old(i);try{for(f=u.metadata.author,s=0,a=f.length;s<a;s++){e=f[s];try{e.affiliation=e.affiliation.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}}}catch(e){}try{u.metadata.author=u.metadata.author.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}o=await this.find(i);try{o.metadata.author=o.metadata.author.sort((function(e,t){return e.name.localeCompare(t.name)}))}catch(e){}for(n in(null!=(m=u.url)?m:"").toLowerCase()!==(null!=(y=o.url)?y:"").toLowerCase()&&(x.find[i].url_old=null!=(g=u.url)?g:"",x.find[i].url_new=null!=(_=o.url)?_:""),u.metadata)"object"==typeof u.metadata[n]&&(u.metadata[n]=JSON.stringify(u.metadata[n])),"object"==typeof o.metadata[n]&&(o.metadata[n]=JSON.stringify(o.metadata[n])),L.call(x.ignoring,n)<0&&(null!=(v=u.metadata[n])?v:"").toLowerCase()!==(null!=(b=o.metadata[n])?b:"").toLowerCase()&&(x.find[i][n+"_old"]=null!=(w=u.metadata[n])?w:"",x.find[i][n+"_new"]=null!=(d=o.metadata[n])?d:"",x.find[i][n+"_old"]&&x.find[i][n+"_new"]&&(x.find[i][n+"_lev"]=(await this.levenshtein(x.find[i][n+"_old"],x.find[i][n+"_new"])).distance),L.call(x.count,i)<0&&x.count.push(i));for(t in o.metadata)L.call(x.ignoring,t)<0&&o.metadata[t]&&null==u.metadata[t]&&(x.find[i][t+"_old"]="",x.find[i][t+"_new"]="object"==typeof o.metadata[t]?JSON.stringify(o.metadata[t]):null!=(h=o.metadata[t])?h:"",L.call(x.count,i)<0&&x.count.push(i))}return x.count=x.count.length+"/"+x.dois.length,x},t.find_old=async function(e,t={},i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;w={},s=async e=>{var i,r;for(r in i=await this.citation_old(e))"url"===r||"paywall"===r?null==w[r]&&(w[r]=i[r]):t[r]||(t[r]=i[r]);return!0},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(d=e.dom)?d:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find_old=e.metadata),e.find_old&&(e.find_old.startsWith("10.")&&e.find_old.includes("/")?e.doi=e.find_old:e.url=e.find_old,delete e.find_old),null==e.url&&(e.url=null!=(h=e.q)?h:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(a="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&a.split("/")[0].length>6&&a.length>8&&((o=a.split("/")).length>2&&(a=o.join("/")),null==t.doi&&(t.doi=a)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(f=e.url.replace("...","").match(/\./gi))?f:[]).length>3||(null!=(m=e.url.match(/\(/gi))?m:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(y=e.title.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(g=e.title.match(/\(/gi))?g:[]).length>2)&&(e.citation=e.title,delete e.title),e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(_=e.pmcid)?_:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}for("string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(w.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(v=e.from)||"eZwJ83xp3oZDaec86"===v)&&null==w.demo&&(w.demo=!0),w.demo&&null==w.test&&(w.test=!0),u=!1,l=async()=>{var r,n,l,a,o;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(o=await this.scrape(null!=i?i:e.url),await s(o)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(a=t.pmcid)?a:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(l=await this.src.crossref.works.title(t.title))?l.type:void 0)&&(null!=l?l.DOI:void 0)&&await s(l),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(n=async()=>{var e;return null==(e=await this.src.oadoi.doi(t.doi))&&(w.doi_not_in_oadoi=t.doi),(null!=e?e.doi:void 0)&&(null!=t?t.doi:void 0)&&e.doi.toLowerCase()===t.doi.toLowerCase()&&await s(e),!0},r=async()=>{if(null!=(l=await this.src.crossref.works.doi(t.doi))?l.type:void 0){try{l.published=await this.src.crossref.works.published(l);try{l.year=l.published.split("-")[0]}catch(e){}try{l.year=parseInt(l.year)}catch(e){}try{l.publishedAt=await this.epoch(l.published)}catch(e){}}catch(e){}await s(l)}else w.doi_not_in_crossref=t.doi;return!0},await Promise.all([n(),r()])),!0},await l(),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==w.ill&&(w.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==w.permissions&&(w.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]),c=0,p=(b=["title","journal","year","doi"]).length;c<p;c++)e[x=b[c]]&&e[x]!==t[x]&&(t[x]=e[x]);return w.metadata=t,w},t.citation_old=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et,tt,it,rt,st,nt,lt,at,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Lt;bt={};try{null==e&&(e=null!=(R=this.params.citation_old)?R:this.params)}catch(e){}if("string"==typeof e)if(e.startsWith("{")||e.startsWith("["))try{e=JSON.parse(e)}catch(e){}else if(e.startsWith("10."))try{e=await this.src.crossref.works.doi(e)}catch(e){}if("object"==typeof e){bt.doi=null!=(T=e.DOI)?T:e.doi,bt.pmid=null!=(V=e.pmid)?V:null!=(se=e.ids)?se.pmid:void 0,bt.pmcid=null!=(me=e.pmcid)?me:null!=(Se=e.ids)?Se.pmcid:void 0;try{bt.type=null!=(qe=null!=(Ge=e.type_crossref)?Ge:e.type)?qe:e.genre}catch(e){}null==bt.issn&&(bt.issn=null!=(nt=null!=(yt=null!=(q=null!=(W=e.ISSN)?W:e.issn)?q:null!=(U=e.journalInfo)&&null!=(M=U.journal)?M.issn:void 0)?yt:null!=(z=e.journal)?z.issn:void 0)?nt:null!=(F=e.primary_location)&&null!=(B=F.source)?B.issn:void 0),null!=(null!=(J=e.journalInfo)&&null!=($=J.journal)?$.eissn:void 0)&&(null==bt.issn&&(bt.issn=[]),"string"==typeof bt.issn&&(bt.issn=[bt.issn]),X=e.journalInfo.journal.eissn,L.call(bt.issn,X)<0&&bt.issn.push(e.journalInfo.journal.eissn)),!bt.issn&&e.journal_issns&&(bt.issn=e.journal_issns.split(",")),bt.title=e.title,Array.isArray(bt.title)&&(bt.title=bt.title[0]),bt.title&&null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(bt.title+=": "+e.subtitle[0]),null==bt.title&&(bt.title=null!=(G=e.dctitle)?G:null!=(H=e.bibjson)?H.title:void 0),404!==(Y=bt.title)&&"404"!==Y||delete bt.title,"string"==typeof bt.title&&(bt.title=bt.title.replace(/\s\s+/g," ").trim()),null==bt.journal&&(bt.journal=e["container-title"]?e["container-title"][0]:null!=(Z=e.primary_location)&&null!=(K=Z.source)?K.display_name:void 0);try{bt.shortname=e["short-container-title"][0]}catch(e){}try{bt.shortname=null!=(Q=e.journalInfo.journal.isoabbreviation)?Q:e.journalInfo.journal.medlineAbbreviation}catch(e){}bt.shortname&&!bt.journal_short&&(bt.journal_short=bt.shortname),null==bt.journal&&(bt.journal=null!=(ee=null!=(te=e.journal_name)?te:null!=(ie=e.journalInfo)&&null!=(re=ie.journal)?re.title:void 0)?ee:null!=(ne=e.journal)?ne.title:void 0),e.journal&&(bt.journal=e.journal.split("(")[0].trim());try{for(u=0,m=(le=["title","journal"]).length;u<m;u++)null==bt[d=le[u]]&&(bt[d]=bt[d].charAt(0).toUpperCase()+bt[d].slice(1))}catch(e){}null==bt.publisher&&(bt.publisher=null!=(ae=e.publisher)?ae:null!=(oe=e.primary_location)&&null!=(ue=oe.source)?ue.publisher:void 0),bt.publisher&&(bt.publisher=bt.publisher.trim()),null==bt.published&&(bt.published=e.publication_date);try{null==bt.issue&&(bt.issue=null!=(ce=null!=(pe=e.issue)?pe:null!=(de=e.journalInfo)?de.issue:void 0)?ce:null!=(he=e.biblio)?he.issue:void 0)}catch(e){}try{null==bt.volume&&(bt.volume=null!=(fe=null!=(ye=e.volume)?ye:null!=(ge=e.journalInfo)?ge.volume:void 0)?fe:null!=(_e=e.biblio)?_e.volume:void 0)}catch(e){}for((e.page||e.pages||e.pageInfo)&&null==bt.pages&&(bt.pages=(null!=(ve=e.page)?ve:e.pageInfo).toString()),((null!=(be=e.biblio)?be.first_page:void 0)||(null!=(we=e.biblio)?we.last_page:void 0))&&(bt.pages=(null!=(xe=e.biblio.first_page)?xe:"")+(e.biblio.first_page&&e.biblio.last_page?" to ":"")+(null!=(Oe=e.biblio.last_page)?Oe:"")),bt.abstract=null!=(ke=e.abstract)?ke:e.abstractText,c=0,y=(je=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;c<y;c++)if(D=je[c],"string"!=typeof bt.published){if(xt=null!=(Ie=null!=(Ae=e[D])?Ae:null!=(De=e["journal-issue"])?De[D.replace("journal-issue.","")]:void 0)?Ie:null!=(Ce=e.journalInfo)?Ce[D.replace("journalInfo.","")]:void 0){"number"==typeof xt&&(xt=xt.toString());try{"string"!=typeof xt&&(xt=xt["date-time"].toString())}catch(e){}if("string"!=typeof xt)try{for(p in xt["date-parts"][0])"number"!=(Le=typeof xt["date-parts"][0][p])&&"string"!==Le&&(xt["date-parts"][0][p]="01");xt=xt["date-parts"][0].join("-")}catch(e){}"string"==typeof xt&&(bt.published=xt.includes("T")?xt.split("T")[0]:xt,bt.published=bt.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),bt.published.includes("-")||(bt.published+="-01"),3!==bt.published.split("-").length&&(bt.published+="-01"),null==bt.year&&(bt.year=bt.published.split("-")[0]),3!==bt.published.split("-").length&&delete bt.published,4!==bt.year.toString().length&&delete bt.year)}if(bt.published)break}e.year&&null==bt.year&&(bt.year=e.year);try{null==bt.year&&(bt.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(!bt.year&&bt.published&&bt.published.includes("-")&&(bt.year=bt.published.split("-")[0]),null==bt.author&&(null!=e.author||null!=e.z_authors||(null!=(Ne=e.authorList)?Ne.author:void 0)||e.authorships)){null==bt.author&&(bt.author=[]);try{for(Te=null!=(Ee=null!=(Pe=null!=(Re=e.author)?Re:e.z_authors)?Pe:e.authorList.author)?Ee:e.authorships,E=0,v=Te.length;E<v;E++)if("string"==typeof(t=Te[E]))bt.author.push({name:t});else{if(s={},"object"==typeof t.author)for(s.name=t.author.display_name,s.family=s.name.split(" ").pop(),s.name.split(" ").length>1&&(s.given=s.name.split(" ")[0]),Ue=null!=(We=s.raw_affiliation_strings)?We:[],P=0,b=Ue.length;P<b;P++)i=Ue[P],null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i});else for(s.given=null!=(Me=t.given)?Me:t.firstName,s.family=null!=(ze=t.family)?ze:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(Fe=s.family)?Fe:""),Je=t.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:null!=(Be=t.authorAffiliationDetailsList.authorAffiliation)?Be:[],Ot=0,w=Je.length;Ot<w;Ot++)"string"==typeof(i=Je[Ot])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=($e=i.name)?$e:i.affiliation).replace(/\s\s+/g," ").trim()}));bt.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(bt.subject=e.subject)}catch(e){}try{null!=(null!=(Xe=e.keywordList)?Xe.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(bt.keyword=e.keywordList.keyword)}catch(e){}if(!bt.keyword&&e.keywords)for(bt.keyword=[],jt=0,x=(Ve=e.keywords).length;jt<x;jt++)h=Ve[jt],bt.keyword.push(h.keyword);try{for(Qe=[...null!=(He=null!=(Ye=e.meshHeadingList)?Ye.meshHeading:void 0)?He:[],...null!=(Ze=null!=(Ke=e.chemicalList)?Ke.chemical:void 0)?Ze:[]],St=0,O=Qe.length;St<O;St++)I=Qe[St],null==bt.keyword&&(bt.keyword=[]),"string"==typeof(A="string"==typeof I?I:null!=(et=I.name)?et:I.descriptorName)&&A&&L.call(bt.keyword,A)<0&&bt.keyword.push(A)}catch(e){}"string"==typeof e.license&&(bt.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(bt.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(tt=e.best_oa_location)?tt.license:void 0)&&null==bt.licence&&(bt.licence=e.best_oa_location.license)}catch(e){}try{(null!=(it=e.primary_location)?it.license:void 0)&&null==bt.licence&&(bt.licence=e.primary_location.license)}catch(e){}if(!bt.licence){for(It=0,k=(st=null!=(rt=e.assertion)?rt:[]).length;It<k;It++)"OPEN ACCESS"===(t=st[It]).label&&t.URL&&t.URL.includes("creativecommons")&&null==bt.licence&&(bt.licence=t.URL);for(At=0,j=(at=null!=(lt=e.license)?lt:[]).length;At<j;At++)!(f=at[At]).URL||!f.URL.includes("creativecommons")||bt.licence&&bt.licence.includes("creativecommons")||null==bt.licence&&(bt.licence=f.URL)}if("string"==typeof bt.licence&&bt.licence.includes("/licenses/")&&(bt.licence="cc-"+bt.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==bt.url&&(bt.url=null!=(ot=null!=(ut=null!=(ct=null!=(pt=e.best_oa_location)?pt.pdf_url:void 0)?ct:null!=(dt=e.best_oa_location)?dt.url_for_pdf:void 0)?ut:null!=(ht=e.best_oa_location)?ht.url:void 0)?ot:null!=(ft=e.best_oa_location)?ft.landing_page_url:void 0),!bt.url&&null!=(null!=(mt=e.fullTextUrlList)?mt.fullTextUrl:void 0))for(Dt=0,S=(gt=e.fullTextUrlList.fullTextUrl).length;Dt<S;Dt++)"oa"!==(_t=(l=gt[Dt]).availabilityCode.toLowerCase())&&"f"!==_t||bt.url&&("pdf"!==l.documentStyle||bt.url.includes("pdf"))||(bt.url=l.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(bt.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(bt.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!bt.doi&&e.includes("http")&&(bt.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(bt.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?bt.title=e.split('"')[1].trim():e.split("'").length>2&&null==bt.title&&(bt.title=e.split("'")[1].trim())}catch(e){}try{for(N=e.replace(/,\./g," ").split(" "),Ct=0,g=N.length;Ct<g;Ct++)C=N[Ct],bt.year||4===(C=C.replace(/[^0-9]/g,"")).length&&("number"!=typeof(kt=parseInt(C))||isNaN(kt)||(bt.year=kt))}catch(e){}try{!bt.title&&bt.year&&e.indexOf(bt.year)<e.length/4&&(bt.title=e.split(bt.year)[1].trim(),(!bt.title.includes("(")||bt.title.indexOf(")")<bt.title.indexOf("("))&&(bt.title=bt.title.replace(")","")),bt.title.indexOf(".")<3&&(bt.title=bt.title.replace(".","")),bt.title.indexOf(",")<3&&(bt.title=bt.title.replace(",","")),bt.title=bt.title.trim(),bt.title.includes(".")?bt.title=bt.title.split(".")[0]:bt.title.includes(",")&&(bt.title=bt.title.split(",")[0]))}catch(e){}if(bt.title){try{if(n=e.split(bt.title)[0],bt.year&&n.includes(bt.year)&&(n=n.split(bt.year)[0]),bt.url&&n.indexOf(bt.url)>0&&(n=n.split(bt.url)[0]),bt.url&&n.startsWith(bt.url)&&(n=n.replace(bt.url)),bt.doi&&n.startsWith(bt.doi)&&(n=n.replace(bt.doi)),n.indexOf(".")<3&&(n=n.replace(".","")),n.indexOf(",")<3&&(n=n.replace(",","")),n.lastIndexOf("(")>n.length-3&&(n=n.substring(0,n.lastIndexOf("("))),n.lastIndexOf(")")>n.length-3&&(n=n.substring(0,n.lastIndexOf(")"))),n.lastIndexOf(",")>n.length-3&&(n=n.substring(0,n.lastIndexOf(","))),n.lastIndexOf(".")>n.length-3&&(n=n.substring(0,n.lastIndexOf("."))),(n=n.trim()).length>6)if(n.includes(","))for(bt.author=[],vt=n.split(","),Lt=0,_=vt.length;Lt<_;Lt++)r=vt[Lt],bt.author.push({name:r});else bt.author=[{name:n}]}catch(e){}try{wt=e.split(bt.title)[1],bt.url&&wt.includes(bt.url)&&(wt=wt.replace(bt.url)),bt.doi&&wt.includes(bt.doi)&&(wt=wt.replace(bt.doi)),wt.indexOf(".")<3&&(wt=wt.replace(".","")),wt.indexOf(",")<3&&(wt=wt.replace(",","")),(wt=wt.trim()).length>6&&(bt.journal=wt,wt.includes(",")&&(bt.journal=bt.journal.split(",")[0].replace(/in /gi,"").trim()),bt.journal.indexOf(".")<3&&(bt.journal=bt.journal.replace(".","")),bt.journal.indexOf(",")<3&&(bt.journal=bt.journal.replace(",","")),bt.journal=bt.journal.trim())}catch(e){}}try{if(bt.journal&&(wt=e.split(bt.journal)[1],bt.url&&wt.includes(bt.url)&&(wt=wt.replace(bt.url)),bt.doi&&wt.includes(bt.doi)&&(wt=wt.replace(bt.doi)),wt.indexOf(".")<3&&(wt=wt.replace(".","")),wt.indexOf(",")<3&&(wt=wt.replace(",","")),(wt=wt.trim()).length>4)){if(wt.includes("retrieved")&&(wt=wt.split("retrieved")[0]),wt.includes("Retrieved")&&(wt=wt.split("Retrieved")[0]),bt.volume=wt,bt.volume.includes("(")){bt.volume=bt.volume.split("(")[0],bt.volume=bt.volume.trim();try{bt.issue=wt.split("(")[1].split(")")[0],bt.issue=bt.issue.trim()}catch(e){}}if(bt.volume.includes(",")){bt.volume=bt.volume.split(",")[0],bt.volume=bt.volume.trim();try{bt.issue=wt.split(",")[1],bt.issue=bt.issue.trim()}catch(e){}}if(bt.volume)try{isNaN(parseInt(bt.volume))&&delete bt.volume}catch(e){}if(bt.issue){bt.issue.includes(",")&&(bt.issue=bt.issue.split(",")[0].trim());try{isNaN(parseInt(bt.issue))&&delete bt.issue}catch(e){}}if(bt.volume&&bt.issue)try{(wt=e.split(bt.journal)[1]).includes("retriev")&&(wt=wt.split("retriev")[0]),wt.includes("Retriev")&&(wt=wt.split("Retriev")[0]),bt.url&&wt.includes(bt.url)&&(wt=wt.split(bt.url)[0]),bt.doi&&wt.includes(bt.doi)&&(wt=wt.split(bt.doi)[0]),(wt=(wt=wt.substring(wt.indexOf(bt.volume)+(bt.volume+"").length)).substring(wt.indexOf(bt.issue)+(bt.issue+"").length)).indexOf(".")<2&&(wt=wt.replace(".","")),wt.indexOf(",")<2&&(wt=wt.replace(",","")),wt.indexOf(")")<2&&(wt=wt.replace(")","")),wt=wt.trim(),isNaN(parseInt(wt.substring(0,1)))||(bt.pages=wt.split(" ")[0].split(".")[0].trim(),bt.pages.length>5&&(bt.pages=bt.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!bt.author&&e.includes("et al")&&(o=e.split("et al")[0].trim(),e.startsWith(o)&&(bt.author=[{name:o+"et al"}])),bt.title&&!bt.volume)try{(a=e.split(bt.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(bt.volume=a.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!bt.issue&&a.includes("iss")&&(bt.issue=a.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!bt.pages&&a.includes("page")&&(bt.pages=a.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof bt.year&&(bt.year=bt.year.toString()),bt},t.availability=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&e.availability.includes("/")?e.doi=e.availability:e.availability.includes(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(n=null!=(l=null!=(g=null!=(b=null!=(w=null!=(x=null!=(O=null!=(k=e.doi)?k:e.pmid)?O:e.pmc)?x:e.pmcid)?w:e.title)?b:e.url)?g:e.id)?l:e.citation)?n:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.find(e)),null!=i.v2){null==(r=i.data).match&&(r.match=null!=(j=null!=(S=null!=(a=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(p=i.v2.metadata)?p.doi:void 0)?u:null!=(d=i.v2.metadata)?d.title:void 0)?o:null!=(h=i.v2.metadata)?h.pmid:void 0)?a:null!=(f=i.v2.metadata)?f.pmc:void 0)?S:null!=(m=i.v2.metadata)?m.pmcid:void 0)?j:null!=(y=i.v2.metadata)?y.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(s=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(A=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+s+" AND type:article&sort=createdAt:desc"))&&null!=(_=A.hits)?_.total:void 0)&&((D={type:"article",_id:(I=A.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(v=I.user)?v.id:void 0)!==e.uid),i.data.requests.push(D))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},L=[].indexOf,t.ill=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;if(this.S.shutdown&&"ill"===this.fn)return D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"};null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),s=e.config;try{s=JSON.parse(s)}catch(e){}for(p in("string"==typeof s||!s&&e.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=e.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:s)))),null==s&&(s={}),O={name:"librarian",details:""},d=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(c in e[p])"email"!==c&&(e[c]=e[p][c],L.call(d,c)<0&&d.push(c));delete e.metadata}else L.call(d,p)<0&&d.push(p);for(l=0,o=d.length;l<o;l++)if(e[h=d[l]]&&(O[h]=e[h],"author"===h)){for(n=!0,r=[],a=0,u=(y=e[h]).length;a<u;a++)(t=y[a]).family&&(n&&(n=!1),i=t.family+(t.given?" "+t.given:""),r.push(i));O[h]=r}return null!=e.author&&delete e.author,O.illid=e._id=await this.uid(),s.search&&s.search.length&&(e.issn||e.journal)&&(-1!==s.search.indexOf("worldcat")?(b=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",b+=null!=e.issn?"in%3A":"ti%3A",b+="&si0qs="+(null!=(g=e.issn)?g:e.journal),b+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(b=s.search,b+=e.issn?e.issn:e.journal),O.worldcatsearchurl=b),await this.ills(e),w=(w=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!s.email&&!e.email||this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,to:null!=(_=s.email)?_:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id})),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),x=["joe+notifications@oa.works"],(null!=(v=this.S.log)?v.logs:void 0)&&x.push(this.S.log.logs),this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:x})),e},t.ills={_index:!0},t.ill.collect=async function(e){var t,i,r;if(this.S.shutdown&&"ill.collect"===this.fn)return D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"};for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},t.ill.openurl=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h;if(this.S.shutdown&&"ill.openurl"===this.fn)return D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"};for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=s[r]);for(l in d="",e.ill_added_params&&(d+=e.ill_added_params.replace("?","")+"&"),d+=e.sid+"=InstantILL&",t){if(h="","author"===l)for(n=0,a=(p=Array.isArray(t.author)?t.author:[t.author]).length;n<a;n++)i=p[n],h.length&&(h+=", "),h+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==l&&"pmid"!==l&&"pmc"!==l&&"pmcid"!==l&&"url"!==l&&"journal"!==l&&"title"!==l&&"year"!==l&&"issn"!==l&&"volume"!==l&&"issue"!==l&&"page"!==l&&"crossref_type"!==l&&"publisher"!==l&&"published"!==l&&"notes"!==l||(h=t[l]);h&&(d+=(e[l]?e[l]:l)+"="+encodeURIComponent(h)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(o+"=")?d+="&"+o+"=The user provided some metadata.":d=d.replace(o+"=",o+"=The user provided some metadata. ")),d.replace("/&&/g","&")},t.ill.subscription=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;if(this.S.shutdown&&"ill.subscription"===this.fn)return D.log("***SHUTDOWN***",this.fn,this.request.url,this.S.shutdown),{status:503,body:"This API will be permanently shut down on November 18, 2025. This brownout will end at "+this.S.shutdown+". Please migrate your usage as soon as possible to avoid service disruption. Learn more: https://blog.oa.works/sunsetting-the-open-access-button-instantill/"};if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(a=this.params.config)?a:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(p in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),n=await this.ill.openurl(e,t),e.ill_added_params&&(n=n.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(h=e.subscription[p])?(f=h.type,h=h.url):f=null!=(u=e.subscription_type[p])?u:"unknown",h=h.trim()){"serialssolutions"===f||-1!==h.indexOf("serialssolutions")?(-1!==(y=h.split(".search")[0]).indexOf("//")&&(y=y.split("//")[1]),h="http://"+y+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===h.indexOf("sfx.")||-1!==h.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===h.indexOf(".exlibris")||-1!==h.indexOf("response_type")||(h=h.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):h+=(-1===h.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=h+(-1===h.indexOf("?")?"?":"&")+n).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==h.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==h.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),l="",d="",i=!1,c.lookups.push(g);try{null!=(l=await this.fetch(g))&&"object"!=typeof l||(l="",i=!0)}catch(e){i=!0}try{d=-1!==l.indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,c.contents.push(d)}catch(e){i=!0}if("sfx"===f||-1!==g.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{c.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(e){}else-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==g.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">'))(r=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=r,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===d.indexOf("ss_noresults")){m=g.split("?")[0]+"?ShowSupressedLinks"+l.split("?ShowSupressedLinks")[1].split('">')[0];try{-1!==(s=await this.fetch(m)).indexOf("ArticleCL")&&-1!==s.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+s.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(e){i&&c.error.push("serialssolutions")}}}else"exlibris"!==f&&-1===g.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")&&(c.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},L=[].indexOf,t.ill_grace=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;null==e&&(e=this.copy(this.params)).ill_grace&&(e.doi=e.ill_grace,delete e.ill_grace),null==e.metadata&&(e.metadata=await this.metadata_grace(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),s=e.config;try{s=JSON.parse(s)}catch(e){}for(p in("string"==typeof s||!s&&e.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=e.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:s)))),null==s&&(s={}),O={name:"librarian",details:""},d=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(c in e[p])"email"!==c&&(e[c]=e[p][c],L.call(d,c)<0&&d.push(c));delete e.metadata}else L.call(d,p)<0&&d.push(p);for(l=0,o=d.length;l<o;l++)if(e[h=d[l]]&&(O[h]=e[h],"author"===h)){for(n=!0,r=[],a=0,u=(y=e[h]).length;a<u;a++)(t=y[a]).family&&(n&&(n=!1),i=t.family+(t.given?" "+t.given:""),r.push(i));O[h]=r}return null!=e.author&&delete e.author,O.illid=e._id=await this.uid(),s.search&&s.search.length&&(e.issn||e.journal)&&(-1!==s.search.indexOf("worldcat")?(b=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",b+=null!=e.issn?"in%3A":"ti%3A",b+="&si0qs="+(null!=(g=e.issn)?g:e.journal),b+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(b=s.search,b+=e.issn?e.issn:e.journal),O.worldcatsearchurl=b),await this.ills(e),w=(w=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!s.email&&!e.email||this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,to:null!=(_=s.email)?_:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id})),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),x=["joe+notifications@oa.works"],(null!=(v=this.S.log)?v.logs:void 0)&&x.push(this.S.log.logs),this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:x})),e},t.ill_grace.collect=async function(e){var t,i,r;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},t.ill_grace.openurl=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h;for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata_grace()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=s[r]);for(l in d="",e.ill_added_params&&(d+=e.ill_added_params.replace("?","")+"&"),d+=e.sid+"=InstantILL&",t){if(h="","author"===l)for(n=0,a=(p=Array.isArray(t.author)?t.author:[t.author]).length;n<a;n++)i=p[n],h.length&&(h+=", "),h+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==l&&"pmid"!==l&&"pmc"!==l&&"pmcid"!==l&&"url"!==l&&"journal"!==l&&"title"!==l&&"year"!==l&&"issn"!==l&&"volume"!==l&&"issue"!==l&&"page"!==l&&"crossref_type"!==l&&"publisher"!==l&&"published"!==l&&"notes"!==l||(h=t[l]);h&&(d+=(e[l]?e[l]:l)+"="+encodeURIComponent(h)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(o+"=")?d+="&"+o+"=The user provided some metadata.":d=d.replace(o+"=",o+"=The user provided some metadata. ")),d.replace("/&&/g","&")},t.ill_grace.subscription=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata_grace(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(a=this.params.config)?a:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(p in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),n=await this.ill_grace.openurl(e,t),e.ill_added_params&&(n=n.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(h=e.subscription[p])?(f=h.type,h=h.url):f=null!=(u=e.subscription_type[p])?u:"unknown",h=h.trim()){"serialssolutions"===f||-1!==h.indexOf("serialssolutions")?(-1!==(y=h.split(".search")[0]).indexOf("//")&&(y=y.split("//")[1]),h="http://"+y+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===h.indexOf("sfx.")||-1!==h.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===h.indexOf(".exlibris")||-1!==h.indexOf("response_type")||(h=h.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):h+=(-1===h.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=h+(-1===h.indexOf("?")?"?":"&")+n).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==h.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==h.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),l="",d="",i=!1,c.lookups.push(g);try{null!=(l=await this.fetch(g))&&"object"!=typeof l||(l="",i=!0)}catch(e){i=!0}try{d=-1!==l.indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,c.contents.push(d)}catch(e){i=!0}if("sfx"===f||-1!==g.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{c.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(e){}else-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==g.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">'))(r=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=r,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===d.indexOf("ss_noresults")){m=g.split("?")[0]+"?ShowSupressedLinks"+l.split("?ShowSupressedLinks")[1].split('">')[0];try{-1!==(s=await this.fetch(m)).indexOf("ArticleCL")&&-1!==s.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+s.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(e){i&&c.error.push("serialssolutions")}}}else"exlibris"!==f&&-1===g.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")&&(c.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},L=[].indexOf,t.ill_internal=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;null==e&&(e=this.copy(this.params)).ill_internal&&(e.doi=e.ill_internal,delete e.ill_internal),null==e.metadata&&(e.metadata=await this.metadata_internal(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),s=e.config;try{s=JSON.parse(s)}catch(e){}for(p in("string"==typeof s||!s&&e.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=e.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:s)))),null==s&&(s={}),O={name:"librarian",details:""},d=["title","author","volume","issue","date","pages"],e)if("metadata"===p){for(c in e[p])"email"!==c&&(e[c]=e[p][c],L.call(d,c)<0&&d.push(c));delete e.metadata}else L.call(d,p)<0&&d.push(p);for(l=0,o=d.length;l<o;l++)if(e[h=d[l]]&&(O[h]=e[h],"author"===h)){for(n=!0,r=[],a=0,u=(y=e[h]).length;a<u;a++)(t=y[a]).family&&(n&&(n=!1),i=t.family+(t.given?" "+t.given:""),r.push(i));O[h]=r}return null!=e.author&&delete e.author,O.illid=e._id=await this.uid(),s.search&&s.search.length&&(e.issn||e.journal)&&(-1!==s.search.indexOf("worldcat")?(b=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",b+=null!=e.issn?"in%3A":"ti%3A",b+="&si0qs="+(null!=(g=e.issn)?g:e.journal),b+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(b=s.search,b+=e.issn?e.issn:e.journal),O.worldcatsearchurl=b),await this.ills(e),w=(w=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!s.email&&!e.email||this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,to:null!=(_=s.email)?_:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id})),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),x=["joe+notifications@oa.works"],(null!=(v=this.S.log)?v.logs:void 0)&&x.push(this.S.log.logs),this.waitUntil(this.mail({svc:"oaworks",vars:O,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:x})),e},t.ill_internal.collect=async function(e){var t,i,r;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},t.ill_internal.openurl=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h;for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata_internal()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=s[r]);for(l in d="",e.ill_added_params&&(d+=e.ill_added_params.replace("?","")+"&"),d+=e.sid+"=InstantILL&",t){if(h="","author"===l)for(n=0,a=(p=Array.isArray(t.author)?t.author:[t.author]).length;n<a;n++)i=p[n],h.length&&(h+=", "),h+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==l&&"pmid"!==l&&"pmc"!==l&&"pmcid"!==l&&"url"!==l&&"journal"!==l&&"title"!==l&&"year"!==l&&"issn"!==l&&"volume"!==l&&"issue"!==l&&"page"!==l&&"crossref_type"!==l&&"publisher"!==l&&"published"!==l&&"notes"!==l||(h=t[l]);h&&(d+=(e[l]?e[l]:l)+"="+encodeURIComponent(h)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(o+"=")?d+="&"+o+"=The user provided some metadata.":d=d.replace(o+"=",o+"=The user provided some metadata. ")),d.replace("/&&/g","&")},t.ill_internal.subscription=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata_internal(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(a=this.params.config)?a:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(p in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),n=await this.ill_internal.openurl(e,t),e.ill_added_params&&(n=n.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(h=e.subscription[p])?(f=h.type,h=h.url):f=null!=(u=e.subscription_type[p])?u:"unknown",h=h.trim()){"serialssolutions"===f||-1!==h.indexOf("serialssolutions")?(-1!==(y=h.split(".search")[0]).indexOf("//")&&(y=y.split("//")[1]),h="http://"+y+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===h.indexOf("sfx.")||-1!==h.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===h.indexOf(".exlibris")||-1!==h.indexOf("response_type")||(h=h.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):h+=(-1===h.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=h+(-1===h.indexOf("?")?"?":"&")+n).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==h.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==h.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),l="",d="",i=!1,c.lookups.push(g);try{null!=(l=await this.fetch(g))&&"object"!=typeof l||(l="",i=!0)}catch(e){i=!0}try{d=-1!==l.indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,c.contents.push(d)}catch(e){i=!0}if("sfx"===f||-1!==g.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{c.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(e){}else-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==g.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">'))(r=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=r,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===d.indexOf("ss_noresults")){m=g.split("?")[0]+"?ShowSupressedLinks"+l.split("?ShowSupressedLinks")[1].split('">')[0];try{-1!==(s=await this.fetch(m)).indexOf("ArticleCL")&&-1!==s.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+s.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(e){i&&c.error.push("serialssolutions")}}}else"exlibris"!==f&&-1===g.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")&&(c.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},t.licence=async function(e,t,i,r){var s,n,l,a,o,u,c,p,d,h,f,m,y;if(null==e&&(e=this.params.url),null==t&&(t=null!=(c=this.params.content)?c:this.body),e||t||!this.params.licence&&!this.params.doi||(e="https://doi.org/"+(null!=(p=this.params.licence)?p:this.params.doi)),e&&(e=e.replace(/(^\s*)|(\s*$)/g,""),!t)){D.log(e);try{t=await this.fetch(e)}catch(e){}}if("number"==typeof t&&(t=void 0),null==i&&(i=this.params.start),null==r&&(r=this.params.end),a={},e&&(a.url=e),"string"==typeof t)for(null!=i&&t.includes(i)&&(t=t.split(i)[1]),r&&(t=t.split(r)[0]),t.length>1e5&&(a.large=!0,t=t.substring(0,5e4)+t.substring(t.length-5e4,t.length)),s=0,l=(f=null!=(d=null!=(o=await this.licences("*",1e4))&&null!=(h=o.hits)?h.hits:void 0)?d:[]).length;s<l;s++)if((!(n=f[s]._source).matchesondomains||"*"===n.matchesondomains||null==e||n.matchesondomains.toLowerCase().includes(e.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=n.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(m=!!(y=!!n.matchtext.includes("://")&&n.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&t.toLowerCase().includes(y))||t.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){a.licence=n.licencetype,a.match=n.matchtext,a.matched=m?y:u;break}return a},t.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1},L=[].indexOf,t.oareport=function(){return"OA.Works OA.report"},t.oareport.works={_index:!0};try{t.oareport.email=t.report.email}catch(e){}t.oareport.orgs={_sheet:"1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data",_format:async function(e=[]){var t,i,r,s,n,l,a,o,u,c,p,d;for(o=[],r=0,n=(c="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<n;r++){for(i in a={},u=c[r]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(e){t=e,D.log("cant parse "+i,u[i],t)}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(a,i,u[i])}catch(e){}else a[i]=u[i]}if(Array.isArray(a.sheets))for(s=0,l=(p=a.sheets).length;s<l;s++)(d=p[s]).url=await this.encrypt(d.url);else delete a.sheets;try{"string"==typeof a.id&&a.id.length&&(a._id=a.id)}catch(e){}"{}"!==JSON.stringify(a)&&o.push(a)}return 1===o.length?o[0]:o}},t.oareport.duplicate={_index:!0,_prefix:!1},t.oareport.duplicates=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we;if(he=Date.now(),null==e&&(e=null!=(R=this.params.duplicates)?R:this.params.doi),this.params.empty&&await this.oareport.duplicate(""),!e)return this.params.empty?"":void 0;if(!this.refresh&&(a=await this.oareport.duplicate(e))&&a.createdAt>he-2592e6)return(ce=a).memory=!0,ce.took=Date.now()-he,ce;for(ce={createdAt:he,took:0,original:e,doi:void 0,preprint:void 0,count:0,mismatch:void 0,dois:[],preprints:[],cascades:null!=t?t:[],extras:0,relations:[],timestamps:{},records:{}},L.call(ce.cascades,e)<0&&!1!==this.params.cascade&&ce.cascades.push(e),ue=null!=(T=this.params.relations)?T:["is-version-of","has-version","has-preprint","is-preprint-of","is-same-as"],h=null!=(V=this.params.keys)?V:["update-to.DOI","DOI"],p=0,m=ue.length;p<m;p++)P=ue[p],h.push("relation."+P+".id");for(E={query:{bool:{should:[]}}},f=0,y=h.length;f<y;f++)d=h[f],E.query.bool.should.push({term:{}}),E.query.bool.should[E.query.bool.should.length-1].term[d+".keyword"]={value:e,case_insensitive:!0};for(k=0,g=(de=null!=(ie=null!=(pe=await this.src.crossref.works(E,{size:1e4,sort:{"indexed.timestamp":"asc"}}))&&null!=(re=pe.hits)?re.hits:void 0)?ie:[]).length;k<g;k++)_e=de[k],ce.dois.push(_e._source.DOI.toLowerCase());for(j=0,_=de.length;j<_;j++){for((ve=(_e=de[j])._source).DOI=ve.DOI.toLowerCase(),l=!0,D=0,v=h.length;D<v;D++)for(C=(C=h[D]).replace("relation.","").replace(".DOI",""),ye=0,b=(ae=null!=(se=null!=(ne=null!=(le=ve.relation)?le[C]:void 0)?ne:ve[C])?se:[]).length;ye<b;ye++){if(i=ae[ye],("update-to"!==C&&"updated-by"!==C||"erratum"!==(oe=i.type)&&"err"!==oe&&"expression_of_concern"!==oe)&&(l=!1,"is-preprint-of"===C&&(q=ve.DOI,L.call(ce.preprints,q)<0)&&ce.preprints.push(ve.DOI),(r=null!=(W=i.id)?W:i.DOI)&&r.startsWith("10."))){if(N=C+("update-to"===C||"updated-by"===C?"_"+i.type:""),L.call(ce.relations,N)<0&&ce.relations.push(N),r=r.toLowerCase(),L.call(ce.dois,r)<0&&null==ce.records[r]&&(ce.records[r]=await this.src.crossref.works(r))){for(ce.extras+=1,ce.records[r].DOI=ce.records[r].DOI.toLowerCase(),me=ce.records[r].indexed.timestamp;me&&null!=ce.timestamps[me];)me+=1;if(ce.timestamps[me]=ce.records[r].DOI,ce.dois.push(r),L.call(ce.cascades,r)<0&&!1!==this.params.cascade&&(c=await this.oareport.duplicates(r,ce.cascades)))for(ce.cascades.push(r),ge=0,w=(U=c.dois).length;ge<w;ge++){if(o=U[ge],L.call(ce.dois,o)<0){for(ce.dois.push(o),ce.records[o]=c.records[o],me=c.records[o].indexed.timestamp;me&&null!=ce.timestamps[me];)me+=1;ce.timestamps[me]=o}L.call(c.preprints,o)>=0&&L.call(ce.preprints,o)<0&&ce.preprints.push(o)}}("has-preprint"===C||"preprint"===(null!=(M=ce.records[r])?M.subtype:void 0))&&L.call(ce.preprints,r)<0&&ce.preprints.push(r)}"preprint"===ve.subtype&&(z=ve.DOI,L.call(ce.preprints,z)<0)&&ce.preprints.push(ve.DOI)}if(l)ve.DOI!==e&&(B=ve.DOI,L.call(ce.dois,B)>=0)&&ce.dois.splice(ce.dois.indexOf(ve.DOI),1);else{for(ce.records[ve.DOI]=ve,me=null!=(F=ve.indexed)?F.timestamp:void 0;me&&null!=ce.timestamps[me];)me+=1;ce.timestamps[me]=ve.DOI}}for(ce.count=Object.keys(ce.records).length,I=[],A=[],be=0,x=(J=Object.keys(ce.timestamps).sort()).length;be<x;be++)fe=J[be],$=ce.timestamps[fe],L.call(I,$)<0&&I.push(ce.timestamps[fe]),X=ce.timestamps[fe],L.call(A,X)<0&&(G=ce.timestamps[fe],L.call(ce.preprints,G)>=0)&&A.push(ce.timestamps[fe]),H=ce.timestamps[fe],L.call(ce.dois,H)<0&&(ce.mismatch=!0);for(I.length===ce.dois.length?ce.dois=I:ce.mismatch=!0,A.length===ce.preprints.length?ce.preprints=A:ce.mismatch=!0,ce.count!==ce.dois.length&&(ce.mismatch=!0),ce.preprint=(Y=ce.original,L.call(ce.preprints,Y)>=0),u=ce.dois.length;u>0&&!ce.doi;)(!ce.preprint&&(Z=ce.dois[u-1],L.call(ce.preprints,Z)<0)||ce.preprint&&(K=ce.dois[u-1],L.call(ce.preprints,K)>=0))&&(ce.doi=ce.dois[u-1]),u--;if(!t){for(s=[],delete ce.records,delete ce.timestamps,we=0,O=(Q=ce.dois).length;we<O;we++){if(n=Q[we],(S={...ce})._id=n.replace(/\//g,"_").toLowerCase(),S.original=n===S.original?S.original:[n,S.original],S.preprint!==L.call(S.preprints,n)>=0)for(S.doi=void 0,S.preprint=L.call(S.preprints,n)>=0,u=S.dois.length;u>0&&!S.doi;)(!S.preprint&&(ee=S.dois[u-1],L.call(S.preprints,ee)<0)||S.preprint&&(te=S.dois[u-1],L.call(S.preprints,te)>=0))&&(S.doi=S.dois[u-1]),u--;s.push(S)}ce.saved=await this.oareport.duplicate(s)}return delete ce._id,ce.took=Date.now()-he,ce},t.oareport.orgs.analysis=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S;for("string"==typeof e?(y=e,e=[]):"object"==typeof e&&(e=[e]),null!=e&&0!==e.length||(null==y&&(y=this.params.org),e=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")),l={},"string"==typeof y&&(y=y.split(",")),a=0,u=e.length;a<u;a++)if(m=e[a],!y||(v=m.id,L.call(y,v)>=0)){for(i in!1!==t&&(m=await this.report.orgs._format(m,!1)),null!=(b=m.analysis)?b:{})if(m.analysis[i].query&&!1!==(w=m.analysis[i].make_key)&&"false"!==w&&"False"!==w&&"FALSE"!==w)for await(g of(D.log("OAreport orgs anaysing by query",m.id,m.name,i),await this.oareport.works._for(decodeURIComponent(m.analysis[i].query)))){if(null==l[p=g.DOI]&&(l[p]=g),null==(r=l[g.DOI]).meta&&(r.meta={}),null==(s=l[g.DOI].meta).query_matches&&(s.query_matches=[]),f=m.id+"/"+i,L.call(l[g.DOI].meta.query_matches,f)<0&&l[g.DOI].meta.query_matches.push(f),d=null!=(x=null!=(O=m.analysis[i].key)?O:m.analysis[i].name)?x:i,h=null==(k=m.analysis[i].value)||k,m.analysis[i].list){for(null==(n=await this.dot(l[g.DOI],d))&&(n=[]),Array.isArray(n)||(n=[n]),Array.isArray(h)||(h=[h]),o=0,c=h.length;o<c;o++)S=h[o],n.push(S);h=n}await this.dot(l[g.DOI],d,h)}if(m.country_code&&m.paid)for await(g of await this.oareport.works._for('DOI:* AND supplements.org.keyword:"'+m.id+'" AND NOT funder.country.keyword:"'+m.country_code+'"'))l[g.DOI]=await this.oareport._funder_country(null!=(j=l[g.DOI])?j:g,m)}return(_=Object.values(l))&&_.length&&await this.oareport.works(_),_.length},t.oareport.orgs.supplements={_index:!0,_auth:"@oa.works"},t.oareport.orgs.supplement=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re;for(this.params.empty&&await this.oareport.works(""),this.params.empty&&await this.oareport.orgs.supplements(""),Z=await this.epoch(),f=await this.datetime(Z),null==e&&(e=this.params.org),"string"==typeof e&&(e=e.split(",")),null==t&&(t=this.params.sheet),"string"==typeof t&&(t=t.split(",")),r=[],Q={},te=0,m=0,b=(C=await this.src.google.sheets("1OzXJFTedsmvxhpgeAmNHg5Y0sB3ZIXGPk45UUu_a5eE/data")).length;m<b;m++)if(S=C[m],!e||(N=S.id,L.call(e,N)>=0))for(V in S=await this.report.orgs._format(S,!1),r.push(S),H=Array.isArray(S.sheets)?S.sheets:"string"==typeof S.sheets?S.sheets.replace(/; /g,";").replace(/ ;/g,";").trim().split(";"):[])if(G=H[V],!t||(q=G.name,L.call(t,q)>=0)){if(await this.sleep(5e3),D.log(S.id,S.name,G.name,V,"of",H.length,G.url),!1!==s&&(s=1),re=null==(W=null!=(U=this.params.update)?U:this.params.empty)||W,g=!1,null==this.params.update&&!this.params.empty)try{for(l=!1,a=0;!1===l&&a<5;){a++;try{l=await this.src.google.sheets({sheetid:G.url,sheet:"m_admin",headers:!1})}catch(e){await this.sleep(5e3)}}if("last updated"===l[0][0].toLowerCase()&&(g=l[0][1])&&([v,O]=g.split(" "),g=await this.epoch(v.split("/").reverse().join("-")+"T"+O)),"number"==typeof g&&g>15778368e5){try{_=await this.oareport.works('supplements.sheets.keyword:"'+G.name+'"',{size:1,sort:{"supplements.updated":"desc"}})}catch(e){}null!=(null!=_&&null!=(M=_.hits)?M.hits:void 0)&&(_=_.hits.hits[0]._source),(null!=_&&null!=(z=_.meta)?z.updated:void 0)&&g<=_.meta.updated&&(re=g)}}catch(e){re=!1}if(!0!==re)D.log(S.id,S.name,G.name,"NOT loading because",g,"is not after",re);else{for(X=!1,ie=0;!Array.isArray(X)&&ie<5;){ie++;try{X=await this.src.google.sheets({sheetid:G.url,sheet:"Export",headers:!1})}catch(e){await this.sleep(5e3)}}if(Array.isArray(X)&&X.length){for(c=[],y=0,w=(F=X.shift()).length;y<w;y++)u=F[y],c.push(u.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(I in o=["apc_cost","wellcome.apc_paid_actual_currency_excluding_vat","wellcome.apc_paid_gbp_inc_vat_if_charged","wellcome.additional_publication_fees_gbp","wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp","wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"],D.log(S.id,S.name,G.name,X.length,"rows"),X){for(d in $=X[I],K={updated:Z,org:S.id,sheets:G.name,paid:!!S.paid||void 0},c)if("pmcid"===(p=c[d].toLowerCase())||"openalex"===p)K[p.toUpperCase()]="pmcid"===p?"PMC"+$[d].toLowerCase().replace("pmc",""):$[d];else try{h=L.call(o,p)>=0?parseFloat($[d]):"number"==typeof $[d]?$[d]:$[d]?"true"===(B=$[d].trim().toLowerCase())||"yes"===B||"false"!==(J=$[d].trim().toLowerCase())&&"no"!==J&&("grant_id"===p||"ror"===p?$[d].replace(/\//g,",").replace(/ /g,"").split(","):$[d]):void 0,"string"==typeof $[d]&&$[d].includes(";")&&(h=$[d].replace(/; /g,";").replace(/ ;/g,";").trim().split(";")),null!=h&&""!==h&&await this.dot(K,c[d],h)}catch(e){}if((K.DOI||K.doi)&&(K.DOI=await this.report.cleandoi(null!=(E=K.DOI)?E:K.doi)),K.DOI&&K.DOI.endsWith("/")&&D.log(K),delete K.doi,i=null!=(P=null!=(R=K.DOI)?R:K.OPENALEX)?P:K.PMCID){try{i=i.toLowerCase()}catch(e){}null==Q[i]&&(Q[i]={_id:i.replace(/\//g,"_"),supplements:[],first_seen:{}}),!Q[i].DOI&&K.DOI&&(Q[i].DOI=K.DOI),!Q[i].OPENALEX&&K.OPENALEX&&(Q[i].OPENALEX=K.OPENALEX),!Q[i].PMCID&&K.PMCID&&(Q[i].PMCID=K.PMCID),Q[i].updated=Z,null==(n=Q[i].first_seen)[j=S.id]&&(n[j]=f),Q[i].supplements.push(K)}(A=parseInt(I))&&A%1e3==0&&D.log(S.id,S.name,G.name,V,"of",H.length,"row",I,"of",X.length,Date.now()-Z)}}}}for((Y=Object.values(Q)).length&&(te+=Y.length,D.log("saving",te,Y.length,"supplements"),await this.oareport.orgs.supplements(Y),await this.sleep(5e3),D.log("loading works",Y.length),this.oareport.works.load(Object.keys(Q)),Q={},Y=[]),k=0,x=r.length;k<x;k++)S=r[k],await this.oareport.orgs.analysis(S,!1);return ee=await this.epoch()-Z,D.log("OAreport orgs supplement sheet reading "+(r.length?"and "+r.length+" org analysis ":"")+"complete",te,ee),await this.mail({to:null!=(T=this.S.log)?T.logs:void 0,subject:"OAreport orgs supplement sheet reading "+te+" at "+ee,text:"In sheets found "+te}),te},t.oareport.orgs.supplement._async=!0,t.oareport.orgs.supplement._log=!1,t.oareport.orgs.supplement._bg=!0,t.oareport.orgs.supplement._auth="@oa.works",t.oareport._funder_country=function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j;if(null!=t?t.country_code:void 0)for(s=0,l=(_=null!=(g=e.funder)?g:[]).length;s<l;s++){if((i=_[s]).id){if(t.fundref)for(n=0,a=(v="string"===t.fundref?[t.fundref]:t.fundref).length;n<a;n++)if(y=v[n],i.id.includes(y)){i.country=t.country_code;break}if(!i.country&&t.openalex_funder_id)for(p=0,o=(b="string"===t.openalex_funder_id?[t.openalex_funder_id]:t.openalex_funder_id).length;p<o;p++)if(h=b[p],i.id.includes(h)){i.country=t.country_code;break}}if(!i.country&&i.name){if(((r=i.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(port)||port.includes(r)||(null!=(w=t.aliases)?w:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(r)||(null!=(x=t.acronyms)?x:"").toLowerCase().includes(r))&&(i.country=t.country_code),!i.country&&t.acronyms)for(d=0,u=(O=t.acronyms.split(",")).length;d<u;d++)k=O[d].replace(/[^a-z A-Z]/g,""),L.call(i.name.split(" "),k)>=0&&(i.country=t.country_code);if(!i.country&&t.aliases)for(f=0,c=(j=t.aliases).length;f<c;f++)m=j[f],r.includes(m.toLowerCase().replace(/[^a-z ]/g,""))&&(i.country=t.country_code)}}return e},t.oareport._author_display_name=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;if(l=e.outreach.email_address.includes("@")?e.outreach.email_address:await this.decrypt(e.outreach.email_address),(null!=(p=e.openalex)?p.authorships:void 0)&&1===e.openalex.authorships.length&&(i=null!=(d=e.openalex.authorships[0].author)?d.display_name:void 0))e.outreach.author_display_name="Dr. "+i;else{for(m=l.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),r="",s="",t="",n=1e6,o=0,u=(h=e.openalex.authorships).length;o<u;o++)(c=null!=(f=(y=h[o]).author)?f.display_name:void 0)&&((g=(await this.levenshtein(m,c.toLowerCase().replace(/[^a-z]/g,""))).distance/c.length)<n&&(n=g,s=c),n>.2&&(m.endsWith(c.split(" ").pop().toLowerCase())||c.split(" ")[0].length>4&&m.includes(c.split(" ")[0].toLowerCase()))&&(n=.1,s=c),!r&&m.startsWith((c.split(" ")[0].slice(0,1)+c.split(" ").pop().slice(0,1)).toLowerCase())&&(r=c),!t&&y.author.is_corresponding&&(t=c));(a=s&&n<.7?s.split(" ").pop():r||t||i)&&(e.outreach.author_display_name="Dr. "+a)}return e},t.oareport.works.process=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et,tt,it,rt,st,nt,lt,at,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Lt,Nt,Et,Pt,Rt,Tt,qt,Wt,Ut,Mt,zt,Ft,Bt,Jt,$t,Xt,Vt,Gt,Ht,Yt,Zt,Kt,Qt,ei,ti,ii,ri,si,ni,li,ai,oi,ui,ci,pi,di,hi,fi,mi,yi,gi,_i,vi,bi,wi,xi,Oi,ki,ji,Si,Ii,Ai,Di,Ci,Li,Ni,Ei,Pi,Ri,Ti;try{if(Si=await this.epoch(),await this.datetime(Si),"oareport.works.process"===this.fn&&(e=this.params.process),We={ids:{},is_free_to_read:!1,is_open_access:!1,supplements:[],corresponding_authorships:[],corresponding_author_ids:[],meta:{replaced:[]},outreach:{},data_availability_statement:{}},(e=e.toLowerCase().split(".org/").pop().replace(/\/$/,"")).startsWith("pmc")){We.PMCID=e.toUpperCase();try{Oe=await this.src.openalex.works('ids.pmcid:"'+e.replace("pmc","")+'"',1)}catch(e){}}else e.startsWith("10.")&&(We.DOI=e);if(null==Oe&&(Oe=await this.src.openalex.works(e.startsWith("w")?'id.keyword:"https://openalex.org/'+e+'"':e,e.startsWith("w")?1:void 0)),null!=Oe&&(Oe.ids.doi&&null==We.DOI&&(We.DOI=Oe.ids.doi.split("doi.org/").pop()),Oe.ids.pmcid&&null==We.PMCID&&(We.PMCID="PMC"+Oe.ids.pmcid.split("/").pop().toLowerCase().replace("pmc",""))),We._id=We.DOI?We.DOI.toLowerCase().replace(/\//g,"_"):(null!=Oe?Oe.id:void 0)?Oe.id.split(".org/").pop().toLowerCase():We.PMCID?We.PMCID.toLowerCase():e,this.refresh||null==(A=await this.oareport.works(e))&&(A=await this.oareport.works('ids.doi.keyword:"'+e+'" OR ids.pmcid.keyword:"'+e+'" OR ids.openalex.keyword:"'+e+'" OR meta.replaced.keyword:"'+e+'"',1)),(null!=A?A._id:void 0)&&(We.meta=A.meta),e.startsWith("10.")&&(O=await this.oareport.duplicates(e)))for(null!=O.doi&&O.doi!==e&&(null!=A&&(A=void 0),We.DOI=O.doi,We._id=We.DOI.toLowerCase().replace(/\//g,"_"),A||this.refresh||null==(A=await this.oareport.works(We._id))&&(A=await this.oareport.works('ids.doi.keyword:"'+We.DOI+'" OR meta.replaced.keyword:"'+We.DOI+'"',1)),A&&(We.meta=A.meta)),(null!=(Oe=await this.src.openalex.works(O.doi))&&null!=(Ue=Oe.ids)?Ue.pmcid:void 0)&&(We.PMCID="PMC"+Oe.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),e!==O.doi&&L.call(We.meta.replaced,e)<0&&We.meta.replaced.push(e),Me=O.dois,q=0,B=Me.length;q<B;q++)(x=Me[q])!==O.doi&&L.call(We.meta.replaced,x)<0&&(O.preprint&&L.call(O.preprints,x)>=0||!O.preprint&&L.call(O.preprints,x)<0)&&We.meta.replaced.push(x);if((e.startsWith("w")||e.startsWith("pmc"))&&We._id.startsWith("10.")&&(P=e.replace(/^w/,"W").replace(/^pmc/,"PMC"),L.call(We.meta.replaced,P)<0&&We.meta.replaced.push(P)),null!=i){for(null==(o=We.meta).org_query_match&&(o.org_query_match={crossref:{},openalex:{}}),z=0,J=(Ye=["crossref","openalex"]).length;z<J;z++)for(je in i[ke=Ye[z]])null==(u=We.meta.org_query_match[ke])[je]&&(u[je]=i[ke][je]);We.meta.org_query_matches=Object.keys(We.meta.org_query_match.crossref).concat(Object.keys(We.meta.org_query_match.openalex)).length}if(null!=Oe?Oe.id:void 0){for(We.ids.openalex=Oe.id.split("/").pop(),We.openalex={},me=0,te=(at=["id","abstract","apc_list","apc_paid","authorships","authors_count","best_oa_location","biblio","cited_by_count","concepts","countries_distinct_count","corresponding_author_ids","created_date","display_name","domains","fields","has_fulltext","ids","is_paratext","is_retracted","keywords","language","mesh","open_access","primary_location","publication_date","publication_year","referenced_works_count","sustainable_development_goals","title","type","type_crossref","updated","updated_date"]).length;me<te;me++)ge=at[me],We.openalex[ge]=Oe[ge];for(Dt=null!=(_t=Oe.grants)?_t:[],_e=0,le=Dt.length;_e<le;_e++)N=Dt[_e],null==We.funder&&(We.funder=[]),We.funder.push({award:(null!=(Mt=N.award_id)?Mt:"").replace(/, /g,",").split(","),display_name:N.funder_display_name,source:"openalex",id:N.funder});for(oi=null!=(Zt=Oe.locations)?Zt:[],Se=0,ae=oi.length;Se<ae;Se++)if((he=oi[Se]).license&&(fe=he.license.toLowerCase())&&("pd"!==fe&&"public-domain"!==fe&&"cc0"!==fe&&"cc-by"!==fe||(We.is_open_access=!0)),(null!=(vi=he.source)?vi.is_in_doaj:void 0)&&(null==We.syp_permissions&&(We.syp_permissions={}),We.syp_permissions.can_archive=!0,We.syp_permissions.archivable_version=he.version),"journal"===(null!=(ze=he.source)?ze.type:void 0)&&he.license&&(!(null!=(Fe=We.publisher)?Fe.license:void 0)||he.license.length<We.publisher.license)&&"publishedVersion"===he.version)null==We.publisher&&(We.publisher={}),We.publisher.license=he.license,We.publisher.url_for_pdf=he.pdf_url,We.publisher.version=he.version;else if("repository"===(null!=(Be=he.source)?Be.type:void 0)&&(null==We.repository&&(We.repository={}),he.license&&(!We.repository.license||he.license.length<We.repository.license)&&(We.repository.license=he.license),he.landing_page_url&&he.landing_page_url.toLowerCase().includes("pmc")&&(We.PMCID||(Ce=he.landing_page_url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(Ce))&&(We.PMCID="PMC"+Ce),he.license&&!(null!=(Je=We.epmc)?Je.license:void 0)&&(null==We.epmc&&(We.epmc={}),We.epmc.license=he.license)),!We.repository.url||!We.repository.url.includes("pmc")||!We.repository.url.includes("ncbi.")&&he.landing_page_url&&he.landing_page_url.includes("ncbi.")))for(Di=0,oe=($e=["license","pdf_url","landing_page_url","version"]).length;Di<oe;Di++)he[xe=$e[Di]]&&(We.repository[xe]=he[xe]);for((null!=(Xe=We.repository)?Xe.url:void 0)&&(We.repository.url.toLowerCase().includes("europepmc.")||We.repository.url.toLowerCase().includes("ncbi."))&&(null==We.PMCID&&(We.PMCID="PMC"+We.repository.url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),We.repository.url_in_pmc=!0),(null!=(Ve=Oe.ids)?Ve.pmid:void 0)&&(We.PMID=Oe.ids.pmid.split("/").pop()),(null!=(Ge=Oe.open_access)?Ge.is_oa:void 0)&&(We.is_free_to_read=!0),Ze=null!=(He=We.openalex.concepts)?He:[],Ei=0,ue=Ze.length;Ei<ue;Ei++){delete(m=Ze[Ei]).wikidata;try{m.score=Math.floor(100*m.score)}catch(e){}}for(Qe=null!=(Ke=Oe.corresponding_author_ids)?Ke:[],Ri=0,ce=Qe.length;Ri<ce;Ri++)y=Qe[Ri],L.call(We.corresponding_author_ids,y)<0&&We.corresponding_author_ids.push(y);for(tt=null!=(et=We.openalex.authorships)?et:[],Ti=0,pe=tt.length;Ti<pe;Ti++){for(rt=null!=(it=(s=tt[Ti]).institutions)?it:[],E=0,de=rt.length;E<de;E++)delete rt[E].type;(null!=(st=s.author)?st.orcid:void 0)&&s.author.orcid.includes("orcid.org/")&&(s.author.orcid_number=s.author.orcid.split("/").pop()),nt=null!=(lt=s.author)?lt.id:void 0,L.call(We.corresponding_author_ids,nt)>=0&&We.corresponding_authorships.push(s)}}null==(c=We.ids).doi&&(c.doi=We.DOI),null==(p=We.ids).pmcid&&(p.pmcid=We.PMCID);try{for(r=function(e={}){var t,i,r,s,n,l,a,o,u;for(null==We.supplements&&(We.supplements=[]),We.supplements=We.supplements.concat(null!=(l=e.supplements)?l:[]),u=[],r=0,s=(o=null!=(a=e.first_seen)?a:{}).length;r<s;r++)n=o[r],null==(t=We.meta).first_seen&&(t.first_seen=[]),u.push(null!=(i=We.meta.first_seen)[n]?i[n]:i[n]=e.first_seen[n]);return u},(null!=t?t:t=await this.oareport.orgs.supplements(We._id))&&await r(t),ot=We.meta.replaced,W=0,$=ot.length;W<$;W++)bi=ot[W],(xi=await this.oareport.orgs.supplements(bi))&&await r(xi);for(M=0,X=(ut=["pmcid","openalex"]).length;M<X;M++)ki=ut[M],We.ids[ki]&&(ct=We.ids[ki],L.call(We.meta.replaced,ct)<0)&&(Le=await this.oareport.orgs.supplements(We.ids[ki]))&&(We.meta.replaced.push(We.ids[ki]),await r(Le));for(pt=We.supplements,F=0,V=pt.length;F<V;F++){(ji=pt[F]).paid&&(We.meta.is_updated=!0),delete ji.paid,ji.email&&!We.outreach.email_address&&(We.outreach.email_address=ji.email),"string"==typeof ji.email&&ji.email.includes("@")&&(ji.email=await this.encrypt(ji.email)),ji.author_email_name_ic&&!We.outreach.author_display_name&&(We.outreach.author_display_name=ji.author_email_name_ic);try{for(ht="string"==typeof ji.corresponding_author_ids?ji.corresponding_author_ids.split(","):null!=(dt=ji.corresponding_author_ids)?dt:[],ye=0,G=ht.length;ye<G;ye++)y=ht[ye],L.call(We.corresponding_author_ids,y)<0&&We.corresponding_author_ids.push(y)}catch(e){}for(!ji.publisher_license_ic||"cc-by"!==(ft=ji.publisher_license_ic)&&"cc0"!==ft||(We.is_open_access=!0),(!0===ji.is_free_ic||We.is_open_access)&&(We.is_free_to_read=!0),ve=0,H=(mt=["mturk_has_data_availability_statement","has_data_availability_statement_ic","has_data_availability_statement","data_availability_statement","data_availability_statement_ic"]).length;ve<H;ve++)null==ji[Ii=mt[ve]]||We.data_availability_statement.has_data_availability_statement||(We.data_availability_statement.has_data_availability_statement=!!ji[Ii],We.data_availability_statement.source="oareport");for(we=0,Y=(yt=["category","accession_number","doi","url"]).length;we<Y;we++)null!=ji["data_availability_statement_"+(_=yt[we])]&&(We.data_availability_statement[_]=ji["data_availability_statement_"+("doi"===_||"url"===_?"resource_":"")+_]);for(U in ji)null!=We[U]&&"object"!=typeof We[U]&&"DOI"!==U&&"corresponding_author_ids"!==U&&"paid"!==U&&"is_updated"!==U&&"email"!==U&&(We[U]="NULL"===ji[U]?void 0:ji[U])}}catch(e){}try{"not data availability statement"===We.data_availability_statement.category.toLowerCase()&&(We.data_availability_statement.has_data_availability_statement=!1)}catch(e){}try{(null!=(gt=We.openalex)?gt.authorships:void 0)&&We.outreach.email_address&&!We.outreach.author_display_name&&(We=await this.oareport._author_display_name(We))}catch(e){}if(("Public Library of Science"===(null!=(vt=We.openalex)&&null!=(bt=vt.primary_location)&&null!=(wt=bt.source)?wt.publisher:void 0)||We.DOI&&(We.DOI.startsWith("10.1186")||We.DOI.startsWith("10.12688/gatesopenres")))&&(We.data_availability_statement.has_data_availability_statement=!0,We.data_availability_statement.source="openalex"),We.meta.is_updated){if(T=[],We.DOI&&!(null!=Oe?Oe.grants:void 0)&&(g=await this.src.crossref.works(We.DOI))){if(g.ISSN&&(T=g.ISSN),g.is_oa&&(We.is_free_to_read=!0),"preprint"===g.subtype&&(null==We.crossref&&(We.crossref={}),We.crossref.subtype="preprint"),We.meta.checked_crossref=Si,!We.submission_date||!We.acceptance_date)for(Ot=null!=(xt=g.assertion)?xt:[],Ie=0,Z=Ot.length;Ie<Z;Ie++)((a=(null!=(kt=(l=Ot[Ie]).label)?kt:"").toLowerCase()).includes("accepted")&&a.split(" ").length<3||a.includes("received"))&&(null!=(n=await this.dateparts(l.value))?n.date:void 0)&&n.timestamp&&null==We[be=(a.includes("received")?"submission":"acceptance")+"_date"]&&(We[be]=n.date);if(null!=Oe&&!Oe.grants)for(St=null!=(jt=g.funder)?jt:[],Te=0,K=St.length;Te<K;Te++)C=St[Te],null==We.funder&&(We.funder=[]),We.funder.push({award:C.award,display_name:C.name,source:"crossref",id:C.DOI})}if((null!=(It=We.openalex)&&null!=(At=It.primary_location)&&null!=(Ct=At.source)?Ct.publisher:void 0)&&!We.publisher_simple){if(!v.length)for(Nt=null!=(Lt=await this.report.publishers("*",1e4))?Lt:[],qe=0,Q=Nt.length;qe<Q;qe++)wi=Nt[qe],v.push(null!=(Et=wi._source)?Et:wi);for(Pe=We.openalex.primary_location.source.publisher.toLowerCase(),Oi=0,ee=v.length;Oi<ee;Oi++)if((Ee=v[Oi]).publisher&&Pe.includes(Ee.publisher.toLowerCase())){We.publisher_simple=Ee.publisher_display_name;break}}if((We.DOI||We.PMID||(null!=(Pt=We.ids)?Pt.pmid:void 0))&&(!We.PMCID&&!(null!=(Rt=We.ids)?Rt.pmcid:void 0)||!We.PMID&&!(null!=(Tt=We.ids)?Tt.pmid:void 0)||null==(null!=(qt=We.pubmed)?qt.pubtype:void 0)||!We.submission_date||!We.acceptance_date)&&(Re=We.PMID||We.ids.pmid?await this.src.pubmed(null!=(Wt=We.PMID)?Wt:We.ids.pmid):await this.src.pubmed.doi(We.DOI))){for(zt=null!=(Ut=Re.ISSN)?Ut:[],Ai=0,ie=zt.length;Ai<ie;Ai++)De=zt[Ai],L.call(T,De)<0&&T.push(De);!We.PMCID&&(null!=Re&&null!=(Ft=Re.identifier)?Ft.pmc:void 0)&&(We.PMCID="PMC"+Re.identifier.pmc.toLowerCase().replace("pmc","")),!We.PMID&&(null!=Re&&null!=(Bt=Re.identifier)?Bt.pubmed:void 0)&&(We.PMID=Re.identifier.pubmed),null==We.pubmed&&(We.pubmed={}),We.pubmed.pubtype=Re.type,null==We.submission_date&&(We.submission_date=null!=(Jt=Re.dates)&&null!=($t=Jt.PubMedPubDate_received)?$t.date:void 0),null==We.acceptance_date&&(We.acceptance_date=null!=(Xt=Re.dates)&&null!=(Vt=Xt.PubMedPubDate_accepted)?Vt.date:void 0)}if((We.PMCID||We.ids.pmcid)&&(We.meta.checked_epmc_license=Si,S=await this.src.epmc.pmc(null!=(Gt=We.PMCID)?Gt:We.ids.pmcid))){for((null!=(Ht=S.journalInfo)&&null!=(Yt=Ht.journal)?Yt.issn:void 0)&&(Kt=S.journalInfo.journal.issn,L.call(T,Kt)<0)&&T.push(S.journalInfo.journal.issn),(null!=(Qt=S.journalInfo)&&null!=(ei=Qt.journal)?ei.essn:void 0)&&(ti=S.journalInfo.journal.essn,L.call(T,ti)<0)&&T.push(S.journalInfo.journal.essn),null==We.PMCID&&(We.PMCID=S.pmcid),null==We.pubmed&&(We.pubmed={}),null==(d=We.pubmed).pubtype&&(d.pubtype=[]),si=null!=(ii=null!=(ri=S.pubTypeList)?ri.pubType:void 0)?ii:[],Ci=0,re=si.length;Ci<re;Ci++)Ne=si[Ci],L.call(We.pubmed.pubtype,Ne)<0&&We.pubmed.pubtype.push(Ne);if(null==We.epmc&&(We.epmc={}),We.epmc.license=null!=(ni=await this.src.epmc.licence(null!=(li=We.PMCID)?li:We.ids.pmcid,S))?ni.licence:void 0,(null!=(ai=We.data_availability_statement)?ai.has_data_availability_statement:void 0)||(await this.src.pubmed.availability(null!=(ui=We.PMCID)?ui:We.ids.pmcid)?(We.data_availability_statement.has_data_availability_statement=!0,We.data_availability_statement.source="pubmed"):(We.data_availability_statement.has_data_availability_statement=!1,We.data_availability_statement.source="pubmed")),!(null!=(ci=We.data_availability_statement)?ci.has_data_availability_statement:void 0))if(k=await this.src.epmc.statement(null!=(pi=We.PMCID)?pi:We.ids.pmcid,S)){if(We.data_availability_statement.has_data_availability_statement=!0,We.data_availability_statement.source="epmc",We.data_availability_statement.full_text=k,Li=await this.src.epmc.statement.url(null!=(di=We.PMCID)?di:We.ids.pmcid,S,k))for(Ni=0,se=Li.length;Ni<se;Ni++)(b=Li[Ni])&&b.includes("doi.org/")?(w=b.split("doi.org/")[1].toLowerCase(),null==(h=We.data_availability_statement).resource_doi&&(h.resource_doi=[]),L.call(We.data_availability_statement.resource_doi,w)<0&&We.data_availability_statement.resource_doi.push(w)):(null==(f=We.data_availability_statement).resource_url&&(f.resource_url=[]),L.call(We.data_availability_statement.resource_url,b)<0&&We.data_availability_statement.resource_url.push(b))}else We.data_availability_statement.has_data_availability_statement=!1,We.data_availability_statement.source="epmc";null==We.submission_date&&(We.submission_date=await this.src.epmc.submitted(null!=(hi=We.PMCID)?hi:We.ids.pmcid,S))}We.DOI&&(null==We.syp_permissions&&(We.syp_permissions={}),(Ae=await this.permissions_new({doi:We.DOI},void 0,Oe))&&null!=Ae.best_permission&&(We.syp_permissions.can_archive&&!Ae.best_permission.can_archive||(We.syp_permissions.can_archive=Ae.best_permission.can_archive,Ae.best_permission.version&&(We.syp_permissions.archivable_version=Ae.best_permission.version))),(T||null!=Oe||null!=g)&&(We.syp_permissions.journal_oa_type=null!=(fi=await this.permissions_new.journals.oa.type(T,void 0,Oe,g))?fi:"unsuccessful","gold"!==(mi=We.syp_permissions.journal_oa_type)&&"diamond"!==mi||(We.is_open_access=!0)))}for("string"==typeof We.outreach.email_address&&We.outreach.email_address.includes("@")&&(We.outreach.email_address=await this.encrypt(We.outreach.email_address)),We.is_open_access||!(null!=(yi=We.epmc)?yi.license:void 0)||!(j=We.epmc.license.toLowerCase())||"pd"!==j&&"public-domain"!==j&&"cc0"!==j&&"cc-by"!==j||(We.is_open_access=!0),We.meta.updated=await this.epoch(),We.meta.updated_date=await this.date(We.meta.updated),We.meta.took=We.meta.updated-Si,Pi=0,ne=(gi=["DOI","PMCID","PMID"]).length;Pi<ne;Pi++)We[R=gi[Pi]]&&(We.ids[R.toLowerCase()]=We[R]),"DOI"!==R&&delete We[R];return!1!==this.params.save&&We._id&&We._id===(null!=(_i=this.params.process)?_i:"").toLowerCase().replace(/\//g,"_")&&this.oareport.works(We),We}catch(t){I=t,D.log("OAreport works process error",I);try{D.log(e)}catch(e){}}},t.oareport.works.process._log=!1,t.oareport.works.load=async function(e,t,i,r,s,n){var l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M;if(R=await this.epoch(),null==s&&(s="supplements"===this.params.load),r=this.params.load&&"supplements"!==this.params.load?this.params.load:(await this.date()).split("-")[0],i=null!=(y=null!=(g=this.params.org)?g:this.params.orgs)?y:"orgs"===this.params.load,null==e&&(e=[]),"string"==typeof e&&(e=e.split(",")),null==n&&(n=this.params.clear),n&&await this.oareport.works(""),P=await this.oareport.works.count(),m=0,this.params.q)for await(q of(D.log("OAreport works load for query",this.params.q),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"oareport_works",this.params.q,{scroll:"5m",include:["ids"]})))e.push(null!=(j=null!=(S=null!=(I=q.ids)?I.doi:void 0)?S:null!=(A=q.ids)?A.openalex:void 0)?j:null!=(C=q.ids)?C.pmcid:void 0);else if(s){for await(T of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"oareport_orgs_supplements",t?"updated:<"+t:i?'org:"'+i+'"':void 0,{scroll:"5m",include:["DOI","openalex","pmcid"]}))e.push(null!=(N=null!=(_=T.DOI)?_:T.openalex)?N:T.pmcid);D.log("OAreport works to load all from orgs supplements search",t,i,e.length)}else if(!e.length){if(l=async(i,s,n)=>{var l,a,o,u,c;for await(o of(null!=n&&Array.isArray(e)&&(e={}),null==i&&(i=(s?"(funder.name:* OR author.affiliation.name:*) AND year.keyword:":"authorships.institutions.display_name:* AND publication_year:")+r),t&&(i="("+i+") AND "+(s?"srcday":"updated_date")+":>"+t),a=await this.src[s?"crossref":"openalex"].works.count(i),D.log("OAreport works load "+(s?"crossref":"openalex")+" by query expects",i,a),m+=a,c=[],this.index._for(s?"src_crossref_works":"src_openalex_works",i,{include:s?["DOI"]:["id","ids"],scroll:"10m"})))(l=o.DOI?o.DOI:(null!=(u=o.ids)?u.doi:void 0)?"10."+o.ids.doi.split("/10.")[1]:o.id.split("openalex.org/").pop())?null!=n?(null==e[l]&&(e[l]={crossref:{},openalex:{}}),c.push(e[l][s?"crossref":"openalex"][n.name]=a)):t||L.call(e,l)<0?c.push(e.push(l)):c.push(void 0):c.push(void 0);return c},i||r!==this.params.load)for await(h of(D.log("OAreport works load for org",i||"all","by source.openalex or source.crossref query presence"),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"oareport_orgs","string"==typeof i?'name.keyword:"'+i+'"':"*",{scroll:"10m"})))(null!=(v=h.source)?v.openalex:void 0)&&await l(decodeURIComponent(decodeURIComponent(h.source.openalex)),void 0,h),(null!=(b=h.source)?b.crossref:void 0)&&await l(decodeURIComponent(decodeURIComponent(h.source.crossref)),!0,h);else D.log("OAreport works load for year",r),await Promise.all([l(),l(void 0,!0)]);if(t)for await(f of(D.log("OAreport works load for updated before",t,await this.date(t)),await this.oareport.works._for("(DOI:* OR ids.doi:*) AND meta.is_updated:true AND updated:<"+t,{include:["DOI","ids"],scroll:"10m"})))(M=null!=(w=null!=(x=null!=(O=f.DOI)?O:ids.doi)?x:ids.openalex)?w:ids.pmcid)&&L.call(e,M)<0&&e.push(M)}for(a=[],p=0,d=(c=Array.isArray(e)?e:Object.keys(e)).length;p<d;p++)u=c[p],null!=(E=await this.oareport.works.process(u,void 0,Array.isArray(e)?void 0:e[u]))&&a.push(E),a.length>=1e4&&(D.log("OAreport works loading",a.length,Date.now()-R),await this.oareport.works(a),a=[]);return a.length&&await this.oareport.works(a),await this.sleep(5e3),o=await this.oareport.works.count(),W=await this.epoch()-R,D.log("OAreport works loaded",c.length,P,m,o,W),U="Start count: "+P+"\nLoaded: "+c.length+"\nCurrent count: "+o+"\nElapsed time: "+W,m&&(U+="\nQuery Expected-counts total: "+m),await this.mail({to:null!=(k=this.S.log)?k.logs:void 0,subject:"OAreport works loaded "+c.length+" at "+W,text:U}),c.length},t.oareport.works.load._log=!1,t.oareport.works.load._bg=!0,t.oareport.works.load._async=!0,t.oareport.works.load._auth="@oa.works",t.oareport.check=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d,h;for(e={report:0,oareport:0},a={report:[],oareport:[]},h={report:[],oareport:[]},n={report:[],oareport:[]},r=0,s=(o=[]).length;r<s;r++)for await(l of(i=o[r],this.index._for("paradigm_b_"+i+"_works","DOI:* AND supplements.org:Gates",{scroll:"10m"})))e[i]+=1,D.log(i,e),"report"===i&&await this.oareport.works(l.DOI)||"oareport"===i&&await this.report.works(l.DOI)?a[i].push(l.DOI):n[i].push(l.DOI);for await(d of this.index._for("paradigm_b_oareport_orgs_supplements",'supplements.org.keyword:"0456r8d26"',{scroll:"10m"}))e.oareport+=1,D.log("sup","oareport",e),d.DOI&&(t=await this.oareport.works(d.DOI)),!t&&d.DOI&&(t=await this.oareport.works('meta.replaced.keyword:"'+d.DOI+'"',1)),!t&&d.PMCID&&(t=await this.oareport.works('ids.pmcid.keyword:"'+d.PMCID+'" OR meta.replaced.keyword:"'+d.PMCID+'"',1)),!t&&d.OPENALEX&&(t=await this.oareport.works('ids.openalex.keyword:"'+d.OPENALEX+'" OR meta.replaced.keyword:"'+d.OPENALEX+'"')),(null!=t?t._id:void 0)||h.oareport.push(null!=(u=null!=(c=d.DOI)?c:d.PMCID)?u:d.OPENALEX);return p={checked:e,present:{report:a.report.length,oareport:a.oareport.length},missing:{report:n.report.length,oareport:n.oareport.length},supplement:{report:h.report.length,oareport:h.oareport.length}},D.log(h.oareport),D.log(p),fs.writeFile("/home/oaw/static/oareport_check.json",JSON.stringify(h.oareport,null,2)),p},t.oareport.check._async=!0,L=[].indexOf,t.permissions=async function(e,t,i,s,n,l){var a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te;if(q=!1,m=!1,a=async function(t){var i,s,l,a,o,u,c,p,d,h,f,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,L,N,E;if(m&&t.embargo_months&&(e.published||e.year)&&(s=new Date(Date.parse(null!=(g=e.published)?g:e.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+t.embargo_months)),t.embargo_end=s.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(_=t.copyright_owner.toLowerCase())&&"affiliation"!==_?m&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(S=e.author[0].name)?S:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(j=e.journal)?j:"",("publisher"===(I=t.copyright_name.toLowerCase())||"journal"===I)&&(n||e.doi||(null!=(A=t.provenance)?A.example:void 0)))for(null==n&&(n=await this.src.crossref.works.doi(null!=(D=e.doi)?D:t.provenance.example)),o=0,p=(L=null!=(C=null!=n?n.assertion:void 0)?C:[]).length;o<p;o++)if("copyright"===(i=L[o]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(m&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,m&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(a="",u=0,d=(N=t.deposit_statement.split("<<")).length;u<d;u++)if(y=N[u],""!==a||y.includes(">>")){if(null!=(E={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(l=y.split(">>"))[0].toLowerCase()]&&(f=E[f]),"author"===f)try{a+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else a+=null!=(b=null!=(w=e[f])?w:t[f])?b:"";try{a+=l[1]}catch(e){}}else a+=y;t.deposit_statement=a}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(q=t.issuer.has_policy),c=0,h=(k=["_id","hide"]).length;c<h;c++)delete t[k[c]];return t},u=e=>{var t,i,r,s,n,l;return l=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(l+=1e3),null!=e.requirements?l-=10:l+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,e.licence&&(l-=5),l+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(n=e.issuer)?n.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(l-=25),l},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),v=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&e.issn.includes(",")&&(e.issn=e.issn.split(",")),delete e.best,"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(null==l&&(l=this.params.best),l&&e.doi&&!e.ror.length&&(p=await this.permissions.best(e.doi))&&(!0===l||p.updated>l))return delete p.updated,delete p.DOI,{best_permission:p};if(o=async()=>{var t,i,r,s,l,a;if(i=this.copy(e),"{}"!==JSON.stringify(i)){try{a=null!=(r=null!=n?n:await this.metadata(e.doi))?r:{}}catch(e){}try{a=null!=(s=null!=n?n:await this.metadata_internal(e.doi))?s:{}}catch(e){}for(t in l=[],a)l.push(null!=e[t]?e[t]:e[t]=a[t]);return l}},!1===i||!e.doi||e.publisher&&e.issn||await o(),!e.published&&e.year&&(e.published=e.year+"-01-01"),m=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!v.length)for(y=0,x=(X=e.issn).length;y<x;y++)_=X[y],L.call(v,_)<0&&v.push(_);try{null==e.doi&&(e.doi=await this.permissions.journals.example(v))}catch(e){}!m&&e.doi&&await o()}if(m&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ce=e.year)?ce:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(M={best_permission:void 0,all_permissions:[]},Se=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(De=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(be=De.hits)?be.total:void 0))try{(null!=(we=(Ce=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')).hits)?we.total:void 0)&&(Ce=Ce.hits.hits[0]._source),Ce.country.country_code&&(De=await this.permissions.affiliations('issuer.id:"'+Ce.country.country_code+'"'))}catch(e){}for(b=0,O=(ke=null!=(xe=null!=De&&null!=(Oe=De.hits)?Oe.hits:void 0)?xe:[]).length;b<O;b++)Ae=ke[b],(Ee=await a(Ae._source)).score=await u(Ee),Se.push(Ee)}if(g=void 0,v){for await($ of this.index._for("src_doaj_journals",'bibjson.pissn:"'+v.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+v.join('" OR bibjson.eissn:"')+'"'))g||(g=$),V=$.bibjson.pissn,L.call(v,V)<0&&v.push($.bibjson.pissn),G=$.bibjson.eissn,L.call(v,G)<0&&v.push($.bibjson.eissn);if(v.length)for(P=0,j=(Z=null!=(H=null!=(z=await this.permissions.journals('issuer.id:"'+v.join('" OR issuer.id:"')+'"'))&&null!=(Y=z.hits)?Y.hits:void 0)?H:[]).length;P<j;P++)W=Z[P],(Ie=await a(W._source)).score=await u(Ie),M.all_permissions.push(Ie)}if(e.publisher)for(B='issuer.id:"'+e.publisher+'"',R=0,S=(ee=null!=(K=null!=(z=await this.permissions.publishers(B))&&null!=(Q=z.hits)?Q.hits:void 0)?K:[]).length;R<S;R++)W=ee[R],(Ie=await a(W._source)).score=await u(Ie),M.all_permissions.push(Ie);if(c={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},v&&(null!=g?g:g=await this.src.doaj.journals('bibjson.eissn.keyword:"'+v.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+v.join('" OR bibjson.pissn.keyword:"')+'"',1))){for(T=0,I=(se=null!=(ie=null!=(re=g.bibjson)?re.license:void 0)?ie:[]).length;T<I;T++)h=se[T],(!c.licence||c.licence.length<h.type.length)&&(c.licence=h.type),null==c.licences&&(c.licences=[]),c.licences.push({type:h.type});if(null==c.licence&&(d=await this.src.crossref.journals('ISSN.keyword:"'+v.join('" OR ISSN.keyword:"')+'"',1)))for(F=0,A=(le=null!=(ne=d.license)?ne:[]).length;F<A;F++)E=le[F],(!c.licence||c.licence.length<E.type.length)&&(c.licence=E.type);"string"==typeof c.licence?(c.licence=c.licence.toLowerCase().trim(),c.licence.startsWith("cc")?c.licence=c.licence.replace(/ /g,"-"):c.licence.includes("creative")?c.licence=c.licence.includes("0")||c.licence.includes("zero")?"cc0":c.licence.includes("share")?"ccbysa":c.licence.includes("derivative")?"ccbynd":"ccby":delete c.licence):delete c.licence,c.issuer.id=g.bibjson.eissn&&g.bibjson.pissn?[g.bibjson.pissn,g.bibjson.eissn]:g.bibjson.pissn?[g.bibjson.pissn]:[g.bibjson.eissn],c.embargo_months=0,c.provenance={oa_evidence:"In DOAJ"},c.score=await u(c),M.all_permissions.push(c)}else!v&&e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(c.issuer.id=e.publisher,c.meta.creator=["joe+oapublisher@oa.works"],c.meta.contributors=["joe+oapublisher@oa.works"],c.provenance={oa_evidence:"OA publisher"},c.score=await u(c),M.all_permissions.push(c));if(e.doi&&(null==s&&(s=await this.src.oadoi.doi(e.doi)),m&&(null!=s&&null!=(ae=s.best_oa_location)?ae.license:void 0)&&s.best_oa_location.license.includes("cc")&&((f={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(f.versions="submittedVersion"===f.version?["submittedVersion"]:"acceptedVersion"===f.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),f.score=await u(f),M.all_permissions.push(f))),M.all_permissions.length){for(M.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),J=0,D=(oe=M.all_permissions).length;J<D;J++)null==(Te=oe[J]).licences&&(Te.licences=[],Te.licence&&Te.licences.push({type:Te.licence})),m&&(null!=(ue=Te.issuer)?ue.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Te.issuer.journal_oa_type_from)&&delete Te.issuer.journal_oa_type,delete Te.issuer.journal_oa_type_from,!v&&"journal"!==(null!=(pe=Te.issuer)?pe.type:void 0)||Te.issuer.journal_oa_type||(Te.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=v?v:Te.issuer.id,g,s,n)),(null!=(de=Te.provenance)?de.enforcement_from:void 0)?(!e.published||Date.parse(e.published)>Date.parse(Te.provenance.enforcement_from.split("/").reverse().join("-")))&&null==M.best_permission&&(M.best_permission=this.copy(Te)):null==M.best_permission&&(M.best_permission=this.copy(Te));if(Se.length)for(Se.sort(((e,t)=>e.score<t.score?1:-1)),Le=0,C=Se.length;Le<C;Le++)if(je=Se[Le],m&&(null!=(he=je.issuer)?he.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(je.issuer.journal_oa_type_from)&&delete je.issuer.journal_oa_type,delete je.issuer.journal_oa_type_from,!v&&"journal"!==(null!=(fe=je.issuer)?fe.type:void 0)||je.issuer.journal_oa_type||(je.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=v?v:je.issuer.id,g,s,n)),M.all_permissions.push(je),null==(null!=(me=M.best_permission)?me.author_affiliation_requirement:void 0)&&null!=M.best_permission&&(!(null!=(ye=je.provenance)?ye.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(je.provenance.enforcement_from.split("/").reverse().join("-")))){for(U=this.copy(M.best_permission),Ne=0,N=(ge=["versions","locations"]).length;Ne<N;Ne++)for(Pe=0,k=(_e=je[w=ge[Ne]]).length;Pe<k;Pe++)Re=_e[Pe],null==U[w]&&(U[w]=[]),L.call(U[w],Re)<0&&U[w].push(Re);U.version=L.call(U.versions,"publishedVersion")>=0?"publishedVersion":L.call(U.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",U.embargo_end&&je.embargo_end&&Date.parse(je.embargo_end)<Date.parse(U.embargo_end)&&(U.embargo_end=je.embargo_end),U.embargo_months&&null!=je.embargo_months&&je.embargo_months<U.embargo_months&&(U.embargo_months=je.embargo_months),!0===je.can_archive&&(U.can_archive=!0),null==U.requirements&&(U.requirements={}),U.requirements.author_affiliation_requirement=null==e.ror?je.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],U.issuer.affiliation=je.issuer,null==U.meta&&(U.meta={}),U.meta.affiliation=je.meta,null==U.provenance&&(U.provenance={}),U.provenance.affiliation=je.provenance,U.score=parseInt(U.score)+parseInt(je.score),M.best_permission=U,M.all_permissions.push(U)}}return q?{body:"string"!=typeof q?q:null!=(ve={"not publisher":"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it"}[q.toLowerCase()])?ve:q,status:501}:(e.doi&&!Se.length&&M.best_permission&&((p=await this.copy(M.best_permission)).updated=await this.epoch(),p.DOI=e.doi,this.waitUntil(this.permissions.best(p))),!0!==this.params.metadata&&!0!==i||(M.metadata=e),M)},t.permissions._log=!1,t.permissions.best={_index:!0,_key:"DOI"},t.permissions.journals={_sheet:"1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",_prefix:!1,_format:async function(e=[]){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v;for(f=[],s=0,u=(y="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<u;s++){for(l in h={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},m=y[s])if("string"==typeof m[l]&&(m[l]=m[l].trim()),"id"===l)if(h.issuer.id="string"==typeof m.id&&m.id.includes(",")?m.id.split(","):m.id,"string"==typeof h.issuer.id&&h.issuer.id.startsWith("10.")&&h.issuer.id.includes("/")&&!h.issuer.id.includes(" "))h.DOI=h.issuer.id;else{for(r=[],n=0,c=(g="string"==typeof h.issuer.id?[h.issuer.id]:h.issuer.id).length;n<c;n++){if(d=(d=g[n]).trim(),"journal"===h.issuer.type&&d.includes("-")&&!d.includes(" ")&&(d=d.toUpperCase(),t=await this.src.openalex.sources('issn:"'+d+'"',1)))for(o=0,p=(_=t.issn).length;o<p;o++)i=_[o],L.call(r,i)<0&&r.push(i);L.call(r,d)<0&&r.push(d)}h.issuer.id=r}else"embargo_months"===l?(a="number"==typeof m[l]?m[l]:"string"==typeof m[l]?parseInt(m[l].trim()):void 0)&&"number"==typeof a&&(h.embargo_months=a,h.embargo_end=""):l&&null!=m[l]&&""!==(v=m[l])&&"none"!==v&&"unclear"!==v&&("versions"===l&&m.versions.length&&(h.can_archive=!0,h.version=m.versions.includes("ublish")?"publishedVersion":m.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==l&&"locations"!==l&&"meta.contributors"!==l&&"meta.creator"!==l&&"meta.reviewer"!==l&&"provenance.archiving_policy"!==l&&"requirements.funder"!==l&&"journal"!==l||(m[l]=m[l].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(h,"license"===l?"licence":l,m[l]));h.copyright_owner&&"journal"!==h.copyright_owner.toLowerCase()||!h.issuer.type||(h.copyright_owner=h.issuer.type),"{}"===JSON.stringify(h.requirements)&&delete h.requirements,f.push(h)}return 1===f.length?f[0]:f}},t.permissions.publishers={_sheet:"11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.affiliations={_sheet:"15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.journals.example=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.crossref.works('ISSN:"'+e.join('" OR ISSN:"')+'"',1)).DOI}catch(e){}},t.permissions.journals.example._log=!1,t.permissions.journals.transformative={_index:!0,_prefix:!1},t.permissions.journals.transformative.load=async function(){var e,t,i,r,s;for(e=[],t=0,i=(s=(await this.fetch("https://api.journalcheckertool.org/journal?q=tj:true&include=issn&size=10000")).hits.hits).length;t<i;t++)r=s[t],e.push(r._source);return e.length&&(await this.permissions.journals.transformative(""),await this.permissions.journals.transformative(e)),e.length},t.permissions.journals.transformative.load._bg=!0,t.permissions.journals.transformative.load._async=!0,t.permissions.journals.transformative.load._auth="root",t.permissions.journals.oa=async function(e,t){var i,r,s,n,l,a;try{null==e&&(e=null!=(r=null!=(s=null!=(n=this.params.journals)?n:this.params.journal)?s:this.params.issn)?r:this.params.oa)}catch(e){}return a={},e&&(a.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'"'),a.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'" AND is_oa:true'),a.articles===a.open&&(a.oa=!0),await this.src.doaj.journals('bibjson.pissn:"'+e+'" OR bibjson.eissn:"'+e+'"',1)&&(a.open=a.articles,a.doaj=!0,a.oa=!0),(i=await this.permissions.journals.example(e))&&(null==t&&(t=await this.src.oadoi.doi(i)),null!=t?(delete a.oa,a.open=a.articles,a.oadoi=!0,a.oa=(null!=t&&null!=(l=t.best_oa_location)?l.license:void 0)&&t.best_oa_location.license.includes("cc")):a.oa=!1)),a},t.permissions.journals.oa._log=!1,t.permissions.journals.oa.type=async function(e,t,i,r){var s,n,l,a,o,u,c,p,d,h,f,m,y;return null==e&&(e=null!=(l=null!=(a=null!=(u=null!=(c=null!=(p=null!=(d=null!=i?i.journal_issns:void 0)?d:null!=r?r.ISSN:void 0)?p:this.params.journals)?c:this.params.journal)?u:this.params.type)?a:this.params.issn)?l:this.params.issns),"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),e.startsWith("10.")&&(null==i&&(i=await this.src.oadoi.doi(e)),null==r&&(r=await this.src.crossref.works.doi(e)),e=null!=(h=null!=i?i.journal_issns:void 0)?h:null!=r?r.ISSN:void 0)),"string"==typeof e&&(e=e.split(",")),n="unknown",null!=(null!=r?r.type:void 0)&&"journal-article"!==r.type?n="not applicable":(null!=r?r.type:void 0)&&"journal-article"!==r.type||(n="gold"===(null!=i?i.oa_status:void 0)||(null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",null==t&&e&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?n=!1===(null!=(f=t.bibjson)&&null!=(m=f.apc)?m.has_apc:void 0)?"diamond":"gold":e&&(e&&await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?n="transformative":"closed"===n&&(await this.src.oadoi.hybrid(e)?n="hybrid":"closed"!==(y=null!=i?i.oa_status:void 0)&&"bronze"!==y&&"green"!==y&&(s=await this.src.oadoi.oa.type(e)).calculated&&"closed"!==(o=s.calculated)&&"bronze"!==o&&"green"!==o&&(n=s.calculated)))),n},t.permissions.journals.oa.type._log=!1,t.permissions.publishers.oa=async function(e){var t,i,r,s;return s={publisher:(null!=(r=null!=e?e:this.params.publisher)?r:this.params.oa).replace(/&/g,"")},await this.src.crossref.journals('publisher:"'+s.publisher+'"',1)||((t=await this.src.crossref.journals('publisher:"'+s.publisher.split(" ").join('" AND publisher:"')+'"',1))?t.publisher.toLowerCase()!==s.publisher.toLowerCase()&&((i=await this.levenshtein(t.publisher,s.publisher)).distance<5||(i.length.a>i.length.b?i.length.a:i.length.b)/i.distance>10)&&(s.publisher=t.publisher):s.journals=0),null==s.journals&&(s.journals=await this.src.crossref.journals.count('publisher:"'+s.publisher+'" AND NOT discontinued:true')),s.open=await this.src.doaj.journals.count('publisher:"'+s.publisher+'" AND NOT bibjson.discontinued_date:* AND NOT bibjson.is_replaced_by:*'),s.percent=s.journals?Math.ceil(s.open/s.journals*100):s.open?100:0,s.oa=!s.journals&&s.open||s.journals&&s.journals===s.open,s},t.permissions.publishers.oa._log=!1,L=[].indexOf,t.permissions_new=async function(e,t,i){var s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et;U=!1,h=!1,s=function(t){var i,s,n,l,a,o,u,c,p,d,f,m,y,g,_,v,b,w,x,O,k;if(h&&t.embargo_months&&(e.published||e.year)&&(i=new Date(Date.parse(null!=(d=e.published)?d:e.year+"-01-01")),i=new Date(i.setMonth(i.getMonth()+t.embargo_months)),t.embargo_end=i.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(f=t.copyright_owner.toLowerCase())&&"affiliation"!==f?h&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(g=e.author[0].name)?g:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(y=e.journal)?y:"",h&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,h&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(n="",l=0,o=(_=t.deposit_statement.split("<<")).length;l<o;l++)if(p=_[l],""!==n||p.includes(">>")){if(null!=(k={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[c=(s=p.split(">>"))[0].toLowerCase()]&&(c=k[c]),"author"===c)try{n+=(null!=(v=e.author[0].name)?v:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else n+=null!=(b=null!=(w=e[c])?w:t[c])?b:"";try{n+=s[1]}catch(e){}}else n+=p;t.deposit_statement=n}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(U=t.issuer.has_policy),a=0,u=(m=["_id","hide"]).length;a<u;a++)delete t[m[a]];return t},n=e=>{var t,i,r,s,n,l;return l=(e.can_archive?1e3:0)+("In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)?1e3:0)+(e.licence?-5:0),l+=null!=e.requirements?-10:"publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,l+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(n=e.issuer)?n.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(l-=25),l},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params));try{e.permissions=e.permissions_new,delete e.permissions_new}catch(e){}if(!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),"string"==typeof e.issn&&(e.issn=e.issn.split(",")),"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};h=e.doi;try{null==e.doi&&(e.doi=await this.permissions_new.journals.example(e.issn))}catch(e){}if(h&&(!e.publisher||!e.issn)&&(null!=i?i:i=await this.src.openalex.works(h))){for(f=0,b=(G=null!=(V=i.authorships)?V:[]).length;f<b;f++){for(l=G[f],(u={}).name=l.author.display_name,u.family=u.name.split(" ").pop(),u.name.split(" ").length>1&&(u.given=u.name.split(" ")[0]),y=0,w=(fe=null!=(se=l.raw_affiliation_strings)?se:[]).length;y<w;y++)a=fe[y],null==u.affiliation&&(u.affiliation=[]),u.affiliation.push({name:a});null==e.author&&(e.author=[]),e.author.push(u)}if(null==e.type&&(e.type=i.type_crossref),"journal"===(null!=(ke=i.primary_location)&&null!=(Pe=ke.source)?Pe.type:void 0))for(null==e.publisher&&(e.publisher=null!=(We=i.primary_location.source.publisher)?We:i.primary_location.source.host_organization_name),null==e.journal&&(e.journal=i.primary_location.source.display_name),null==e.issn&&(e.issn=[]),g=0,j=(Me=null!=(Ue=i.primary_location.source.issn)?Ue:[]).length;g<j;g++)q=Me[g],L.call(e.issn,q)<0&&e.issn.push(q);for(null==e.published&&(e.published=i.publication_date),null==e.year&&(e.year=i.publication_year),e.abstract=i.abstract,v=0,S=(ze=["title"]).length;v<S;v++)i[W=ze[v]]&&null==e[W]&&(e[W]=i[W]);for(P=0,I=(H=["volume","issue"]).length;P<I;P++)c=H[P],(null!=(Y=i.biblio)?Y[c]:void 0)&&null==e[c]&&(e[c]=i.biblio[c]);((null!=(Z=i.biblio)?Z.first_page:void 0)||(null!=(K=i.biblio)?K.last_page:void 0))&&(e.pages=(null!=(Q=i.biblio.first_page)?Q:"")+(i.biblio.first_page&&i.biblio.last_page?" to ":"")+(null!=(ee=i.biblio.last_page)?ee:""))}if(!e.year&&e.published&&e.published.includes("-")&&(e.year=e.published.split("-")[0]),"number"==typeof e.year&&(e.year+=""),!e.published&&e.year&&(e.published=e.year+"-01-01"),"string"==typeof e.issn&&(e.issn=[e.issn]),e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim()),h&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};try{e.citation="["+(e.title?e.title+". ":""),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ie=e.year)?ie:e.published).split("-")[0]+")"),e.citation=e.citation.trim()+"]"}catch(e){}if(F={best_permission:void 0,all_permissions:[]},Be=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(Xe=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(re=Xe.hits)?re.total:void 0)){try{Ve=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')}catch(e){}(null!=Ve&&null!=(ne=Ve.hits)?ne.total:void 0)&&(Ve=Ve.hits.hits[0]._source),(null!=Ve&&null!=(le=Ve.country)?le.country_code:void 0)&&(Xe=await this.permissions.affiliations('issuer.id:"'+Ve.country.country_code+'"'))}for(R=0,A=(ue=null!=(ae=null!=Xe&&null!=(oe=Xe.hits)?oe.hits:void 0)?ae:[]).length;R<A;R++)$e=ue[R],(Ye=await s($e._source)).score=await n(Ye),Be.push(Ye)}if(m=void 0,e.issn){for await(X of this.index._for("src_doaj_journals",'bibjson.pissn:"'+e.issn.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+e.issn.join('" OR bibjson.eissn:"')+'"'))null==m&&(m=X),ce=X.bibjson.pissn,L.call(e.issn,ce)<0&&e.issn.push(X.bibjson.pissn),pe=X.bibjson.eissn,L.call(e.issn,pe)<0&&e.issn.push(X.bibjson.eissn);for(T=0,D=(me=null!=(de=null!=(B=await this.permissions.journals('issuer.id:"'+e.issn.join('" OR issuer.id:"')+'"'))&&null!=(he=B.hits)?he.hits:void 0)?de:[]).length;T<D;T++)M=me[T],(Je=await s(M._source)).score=await n(Je),F.all_permissions.push(Je)}if(e.publisher)for(J=0,C=(_e=null!=(ye=null!=(B=await this.permissions.publishers('issuer.id:"'+e.publisher+'"'))&&null!=(ge=B.hits)?ge.hits:void 0)?ye:[]).length;J<C;J++)M=_e[J],(Je=await s(M._source)).score=await n(Je),F.all_permissions.push(Je);if(o={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},m){for($=0,N=(we=null!=(ve=null!=(be=m.bibjson)?be.license:void 0)?ve:[]).length;$<N;$++)p=we[$],(!o.licence||o.licence.length>p.type)&&(o.licence=p.type),null==o.licences&&(o.licences=[]),o.licences.push({type:p.type});"string"==typeof o.licence?(o.licence=o.licence.toLowerCase().trim(),o.licence.startsWith("cc")?o.licence=o.licence.replace(/ /g,"-"):o.licence.includes("creative")?o.licence=o.licence.includes("0")||o.licence.includes("zero")?"cc0":o.licence.includes("share")?"ccbysa":o.licence.includes("derivative")?"ccbynd":"ccby":delete o.licence):delete o.licence,o.issuer.id=m.bibjson.eissn&&m.bibjson.pissn?[m.bibjson.pissn,m.bibjson.eissn]:m.bibjson.pissn?[m.bibjson.pissn]:[m.bibjson.eissn],o.embargo_months=0,o.provenance={oa_evidence:"In DOAJ"},o.score=await n(o),F.all_permissions.push(o)}else e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(o.issuer.id=e.publisher,o.meta.creator=["joe+oapublisher@oa.works"],o.meta.contributors=["joe+oapublisher@oa.works"],o.provenance={oa_evidence:"OA publisher"},o.score=await n(o),F.all_permissions.push(o));if(h&&(null!=i?i:i=await this.src.openalex.works(h))&&(null!=(xe=null!=i&&null!=(Oe=i.best_oa_location)?Oe.license:void 0)?xe:"").includes("cc")&&((d={can_archive:!0,version:i.best_oa_location.version,versions:"submittedVersion"===i.best_oa_location.version?["submittedVersion"]:"acceptedVersion"===i.best_oa_location.version?["submittedVersion","acceptedVersion"]:i.best_oa_location.version?["submittedVersion","acceptedVersion","publishedVersion"]:[],licence:i.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:i.updated},provenance:{oa_evidence:"Openalex"}}).score=await n(d),F.all_permissions.push(d)),F.all_permissions.length){for(F.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),Ge=0,E=(je=F.all_permissions).length;Ge<E;Ge++)null==(et=je[Ge]).licences&&(et.licences=[],et.licence&&et.licences.push({type:et.licence})),h&&(null!=(Se=et.issuer)?Se.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(et.issuer.journal_oa_type_from)&&delete et.issuer.journal_oa_type,delete et.issuer.journal_oa_type_from,!e.issn&&"journal"!==(null!=(Ie=et.issuer)?Ie.type:void 0)||et.issuer.journal_oa_type||(et.issuer.journal_oa_type=await this.permissions_new.journals.oa.type(null!=(Ae=e.issn)?Ae:et.issuer.id,m,i)),(!(null!=(De=et.provenance)?De.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(et.provenance.enforcement_from.split("/").reverse().join("-")))&&null==F.best_permission&&(F.best_permission=et);for(Ce=Be.sort(((e,t)=>e.score<t.score?1:-1)),He=0,x=Ce.length;He<x;He++)if(Fe=Ce[He],h&&(null!=(Le=Fe.issuer)?Le.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Fe.issuer.journal_oa_type_from)&&delete Fe.issuer.journal_oa_type,delete Fe.issuer.journal_oa_type_from,!e.issn&&"journal"!==(null!=(Ne=Fe.issuer)?Ne.type:void 0)||Fe.issuer.journal_oa_type||(Fe.issuer.journal_oa_type=await this.permissions_new.journals.oa.type(null!=(Ee=e.issn)?Ee:Fe.issuer.id,m,i)),F.all_permissions.push(Fe),null!=(z=F.best_permission)&&null==z.author_affiliation_requirement&&(!(null!=(Re=Fe.provenance)?Re.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(Fe.provenance.enforcement_from.split("/").reverse().join("-")))){for(Ze=0,O=(Te=["versions","locations"]).length;Ze<O;Ze++)for(Ke=0,k=(qe=Fe[_=Te[Ze]]).length;Ke<k;Ke++)Qe=qe[Ke],L.call(z[_],Qe)<0&&z[_].push(Qe);z.version=L.call(z.versions,"publishedVersion")>=0?"publishedVersion":L.call(z.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",z.embargo_end&&Fe.embargo_end&&Date.parse(Fe.embargo_end)<Date.parse(z.embargo_end)&&(z.embargo_end=Fe.embargo_end),z.embargo_months&&null!=Fe.embargo_months&&Fe.embargo_months<z.embargo_months&&(z.embargo_months=Fe.embargo_months),!0===Fe.can_archive&&(z.can_archive=!0),null==z.requirements&&(z.requirements={}),z.requirements.author_affiliation_requirement=null==e.ror?Fe.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],z.issuer.affiliation=Fe.issuer,null==z.meta&&(z.meta={}),z.meta.affiliation=Fe.meta,null==z.provenance&&(z.provenance={}),z.provenance.affiliation=Fe.provenance,z.score=parseInt(z.score)+parseInt(Fe.score),F.all_permissions.push(z)}}return U?{status:501,body:"string"==typeof U&&"not publisher"===U.toLowerCase()?"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it":U}:(!0===this.params.metadata&&(F.metadata=e),F)},t.permissions_new._log=!1,t.permissions_new.journals={example:async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.openalex.works('ids.doi:* AND locations.source.issn:"'+e.join('" OR locations.source.issn:"')+'"',1)).doi}catch(e){}}},t.permissions_new.journals.example._log=!1,t.permissions_new.journals.oa={type:async function(e,t,i,r){var s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N;if(null==e&&(e=null!=(h=null!=(f=null!=(k=null!=(j=null!=(S=this.params.journals)?S:this.params.journal)?j:this.params.type)?k:this.params.issn)?f:this.params.issns)?h:[]),l=null!=t,"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),null==i&&e.startsWith("10.")&&(i=await this.src.openalex.works.doi(e),null==r&&null==i&&(r=await this.src.crossref.works.doi(e)),e=[])),"string"==typeof e&&(e=e.split(",")),o="unknown",(null!=i?i.type_crossref:void 0)&&"journal-article"!==i.type_crossref||(null!=r?r.type:void 0)&&"journal-article"!==r.type)o="not applicable";else if(!((null!=i?i.type_crossref:void 0)&&"journal-article"!==i.type_crossref||(null!=r?r.type:void 0)&&"journal-article"!==r.type)){if(null!=i){for(n=0,u=(A=null!=(I=i.locations)?I:[]).length;n<u;n++)for((null!=(D=(p=A[n]).source)?D.is_in_doaj:void 0)&&(l=!0),a=0,c=(m=null!=(C=null!=(N=p.source)?N.issn:void 0)?C:[]).length;a<c;a++)(d=m[a])&&L.call(e,d)<0&&e.push(d);o="hybrid"!==(null!=(y=i.open_access)?y.oa_status:void 0)||l?l||"gold"===(null!=(g=i.open_access)?g.oa_status:void 0)?"gold":"closed":"hybrid"}"unknown"!==o||e||l||!(null!=r||(null!=i&&null!=(_=i.ids)?_.doi:void 0)&&(r=await this.src.crossref.works(i.ids.doi.split("doi.org/").pop())))||r.ISSN&&(e=r.ISSN),(e||null!=t)&&(null==t&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?o=!1===(null!=(v=t.bibjson)&&null!=(b=v.apc)?b.has_apc:void 0)?"diamond":"gold":e&&(await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?o="transformative":"closed"===o&&(await this.src.openalex.hybrid(e)?o="hybrid":"closed"!==(w=null!=i&&null!=(x=i.open_access)?x.oa_status:void 0)&&"bronze"!==w&&"green"!==w&&(s=await this.src.openalex.oa.type(e)).calculated&&"closed"!==(O=s.calculated)&&"bronze"!==O&&"green"!==O&&(o=s.calculated))))}return o}},t.permissions_new.journals.oa.type._log=!1,L=[].indexOf;try{r.report=JSON.parse(SECRETS_REPORT)}catch(e){}null==r.report&&(r.report={}),t.report=function(){return"OA.Works report"},t.report.chat=async function(e,t,i,r){var s,n,l;return(s=this.params.pmcid)&&(r=await this.src.epmc.xml(s),!0!==this.params.xml&&(r=r.split("<ref-list>")[0].replace(/\n/g," ").replace(/(<([^>]+)>)/gi,""))),null==e&&(e=null!=(n=this.params.prompt)?n:"Please return the data availability statement"),r&&(e+=" of the following research article: "+r),null==t&&(t=null!=(l=this.params.role)?l:"You are a terse text and data mining extraction tool in the scientific research publishing field"),r?this.src.openai.chat(e,t,this.params.model,this.params.json):{}},m=[],g=[],y=!1,o=[],u=[],h=[],d={},f={},c=[],p=!1,t.report._handle_queue=async function(){var e,t;if(!1===y&&(y=Date.now()),m.length>3e3||m.length&&Date.now()>y+3e4){for(D.log("handle queue saving batch",m.length),e=[];t=m.shift();)g.shift(),t.createdAt=Date.now(),null==t._id&&(t._id=t.identifier.toLowerCase()),e.push(t),e.length>=1e4&&(await this.report.queued(e),e=[]);e.length&&this.report.queued(e),y=Date.now()}return!1===p&&this.report._handle_processed(),setTimeout(this.report._handle_queue,5e3)},t.report._handle_processed=async function(){var e,t,i;if(!1===p&&(p=Date.now()),c.length>=3e3||c.length&&Date.now()>p+3e4){for(D.log("handle processed saving batch",c.length),i=c,c=[],e=u,u=[],this.report.works(i);t=e.shift();)await this.report.queued(t,"");p=Date.now()}return setTimeout(this.report._handle_processed,5e3)},t.report.queued={_index:!0},t.report.queue=async function(e,t,i,r,s="default"){var n,l,a,o,c,p,d,h,f,_,v,b,w,x,O,k;if(this.params.empty)if("string"==typeof this.params.empty)for await(o of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_queued",'action.keyword:"'+this.params.empty+'"'))await this.report.queued(o._id,"");else await this.report.queued("");if(null==e&&(e=null!=(c=null!=(p=null!=(d=this.params.queue)?d:this.params.doi)?p:this.params.openalex)?c:this.params.pmcid),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),e)for(l=0,a=(h=Array.isArray(e)?e:[e]).length;l<a;l++){n=h[l];try{(O="object"==typeof n?null!=(f=null!=(_=null!=(v=null!=(b=null!=(w=n.ident)?w:n.identifier)?b:n.DOI)?v:n.doi)?_:n.openalex)?f:n.pmcid:n).startsWith("w")&&(O=O.replace("w","W")),O.startsWith("pmc")&&(O=O.replace("pmc","PMC")),O.includes("10.")&&!(O=await this.report.cleandoi(O))||(k=O.toLowerCase(),O&&"string"==typeof O&&(O.startsWith("10.")||O.startsWith("W")||O.startsWith("PMC"))&&L.call(g,k)<0&&L.call(u,k)<0&&(g.push(k),x=!0===(x="object"==typeof n&&null!=n.refresh?n.refresh:null!=i?i:"undefined"!=typeof inq&&null!==inq?inq.refresh:void 0)?0:!1===x?void 0:x,m.push({identifier:O,refresh:x,everything:"object"==typeof n&&null!=n.everything?n.everything:null!=r?r:"undefined"!=typeof inq&&null!==inq?inq.everything:void 0,action:"object"==typeof n&&null!=n.action?n.action:s})))}catch(e){}}return!1===y&&this.report._handle_queue(),{queue:m.length}},t.report.queue._bg=!0,t.report.queue._log=!1,t.report.queue._auth="@oa.works",t.report._runqueue=async function(e,t,i,r){var s,n,l,a,c,p,d,f,g,_,v,b,w,x,O,k,j;if(null==t&&(t='action:"default"'),null==i&&(i="desc"),null!=e)t="for requested identifier "+e;else{if(o.length)t="";else if(r&&(!0===r&&(r=(s=(await this.report.queued(t,{size:1,sort:{createdAt:"asc"}})).createdAt)+Math.floor(((await this.report.queued(t,{size:1,sort:{createdAt:"desc"}})).createdAt-s)/2),D.log("queue midpoint",r)),t="("+t+") AND createdAt:"+("desc"===i?"<":">")+r),(null!=(c=await this.report.queued(t,{size:2e3,sort:{createdAt:i}}))&&null!=(d=c.hits)?d.total:void 0)||'action:"default"'!==t||(D.log("no queued records found for specified qry",t,"checking for any other queued records..."),c=await this.report.queued("NOT action:*",{size:2e3,sort:{createdAt:i}}),t="queried * as none for qry "+t),r&&(null!=c&&null!=(f=c.hits)?f.total:void 0)&&c.hits.total<5e3)D.log("not queueing on mid "+i+" queue when only "+c.hits.total+" records to process, waiting 5s..."),await this.sleep(5e3);else if("desc"!==i&&(null!=c&&null!=(_=c.hits)?_.total:void 0)&&c.hits.total<1e4)D.log("not queueing on reverse "+i+" queue when only "+c.hits.total+" records to process, waiting 5s..."),await this.sleep(5e3);else for((null!=c&&null!=(v=c.hits)?v.total:void 0)||m.length||(D.log("no queued records to process, waiting 5s..."),await this.sleep(5e3)),n=0,l=(x=null!=(b=null!=c&&null!=(w=c.hits)?w.hits:void 0)?b:[]).length;n<l;n++)O=(p=x[n])._source.identifier,L.call(h,O)<0&&(k=p._source.identifier,L.call(u,k)<0)&&(j=p._source.identifier,L.call(o,j)<0)&&o.push(p._source);e=null!=(g=null!=(a=o.shift())?a.identifier:void 0)?g:null!=a?a.DOI:void 0}if(D.log("report run queue",h.length,o.length),"string"==typeof e&&(e.startsWith("10.")||e.startsWith("W")||e.startsWith("PMC"))&&L.call(h,e)<0&&L.call(u,e)<0){for(await this.sleep(10);h.length>=5;)await this.sleep(500);h.push(e),this.report.works.process(e,void 0,null!=a?a.refresh:void 0,null!=a?a.everything:void 0,null!=a?a.action:void 0,void 0,e)}return!1===y&&this.report._handle_queue(),!0},t.report._doqueue=function(){return this.report._runqueue()},t.report._doqueue._log=!1,t.report._doqueue._bg=!0,t.report._domidqueue=function(){return this.report._runqueue(void 0,void 0,void 0,!0)},t.report._domidqueue._log=!1,t.report._domidqueue._bg=!0,t.report._domidreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc",!0)},t.report._domidreversequeue._log=!1,t.report._domidreversequeue._bg=!0,t.report._doreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc")},t.report._doreversequeue._log=!1,t.report._doreversequeue._bg=!0,t.report._dochangesqueue=function(){return this.report._runqueue(void 0,'action:"changes" OR action:"years"')},t.report._dochangesqueue._log=!1,t.report._dochangesqueue._bg=!0,t.report.dev2live=async function(e){var t,i,r,s,n,l,a;for await(n of("number"==typeof(a=this.params.toalias)&&(a+=""),s=this.params.org?'orgs.keyword:"'+this.params.org+'"':this.params.q,e?(r="paradigm_report_works",l="paradigm_b_report_works"):(r="paradigm_b_report_works",l="paradigm_report_works"),this.params.clear&&await this.index._send(l,"",void 0,!1,a),i=0,t=[],D.log("report works running",e?"live2dev":"dev2live",r,l,a,s),this.index._for(r,s,{scroll:"30m"})))i+=1,t.push(n),5e4===t.length&&(D.log("report works",e?"live2dev":"dev2live",r,l,a,i),await this.index._bulk(l,t,void 0,void 0,!1,a),t=[]);return t.length&&(D.log("report works",e?"live2dev":"dev2live",r,l,a,i,"remaining",t.length),await this.index._bulk(l,t,void 0,void 0,!1,a),t=[]),D.log(i,"report works",e?"live2dev":"dev2live",r,l,a,"complete",s?"for query "+s:""),i},t.report.dev2live._async=!0,t.report.dev2live._bg=!0,t.report.dev2live._auth="@oa.works",t.report.live2dev=function(){return this.report.dev2live(!0)},t.report.live2dev._async=!0,t.report.live2dev._bg=!0,t.report.live2dev._auth="root",t.report.oapolicy={_sheet:r.report.oapolicy_sheet,_format:function(e=[]){var t,i,r,s,n,l,a,o;for(l=[],r=0,s=(o="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<s;r++){for(i in n={},a=o[r]){if("string"==typeof a[i])if(a[i]=a[i].trim(),"true"===a[i].toLowerCase())a[i]=!0;else if("false"===a[i].toLowerCase())a[i]=!1;else if(a[i].startsWith("[")&&a[i].endsWith("]")||a[i].startsWith("{")&&a[i].endsWith("}"))try{a[i]=JSON.parse(a[i])}catch(e){t=e,D.log("cant parse "+i,a[i],t)}else a[i].includes(";")&&(a[i]=a[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(null!=a[i]&&""!==a[i])if(i.includes("."))try{this.dot(n,i,a[i])}catch(e){}else n[i]=a[i]}"{}"!==JSON.stringify(n)&&l.push(n)}return 1===l.length?l[0]:l}},t.report.cleandoi=function(e){var t;null==e&&(e=null!=(t=this.params.cleandoi)?t:this.params.doi);try{e=e.split(",http")[0]}catch(e){}try{e.startsWith("http")&&(e="10."+e.split("/10.")[1])}catch(e){}try{e.startsWith("doi ")&&(e=e.toLowerCase().replace("doi ",""))}catch(e){}try{e=e.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").split(" ")[0].split("&")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{e=e.split("#")[0]}catch(e){}try{e.startsWith("/")&&(e=e.replace(/^\/+/,""))}catch(e){}try{e.endsWith("/")&&(e=e.replace(/\/+$/,""))}catch(e){}try{e=e.replace(/#/g,"%23")}catch(e){}try{e=e.replace(/\,$/,"")}catch(e){}try{e=e.replace(/\.$/,"")}catch(e){}try{e.includes("(")||(e=e.replace(/\)$/,""))}catch(e){}if("string"==typeof e&&e.startsWith("10.")&&!e.includes("@"))return e},t.report.cleandoi._log=!1,v=[],t.report.publishers={_sheet:"1M2s1KBycWI5j7SIfIY0mzfkRC4cYr0HoROP7MR6k3GU"},t.report.orgs={_sheet:r.report.orgs_sheet,_format:async function(e=[],t){var i,r,s,n,l,a,o,u,c,p,d,h;for(u=[],s=0,l=(p="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<l;s++){for(r in o={},c=p[s]){if("string"==typeof c[r])if(c[r]=c[r].trim(),"true"===c[r].toLowerCase())c[r]=!0;else if("false"===c[r].toLowerCase())c[r]=!1;else if(c[r].startsWith("[")&&c[r].endsWith("]")||c[r].startsWith("{")&&c[r].endsWith("}"))try{c[r]=JSON.parse(c[r])}catch(e){i=e,D.log("cant parse "+r,c[r],i)}else c[r].includes(";")&&(c[r]=c[r].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(r.includes("."))try{this.dot(o,r,c[r])}catch(e){}else o[r]=c[r]}if(Array.isArray(o.sheets)){if(!1!==t)for(n=0,a=(d=o.sheets).length;n<a;n++)(h=d[n]).url=await this.encrypt(h.url)}else delete o.sheets;"{}"!==JSON.stringify(o)&&u.push(o)}return 1===u.length?u[0]:u}},t.report.orgs.orgkeys={_index:!0,_auth:"@oa.works"},t.report.orgs.key=async function(e){var t,i;if(null==e&&(e=this.params.org),null!=e){if(e=e.toLowerCase(),null==(i=await this.report.orgs.orgkeys('org.keyword:"'+e+'"',1))||this.refresh){if(null!=i){i.lastRefreshedAt=await this.epoch();try{i.lastRefreshedBy=this.user.email}catch(e){}}else{i={org:e,createdAt:await this.epoch()};try{i.createdBy=this.user.email}catch(e){}}return t=await this.uid(),i.key=await this.encrypt(t),await this.report.orgs.orgkeys(i),t}i.lastRetrievedAt=await this.epoch();try{i.lastRetrievedBy=this.user.email}catch(e){}return await this.report.orgs.orgkeys(i),this.decrypt(i.key)}},t.report.orgs.key._log=!1,t.report.orgs.key._auth="@oa.works",t.report.orgs.supplements={_index:!0,_auth:"@oa.works"},t.report.orgs.supplements.load=async function(e,t,i){var s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce;if(je=await this.epoch(),"report.orgs.supplements.load"===this.fn&&null==i&&(i=this.params.clear),i&&await this.report.orgs.supplements(""),null==e&&(e=this.params.org),null==t&&(t=this.params.sheet),T=await this.src.google.sheets(r.report.orgs_sheet),Ae=0,p=[],ge={},Oe=[],ke={},xe=[],!i)for await(Se of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements","replaced:*"))ge[Se.replaced]=Se.DOI;for(d=0,g=(q="object"!=typeof T||Array.isArray(T)?T:[T]).length;d<g;d++){for(l in S={},R=q[d]){if("string"==typeof R[l])if(R[l]=R[l].trim(),"true"===R[l].toLowerCase())R[l]=!0;else if("false"===R[l].toLowerCase())R[l]=!1;else if(R[l].startsWith("[")&&R[l].endsWith("]")||R[l].startsWith("{")&&R[l].endsWith("}"))try{R[l]=JSON.parse(R[l])}catch(e){}else R[l].includes(";")&&(R[l]=R[l].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(l.includes("."))try{await this.dot(S,l,R[l])}catch(e){}else S[l]=R[l]}if(Array.isArray(S.sheets))for(h=0,_=(V=S.sheets).length;h<_;h++)if(we=V[h],!(e&&S.name!==e||t&&we.name!==t)){if(D.log(S.name,we.name,we.url),P=0,I=[],o=[],ve=[],Ce=null==(ie=this.params.update)||ie,f=!1,Ie=[],await this.sleep(1e3),null==this.params.update)try{if(n=await this.src.google.sheets({sheetid:we.url,sheet:"m_admin",headers:!1}),await this.sleep(1e3),Array.isArray(n)&&n.length&&"last updated"===n[0][0].toLowerCase()&&(f=n[0][1])){if([y,O]=f.split(" "),y=y.split("/").reverse().join("-"),f=await this.epoch(y+"T"+O),D.log(S.name,we.name,"last updated",f),"number"==typeof f&&f>15778368e5){if(!(m=ke[we.name])){try{m=await this.report.orgs.supplements('sheets.keyword:"'+we.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=m&&null!=(pe=m.hits)?pe.hits:void 0)&&(m=m.hits.hits[0]._source,ke[we.name]=m)}(null!=m?m.updated:void 0)&&f<=m.updated&&(Ce=f)}}else if(Array.isArray(n)&&n.length){if(!(m=ke[we.name])){try{m=await this.report.orgs.supplements('sheets.keyword:"'+we.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=m&&null!=(de=m.hits)?de.hits:void 0)&&(m=m.hits.hits[0]._source,ke[we.name]=m)}(null!=m?m.updated:void 0)&&m.updated>=je-864e5&&(Ce=!1)}else Ce=!1}catch(e){Ce=!1}if(!0!==Ce)D.log(S.name,we.name,"NOT loading because",f,"is not after",Ce);else{await this.sleep(1e3);try{ve=await this.src.google.sheets({sheetid:we.url,sheet:"Export",headers:!1})}catch(e){}for(De=0;(!Array.isArray(ve)||!ve.length)&&De<5;){await this.sleep(5e3),De+=1;try{ve=await this.src.google.sheets({sheetid:we.url,sheet:"Export",headers:!1})}catch(e){}}if(Array.isArray(ve)&&ve.length){for(k=0,v=(he=ve.shift()).length;k<v;k++)a=he[k],o.push(a.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(j=0,b=ve.length;j<b;j++){for(u in _e=ve[j],P+=1,be={org:S.name,sheets:we.name,ror:S.ror,paid:!0===S.paid?S.paid:void 0},o)if("pmcid"===(l=o[u]).toLowerCase())be[l]=_e[u],be.pmcid="PMC"+_e[u].toLowerCase().replace("pmc","");else if("doi"===l||"DOI"===l)be[l]=_e[u];else{if(c="","apc_cost"===l||"wellcome.apc_paid_actual_currency_excluding_vat"===l||"wellcome.apc_paid_gbp_inc_vat_if_charged"===l||"wellcome.additional_publication_fees_gbp"===l||"wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp"===l||"wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp"===l||"wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"===l)try{c=parseFloat(_e[u])}catch(e){}else c="number"==typeof _e[u]?_e[u]:_e[u]?"true"===(fe=_e[u].trim().toLowerCase())||"yes"===fe||"false"!==(me=_e[u].trim().toLowerCase())&&"no"!==me&&("grant_id"===(ye=l.toLowerCase())||"ror"===ye?_e[u].replace(/\//g,",").replace(/ /g,"").split(","):_e[u]):void 0,"string"==typeof _e[u]&&_e[u].includes(";")&&(c=_e[u].split(";"));null!=c&&""!==c&&(l.includes(".")?await this.dot(be,l,c):be[l]=c)}be.doi?null==be.DOI&&(be.DOI=be.doi+""):be.doi=(null!=(W=be.DOI)?W:"")+"";try{be.DOI.startsWith("http")&&(be.DOI="10."+be.DOI.split("/10.")[1])}catch(e){}try{be.DOI.startsWith("doi ")&&(be.DOI=be.DOI.toLowerCase().replace("doi ",""))}catch(e){}try{be.DOI=be.DOI.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{be.DOI=be.DOI.split(",http")[0]}catch(e){}("string"==typeof be.DOI&&be.DOI.startsWith("10.")&&!be.DOI.includes("@")||be.openalex||be.pmcid)&&(!i&&be.DOI&&null!=ge[be.DOI]&&(be.replaced=be.DOI,be.DOI=ge[be.DOI]),"string"==typeof be.email&&be.email.includes("@")&&(be.email=await this.encrypt(be.email)),be.osdid=(S.name.replace(/[^a-zA-Z0-9-_ ]/g,"")+"_"+we.name+"_"+(null!=(U=null!=(M=be.DOI)?M:be.openalex)?U:be.pmcid)).replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),be._id=be.osdid,I.push(be.osdid),z=null!=(F=null!=(B=be.DOI)?B:be.openalex)?F:be.pmcid,L.call(p,z)<0&&p.push(null!=(J=null!=($=be.DOI)?$:be.openalex)?J:be.pmcid),be.updated=je,Ie.push(be),Ae+=1)}D.log(S.name,we.name,Ie.length,p.length),await this.report.orgs.supplements(Ie)}for await(Se of(await this.sleep(2e3),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'org.keyword:"'+S.name+'" AND sheets.keyword:"'+we.name+'"',{scroll:"30m",include:["osdid","DOI","openalex","pmcid"]})))X=Se.osdid,L.call(I,X)<0&&(await this.report.orgs.supplements(Se.osdid,""),G=null!=(H=null!=(Y=Se.DOI)?Y:Se.openalex)?H:Se.pmcid,L.call(p,G)<0&&p.push(null!=(Z=null!=(K=Se.DOI)?K:Se.openalex)?Z:Se.pmcid))}Oe.push({org:S.name,sheet:we.name,rows:P,update:Ce,supplements:Ie.length}),xe.push(we.name)}}if(!i&&!e&&!t)for(C=0,w=(Q=await this.report.works.suggest("supplements.sheets",void 0,5e3)).length;C<w;C++)if(s=Q[C],L.call(xe,s)<0){for await(Se of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'sheets.keyword:"'+s+'"',{scroll:"30m",include:["osdid"]}))await this.report.orgs.supplements(Se.osdid,"");for await(A of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",'supplements.sheets.keyword:"'+s+'"',{scroll:"30m",include:["DOI","openalex","pmcid"]}))(A.DOI&&(ee=A.DOI,L.call(p,ee)<0)||!A.DOI&&A.openalex&&(te=A.openalex,L.call(p,te)<0)||!A.DOI&&!A.openalex&&A.pmcid&&(re=A.pmcid,L.call(p,re)<0))&&p.push(null!=(se=null!=(ne=A.DOI)?ne:A.openalex)?se:A.pmcid)}if(i)for(E=0,x=(le=await this.report.works("orgs:* OR supplements.sheets:*",{include:["DOI","openalex","pmcid"]})).length;E<x;E++)((N=le[E]).DOI&&(ae=N.DOI,L.call(p,ae)<0)||!N.DOI&&N.openalex&&(oe=N.openalex,L.call(p,oe)<0)||!N.DOI&&!N.openalex&&N.pmcid&&(ue=N.pmcid,L.call(p,ue)<0))&&p.push(null!=(ce=N.DOI)?ce:N.openalex);return await this.sleep(6e4),D.log("report orgs supplements load",Ae,p.length,await this.epoch()-je),p.length&&(D.log("report orgs supplements load ready to call works load",p.length),await this.report.works.load(void 0,void 0,p,void 0,void 0,je,void 0,Oe)),Ae},t.report.orgs.supplements.load._bg=!0,t.report.orgs.supplements.load._async=!0,t.report.orgs.supplements.load._log=!1,t.report.orgs.queries=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;for await(n of(null==e&&(e=this.params.org),null==t&&(t=null!=(u=this.params.queries)?u:this.params.doi),g={},r=[],l=0,this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs",e?'name:"'+e+'"':"paid:true",{scroll:"30m"})))for(i in null!=(c=n.analysis)?c:[])if(null!=n.analysis[i].query&&(0==(p=!n.analysis[i].make_key)||"false"===p||"False"===p||"FALSE"===p))for await(o of(a=n.analysis[i].query,t&&(a="("+a+') AND  DOI.keyword:"'+t+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",a,{scroll:"30m"})))s=null==(d=n.analysis[i].value)||d,n.analysis[i].list&&(s=[s]),t?g[null!=(h=null!=(f=n.analysis[i].key)?f:n.analysis[i].name)?h:i]=s:(o[null!=(m=null!=(y=n.analysis[i].key)?y:n.analysis[i].name)?m:i]=s,r.push(o),l+=1,r.length>2e4&&(await this.report.works(r),r=[]));return r.length&&await this.report.works(r),t?g:l},t.report.orgs.queries._log=!1,t.report.orgs.queries._bg=!0,t.report.orgs.queries._async=!0,t.report.orgs.queries._auth="@oa.works",t.report.emails={_sheet:r.report.emails_sheet,_key:"doi",_auth:"@oa.works"},t.report.email=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h;if((e||this.params.orgkey)&&(null==e&&(e=null!=(l=this.params.email)?l:this.params.doi),null!=e&&(t=null!=(a=null!=(n=await this.report.works(e))?n.email:void 0)?a:null!=n&&null!=(o=n.outreach)?o.email_address:void 0))){if(t.includes("@"))return t;if(h=await this.encrypt(this.params.orgkey),"string"==typeof(null!=(s=await this.report.orgs.orgkeys('key.keyword:"'+h+'"',1))?s.org:void 0)&&s.org.length){for(p=[],i=0,r=(u=n.orgs).length;i<r;i++)d=u[i],p.push(d.toLowerCase());if(L.call(p,"gates foundation")>=0&&s.org.toLowerCase().includes("gates foundation"))return this.decrypt(t);if(c=s.org.toLowerCase(),L.call(p,c)>=0)return this.decrypt(t)}}},t.report.email._log=!1;try{t.oareport.email=t.report.email}catch(e){}t.report.works={_index:!0},t.report.works.process=async function(e,t,i,r,s,n,l){var a,o,p,m,y,g,_,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he,fe,me,ye,ge,_e,ve,be,we,xe,Oe,ke,je,Se,Ie,Ae,De,Ce,Le,Ne,Ee,Pe,Re,Te,qe,We,Ue,Me,ze,Fe,Be,Je,$e,Xe,Ve,Ge,He,Ye,Ze,Ke,Qe,et,tt,it,rt,st,nt,lt,at,ot,ut,ct,pt,dt,ht,ft,mt,yt,gt,_t,vt,bt,wt,xt,Ot,kt,jt,St,It,At,Dt,Ct,Lt,Nt,Et,Pt,Rt,Tt,qt,Wt,Ut,Mt,zt,Ft,Bt,Jt,$t,Xt,Vt,Gt,Ht,Yt,Zt,Kt,Qt,ei,ti,ii,ri,si,ni,li,ai,oi,ui,ci,pi,di,hi,fi,mi,yi,gi,_i,vi,bi,wi,xi,Oi,ki,ji,Si,Ii,Ai,Di,Ci,Li,Ni,Ei,Pi,Ri,Ti,qi,Wi,Ui,Mi,zi,Fi,Bi,Ji,$i,Xi,Vi,Gi;try{if(Ri=await this.epoch(),null==e&&(e=this.params.process),W=!1,0===i&&(i=!0),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),Ve={},"string"==typeof e&&e.toLowerCase().startsWith("pmc")&&(W=e.toLowerCase().replace("pmc","PMC"),e=void 0,null==t&&(t=await this.src.openalex.works('ids.pmcid:"'+W.toLowerCase().replace("pmc","")+'"',1)),null==t&&(E=await this.src.epmc.pmc(W,i))&&(e=E.doi)),!t&&e&&(e.includes("openalex.org/")||e.startsWith("W"))&&(e.includes("openalex.org/")&&(e=e.split("openalex.org/")[1]),t=e,e=void 0),"string"==typeof t&&((t=(t=t.split(t.includes("doi.org")?"doi.org/":"/").pop()).replace(/\/$/,"")).startsWith("10.")&&(t=t.toLowerCase(),null==e&&(e=t)),t.startsWith("W")||t.startsWith("10.")))try{Ce=t.startsWith("W")?await this.src.openalex.works('id.keyword:"https://openalex.org/'+t+'"'):await this.src.openalex.works.doi(t,null!=(Ge=this.params.refresh_sources)&&Ge);try{(null!=Ce&&null!=(He=Ce.hits)&&null!=(lt=He.hits)?lt.length:void 0)&&(Ce=Ce.hits.hits[0]._source)}catch(e){}(null!=Ce?Ce.id:void 0)&&(t=Ce)}catch(e){}if(("object"==typeof t&&(null!=(yt=t.ids)?yt.doi:void 0)||"string"==typeof t&&t.startsWith("10."))&&(Ei=("string"==typeof t?t:t.ids.doi.split(".org/")[1]).toLowerCase(),(null!=(R=await this.report.works(Ei))?R.DOI:void 0)&&R.DOI.toLowerCase()!==Ei&&(R=void 0),((null!=R?R.updated:void 0)||i&&!0!==i&&R&&R.updated<i)&&(i=!0)),"string"!=typeof t||t.startsWith("W")||t.startsWith("10.")||(t=void 0),null==e&&"object"==typeof t&&(null!=t&&null!=(It=t.ids)?It.doi:void 0)&&(e=t.ids.doi),"string"==typeof e&&e.includes("doi.org/")&&(e=e.split("doi.org/").pop()),"string"!=typeof e||e.startsWith("10.")||(e=void 0),"string"==typeof e&&(e=e.toLowerCase()),"string"==typeof e&&(Xi=await this.src.crossref.works.doi(e,null!=(qt=this.params.refresh_sources)&&qt))&&(e=Xi),"object"!=typeof e||e.DOI||(e=void 0),null!=e&&null==R&&(R=await this.report.works("string"==typeof e?e:e.DOI)),(null!=R?R.DOI:void 0)&&R.DOI.toLowerCase()!==("string"==typeof e?e:"object"==typeof e&&e.DOI?e.DOI:"").toLowerCase()&&(R=void 0),!0!==i&&(null==R||r||(null!=R.PMCID&&"PMC"!==R.PMCID&&(Ve.PMCID=R.PMCID),null!=R.pubtype&&(Ve.pubtype=R.pubtype),null!=R.tried_epmc_licence&&(Ve.tried_epmc_licence=R.tried_epmc_licence),null!=R.epmc_licence&&(Ve.epmc_licence=R.epmc_licence),R.pmc_has_data_availability_statement&&(Ve.pmc_has_data_availability_statement=R.pmc_has_data_availability_statement),null!=R.data_availability_statement&&(Ve.data_availability_statement=R.data_availability_statement),null!=R.data_availability_url&&(Ve.data_availability_url=R.data_availability_url),null!=R.data_availability_doi&&(Ve.data_availability_doi=R.data_availability_doi)),(!(null!=R?R.updated:void 0)||i&&!0!==i&&R&&R.updated<i)&&(i=!0)),null!=e&&null==t&&(t=await this.src.openalex.works.doi("object"==typeof e?e.DOI:e,null!=(Gt=this.params.refresh_sources)&&Gt)),"string"!=typeof t&&(null!=t?t.id:void 0)||(t=void 0),"object"==typeof e&&e.DOI){for((null!=R?R.updated:void 0)&&(null!=(ni=e.indexed)?ni.timestamp:void 0)&&R.updated<e.indexed.timestamp&&(i=!0),Ve.DOI=e.DOI.toLowerCase(),Ve.published_year=e.year,Ve.published_date=e.published,Ve.issn=e.ISSN,M=0,V=(yi=["subject","subtitle","volume","issue","publisher","funder","subtype","assertion","relation"]).length;M<V;M++)Ve[S=yi[M]]=e[S];for(Ye=null!=(Si=e.assertion)?Si:[],J=0,G=Ye.length;J<G;J++)(y=(null!=(Ze=(m=Ye[J]).label)?Ze:"").toLowerCase()).includes("accepted")&&y.split(" ").length<3&&(null!=(p=await this.dateparts(m.value))?p.date:void 0)&&(p.timestamp?null==Ve.accepted_date&&(Ve.accepted_date=p.date):null==Ve.bad_accepted_date&&(Ve.bad_accepted_date="bad date "+p.date)),y.includes("received")&&(null!=(Ni=await this.dateparts(m.value))?Ni.date:void 0)&&(Ni.timestamp?null==Ve.submitted_date&&(Ve.submitted_date=Ni.date):null==Ve.bad_submitted_date&&(Ve.bad_submitted_date="bad date "+Ni.date));for(Qe=null!=(Ke=Ve.funder)?Ke:[],xe=0,ne=Qe.length;xe<ne;xe++)delete(T=Qe[xe])["doi-asserted-by"];for(e.title&&"string"!=typeof e.title&&e.title.length&&(Ve.title=e.title[0]),e["container-title"]&&e["container-title"].length&&(Ve.journal=e["container-title"][0]),null!=e["reference-count"]&&(Ve["reference-count"]=e["reference-count"]),tt=null!=(et=e.license)?et:[],je=0,de=tt.length;je<de;je++)"am"!==(it=(X=tt[je])["content-version"])&&"vor"!==it&&"tdm"!==it&&"unspecified"!==it||(Ve["crossref_license_url_"+X["content-version"]]=X.URL,(!Ve.publisher_license_crossref||Ve.publisher_license_crossref.length<X.URL.length)&&(Ve.publisher_license_crossref=X.URL));for(Ve.crossref_is_oa=null!=e.is_oa&&e.is_oa,x=[],a=async(t,i)=>(t.DOI=e.DOI,t.replaced=i,await this.report.orgs.supplements(t.osdid,""),t._id=t.osdid=t.osdid.split("_10.")[0]+"_"+t.DOI.replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),x.push(t)),st=null!=(rt=e["update-to"])?rt:[],Le=0,he=st.length;Le<he;Le++)if((Mi=st[Le]).DOI!==e.DOI&&Mi.type&&"erratum"!==(nt=Mi.type.toLowerCase())&&"correction"!==nt)for await(Ti of(Ve.replaces=[],Ve.replaces.push({DOI:Mi.DOI,type:Mi.type,updated:null!=(at=Mi.updated)?at.timestamp:void 0}),await this.report.works(Mi.DOI)&&await this.report.works(Mi.DOI,""),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+Mi.DOI+'"')))a(Ti,Mi.DOI);x.length&&await this.report.orgs.supplements(x),n&&(null==Ve.replaces&&(Ve.replaces=[]),Ve.replaces.push({DOI:n,type:"relation"}))}if(null!=t){try{(null!=R?R.updated:void 0)&&!t.is_paratext&&!t.is_retracted&&t.updated_date&&R.updated<await this.epoch(t.updated_date)&&(i=!0)}catch(e){}for(Ve.openalx=JSON.parse(JSON.stringify(t)),Je=0,fe=(ot=["topics","primary_topic","keywords","concepts","domains","fields","subfields"]).length;Je<fe;Je++)I=ot[Je],delete Ve.openalx[I];for(Ve.publisher_license_v2=null!=(ut=Ve.openalx.primary_location)?ut.license:void 0,pt=null!=(ct=Ve.openalx.locations)?ct:[],Wi=0,me=pt.length;Wi<me;Wi++)(be=pt[Wi]).license&&(!Ve.publisher_license_v2||be.license.length<Ve.publisher_license_v2)&&"journal"===(null!=(dt=be.source)?dt.type:void 0)&&(Ve.publisher_license_v2=be.license),be.license&&(!Ve.repository_license_v2||be.license.length<Ve.repository_license_v2)&&"repository"===(null!=(ht=be.source)?ht.type:void 0)&&(Ve.repository_license_v2=be.license);for(t.id&&(Ve.openalex=t.id.split("/").pop()),Ve.DOI||null==(null!=(ft=t.ids)?ft.doi:void 0)||(Ve.DOI=t.ids.doi.split("doi.org/").pop().toLowerCase()),(null!=(mt=t.ids)?mt.pmid:void 0)&&(Ve.PMID=t.ids.pmid.split("/").pop()),!Ve.PMCID&&(null!=(gt=t.ids)?gt.pmcid:void 0)&&(Ve.PMCID="PMC"+t.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),t.title&&(Ve.title=t.title),Fi=0,ye=(_t=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;Fi<ye;Fi++)Ve[De=_t[Fi]]=t[De];for(t.publication_date&&(Ve.published_date=t.publication_date),t.publication_year&&(Ve.published_year=t.publication_year),(null!=(vt=t.host_venue)?vt.issn:void 0)&&t.host_venue.issn.length&&(Ve.issn=t.host_venue.issn),t.biblio&&(Ve.biblio=t.biblio),t.referenced_works&&(Ve.referenced_works=t.referenced_works.length),wt=null!=(bt=Ve.concepts)?bt:[],Ji=0,ge=wt.length;Ji<ge;Ji++){delete(O=wt[Ji]).wikidata;try{O.score=Math.floor(100*O.score)}catch(e){}}for(Ot=null!=(xt=Ve.authorships)?xt:[],$i=0,_e=Ot.length;$i<_e;$i++){for(jt=null!=(kt=(o=Ot[$i]).institutions)?kt:[],Vi=0,H=jt.length;Vi<H;Vi++)delete jt[Vi].type;(null!=(St=o.author)?St.orcid:void 0)&&o.author.orcid.includes("orcid.org/")&&(o.author.orcid_number=o.author.orcid.split("/").pop())}}if(Ve.DOI||"string"!=typeof e||(Ve.DOI=e.toLowerCase()),W&&!Ve.PMCID&&(Ve.PMCID=W),Ve.DOI){for(Ae=await this.src.oadoi.doi(Ve.DOI,24192e5),Ve.oadoi=null!=Ae,Dt=null!=(At=null!=Ae?Ae.oa_locations:void 0)?At:[],Gi=0,Y=Dt.length;Gi<Y;Gi++)if("publisher"===(we=Dt[Gi]).host_type&&(null==Ve.publisher_license&&(Ve.publisher_license=we.license),null==Ve.publisher_url_for_pdf&&(Ve.publisher_url_for_pdf=we.url_for_pdf),null==Ve.publisher_version&&(Ve.publisher_version=we.version)),"repository"===we.host_type&&(we.url&&we.url.toLowerCase().includes("pmc")&&(Ve.PMCID||(We=we.url.toLowerCase().split("pmc").pop().split("articles/").pop().split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(We))&&(Ve.PMCID="PMC"+We),we.license&&!Ve.epmc_licence&&(Ve.epmc_licence=we.license)),!Ve.repository_url||!Ve.repository_url.includes("pmc")||!Ve.repository_url.includes("ncbi.")&&we.url.includes("ncbi.")))for(U=0,Z=(Ct=["license","url_for_pdf","url","version"]).length;U<Z;U++)we[De=Ct[U]]&&(Ve["repository_"+De]=we[De]);Ve.repository_url&&(Ve.repository_url.toLowerCase().includes("europepmc.")||Ve.repository_url.toLowerCase().includes("ncbi."))&&(null==Ve.PMCID&&(Ve.PMCID="PMC"+Ve.repository_url.toLowerCase().split("pmc").pop().split("articles/").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),Ve.repository_url_in_pmc=!0),null!=Ae&&(Ve.best_oa_location_url=null!=(Lt=Ae.best_oa_location)?Lt.url:void 0,Ve.best_oa_location_url_for_pdf=null!=(Nt=Ae.best_oa_location)?Nt.url_for_pdf:void 0,Ve.oa_status=Ae.oa_status,Ve.has_repository_copy=Ae.has_repository_copy,Ve.has_oa_locations_embargoed=!(null==Ae.oa_locations_embargoed||!Ae.oa_locations_embargoed.length),Ve.title=Ae.title,!Ve.issn&&"string"==typeof Ae.journal_issns&&Ae.journal_issns.length&&(Ve.issn=Ae.journal_issns.split(",")),null==Ve.journal&&(Ve.journal=Ae.journal_name),null==Ve.publisher&&(Ve.publisher=Ae.publisher),Ae.published_date&&(Ve.published_date=Ae.published_date),Ae.year&&(Ve.published_year=Ae.year),null!=Ae.is_oa&&(Ve.oadoi_is_oa=Ae.is_oa))}if(j=[],Ve.supplements=[],Ve.orgs=[],ke=void 0,Ve.DOI||Ve.openalex||Ve.PMCID)for await(Ti of(Pi="",Ve.DOI&&(Pi+='DOI.keyword:"'+Ve.DOI+'"'),Ve.openalex&&(Pi+=(Pi?" OR ":"")+'openalex.keyword:"'+Ve.openalex+'"'),Ve.PMCID&&(Pi+=(Pi?" OR ":"")+'pmcid.keyword:"'+Ve.PMCID+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",Pi,{sort:{"osdid.keyword":"asc"}}))){if(Et=Ti.org,L.call(Ve.orgs,Et)<0&&Ve.orgs.push(Ti.org),Ti.paid&&(Ve.paid=!0),!Ve.email&&Ti.email&&(Ve.email=Ti.email),Ti.author_email_name_ic&&(Ve.author_email_name=Ti.author_email_name_ic),null!=Ti.mturk_has_data_availability_statement&&(ke=Ti.mturk_has_data_availability_statement),Ti.corresponding_author_ids)for(Pt="string"==typeof Ti.corresponding_author_ids?Ti.corresponding_author_ids.split(","):Ti.corresponding_author_ids,z=0,K=Pt.length;z<K;z++)k=Pt[z],L.call(j,k)<0&&j.push(k);Ve.supplements.push(Ti)}for(Wt=null!=(Rt=null!=(Tt=Ve.openalx)?Tt.corresponding_author_ids:void 0)?Rt:[],B=0,Q=Wt.length;B<Q;B++)k=Wt[B],L.call(j,k)<0&&j.push(k);for(Ve.corresponding_authors=[],zt=null!=(Ut=null!=(Mt=Ve.openalx)?Mt.authorships:void 0)?Ut:[],$=0,ee=zt.length;$<ee;$++)Ft=null!=(Bt=(g=zt[$]).author)?Bt.id:void 0,L.call(j,Ft)>=0&&Ve.corresponding_authors.push(g);if(null!=(null!=(Jt=Ve.openalx)?Jt.authorships:void 0)&&null==Ve.openalx.authors_count&&(Ve.openalx.authors_count=Ve.openalx.authorships.length),null!=R){if(null==i)for(F in!Ve.author_email_name&&R.author_email_name&&R.email&&Ve.email&&Ve.email.toLowerCase()===R.email.toLowerCase()&&(Ve.author_email_name=R.author_email_name),R)"orgs_by_query"!==F&&"PMCID"!==F&&null==Ve[F]&&(Ve[F]=R[F]);Ve.PMCID&&"PMC"!==Ve.PMCID||null==R.PMCID||"PMC"===R.PMCID||(Ve.PMCID=R.PMCID)}if(null!=Ve.authorships&&Ve.email&&!Ve.author_email_name&&(i||null==(null!=R?R.authorships:void 0)||!(null!=R?R.email:void 0)))if(N=Ve.email.includes("@")?Ve.email:await this.decrypt(Ve.email),1===Ve.authorships.length)Ve.author_email_name="Dr. "+(null!=($t=Ve.authorships[0].author)?$t.display_name:void 0);else{for(Ii=N.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),_="",b="",w=1e6,Xt=Ve.authorships,Oe=0,te=Xt.length;Oe<te;Oe++)(Xe=null!=(Vt=Xt[Oe].author)?Vt.display_name:void 0)&&((Li=(await this.levenshtein(Ii,Xe.toLowerCase().replace(/[^a-z]/g,""))).distance/Xe.length)<w&&(w=Li,b=Xe),w>.2&&(Ii.endsWith(Xe.split(" ").pop().toLowerCase())||Xe.split(" ")[0].length>4&&Ii.includes(Xe.split(" ")[0].toLowerCase()))&&(w=.1,b=Xe),!_&&Ii.startsWith((Xe.split(" ")[0].slice(0,1)+Xe.split(" ").pop().slice(0,1)).toLowerCase())&&(_=Xe));b&&w<.7&&(Ve.author_email_name="Dr. "+b.split(" ").pop()),!Ve.author_email_name&&_&&(Ve.author_email_name="Dr. "+_)}if("string"==typeof Ve.email&&Ve.email.includes("@")&&(Ve.email=await this.encrypt(Ve.email)),Ve.publisher&&(null!=i||!Ve.publisher_simple)){if(!v.length)for(Di=await this.report.publishers("*",1e4),Array.isArray(Di)||null==(null!=Di&&null!=(Ht=Di.hits)?Ht.hits:void 0)||(Di=Di.hits.hits),Se=0,ie=(Yt=null!=Di?Di:[]).length;Se<ie;Se++)Ai=Yt[Se],v.push(null!=(Zt=Ai._source)?Zt:Ai);for(ze=Ve.publisher.toLowerCase(),Ie=0,re=v.length;Ie<re;Ie++)if((Me=v[Ie]).publisher&&ze.includes(Me.publisher.toLowerCase())){Ve.publisher_simple=Me.publisher_display_name;break}}for(Ve.PMCID&&Ve.PMID&&null!=Ve.pubtype&&Ve.submitted_date&&Ve.accepted_date||(Fe=Ve.PMID?await this.src.pubmed(Ve.PMID):Ve.DOI?await this.src.pubmed.doi(Ve.DOI):void 0)&&(!Ve.PMCID&&(null!=Fe&&null!=(Kt=Fe.identifier)?Kt.pmc:void 0)&&(Ve.PMCID="PMC"+Fe.identifier.pmc.toLowerCase().replace("pmc","")),!Ve.PMID&&(null!=Fe&&null!=(Qt=Fe.identifier)?Qt.pubmed:void 0)&&(Ve.PMID=Fe.identifier.pubmed),Ve.pubtype=Fe.type,null==Ve.submitted_date&&(Ve.submitted_date=null!=(ei=Fe.dates)&&null!=(ti=ei.PubMedPubDate_received)?ti.date:void 0),null==Ve.accepted_date&&(Ve.accepted_date=null!=(ii=Fe.dates)&&null!=(ri=ii.PubMedPubDate_accepted)?ri.date:void 0)),Ve.DOI&&!Ve.journal_oa_type&&(Ee=await this.permissions(await this.copy(Ve),void 0,void 0,Ae,e,Ri-12096e5),Ve.can_archive=null!=Ee&&null!=(si=Ee.best_permission)?si.can_archive:void 0,null==Ve.can_archive&&((null!=(li=null!=Ae&&null!=(ai=Ae.best_oa_location)?ai.license:void 0)?li:"").includes("cc")||(null!=Ae?Ae.journal_is_in_doaj:void 0))&&(Ve.can_archive=!0),Ve.version=null!=Ee&&null!=(oi=Ee.best_permission)?oi.version:void 0,Ve.journal_oa_type=await this.permissions.journals.oa.type(Ve.issn,void 0,Ae,e),null==Ve.journal_oa_type&&(Ve.journal_oa_type="unsuccessful")),ci=null!=(ui=Ve.orgs)?ui:[],Ne=0,se=ci.length;Ne<se;Ne++)if("fwf austrian science fund"!==(Te=(Re=ci[Ne]).toLowerCase().trim())&&"dutch research council"!==Te&&"national science center"!==Te&&"uk research and innovation"!==Te&&"agencia nacional de investigación y desarrollo"!==Te&&"national natural science foundation of china"!==Te&&"research foundation - flanders"!==Te&&"ministry of business, innovation and employment"!==Te&&"german research foundation"!==Te&&"national cancer institute"!==Te)r=!0;else if(Ve.funder)try{if(Te=Te.replace(/[^a-z ]/g,""),null==f[Te]&&(f[Te]=await this.report.orgs('name.keyword:"'+Re+'"',1)),null!=(pi=f[Te])?pi.country_code:void 0)for(di=Ve.funder,Be=0,le=di.length;Be<le;Be++){if((T=di[Be]).DOI&&f[Te].fundref)for(hi="string"==typeof f[Te].fundref?[f[Te].fundref]:f[Te].fundref,$e=0,ae=hi.length;$e<ae;$e++)if(qe=hi[$e],T.DOI.includes(qe)){T.country=f[Te].country_code;break}if(!T.country&&T.name){if(((q=T.name.toLowerCase().replace(/[^a-z ]/g,"")).includes(Te)||Te.includes(q)||(null!=(fi=f[Te].aliases)?fi:[]).join("").toLowerCase().replace(/[^a-z ]/g,"").includes(q)||(null!=(mi=f[Te].acronyms)?mi:"").toLowerCase().includes(q))&&(T.country=f[Te].country_code),!T.country&&f[Te].acronyms)for(gi=f[Te].acronyms.split(","),Ci=0,oe=gi.length;Ci<oe;Ci++)_i=gi[Ci].replace(/[^a-z A-Z]/g,""),L.call(T.name.split(" "),_i)>=0&&(T.country=f[Te].country_code);if(!T.country&&f[Te].aliases)for(vi=f[Te].aliases,qi=0,ue=vi.length;qi<ue;qi++)Pe=vi[qi],q.includes(Pe.toLowerCase().replace(/[^a-z ]/g,""))&&(T.country=f[Te].country_code)}}}catch(e){}if((Ve.DOI||Ve.PMCID)&&(null!=E||!Ve.PMCID||null==Ve.pubtype)&&(null!=E||r&&(E=Ve.PMCID?await this.src.epmc.pmc(Ve.PMCID,i):await this.src.epmc.doi(Ve.DOI,i))))for(!Ve.PMCID&&E.pmcid&&(Ve.PMCID=E.pmcid),xi=null!=(bi=null!=(wi=E.pubTypeList)?wi.pubType:void 0)?bi:[],Ui=0,ce=xi.length;Ui<ce;Ui++)Ue=xi[Ui],null==Ve.pubtype&&(Ve.pubtype=[]),L.call(Ve.pubtype,Ue)<0&&Ve.pubtype.push(Ue);if(!r&&null==E||!Ve.PMCID||Ve.epmc_licence||!i&&Ve.tried_epmc_licence||(Ve.tried_epmc_licence=!0,ve=await this.src.epmc.licence(Ve.PMCID,E,void 0,i),Ve.epmc_licence=null!=ve?ve.licence:void 0),Ve.pmc_has_data_availability_statement||(Ve.pmc_has_data_availability_statement=Ve.PMCID&&await this.src.pubmed.availability(Ve.PMCID)),r&&Ve.PMCID&&(i||!Ve.data_availability_statement||!Ve.submitted_date)){if(Ve.data_availability_statement=await this.src.epmc.statement(Ve.PMCID,E,i),Ve.data_availability_statement&&(zi=await this.src.epmc.statement.url(Ve.PMCID,E,Ve.data_availability_statement)))for(Bi=0,pe=zi.length;Bi<pe;Bi++)(A=zi[Bi]).includes("doi.org/")?(C=A.split("doi.org/")[1].toLowerCase(),null==Ve.data_availability_doi&&(Ve.data_availability_doi=[]),L.call(Ve.data_availability_doi,C)<0&&Ve.data_availability_doi.push(C)):(null==Ve.data_availability_url&&(Ve.data_availability_url=[]),L.call(Ve.data_availability_url,A)<0&&Ve.data_availability_url.push(A));null==Ve.submitted_date&&(Ve.submitted_date=await this.src.epmc.submitted(Ve.PMCID,E))}return(Ve.PMCID||(null!=(Oi=Ve.openalx)&&null!=(ki=Oi.open_access)?ki.any_repository_has_fulltext:void 0))&&(Ve.has_repository_copy=!0),Ve.is_oa=Ve.oadoi_is_oa||Ve.crossref_is_oa||"gold"===Ve.journal_oa_type,Ve.has_data_availability_statement=!!(Ve.pmc_has_data_availability_statement||ke||Ve.DOI&&(Ve.DOI.startsWith("10.1186")||Ve.DOI.startsWith("10.12688")||Ve.DOI.startsWith("10.1371")))||(null!=(ji=Ve.pmc_has_data_availability_statement)?ji:ke),null==Ve._id&&(Ve._id=Ve.DOI?Ve.DOI.toLowerCase().replace(/\//g,"_"):Ve.openalex?Ve.openalex.toLowerCase():Ve.PMCID?Ve.PMCID.toLowerCase():void 0),Ve.supplemented=await this.epoch(),Ve.updated=Ve.supplemented,Ve.took=Ve.supplemented-Ri,Ve.supplemented_date=await this.datetime(Ve.supplemented),Ve.updated_date=await this.datetime(Ve.updated),this.params.process&&!1!==this.params.save&&(Ve.DOI&&Ve.DOI.toLowerCase()===this.params.process.toLowerCase()||Ve.openalex&&Ve.openalex.toLowerCase()===this.params.process.toLowerCase()||Ve.PMCID&&Ve.PMCID.toLowerCase()===this.params.process.toLowerCase())?await this.report.works(Ve):l&&(u.push(l.toLowerCase()),null!=Ve._id&&c.push(Ve),h.splice(h.indexOf(l),1)),Ve}catch(t){P=t,D.log("report works process error",P,"object"==typeof e?e.DOI:e),l&&(await this.sleep(3e3),h.splice(h.indexOf(l),1),null==d[l]&&(d[l]=0),d[l]+=1,4!==d[l]?this.report.queue(l,void 0,i,r,s):delete d[l])}},t.report.works.process._log=!1,t.report.works.load=async function(e,t,i,r,s,n,l,a){var o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,L,N,E,P,R,T;if(L=await this.epoch(),null==r&&(r=null!=(m=this.params.load)?m:(await this.date()).split("-")[0]),null==t&&(t=null!=(y=null!=(O=this.params.org)?O:this.params.orgs)?y:"orgs"===this.params.load),null==i&&"string"==typeof this.params.load&&(this.params.load.startsWith("10.")||this.params.load.toLowerCase().startsWith("pmc")||this.params.load.toLowerCase().startsWith("w"))&&(i=this.params.load),"string"==typeof i&&(i=[i]),this.fn.startsWith("report.works.load")&&null==s&&(s=this.params.clear),C=this.refresh,null==l&&(l=null!=(k=this.params.everything)?k:"everything"===this.params.load),T=0,this.params.q){for await(E of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",this.params.q,{scroll:"5m",include:["DOI","openalex","PMCID"]})))i.push(null!=(j=null!=(S=E.DOI)?S:E.openalex)?j:E.PMCID),i.length%1e3==0&&D.log("report works preparing to load from query",i.length);D.log("report works supplements to load from query",this.params.q)}else if("supplements"===this.params.load){for await(N of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",e?"updated:<"+e:t?'org:"'+t+'"':void 0,{scroll:"5m",include:["DOI","openalex","pmcid"]})))i.push(null!=(I=null!=(A=N.DOI)?A:N.openalex)?I:N.pmcid);D.log("report works supplements to load",e,t,i.length)}else if(l){for await(N of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","NOT pmc_has_data_availability_statement:*",{scroll:"5m",include:["DOI","openalex","PMCID"]})))i.push(null!=(g=null!=(_=N.DOI)?_:N.openalex)?g:N.PMCID);D.log("report works supplements to load everything for records that do not yet have everything",i.length)}if(Array.isArray(i))D.log("report works queueing identifiers batch",i.length),await this.report.queue(i,void 0,null!=e?e:C,l),T+=i.length;else{for await(f of(o=async(i,s)=>{var n,a,o;for await(n of(null==i&&(i="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+r),e&&(i="("+i+") AND srcday:>"+e),a=await this.src.crossref.works.count(i),D.log("report works load crossref by query expects",i,a),o=[],this.index._for("src_crossref_works",i,{include:["DOI"],scroll:"30m"})))t||r!==this.params.load||!await this.report.works(n.DOI)?(T+=1,o.push(await this.report.queue(n.DOI,void 0,null!=e?e:C,l,s))):o.push(void 0);return o},!0!==t&&r===this.params.load&&await o(void 0,"years"),u=async(i,s)=>{var n,a,o,u,c;for await(n of(null==i&&(i="authorships.institutions.display_name:* AND publication_year:"+r),e&&(i="("+i+") AND updated_date:>"+e),o=await this.src.openalex.works.count(i),D.log("report works load openalex by query expects",i,o),c=[],this.index._for("src_openalex_works",i,{include:["id","ids"],scroll:"30m"})))(a=(null!=(u=n.ids)?u.doi:void 0)?"10."+n.ids.doi.split("/10.")[1]:n.id.split("openalex.org/").pop())?!t&&r===this.params.load&&a.startsWith("10.")&&await this.report.works(a)?c.push(void 0):(T+=1,c.push(await this.report.queue(a,void 0,null!=e?e:C,l,s))):c.push(void 0);return c},!0!==t&&r===this.params.load&&await u(void 0,"years"),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs","string"==typeof t?'name:"'+t+'"':"paid:true",{scroll:"10m"}))){if(null!=(v=f.source)?v.crossref:void 0){try{f.source.crossref.includes("%")&&(f.source.crossref=decodeURIComponent(decodeURIComponent(f.source.crossref)))}catch(e){}D.log("report works load crossref by org",f.name,f.source.crossref),await o(f.source.crossref)}if(null!=(b=f.source)?b.openalex:void 0){try{f.source.openalex.includes("%")&&(f.source.openalex=decodeURIComponent(decodeURIComponent(f.source.openalex)))}catch(e){}D.log("report works load openalex by org",f.name,f.source.openalex),await u(f.source.openalex)}}if(e)for await(c of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs:* AND updated:<"+e,{scroll:"10m"}))await this.src.crossref.works.count('DOI.keyword:"'+c.DOI+'" AND srcday:>'+e)&&await this.report.queue(c.DOI,void 0,null!=e?e:C,l)}for(R=await this.epoch()-L,P="Report works queued "+T+(this.S.dev?" (dev)":"")+"\n",i&&i.length&&(P+=i.length+" identifiers were provided to process\n"),this.params.q&&(P+="These were derived by searching for provided query"+JSON.stringify(this.params.q)+"\n"),"supplements"===this.params.load&&(P+="These were derived by searching for all works that already have supplements attached\n"),l&&!this.params.q&&(P+="These were derived by searching for all works that have not yet had everything fully processed\n"),n&&(P+="These were provided by an orgs supplements refresh which took "+Math.ceil((L-n)/1e3/60)+"m\n"),"string"==typeof t&&(P+="The load process was "+(this.params.q?"matched":"limited")+" to "+t+"\n"),e&&(P+="The load process was run for changes since "+await this.datetime(e)+"\n"),!r||"string"==typeof t||!this.params.load&&e||(null!=i?i:[]).length||(P+="The load process was run for year "+r+"\n"),d=0,h=(w=null!=a?a:[]).length;d<h;d++)p=w[d],P+="\n"+JSON.stringify(p)+"\n";return D.log("Report works loaded",T,R),await this.mail({to:null!=(x=this.S.log)?x.logs:void 0,subject:"Report works loaded "+T,text:P}),T},t.report.works.load._log=!1,t.report.works.load._bg=!0,t.report.works.load._async=!0,t.report.works.load._auth="@oa.works",t.report.works.load.mains=async function(){var e,t,i,r;for(e=0,t=(r=this.params.orgs?this.params.orgs.split(","):["Gates Foundation","Robert Wood Johnson Foundation","Howard Hughes Medical Institute","Templeton World Charity Foundation","Michael J. Fox Foundation","Parkinson’s Progression Markers Initiative"]).length;e<t;e++)i=r[e],await this.report.works.load(void 0,i);return!0},t.report.works.load.mains._log=!1,t.report.works.load.mains._bg=!0,t.report.works.load.mains._async=!0,t.report.works.load.mains._auth="@oa.works",t.report.works.changes=function(e,t){var i,r;return null==e&&(e=null!=(i=null!=(r=this.params.changes)?r:this.params.timestamp)?i:Date.now()-9e7),null==t&&(t=this.params.org),this.report.works.load(e,t),!0},t.report.works.changes._log=!1,t.report.works.changes._bg=!0,t.report.works.changes._async=!0,t.report.works.changes._auth="@oa.works",t.report.rs={_index:!0},t.report.fixoatype=async function(){var e,t,i,r,s,n,l,a,o,u,c,p;for await(a of(r=0,t=0,n=0,s={},p={},e=[],l='journal_oa_type.keyword:"closed" AND issn:* AND orgs:*',i=await this.report.works.count(l),D.log("check oa type expecting",i),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",l,{scroll:"30m"})))t+=1,a.issn||(n+=1),t%100==0&&D.log("check oa type checked",t,r,n),a.issn&&s[a.issn[0]]?"closed"!==(o=s[a.issn[0]])&&"unknown"!==o&&(p[s[a.issn[0]]]+=1,r+=1,a.journal_oa_type=s[a.issn[0]],e.push(a)):(a.issn||a.DOI)&&(c=await this.permissions.journals.oa.type(null!=(u=a.issn)?u:a.DOI))&&(a.issn&&(s[a.issn[0]]=c),c&&"closed"!==c&&"unknown"!==c&&(null==p[c]&&(p[c]=0),p[c]+=1,r+=1,a.journal_oa_type=c,e.push(a))),e.length>=2e4&&(await this.report.works(e),e=[]);e.length&&await this.report.works(e),D.log("check oa type completed with",t,r,n,i),D.log(p);try{D.log(Object.keys(s).length)}catch(e){}return r},t.report.fixoatype._bg=!0,t.report.fixoatype._async=!0,t.report.fixoatype._auth="@oa.works",L=[].indexOf,null==t.svc&&(t.svc={}),t.svc.rscvd={_index:!0},t.svc.rscvd.form=async function(){var e,t,i,r,s,n,l,a;if(this.keys(this.params).length>1){delete(t=this.copy(this.params)).form,t.status="Awaiting verification";try{(l=await this.svc.rscvd.requestees('email:"'+t.email+'"'))&&((null!=l?l.verified:void 0)||"Approved"===(null!=l?l.verification:void 0)?(t.status="Verified",t.verified=!0):((null!=l?l.denied:void 0)||"Denied"===(null!=l?l.verification:void 0))&&(t.status="Denied",t.verified=!1))}catch(e){}if("Awaiting verification"===t.status)try{(null!=(e=await this.svc.rscvd('email:"'+t.email+'" AND verified:*'))&&null!=(i=e.hits)?i.hits:void 0)&&!0===e.hits.hits[0]._source.verified?(t.status="Verified",t.verified=!0):!1===e.hits.hits[0]._source.verified&&(t.status="Denied",t.verified=!1)}catch(e){}null==t.type&&(t.type="paper");try{t.createdAt=new Date}catch(e){}try{t.neededAt=await this.epoch(t["needed-by"])}catch(e){}t._id=await this.svc.rscvd(t);try{a="Hi "+t.name+",<br><br>We got your request:<br><br>Title: "+(null!=(r=null!=(s=t.atitle)?s:t.title)?r:"Unknown")+"\nReference (if provided): "+(null!=(n=t.reference)?n:"")+"<br><br>",a+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+t._id+'">cancel your request</a>, it only takes a second.<br><br>',a+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',a+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:t.email,subject:"RSCVD Request Receipt",text:a})}catch(e){}return t}},t.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},t.svc.rscvd.resolves=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h;for(null==e&&(e=this.params.resolves),null==t&&(t=this.params.resolver),e?l="object"==typeof e?e:await this.svc.rscvd(e):a=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+t+'" AND NOT unresolved:"'+t+'"'),d={},i=0,r=(c=null!=l?[l]:null!=(o=null!=a&&null!=(u=a.hits)?u.hits:void 0)?o:[]).length;i<r;i++)null!=(n=c[i])._source&&null==(l=n._source)._id&&(l._id=n._id),(s=this.copy(l)).title&&(s.journal=s.title),s.atitle&&(s.title=s.atitle),(null!=(h=await this.ill.subscription({subscription:t},s))?h.url:void 0)?(null==l.resolved&&(l.resolved=[]),l.resolved.push(t),null==l.resolves&&(l.resolves=[]),l.resolves.push({resolver:t,url:h.url,user:null!=(p=this.user)?p._id:void 0}),d[n._id]=!0):(null==l.unresolved&&(l.unresolved=[]),l.unresolved.push(t),d[n._id]=!1),this.svc.rscvd(l);return e&&d[e]?d[e]:d},t.svc.rscvd.cancel=async function(){var e;if(this.params.cancel)return(e=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(e),e},t.svc.rscvd.verify=async function(e,t=!0){var i,r;if(null==e&&(e=this.params.verify),e)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:e,createdAt:Date.now()}),t?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+e+'"',{action:"index"},(function(e){return e.status&&"Awaiting verification"!==e.status||(e.verified=t,t?(e.status="Verified",e.verified_by=this.user.email):(e.status="Denied",e.denied_by=this.user.email)),e})),!0},t.svc.rscvd.verify._auth=!0,t.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},t.svc.rscvd.deny._auth=!0,t.svc.rscvd.status=async function(){var e,t,i;if(this.params.status){[t,i]=this.params.status.split("/"),(e=await this.svc.rscvd(t)).status=i;try{"Done"===e.status?e.done_by=this.user.email:"In Progress"===e.status&&(e.progressed_by=this.user.email)}catch(e){}return this.svc.rscvd(e),e}},t.svc.rscvd.status._auth=!0,t.svc.rscvd.poll=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,N;if(null==e&&(e=null!=(v=this.params.poll)?v:Date.now()-18e4),"string"==typeof(t=null!=(b=this.params.which)?b:["new","verify","deny","cancel","status","overdue"])&&(t=t.split(",")),L.call(t,"overdue")>=0&&this.svc.rscvd.overdue(),A={new:[],verify:[],deny:[],cancel:[],status:{}},L.call(t,"new")>=0)for(l=0,c=(O=null!=(w=null!=(_=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+e,500))&&null!=(x=_.hits)?x.hits:void 0)?w:[]).length;l<c;l++)null==(i=(y=O[l])._source)._id&&(i._id=y._id),A.new.push(y._source);if(L.call(t,"verify")>=0)for(a=0,p=(k=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;a<p;a++)N=k[a]._source.parts.pop(),L.call(A.verify,N)<0&&A.verify.push(N);if(L.call(t,"deny")>=0)for(o=0,d=(j=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<d;o++)n=j[o]._source.parts.pop(),L.call(A.deny,n)<0&&A.deny.push(n);if(L.call(t,"cancel")>=0)for(u=0,h=(S=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<h;u++)s=S[u]._source.parts.pop(),L.call(A.cancel,s)<0&&A.cancel.push(s);if(L.call(t,"status")>=0)for(m=0,f=(I=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;m<f;m++)C=(D=I[m])._source.parts.pop(),null==(r=A.status)[g=D._source.parts.pop()]&&(r[g]=C);return A},t.svc.rscvd.poll._log=!1,t.svc.rscvd.overdue=async function(){var e,t,i,r,s,n,l,a,o,u,c;if(t=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(r=0,n=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;r<n;r++)null==(e=(a=c[r])._source)._id&&(e._id=a._id),u.push(a._source);for(s=0,l=u.length;s<l;s++)(o=u[s]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),t+=1;return t},L=[].indexOf,t.test=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z;for(H=null!=(j=this.params.row)?j:this.params.id,h=null!=(S=this.params.test)?S:this.params.group,null==t&&(t=null!=(W=this.params.max)?W:H?1:1e4),(X={summary:{ran:0,max:t,id:H,responded:0,errors:0,differences:0,difference:null==(U=null!=(M=this.params.diff)?M:this.params.difference)||U,anomalous:0},anomalies:{},anomalous_ids:[],errors:[],differences:{}}).sheet={id:null!=(z=null!=e?e:this.params.sheet)?z:"1GQhgRCZ9ovfTN_wwKCvoAqf9QlO7ozcxScBgjEnpfl8/tests"},null==(s=X.sheet).url&&(s.url="https://docs.google.com/spreadsheets/d/"+X.sheet.id.split("/")[0]),X.sheet.content=await this.src.google.sheets(X.sheet.id),X.responses=[],X.diffs=[],D.log(X.sheet.content.length,"tests found to run in",X.sheet.id),m=0,_=(F=X.sheet.content).length;m<_&&(Z=F[m],X.summary.ran!==t);m++)if(null==Z.PARAMS&&null!=Z.QUERY&&(Z.PARAMS=Z.QUERY),null==Z.ENDPOINT&&null!=Z.ENDPOINT_PRIMARY&&(Z.ENDPOINT=Z.ENDPOINT_PRIMARY),null==Z.DIFF&&null!=Z.ENDPOINT_SECONDARY&&(Z.DIFF=Z.ENDPOINT_SECONDARY),Z.ENDPOINT&&Z.ID&&(null==H||Z.ID.toString().toLowerCase()===H.toString().toLowerCase())&&(!h||(B=h.toString().toLowerCase(),L.call(Z.GROUP.toString().toLowerCase().replace(/ /g,"").split(";"),B)>=0))){try{Z.PARAMS=Z.PARAMS.trim()}catch(e){}X.summary.ran++,""==(i=(null!=(J=null!=($=null!=(I=Z.ID)?I:Z.NAME)?$:Z.ENDPOINT)?J:"")+(Z.ID||Z.NAME||!Z.PARAMS?"":"("+Z.PARAMS+")"))&&(i="UNIDENTIFIED_TEST_"+X.summary.ran);try{for(n in G=Z.ENDPOINT.startsWith("http")?await this.fetch(Z.ENDPOINT+(Z.ENDPOINT.endsWith("/")||(null!=(A=Z.PARAMS)?A:"").startsWith("/")?"":"/")+(null!=(C=Z.PARAMS)?C:"")):await this[Z.ENDPOINT](Z.PARAMS),X.summary.responded++,Z)if("ID"!==n&&"GROUP"!==n&&"ENDPOINT"!==n&&"ENDPOINT_PRIMARY"!==n&&"ENDPOINT_SECONDARY"!==n&&"DIFF"!==n&&"PARAMS"!==n&&"QUERY"!==n&&"NAME"!==n&&"SPEC"!==n&&"TEST_LINK"!==n&&"PRIMARY_URL"!==n&&"GROUP_MANUAL"!==n&&"ID_MANUAL"!==n&&"TEST_REQUIREMENTS_MET"!==n&&""!==n&&!n.startsWith("OPTIONS.")&&null!=(d=Z[n])&&""!==d){if(k=await this.dot(G,n),f=!1,b=!1,O=!1,a="string"==typeof d&&(d.startsWith("~")||Array.isArray(k)&&(!d.includes(",")||k.length!==d.split(",").length)),"object"==typeof k)a||("string"==typeof d&&Array.isArray(k)&&(d=d.split(",")),k=JSON.stringify(k),"object"==typeof d&&(d=JSON.stringify(d)));else try{"number"!=typeof(w=parseFloat(k))||w.toString().trim().length!==k.toString().trim().length||isNaN(w)||(k=w,d.startsWith(">")?(f=!0,d=parseFloat(d.slice(1))):d.startsWith("<")?(b=!0,d=parseFloat(d.slice(1))):d.startsWith("!")?(O=!0,d=parseFloat(d.slice(1))):d=parseFloat(d))}catch(e){}if("boolean"==typeof d||"boolean"==typeof k)try{d=d.toString().trim().toLowerCase(),k=k.toString().trim().toLowerCase()}catch(e){}x="!*"===d||"UNDEFINED"===d||"NULL"===d||"NONE"===d,Y=(y=!(r="*"===d)&&!x&&"string"==typeof d&&(d.startsWith("*")||d.endsWith("*")))&&!d.startsWith("*"),c=y&&!d.endsWith("*"),y&&(d=d.replace(/\*/g,"")),x&&(a=!1),!O&&"string"==typeof d&&d.startsWith("!")&&d.length>1&&(O=!0,d=d.slice(1)),a&&("string"==typeof d&&d.startsWith("~")&&(d=d.slice(1)),l=r||L.call(k,d)>=0||(N=parseFloat(d),L.call(k,N)>=0)||(E=parseInt(d),L.call(k,E)>=0)||"true"===d.toLowerCase()&&L.call(k,!0)>=0||"false"===d.toLowerCase()&&L.call(k,!1)>=0),D.log(X.summary.ran,n,"part:",typeof k,k,"expect:",typeof d,d,typeof Z[n],Z[n],"gt:",f,"lt:",b,"nt:",O,"nothing:",x,"anything:",r,"includes:",y,"starts:",Y,"ends:",c,"contains:",a,"contained:",l),!(null==k&&!x&&!O||null!=k&&"[]"!==(P=JSON.stringify(k))&&"{}"!==P&&x||a&&!l&&!O||Y&&!k.startsWith(d)||c&&!k.endsWith(d)||!Y&&!c&&y&&!k.includes(d)||O&&(k===d||a&&l)||f&&k<=d||b&&k>=d)&&(f||b||O||r||x||a||y||k===d)||(null==X.anomalies[i]&&(X.anomalous_ids.push(i),X.summary.anomalous++,X.anomalies[i]={}),X.anomalies[i][n]={group:Z.GROUP,expected:Z[n],reported:null==k?"UNDEFINED":k})}if(X.responses.push(G),Z.DIFF&&!0===X.difference)try{V=Z.DIFF.startsWith("http")?await this.fetch(Z.DIFF+(Z.DIFF.endsWith("/")||(null!=(R=Z.PARAMS)?R:"").startsWith("/")?"":"/")+(null!=(T=Z.PARAMS)?T:"")):await this[Z.DIFF](Z.PARAMS),u=await this.fetch("https://s.leviathan.sh/diff",{body:{a:G,b:V}}),X.diffs.push(u),u.diff.length&&(X.summary.differences+=1,X.differences[i]=u.diff)}catch(e){}await this.sleep(200)}catch(e){p=e,D.log(p),X.errors.push(i),X.summary.errors++}}if(!this.params.verbose){try{for(o in X.differences)X.differences[o]=X.differences[o].length}catch(e){}for(g=0,v=(q=["responses","diffs"]).length;g<v;g++)delete X[q[g]];delete X.sheet.content}return X},t.tests=t.test,L=[].indexOf,t.src.crossref=function(){return"Crossref API wrapper"},t.src.crossref.works={_index:{settings:{number_of_shards:15}}},t.src.crossref.works._key="DOI",t.src.crossref.works._prefix=!1,t.src.crossref.works.doi=async function(e,t,i){var r,s,n,l,a,o,u;return null==e&&(e=this.params.doi),null==t&&"src.crossref.works.doi"===this.fn&&(t=this.refresh),null==i&&(i=null==(s=this.params.save)||s),"string"==typeof e&&e.startsWith("10.")&&(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),!t&&(r=await this.src.crossref.works(e))||null!=(null!=(u=await this.fetch("https://api.crossref.org/works/"+e,{headers:{"User-Agent":(null!=(n=this.S.name)?n:"OA.Works")+"; mailto:"+(null!=(l=null!=(a=this.S.mail)?a.to:void 0)?l:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}))&&null!=(o=u.message)?o.DOI:void 0)&&(r=await this.src.crossref.works._format(u.message),i&&await this.src.crossref.works(r))),r},t.src.crossref.works.title=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;if(null==e&&(e=null!=(o=this.params.title)?o:this.params.q),l='title:"'+e+'"',e.split(" ").length>2){for(l+=" OR (",t=0,i=(u=e.split(" ")).length;t<i;t++)g=u[t],l.endsWith("(")||(l+=" AND "),l+='(title:"'+g+'" OR subtitle:"'+g+'")';l+=")"}for(h=await this.src.crossref.works(l),s=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),n=0,r=(d=null!=(c=null!=h&&null!=(p=h.hits)?p.hits:void 0)?c:[]).length;n<r;n++)(a=d[n])._source.DOI&&a._source.title&&a._source.title.length&&(m=("string"==typeof a._source.title?a._source.title:a._source.title[0]).toLowerCase(),a._source.subtitle&&a._source.subtitle.length&&"string"==typeof(y=("string"==typeof a._source.subtitle?a._source.subtitle:a._source.subtitle[0]).toLowerCase())&&y.length&&L.call(m,y)<0&&(m+=" "+y),m=m.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==s.indexOf(m)||-1!==m.indexOf(s))&&s.length/m.length>.7&&s.length/m.length<1.3&&("journal-article"===a._source.type||null==f||"journal-article"!==f.type&&"journal-article"===a._source.type)&&(f=a._source));return f},t.src.crossref.works._format=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y;for(e.abstract&&(e.abstract=e.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==e._id&&(e._id=e.DOI.replace(/\//g,"_")),r=0,n=(p=null!=(c=e.assertion)?c:[]).length;r<n;r++)"OPEN ACCESS"===(t=p[r]).label&&(t.URL&&-1!==t.URL.indexOf("creativecommons")&&(null==e.license&&(e.license=[]),e.license.push({URL:t.URL})),e.is_oa=!0);for(o=0,l=(h=null!=(d=e.license)?d:[]).length;o<l;o++)if((s=h[o]).URL&&-1!==s.URL.indexOf("creativecommons")&&(!e.licence||-1===e.licence.indexOf("creativecommons"))){e.licence=s.URL;try{e.licence="cc-"+e.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(e){}e.is_oa=!0}try{e.reference&&e.reference.length>100&&(e.reference_original_length=e.reference.length,e.reference=e.reference.slice(0,100))}catch(e){}try{e.relation&&e.relation.length>100&&(e.relation_original_length=e.relation.length,e.relation=e.relation.slice(0,100))}catch(e){}for(u=0,a=(m=null!=(f=e.author)?f:[]).length;u<a;u++)(i=m[u]).name=(i.given?i.given+" ":"")+(null!=(y=i.family)?y:"");if(e.published=await this.src.crossref.works.published(e)){try{e.year=e.published.split("-")[0]}catch(e){}try{parseInt(e.year)}catch(e){}try{e.publishedAt=await this.epoch(e.published)}catch(e){}}return e},t.src.crossref.works.published=async function(e){var t,i,r,s,n,l,a,o,u;if(null==e&&(e=this.params.published),"string"==typeof e&&(e=await this.src.crossref.works(e)),null!=e){for(n=void 0,s=void 0,t=0,i=(a=["published","published-print","published-online","issued","deposited"]).length;t<i;t++)"object"==typeof e[r=a[t]]&&(l=void 0,"string"==typeof e[r]["date-time"]&&3===e[r]["date-time"].split("T")[0].split("-").length?l=e[r]["date-time"].split("T")[0]:Array.isArray(e[r]["date-parts"])&&e[r]["date-parts"].length&&Array.isArray(e[r]["date-parts"][0])&&("string"!=(o=typeof(u=e[r]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(l=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),l&&(!s||n>await this.epoch(l))&&(s=l,n=await this.epoch(s)));return s}},t.src.crossref.works.published._log=!1,t.src.crossref.works.search=async function(e,t,i,r,s,n,l,a){var o,u,c,p,d,h,f,m,y,g,_;if(null==e&&(e=null!=(d=this.params.q)?d:this.params.search),null==t&&(t=this.params.from),null==i&&(i=this.params.size),null==r&&(r=this.params.filter),null==s&&(s=this.params.start),null==n&&(n=this.params.end),null==l&&(l=this.params.sort),null==a&&(a=null!=(h=this.params.order)?h:"asc"),o="",s&&(null==r&&(r=null!=l?l:"updated"),"string"==typeof s&&-1!==s.indexOf("-")||(s=await this.date(s)),o="from-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+s),n&&(null==r&&(r=null!=l?l:"updated"),"string"==typeof n&&-1!==n.indexOf("-")||(n=await this.date(n)),o+=(o?",":"")+"until-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+n),o&&(r=o),_="https://api.crossref.org/works?",null!=l&&(_+="sort="+l+"&order="+a+"&"),"object"==typeof e)for(c in e)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(_+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(e[c])+"&");else e&&"all"!==e&&(p=(p=e.replace(/\w+?\:/g,"")).replace(/ /g,"+"),_+="query="+encodeURIComponent(p)+"&");if(null!=t){if("*"!==t&&"string"==typeof t&&!t.replace(/[0-9]/g,"").length)try{u=parseInt(t),isNaN(u)||(t=u)}catch(e){}_+="number"!=typeof t?"cursor="+encodeURIComponent(t)+"&":"offset="+t+"&"}null!=i&&(_+="rows="+i+"&"),r&&(_+="filter="+encodeURIComponent(r)+"&"),_=_.replace("?&","?").replace(/&$/,"");try{return{total:(g=await this.fetch(_,{headers:{"User-Agent":(null!=(f=this.S.name)?f:"OA.Works")+"; mailto:"+(null!=(m=null!=(y=this.S.mail)?y.to:void 0)?m:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}})).message["total-results"],cursor:g.message["next-cursor"],data:g.message.items,facets:g.message.facets}}catch(e){}},t.src.crossref.journals={_index:!0,_prefix:!1},t.src.crossref.journals.load=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I;for(await this.src.crossref.journals(""),t=0,j=0,e=[],i="*";i&&(0===t||t<j);){for(S="https://api.crossref.org/journals?cursor="+i+"&rows=1000",O=await this.fetch(S,{headers:{"User-Agent":(null!=(p=this.S.name)?p:"OA.Works")+"; mailto:"+(null!=(d=null!=(m=this.S.mail)?m.to:void 0)?d:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}),0===j&&(j=O.message["total-results"]),i=O.message["next-cursor"],s=0,n=(y=O.message.items).length;s<n;s++){for(null==(c=y[s]).ISSN&&(c.ISSN=[]),c.issn=[],o=0,l=(g=c.ISSN).length;o<l;o++)"string"==typeof(r=g[o])&&r.length&&L.call(c.issn,r)<0&&c.issn.push(r);if(c.dois=null!=(_=c.counts)?_["total-dois"]:void 0,null!=(null!=(v=c.breakdowns)?v["dois-by-issued-year"]:void 0)){for(c.years=[],u=0,a=(b=c.breakdowns["dois-by-issued-year"]).length;u<a;u++)2===(I=b[u]).length&&(w=I[0],L.call(c.years,w)<0)&&c.years.push(I[0]);c.years.sort()}null!=c.years&&c.years.length&&c.dois?(k=(new Date).getFullYear(),L.call(c.years,k)<0&&(x=k-1,L.call(c.years,x)<0)&&(h=k-2,L.call(c.years,h)<0)&&(f=k-3,L.call(c.years,f)<0)&&(c.discontinued=!0)):c.discontinued=!0,e.push(c)}t+=1e3,e.length>=1e4&&(await this.src.crossref.journals(e),e=[])}return e.length&&(await this.src.crossref.journals(e),e=[]),D.log(t),t},t.src.crossref.journals.load._bg=!0,t.src.crossref.journals.load._async=!0,t.src.crossref.journals.load._auth="root",t.src.crossref.changes=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b;if(null==e&&(e=this.params.changes),"string"==typeof e&&(e.includes("/")||e.includes("-"))&&(e=await this.epoch(e)),!e)try{e=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday+864e5,D.log("Crossref changes start day set from latest record srcday",await this.date(e))}catch(e){}if(!e)try{e=(await this.src.crossref.works("indexed.timestamp:*",{size:1,sort:{"indexed.timestamp":"desc"}})).indexed.timestamp,D.log("Crossref changes start day set from latest record indexed timestamp",await this.date(e))}catch(e){}if(null==e&&(e=16935264e5),e=await this.epoch(await this.date(e)),null==t&&(t=this.params.end),"string"==typeof t&&(t.includes("/")||t.includes("-"))&&(t=await this.epoch(t)),null==i&&(i=this.params.created),l=null!=t?t:Date.now(),d=0,h=[],n=0,r=[],e>=(l=await this.epoch(await this.date(l)))&&"src.crossref.changes"!==this.fn)D.log("crossref works changes waiting an hour before looping to check for new changes because start day is not yet a day or more in the past"),await this.sleep(36e5);else{for(;e<l;){for(D.log("Crossref changes",e,n),s="*",n+=1,b=!1,u=0,_=0;_<3&&(!1===b||u<b);)if(await this.sleep(500),null!=(v=await this.src.crossref.works.search(void 0,s,1e3,"indexed",e,e))?v.data:void 0){for(c=0,p=(m=v.data).length;c<p;c++)f=m[c],(o=await this.src.crossref.works._format(f)).srcday=e,r.push(o),d+=1;r.length>=1e4&&(D.log("Crossref bulk load",e,n,b,u,d,h.length),await this.src.crossref.works(r),r=[]),!1===b&&(b=null!=(y=v.total)?y:0,D.log(e,b)),u+=1e3,s=v.cursor}else D.log("crossref error"),await this.sleep(2e3),_+=1;e+=864e5}r.length&&await this.src.crossref.works(r),D.log("crossref works changes completed",d,n,h.length),(d>0||1===(new Date).getDay())&&(a=await this.datetime(),await this.mail({to:null!=(g=this.S.log)?g.logs:void 0,subject:"Crossref works load or changes "+d+" at "+a,text:"loaded "+d}))}return d},t.src.crossref.changes._bg=!0,t.src.crossref.changes._async=!0,t.src.crossref.changes._log=!1,t.src.crossref.changes._auth="root",t.src.crossref.changes._notify=!1,t.src.crossref.plus={},t.src.crossref.plus.load=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d,h;if(c=await this.epoch(),s=0,this.params.clear)await this.src.crossref.works(""),(l={properties:{}}).properties.assertion={properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},explanation:{properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},group:{properties:{label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},order:{type:"long"},value:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},await this.src.crossref.works.mapping(l);else try{s=(await this.src.crossref.works("srcfile:*",{size:1,sort:{srcfile:"desc"}})).srcfile}catch(e){}i=this.S.directory+"/import/crossref/all.json.tar.gz";try{await fs.stat(i)}catch(e){D.log("crossref downloading snapshot"),(r={})["Crossref-Plus-API-Token"]="Bearer "+this.S.crossref,o=await fetch("https://api.crossref.org/snapshots/monthly/latest/all.json.tar.gz",{headers:r}),h=fs.createWriteStream(i),await new Promise(((e,t)=>(o.body.pipe(h),o.body.on("error",t),h.on("finish",e)))),D.log("snapshot downloaded")}for(d=0,u=0,n="",e=!1,p=fs.createReadStream(i).pipe(zlib.createGunzip()),a="",p.on("data",(async e=>{var t,i,r,l,o,c,p,h,f,m;if(r=e.toString("utf8"),n+=r,(a+r).includes('\n  "items" : ['))for(;n.includes('\n  "items" : [');)if([l,n]=n.replace('\n  "items" : [',"X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),l.includes("\n  } ]")){if(o=l.split("\n  } ]"),m=parseInt(o.pop().split(".json")[0].replace(/[^0-9]/g,"")),u<s)D.log("crossref plus load waiting for file",u,s);else{for(p=[],t=0,i=(h=f=JSON.parse("["+o.join("]")+"}]")).length;t<i;t++)c=h[t],(null!=(c=await this.src.crossref.works._format(c))?c.DOI:void 0)&&(c.srcfile=u,p.push(c));D.log("crossref plus load",f.length,p.length),d+=p.length,p.length&&await this.src.crossref.works(p)}u=m}return a=r})),p.on("error",(e=>D.log("crossref plus load file stream error",JSON.stringify(e)))),p.on("end",(()=>(D.log("stream complete for crossref plus load"),e=!0)));!e;)D.log("crossref plus load streaming file",n.length,u,d,Math.floor((Date.now()-c)/1e3/60)+"m"),await this.sleep(3e4);return t=Date.now(),D.log("crossref plus load complete",u,d,c,t,Math.floor((t-c)/1e3/60)+"m"),d},t.src.crossref.plus.load._log=!1,t.src.crossref.plus.load._bg=!0,t.src.crossref.plus.load._async=!0,null==(x=r.src).doaj&&(x.doaj={});try{r.src.doaj.secrets=JSON.parse(SECRETS_DOAJ)}catch(e){}t.src.doaj={},t.src.doaj.journals={_index:!0,_prefix:!1},t.src.doaj.journals.load=async function(){var e,t,i,s,n,l,a,o;for(i="/tmp/doaj_"+await this.uid(),await fs.mkdir(i),i+="/",await fs.writeFile(i+"doaj.tar",await this.fetch("https://doaj.org/public-data-dump/journal?api_key="+r.src.doaj.secrets.apikey,{buffer:!0})),tar.extract({file:i+"doaj.tar",cwd:i,sync:!0}),e=!1,s=0,l=(a=await fs.readdir(i)).length;s<l;s++)(t=a[s]).includes("doaj_journal_data")&&(e=t);return o=0,e&&(o=(n=JSON.parse(await fs.readFile(i+e+"/journal_batch_1.json"))).length,await this.src.doaj.journals(""),await this.src.doaj.journals(n),await fs.unlink(i+e+"/journal_batch_1.json")),await fs.rmdir(i+e),await fs.unlink(i+"doaj.tar"),await fs.rmdir(i),o},t.src.doaj.journals.load._bg=!0,t.src.doaj.journals.load._async=!0,t.src.doaj.journals.load._auth="root",L=[].indexOf,t.src.epmc={_index:!0,_prefix:!1,_key:"id"},t.src.epmc.notinepmc={_index:!0,_prefix:!1,_key:"id",_hide:!0},t.src.epmc.search=async function(e,t,i){var r,s,n,l,a,o,u,c,p;null==e&&(e=null!=(r=null!=(s=null!=(n=this.params.search)?n:this.params.epmc)?s:this.params.doi)?r:""),e.startsWith("10.")&&!e.includes(" ")&&e.split("/").length>=2&&(e="DOI:"+e),"string"!=typeof e||e.startsWith("PMCID:")||!e.toLowerCase().startsWith("pmc")||e.includes(" ")||(e="PMCID:PMC"+e.toLowerCase().replace("pmc","")),"number"==typeof e&&(e="PMCID:PMC"+e),p="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(p+="&pageSize="+i),null!=t&&(p+="&cursorMark="+t),c={},await this.sleep(150);try{u=await this.fetch(p),c.total=u.hitCount,c.data=null!=(l=null!=(a=u.resultList)?a.result:void 0)?l:[],c.cursor=u.nextCursorMark}catch(e){}return(null!=(o=c.data)?o.length:void 0)&&this.waitUntil(this.src.epmc(c.data)),c},t.src.epmc.doi=async function(e,t){var i,r,s,n,l;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.doi),null!=(i=await this.src.epmc('doi:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?s:0)<24192e5);else{if((l=await this.src.epmc.search("DOI:"+e)).total)return l.data[0].doi||(l.data[0].doi=e,this.waitUntil(this.src.epmc(l.data[0]))),l.data[0];null!=l.total&&await this.src.epmc.notinepmc({id:e.replace(/\//g,"_"),doi:e,checkedAt:Date.now()})}},t.src.epmc.pmid=async function(e,t){var i,r,s,n,l;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.pmid),null!=(i=await this.src.epmc('pmid:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?s:0)<24192e5);else{if((l=await this.src.epmc.search("EXT_ID:"+e+" AND SRC:MED")).total)return l.data[0];null!=l.total&&await this.src.epmc.notinepmc({id:e,pmid:e,checkedAt:Date.now()})}},t.src.epmc.pmc=async function(e,t){var i,r,s,n,l,a;if(e||null==t&&(t=this.refresh),null==e&&(e=null!=(r=this.params.pmc)?r:this.params.pmcid),e="PMC"+e.toLowerCase().replace("pmc",""),null!=(i=await this.src.epmc('pmcid:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(n=null!=(l=await this.src.epmc.notinepmc(e))?l.checkedAt:void 0)?n:0)<24192e5);else{if((a=await this.src.epmc.search("PMCID:"+e)).total)return a.data[0];null!=a.total&&await this.src.epmc.notinepmc({id:e,pmcid:e,checkedAt:Date.now()})}},t.src.epmc.title=async function(e){var t,i,r;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(null!=(t=await this.src.epmc('title:"'+e+'"'))&&null!=(i=t.hits)?i.total:void 0)?t.hits.hits[0]._source:(r=await this.src.epmc.search('title:"'+e+'"')).total?r.data[0]:void 0},t.src.epmc.licence=async function(e,t,i,r){var s,n,l;if(e||null==r&&(r=this.refresh),null==e&&(e=null!=(n=null!=(l=this.params.licence)?l:this.params.pmcid)?n:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),e&&null==t&&(t=await this.src.epmc.pmc(e,r)),t||i){if(null!=(null!=t?t.calculated_licence:void 0)&&!r)return"not found"===t.calculated_licence.licence?void 0:t.calculated_licence;if(null==e&&(e=null!=t?t.pmcid:void 0),(null!=t?t.license:void 0)&&"string"==typeof t.license?(s={licence:t.license,source:"epmc_api"}).licence.startsWith("cc")&&(s.licence=s.licence.replace(/ /g,"-")):(!i&&e&&(i=await this.src.epmc.xml(e,t,r)),null!=this.licence&&i&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(s=await this.licence(void 0,i,"<permissions>","</permissions>"))?s.licence:void 0)&&(s.source="epmc_xml_permissions"),null==(null!=s?s.licence:void 0)&&null!=(null!=(s=await this.licence(void 0,i))?s.licence:void 0)&&(s.source="epmc_xml_outside_permissions")),null==(null!=s?s.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(s={licence:"non-standard-licence",source:"epmc_xml_permissions"})),null!=(null!=s?s.licence:void 0))return t.calculated_licence=s,await this.src.epmc(t.id,t),s;t.calculated_licence={licence:"not found"},await this.src.epmc(t.id,t)}},b=Date.now(),w=0,t.src.epmc.xml=async function(e,t,i){var r,s,n,l,a;if(null==e&&(e=null!=(n=null!=(l=this.params.xml)?l:this.params.pmcid)?n:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),null==i&&(i=this.refresh),e)try{return(r=await fs.readFile(this.S.directory+"/epmc/fulltext/"+e+".xml")).toString()}catch(n){if(null==t&&(t=await this.src.epmc.pmc(e,i)),i||!(null!=t?t.no_ft:void 0)){for(s=Date.now()-b;s<500||w>=2;)await this.sleep(500-s),s=Date.now()-b;if(b=Date.now(),w+=1,a="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&id="+e,r=await this.fetch(a),w-=1,"string"==typeof r&&r.length||null==t||(a="https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",r=await this.fetch(a)),"string"==typeof r&&r.length){try{await fs.writeFile(this.S.directory+"/epmc/fulltext/"+e+".xml",r)}catch(e){}return r}null!=t&&(t.no_ft=!0,await this.src.epmc(t.id,t))}}},t.src.epmc.fulltext=async function(e){var t,i,r;if(null==e&&(e=null!=(i=null!=(r=this.params.fulltext)?r:this.params.pmcid)?i:this.params.epmc),e)return await this.sleep(150),200===(null!=(t=await this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",{method:"HEAD"}))?t.status:void 0)},t.src.epmc.aam=async function(e,t,i,r){var s,n,l,a;if(null==e&&(e=null!=(n=null!=(l=this.params.aam)?l:this.params.pmcid)?n:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{e&&!t&&(t=await this.src.epmc.pmc(e,r))}catch(e){}return null==e&&(e=null!=t?t.pmcid:void 0),e?"string"==typeof(i=await this.src.epmc.xml(e,t,r))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),a="https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc",""),(s=await this.fetch(a))?"string"==typeof s?s.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||s.includes("Author manuscript; available in PMC")||s.includes("logo-nihpa.gif")||s.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}:null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},t.src.epmc.submitted=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h;if(null==e&&(e=null!=(o=null!=(u=null!=(c=null!=(p=this.params.submitted)?p:this.params.pmc)?c:this.params.pmcid)?u:this.params.PMC)?o:this.params.PMCID),null==i&&(i=this.refresh),e){e="PMC"+(e+"").toLowerCase().replace("pmc","");try{if(r=await this.src.epmc.xml(e,t,i)){if((r=r.split("<article-meta")[1].split("/article-meta")[0].split('date-type="received"')[1].split("</date")[0]).includes("<year")){h=r.split("<year")[1].split("</year>")[0].split(">").pop();try{h+="-"+r.split("<month")[1].split("</month>")[0].split(">").pop()}catch(e){h+="-01"}try{h+="-"+r.split("<day")[1].split("</day>")[0].split(">").pop()}catch(e){h+="-01"}r=h}else r=r.includes("<")?r.replace(">","").split("<")[0]:r.split('"')[1];if(r=r.replace("\n","").trim()){if(10!==r.length){for(a=[],d=r.split("T")[0].split("-"),n=0,l=d.length;n<l;n++)s=d[n],a.push(1===s.length?"0"+s:s);r=a.join("-")}return r}}}catch(e){}}},t.src.epmc.statement=async function(e,t,i,r){var s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C;if(null==e&&(e=null!=(_=null!=(v=null!=(b=null!=(w=this.params.statement)?w:this.params.pmc)?b:this.params.pmcid)?v:this.params.PMC)?_:this.params.PMCID),null==i&&(i=this.refresh),null==r&&(r=this.params.verbose),m=[],d=[],j=[],C=[],A=[],e&&(e="PMC"+(e+"").toLowerCase().replace("pmc",""),l=await this.src.epmc.xml(e,t,i)))for(l=l.split("<ref-list")[0].replace(/\<p\>/g,"").replace(/\<\/p\>/g,""),I="",a=0,o=(x=['"data',">Data",">Availab",">data",">Code",">code"]).length;a<o;a++){O=x[a];try{if(l.includes(O))for(j.push(O),f=(k=l.split(O)).shift();f&&(c=k.shift());){if(m.push(f.slice(-1e3)),D=f.split("<").pop().split(">")[0].split(" ")[0].replace("/",""),!O.startsWith('"')&&f.endsWith("><"+D)&&(D=f.split("</"+D+">").pop().split("><"+D)[0].split("<").pop().split(">")[0].split(" ")[0].replace("/","")),p=(O.startsWith('"')?c.split(/\>(.*)/s)[1]:c.startsWith("il")||c.startsWith("l")?"Availab":"Data")+c,d.push(p.slice(0,1e3)),p.includes("</"+D+">")&&p.indexOf("</"+D+">")<40)try{(u=(y=f.split("<"))[y.length-2].split(">")[0].split(" ")[0]).startsWith("/")||(D=u)}catch(e){}if(C.push(D),S="\n"+(g=f.split("<"+D)).slice(0,g.length-1).pop().split("\n").pop()+"</"+D+">",p.split("</"+D+">")[0].includes("\n"))for(;!p.includes(S)&&k.length;)p+=(O.startsWith(">")?">":"")+(k[0].startsWith("il")||k[0].startsWith("l")?"Availab":"Data")+k.shift();p=(p=p.split(S)[0]).replace("</title>","|TTT|").replace(/\n/g," ").replace(/\s+/g," ").replace(/(<([^>]+)>)/gi,""),h=(m[m.length-1]+p).toLowerCase(),p.length>20&&p.length<3e3&&(h.includes("availab")||h.includes("accessib"))&&(h.includes("data")||h.includes("code"))&&(p.includes("|TTT|")&&(p=p.split("|TTT|")[1]),n=(s=(s=(s=(await this.decode(p.trim())).replace(/"/g,"").replace(/\s+/g," ")).replace("<title","").replace("<p","")).trim()).toLowerCase(),s.length>20&&(n.includes("data")||n.includes("code")||n.includes("availab")||n.includes("accessib"))&&!I.includes(n)&&(I+=n,A.push(s))),f=c}}catch(e){}}return r?{pmcid:e,file:"https://static.oa.works/epmc/fulltext/"+e+".xml",pres:m,posts:d,splits:j,tags:C,statements:A,url:A?await this.src.epmc.statement.url(void 0,void 0,A,i):void 0}:A.length?A:void 0},t.src.epmc.statement.url=async function(e,t,i,r){var s,n,l,a,o,u;for(null==i&&(i=await this.src.epmc.statement(e,t,r)),u=[],s=(e,t)=>{var i,r,s,n,l;for((r=e.split(t)).shift(),l=[],s=0,n=r.length;s<n;s++)(i=t+(i=r[s]).split(" ")[0]).length>10&&i.includes("/")?((i=i.toLowerCase()).includes(")")&&(e.includes("(h")||e.includes("(10"))&&(i=i.split(")")[0].replace("(","")),i.endsWith(".")&&(i=i.slice(0,-1)),i.startsWith("10.")&&(i="https://doi.org/"+i),L.call(u,i)<0?l.push(u.push(i)):l.push(void 0)):l.push(void 0);return l},l=0,a=(o=null!=i?i:[]).length;l<a;l++)(n=o[l]).includes("http")&&await s(n,"http"),n.includes("10.")&&await s(n,"10.");return u.length?u:void 0},null==(x=r.src).google&&(x.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}t.src.google=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d;return null==e&&(e=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(n=this.params)?n.google:void 0),null==t&&(t=null!=(l=this.S.src.google)&&null!=(a=l.secrets)&&null!=(o=a.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(p=c.search)?p.key:void 0),e&&t&&i?(d="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(d)):{}},t.src.google.sheets=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;if(null==e&&(e=this.copy(this.params)),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(c=e.sheet)?c:e.sheets,delete e.sheet,delete e.sheets),!e.sheetid)return[];if(e.sheetid.startsWith("http")&&e.sheetid.includes("sheets.googleapis.com/v4/")?b=e.sheetid:(e.sheetid.includes("/spreadsheets/")?(_=e.sheetid.replace("/spreadsheets/d/","/spreadsheets/").split("/spreadsheets/")[1].split("/")[0],!e.sheet&&e.sheetid.includes("/values/")&&(e.sheet=e.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),e.sheetid=_):2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="Sheet1"),b="https://sheets.googleapis.com/v4/spreadsheets/"+e.sheetid+"/values/"+e.sheet+"?alt=json&key="+(null!=(p=null!=(d=this.S.src.google)&&null!=(h=d.secrets)?h.serverkey:void 0)?p:null!=(f=this.S.src.google)&&null!=(m=f.secrets)?m.apikey:void 0)),t=await this.fetch(b,{headers:{"Cache-Control":"no-cache"}}),!1===e.values)return t;if(!1===e.headers)return t.values;if(Array.isArray(e.headers))s=e.headers;else if(s=[],null!=t.values)for(n=0,o=(v=t.values.shift()).length;n<o;n++){r=v[n];try{r=r.trim()}catch(e){}s.push(r)}for(x=[],l=0,u=(g=null!=(y=t.values)?y:[]).length;l<u;l++){for(i in a=g[l],w={},s)try{w[s[i]]=a[i]}catch(e){}"{}"!==JSON.stringify(w)&&x.push(w)}return x},t.src.google.sheets._bg=!0,t.src.google.sheets._log=!1,null==(x=r.src).microsoft&&(x.microsoft={});try{r.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(e){}t.src.microsoft={},t.src.microsoft.bing=async function(e,t,i,s,n){var l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x;return null==e&&(e=null!=(l=null!=(a=null!=this&&null!=(h=this.params)?h.bing:void 0)?a:null!=this&&null!=(f=this.params)?f.q:void 0)?l:null!=this&&null!=(m=this.params)?m.query:void 0),null==t&&(t=null!=(y=null!=this&&null!=(g=this.params)?g.key:void 0)?y:null!=(_=r.src.microsoft.bing)?_.key:void 0),null==i&&(i=null!=(v=null!=this&&null!=(b=this.params)?b.market:void 0)?v:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==n&&(n=null!=(c=null!=this&&null!=(p=this.params)?p.cache:void 0)?c:259200),null!=e&&null!=t&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+e,null!=(w=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":t},cache:n}))&&null!=(d=w.webPages)?d.value:void 0)?{total:w.webPages.totalEstimatedMatches,data:w.webPages.value}:{total:0,data:[]}},t.src.microsoft.bing._auth="@oa.works",null==(x=r.src).oadoi&&(x.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(e){}t.src.oadoi={_index:{settings:{number_of_shards:9}}},t.src.oadoi._key="doi",t.src.oadoi._prefix=!1,t.src.oadoi.search=async function(e){var t,i,s;if(null==e&&(e=null!=(t=null!=(i=this.params.oadoi)?i:this.params.doi)?t:this.params.search),"string"==typeof e&&e.startsWith("10."))return await this.sleep(900),s="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,this.fetch(s)},t.src.oadoi.doi=async function(e,t){var i,s,n;if(null==e&&(e=this.params.doi),null==t&&"src.oadoi.doi"===this.fn&&(t=this.refresh),"string"==typeof e&&e.startsWith("10.")){if(!0!==t&&(i=await this.src.oadoi(e))&&("number"!=typeof t||null!=i.updated&&new Date(i.updated).valueOf()>Date.now()-t))return i;try{if(D.log("getting from OADOI",e),await this.sleep(500),n="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,(s=await this.fetch(n))&&s.doi){try{await this.src.oadoi(await this.src.oadoi._format(s))}catch(e){}return s}}catch(e){}}},t.src.oadoi.hybrid=async function(e){var t,i,r,s,n,l;if(null==e&&(e=null!=(s=null!=(n=this.params.hybrid)?n:this.params.issn)?s:this.params.issns),"object"!=typeof e||Array.isArray(e)||(e=null!=(l=e.journal_issns)?l:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return(r="journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(r="("+r+")"),t=await this.src.oadoi.count(r+' AND oa_status:"closed"'),i=await this.src.oadoi.count(r+' AND oa_status:"hybrid"'),!!(t&&i/t>.001)},t.src.oadoi.oa={type:async function(e){var t,i,r,s,n;return null==e&&(e=null!=(i=null!=(r=this.params.type)?r:this.params.issn)?i:this.params.issns),"string"==typeof e&&e.startsWith("10.")&&(t=await this.src.oadoi.doi(e))&&(e=t.journal_issns),e&&"object"==typeof e&&!Array.isArray(e)&&(e=null!=(s=e.journal_issns)?s:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length?(n=await this.src.oadoi.terms("oa_status.keyword","journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*"),{issn:e,calculated:1===n.length?n[0].term:0===n.length?"unknown":JSON.stringify(n).toLowerCase().includes('"hybrid"')?await this.src.oadoi.hybrid(e):n[1].count/n[0].count>.001?n[0].term:"unknown",types:n}):{issn:e,calculated:"",types:[]}}},t.src.oadoi.load=async function(e,t,i,r,s){var n,l,a,o,u,c,p,d,h,f,m,y,g;null==e&&(e=null!=(d=this.params.url)?d:"https://api.unpaywall.org/feed/snapshot"),f=await this.epoch(),c=this.S.directory+"/import/oadoi/snapshot.jsonl";try{await fs.stat(c)}catch(t){D.log("OADOI downloading snapshot"),e.includes("api_key=")||(e+=(e.includes("?")?"&":"?")+"api_key="+this.S.src.oadoi.apikey),D.log(e),h=await fetch(e),g=fs.createWriteStream(c),await new Promise(((e,t)=>(h.body.pipe(g),h.body.on("error",t),g.on("finish",e)))),D.log("snapshot downloaded")}if(null==t&&(t="src_oadoi"),null==i&&(i=this.params.toalias),"number"==typeof i&&(i+=""),null==r&&(r=this.params.clear),D.log("loading oadoi",t,i,s),r){try{await this.index._send(t,"",void 0,!1,i,s),D.log("cleared"),await this.sleep(2e4)}catch(e){}await this.index._send(t,{settings:{number_of_shards:9}},void 0,!1,i,s),D.log("mapped"),await this.sleep(5e3)}for(y=0,a=[],l=[],p="",o=!1,n=async()=>{var e;if(a.length)return e=a.shift(),y+=e.length,D.log("OADOI bulk loading",e.length,y,a.length),await this.index._bulk(t,e,void 0,void 0,!1,i,s)},(m=fs.createReadStream(c)).on("data",(async e=>{var t,i,r;for("string"==typeof(t=e.toString("utf8"))&&t&&(p+=t);p.includes("\n");){[i,p]=p.replace("\n","X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),r={};try{r=JSON.parse(i)}catch(e){}(null!=r?r.doi:void 0)?(r=await this.src.oadoi._format(r),l.push(r)):D.log("oadoi load failed to parse record from string",i),3e4===l.length&&(a.push(l),l=[],n())}return null!=p?p:p=""})),m.on("error",(e=>D.log("oadoi load file stream error",JSON.stringify(e)))),m.on("end",(()=>(D.log("stream complete for oadoi load"),o=!0)));!o;)D.log("oadoi load streaming file",p.length,y,Math.floor((Date.now()-f)/1e3/60)+"m"),await this.sleep(3e4);for(;a.length;)await n();return u=Date.now(),D.log("oadoi load complete",y,f,u,Math.floor((u-f)/1e3/60)+"m"),y},t.src.oadoi.load._bg=!0,t.src.oadoi.load._async=!0,t.src.oadoi.load._log=!1,t.src.oadoi.load._auth="root",t.src.oadoi.load2025=function(){return this.src.oadoi.load(void 0,void 0,"2025",!0,this.S.dev?"http://10.108.0.3:9200":void 0)},t.src.oadoi.load2025._bg=!0,t.src.oadoi.load2025._async=!0,t.src.oadoi.load2025._log=!1,t.src.oadoi.load2025._auth="root",t.src.oadoi[2025]={_index:!0},t.src.oadoi[2025]._key="doi",t.src.oadoi[2025]._prefix=!1,t.src.oadoi.changes=async function(e,t,i,r){var s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;if(null==t&&(t="src_oadoi"),null==i&&(i=this.params.toalias),"number"==typeof i&&(i+=""),i="2025",x=this.S.directory+"/import/oadoi/upto"+(i?"_"+i:""),null==e&&(e=this.params.changes),!e)try{e=parseInt((await fs.readFile(x)).toString())}catch(e){}if(!e)try{y=await this.index.translate("*",{size:1,sort:{updated:{order:"desc"}}}),e=(u=(await this.index._send(t+"/_search",y,void 0,!1,i,r)).hits.hits[0]._source).updated}catch(e){}if("string"==typeof e)try{e=new Date(e).valueOf()}catch(t){e=parseInt(e)}if("number"==typeof e){for(n=0,l=0,w=!1,o=0,p=(_=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;o<p;o++){if(m=_[o],f=new Date(m.last_modified).valueOf(),D.log(m.last_modified,f,e,null!=u?u.updated:void 0),"jsonl"===m.filetype&&(!e||f>e)){for await(h of(D.log("OADOI importing changes for",m.last_modified),l+=1,s=[],c=0,d=this.S.directory+"/import/oadoi/"+m.date+".jsonl.gz",b=await fetch(m.url),O=fs.createWriteStream(d),await new Promise(((e,t)=>(b.body.pipe(O),b.body.on("error",t),O.on("finish",e)))),readline.createInterface({input:fs.createReadStream(d).pipe(zlib.createGunzip())})))w=f,c+=1,g=JSON.parse(h.trim().replace(/\,$/,"")),g=await this.src.oadoi._format(g),s.push(g),n+=1,s.length>=3e4&&(D.log("OADOI bulk loading changes",l,s.length,c),await this.index._bulk(t,s,void 0,void 0,!1,i,r),s=[]);s.length&&await this.index._bulk(t,s,void 0,void 0,!1,i,r),fs.unlink(d)}if(w)try{await fs.writeFile(x,w)}catch(e){}}return a=await this.datetime(),await this.mail({to:null!=(v=this.S.log)?v.logs:void 0,subject:"OADOI changes "+n+" at "+a,text:JSON.stringify("Changes found "+n+" over "+l+" for "+e+" to "+w)}),D.log("oadoi changes complete",l,n),n}D.log("Timestamp day to work since is required - run load first to auto-generate")},t.src.oadoi.changes._bg=!0,t.src.oadoi.changes._async=!0,t.src.oadoi.changes._log=!1,t.src.oadoi.changes._auth="root",t.src.oadoi.changes._notify=!1,t.src.oadoi._format=function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m;for(t=["updated","evidence"],i=0,l=(f=null!=(h=e.oa_locations)?h:[]).length;i<l;i++)for(c=f[i],r=0,a=t.length;r<a;r++)c[s=t[r]]&&"string"==typeof c[s]&&c[s].includes("deprecated")&&(c[s]=void 0);for(n=0,o=(m=["best_oa_location","first_oa_location"]).length;n<o;n++)if(null!=e[d=m[n]])for(p=0,u=t.length;p<u;p++)s=t[p],e[d][s]&&"string"==typeof e[d][s]&&e[d][s].includes("deprecated")&&(e[d][s]=void 0);return e._id=e.doi.replace(/\//g,"_").toLowerCase(),e},null==(x=r.src).openai&&(x.openai={});try{r.src.openai=JSON.parse(SECRETS_OPENAI)}catch(e){}t.src.openai={},t.src.openai.chat=async function(e,t,i,r){var s,n,l,a,o,u,c,p,d;return null==e&&(e=null!=(l=null!=(a=null!=(o=this.params.chat)?o:this.params.prompt)?a:this.params.q)?l:""),null==t&&(t=null!=(u=this.params.role)?u:"You are a helpful assistant"),null==i&&(i=null!=(c=this.params.model)?c:"gpt-4-1106-preview"),null==r&&(r=this.params.json),"string"==typeof e&&e.length&&(null!=(p=this.S.src.openai)?p.key:void 0)?(s={"Content-Type":"application/json",Authorization:"Bearer "+this.S.src.openai.key},n={model:i,messages:[]},r&&(n.response_format={type:"json_object"}),d={role:"system",content:t},n.messages.push(d),e={role:"user",content:e},n.messages.push(e),await this.fetch("https://api.openai.com/v1/chat/completions",{headers:s,body:n})):{}},t.src.openai.chat._auth="@oa.works",t.src.openai.grantid=async function(e,t){var i,r,s,n,l,a;if(null==e&&(e=null!=(s=this.params.prompt)?s:"Please extract the grant ID requested from the provided acknowledgements text."),null==t&&(t=null!=(n=this.params.text)?n:"Bill & Melinda Gates Foundation:\n\nThis work was supported by the USDA-NIFA Hatch/Multistate project W4147-TEN00539, the Bill and Melinda Gates Foundation (grant ID OPP1052983 and OPP1213329) and the Illumina Agricultural Greater Good Initiative grant."),"string"==typeof t&&t.length&&(null!=(l=this.S.src.openai)?l.key:void 0))try{return i={"Content-Type":"application/json",Authorization:"Bearer "+this.S.src.openai.key},r={model:"gpt-4o-2024-08-06",messages:[{role:"system",content:[{text:e,type:"text"}]},{role:"user",content:[{text:t,type:"text"}]}],response_format:{type:"json_schema",json_schema:{name:"grantid_response",schema:{type:"object",required:[],properties:{grantid:{type:["string","null"],description:"The grant id found, semi-colon seperated"}}},strict:!1}},temperature:1,max_tokens:256,top_p:1,frequency_penalty:0,presence_penalty:0},a=await this.fetch("https://api.openai.com/v1/chat/completions",{headers:i,body:r}),JSON.parse(a.choices[0].message.content)}catch(e){}return{}},t.src.openai.assistant=async function(e,t,i,r,s){var n,l;if(n=new OpenAI({apiKey:this.S.src.openai.key}),null==e&&(e=this.params.assistant),null==t&&(t=this.params.message),null==i&&(i=this.params.thread),null==r&&(r=this.params.instruct),null==s&&(s=this.params.model),e&&t){l={assistant:e,thread:i,message:t,response:void 0},i?l.posted=await n.beta.threads.messages.create(i,{role:"user",content:t}):(l.posted=await n.beta.threads.create({messages:[{role:"user",content:t}]}),l.thread=l.posted.id),l.run=await n.beta.threads.runs.createAndPoll(l.thread,{assistant_id:e,model:s,additional_instructions:r});try{l.messages=await n.beta.threads.messages.list(l.thread)}catch(e){}try{l.response=l.messages.body.data[0].content[0].text.value}catch(e){}try{l.response=JSON.parse(l.response)}catch(e){}return delete l.posted,delete l.run,delete l.messages,l}},t.src.openai.assistant._bg=!0,L=[].indexOf,null==(x=r.src).openalex&&(x.openalex={});try{r.src.openalex=JSON.parse(SECRETS_OPENALEX)}catch(e){}t.src.openalex=function(){return!0},t.src.openalex.works={_index:{settings:{number_of_shards:15}},_prefix:!1},t.src.openalex.works._format=function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,L;for(i=0,l=(m=["concepts","topics","keywords","sustainable_development_goals","domains","fields","subfields","authorships","locations"]).length;i<l;i++)for(r=0,a=(w=null!=(y=e[m[i]])?y:[]).length;r<a;r++){L=w[r];try{null!=L.score&&(L.score=Math.floor(L.score))}catch(e){}try{null!=L.id&&"string"!=typeof L.id&&(L.id="https://openalex.org/"+L.id)}catch(e){}for(s=0,o=(x=["source","author","institutions","domain","field","subfield"]).length;s<o;s++){D=x[s];try{null!=(null!=(O=L[D])?O.id:void 0)&&"string"!=typeof L[D].id&&(L[D].id="https://openalex.org/"+L[D].id)}catch(e){}}}for(n=0,u=(k=["best_oa_location","primary_location","primary_topic"]).length;n<u;n++){d=k[n];try{(null!=(j=e[d])?j.score:void 0)&&(e[d].score=Math.floor(e[d].score))}catch(e){}try{null!=(null!=(S=e[d])?S.id:void 0)&&"string"!=typeof e[d].id&&(e[d].id="https://openalex.org/"+e[d].id)}catch(e){}for(h=0,c=(I=["source","domain","field","subfield"]).length;h<c;h++){D=I[h];try{null!=(null!=(A=e[d][D])?A.id:void 0)&&"string"!=typeof e[d][D].id&&(e[d][D].id="https://openalex.org/"+e[d][D].id)}catch(e){}}}try{e._id=null!=(g=null!=(_=e.doi)?_:e.DOI)?g:null!=(v=e.ids)?v.doi:void 0,e._id.includes("http")&&e._id.includes("/10.")&&(e._id="10."+e._id.split("/10.").pop()),e._id&&e._id.startsWith("10.")||(e._id=e.id.split("/").pop())}catch(t){e._id=e.id.split("/").pop()}try{for(C in t=[],e.abstract_inverted_index)for(b=e.abstract_inverted_index[C],f=0,p=b.length;f<p;f++)t[b[f]]=C;t.length&&(e.abstract=t.join(" "))}catch(e){}try{delete e.abstract_inverted_index}catch(e){}return e},t.src.openalex.works.doi=async function(e,t,i){var r,s,n;return null==e&&(e=this.params.doi),null==t&&"src.openalex.works.doi"===this.fn&&(t=this.refresh),null==i&&(i=null==(s=this.params.save)||s),!t&&(r=await this.src.openalex.works('ids.doi.keyword:"https://doi.org/'+e+'"',1))||(r=await this.fetch("https://api.openalex.org/works/https://doi.org/"+e+((null!=(n=this.S.src.openalex)?n.apikey:void 0)?"?api_key="+this.S.src.openalex.apikey:"")))&&r.id&&(r=await this.src.openalex.works._format(r),i&&await this.src.openalex.works(r)),r},t.src.openalex.works.title=async function(e){if(null!=e?e:e=this.params.title)return await this.src.openalex.works('title:"'+e+'"',1)},t.src.openalex.oa={type:async function(e){var t,i,r,s,n,l,a,o,u,c;return null==e&&(e=null!=(i=null!=(r=this.params.type)?r:this.params.issn)?i:this.params.issns),"string"==typeof e&&e.startsWith("10.")&&(t=await this.src.openalex.works.doi(e))&&(e=null!=(s=t.primary_location)&&null!=(n=s.source)?n.issn:void 0),"object"!=typeof e||Array.isArray(e)||(e=null!=(l=null!=(a=e.journal_issns)?a:e.ISSN)?l:null!=(o=e.primary_location)&&null!=(u=o.source)?u.issn:void 0),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length?(c=await this.src.openalex.works.terms("open_access.oa_status.keyword",'locations.source.issn.keyword:"'+e.join('" OR locations.source.issn.keyword:')+'"'),{issn:e,calculated:1===c.length?c[0].term:0===c.length?"unknown":JSON.stringify(c).toLowerCase().includes('"hybrid"')?await this.src.openalex.hybrid(e):c[1].count/c[0].count>.001?c[0].term:"unknown",types:c}):{issn:e,calculated:"",types:[]}}},t.src.openalex.manifest=async function(){var e,t,i,r,s;if("works"!==(s=null!=(t=null!=(i=this.params.manifest)?i:this.params.openalex)?t:"works"))return!1;e=async e=>{var t,i,r,s,n,l,a;for(a="",s=0,r=0,n=(l=e.entries).length;r<n;r++)i=l[r].url.split("=")[1].split("/")[0],(t=await this.epoch(i))>s&&(s=t,a=i);return a},(r={last:"",previous:"",manifest:await this.fetch("https://openalex.s3.amazonaws.com/data/"+s+"/manifest")}).last=await e(r.manifest);try{r.previous=await e(JSON.parse((await fs.readFile(this.S.directory+"/import/openalex/data/"+s+"/manifest")).toString()))}catch(e){}return r},t.src.openalex.load=async function(e,t,i,r,s,n){var l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G;if($=await this.epoch(),null==e&&(e=null!=(N=null!=(E=this.params.load)?E:this.params.openalex)?N:"works"),"works"!==e)return!1;I=null!=(R=this.params.onlyinfo)&&R,null==t&&(t=this.params.changes),y=this.S.directory+"/import/openalex/data/"+e,null==n&&(n=this.params.toalias),"number"==typeof n&&(n+=""),n="15032024",null==i&&(i=this.params.clear),i&&(D.log("clearing",e,n),await this.index._send("src_openalex_"+e,"",void 0,!1,n),await this.sleep(2e4),await this.index._send("src_openalex_"+e,{settings:{number_of_shards:15}},void 0,!1,n),D.log("cleared and mapped"),await this.sleep(1e3)),null==s&&(s=0),b="";try{for(A=(await fs.readFile(y+"/manifest")).toString(),T=JSON.parse(A).entries,f=0,w=T.length;f<w;f++)p=T[f].url.split("=")[1].split("/")[0],(u=await this.epoch(p))>s&&(s=u,b=p)}catch(e){}if(null==r&&(r=null!=(q=this.params.sync)&&q),r&&(D.log("Openalex load syncing",e),X=await this._child("aws",["s3","sync","s3://openalex/data/"+e,y,"--no-sign-request"]),D.log("Openalex sync returned",X)),"string"==typeof t&&(t=[t]),!0===t)for(D.log("Checking for Openalex changes in",e),t=[],r||(await fs.writeFile(y+"/manifest"+(I?"info":""),await this.fetch("https://openalex.s3.amazonaws.com/data/"+e+"/manifest",{buffer:!0})),D.log("Openalex manifest "+(I?"temp saved for info":"updated"))),g=0,x=(W=JSON.parse((await fs.readFile(y+"/manifest"+(I?"info":""))).toString()).entries).length;g<x;g++)u=W[g].url.split("=")[1].split("/")[0],L.call(t,u)<0&&await this.epoch(u)>s&&t.push(u);for(D.log(t,s,b),_=0,O=(U=null!=t?t:[]).length;_<O;_++){o=U[_],D.log("Openalex checking if sync required for possibly changed files",e,o);try{await fs.stat(y+"/updated_date="+o)}catch(t){await this._child("aws",["s3","sync","s3://openalex/data/"+e+"/updated_date="+o,y+"/updated_date="+o,"--no-sign-request"]),D.log(o,"was not present, now synced")}}for(a=!0,V=0,d=0,C=0,J=[],l=async t=>{var i,r,s;for await(r of(i=[],readline.createInterface({input:fs.createReadStream(t).pipe(zlib.createGunzip())})))s=JSON.parse(r.trim().replace(/\,$/,"")),V+=1,i.push(await this.src.openalex.works._format(s)),i.length>=2e4&&(D.log("Openalex "+e+" "+n+" bulk loading",t,i.length,V),await this.index._bulk("src_openalex_"+e,i,void 0,void 0,!1,n),i=[]);return i.length&&(D.log("Openalex "+e+" "+n+" bulk loading final set for",t,i.length,d,C,V),await this.index._bulk("src_openalex_"+e,i,void 0,void 0,!1,n)),D.log("removing",t),await fs.unlink(t),C+=1,J.splice(J.indexOf(t),1),!0},v=0,k=(M=await fs.readdir(y)).length;v<k;v++)if(!(G=M[v]).startsWith("manifest")&&(null==t||(z=G.split("=")[1],L.call(t,z)>=0))){for(S=0,j=(F=await fs.readdir(y+"/"+G)).length;S<j;S++)if(m=F[S],a){for(d+=1;5===J.length;)await this.sleep(3e3);h=y+"/"+G+"/"+m,I?D.log("Openalex load would run",h):(J.push(h),D.log("Openalex load running",J),l(h))}else D.log("awaiting catch up",G,m,a),G.includes(a[0])&&(1===a.length||m.includes(a[1]))&&(a=!0);for(;0!==J.length;)await this.sleep(5e3);await fs.rmdir(y+"/"+G)}if(I)try{await fs.unlink(y+"/manifestinfo")}catch(e){}else null!=A&&Array.isArray(t)&&t.length&&await fs.writeFile(y+"/manifestprevious",A);return B={started:$,took:await this.epoch()-$,expected:d,processed:C,total:V,sync:r,last:s,lasth:b,changes:t},(V>0||1===(new Date).getDay())&&(c=await this.datetime(),await this.mail({to:null!=(P=this.S.log)?P.logs:void 0,subject:"Openalex works load or changes "+V+" at "+c,text:JSON.stringify(B)})),D.log(B),B},t.src.openalex.load._bg=!0,t.src.openalex.load._log=!1,t.src.openalex.load._auth="root",t.src.openalex.changes=async function(e){var t,i,r,s,n;if(s=await this.epoch(),D.log("Openalex checking for changes by running load on comparison to manifest"),r=await this.src.openalex.load(void 0,!0),n=(t=await this.epoch())-s,"src.openalex.changes"!==this.fn)for(;n<36e5;)i=36e5-n,D.log("Openalex changes waiting",i,"to loop"),await this.sleep(i),n=(t=await this.epoch())-s;return D.log("Openalex changes took",t-s),r},t.src.openalex.changes._log=!1,t.src.openalex.changes._bg=!0,t.src.openalex.changes._async=!0,t.src.openalex.changes._auth="root",t.src.openalex.sources={_index:!0,_prefix:!1},t.src.openalex.sources.load=async function(){var e,t,i,r,s,n,l,a,o,u;for(await this.src.openalex.sources(""),o=0,e=[],u="https://api.openalex.org/sources?"+((null!=(s=this.S.src.openalex)?s.apikey:void 0)?"api_key="+this.S.src.openalex.apikey+"&":"")+"per-page=200&cursor=",a=await this.fetch(u+"*");null!=a&&"object"==typeof a&&Array.isArray(a.results)&&a.results.length;){for(t=0,i=(n=a.results).length;t<i;t++)(r=n[t])._id=r.id.split("/").pop(),e.push(r);e.length>=2e4?(o+=e.length,await this.src.openalex.sources(e),e=[]):await this.sleep(200),(null!=(l=a.meta)?l.next_cursor:void 0)&&(a=await this.fetch(u+encodeURIComponent(a.meta.next_cursor)))}return e.length&&await this.src.openalex.sources(e),o},t.src.openalex.sources.load._async=!0,t.src.openalex.sources.load._bg=!0,t.src.openalex.hybrid=async function(e){var t,i,r,s,n;if(null==e&&(e=null!=(s=null!=(n=this.params.hybrid)?n:this.params.issn)?s:this.params.issns),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return r='(locations.source.issn.keyword:"'+e.join('" OR locations.source.issn.keyword:"')+'" OR locations.source.issn_l.keyword:"'+e.join('" OR locations.source.issn_l.keyword:"')+'")',t=await this.src.openalex.works.count(r+' AND open_access.oa_status:"closed"'),i=await this.src.openalex.works.count(r+' AND open_access.oa_status:"hybrid"'),t&&i/t>.001},L=[].indexOf,t.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},t.src.pubmed.doi=async function(e){var t;if(null==e&&(e=this.params.doi),e&&(t=await this.src.pubmed('identifier.doi:"'+e+'"',1)))return t},t.src.pubmed.pmc=async function(e){var t;if(null==e&&(e=this.params.pmc),e&&(t=await this.src.pubmed('identifier.pmc:"PMC'+e.toString().toLowerCase().replace("pmc","")+'"',1)))return t},t.src.pubmed.entrez={},t.src.pubmed.entrez.summary=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v;v="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),v+="&id="+i):v+="&query_key="+e+"&WebEnv="+t;try{for(p=await this.convert.xml2json(await this.fetch(v)),h=[],Array.isArray(p.eSummaryResult.DocSum)||(p.eSummaryResult.DocSum=[p.eSummaryResult.DocSum]),f=p.eSummaryResult.DocSum,s=0,o=f.length;s<o;s++){for(r={id:(d=f[s]).Id},m=d.Item,l=0,u=m.length;l<u;l++)if("List"===(n=m[l])._.Type){if(r[n._.Name]=[],null!=n.Item)for(y=n.Item,a=0,c=y.length;a<c;a++)g=y[a],(_={})[g._.Name]=g.$,r[n._.Name].push(_)}else r[n._.Name]=n.$;if(h.push(r),null==i||!i.includes(","))return h[0]}return h}catch(e){}},t.src.pubmed.entrez.pmid=async function(e){var t,i,r;null==e&&(e=this.params.pmid),r="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return await this.sleep(200),t=await this.fetch(r),i=await this.convert.xml2json(t),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey,i.ePostResult.WebEnv)}catch(e){}},t.src.pubmed.search=async function(e,t,i=10,r=!1){var s,n,l,a,o,u,c,p,d,h,f,m;null==e&&(e=null!=(c=this.params.search)?c:this.params.q),m="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof r&&(r=r.split(",")),Array.isArray(r))d={total:r.length,data:[]};else{if(await this.sleep(200),d=await this.fetch(m),d={total:(h=await this.convert.xml2json(d)).eSearchResult.Count[0],data:[]},!0===r)return d.data=h.eSearchResult.IdList[0].Id,d;r=h.eSearchResult.IdList[0].Id}if(t)for(s=0,l=r.length;s<l&&(f=r[s],o=await this.src.pubmed.pmid(f),d.data.push(o),d.data.length!==i);s++);else for(p=await this.src.pubmed.entrez.summary(void 0,void 0,r),n=0,a=p.length;n<a&&(u=p[n],d.data.push(u),d.data.length!==i);n++);return d}catch(e){}},t.src.pubmed.pmid=function(e){null==e&&(e=this.params.pmid);try{return this.src.pubmed.entrez.pmid(e)}catch(e){}},t.src.pubmed.aheadofprint=async function(e){null==e&&(e=this.params.pmid);try{return await this.sleep(100),(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).includes("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){}},t.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},t.src.pubmed.availability=async function(e){var t,i,r,s,n;return null==e&&(e=null!=(t=null!=(i=null!=(r=null!=(s=null!=(n=this.params.pubmed)?n:this.params.availability)?s:this.params.pmc)?r:this.params.pmcid)?i:this.params.PMC)?t:this.params.PMCID),e="pmc"+(e+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(e)},t.src.pubmed.availability.statement=function(e,i){return t.src.epmc.statement(e,i)},t.src.pubmed.load=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m;for(null==e&&"changes"===this.params.load&&(e=!0),f=null!=(c=this.params.streamers)?c:1,l=null!=(p=this.params.howmany)?p:-1,this.refresh&&!e&&await this.src.pubmed(""),i=e?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",s=[],n="number"==typeof this.params.load?this.params.load:"number"==typeof this.params.changes?this.params.changes:void 0,a=0,o=(d=(await this.fetch(i)).split('href="')).length;a<o;a++)(r=d[a].split('"')[0]).endsWith(".gz")&&r.includes(n+".xml")||!n&&r.startsWith("pubmed")&&r.endsWith(".gz")&&("baseline"===this.params.load||this.refresh&&!e||!await this.src.pubmed.count('srcfile:"'+i+r+'"'))?s.push(i+r):r.endsWith(".md5")||D.log("pubmed load skipping file",i+r);for(h=0,m=0,t=async t=>{var i,r,n,a,o,u,c,p,d,f,y,g,_,v,b,w,x,O,k,j,S;D.log("Pubmed loading"+(e?" changes":""),t,s.length,h),u=[],b={};try{for await(g of readline.createInterface({input:(await fetch(t)).body.pipe(zlib.createGunzip())}))if("</PubmedArticle>"===(g=g.trim().replace("&amp;","&"))){if(m+=1,b.srcfile=t,b._id=b.PMID,u.push(b),b={},m===l)break}else if(!(g.startsWith("<?")||g.includes("?xml")||g.includes("!DOCTYPE")||g.includes("/>")||g.includes("PubmedArticle")||g.includes("PubmedData")||g.includes("History")||g.includes("ArticleIdList")||g.includes("List>"))){for(d in g.split(">")[0].split(" ")[0].replace("<",""),f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(g.includes(d)||g.includes(d.replace(">"," ")))&&null==b[v=f[d]]&&(b[v]=g.split(">")[1].split("</")[0]);if(g.includes("<MedlinePgn>"))b.pages=g.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ");else if(g.includes("<ISSN"))null==b.ISSN&&(b.ISSN=[]),S=g.split(">")[1].split("</")[0],L.call(b.ISSN,S)<0&&b.ISSN.push(S);else if(g.includes("<Keyword>"))null==b.keyword&&(b.keyword=[]),S=g.split(">")[1].split("</")[0],L.call(b.keyword,S)<0&&b.keyword.push(S);else if(g.includes("<GeneSymbol>"))null==b.gene&&(b.gene=[]),S=g.split(">")[1].split("</")[0],L.call(b.gene,S)<0&&b.gene.push(S);else if(g.includes("<PublicationType>")||g.includes("<PublicationType "))null==b.type&&(b.type=[]),S=g.split(">")[1].split("</")[0],L.call(b.type,S)<0&&b.type.push(S);else if(g.includes("<Chemical>"))null==b.chemical&&(b.chemical=[]),b.chemical.push({});else if(g.includes("<NameOfSubstance>")||g.includes("<NameOfSubstance "))null==b.chemical&&(b.chemical=[{}]),b.chemical[b.chemical.length-1].name=g.split(">")[1].split("</")[0],b.chemical[b.chemical.length-1].nameID=g.split('UI="')[1].split('"')[0];else if(g.includes("<RegistryNumber>"))null==b.chemical&&(b.chemical=[{}]),b.chemical[b.chemical.length-1].registry=g.split(">")[1].split("</")[0];else if(g.includes("<DataBank>")||g.includes("<DataBank "))null==b.databank&&(b.databank=[]),b.databank.push({});else if(g.includes("<DataBankName>"))null==b.databank&&(b.databank=[{}]),b.databank[b.databank.length-1].name=g.split(">")[1].split("</")[0];else if(g.includes("<AccessionNumber>"))null==b.databank&&(b.databank=[{}]),null==(r=b.databank[b.databank.length-1]).accession&&(r.accession=[]),b.databank[b.databank.length-1].accession.push(g.split(">")[1].split("</")[0]);else if(g.includes("<Grant>")||g.includes("<Grant "))null==b.grant&&(b.grant=[]),b.grant.push({});else if(g.includes("<GrantID>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].id=g.split(">")[1].split("</")[0];else if(g.includes("<Acronym>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].acronym=g.split(">")[1].split("</")[0];else if(g.includes("<Agency>"))null==b.grant&&(b.grant=[{}]),b.grant[b.grant.length-1].agency=g.split(">")[1].split("</")[0];else if(g.includes("<Country>"))b.grant&&!b.grant[b.grant.length-1].country||b.country?b.grant&&b.grant.length&&(b.grant[b.grant.length-1].country=g.split(">")[1].split("</")[0]):b.country=g.split(">")[1].split("</")[0];else if(g.includes("<MeshHeading>")||g.includes("<MeshHeading "))null==b.mesh&&(b.mesh=[]),b.mesh.push({});else if(g.includes("<DescriptorName>")||g.includes("<DescriptorName "))null==b.mesh&&(b.mesh=[{}]),b.mesh[b.mesh.length-1].description=g.split(">")[1].split("</")[0],b.mesh[b.mesh.length-1].descriptionID=g.split('UI="')[1].split('"')[0];else if(g.includes("<QualifierName>")||g.includes("<QualifierName "))null==b.mesh&&(b.mesh=[{}]),null==(n=b.mesh[b.mesh.length-1]).qualifier&&(n.qualifier=[]),b.mesh[b.mesh.length-1].qualifier.push({name:g.split(">")[1].split("</")[0],id:g.split('UI="')[1].split('"')[0]});else if(g.includes("<Author>")||g.includes("<Author ")||g.includes("<Investigator>")||g.includes("<Investigator "))null==b.author&&(b.author=[]),b.author.push(g.includes("<Investigator")?{investigator:!0}:{});else if(g.includes("<LastName>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].lastname=g.split(">")[1].split("</")[0];else if(g.includes("<ForeName>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].firstname=g.split(">")[1].split("</")[0];else if(g.includes("<Affiliation>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].affiliation=g.split(">")[1].split("</")[0];else if(g.includes("<Identifier>"))null==b.author&&(b.author=[{}]),b.author[b.author.length-1].identifier=g.split(">")[1].split("</")[0];else if(g.includes("<Note>")||g.includes("<Note ")||g.includes("<GeneralNote>")||g.includes("<GeneralNote "))null==b.notes&&(b.notes=[]),b.notes.push(g.split(">")[1].split("</")[0]);else if(g.includes("<DeleteCitation>")||g.includes("<DeleteCitation "))b.deletedFromMedline=!0;else if(g.includes("<ArticleId>")||g.includes("<ArticleId ")){null==b.identifier&&(b.identifier={});try{c=g.split('IdType="')[1].split('"')[0],null==(a=b.identifier)[c]&&(a[c]=g.split(">")[1].split("</")[0])}catch(e){}}else if(!g.includes("</")&&(g.includes("Date>")||g.includes("<Date")||g.includes("<PubMedPubDate")||g.includes("<ArticleDate>")||g.includes("ArticleDate ")||g.includes("<PubDate>")||g.includes("<PubDate "))){k=g.split(">")[0].split(" ")[0].replace("<","");try{(_=g.toLowerCase()).includes("pubstatus")&&(j=_.split(">")[0].split("pubstatus")[1]),j.includes('"')&&(j=j.split('"')[1])}catch(e){}}else if(k&&(g.includes("<Year>")||g.includes("<Month>")||g.includes("<Day>"))){null==b.dates&&(b.dates={}),O=k+(j?"_"+j:""),null==(o=b.dates)[O]&&(o[O]={}),b.dates[O][g.split(">")[0].replace("<","").toLowerCase()]=g.split(">")[1].split("</")[0],delete b.dates[O].date,delete b.dates[O].timestamp;try{b.dates[O]=await this.dateparts(b.dates[O])}catch(e){}try{j&&(b.dates[O].pubstatus=j)}catch(e){}}else if(k&&g.includes("</"+k))k="",j="";else if(g.includes("<Reference>")||g.includes("<Reference "))null==b.references&&(b.references=[]);else if(g.includes("<Citation")){null==b.references&&(b.references=[]),x={author:[]};try{for(w=g.split(". ")[0].split(", "),p=0,y=w.length;p<y;p++)i=w[p],x.author.push({name:i})}catch(e){}try{x.title=g.split(". ")[1].split("?")[0].trim()}catch(e){}try{x.journal=g.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{g.includes("doi.org/")&&(x.doi=g.split("doi.org/")[1].split(" ")[0].trim())}catch(e){}try{x.url="http"+rc.split("http")[1].split(" ")[0]}catch(e){}"{}"!==JSON.stringify(x)&&b.references.push(x)}}u.length&&(await this.src.pubmed(u),D.log(t,m))}catch(e){}return h-=1};s.length&&!(l>0&&m>=l);)await this.sleep(1e3),h<f&&(h+=1,u=s.shift(),await t(u));return D.log(m,s.length),this.params.howmany?batch:m},t.src.pubmed.load._bg=!0,t.src.pubmed.load._log=!1,t.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},t.src.pubmed.changes._bg=!0,t.src.pubmed.changes._log=!1,t.src.pubmed.changes._notify=!1,L=[].indexOf,t.src.rs={_index:!0,_prefix:!1},t.src.rs.retrieve=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A;for await(y of(p=this.params.max,k=this.params.retrieve,I=this.params.save,x=this.params.refresh,f=null==(g=this.params.plus)||g,c=null!=(_=this.params.limit)?_:500,(r=this.params.empty)&&await this.src.rs(""),m=null!=(v=this.params.q)?v:'prefix.keyword:"10.21203" AND DOI:"v1" AND type.keyword:"posted-content"',h={include:["DOI"],scroll:"30m"},!e||this.params.q&&!this.params.since||("string"==typeof e&&e.includes(" ")&&(e=await this.epoch(e.replace(" ","T"))),m+=" AND created.timestamp:>"+e),(O={started:A=Date.now(),ended:void 0,took:void 0,limit:c,empty:r,since:e,q:m,expected:0,total:0,refresh:x,existed:void 0,existing:0,local:0,tried:0,retrieved:0,max:p,save:I,saved:0,confirm:0}).expected=await this.src.crossref.works.count(m),O.existed=await this.report.works.count('DOI:"10.21203" AND DOI:"v1"'),i=[],this.index._for("src_crossref_works",m,h))){if(p&&O.tried>=p||k&&O.tried>=k)break;if(O.total+=1,(j=y.DOI.split(".").pop()).startsWith("rs-")||(j="rs-"+j),S="https://www.researchsquare.com/api/article/"+j,O.total%100==0?(O.took=Date.now()-A,D.log(S),D.log(O)):p<=10&&D.log(S),x||f||!await this.report.works(y.DOI))if(x||r||!await this.src.rs('identity.keyword:"'+j+'"',1)){if(O.tried+=1,(t=await this.fetch(S))&&(await this.sleep(O.limit),t.identity===j.split("/")[0])){try{t=JSON.parse(JSON.stringify(t).replace(/""/g,"null"))}catch(e){s=e,D.log(t),D.log(s,typeof t)}for(n=0,o=(b=["nonDraftVersions"]).length;n<o;n++)t[a=b[n]]=JSON.stringify(t[a]);for(l=0,u=(w=["declarations"]).length;l<u;l++)"object"!=typeof t[d=w[l]]&&delete t[d];null==t.updatedAt||t.updatedAt||delete t.updatedAt,O.retrieved+=1,t.DOI=y.DOI.toLowerCase(),t._id=t.DOI.replace(/\//g,"_"),i.push(t)}}else p<=10&&D.log(y.DOI,"already exists in local RS"),O.local+=1;else p<=10&&D.log(y.DOI,"already exists in report/works"),O.existing+=1;i.length>=500&&(!1!==I&&await this.src.rs(i),O.saved+=i.length,i=[])}return i.length&&(!1!==I&&await this.src.rs(i),O.saved+=i.length,i=[]),await this.sleep(5e3),O.confirm=await this.src.rs.count(),O.ended=Date.now(),O.took=O.ended-A,D.log(O),await this.mail({to:this.S.log.logs,subject:"Report RS retrieved "+O.retrieved,text:JSON.stringify(O,"",2)}),O},t.src.rs.retrieve._log=!1,t.src.rs.retrieve._bg=!0,t.src.rs.retrieve._async=!0,t.src.rs.retrieve._auth="@oa.works",t.src.rs.changes=async function(e){var t;return null==e&&(e=null!=(t=this.params.changes)?t:this.params.since),e||(e=(await this.src.rs("*",{sort:"createdAt.keyword:desc",size:1})).createdAt),D.log("Running report RS retrieve for new crossref records since",e),await this.src.rs.retrieve(e)},t.src.rs.changes._log=!1,t.src.rs.changes._bg=!0,t.src.rs.changes._async=!0,t.src.rs.changes._auth="@oa.works",t.src.rs.check=async function(){var e,t,i,r,s,n,l,a,o;for(o={rows:0,checked:0,failed:[],found:0,not_found:[],dups:0,ids:[]},l=this.params.max,r=0,n=(a=(await fs.readFile(this.S.static.folder+"/rscheck.csv","utf8")).split("\n")).length;r<n&&(e=a[r],!(l&&o.rows>=l));r++)o.rows+=1,e&&((s=e.replace("10.21203/","").split("/v")[0].split(".").pop())&&!s.startsWith("rs-")&&(s="rs-"+s),t=e+"_("+s+")",(l||o.rows%50==0)&&D.log(o.rows,e,s),s?(L.call(o.ids,t)>=0?o.dups+=1:o.ids.push(t),o.checked+=1,(i=await this.src.rs('identity.keyword:"'+s+'"'))?(D.log(i.identity,"exists in report/rs"),o.found+=1):(o.not_found.push("("+o.rows+")_"+t),D.log(t,"not found in report/rs"))):o.failed.push("("+o.rows+")_"+t));return o},t.src.ror={_index:!0,_prefix:!1},t.src.ror.query=function(e){var t;if(null==e&&(e=null!=(t=this.params.query)?t:this.params.q),"string"==typeof e)return this.fetch('https://api.ror.org/organizations?query="'+e+'"')},t.src.ror.ror=async function(e,t){var i,r,s;if(null==t&&(t=this.refresh),null==e&&(e=this.params.ror),"string"==typeof e&&!e.includes(" ")&&(e=e.split("/").pop()).length<11){if((null!=(r=t?void 0:await this.src.ror(e))?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.fetch("https://api.ror.org/organizations/"+e))?r.id:void 0)return s=await this.src.ror._format(r),this.waitUntil(this.src.ror(s)),s}},t.src.ror.grid=async function(e){var t,i,r,s;if(null==e&&(e=this.params.grid),"string"==typeof e&&e.startsWith("grid.")){if((null!=(r=await this.src.ror('external_ids.GRID.all:"'+e+'"'))?r.id:void 0)||1===(null!=r&&null!=(t=r.hits)?t.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(e))&&null!=(i=r.items)?i[0]:void 0)return s=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(s)),s}},t.src.ror.title=async function(e){var t,i,r,s,n;if(null==e&&(e=null!=(t=this.params.title)?t:this.params.q),"string"==typeof e){if(this.refresh||(s=await this.src.ror('title:"'+e+'"')),(null!=s?s.id:void 0)||1===(null!=s&&null!=(i=s.hits)?i.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(e))&&null!=(r=s.items)?r[0]:void 0)return n=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(n)),n}},t.src.ror._format=async function(e,t){try{e._id=e.id.split("/").pop()}catch(e){}return null==e.createdAt&&(e.createdAt=null!=t?t:await this.epoch()),e},t.src.ror.dumps=function(){return this.fetch("https://zenodo.org/api/records/?communities=ror-data&sort=mostrecent")},t.src.ror.load=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y;null==e&&(e=this.refresh),m=0,t=[];try{n=await this.src.ror.dumps(),null==e&&(o=await this.epoch(n.hits.hits[0].created.split("+")[0]),null!=(null!=(a=await this.src.ror("src:*",{sort:{createdAt:"desc"},size:1}))?a.hits:void 0)&&(a=a.hits.hits[0]._source))}catch(e){}if(D.log(o,null!=a?a.createdAt:void 0,null!=a?a.src:void 0),e||null==a||null==o||null!=a&&null!=o&&a.createdAt<o)for await(u of(l=n.hits.hits[0].files[0].links.self,D.log(l),i=await this.epoch(),f=!1,s=!1,c="",r=l.replace("/content","").split("/").pop(),h=this.S.directory+"/import/ror/"+r,d=await fetch(l),y=fs.createWriteStream(h),await new Promise(((e,t)=>(d.body.pipe(y),d.body.on("error",t),y.on("finish",e)))),await this._child("unzip",[h,"-d",this.S.directory+"/import/ror/"]),D.log("ROR snapshot downloaded"),await this.src.ror(""),readline.createInterface({input:fs.createReadStream(h.replace(".zip",".json"))})))try{f||5!==u.length||"{"!==u.replace(/\s\s\s\s/,"")?s||5!==u.replace(",","").length||"}"!==u.replace(/\s\s\s\s/,"").replace(",","")?"["!==u&&"]"!==u&&(c+=u):(s=!0,c+="}"):(f=!0,c="{"),!0===f&&!0===s&&(f=!1,s=!1,(p=await this.src.ror._format(JSON.parse(c),i)).src=l,null==p.createdAt&&(p.createdAt=i),c="",m+=1,t.push(p),2e4===t.length&&(D.log("ROR bulk loading",t.length,m),await this.src.ror(t),t=[]))}catch(e){}return t.length&&await this.src.ror(t),D.log(m),m},t.src.ror.load._bg=!0,t.src.ror.load._async=!0,t.src.ror.load._auth="root",null==(x=r.src).zenodo&&(x.zenodo={});try{r.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(e){}t.src.zenodo={deposition:{},records:{}},t.src.zenodo.records.search=function(e,t){var i,r,s;return null==e&&(e=this.params),null==t&&(t=this.params.dev),r=null!=(i=this.params.size)?i:10,s="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+r+"&q="+encodeURIComponent(e),this.fetch(s)},t.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},t.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){}},t.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},t.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},t.src.zenodo.records.format=function(e){var t,i,r,s,n,l,a,o,u,c,p;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=e.metadata.description}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,s=0,l=c.length;s<l;s++)if("pdf"===(r=c[s]).type){null==o.pdf&&(o.pdf=r.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),p=e.metadata.creators,n=0,a=p.length;n<a;n++){if("string"==typeof(t=p[n])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},t.src.zenodo.deposition.create=async function(e,t,i,r){var s,n,l,a,o,u,c,p,d;return null==r&&(r=null!=(l=this.params.dev)?l:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=r?null!=(a=this.S.src)&&null!=(o=a.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(d="https://"+(r?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(n={metadata:e}).metadata.upload_type||(n.metadata.upload_type="publication",n.metadata.publication_type="article"),null==(s=n.metadata).creators&&(s.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(p=await this.fetch(d,{method:"POST",body:n,mode:"cors",credentials:"include",headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))?p.id:void 0)&&(t.content||t.file)&&(p.uploaded=await this.src.zenodo.deposition.upload(p.id,t.content,t.file,t.name,t.url,i,r)),t.publish&&(p.published=await this.src.zenodo.deposition.publish(p.id,i,r)),p):await this.fetch(d,{method:"POST",body:n,headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.upload=async function(e,t,i,r,s,n,l){var a,o,u,c;if(null==e&&(e=null!=(a=this.params.upload)?a:this.params.id),null==t&&(t=this.params.content),null==r&&(r=this.params.filename),!t&&!i)try{i=this.request.files[0]}catch(e){}if(s&&!t&&!i)try{t=await this.fetch(s,{buffer:!0,headers:{referer:this.S.dev||l?"https://sandbox.zenodo.org":"https://zenodo.org"}})}catch(e){}return null==n&&(n=this.params.token),null==n&&(n=this.S.dev||l?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==l&&(l=this.params.dev),null!=n&&null!=e&&(s="https://"+(this.S.dev||l?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+n,this.fetch(s,{file:null!=t?t:i,filename:r,headers:{referer:this.S.dev||l?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.publish=function(e,t,i){var r,s,n,l,a;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src)&&null!=(l=n.zenodo)?l.token:void 0),null!=t&&null!=e&&(a="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(a,{method:"POST",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.delete=async function(e,t,i){var r,s,n,l;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src.zenodo)?n.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(l,{method:"DELETE",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}),!0)},t.blacklist=async function(e){var t,i,r,s,n,l,a,o;if(null==e&&(e=this.params.url),"number"==typeof e&&(e=e.toString()),null!=e&&(e.length<4||-1===e.indexOf(".")))return!1;for(i=[],s=0,l=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;s<l;s++)r=o[s],i.push(r.url.toLowerCase());if(e){if(!e.startsWith("http")&&e.includes(" "))return!1;for(n=0,a=i.length;n<a;n++)if(t=i[n],e.includes(t.toLowerCase()))return!0;return!1}return i},t.bug=function(){var e,t,i,r,s,n,l,a,o,u,c;if(this.params.contact)return"";for(e in c=["help@oa.works"],u="",this.params)u+=e+": "+JSON.stringify(this.params[e],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(r=this.params)?r.form:void 0)?o+=" Wrong article":"bug"===(null!=(s=this.params)?s.form:void 0)?o+=" Bug":"general"===(null!=(n=this.params)?n.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(l=null!=(a=this.params)?a.form:void 0)&&"uninstall"!==l||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:t=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:t}},t.cache=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==e&&(e=this.request);try{for(d=e.url.toString(),a=0,o=(u=["refresh"]).length;a<o;a++)n=u[a],-1!==d.indexOf(n+"=")&&(l=new RegExp(n+"=.*?&"),d=d.replace(l,"")),-1!==d.indexOf("&"+n+"=")&&(d=d.split("&"+n+"=")[0]);s=new URL(d)}catch(e){}}catch(e){}if(null!=e)try{if(null==s&&(s=new URL(e.url)),r=new Request(s.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t)return p=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),p;t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,c))}catch(e){}}},t.cache._auth="system",L=[].indexOf,null==t.convert&&(t.convert={}),t.convert.json2csv=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O;if(null==e&&(e=null!=(m=this.body)?m:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(y=e.hits)?y.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),p=null!=(g=t.quote)?g:'"',O=null!=(_=t.separator)?_:",",u=null!=(v=t.newline)?v:"\n",e.length){for(r=null!=(b=t.keys)?b:[],f="",s=0,a=e.length;s<a;s++){if(h=e[s],f.length&&(f+=u),!1!==t.es&&(h._source||h.fields)){for(c in d={},x=null!=(w=h._source)?w:h.fields)null==d[c]&&(d[c]=x[c]);h=d}if(t.flatten&&(h=await this.flatten(h)),t.subset&&(h=await this.dot(h,t.subset)),!t.keys)for(l in h)null!=h[l]&&L.call(r,l)<0&&r.push(l);for(n=0,o=r.length;n<o;n++){if(i=r[n],f.length&&!f.endsWith(u)&&(f+=O),f+=p,null!=h[i]){try{Array.isArray(h[i])&&1===h[i].length&&Array.isArray(h[i][0])&&(h[i]=h[i][0])}catch(e){}try{Array.isArray(h[i])&&h[i].length&&"object"!=typeof h[i][0]&&(h[i]=h[i].join(","))}catch(e){}try{"object"==typeof h[i]&&(h[i]=JSON.stringify(h[i]))}catch(e){}try{'"'===p&&-1!==h[i].indexOf(p)&&(h[i]=h[i].replace(/"/g,p+p))}catch(e){}try{h[i]=h[i].replace(/\n/g," ")}catch(e){}try{h[i]=h[i].replace(/\s\s/g," ")}catch(e){}try{f+=h[i]}catch(e){}}f+=p}}return p+r.join(p+O+p)+p+"\n"+f}return""},t.convert.csv2json=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w;if(null==t&&(t=this.params),null==e&&(e=null!=(h=this.body)?h:this.params.csv),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(f=t.url)?f:e)),_=[],"string"==typeof e&&e.length&&(d=null!=(m=t.quote)?m:'"',b=null!=(y=t.separator)?y:",",c=null!=(g=t.newline)?g:"\n",(u=e.split(c)).length))for(r=u.shift().split(d+b),p="",s=0,l=u.length;s<l;s++)if((w=(p+=(p?c:"")+(o=u[s])).split(d+b)).length===r.length&&(!d||o.endsWith(d))){for(p="",v={},n=0,a=r.length;n<a;n++)if((i=r[n]).startsWith(d)&&(i=i.replace(d,"")),i.endsWith(d)&&(i=i.substring(0,i.length-1)),w.length&&(v[i]=w.shift(),v[i])){v[i].startsWith(d)&&(v[i]=v[i].replace(d,"")),!w.length&&v[i].endsWith(d)&&(v[i]=v[i].substring(0,v[i].length-1));try{v[i]=JSON.parse(v[i])}catch(e){}}_.push(v)}return _},t.convert.csv2html=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g;if(null==e&&(e=null!=(p=this.body)?p:this.params.csv),null==t&&(t=this.params),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(d=t.url)?d:e)),'"',m="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",m+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(o=e.split("\n")).length){for(m+="<thead><tr>",u=0,i=0,s=(h=o.shift().split('","')).length;i<s;i++)m+='<th style="padding:2px; border:1px solid #ccc;">'+h[i].replace(/"/g,"")+"</th>",u+=1;for(m+="</tr></thead>\n<tbody>\n",r=0,n=o.length;r<n;r++){for(a=o[r],m+="<tr>";-1!==a.indexOf(',"",');)a=a.replace(',"",',',"XXX_EMPTY_XXX",');for(;a.startsWith('"",');)a=a.replace('"",','"XXX_EMPTY_XXX",');for(;a.endsWith(',""');)a=a.slice(0,a.length-3);for(g=0,c=0,l=(f=(a=a.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<l;c++)g+=1,m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(y=(y=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===y.indexOf("{")||0===y.indexOf("[")?(m+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",m+=await this.convert.json2html(JSON.parse(y.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),m+="</div>"):m+=y.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),m+="</td>";for(;g<u;)m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',g+=1;m+="</tr>\n"}m+="</tbody>\n"}return m+"</table>"},t.convert.json2html=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d;if(null==e&&(e=null!=(u=this.body)?u:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.new)for(null==t.edit&&(t.edit=!0),e={},r=0,n=(c=await this.index.keys(this.route.replace(/\//g,"_"))).length;r<n;r++)e[c[r]]="";if(t.subset&&!Array.isArray(e))for(o=t.subset.split(".");(a=o.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[a];)e=e[a];if(Array.isArray(e)||null!=(null!=e&&null!=(p=e.hits)?p.hits:void 0)&&!1!==t.es)return null!=o&&(t.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(e,t));if(d="<div>",t.flatten&&(e=await this.flatten(e),d+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(o.length)for(s=0,l=o.length;s<l;s++)e=e[o[s]];d+="<h3>"+t.subset+":</h3>",d+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return i=e=>{var r,s,n,l,a,o,u,c,p,h,f;if(t.edit&&null==e.comments&&(e.comments=""),t.keys)for(l=0,s=(c=t.keys).length;l<s;l++)null==e[u=c[l]]&&(e[u]="");for(r in h=[],e){try{Array.isArray(e[r])&&1===e[r].length&&Array.isArray(e[r][0])&&(e[r]=e[r][0])}catch(e){}if(null==e[r]||Array.isArray(e[r])&&!e[r].length||t.keys&&!(L.call(t.keys,r)>=0))h.push(void 0);else{if(d+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+r+"</p></b></div>",d+='<div style="float:left;">',d+=t.edit?'<textarea class="PForm" id="'+r+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[r]))if("object"==typeof e[r][0])for(a=0,n=(p=e[r]).length;a<n;a++)o=p[a],i(o);else{try{f=e[r].join(", ")}catch(t){try{f=JSON.stringify(e[r])}catch(t){f=e[r]}}try{d+=(t.edit?"":"<p>")+f+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[r]?i(e[r]):d+=(t.edit?"":"<p>")+e[r]+(t.edit?"":"</p>");d+=t.edit?"</textarea>":"",h.push(d+="</div></div>")}}return h},i(e),d+="</div>"},t.convert.json2txt=async function(e){var t,i,r;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),r=[],t=async function(e){var i,s,n,l,a;if(Array.isArray(e)){for(l=[],s=0,n=e.length;s<n;s++)i=e[s],l.push(await t(i));return l}if("object"==typeof e){for(i in a=[],e)a.push(await t(e[i]));return a}if(e)return r.push(e)},await t(e),r.join(" ")},t.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},t.convert.hex2bin=function(e){var i,r,s,n,l;for(l=[],i=0,s=(n=Array.isArray(e)?e:[e]).length;i<s;i++)r=n[i],l.push(t.convert._hexMatch[r.toLowerCase()]);return l.join("")},t.convert.bin2hex=function(e){var i,r,s,n,l,a,o,u,c;if(!Array.isArray(e)){for(i=[],c=e.split(""),o="";c.length;)4===(o+=c.shift()).length&&(i.push(o),o="");e=i}for(n in u=[],r={},t.convert._hexMatch)r[t.convert._hexMatch[n]]=n;for(s=0,a=e.length;s<a;s++)l=e[s],u.push("0x"+r[l]);return new C(u).toString()},t.convert.buf2bin=async function(e){var i,r;for(C.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),r="",i=0;i<e.length;)r+=await t.convert.hex2bin(e[i]),i++;return r},t.convert.stream2txt=function(e){var t;return t=[],new Promise(((i,r)=>(e.on("data",(e=>t.push(C.from(e)))),e.on("error",(e=>r(e))),e.on("end",(()=>i(C.concat(t).toString("utf8")))))))},t.convert.xml2json=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h,f,m,y;if(null==e&&(e=null!=(d=this.params.xml2json)?d:this.params.url),f={},"string"==typeof e)for(e.startsWith("http")&&(e=await this.fetch(e)),i="",u="",m=!1,r=!1;t=e[0];)if(e=e.slice(1),"\ufeff"!==t&&"\t"!==t&&"\r"!==t&&"\n"!==t&&(" "!==t||i.length&&!i.endsWith(">"))&&("<"===i&&"/"!==t&&"?"!==t&&"!"!==t&&(m=!0),((i+=t).endsWith("</")&&i.split("</").length-1===i.split(">").length||i.endsWith("/>")&&!i.split("/>")[0].includes(">"))&&(r=!0),">"===t)){if(D.log(u),r){if(r=!1,""!==(i=i.split("</")[0])){if(p=await this.dot(f,u,void 0,void 0,!0))Array.isArray(p)?(p.length||(p=[{}]),null!=p[p.length-1].$?(Array.isArray(p[p.length-1].$)||(p[p.length-1].$=[p[p.length-1].$]),p[p.length-1].$.push(i)):p[p.length-1].$=i):p.$=i,i=p;else{i={$:i};try{(c=await this.dot(f,u.slice(0,u.lastIndexOf(".")),void 0,void 0,!0))&&(i._=c[u.split(".").pop()]._)}catch(e){}}"object"==typeof i&&null==i._&&null!=i.$&&(i=i.$),await this.dot(f,u,i,void 0,!0)}u=u.includes(".")?u.slice(0,u.lastIndexOf(".")):""}else if(m){for(m=!1,a={},s=0,l=(h=i.replace("<","").replace(">","").split(" ")).length;s<l;s++)(o=h[s]).includes("=")?o.length&&([n,y]=o.split("="),a[n.trim().replace(/"/g,"")]=y.trim().replace(/"/g,"")):u+=(u&&!u.endsWith(".")?".":"")+o;(p=await this.dot(f,u,void 0,void 0,!0))?(Array.isArray(p)||(p=[p]),p.push("{}"!==JSON.stringify(a)?{_:a}:{}),await this.dot(f,u,p,void 0,!0)):"{}"!==JSON.stringify(a)&&await this.dot(f,u+"._",a,void 0,!0)}i=""}return f},t.dateparts=async function(e){var t,i,r,s,n,l,a,o,u,c,p;t={},null==e&&(e=null!=(n=this.params.dateparts)?n:t.date);try{if("object"==typeof e){for(i in e)t[i]=e[i];e=null!=(l=t.date)?l:""}else if(null==e){for(i in params)null==t[i]&&(t[i]=this.params[i]);e=null!=(a=t.date)?a:""}if(("number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))&&(e=await this.date(e)),e.includes("T")&&e.includes("-")&&(e=e.split("T")[0]),(e=(e=e.trim().toLowerCase().replace(", "," ").replace(" of ","").replace("st "," ").replace("nd "," ").replace("rd "," ").replace("th "," ")).replace(/-/g," ").replace(/\//g," ")).includes(" "))for(i in s=e.split(" "))(r=s[i]).includes(":")||(r.length>=3?isNaN(parseInt(r))?(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(r.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""):t.year=r:parseInt(r)<13&&(2===s.length||3===s.length&&"1"===i)?t.month=r:1===s.length?t.year=r:t.day=r);t.day=(null!=(o=t.day)?o:"01").toString(),1===t.day.length&&(t.day="0"+t.day),"string"==typeof t.month&&t.month.length&&isNaN(parseInt(t.month))&&(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(t.month.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""),t.month=(null!=(u=t.month)?u:"01").toString(),1===t.month.length&&(t.month="0"+t.month),t.year=t.year.toString(),2===t.year.length&&(t.year=parseInt(t.year)<30?"20":"19"+t.year),"31"!==t.day||"04"!==(c=t.month)&&"06"!==c&&"09"!==c&&"11"!==c||(t.day="30"),"02"===t.month&&("30"===(p=t.day)||"31"===p||"29"===t.day&&parseInt(t.year)%4)&&(t.day="28"),t.date=t.year+"-"+t.month+"-"+t.day;try{t.timestamp=await this.epoch(t.date)}catch(e){}}catch(e){}return t},t.dateparts._cache=!1,t.date=function(e,t,i=!0,r=!0){var s,n,l,a,o;if(null==e&&(e=null!=(l=this.params.date)?l:Date.now()),null==t&&(t=this.params.time),"number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))try{return o=(o=new Date(parseInt(e))).toISOString(),t?i?r||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(e){}try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(s in e)"number"!=(a=typeof e[s])&&"string"!==a&&(e[s]="01");e=e.join("-")}catch(e){}return(e=decodeURIComponent(e)).includes("T")&&(e=e.split("T")[0]),(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).includes("-")||(e+="-01-01"),3!==e.split("-").length&&(e+="-01"),3!==(n=e.split("-")).length&&(e=void 0),n[0].length<n[2].length&&(e=n.reverse().join("-")),e}catch(e){}},t.date._cache=!1,t.datetime=function(e,t){var i,r;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(r=null!=e?e:this.params.secs)?r:this.params.s,null!=t?t:this.params.ms)},t.datetime._cache=!1,t.epoch=function(e){var t,i,r,s,n,l;if(null==e&&(e=this.params.epoch),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&e.includes("/")&&(3===(r=e.split("/")).length&&4===r[2].length&&r.reverse(),e=r.join("-")),!e)return Date.now();if(!(e.startsWith("+")||e.startsWith("-")||2===e.split("+").length&&e.split("+")[0].length>4||2===e.split("-").length&&e.split("-")[0].length>4)){if(e.length>8&&!e.includes("-")&&!isNaN(parseInt(e)))return this.date(e,null==(s=this.params.time)||s);for(4===e.length&&(e+="-01"),e.split("-").length<3&&(e+="-01"),e.includes("T")||(e+="T"),e.includes(":")||(e+="00:00"),e.split(":").length<3&&(e+=":00"),e.includes(".")||(e+="."),[n,i]=e.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return i.includes("Z")||(i+="Z"),new Date(n+"."+i).valueOf()}return(e.startsWith("+")||e.startsWith("-"))&&(e=Date.now()+e),e.includes("+")?([e,t]=e.replace("/","").split("+"),(parseInt(e)+parseInt(t)).toString()):e.includes("-")?([e,l]=e.replace("/","").split("-"),(parseInt(e)-parseInt(l)).toString()):void 0},t.epoch._cache=!1,t.uid=function(t){var i,r,s,n,l,a,o,u,c,p,d;return null==t&&(t="uid"===this.fn&&null!=(i=null!=(r=null!=(s=null!=(n=null!=this&&null!=(l=this.params)?l.len:void 0)?n:null!=this&&null!=(a=this.params)?a.length:void 0)?s:null!=this&&null!=(o=this.params)?o.size:void 0)?r:null!=this&&null!=(u=this.params)?u.uid:void 0)?i:21),"string"==typeof t&&(d=parseInt(t),t=isNaN(d)?void 0:d),((t,i=21)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,s=-~(1.6*r*t/e.length);return(n=t)=>{let l="";for(;;){let t=i(s),a=s;for(;a--;)if(l+=e[t[a]&r]||"",l.length===n)return l}}})(t,i,e))(null!=(c=null!=this&&null!=(p=this.params)?p.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",t)()},t.uid._cache=!1,t.encrypt=async function(e){var t,i,r,s,n,l;null==e&&(e=null!=(i=null!=(r=null!=(s=null!=(n=this.params.encrypt)?n:this.params.content)?s:this.params.q)?r:this.params)?i:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createCipheriv("aes-256-ctr",this.S.encrypt.salt,null!=(l=this.params.iv)?l:this.S.encrypt.iv),C.concat([t.update(e),t.final()]).toString("hex")},t.encrypt._cache=!1,t.encrypt._bg=!0,t.decrypt=async function(e){var t,i,r,s,n,l,a;null==e&&(e=null!=(r=null!=(s=null!=(n=null!=(l=this.params.decrypt)?l:this.params.content)?n:this.params.q)?s:this.params)?r:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"object"==typeof e?(i=e.iv,e=e.content):i=null!=(a=this.params.iv)?a:this.S.encrypt.iv,"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createDecipheriv("aes-256-ctr",this.S.encrypt.salt,i),C.concat([t.update(C.from(e,"hex")),t.final()]).toString()},t.decrypt._cache=!1,t.decrypt._bg=!0,t.decrypt._auth="@oa.works",t.hash=async function(e){var t,i,r,s,n,l,a,o,u,c;null==e&&(e=null!=(a=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?a:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(r),l=[],s=0,n=t.length;s<n;s++)i=t[s],l.push(("00"+i.toString(16)).slice(-2));return l.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},t.hashcode=function(e){var t,i,r,s,n,l;for(null==e&&(e=null!=(r=null!=(s=null!=(n=null!=(l=this.params.hashcode)?l:this.params.content)?n:this.params.q)?s:this.params)?r:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),t=0,i=0;i<e.length;)t=(t<<5)-t+e.charCodeAt(i),t&=t,i++;return t},t.hashhex=function(e){var t;return null==e&&(e=this.params.hashhex),(t=this.hashcode(e))<0&&(t=4294967295+t+1),t.toString(16)},t.shorthash=function(e,t){var i,r,s,n,l,a,o,u;for(null==e&&(e=null!=(s=null!=(n=null!=(l=null!=(a=this.params.shorthash)?a:this.params.content)?l:this.params.q)?n:this.params)?s:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),r=this.hashcode(e),t?(u=t.substring(0,1),t=t.replace(u,"")):(t="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=t.length,o=r<0?u:"",r=Math.abs(r);r>=i;)o+=t[r%i],r=Math.floor(r/i);return o+(r>0?t[r]:"")},t.fetch=async function(e,t){var i,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,L,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X;if(null==e&&null==t)try{t=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==t&&(e=(t=e).url),null==t&&(t={}),"number"==typeof t&&(t={cache:t}),"number"==typeof t.cache&&(null==t.cf&&(t.cf={cacheEverything:!0}),t.cf.cacheTtl=t.cache,delete t.cache),!e&&t.url&&(e=t.url,delete t.url),!0===t.bg&&"string"==typeof r.bg&&(t.url=e,e=r.bg+"/fetch",delete t.bg),t.username&&t.password&&(t.auth=t.username+":"+t.password,delete t.username,delete t.password),e.split("?")[0].includes("@")&&e.includes(":")&&e.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(t.auth=e.split("//")[1].split("@")[0],e=e.replace(t.auth+"@","")),t.auth&&(null==t.headers&&(t.headers={}),t.headers.Authorization="Basic "+C.from(t.auth).toString("base64"),delete t.auth),p=0,m=(N=["data","content","json"]).length;p<m;p++)null!=t[l=N[p]]&&(t.body=t[l],delete t[l]);if(null==t.attachment&&(t.attachment=t.attachments),null==t.file&&(t.file=t.attachment),null!=t.file){for(null==t.headers&&(t.headers={}),null!=t.body&&null==t.form&&(t.form=t.body),t.body=new FormData,Array.isArray(t.file)||(u="object"==typeof t.file&&null!=t.file.file?[{file:t.file.file,filename:null!=(E=null!=(q=t.file.filename)?q:t.file.name)?E:t.filename}]:[{file:t.file,filename:t.filename}],t.file=u),d=0,y=(W=t.file).length;d<y;d++)null==(null!=(c=W[d])?c.file:void 0)&&null==(null!=c?c.data:void 0)||t.body.append(null!=t.attachment?"attachment":"file",null!=(U=c.file)?U:c.data,null!=(M=null!=(z=null!=(F=c.filename)?F:c.name)?z:t.filename)?M:"file");delete t.filename,null==t.method&&(t.method="POST")}else null!=t.body&&(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="object"==typeof t.body?"application/json":"text/plain"),"object"!=(B=typeof t.body)&&"boolean"!==B&&"number"!==B||(t.body=JSON.stringify(t.body)),null==t.method&&(t.method="POST"));if(null!=t.form){if(null!=t.file){if("object"==typeof t.form)for(o in t.form)for(f=0,g=(J=Array.isArray(t.form[o])?t.form[o]:[t.form[o]]).length;f<g;f++)s=J[f],t.body.append(o,"object"==typeof s?JSON.stringify(s):s)}else{if(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof t.form){for(k in j="",t.form)for(""!==j&&(j+="&"),b=0,_=(P=Array.isArray(t.form[k])?t.form[k]:[t.form[k]]).length;b<_;b++)null!=(S=P[b])&&(j.endsWith("&")||(j+="&"),j+=k+"="+encodeURIComponent("object"==typeof S?JSON.stringify(S):S));t.form=j}t.body=t.form}delete t.form,null==t.method&&(t.method="POST")}if(delete t.file,delete t.attachment,delete t.attachments,"string"!=typeof e);else{if(!e.startsWith("http:")&&e.includes("localhost"))try{null==t.agent&&(t.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(e.includes("?")){for(O=(A=e.split("?")).shift()+"?",w=0,v=(R=A.join("?").split("&")).length;w<v;w++)L=R[w],O.endsWith("?")||(O+="&"),[h,X]=L.split("="),null==X&&(X=""),h&&(O+=encodeURIComponent(h)+(X?"="+(X.includes("%")?X:encodeURIComponent(X)):""));e=O}if(t.params&&"{}"!==JSON.stringify(t.params)){for(h in e.includes("?")||(e+="?"),T=t.params)X=T[h],e.endsWith("&")||e.endsWith("?")||(e+="&"),h&&(e+=encodeURIComponent(h)+"="+encodeURIComponent("object"==typeof X?JSON.stringify(X):X));delete t.params}r.system&&("string"==typeof r.bg&&e.startsWith(r.bg)||"string"==typeof r.async&&e.startsWith(r.async)||"string"==typeof r.kv&&r.kv.startsWith("http")&&e.startsWith(r.kv))&&(null==t.headers&&(t.headers={}),null==(n=t.headers)[x="x-"+r.name.toLowerCase()+"-system"]&&(n[x]=r.system),t.headers.Authorization||t.headers.authorization||t.headers["x-apikey"]||!this.user||(t.headers["x-apikey"]=this.user.apikey)),i=async()=>{var i,s,n,l,a,o,u,c;if(t.stream)return delete t.stream,fetch(e,t);i=!1,t.buffer&&(i=!0,delete t.buffer),c=await fetch(e,t);try{(!e.includes("localhost")||200!==(o=c.status)&&404!==o)&&r.dev&&!0===r.bg&&D.log(c.status+" "+e),t.verbose&&(c.status>300&&D.log(c.body),D.log(c.status+" "+e))}catch(e){D.log("Error logging to console for fetch"),D.log(c)}if(i)a=await c.buffer();else if("HEAD"===t.method)for(a={status:c.status},l=0,n=(u=[...c.headers]).length;l<n;l++)a[(s=u[l])[0]]=s[1];else{try{a=await c.text()}catch(e){}try{"string"==typeof a&&(a.startsWith("{")||a.startsWith("["))&&(a=JSON.parse(a))}catch(e){}}return 404!==c.status?c.status>=400?(r.dev&&!0===r.bg&&D.log(t,JSON.stringify(a),"FETCH ERROR",c.status),{status:c.status}):a:void 0};try{t.timeout&&null!=(null!=this?this._timeout:void 0)?(I=!0===t.timeout?3e4:t.timeout,delete t.timeout,$=await this._timeout(I,i())):$=await i();try{(($=$.trim()).startsWith("[")||$.startsWith("{"))&&($=JSON.parse($))}catch(e){}return $}catch(t){a=t,r.dev&&!0===r.bg&&D.log("ERROR TRYING TO CALL FETCH",e,a,JSON.stringify(a));try{this.log(a)}catch(e){}}}},t.fetch._auth="system",t._timeout=function(e,t){return new Promise(((t,i)=>{var r;return r=setTimeout((()=>i(new Error("TIMEOUT"))),e),promise.then(value((()=>(clearTimeout(r),t(value))))).catch(reason((()=>(clearTimeout(r),i(reason)))))}))},L=[].indexOf,null==r.index&&(r.index={}),null==(x=r.index).name&&(x.name=null!=(k=r.name)?k:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(O=r.index).url&&(O.url=r.bg+"/index"),t.index=async function(e,i,r,s){var n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w;if("object"==typeof e&&(i=e,e=void 0),null==e&&null==i&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(p=this.parts[1])||"src"===p))return{status:403};if("object"==typeof this.body?i=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(i=this.body):i=this.copy(this.params),delete i.route,delete i.index,delete i[this.fn.split(".").pop()],delete i._id,null!=i.script||-1!==JSON.stringify(i).toLowerCase().indexOf("<script"))return}if("object"!=typeof i||Array.isArray(i)||(null==e&&(e=null!=(d=i.route)?d:i.index),delete i.route,delete i.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(a in g=[],(await this.index._send("_stats")).indices)a.startsWith(".")||a.startsWith("security-")||g.push(a);return g}2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e)if(e.includes("?")?([e,w]=e.split("?"),w="?"+w):w="",e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof i&&!Array.isArray(i)&&i._id&&(l=(i=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i))._id.replace(/\//g,"_").toLowerCase(),-1===e.indexOf("/")&&-1===e.indexOf(l)&&(e+="/"+l),delete i._id,"{}"===JSON.stringify(i)&&(i=void 0)),b=(e=e.toLowerCase()).split("/").length,null==this.index&&(this.index=t.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===e.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===i)_=await this.index._send(e.replace("/","/_doc/")+w,"");else if(1===b){if("string"==typeof i&&(""===i||-1!==i.indexOf("\n"))||Array.isArray(i))return""===i?this.index._send(e+w,i):this.index._bulk(e+w,i);if("object"!=(h=typeof i)&&"string"!==h)return this.index._send(e+"/_search"+w);if("{}"!==JSON.stringify(i)&&(c=await this.index.translate(i,r)))return this.index._send(e+"/_search"+w,c);if("object"==typeof i){for(n=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete n[f[o]];return"{}"===JSON.stringify(n)?(await this.index._send(e+w)||await this.index._send(e+w,{settings:i.settings,aliases:i.aliases,mappings:null!=(m=i.mappings)?m:i.mapping}),this.index._send(e+"/_search"+w)):"created"===(null!=(_=await this.index._send(e+"/_doc"+w,i))?_.result:void 0)&&_._id?_._id:_}}else if(2===b&&(null==i||"object"==typeof i&&!Array.isArray(i)))return e.startsWith("_")||e.includes("/_")||(e=e.replace("/","/_doc/")),null!=i&&"{}"!==JSON.stringify(i)?("object"==typeof i&&null!=i.script&&(e+="_update",w+=(w.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(_=await this.index._send(e+w,i))?_.result:void 0)&&_._id?_._id:_):("object"==typeof(_=await this.index._send(e+w))&&(_._source||_.fields)&&(null==(v=null!=(y=_._source)?y:_.fields)._id&&(v._id=_._id),_=v),_)},t.index._auths="system",t.index._caches=!1,t.index.status=async function(){var e,t,i,r,s,n,l,a,o,u,c,p,d,h,f;c={status:"green",docs:0,size:0,shards:0,failed:0};try{for(i in(f=await this.index._send("_nodes/stats/indices/search")).nodes)null==c.scrolls&&(c.scrolls=0),c.scrolls+=f.nodes[i].indices.search.open_contexts}catch(e){}for(i in c.indices={},p=await this.index._send("_stats"),h=await this.index._send("_cat/shards?format=json"),p.indices)if(!i.startsWith(".")&&!i.startsWith("security-")){for(c.indices[i]={docs:p.indices[i].primaries.docs.count,size:Math.ceil(p.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},r=0,l=h.length;r<l;r++)(d=h[r]).index===i&&"p"===d.prirep&&(null==(e=c.indices[i]).shards&&(e.shards=0),c.indices[i].shards+=1,null==(t=c.indices[i]).failed&&(t.failed=0),"UNASSIGNED"===d.state&&(c.indices[i].failed+=1));c.docs+=c.indices[i].docs;try{c.size+=parseInt(c.indices[i].size.replace("mb",""))}catch(e){}c.shards+=c.indices[i].shards,c.failed+=c.indices[i].failed}c.size=Math.ceil(c.size/1e3+"gb");try{for("green"!==(o=c.cluster.status)&&"yellow"!==o&&(c.status="red"),n=0,a=(u=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;n<a;n++)s=u[n],delete c.cluster[s]}catch(e){}return c},t.index.keys=async function(e,t){var i,r,s,n,l,a;return null==e&&(e=null!=(n=null!=(l=this.params.index)?l:this.params.keys)?n:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys",""),null==t&&(t=null!=(a=this.params.type)?a:this.params.types),"string"==typeof t&&(t=[t]),r=!0===t?{}:[],s="object"==typeof e?e:await this.index.mapping(e),i=async(e,s="")=>{var n,l,a,o;for(n in s&&(s+="."),o=[],e)null!=e[n].properties?o.push(await i(e[n].properties,s+n)):!t||!0===t||(l=e[n].type,L.call(t,l)>=0)?!0===t?o.push(r[s+n]=e[n].type):(a=s+n,L.call(r,a)<0?o.push(r.push(s+n)):o.push(void 0)):o.push(void 0);return o},"object"==typeof s&&await i(s),r},t.index.terms=async function(e,t,i,r=100,s=!0,n="count"){var l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k;if(null==e&&(e=null!=(m=this.params.index)?m:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),!t||!i){if(null==t&&(t=null!=(y=this.params.terms)?y:this.params.key),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),!t)return[];for(l=this.copy(this.params),a=0,u=(g=["index","route","terms","key"]).length;a<u;a++)delete l[g[a]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(l)),f="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&f.query.bool.must.push({query_string:{query:i}}),null==f.aggregations&&(f.aggregations={}),null==f.size&&(f.size=0),null!=this.params.size&&(r=this.params.size),null!=this.params.counts&&(s=this.params.counts),null!=this.params.order&&(n=this.params.order),d={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof n&&null!=d[n]&&(n=d[n]),t.endsWith(".keyword")||(p=await this.index.mapping(e)),f.aggregations[t]={terms:{field:t+(t.endsWith(".keyword")||"text"!==(null!=(_=p[t])?_:{}).type?"":".keyword"),size:r,order:n}},O=[],o=0,c=(x=null!=(v=null!=(k=await this.index._send("/"+e+"/_search",f,"POST"))&&null!=(b=k.aggregations)&&null!=(w=b[t])?w.buckets:void 0)?v:[]).length;o<c;o++)h=x[o],O.push(s?{term:h.key,count:h.doc_count}:h.key);return O},t.index.suggest=async function(e,t,i,r=100,s){var n,l,a,o,u,c,p,d,h,f,m,y,g;if(t&&i||(null==t&&(t=null!=(d=this.params.suggest)?d:this.params.key),"string"==typeof t&&t.includes("/")&&([t,i]=t.split("/"))),!t)return this.index.keys(e,"text");if(null==e&&(e=null!=(h=this.params.index)?h:this.fn.replace(/\./g,"/")),e=e.replace("index/","").split("/suggest")[0],null==s&&(s=this.params.include),"string"==typeof s&&(s=s.replace(/,\s/g,",").split(",")),Array.isArray(s)&&L.call(s,t)<0&&s.push(t),"string"==typeof i&&(c=(i=i.trim()).toLowerCase(),(g={should:[{match:{}},{prefix:{}},{query_string:{query:t+":"+i.split(" ").join(" AND "+t+":")+"*"}}]}).should[0].match[t]={query:i,boost:3},g.should[1].prefix[t]={value:i,boost:2}),m=[],y=[],s){for await(p of this.index._for(e,null!=g?g:i,{sort:t+".keyword",until:r,include:!0===s?[t]:s}))if(a=await this.dot(p,t)){for(;Array.isArray(a)&&(n=a.shift());)n.toLowerCase().includes(c)&&(a=n);o=a.toLowerCase(),L.call(y,o)<0&&(!c||o.includes(c))&&m.push(p),y.push(o)}}else for(l=0,u=(f=await this.index.terms(e,t,null!=g?g:i,r,!1,"term")).length;l<u;l++)o=(a=f[l]).toLowerCase(),L.call(y,o)<0&&(!c||o.includes(c))&&m.push(a),y.push(o);return m},t.index.count=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h;for(null==i&&(i=null!=(a=this.params.count)?a:this.params.key),null==e&&(e=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),r=this.copy(this.params),s=0,n=(u=["index","route","count","key"]).length;s<n;s++)delete r[u[s]];return null==t&&(l=await this.index.translate(r))&&(t=l),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(h=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(c=h.aggregations)&&null!=(p=c.keyed)?p.value:void 0):null!=(h=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(d=h.hits)?d.total:void 0},t.index.percent=async function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h,f,m;for(null==i&&(i=null!=(o=this.params.count)?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),s=this.copy(this.params),n=0,l=(c=["index","route","count","key"]).length;n<l;n++)delete s[c[n]];return null==t&&(a=await this.index.translate(s))&&(t=a),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),m=await this.index.count(e,"*"),r=0,i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(p=f.aggregations)&&null!=(d=p.keyed)?d.value:void 0):r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(h=f.hits)?h.total:void 0,Math.ceil(r/m*1e4)/100},t.index.min=async function(e,t,i,r="min"){var s,n,l,a,o,u,c,p;for(null==t&&(t=null!=(o=this.params[r])?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(e=e.replace("index/","").replace("/"+r,"")).indexOf("/")&&([e,t]=e.split("/")),s=this.copy(this.params),n=0,l=(c=["index","route","min","max","key","sum","average"]).length;n<l;n++)delete s[c[n]];return null==i&&(i=await this.index.translate(s)),(a="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,"sum"===r?a.aggs={sum:{sum:{field:t}}}:"average"===r?a.aggs={average:{avg:{field:t}}}:(a.aggs={},"min"!==r&&"range"!==r||(a.aggs.min={min:{field:t}}),"max"!==r&&"range"!==r||(a.aggs.max={max:{field:t}})),p=await this.index._send("/"+e+"/_search",a,"POST"),"range"===r?{min:p.aggregations.min.value,max:p.aggregations.max.value}:p.aggregations[r].value},t.index.max=function(e,t,i){return this.index.min(e,t,i,"max")},t.index.range=function(e,t,i){return this.index.min(e,t,i,"range")},t.index.sum=function(e,t,i){return this.index.min(e,t,i,"sum")},t.index.average=function(e,t,i){return this.index.min(e,t,i,"average")},t.index.mapping=async function(e,t){var i,r;return-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),null!=t&&(i=await this.index._send(e,t,"PUT"),D.log(e,"mapped",i)),(r=await this.index._send(e))[(await this.keys(r))[0]].mappings.properties},t.index._for=async function*(e,i,s,n,l,a){var o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,L,N,E,P,R;for("number"==typeof s&&(s={until:s}),(null!=s?s.scroll:void 0)?("number"!=typeof(R=s.scroll)&&R.endsWith("m")||(R+="m"),delete s.scroll):R="2m",((null!=s?s.until:void 0)||(null!=s?s.max:void 0))&&(c=null!=(f=s.until)?f:s.max,delete s.until,delete s.max),null==i&&(i="*"),null==(d=await this.index.translate(i,s)).from&&(d.from=0),null==d.size&&(d.size=500),null==d.sort&&(d.sort=["_doc"]),P=e.split("/")[0],u=await this.dot(t,P.replace(/_/g,".")),null==l&&(l=null!=(O=null!=(k=this.params._alias)?k:null!=(j=this.S.alias)?j[P.startsWith(this.S.index.name+"_")?P.replace(this.S.index.name+"_",""):P]:void 0)?O:null!=u?u._alias:void 0),"string"==typeof l&&(l.startsWith("_")||(l="_"+l),l=l.replace(/\//g,"_"),P.endsWith(l)||(e=e.replace(P,P+l))),!0===n&&(n=this.S.index.name),null==n&&(n=null!=(S=null!=u?u._prefix:void 0)?S:this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e)),E=P.startsWith(this.S.index.name+"_")?P.replace(this.S.index.name+"_",""):P,null==a&&(a=null!=(I=null!=(A=null!=(D=null!=(C=this.S.route)?C[E+l]:void 0)?D:null!=(m=this.S.route)?m[E]:void 0)?A:null!=u?u._route:void 0)?I:(null!=this&&null!=(y=this.S)&&null!=(g=y.index)?g.url:void 0)?this.S.index.url:null!=(_=r.index)?_.url:void 0),Array.isArray(a)&&(a=a[Math.floor(Math.random()*a.length)]),(null!=(L=await this.index._send(e+"/_search?scroll="+R,d,void 0,n,l))?L._scroll_id:void 0)&&(p=L._scroll_id.replace(/==$/,"")),(null!=L&&null!=(v=L.hits)?v.total:void 0)&&(null==c||c>L.hits.total)&&(c=L.hits.total),o=0;;){if((null!=L&&null!=(b=L.hits)?b.hits:void 0)&&0!==L.hits.hits.length||!(null!=L?L._scroll_id:void 0)||(null!=(L=await this.index._send("/_search/scroll?scroll="+R+"&scroll_id="+L._scroll_id,void 0,void 0,n,l,a))?L._scroll_id:void 0)!==p&&(await this.index._send("/_search/scroll?scroll_id="+p,"",void 0,n,l,a),p=null!=L?L._scroll_id:void 0),o===c||null==(null!=L&&null!=(w=L.hits)?w.hits:void 0)||!L.hits.hits.length){p&&await this.index._send("/_search/scroll?scroll_id="+p,"",void 0,n,l,a);break}o+=1,null==(N=null!=(x=(h=L.hits.hits.shift())._source)?x:h.fields)._id&&(N._id=h._id),yield N}},t.index._each=async function(e,t,i,r,s,n){var l,a,o,u,c,p,d,h,f,m,y;for await(d of(null==r&&null==i&&"function"==typeof t&&(r=t,t="*"),null==r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),"string"==typeof i&&(l=i,i=void 0),(null!=i?i.action:void 0)&&(l=i.action,delete i.action),(m=null!=(h=i.size)?h:"object"==typeof t&&null!=t.size?t.size:1e3)>50&&((p=await this.index.translate(t,i)).size=1,null!=(null!=(a=await this.index._send(e,p,void 0,s,n))&&null!=(f=a.hits)?f.total:void 0)&&0!==a.hits.total&&(u=Math.floor(1e9/(C.byteLength(JSON.stringify(a.hits.hits[0]))*a._shards.total)))<m&&(m=u),p.size=m),c=0,y=[],this.index._for(e,null!=p?p:t,i,s,n)))c+=1,null==(o=await r.call(this,d))||"object"!=typeof o&&"string"!=typeof o||y.push(o),l&&y.length>m&&(await this.index._bulk(e,y,l,void 0,s,n),y=[]);if(l&&y.length&&this.index._bulk(e,y,l,void 0,s,n),this.S.dev&&!0===this.S.bg)return D.log("_each processed "+c)},t.index._bulk=async function(e,i,s="index",n=5e4,l,a,o){var u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,C,L,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X;if(!0===s&&(s="index"),X=e.split("/")[0],c=await this.dot(t,X.replace(/_/g,".")),null==a&&(a=null!=(v=null!=(L=this.params._alias)?L:null!=(P=this.S.alias)?P[X.startsWith(this.S.index.name+"_")?X.replace(this.S.index.name+"_",""):X]:void 0)?v:null!=c?c._alias:void 0),"string"==typeof a&&(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),X.endsWith(a)||(e=e.replace(X,X+a))),!0===l&&(l=this.S.index.name),null==l&&(l=null!=(R=null!=c?c._prefix:void 0)?R:this.S.index.name),"string"==typeof l&&(l.length&&!l.endsWith("_")&&(l+="_"),e.startsWith(l)||(e=l+e)),J=X.startsWith(this.S.index.name+"_")?X.replace(this.S.index.name+"_",""):X,null==o&&(o=null!=(T=null!=(q=null!=(W=null!=(U=this.S.route)?U[J+a]:void 0)?W:null!=(M=this.S.route)?M[J]:void 0)?q:null!=c?c._route:void 0)?T:(null!=this&&null!=(b=this.S)&&null!=(w=b.index)?w.url:void 0)?this.S.index.url:null!=(x=r.index)?x.url:void 0),Array.isArray(o)&&(o=o[Math.floor(Math.random()*o.length)]),null==this.index&&(this.index=t.index),"string"==typeof i&&-1!==i.indexOf("\n"))return await this.index._send("/_bulk",{body:i,headers:{"Content-Type":"application/x-ndjson"}},void 0,l,a,o),!0;for(_ in B="object"!=typeof i||Array.isArray(i)||null==(null!=i&&null!=(O=i.hits)?O.hits:void 0)?i:i.hits.hits,Array.isArray(B)||(B=[B]),u=0,p=0,g="",B)if(u+=1,"object"==typeof(F=B[_])&&("string"==typeof(z=null!=(k=null!=(j=F._id)?j:null!=(S=F._source)?S._id:void 0)?k:await this.uid())&&(z=z.replace(/\//g,"_")),F._source&&(F=F._source),delete F._id),(y={})[s]={_index:e},y[s]._id="delete"!==s||"string"!=(I=typeof F)&&"number"!==I?z:F,g+=JSON.stringify(y)+"\n","create"===s||"index"===s?g+=JSON.stringify(F)+"\n":"update"===s&&(g+=JSON.stringify({doc:F})+"\n"),u===n||parseInt(_)===B.length-1||g.length>7e7){if($=await this.index._send("/_bulk",{body:g,headers:{"Content-Type":"application/x-ndjson"}},void 0,l,a,o),(null!=this&&null!=(A=this.S)?A.dev:void 0)&&!0===(null!=this&&null!=(C=this.S)?C.bg:void 0)&&(null!=$?$.errors:void 0)){for(d=[],f=0,m=(N=$.items).length;f<m;f++){h=N[f];try{200!==(E=h[s].status)&&201!==E&&(d.push(h[s]),p+=1)}catch(e){p+=1}}try{D.log(d)}catch(e){}try{D.log(0===d.length?"SOME":d.length,"INDEX ERRORS BULK LOADING",$.items.length)}catch(e){}}g="",u=0}return B.length-p},t.index.translate=function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C,L,N,E,P,R,T,q,W,U,M,z,F,B,J,$,X,V,G,H,Y,Z,K,Q,ee,te,ie,re,se,ne,le,ae,oe,ue,ce,pe,de,he;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==e&&(e=null!=this?this.params:void 0),"string"==typeof e){if(""===e||-1!==e.indexOf("\n"))return}else{if("object"!=typeof e||Array.isArray(e))return;for(y=0,v=(P=["settings","aliases","mappings","index","_id"]).length;y<v;y++)if(null!=e[g=P[y]])return;if(E=!1,e.source)try{E=JSON.parse(decodeURIComponent(e.source))}catch(e){}if("{}"!==JSON.stringify(e)&&null==e.q&&null==e.query&&!1===E&&null==e.must&&null==e.should&&null==e.must_not&&null==e.filter&&null==e.aggs&&null==e.aggregations)return}try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if(null==t&&(t={}),("string"==typeof t||Array.isArray(t))&&(t={fields:t}),"random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null!=t.newest&&(t.sort={createdAt:t.newest?"desc":"asc"},delete t.newest),null==(N=null!=($=null!=t?t.query:void 0)?$:{}).query&&(N.query={}),null==(n=N.query).bool&&(n.bool={must:[],filter:[]}),"string"==typeof e)le={query_string:{query:e}},null!=(null!=t?t.fields:void 0)&&(le.query_string.fields="string"==typeof t.fields?t.fields.split(","):t.fields,delete t.fields),N.query.bool.filter.push(le);else if("object"==typeof e)if(null!=e.query)N=e;else for(A in null!=e.source?"string"==typeof e.source&&"object"==typeof E?N=E:"object"==typeof e.source&&(N=e.source):null!=e.q&&("object"==typeof e.q?N.query=e.q:(e.q=decodeURIComponent(e.q),null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(C={})[(L=e.q.split(":"))[0]]=L[1],N.query.bool.must.push({prefix:C})):null!=e.fields?(N.query.bool.filter.push({query_string:{query:e.q,fields:e.fields.split(",")}}),delete e.fields):N.query.bool.filter.push({query_string:{query:e.q}}))),e)null==t[A]&&(t[A]=e[A]);if(null!=(null!=(H=N.query)&&null!=(Y=H.filtered)&&null!=(Z=Y.query)?Z.bool:void 0)&&(N.query.bool=N.query.filtered.query.bool,N.query.bool.filter=N.query.filtered.filter,delete N.query.filtered),null!=N.facets&&(N.aggregations=JSON.parse(JSON.stringify(N.facets).replace(/\.exact/g,".keyword")),delete N.facets),null!=N.query&&null==N.query.bool&&"{}"!==JSON.stringify(N.query)&&(N.query={bool:{must:[],filter:[N.query]}}),null==N.query&&(N.query={bool:{must:[],filter:[]}}),null==(l=N.query).bool&&(l.bool={must:[],filter:[]}),null==(a=N.query.bool).filter&&(a.filter=[]),"string"==typeof t.sort){for(ne=[],_=0,b=(K=t.sort.split(",")).length;_<b;_++)se=K[_],[g,A]=se.split(":"),A?(ne.push({}),ne[ne.length-1][g.trim()]=A.trim()):ne.push(g.trim());t.sort=ne}if(t.random&&(h={function_score:{random_score:{}}},null!=t.seed&&(h.function_score.random_score.seed=t.seed),h.function_score.query=N.query,N.query=JSON.parse(JSON.stringify(h)),delete t.random,t.seed&&t.field&&delete t.field,delete t.seed),(m=null!=(Q=null!=(ee=null!=(te=t._include)?te:t.include)?ee:t._includes)?Q:t.includes)&&(null==N._source&&(N._source={}),N._source.includes="string"==typeof m?m.replace(/,\s/g,",").split(","):m),p=null!=(R=null!=(T=null!=(q=t._exclude)?q:t.exclude)?T:t._excludes)?R:t.excludes)for(null==N._source&&(N._source={}),N._source.excludes="string"==typeof p?p.replace(/,\s/g,",").split(","):p,I=0,w=(M=null!=(W=null!=(U=N._source)?U.includes:void 0)?W:[]).length;I<w;I++)f=M[I],N._source.excludes=N._source.excludes.filter((function(e){return e!==f}));for(ae=0,x=(z=["filter","restrict","must","and","must_not","not","should","or"]).length;ae<x;ae++)if(null!=t[ue=z[ae]])for(S=Array.isArray(t[ue])?t[ue]:[t[ue]],delete t[ue],c="filter"===ue||"restrict"===ue||"must"===ue||"and"===ue?"filter":"must_not"===ue||"not"===ue?"must_not":"should",null==(o=N.query.bool)[c]&&(o[c]=[]),ce=0,O=S.length;ce<O;ce++)"object"==typeof(re=S[ce])?1===(ie=this.keys(re)).length&&"object"!=typeof re[ie[0]]&&(re={term:re}):re={query_string:{query:re}},N.query.bool[c].push(re);if(null!=t.terms){try{t.terms=t.terms.replace(/,\s/g,",").split(",")}catch(e){}for(null==N.aggregations&&(N.aggregations={}),de=0,k=(F=t.terms).length;de<k;de++)oe=F[de],N.aggregations[oe]={terms:{field:oe+(oe.endsWith(".keyword")?"":".keyword"),size:1e3}};delete t.terms}for(he=0,j=(B=["aggs","aggregations"]).length;he<j;he++)if(null!=t[i=B[he]]){for(d in null==N[i]&&(N[i]={}),t[i])N[i][d]=t[i][d];delete t[i]}for(g in t){if(pe=t[g],("from"===g||"size"===g)&&"number"!=typeof pe)try{pe=parseInt(pe),isNaN(pe)&&(pe=void 0)}catch(e){}null!=pe&&"apikey"!==g&&"_"!==g&&"callback"!==g&&"refresh"!==g&&"key"!==g&&"counts"!==g&&"order"!==g&&"index"!==g&&"search"!==g&&"source"!==g&&"q"!==g&&"_alias"!==g&&"include"!==(J=g.replace("_","").replace("s",""))&&"exclude"!==J&&(N[g]=pe)}try{for(r in D={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},N.aggregations)"string"==typeof(null!=(X=N.aggregations[r].terms)?X.order:void 0)&&null!=D[N.aggregations[r].terms.order]&&(N.aggregations[r].terms.order=D[N.aggregations[r].terms.order])}catch(e){}if(null!=(null!=(V=N.query)?V.bool:void 0))for(u in N.query.bool)for(s in N.query.bool[u])"string"==typeof(null!=(G=N.query.bool[u][s].query_string)?G.query:void 0)&&-1!==N.query.bool[u][s].query_string.query.indexOf("/")&&-1===N.query.bool[u][s].query_string.query.indexOf('"')&&(N.query.bool[u][s].query_string.query='"'+N.query.bool[u][s].query_string.query+'"');return null!=N._source&&null!=N.fields&&delete N._source,N},t.index.translate._auth=!1,t.index._send=async function(e,i,s,n,l,a){var o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A;e.includes("?")?([e,S]=e.split("?"),S="?"+S):S="",(e=e.toLowerCase()).startsWith("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,""));try{e.split("/").pop().includes("#")&&(e=e.replace(/#/g,"%23"))}catch(e){}if(null==s&&(s=""===i?"DELETE":null==i||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=i||"_refresh"===(p=e.split("/").pop().split("?")[0])||"_aliases"===p?"POST":"GET":"PUT"),"DELETE"===s&&-1!==e.indexOf("/_all"))return!1;if(!e.startsWith("http")){if(A=e.split("/")[0],e.startsWith("_")||(o=await this.dot(t,A.replace(/_/g,".")),null==l&&(l=null!=(g=null!=(_=this.params._alias)?_:null!=(v=this.S.alias)?v[A.startsWith(this.S.index.name+"_")?A.replace(this.S.index.name+"_",""):A]:void 0)?g:null!=o?o._alias:void 0),"string"==typeof l&&(l.startsWith("_")||(l="_"+l),l=l.replace(/\//g,"_"),A.endsWith(l)||(e=e.replace(A,A+l))),null==n&&(n=null!=(b=null!=o?o._prefix:void 0)?b:this.S.index.name),!0===n&&(n=this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e))),I=A.startsWith(this.S.index.name+"_")?A.replace(this.S.index.name+"_",""):A,null==a&&(a=null!=(w=null!=(x=null!=(O=null!=(k=this.S.route)?k[I+l]:void 0)?O:null!=(d=this.S.route)?d[I]:void 0)?x:null!=o?o._route:void 0)?w:(null!=this&&null!=(h=this.S)&&null!=(f=h.index)?f.url:void 0)?this.S.index.url:null!=(m=r.index)?m.url:void 0),Array.isArray(a)&&(a=a[Math.floor(Math.random()*a.length)]),"string"!=typeof a)return;e=a+"/"+e}if(e.startsWith("http")){if(c=!1,e.includes("/_search")&&"object"==typeof i&&(null!=i.scroll_id||i.scroll)&&(!0===i.scroll&&(i.scroll="2m"),("number"==typeof i.scroll||"string"==typeof i.scroll&&!i.scroll.endsWith("m"))&&(i.scroll+="m"),e+=(-1===e.indexOf("?")?"?":"&")+"scroll="+(null!=(y=i.scroll)?y:"2m"),i.scroll_id?(c=i.scroll_id,e=e.split("://")[0]+"://"+e.split("://")[1].split("/")[0]+"/_search/scroll"+(e.includes("?")?"?"+e.split("?")[1]:""),e+=(-1===e.indexOf("?")?"?":"&")+"scroll_id="+i.scroll_id,i=void 0):(delete i.scroll_id,delete i.scroll)),u=-1!==(e=e+=S).indexOf("/_bulk")||"object"==typeof i&&"object"==typeof i.headers?i:{body:i},-1===e.indexOf("/_search")||"GET"!==s&&"POST"!==s||(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),e.includes("/_doc/")&&e.split("/_doc/")[1].includes("%")&&(e=e.split("/_doc/")[0]+"/_doc/"+encodeURIComponent(e.split("/_doc/")[1])),u.method=s,!(null==(j=await this.fetch(e,u))||"object"==typeof j&&"number"==typeof j.status&&j.status>=400&&j.status<=600)){if(this.S.dev&&"object"==typeof j&&null!=j.hits){try{null!=(null!=i?i.query:void 0)&&(j.q=i)}catch(e){}try{l&&(j._alias=l)}catch(e){}}return(null!=j?j._scroll_id:void 0)&&(j._scroll_id=j._scroll_id.replace(/==$/,"")),c&&c!==(null!=j?j._scroll_id:void 0)&&await this.index._send("/_search/scroll?scroll_id="+c,""),j}}else D.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!i.g[r.kv]&&(i.g[r.kv]={},i.g[r.kv].get=function(e){return t.fetch(r.kv+"/"+e)},i.g[r.kv].getWithMetadata=async function(e){return{value:await t.fetch(r.kv+"/"+e),metadata:{}}},i.g[r.kv].put=function(e,i){return t.fetch(r.kv+"/"+e,{body:i})},i.g[r.kv].delete=function(e){return t.fetch(r.kv+"/"+e,{method:"DELETE"})},i.g[r.kv].list=function(e){return null==e&&(e={}),t.fetch(r.kv+"/list"+(e.prefix?"/"+e.prefix:"")+(e.cursor?"?cursor="+e.cursor:""))}),t.kv=async function(e,t,r,s,n){var l,a,o,u,c,p,d,h,f,m,y,g,_,v;if(null==e&&(e=null!=(d=null!=(h=this.params.kv)?h:this.params.key)?d:this.parts.join("_"),null==t)){if("DELETE"===this.request.method)t="";else if(this.body)t=this.body;else if(this.params.val)t=this.params.val;else{for(t=this.params,l=0,u=(f=["key","kv","refresh","apikey"]).length;l<u;l++)delete t[o=f[l]];for(a=0,c=(m=this.parts).length;a<c;a++)delete t[o=m[a]]}"string"!=typeof t||0!==t.indexOf("[")&&0!==t.indexOf("{")||(t=JSON.parse(t)),"{}"!==(y=JSON.stringify(t))&&"[]"!==y||(t=void 0)}if("object"!=typeof t||"{}"!==(g=JSON.stringify(t))&&"[]"!==g||(t=void 0),"object"==typeof e&&null==t&&(e=null!=(_=(t=e)._id)?_:await this.uid()),null!=e&&this.S.kv&&i.g[this.S.kv]){if(null!=t&&""!==t){if(p={metadata:s},"number"==typeof r&&(1e3*r>Date.now()?p.expiration=r:p.expirationTtl=r),"object"==typeof t&&(!0===r&&(r=await this.kv(e)),"object"==typeof r))for(o in r)null==t[o]&&(t[o]=r[o]);return this.waitUntil(i.g[this.S.kv].put(e,"object"==typeof t?JSON.stringify(t):t,p)),t}if(({value:v,metadata:s}=await i.g[this.S.kv].getWithMetadata(e,n)),null!=v){try{v=JSON.parse(v)}catch(e){}try{s=JSON.parse(s)}catch(e){}return""===t&&this.waitUntil(i.g[this.S.kv].delete(e)),!0===s?{value:v,metadata:s}:v}}},t.kv._auths="system",t.kv._caches=!1,t.kv.list=async function(e,t){var r,s;try{null==e&&(e=null!=(r=null!=(s=this.params.kv)?s:this.params.prefix)?r:this.params.list)}catch(e){}try{null==t&&(t=this.params.cursor)}catch(e){}return await i.g[this.S.kv].list({prefix:e,cursor:t})},t.kv.count=async function(e){var t,r,s,n,l,a,o,u,c;if(r=0,this.S.kv&&null!=i.g[this.S.kv])for(null==e&&(e=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),t=!1,s=void 0;!t;){for(s=(a=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,n=0,l=(c=a.keys).length;n<l;n++)c[n],r+=1;t=a.list_complete}return r},t.kv.prefixes=async function(){var e;return e={},await this.kv._each(void 0,(function(t){var i;return i=t.split("/")[0],null==e[i]&&(e[i]=0),e[i]+=1})),e},t.kv.clear=function(e){var t;if(this.S.dev)return null==e&&(e=null!=(t=this.params.clear)?t:this.params.kv),this.waitUntil(this.kv._each(e,(function(e){return this.waitUntil(i.g[this.S.kv].delete(e))}))),!0},t.kv.delete=async function(e){var t,i,r,s;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==e&&(e=null!=(i=null!=(r=this.params.kv)?r:this.params.delete)?i:this.params.prefix),s=t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));t&&"0"!==t;)this.S.dev&&D.log(e,t),await this.fetch(this.S.kv+"/clear"+(e?"/"+e:"")),await this.sleep(500),t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));return s}},t.kv.delete._bg=!0,t.kv._each=async function(e,t){var r,s,n,l,a,o,u,c;if(this.S.kv&&null!=i.g[this.S.kv]){for("function"==typeof e&&null==t&&(t=e,e=void 0),r=!1,s=void 0,c=[];!r;){for(s=(o=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,n=0,a=(u=o.keys).length;n<a;n++)l=u[n],"function"==typeof t?this.waitUntil(t.call(this,l.name)):""===t?this.waitUntil(i.g[this.S.kv].delete(l.name)):null!=t&&this.waitUntil(this.kv(l.name,t));c.push(r=o.list_complete)}return c}},null==r.log&&(r.log={}),S=[],I=!1,j=!1,t.log=function(e,t){var i,s,n,l,a,o,u,c,p,d;if(i=async()=>{var e,t;for(!1!==I&&clearTimeout(I),I=setTimeout(i,3e4),j=Date.now(),t=new Date(j).toISOString().replace("T"," ").split(".")[0],e=[];e.length<400&&S.length;)e.push(S.shift());if(e.length)return!0===this.S.bg&&D.log("Writing "+e.length+" logs to index",e[0]._id,e[e.length-1]._id,t),await this.index("logs",e)||(await this.index("logs",{}),await this.index("logs",e)),[]},!1!==this.S.log){if(!0!==t&&(t=null==e),!0!==t&&(this._logs.length>3e4||S.length>3e4)&&(t=!0),"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(s=0,a=e.length;s<a;s++)l=e[s],this._logs.push(l);e=void 0}if(null==e){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return S.push(this.body),!1===I&&i(),!0;e="object"==typeof this.body?this.body:this.params,Array.isArray(e)&&(e={logs:e})}null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers,e.request.headers.cookie&&(e.cookie=!0,delete e.request.headers.cookie)}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(u in e.params={},this.params)e.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(e){}try{e.apikey=null!=this.apikey}catch(e){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}if(t){if(!e.logs&&(e.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(n=0,o=(p=this._logs).length;n<o;n++)(l=p[n]).alert&&null==e.alert&&(e.alert=l.alert),l.notify&&null==e.notify&&(e.notify=l.notify),e.logs.push(l);e.createdAt=new Date,null==e.name&&(e.name=r.name),null==e.version&&(e.version=r.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(e._id=this.rid,null!=(null!=(d=this.S.index)?d.url:void 0))!0===this.S.bg?(S.push(e),("object"==typeof this.S.log&&!1===this.S.log.batch||S.length>300||!1===j||Date.now()>j+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(S.push(e),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:e}));else try{this.kv("logs/"+e._id,e)}catch(t){D.log("Logging unable to save to kv or index"),consolg.log(e)}}else this._logs.push(e)}else this.S.dev&&!0===this.S.bg&&D.log("NOT logging",e);return!0},t.logs={_index:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(e){r.mail={}}t.mail=async function(e){var i,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S;if(null!=(p=r.mail)?p.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(d=this.copy(null!=this?this.params:void 0))?d:{}),e.template){for(o in u=await this.template(e.template,null!=(_=null!=(v=e.vars)?v:e.params)?_:e))e[o]=u[o];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(b=null!=(w=null!=(x=null!=(O=e.content)?O:e.msg)?x:e.body)?w:this.body)?b:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}if(delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),a=(e.svc||e.service)&&null!=(null!=(k=this.S.svc[null!=(j=e.svc)?j:e.service])?k.mail:void 0)?this.S.svc[null!=(h=e.svc)?h:e.service].mail:null!=(f=null!=this&&null!=(m=this.S)?m.mail:void 0)?f:r.mail,null==e.from&&(e.from=a.from),null==e.to&&(e.to=a.to),delete e.svc,S="https://api.mailgun.net/v3/"+a.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),e.to){for(i=null!=(y=null!=this?this.fetch:void 0)?y:t.fetch,c={method:"POST",auth:"api:"+a.apikey},n=0,l=(g=["file","files","attachment","attachments"]).length;n<l;n++)null!=e[s=g[n]]&&(c[s]=e[s],delete e[s]);return c.form=e,await i(S,c)}return D.log(e),D.log("NO ADDRESS TO EMAIL TO"),{}},t.mail._auth="system",t.mail.validate=async function(e,t){var i,r,s,n,l;if(null==e&&(e=null!=this&&null!=(s=this.params)?s.email:void 0),"string"==typeof e&&e.length&&(-1===e.indexOf(" ")||e.startsWith('"')&&2===e.split('"@').length)){try{if("string"==typeof t)return null!=(n=(l=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)).did_you_mean)?n:l.is_valid}catch(e){}if(2===(i=e.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(r=i[1].split(".")).length>1&&(2!==r.length||"example"!==r[0]))return!0}return!1},L=[].indexOf,t.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},t.copy._log=!1,t.dot=function(e,i,r,s,n){var l,a,o;return"string"==typeof i?t.dot(e,i.split("."),r,s,n):0===i.length?e:1!==i.length||null==r&&null==s?null==e[i[0]]?null!=r?(e[i[0]]="number"!=typeof i[0]&&isNaN(parseInt(i[0]))?{}:[],t.dot(e[i[0]],i.slice(1),r,s,n)):n&&Array.isArray(e)&&e.length&&(o=e[e.length-1]&&"object"==typeof o&&null!=o[i[0]])?t.dot(o[i[0]],i.slice(1),r,s,n):Array.isArray(e)&&e.length&&"object"==typeof e[0]?t.dot(e.flatMap((function(e){return null!=e[i[0]]?e[i[0]]:[]})),i.slice(1),r,s,n):void 0:n&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))&&e.length&&"object"==typeof e[e.length-1]?(null!=r&&null==(l=e[e.length-1])[a=i[0]]&&(l[a]={}),t.dot(e[e.length-1][i[0]],i.slice(1),r,s,n)):t.dot(e[i[0]],i.slice(1),r,s,n):null!=s?(e instanceof Array?e.splice(i[0],1):delete e[i[0]],!0):(n&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))?(e.length||(e=[{}]),e[e.length-1][i[0]]=r):e[i[0]]=r,!0)},t.dot._log=!1,t.flatten=async function(e,t){var i,r,s,n,l,a,o;if(null==t&&(t=null!=(l=this.params.arrayed)&&l),null==e&&delete(e=this.params).arrayed,a={},i=async function(e,r){var s,n,l,o,u,c,p;if("object"!=typeof e)return a=e;for(l in c=[],e){n=!1;try{n=!isNaN(parseInt(l))}catch(e){}u=n&&!t?r:r?r+"."+l:l,"object"!=typeof(p=e[l])?null!=a[u]?(Array.isArray(a[u])||(a[u]=[a[u]]),c.push(a[u].push(p))):c.push(a[u]=p):Array.isArray(p)?"object"==typeof p[0]?c.push(await async function(){var e;for(o in e=[],p)e.push(await i(p[o],u+(t?"."+o:"")));return e}()):(null==a[u]&&(a[u]=[]),Array.isArray(a[u])||(a[u]=[a[u]]),c.push(function(){var e,t,i;for(i=[],e=0,t=p.length;e<t;e++)s=p[e],i.push(a[u].push(s));return i}())):c.push(await i(p,u))}return c},Array.isArray(e)){for(o=[],s=0,n=e.length;s<n;s++)r=e[s],a={},await i(r),o.push(a);return o}return await i(e),a},t.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&L.call(i,t)<0&&i.push(t);return i},t.pings={_index:!0},t.ping=async function(){var e,t,i;return e=this.copy(this.params),"{}"!==JSON.stringify(e)&&(e.ip=null!=(t=null!=(i=this.headers["x-forwarded-for"])?i:this.headers["cf-connecting-ip"])?t:this.headers["x-real-ip"],e.forwarded=this.headers["x-forwarded-for"],await this.pings(e),!0)},t.scrape=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b,w,x,O,k,j,S,I,A,D,C;if(null==e&&(e=null!=(k=null!=(j=this.params.scrape)?j:this.params.content)?k:this.params.url),null==t&&(t=this.params.doi),f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(C=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&C.length>1&&9<C[1].length&&C[1].length<45&&-1!==C[1].indexOf("/")&&0===C[1].indexOf("10.")&&(f.doi=C[1]),e=await this.fetch(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{for(r=0,S=e.split(" "),n=0,o=S.length;n<o;n++)if(D=S[n],(r+=1)<600&&(-1!==(D=D.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(D=D.split("doi.org")[1]),0===D.indexOf("/")&&(D=D.replace("/","")),0===(D=D.trim()).indexOf("10.")&&-1!==D.indexOf("/"))){f.doi=D;break}}catch(e){}if(!f.doi)try{for(I=(s=await this.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,a=0,u=I.length;a<u;a++)b=I[a],!f.doi&&9<s.matches[b].result[1].length&&s.matches[b].result[1].length<45&&(f.doi=s.matches[b].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(e){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(w=0,c=m.length;w<c;w++)(v=m[w]).length>2&&(f.year=v)}catch(e){}if(!f.keywords)try{-1!==(l=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(l=l.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=l.split(";")):(l=l.replace(/, /g,",").replace(/ ,/g,","),f.keywords=l.split(","))}catch(e){}if(!f.email){y=[];try{for(A=(await this.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,p=A.length;x<p;x++)(g=A[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===y.indexOf(g)&&y.push(g)}catch(e){}for(y.sort((function(e,t){return t.length-e.length})),_="",O=0,d=y.length;O<d;O++)h=y[O],null==f.email&&(f.email=[]),-1===_.indexOf(h)&&f.email.push(h),_+=h}return f},t.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise((t=>setTimeout(t,null!=e?e:1e3)))},t.sleep._auth="root",t.sleep._log=!1,L=[].indexOf,t.template=async function(e,t){var i,r,s,n,l,a,o,u,c,p,d,h,f,m,y,g,_,v,b;if(null==e&&(e=null!=(f=null!=(m=this.params.content)?m:this.params.template)?f:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(y=this.params.url)?y:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{r=await this.templates(e),e=r.content}catch(e){}if(_={},(i=function(t,r=""){var s,n,l,a;for(s in l=[],t)n=r?r+"."+s:s,"object"!=typeof t[s]||Array.isArray(t[s])?-1!==e.toLowerCase().indexOf("{{"+n+"}}")?(a=new RegExp("{{"+n+"}}","gi"),l.push(e=e.replace(a,Array.isArray(t[s])?t[s].join(", "):"string"==typeof t[s]?t[s]:!0===t[s]?"Yes":!1===t[s]?"No":""))):l.push(void 0):l.push(i(t[s],r+(""===r?"":".")+s));return l})(t),u=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(b=["subject","from","to","cc","bcc"],s=0,p=(g=e.toLowerCase().split("{{")).length;s<p;s++)h=g[s].split("{{")[0].split("}}")[0].split(" ")[0],L.call(b,h)<0&&b.push(h);for(n=0,d=b.length;n<d;n++)l=b[n],(a=-1!==e.toLowerCase().indexOf("{{"+l)?l:void 0)&&(o=-1!==e.indexOf("{{"+a.toUpperCase())?a.toUpperCase():a,(v=e.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(v=v.replace(u,"")),(v=v.split("}}")[0].trim())&&(_[a]=v),c=new RegExp("{{"+o+".*?}}","gi"),e=e.replace(c,""))}return-1!==e.indexOf("{{")&&(e=e.replace(u,"")),_.content=e,_},t.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},t.levenshtein=function(e,t,i){var r,s,n,l,a,o,u,c,p,d,h,f,m;for(null==e&&(e=null!=this&&null!=(d=this.params)?d.a:void 0),null==t&&(t=null!=this&&null!=(h=this.params)?h.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(a=e.length)<(u=t.length)&&(r=e,e=t,t=r,c=a,a=u,u=c),p=[[]],r=0;r<u+1;)p[0][r]=r,r++;for(n=1;n<a+1;){for(p[n]=[n],l=1;l<u+1;)s=e.charAt(n-1)===t.charAt(l-1)?0:1,p[n][l]=o(p[n-1][l]+1,p[n][l-1]+1,p[n-1][l-1]+s),l++;n++}return{distance:p[p.length-1][p[p.length-1].length-1],length:{a,b:u}}},t.extract=async function(e){var t,i,r,s,n,l,a,o,u,c,p;if(null==e&&(e=this.copy(this.params)),e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=await this.fetch(e.url)),e.convert)try{p=await this.convert[e.convert+"2txt"](null!=(o=e.url)?o:e.content)}catch(e){}if(null==p&&(p=e.content),null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(a=p.split(e.start),p=a.length>1?a[1]:a[0]),null!=e.end&&(p=p.split(e.end)[0]),e.lowercase&&(p=p.toLowerCase()),e.ascii&&(p=p.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(p=p.replace(/ /g,"")),c={length:p.length,matched:0,matches:[],matchers:e.matchers,text:p},p&&"number"!=typeof p)for(t=0,r=(u="string"==typeof e.matchers?e.matchers.split(","):e.matchers).length;t<r;t++){"string"==typeof(n=u[t])?(l="",0===n.indexOf("/")?(i=n.lastIndexOf("/"))+1!==n.length&&(l=n.substring(i+1),n=n.substring(1,i)):n=n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):l="",e.lowercase&&(l+="i");try{(s=new RegExp(n,l).exec(p))&&(c.matched+=1,c.matches.push({matched:n.toString(),result:s}))}catch(e){}}return c},t.decode=async function(e){var t,i,r,s,n,l,a,o,u,c,p,d,h;for(null==e&&(e=null!=(l=null!=(a=null!=(o=null!=this&&null!=(u=this.params)?u.decode:void 0)?o:null!=this&&null!=(c=this.params)?c.content:void 0)?a:null!=this&&null!=(p=this.params)?p.text:void 0)?l:null!=this?this.body:void 0),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(x?[0-9A-Fa-f]+);/gi,(function(e,t){var i;return i=t.startsWith("x")?parseInt(t.replace("x",""),16):parseInt(t,10),String.fromCharCode(i)}))},h=(h=await t(e)).replace(/\n/g," "),r=0,s=(d=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;r<s;r++)i=d[r],n=new RegExp(i.bad,"g"),h=h.replace(n,i.good);try{-1!==h.indexOf("%2")&&(h=decodeURIComponent(h))}catch(e){}try{-1!==h.indexOf("%2")&&(h=decodeURIComponent(h))}catch(e){}return h},r.built="Tue Oct 14 2025 15:55:20 GMT+0100",t.convert.doc2txt={_bg:!0},t.convert.docx2txt={_bg:!0},t.convert.pdf2txt={_bg:!0}})()})();